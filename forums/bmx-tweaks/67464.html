<!DOCTYPE html><html lang="en" ><head ><title >maxmod update 1.16</title><meta name='viewport' content='width=device-width, initial-scale=0.66'><meta name='description' content='language:basic, target:desktop, category:game development'><link rel="styleSheet" href="../skins/granite/style.css" type="text/css"><style type="text/css">div.bbcode {padding: 8px;background: #E5E5E5;color: #000000;border: 1px dashed #B4B4BE;}</style></head><body ><table width=100% cellspacing=0 cellpadding=0><tr ><td class="menubarleft"></td><td class="menubar"><table cellspacing="0" cellpadding="0"><tr ><td >&nbsp;</td><td class="menuitemleft"></td><td class="menuitem"><a href="/" class="menuitem">News</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/forums.php" class="menuitem">Forums</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/codearcs.php" class="menuitem">Code</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/logs.php" class="menuitem">Logs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/gallery.php" class="menuitem">Gallery</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/sdkspecs.php" class="menuitem">Specs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/search.php" class="menuitem">Search</a></td><td class="menuitemright"></td></tr></table></td><td class="menubarright"></td></tr></table><div class="main"><h1 >maxmod update 1.16</h1><a href="forums.php" >BlitzMax Forums</a>/<a href="topics.php?forum=110" >BlitzMax Module Tweaks</a>/<a href="#bottom" >maxmod update 1.16</a><br><br>
<a name="753512"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >REDi</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#1">[#1]</a></td></tr></table></td></tr><tr ><td class="posttext"> New version of maxmod is up, just click the link in my sig... <br><br></td></tr></table><br>
<a name="753514"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >REDi</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#2">[#2]</a></td></tr></table></td></tr><tr ><td class="posttext"> There is a few changes in this version, that will break current apps, I've seperated the TMusic object and streaming into two seperate object...<br><pre class=code>
Local Music:TMusic = LoadMusic(RequestFile("Select music to play...",MusicExtensions())) 
If Not Music RuntimeError "Unable to open music"
Local Stream:TAudioStream = StreamMusic(Music)
If Not Stream Notify "Unable to open stream"
PlayStream(Stream)</pre><br>So now the TMusic object is the player/decoder and TAudioStream handles the streaming to directsound.<br><br>Sorry, its a bit awkward, but IMO required in the long run. (ie, its easier to plug into other sound engines ;) )<br><br>on the plus side, you can now load the entire track and play it back with freeaudio, without touching a maxmod stream.<br><br>This release was rushed, so it wasn't as tested as i would have liked, so if you find some bugs, give me a shout. <br><br></td></tr></table><br>
<a name="753523"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >GfK</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#3">[#3]</a></td></tr></table></td></tr><tr ><td class="posttext"> Eek!<br><br>Slowly getting my head around all this.  But what's happened to the 'Pause' method?<br><br>Is there still a way to pause music then resume it from the same point?? <br><br></td></tr></table><br>
<a name="753524"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >REDi</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#4">[#4]</a></td></tr></table></td></tr><tr ><td class="posttext"> LOL, I'm on it.. ? lol <br><br></td></tr></table><br>
<a name="753530"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >REDi</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#5">[#5]</a></td></tr></table></td></tr><tr ><td class="posttext"> Ok, another version for ya 1.16a, with a pause function!<br><br>Stream.pause or PauseStream(Stream)<br>Call it once to pause it, and again to unpause.<br><br>If you have any more problems (probably), let me know mate, I'll fix it asap, gotta get some sleep now tho -.-<br><br>anyway, sorry for the inconvenience, this update was a bit of a surprise. <br><br></td></tr></table><br>
<a name="753533"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >hub</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#6">[#6]</a></td></tr></table></td></tr><tr ><td class="posttext"> Thanks Redi ! <br><br></td></tr></table><br>
<a name="753535"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >GfK</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#7">[#7]</a></td></tr></table></td></tr><tr ><td class="posttext"> Couple of problems turning up.<br><br>1. Geti(MM_ISPLAYING) - always returns 0.<br>2. tAudioStream.SetVolume(v) - "Too many function parameters"<br>3. Setf(MM_VOLUME,v) - does nothing.<br>4. SetStreamVolume(stream,v) - does nothing.<br>5. tMusic.Getf(MM_VOLUME) - always returns 0. <br><br></td></tr></table><br>
<a name="753538"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Matthew Smith</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#8">[#8]</a></td></tr></table></td></tr><tr ><td class="posttext"> Redi,<br><br>Any chance on taking a look at the SidStream changes at some stage??  Unfortunately, a bit beyond me!! <br><br></td></tr></table><br>
<a name="753540"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >REDi</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#9">[#9]</a></td></tr></table></td></tr><tr ><td class="posttext"> thanks GfK, now thats what I call sloppy work! ;)<br><br>1. thanks easy fix<br>2. TAudioStream.SetVolume is a private method, forget that one (your right, i will make it uniform)<br>3. see 4<br>4. just tried it here and works okay, value should be between 0.0-1.0<br>5. oops, use Stream.alPitch as a temp fix<br><br>@Matt, sure thing, will do it tonight.<br><br>night all <br><br></td></tr></table><br>
<a name="753704"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Matthew Smith</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#10">[#10]</a></td></tr></table></td></tr><tr ><td class="posttext"> Thanks Redi <br><br></td></tr></table><br>
<a name="753743"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >REDi</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#11">[#11]</a></td></tr></table></td></tr><tr ><td class="posttext"> no problems mate, fixes will be available tonite at some point. <br><br></td></tr></table><br>
<a name="753757"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >skidracer</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#12">[#12]</a></td></tr></table></td></tr><tr ><td class="posttext"> REDi, in regards to streaming, I was wondering about the following change to freeaudioaudio.bmx[149]<br><br>&lt;edit&gt;<br><pre class=code>
	Method Playing()
		Local status=fa_ChannelStatus( fa_channel ) &amp; ~(FA_CHANNELSTATUS_STOPPED)
'		If status Return True
		If status Return fa_ChannelPosition(fa_channel)+1
	End Method
</pre><br><br>Which should give you the current readpointer of the channel in samples.<br><br>For music synthesis, you should be then able to play a looped sample and write your data ahead of the mixer's read pointer.<br><br>Kindof busy at the moment but will try and test / post some helper classes soon. <br><br></td></tr></table><br>
<a name="753760"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >REDi</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#13">[#13]</a></td></tr></table></td></tr><tr ><td class="posttext"> Great news skid, much appreciated! :D <br><br></td></tr></table><br>
<a name="753777"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >skidracer</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#14">[#14]</a></td></tr></table></td></tr><tr ><td class="posttext"> OK, it seems to be working, <a href="http://gameartnow.com/nitrologic/freeaudiobeta.zip" target="_blank">new freeaudio here</a>, and the start of a synth class that supports 8/16/mono/stereo streaming, currently setdriver is required due to a nullaudiodevice somehow being installed after freeaudio default, not sure about that one....<br><br>A TFloatSynth is probably needed next, and then a hook to the oggreader code should hopefully be possible.<br><br><textarea class=codebox name="code" wrap=OFF readonly="true" rows="15" cols="80">
' synth.bmx

Strict

'SetAudioDriver "FreeAudio DirectSound"	'cludge around build order problems
SetAudioDriver "FreeAudio Default"	'cludge around build order problems


?BigEndian
Const SF_STEREO16=SF_STEREO16BE
Const SF_MONO16=SF_MONO16BE
?LittleEndian
Const SF_STEREO16=SF_STEREO16LE
Const SF_MONO16=SF_MONO16LE
?

Type TSynth

	Global timer:TTimer
	Global synthlist:TList=New TList
	
	Field sample:TAudioSample
	Field channel:TChannel
	Field sound:TSound

	Field bits
	Field channels
	Field format
	Field fragsize		
	Field writepos
	
	Function eventhook:Object(id%,data:Object,context:Object)
		Local synth:TSynth
		If context=timer 
			For synth=EachIn synthlist
				synth.Poll
			Next
			Return Null
		EndIf
	End Function
	
	Method Poll()
		Local readpos
		Local count
		readpos=ChannelPlaying(channel)/channels
		If readpos=0 Return 'this channel is stopped
		count=((readpos+fragsize*2-writepos)/fragsize)
		While count
			Select bits
				Case 8
					Mix8
				Case 16
					Mix16
			End Select
			writepos=writepos+fragsize
			count=count-1
		Wend
	End Method

' mix the next .fragsize samples into .sample at (.writepos mod .fragsize)

	Method Mix8()
	End Method

	Method Mix16()
	End Method
		
	Method CreateSynth:TSynth(frag=8192,_bits=16,_channels=2)
		fragsize=frag
		bits=_bits
		channels=_channels
		If bits=16
			If channels=2			
				format=SF_STEREO16
			Else
				format=SF_MONO16
			EndIf			
		Else
			If channels=2
				format=SF_STEREO8
			Else
				format=SF_MONO8
			EndIf
		EndIf		
		sample=CreateAudioSample(fragsize*4,44100,format)	'SF_MONO8)
		MemClear sample.samples,sample.capacity
		channel=AllocChannel() 
		sound=LoadSound(sample,True)
		PlaySound sound,channel
		If Not timer
			timer=CreateTimer(100)
			AddHook EmitEventHook,eventhook,timer
		EndIf
		synthlist.AddLast Self
		Return Self
	End Method
	
	Function Close()
		If timer
			RemoveHook EmitEventHook,eventhook
			StopTimer timer
			timer=Null
		EndIf
	End Function

End Type

Type TSweepSynth Extends TSynth

	Field rad#,radf#

	Method Mix8()
		Local b:Byte Ptr
		Local p,i	
		p=writepos Mod (fragsize*4)
		b=sample.samples+p*channels
		For i=0 Until fragsize*channels		
			rad=rad+radf/channels
			radf=radf+.00001/channels
			b[i]=128+127*Sin(rad)
		Next	
	End Method

	Method Mix16()
		Local s:Short Ptr
		Local p,i
		p=writepos Mod (fragsize*4)
		s=Short Ptr sample.samples+p*channels
		For i=0 Until fragsize*channels
			rad=rad+radf/channels
			radf=radf+.00001/channels
			s[i]=32767*Sin(rad)
		Next	
	End Method

	Method CreateSweepSynth:TSweepSynth(frag=8192,_bits=16,_channels=2)
		CreateSynth frag,_bits,_channels
		Return Self
	End Method

End Type


Function CreateSweepSynth:TSynth(fragsize,bits,channels)
	Return New TSweepSynth.CreateSweepSynth(fragsize,bits,channels)
End Function

CreateSweepSynth 8192,16,2

While True
	WaitEvent
	Print "yo!"
Wend
</textarea> <br><br></td></tr></table><br>
<a name="753805"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >REDi</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#15">[#15]</a></td></tr></table></td></tr><tr ><td class="posttext"> Fixed (I hope) version of maxmod is now up 1.16b, including sidstream.mod update.<br><br>WOW, Thanks skidracer!, here's a quick bodged tester using maxmod... :D<br><textarea class=codebox name="code" wrap=OFF readonly="true" rows="15" cols="80">
' synth.bmx

Strict

Import REDi.MaxMod

'SetAudioDriver "FreeAudio DirectSound"	'cludge around build order problems
'SetAudioDriver "FreeAudio Default"	'cludge around build order problems
SetAudioDriver "Set OpenAL Generic Hardware"

?BigEndian
Const SF_STEREO16=SF_STEREO16BE
Const SF_MONO16=SF_MONO16BE
?LittleEndian
Const SF_STEREO16=SF_STEREO16LE
Const SF_MONO16=SF_MONO16LE
?

Type TSynth

	Global timer:TTimer
	Global synthlist:TList=New TList
	
	Field sample:TAudioSample
	Field channel:TChannel
	Field sound:TSound

	Field bits
	Field channels
	Field format
	Field fragsize		
	Field writepos
	
	Function eventhook:Object(id%,data:Object,context:Object)
		Local synth:TSynth
		If context=timer 
			For synth=EachIn synthlist
				synth.Poll
			Next
			Return Null
		EndIf
	End Function
	
	Method Poll()
		Local readpos
		Local count
		readpos=ChannelPlaying(channel)/channels
		If readpos=0 Return 'this channel is stopped
		count=((readpos+fragsize*2-writepos)/fragsize)
		While count
			Select bits
				Case 8
					Mix8
				Case 16
					Mix16
			End Select
			writepos=writepos+fragsize
			count=count-1
		Wend
	End Method

' mix the next .fragsize samples into .sample at (.writepos mod .fragsize)

	Method Mix8()
	End Method

	Method Mix16()
	End Method
		
	Method CreateSynth:TSynth(frag=8192,_bits=16,_channels=2)
		fragsize=frag
		bits=_bits
		channels=_channels
		If bits=16
			If channels=2			
				format=SF_STEREO16
			Else
				format=SF_MONO16
			EndIf			
		Else
			If channels=2
				format=SF_STEREO8
			Else
				format=SF_MONO8
			EndIf
		EndIf		
		sample=CreateAudioSample(fragsize*4,44100,format)	'SF_MONO8)
		MemClear sample.samples,sample.capacity
		channel=AllocChannel() 
		sound=LoadSound(sample,True)
		PlaySound sound,channel
		If Not timer
			timer=CreateTimer(100)
			AddHook EmitEventHook,eventhook,timer
		EndIf
		synthlist.AddLast Self
		Return Self
	End Method
	
	Function Close()
		If timer
			RemoveHook EmitEventHook,eventhook
			StopTimer timer
			timer=Null
		EndIf
	End Function

End Type

Type TMusicStream Extends TSynth

	Field Music:TMusic

	Method Mix8()
		Local b:Byte Ptr
		Local p,i	
		p=writepos Mod (fragsize*4)
		b=sample.samples+p*channels
		Music.FillBuffer(Int(p),fragsize*4)
	End Method

	Method Mix16()
		Local s:Short Ptr
		Local p,i
		p=writepos Mod (fragsize*4)
		s=Short Ptr sample.samples+p*channels
		Music.FillBuffer(Int(s),fragsize*4)
	End Method

	Function CreateMusicStream:TMusicStream(Music:TMusic)
		Local This:TMusicStream = New TMusicStream
		This.Music = Music
		This.CreateSynth(8192,16,2)
		Return This
	EndFunction

End Type




Local Music:TMusic = LoadMusic(RequestFile("Select music to play...",MusicExtensions())) 
If Not Music RuntimeError "Unable to open music"
If Not Music Notify "Unable to open music"
Local Stream:TMusicStream = TMusicStream.CreateMusicStream(Music:TMusic)

While True
	WaitEvent
	Print "yo!"
Wend</textarea> <br><br></td></tr></table><br>
<a name="753816"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Matthew Smith</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#16">[#16]</a></td></tr></table></td></tr><tr ><td class="posttext"> Redi,<br><br>Thanks for the update and the changes for SidPlayer! <br><br></td></tr></table><br>
<a name="753825"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >REDi</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#17">[#17]</a></td></tr></table></td></tr><tr ><td class="posttext"> No probs mate, give me a shout if you have problems with it.<br><br>Skid, how about filling the entire sample at creation first, then chasing the play cursor (filling in from the last write position to the play cursor), that way you should always have the entire sample size worth of audio prebuffered (less chance of glitches), also means you dont fill the buffer in same sized chuncks (more evenly spread cpu usage?)<br><br>See TAudioStream.Update in maxmod.mod/stream.bmx for an idea of how i done it for that.<br><br>Just a thought. Anyway thanks again, made my day that has! <br><br></td></tr></table><br>
<a name="753843"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Matthew Smith</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#18">[#18]</a></td></tr></table></td></tr><tr ><td class="posttext"> Everyone,<br><br>To simplify the playing of SIDs using Redi's excellent module, I have created a wrapper to give you access to the required items without flipping between the music and stream types.<br><br>example:<br><textarea class=codebox name="code" wrap=OFF readonly="true" rows="15" cols="80">
' load.bmx

Strict 
Framework BRL.GLMax2D 
Import REDi.MaxMod
Import SID.SIDStream

Graphics 800,600,0 

' initialize the MaxMod music system
InitMaxModStream()

' use the built-in SIDStream loader
Local Stream:SIDStream = New SIDStream
Stream.Load(RequestFile("Load a sid file"))

' start sid
Stream.Play()

Local Pitch# = 1
Repeat 

	Cls 
	DrawText "  ESCAPE = Exit",5,5
	DrawText "   SPACE = Play",5,20
	DrawText "       S = Stop",5,35
	DrawText "       P = Pause",5,50
	DrawText " UP/DOWN = Pitch",5,65
	
	DrawText "   PITCH = "+Pitch,5,125

	DrawText "TOTAL TRACKS = "+Stream.GetTrackCount(),5,170
	DrawText "       TRACK = "+Stream.CurrentTrack(),5,185
	DrawText "  LEFT/RIGHT = Select Track",5,200
	
	If KeyHit(KEY_S) 	 Then Stream.Stop()
	If KeyHit(KEY_SPACE) Then Stream.Play()
	If KeyHit(KEY_P) 	 Then Stream.Pause()
	If KeyDown(KEY_UP)	 Then Pitch:+0.001 ; Stream.SetHertz(Pitch)
	If KeyDown(KEY_DOWN) Then Pitch:-0.001 ; Stream.SetHertz(Pitch)
	If KeyHit(KEY_LEFT) Then Stream.SelectTrack(Stream.CurrentTrack()-1)
	If KeyHit(KEY_RIGHT) Then Stream.SelectTrack(Stream.CurrentTrack()+1)

	Flip True
	
Until KeyDown(KEY_ESCAPE) 
Stream.Free()
End

</textarea><br><br>Please download it from here <a href="http://www.projectstudioide.com/files/sidstream.zip" target="_blank">http://www.projectstudioide.com/files/sidstream.zip</a>  Unpack it into the \BlitzMax\mod\sid.mod folder<br><br>If anyone can tidy it up further go right ahead!! <br><br></td></tr></table><br>
<a name="754040"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >skidracer</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#19">[#19]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> Skid, how about filling the entire sample at creation first, then chasing the play cursor (filling in from the last write position to the play cursor), that way you should always have the entire sample size worth of audio prebuffered (less chance of glitches), also means you dont fill the buffer in same sized chuncks (more evenly spread cpu usage?)<br><br>See TAudioStream.Update in maxmod.mod/stream.bmx for an idea of how i done it for that. <br></div><br><br><br>Thanks, will take a look. <br><br>The theory behind current design is the mixer thread does force frag size on most drivers so I am most interested in syncing a synth to the mixer by having it poll at least twice the frequency of that frag length. <br><br>The Apple CoreAudio driver is a bit unique and it pulls what ever size it wants, I'm more into the fixed size, especially for decoder synths. Hmmm, changing the channel rate on a synth is going to be interesting, it's going to need fragsize * maximum rate for a buffer size, perhaps tsynth should extend tchannel so algorithmic synths can implement rate while decoder style streams get rate change for free but have to deliver more data. <br><br><br>Oh, also brl.freeaudioaudio now needs to maintain a reference to sample as pub.freeaudio is no longer making it's own copy of the memory so samples were going out of scope in my game, and when they were deleted  freeaudio starts playing corrupted memory which sounded pretty awful, quick hack:<br><br><textarea class=codebox name="code" wrap=OFF readonly="true" rows="15" cols="80">

Strict

Module BRL.FreeAudioAudio

ModuleInfo "Version: 1.06"
ModuleInfo "Author: Mark Sibly"
ModuleInfo "License: Blitz Shared Source Code"
ModuleInfo "Copyright: Blitz Research Ltd"
ModuleInfo "Modserver: BRL"

ModuleInfo "History: 1.06 Release"
ModuleInfo "History: Added Method TFreeAudioChannel.Position"
ModuleInfo "History: 1.05 Release"
ModuleInfo "History: Mono and 8 bit sample support added"

Import BRL.Audio
Import Pub.FreeAudio

Type TFreeAudioSound Extends TSound

	Field src:TAudioSample
	Field fa_sound
	
	Method Delete()
		fa_FreeSound fa_sound
	End Method

	Method Play:TFreeAudioChannel( alloced_channel:TChannel )
		Local channel:TFreeAudioChannel,fa_channel
		If alloced_channel
			channel=TFreeAudioChannel( alloced_channel )
			If Not channel Return
			fa_channel=channel.fa_channel
		EndIf		
		fa_channel=fa_PlaySound(fa_sound,False,fa_channel)
		If Not fa_channel Return
		If channel And channel.fa_channel=fa_channel Return channel
		Return TFreeAudioChannel.CreateWithChannel( fa_channel )
	End Method
	
	Method Cue:TFreeAudioChannel( alloced_channel:TChannel )
		Local channel:TFreeAudioChannel,fa_channel
		If alloced_channel
			channel=TFreeAudioChannel( alloced_channel )
			If Not channel Return
			fa_channel=channel.fa_channel
		EndIf
		fa_channel=fa_PlaySound( fa_sound,True,fa_channel )
		If Not fa_channel Return
		If channel And channel.fa_channel=fa_channel Return channel
		Return TFreeAudioChannel.CreateWithChannel( fa_channel )
	End Method

	Function CreateWithSound:TFreeAudioSound( fa_sound,	src:TAudioSample )
		Local t:TFreeAudioSound=New TFreeAudioSound
		t.fa_sound=fa_sound
		t.src=src
		Return t
	End Function
	
End Type

Type TFreeAudioChannel Extends TChannel

	Field fa_channel

	Method Stop()
		fa_StopChannel fa_channel
	End Method
	
	Method SetPaused( paused )
		fa_SetChannelPaused fa_channel,paused
	End Method
	
	Method SetVolume( volume# )
		fa_SetChannelVolume fa_channel,volume
	End Method
	
	Method SetPan( pan# )
		fa_SetChannelPan fa_channel,pan
	End Method
	
	Method SetDepth( depth# )
		fa_SetChannelDepth fa_channel,depth
	End Method
	
	Method SetRate( rate# )
		fa_SetChannelRate fa_channel,rate
	End Method
	
	Method Playing()
		Local status=fa_ChannelStatus( fa_channel ) &amp; ~(FA_CHANNELSTATUS_STOPPED)
'		If status Return True
		If status Return fa_ChannelPosition(fa_channel)+1
	End Method
	
	Method Position()
		Return fa_ChannelPosition( fa_channel )
	End Method
	
	Function CreateWithChannel:TFreeAudioChannel( fa_channel )
		Local t:TFreeAudioChannel=New TFreeAudioChannel
		t.fa_channel=fa_channel
		Return t
	End Function
	
End Type

Type TFreeAudioAudioDriver Extends TAudioDriver

	Method Enum$()
		Return _enum
	End Method
	
	Method Initialize()
		'***** Simon! *****
		If _ready fa_Close
		If fa_Init( _mode )&lt;&gt;-1
			atexit_ fa_Close
			_ready=True
		EndIf
		Return _ready
	End Method

	Method CreateSound:TSound( sample:TAudioSample,loop_flag )
		Assert _ready
		
		Local channels,bits
		
		Select sample.format
?BigEndian
		Case SF_MONO16LE
			sample=sample.Convert(SF_MONO16BE)
		Case SF_STEREO16LE
			sample=sample.Convert(SF_STEREO16BE)
?LittleEndian
		Case SF_MONO16BE
			sample=sample.Convert(SF_MONO16LE)
		Case SF_STEREO16BE
			sample=sample.Convert(SF_STEREO16LE)
?
		End Select
		If loop_flag loop_flag=-1
		channels=ChannelsPerSample[sample.format]
		If Not channels Return
		bits=8*BytesPerSample[sample.format]/channels
		Local fa_sound=fa_CreateSound( sample.length,bits,channels,sample.hertz,sample.samples,loop_flag )
		Return TFreeAudioSound.CreateWithSound( fa_sound,sample )
	End Method
	
	Method AllocChannel:TChannel()
		Assert _ready	
		Local fa_channel=fa_AllocChannel()
		If fa_channel Return TFreeAudioChannel.CreateWithChannel( fa_channel )
	End Method
		
	Function Create:TFreeAudioAudioDriver( enum$,mode )
		'***** need some kind of "exists but don't activate" init/check here *****
		Local t:TFreeAudioAudioDriver=New TFreeAudioAudioDriver
		t._enum=enum
		t._mode=mode
		Return t
	End Function
	
	Field _enum$,_mode,_ready
	
End Type

TFreeAudioAudioDriver.Create "FreeAudio Default",0
TFreeAudioAudioDriver.Create "FreeAudio DirectSound",1

SetAudioDriver "FreeAudio Default"
</textarea> <br><br></td></tr></table><br>
<a name="754046"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >skidracer</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#20">[#20]</a></td></tr></table></td></tr><tr ><td class="posttext"> Looks like streaming to OpenAL is not going to be quite as straight forward (your test has error in driver name) as there are no dynamic buffers, streamed samples are going to need to have multiple buffers that are queued which need to refresh from the dynamic sample, yuck. <br><br></td></tr></table><br>
<a name="754075"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >GfK</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#21">[#21]</a></td></tr></table></td></tr><tr ><td class="posttext"> There's something bothering me about all this streaming audio lark.<br><br>Blit3D's PlayMusic() handled it pretty well.  Why's Blitzmax apparently such a different kettle of fish? <br><br></td></tr></table><br>
<a name="754089"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Mark Tiffany</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#22">[#22]</a></td></tr></table></td></tr><tr ><td class="posttext"> Because b3d used FMOD, and max doesn't? <br><br></td></tr></table><br>
<a name="754091"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >GfK</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#23">[#23]</a></td></tr></table></td></tr><tr ><td class="posttext"> Yeah but my point is, is FMOD can do it, why is it proving to be so difficult for BRL? <br><br></td></tr></table><br>
<a name="754098"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >REDi</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#24">[#24]</a></td></tr></table></td></tr><tr ><td class="posttext"> GfK, IMHO the point is FMOD wasn't written in a week mate! Those guys also have years of experience in audio, way back to the amiga days IIRC.<br><br>(LOL @ driver name error) <br><br></td></tr></table><br>
<a name="754157"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >skidracer</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#25">[#25]</a></td></tr></table></td></tr><tr ><td class="posttext"> REDi, for freeaudio 1.20 which I think is now up on syncmods the channelplaying value now correctly returns position in samples so longer needs to be divided by channels, so where the synth has:<br><br>readpos=ChannelPlaying(channel)/channels<br><br>change to<br><br>readpos=ChannelPlaying(channel)<br><br>if you don't expect clicking buffer overruns... <br><br></td></tr></table><br>
<a name="754159"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >REDi</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#26">[#26]</a></td></tr></table></td></tr><tr ><td class="posttext"> yeah thanks mate, i figured that one already ;) nice work, sounding good with the default driver, but the directsound one still jumps about abit! (eg, when i use the mouse wheel to scroll in IE)<br><br>Anyway I'll just wait and see what you come up with for ogg/wav streaming, then I'll follow suit afterwards.<br><br>tester for maxmod users...<br><textarea class=codebox name="code" wrap=OFF readonly="true" rows="15" cols="80">
Strict

Import REDi.MaxMod

'SetAudioDriver "FreeAudio DirectSound"
SetAudioDriver "FreeAudio Default"

?BigEndian
Const SF_STEREO16=SF_STEREO16BE
Const SF_MONO16=SF_MONO16BE
?LittleEndian
Const SF_STEREO16=SF_STEREO16LE
Const SF_MONO16=SF_MONO16LE
?

Type TSynth

	Global timer:TTimer
	Global synthlist:TList=New TList
	
	Field sample:TAudioSample
	Field channel:TChannel
	Field sound:TSound

	Field bits
	Field channels
	Field format
	Field fragsize		
	Field writepos
	
	Function eventhook:Object(id%,data:Object,context:Object)
		Local synth:TSynth
		If context=timer 
			For synth=EachIn synthlist
				synth.Poll
			Next
			Return Null
		EndIf
	End Function
	
	Method Poll()
		Local readpos
		Local count
		readpos=ChannelPlaying(channel)
		If readpos=0 Return 'this channel is stopped
		count=((readpos+fragsize*2-writepos)/fragsize)
		While count
			Select bits
				Case 8
					Mix8
				Case 16
					Mix16
			End Select
			writepos=writepos+fragsize
			count=count-1
		Wend
	End Method

' mix the next .fragsize samples into .sample at (.writepos mod .fragsize)

	Method Mix8()
	End Method

	Method Mix16()
	End Method
		
	Method CreateSynth:TSynth(frag=8192,_bits=16,_channels=2)
		fragsize=frag
		bits=_bits
		channels=_channels
		If bits=16
			If channels=2			
				format=SF_STEREO16
			Else
				format=SF_MONO16
			EndIf			
		Else
			If channels=2
				format=SF_STEREO8
			Else
				format=SF_MONO8
			EndIf
		EndIf		
		sample=CreateAudioSample(fragsize*4,44100,format)	'SF_MONO8)
		MemClear sample.samples,sample.capacity
		channel=AllocChannel() 
		sound=LoadSound(sample,True)
		PlaySound sound,channel
		If Not timer
			timer=CreateTimer(100)
			AddHook EmitEventHook,eventhook,timer
		EndIf
		synthlist.AddLast Self
		Return Self
	End Method
	
	Function Close()
		If timer
			RemoveHook EmitEventHook,eventhook
			StopTimer timer
			timer=Null
		EndIf
	End Function

End Type








Type TMusicStream Extends TSynth

	Field Music:TMusic

	Method Mix16()
		Local p=writepos Mod (fragsize*4)
		Local s:Short Ptr = Short Ptr sample.samples+p*channels
		Music.FillBuffer(Int(s), fragsize*4)
	End Method

	Method CreateBuffer(Music:TMusic)
		Self.Music 	= Music
		fragsize	= 1024*12
		bits		= 16
		channels	= 2
		format		= SF_STEREO16
		sample		= CreateAudioSample(fragsize*4,Music.SAMPLE_RATE,format)
		channel		= AllocChannel() 
		sound		= LoadSound(sample,True)
		PlaySound sound,channel
		If Not timer
			timer=CreateTimer(100)
			AddHook EmitEventHook,eventhook,timer
		EndIf
		synthlist.AddLast Self
	EndMethod

	Function CreateMusicStream:TMusicStream(Music:TMusic)
		Local This:TMusicStream = New TMusicStream
		This.CreateBuffer(Music)
		Return This
	EndFunction

End Type



Local Music:TMusic = LoadMusic(RequestFile("Select music to play...",MusicExtensions())) 
If Not Music RuntimeError "Unable to open music"
'Music.Seti(MM_SAMPLERATE,22050)
'Music.Seti(MM_INTERPOLATION,MM_CATMULLROM)
Local Stream:TMusicStream = TMusicStream.CreateMusicStream(Music:TMusic)

While True
	WaitEvent
	Print "yo!"
Wend
</textarea><br>Note, since the syncmods it now works without altering any modules. if you have maxmod installed just copy, paste and run. <br><br></td></tr></table><br>
<a name="754168"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >skidracer</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#27">[#27]</a></td></tr></table></td></tr><tr ><td class="posttext"> Cool, that maxmod synth seems to play just fine on Apple and Linux although on Linux the mod continues to play even though the process is reportedly finished, very strange... <br><br></td></tr></table><br>
<a name="754171"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >REDi</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#28">[#28]</a></td></tr></table></td></tr><tr ><td class="posttext"> LOL, SWEET! <br><br></td></tr></table><br>
<a name="756911"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >anawiki</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#29">[#29]</a></td></tr></table></td></tr><tr ><td class="posttext"> REDi, make sure to bring no loop functionality with next release :)<br><br>best<br>Roman <br><br></td></tr></table><br>
<a name="758597"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >The Caffeine Kid</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#30">[#30]</a></td></tr></table></td></tr><tr ><td class="posttext"> What has happened to the site? :( <br><br></td></tr></table><br>
<a name="760266"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >u2o</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#31">[#31]</a></td></tr></table></td></tr><tr ><td class="posttext"> Redi's site is down, does anyone else have a link for the download?<br><br>Many thanks <br><br></td></tr></table><br>
<a name="760405"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >bursar</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#32">[#32]</a></td></tr></table></td></tr><tr ><td class="posttext"> Seek and ye shall find: <a href="http://www.blitzbasic.com/Community/posts.php?topic=67827" target="_blank">http://www.blitzbasic.com/Community/posts.php?topic=67827</a> :) <br><br></td></tr></table><br>
<a name="767888"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Russell</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#33">[#33]</a></td></tr></table></td></tr><tr ><td class="posttext"> Using the FreeAudio methodology, is this version compatible with all platforms?<br><br>And on that note, does the entire mod have to be sampled into memory, or could this also be streamed (using FreeAudio for cross-compatibility)? Sampling a 5 minute .xm file, uncompressed, could be quite large! ;)<br><br>Russell <br><br></td></tr></table><br>
<a name="778084"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >REDi</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#34">[#34]</a></td></tr></table></td></tr><tr ><td class="posttext"> Sorry guys, not online ATM, will be back soon I hope. to skint to be paying out on internet bills ATM.<br><br>Just to let you know work on maxmod is still going on, sound feking awesome now! and its a hell of a lot quicker to! <br><br></td></tr></table><br>
<a name="778087"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >popcade</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#35">[#35]</a></td></tr></table></td></tr><tr ><td class="posttext"> REDi, that's Good News and hope everything will going well.<br><br>I really hope there'll be the possibility to "plug" the module part of MaxMod into official audio system so we can have a TModule class or something and they'll be fully cross platfrom.<br><br>uGMOD have DSound/OpenAL implementations too, but have conflict with official moduls that make it inconvenient to use, I hope MaxMod can integrate everything well.... <br><br></td></tr></table><br>
<a name="867315"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Panno</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#36">[#36]</a></td></tr></table></td></tr><tr ><td class="posttext"> matts sid.mod link is down <br><br>have anyone an upload please .....<br><br><br>mfg <br><br></td></tr></table><br>
<a name="867339"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Matthew Smith</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#37">[#37]</a></td></tr></table></td></tr><tr ><td class="posttext"> Panno,<br><br>Sorry, removed the mod as Redi released a 1.20 version.  Have a quick check around the forums for this version. <br><br></td></tr></table><br>
<a name="869085"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Josepho</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#38">[#38]</a></td></tr></table></td></tr><tr ><td class="posttext"> Anybody knows why when I make the game change between the windowed mode and the fullscreen mode my music repeats some seconds using maxmod streaming?? Anybody knows if its possible to fix it?<br><br>Thanks <br><br></td></tr></table><br>
<a name="869377"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >REDi</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#39">[#39]</a></td></tr></table></td></tr><tr ><td class="posttext"> The repeating is caused by pauses in event handling being bigger than the audios circular buffer, you can make the streaming buffer bigger by changing the global variables used by maxmod... <br><br><pre class=code>
TDirectSoundAudioStream.buffersize = 44100*3
TOpenALAudioStream._buffersize = 1024*8
</pre><br><br>the values above are the defaults for maxmod, so you could  try doubling the buffer sizes, this should be enougth to fix the problem. <br><br></td></tr></table><br>
<a name="bottom"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td align="right"><a href="http://monkeycoder.co.nz" target="_blank"><img src="/img/monkey2.svg" ></a> <a href="https://github.com/blitz-research" target="_blank"><img src="/img/github.svg" ></a> <a href="https://discord.gg/qJccbSp" target="_blank"><img src="/img/discord.svg" ></a></td></tr></table><br></div><br><table width="100%"><tr><td></body></html lang="en">
