<!DOCTYPE html><html lang="en" ><head ><title >Detect Vertical Blank</title><meta name='viewport' content='width=device-width, initial-scale=0.66'><meta name='description' content='language:basic, target:desktop, category:game development'><link rel="styleSheet" href="../skins/granite/style.css" type="text/css"><style type="text/css">div.bbcode {padding: 8px;background: #E5E5E5;color: #000000;border: 1px dashed #B4B4BE;}</style></head><body ><table width=100% cellspacing=0 cellpadding=0><tr ><td class="menubarleft"></td><td class="menubar"><table cellspacing="0" cellpadding="0"><tr ><td >&nbsp;</td><td class="menuitemleft"></td><td class="menuitem"><a href="/" class="menuitem">News</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/forums.php" class="menuitem">Forums</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/codearcs.php" class="menuitem">Code</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/logs.php" class="menuitem">Logs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/gallery.php" class="menuitem">Gallery</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/sdkspecs.php" class="menuitem">Specs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/search.php" class="menuitem">Search</a></td><td class="menuitemright"></td></tr></table></td><td class="menubarright"></td></tr></table><div class="main"><h1 >Detect Vertical Blank</h1><a href="forums.php" >BlitzMax Forums</a>/<a href="topics.php?forum=103" >OpenGL Module</a>/<a href="#bottom" >Detect Vertical Blank</a><br><br>
<a name="898508"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >USNavyFish</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#1">[#1]</a></td></tr></table></td></tr><tr ><td class="posttext"> Could anyone point me to a method for detecting an imminent hardware refresh?<br><br>For some reason, I can't get FlipHook to work.  Do you need a Max2d context?  I'm using OGL in a MaxGUI Canvas.<br><br><br>In case you're wondering why I need it, I plan on doing the following:<br><br>Detect Vertical Blank<br>Flip current buffer<br>Draw updated graphics (to backbuffer)<br>While drawing, set "IS_DRAWING" = True<br>DO NOT FLIP once done drawing.  Set "IS_DRAWING" = False<br>Upon next Vertical Blank, check status of "IS_DRAWING"<br>If False, flip and repeat the whole process<br><br>If True, DO NOT FLIP.  Allow the draw function to continue drawing<br>Wait for the next Vertical Blank and check again.<br><br><br>The idea is that, with a 60hz refresh rate, the system will attempt to draw once every 1/60th of a second.   A buffer will already be 'ready' as soon as the system detects a vertical blank, and thus will be able to dump that completed buffer to the screen with no tearing.  If the draw function hasn't finished drawing the buffer, it skips the flip until the next 1/60th of a second cycle. In this case of just one flip 'skip', the true flip rate would be 30 flips per second for that short period of time.<br><br>This is probably how "Flip 1" works, but for whatever reason Flip 1 locks up my app and hogs CPU.   <br><br><br>Thanks for your assistance in advance. <br><br></td></tr></table><br>
<a name="898671"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >ImaginaryHuman</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#2">[#2]</a></td></tr></table></td></tr><tr ><td class="posttext"> Flip 1<br><br>detects the vertical blank and then flips the backbuffer. <br><br></td></tr></table><br>
<a name="898788"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >USNavyFish</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#3">[#3]</a></td></tr></table></td></tr><tr ><td class="posttext"> Yes, but as I said in my post...<br><br><div class="quote"> This is probably how "Flip 1" works, but for whatever reason Flip 1 locks up my app and hogs CPU. <br></div><br><br>Besides, I would like more precise control over my buffer flips.<br><br>There has to be a way to detect the vertical blank.  What about fliphook?  I couldn't get that to work but perhaps was doing it wrong. Has anyone used it? <br><br></td></tr></table><br>
<a name="898848"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >ImaginaryHuman</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#4">[#4]</a></td></tr></table></td></tr><tr ><td class="posttext"> It would be nice to have a WaitVBL command that just waits for the blank and then returns, but alas we don't got one. At the moment you have to flip at the same time as the vblank wait, and like you say it wastes cpu time.<br><br>You could use a timer to estimate when the vblank is about to occur and trigger a flip? <br><br></td></tr></table><br>
<a name="899141"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >USNavyFish</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#5">[#5]</a></td></tr></table></td></tr><tr ><td class="posttext"> Unfortunately that still causes tearing.  Sure, I can flip 60 or 30 or 15 times per second (assuming 60 hz), but there is no guarantee that my custom 'flip timer' will fire in sync with the VBL.   The phase shift between the two leads to tearing. <br><br></td></tr></table><br>
<a name="899256"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >ImaginaryHuman</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#6">[#6]</a></td></tr></table></td></tr><tr ><td class="posttext"> Unless every several frames you do a Flip 1 and resynchronize the flips with your timed flips. Not ideal I know. It would be really nice to have a WaitVBL command - maybe we can rip some code out from Flip()? or does it access the o/s to do it? <br><br></td></tr></table><br>
<a name="899297"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >USNavyFish</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#7">[#7]</a></td></tr></table></td></tr><tr ><td class="posttext"> Well, the flip() code is stored in BRL.mod -&gt; graphics.mod, under line 341.<br><br>The code is as follows:<br><br><pre class=code>
Function Flip( sync=-1 )
	RunHooks FlipHook,Null
	If sync&lt;&gt;-1
		_driver.Flip sync
		Return
	EndIf
	If _graphics&lt;&gt;_exGraphics Or Not _softSync
		Local sync=False
		If _gDepth sync=True
		_driver.Flip sync
		Return
	EndIf
	_syncTime:+_syncPeriod
	_syncAccum:+_syncFrac
	If _syncAccum&gt;=_syncRate
		_syncAccum:-_syncRate
		_syncTime:+1
	EndIf
	Local dt=_syncTime-MilliSecs()
	If dt&gt;0
		Delay dt
	Else
		_syncTime:-dt
	EndIf
	_driver.Flip False
End Function
</pre><br><br><br>I'll take a closer look and try to figure out what's going on here. <br><br></td></tr></table><br>
<a name="899466"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >ImaginaryHuman</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#8">[#8]</a></td></tr></table></td></tr><tr ><td class="posttext"> I think that the line: <pre class=code>_driver.Flip sync</pre> is the one which is calling a routine in the driver, which is probably platform specific, to do a Flip 0 or a Flip 1. The rest of the code seems to handle the Flip -1 condition. We'd have to look at the driver's Flip routine to see which parts of it are coded in BlitzMax and whether there is something there we can pull out to do just a vbl wait without flipping, otherwise it might involve dipping into C code or something. <br><br></td></tr></table><br>
<a name="899505"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >USNavyFish</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#9">[#9]</a></td></tr></table></td></tr><tr ><td class="posttext"> Are you sure about that?   <br><br>_driver is a TGraphicsObject, whose method "Flip" is the one we're looking at above.<br><br>It seems like there are several recursive calls to the Flip function from within itself.<br><br><br>My guess is that the various globals, namely:<br><br><pre class=code>Global _softSync,_syncRate,_syncPeriod,_syncFrac,_syncAccum,_syncTime</pre><br><br>Are somewhere registered with the platform-specific drivers, and an internal buffer swap is called by those drivers when conditions pertaining to the globals are met.    Perhaps when _syncFrac = 0.<br><br>Gah, where's Mark when you need him? <br><br></td></tr></table><br>
<a name="899533"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >ImaginaryHuman</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#10">[#10]</a></td></tr></table></td></tr><tr ><td class="posttext"> See this below code, for example, in Objective C format from the .m Mac file, as part of the GLGraphics module (part of the GL driver):<br><br><textarea class=codebox name="code" wrap=OFF readonly="true" rows="15" cols="80">void bbGLGraphicsFlip( int sync ){

	static int _sync=-1;
	
	if( !_currentContext ) return;
	
	sync=sync ? 1 : 0;
	if( sync!=_currentContext-&gt;sync ){
		_currentContext-&gt;sync=sync;
		[_currentContext-&gt;glContext setValues:(long*)&amp;sync forParameter:kCGLCPSwapInterval];
	}
	
	[_currentContext-&gt;glContext flushBuffer];
}
</textarea><br><br>And this was referenced in the GLGraphics.bmx file, so I'm sure the DX driver has its own code for flipping too. That's why I said you probably have to dip into C code to handle the verticle blank issue. I don't entirely follow what the above code is doing, either. It seems like it's using a GL graphics context and setting Sync to be a field within that type, either 1 or 0, and presumably the flushBuffer is actually doing the flip - presumably the vertical blank part of it is built into the o/s's implementation of OpenGL. You'd probably end up having to look at the o/s API itself to see if it provides a vblank wait that isn't tied to a flip. <br><br></td></tr></table><br>
<a name="899534"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >ImaginaryHuman</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#11">[#11]</a></td></tr></table></td></tr><tr ><td class="posttext"> I saw this on an Apple page: "OpenGL blocks drawing to the display while waiting for the next vertical retrace. Applications that attempt to draw to the screen during this waiting period waste time that could be spent performing other drawing operations or saving battery life and minimizing fan operation."            "The swap interval can be set only to 0 or 1. If the swap interval is set to 1, the buffers are swapped only during the vertical retrace. After you set up synchronization, call the function CGLFlushDrawable to copy the back buffer to the front buffer during the vertical retrace of the display."<br><br>which says to me that with GL you don't really get to detect the vblank yourself, it's part of the call to flip the display because when you're using OpenGL you have to use the GL flip function provided by the o/s.<br><br>I don't quite get what you plan to do. Lets say you spend half a frame rendering the next frame and you have several milliseconds of time spare, what else do you plan to do in that time? Further processing while somehow the hook just magically occurs when the flip is ready? You still have to poll for events to trigger the hook function. Are you hoping for a `test if the vertical blank happened yet` poll command, which returns with a true/false rather than waiting? How about you use Flip 1 to sync to vbl, then you know that you have about 15 milliseconds until the next vbl, so after you finish preparing the next frame you check the time and if the time hasn't arrive to do the next flip (approximately just before) you keep doing processing. Then you do a Flip 1 - it'll waste a little bit of time but not all of it. <br><br></td></tr></table><br>
<a name="899660"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >USNavyFish</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#12">[#12]</a></td></tr></table></td></tr><tr ><td class="posttext"> My program is entirely hook-based.  As a result, I need a logical way of calling the screen's redraw function, since I do not want to draw 'whenever possible,'  as this would interrupt the other timed functions.<br><br>The ideal case is to be able to hook into the VBL so I can call my redraw function exactly once per refresh.<br><br>I'm going to put this one on the back-burner and simply call my redraw function less frequently.  If anyone has used the "fliphook" function with success, I'd love to hear about it. <br><br></td></tr></table><br>
<a name="899815"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >ImaginaryHuman</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#13">[#13]</a></td></tr></table></td></tr><tr ><td class="posttext"> The flip hook is supposed to work. If it's not working, is it bugged? <br><br></td></tr></table><br>
<a name="899998"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >USNavyFish</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#14">[#14]</a></td></tr></table></td></tr><tr ><td class="posttext"> Perhaps I'm doing it wrong.. my assumption was that I simply Addhook(Fliphook,MyFlipHookFunc) like I would with any EmitEventHook, and then it will simply call MyFlipHookFunc once every flip.  hmf <br><br></td></tr></table><br>
<a name="900002"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >tonyg</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#15">[#15]</a></td></tr></table></td></tr><tr ><td class="posttext"> It would help to have a small example which shows the problem. <br><br></td></tr></table><br>
<a name="bottom"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td align="right"><a href="http://monkeycoder.co.nz" target="_blank"><img src="/img/monkey2.svg" ></a> <a href="https://github.com/blitz-research" target="_blank"><img src="/img/github.svg" ></a> <a href="https://discord.gg/qJccbSp" target="_blank"><img src="/img/discord.svg" ></a></td></tr></table><br></div><br><table width="100%"><tr><td></body></html lang="en">
