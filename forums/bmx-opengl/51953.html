<!DOCTYPE html><html lang="en" ><head ><title >Nehe 19: 2500 Particles (Xcode) vs 150 (BlitzMax)</title><meta name='viewport' content='width=device-width, initial-scale=0.66'><meta name='description' content='language:basic, target:desktop, category:game development'><link rel="styleSheet" href="../skins/granite/style.css" type="text/css"><style type="text/css">div.bbcode {padding: 8px;background: #E5E5E5;color: #000000;border: 1px dashed #B4B4BE;}</style></head><body ><table width=100% cellspacing=0 cellpadding=0><tr ><td class="menubarleft"></td><td class="menubar"><table cellspacing="0" cellpadding="0"><tr ><td >&nbsp;</td><td class="menuitemleft"></td><td class="menuitem"><a href="/" class="menuitem">News</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/forums.php" class="menuitem">Forums</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/codearcs.php" class="menuitem">Code</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/logs.php" class="menuitem">Logs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/gallery.php" class="menuitem">Gallery</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/sdkspecs.php" class="menuitem">Specs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/search.php" class="menuitem">Search</a></td><td class="menuitemright"></td></tr></table></td><td class="menubarright"></td></tr></table><div class="main"><h1 >Nehe 19: 2500 Particles (Xcode) vs 150 (BlitzMax)</h1><a href="forums.php" >BlitzMax Forums</a>/<a href="topics.php?forum=103" >OpenGL Module</a>/<a href="#bottom" >Nehe 19: 2500 Particles (Xcode) vs 150 (BlitzMax)</a><br><br>
<a name="579736"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >salric</td><td align="right"><font class=tiny>(Posted 2005)</font>&nbsp;<a href="#1">[#1]</a></td></tr></table></td></tr><tr ><td class="posttext"> Hi All,<br><br>I've been going through the excellent NeHe tutorials (thanks very much to Extron for converting them to Blitzmax) - noticing that tutorial #19 seems very slow on my Powerbook G4. To get a decent framerate above 30fps I reduced the maximum number of particles to 150 (the default is 1000). I thought this to be an extremely low count so I went back to the NeHe site &amp; downloaded an XCode (Cocoa) version, it will perform smoothly at over 2500 particles.<br><br>You can find the OSX code at the bottom of this page:<br><a href="http://nehe.gamedev.net/data/lessons/lesson.asp?lesson=19" target="_blank">http://nehe.gamedev.net/data/lessons/lesson.asp?lesson=19</a><br><br>In case you don't know, the blitzmax code can be found on this thread:<br><a href="http://www.blitzbasic.com/Community/posts.php?topic=41689" target="_blank">http://www.blitzbasic.com/Community/posts.php?topic=41689</a><br><br>Can anyone shed some light on this matter of differing performance between the Blitzmax &amp; XCode versions? <br><br></td></tr></table><br>
<a name="579741"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Sveinung</td><td align="right"><font class=tiny>(Posted 2005)</font>&nbsp;<a href="#2">[#2]</a></td></tr></table></td></tr><tr ><td class="posttext"> I have no problems runnig either of them. You will get the same result if you set the swapinterval to zero in the max example, I think.<br><br>Sveinung <br><br></td></tr></table><br>
<a name="579747"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >salric</td><td align="right"><font class=tiny>(Posted 2005)</font>&nbsp;<a href="#3">[#3]</a></td></tr></table></td></tr><tr ><td class="posttext"> Thanks for the reply - I tried setting the swapinterval to zero and this had no effect. Just in case anyone else asks I'm not running in debug mode either. <br><br></td></tr></table><br>
<a name="579825"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >T-Light</td><td align="right"><font class=tiny>(Posted 2005)</font>&nbsp;<a href="#4">[#4]</a></td></tr></table></td></tr><tr ><td class="posttext"> No problems on the PC version of Max.<br>Whether the settings are<br>MAX_PARTICLES=150<br>or<br>MAX_PARTICLES=2500<br>the frame rates remain at a constant 61fps <br><br></td></tr></table><br>
<a name="579891"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >LarsG</td><td align="right"><font class=tiny>(Posted 2005)</font>&nbsp;<a href="#5">[#5]</a></td></tr></table></td></tr><tr ><td class="posttext"> 1000 ran just fine.. so did 2500..<br>I even got 25000 running at 56 fps.. :p <br><br></td></tr></table><br>
<a name="580560"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >salric</td><td align="right"><font class=tiny>(Posted 2005)</font>&nbsp;<a href="#6">[#6]</a></td></tr></table></td></tr><tr ><td class="posttext"> I've just tested the same code under an iMac G5; the issues with performance are the same under this platform. If anyone could test these examples under the OSX platform I would appreciate it.<br><br>Thanks. <br><br></td></tr></table><br>
<a name="580948"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >bortels</td><td align="right"><font class=tiny>(Posted 2005)</font>&nbsp;<a href="#7">[#7]</a></td></tr></table></td></tr><tr ><td class="posttext"> Just tried both on Dual G5 Powermac - same results. Cocoa version very fast, BMax version dog slow (6 to 7 fps). Commenting out the actual for loop that draws the particles brings it up to 60, so we're looking at something in there.<br><br>So, I poked around commenting things out - and the thing that's slowing stuff down are the "If (KeyDown..." statements, surprisingly enough - commenting them out brings the framerate back up to 60. Even leaving the single "If KeyDown(KEY_TAB)" brought the fps down to 30. And this is without touching the keys during the run, so it's not the content of the if statements - it's the actual checks. <br><br>... time passes...<br><br>Ah. They're inside the "For loop=0 to MAX_PARTICLES-1" loop - that explains it. Rather than check those keys once per frame, we're checking once per particle - presumably as a cheap way to adjust all of the particles. Dandy, but slow.<br><br>Moving those If statements to outside that loop, and changing them to the form:<br><pre class=code>
			If (KeyDown(KEY_NUM8)) And (particle[loop].yg&lt;1.5) 
				For n = 0 To MAX_PARTICLES-1
					particle[n].yg:+0.01
				Next
			EndIf
</pre><br>Gives us a nice 60 fps.<br><br>(Edited for code clarity) <br><br></td></tr></table><br>
<a name="580950"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >bortels</td><td align="right"><font class=tiny>(Posted 2005)</font>&nbsp;<a href="#8">[#8]</a></td></tr></table></td></tr><tr ><td class="posttext"> As a followup now that I think of it - it then makes no sense that the PC version would work without slowdown, as it's doing the same work - unless the implementation of KeyDown is signficantly cheaper on the PC.<br><br>And in fact, on my older PC (Intel P4 2.4 Ghz, 3/4 gig of ram, ATI video card) I get 35 fps with the unmodified version. My guess is the other PC testers had better hardware than I do :-)<br><br>And - the KeyDown code on the mac appears to be significantly slower than on the PC. I am sad.<br><br>UPDATE: I filed a bug report on the slow KeyDown issue in the bugs forum... <br><br></td></tr></table><br>
<a name="581604"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >salric</td><td align="right"><font class=tiny>(Posted 2005)</font>&nbsp;<a href="#9">[#9]</a></td></tr></table></td></tr><tr ><td class="posttext"> Bortels,<br><br>Thanks very much for solving this problem, the last thing I expected it to be is KeyDown checking! On the iMac G5 the demo in mention now moves around 20,000 particles at full-frame. I'm very impressed. <br><br>Another point of interest is it takes about 1 minute to create 20,000 instances of the particle type in the array. I've tried putting a flushmem in the loop however it makes very little diffference. Interesting?<br><br>Thanks again Bortels - you're a champion!! <br><br></td></tr></table><br>
<a name="581686"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Robert Cummings</td><td align="right"><font class=tiny>(Posted 2005)</font>&nbsp;<a href="#10">[#10]</a></td></tr></table></td></tr><tr ><td class="posttext"> The init stuff is likely to be much faster in the next blitzmax update. <br><br></td></tr></table><br>
<a name="582784"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Dreamora</td><td align="right"><font class=tiny>(Posted 2005)</font>&nbsp;<a href="#11">[#11]</a></td></tr></table></td></tr><tr ><td class="posttext"> There is a simple reason initialisation takes that long: One of the worst possible implementations for the particle array's init ... (might be nice for C++ but deadly for BM with its memory management where resizing an array means much more of work than just resizing a memory block)<br><br>Change the following code:<br><br><pre class=code>Function InitGl()
	LoadGlTextures()
	glEnable(GL_TEXTURE_2D)											' Enable Texture Mapping
	glShadeModel(GL_SMOOTH)											' Enable Smooth Shading
	glClearColor(0.0, 0.0, 0.0, 0.0)									' Black Background
	glClearDepth(1.0)													' Depth Buffer Setup
	glDisable(GL_DEPTH_TEST)											' Disable Depth Testing
	glEnable(GL_BLEND)												' Enable Blending
	glBlendFunc(GL_SRC_ALPHA,GL_ONE)									' Type Of Blending To Perform
	glDepthFunc(GL_LEQUAL)												' The Type Of Depth Testing To Do
	glHint(GL_PERSPECTIVE_CORRECTION_HINT, GL_NICEST)					' Really Nice Perspective Calculations
	glHint(GL_POINT_SMOOTH_HINT,GL_NICEST)								' Really Nice Point Smoothing
	glBindTexture(GL_TEXTURE_2D,Texname)								' Select Our Texture

	For loop=0 To MAX_PARTICLES-1										' Initials All The Textures
		particle=particle:particles[..loop+1]
		particle[loop]=New particles
</pre><br><br>to<br><br><pre class=code>Function InitGl()
	LoadGlTextures()
	glEnable(GL_TEXTURE_2D)											' Enable Texture Mapping
	glShadeModel(GL_SMOOTH)											' Enable Smooth Shading
	glClearColor(0.0, 0.0, 0.0, 0.0)									' Black Background
	glClearDepth(1.0)													' Depth Buffer Setup
	glDisable(GL_DEPTH_TEST)											' Disable Depth Testing
	glEnable(GL_BLEND)												' Enable Blending
	glBlendFunc(GL_SRC_ALPHA,GL_ONE)									' Type Of Blending To Perform
	glDepthFunc(GL_LEQUAL)												' The Type Of Depth Testing To Do
	glHint(GL_PERSPECTIVE_CORRECTION_HINT, GL_NICEST)					' Really Nice Perspective Calculations
	glHint(GL_POINT_SMOOTH_HINT,GL_NICEST)								' Really Nice Point Smoothing
	glBindTexture(GL_TEXTURE_2D,Texname)								' Select Our Texture
	particle= new particles[MAX_PARTICLES]
	For loop=0 To MAX_PARTICLES-1	</pre><br><br><br>This should speed the whole thing quite a little up <br><br></td></tr></table><br>
<a name="582852"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >salric</td><td align="right"><font class=tiny>(Posted 2005)</font>&nbsp;<a href="#12">[#12]</a></td></tr></table></td></tr><tr ><td class="posttext"> Dreamora, this is really excellent! The improvement in speed is amazing!<br><br>Thank you! <br><br></td></tr></table><br>
<a name="bottom"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td align="right"><a href="http://monkeycoder.co.nz" target="_blank"><img src="/img/monkey2.svg" ></a> <a href="https://github.com/blitz-research" target="_blank"><img src="/img/github.svg" ></a> <a href="https://discord.gg/qJccbSp" target="_blank"><img src="/img/discord.svg" ></a></td></tr></table><br></div><br><table width="100%"><tr><td></body></html lang="en">
