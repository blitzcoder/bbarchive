<!DOCTYPE html><html lang="en" ><head ><title >MT Memory issues (GC?)</title><meta name='viewport' content='width=device-width, initial-scale=0.66'><meta name='description' content='language:basic, target:desktop, category:game development'><link rel="styleSheet" href="../skins/granite/style.css" type="text/css"><style type="text/css">div.bbcode {padding: 8px;background: #E5E5E5;color: #000000;border: 1px dashed #B4B4BE;}</style></head><body ><table width=100% cellspacing=0 cellpadding=0><tr ><td class="menubarleft"></td><td class="menubar"><table cellspacing="0" cellpadding="0"><tr ><td >&nbsp;</td><td class="menuitemleft"></td><td class="menuitem"><a href="/" class="menuitem">News</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/forums.php" class="menuitem">Forums</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/codearcs.php" class="menuitem">Code</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/logs.php" class="menuitem">Logs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/gallery.php" class="menuitem">Gallery</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/sdkspecs.php" class="menuitem">Specs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/search.php" class="menuitem">Search</a></td><td class="menuitemright"></td></tr></table></td><td class="menubarright"></td></tr></table><div class="main"><h1 >MT Memory issues (GC?)</h1><a href="forums.php" >Archives Forums</a>/<a href="topics.php?forum=105" >BlitzMax Bug Reports</a>/<a href="#bottom" >MT Memory issues (GC?)</a><br><br>
<a name="1037049"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >ima747</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#1">[#1]</a></td></tr></table></td></tr><tr ><td class="posttext"> See thread at <a href="/posts.php?topic=91075" target="_blank">http://www.blitzbasic.com/Community/posts.php?topic=91075</a> for further details and some sample code.<br><br>First off I never had any of these problems before I converted my project to MT, but I converted it because I NEEDED multithreading for a specific feature that's critical so I can't go back now.<br><br>I can't get it to manifest the same in the test example as in my program. But it seems memory blocks can get juggled at unexpected times, causing large reads to fail and crash (e.g. when doing a TPixmap.Convert() it will crash while iterating through the pixels sometimes...)<br><br>However it manifests differently in the example posted in the thread.<br><br>Further more using some other modules (freeimage from Brucy specifically) I'll get a spinlock while a module tries to free some memory, and the main thread locks up waiting for a semaphore (I assume related to a memory clear, it usually comes from the event que getting managed...).<br><br>This happens when copies etc. are done in child threads or the main thread.<br><br>I can't get any example I try to punch up to reproduce the same problems as any other examples (they also tend to crash or hang differently in debug vs normal build) but they all have problems when you start juggling chunks of data.<br><br>I've been hacking away at the MT garbage collector to see if I can get any more details, but I can't get anything reliable. I have however made 2 modifications:<br>First, I made the collect function return right away if the GC is suspended. It would return from manual collects, but it looked like auto collects would still get fired.<br>Second, I made the auto collect when creating a new memory alloc always fire by removing the heap check, as some examples would just hemorage memory otherwise.<br><br>I'm happy to try anything or provide as much sample code as possible. I can send my current main project with the pixmap.convert() specific crash to Blitz directly if so desired but it's under some copywrites etc. so I can't publicly release it.<br><br>Any thoughts of stuff to try, or examples to test, or questions about the crashes etc. please don't hesitate, I'm spending all my time on this at the moment as I NEED to get it fixed. <br><br></td></tr></table><br>
<a name="1037368"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >ima747</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#2">[#2]</a></td></tr></table></td></tr><tr ><td class="posttext"> Probably related to all of this, but I'm getting crashes on mac on occasion where a child thread will die, and it's trace just shows a ton of calls to "mark + 72" which I assume is referencing <br>static void mark( void *p )<br>in blitz.mod/blitz_gc_ms.c line 256<br><br>It seems to me (bearing in mind that I still don't fully understand the structures and methodology behind the MT GC system) that mark is getting recursively called forever.. which shouldn't be possible since it's flagging before the recursive calls... either that or the block it's iterating through is getting shifted (like the pixmap convert blocks mentioned earlier) while it's iterating and therefore it's going off into some other part of memory, and trying to mark something and that's crashing... <br><br></td></tr></table><br>
<a name="bottom"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td align="right"><a href="http://monkeycoder.co.nz" target="_blank"><img src="/img/monkey2.svg" ></a> <a href="https://github.com/blitz-research" target="_blank"><img src="/img/github.svg" ></a> <a href="https://discord.gg/qJccbSp" target="_blank"><img src="/img/discord.svg" ></a></td></tr></table><br></div><br><table width="100%"><tr><td></body></html lang="en">
