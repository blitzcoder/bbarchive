<!DOCTYPE html><html lang="en" ><head ><title >Issue with GC in Multi-threaded environments</title><meta name='viewport' content='width=device-width, initial-scale=0.66'><meta name='description' content='language:basic, target:desktop, category:game development'><link rel="styleSheet" href="../skins/granite/style.css" type="text/css"><style type="text/css">div.bbcode {padding: 8px;background: #E5E5E5;color: #000000;border: 1px dashed #B4B4BE;}</style></head><body ><table width=100% cellspacing=0 cellpadding=0><tr ><td class="menubarleft"></td><td class="menubar"><table cellspacing="0" cellpadding="0"><tr ><td >&nbsp;</td><td class="menuitemleft"></td><td class="menuitem"><a href="/" class="menuitem">News</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/forums.php" class="menuitem">Forums</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/codearcs.php" class="menuitem">Code</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/logs.php" class="menuitem">Logs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/gallery.php" class="menuitem">Gallery</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/sdkspecs.php" class="menuitem">Specs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/search.php" class="menuitem">Search</a></td><td class="menuitemright"></td></tr></table></td><td class="menubarright"></td></tr></table><div class="main"><h1 >Issue with GC in Multi-threaded environments</h1><a href="forums.php" >Archives Forums</a>/<a href="topics.php?forum=105" >BlitzMax Bug Reports</a>/<a href="#bottom" >Issue with GC in Multi-threaded environments</a><br><br>
<a name="1021840"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rozek</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#1">[#1]</a></td></tr></table></td></tr><tr ><td class="posttext"> Well,<br><br>as usual in such a situation, it is difficult to isolate the problem, but: it seems that (under Mac OS X, at least) the GC for MT applications causes crashes.<br><br>See <a href="http://www.blitzmax.com/Community/posts.php?topic=89912" target="_blank">http://www.blitzmax.com/Community/posts.php?topic=89912</a> and <a href="http://www.blitzmax.com/Community/posts.php?topic=88578#1005858" target="_blank">http://www.blitzmax.com/Community/posts.php?topic=88578#1005858</a> for descriptions.<br><br>Just contact me if you need more information and I'll see what I can do...this issue prevents me from continuing with my development (I'll see if I can live with a single-threaded app in the beginning...)<br><br>Thanks in advance for your effort! <br><br></td></tr></table><br>
<a name="1021974"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rozek</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#2">[#2]</a></td></tr></table></td></tr><tr ><td class="posttext"> Ok,<br><br>meanwhile (and with the help of others!) I've been able to isolate the problem and develop a workaround (for a particular type of problem, at least)<br><br>The underlying problem is: destructor methods get called from outside the main thread (i.e. from within non-main threads) and do "things" which should only be done from within the main thread!<br><br>One such destructor is that of "TGLImageFrame", which internally invokes "glDeleteTextures", which then crashes the application.<br><br>A workaround for that particular destructor can be found at the end of <a href="http://www.blitzmax.com/Community/posts.php?topic=89912" target="_blank">http://www.blitzmax.com/Community/posts.php?topic=89912</a><br><br>As a more generic approach, I would suggest a <pre class=code>function invoke_async (handler(data:object), data:object)
end function</pre><br>which accepts a "handler" together with all the "data" it needs and invokes it the next time "waitevent" (or similar) is called from within the main thread. The "handler" could then do anything that should not be done within subthreads.<br><br>This would still require the programmer to think about any potential problems within destructors but would also allow her/him to tackle such issues relatively painlessly. <br><br></td></tr></table><br>
<a name="1022152"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >marksibly</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#3">[#3]</a></td></tr></table></td></tr><tr ><td class="posttext"> Hi,<br><br>Nice find!<br><br>What I think I'll do for now is queue up 'dead' gl textures like this and flush the queue before allocating new ones. Does that sound OK? I'm not too keen on adding a new global invoke_async() handler until we have more than one use-case to go by...also, this way should be able to handle GL contexts on non-main threads (to a degree...)?<br><br>Can anyone think of any other situations like this?<br><br>As far as I know, OpenAL is not architected to be 'context-per-thread' the way GL is, so I don't think that's a problem. <br><br></td></tr></table><br>
<a name="1022223"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rozek</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#4">[#4]</a></td></tr></table></td></tr><tr ><td class="posttext"> Hello Mark!<br><br>Queuing up dead textures and freeing them later sounds ok - just make sure that you free them in the main thread ;-)<br><br>It's ok not to add s.th. like "invoke_async" although I mainly had user-defined situations (not only destructors but also, e.g., MaxGUI-related operations) in mind for this routine: Java is in a similar situation with its "Swing" package and solves this using an "invokeLater" method which does exactly what the "invoke_async" (or similar) should do.<br><br>On the other hand: such an "invoke_async" can easily be emulated using an approach similar to what I am currently doing with "glDeleteTextures" - thus, there is no urgent need for *you* to provide it.<br><br>Nevertheless, thanks for fixing this bug! <br><br></td></tr></table><br>
<a name="bottom"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td align="right"><a href="http://monkeycoder.co.nz" target="_blank"><img src="/img/monkey2.svg" ></a> <a href="https://github.com/blitz-research" target="_blank"><img src="/img/github.svg" ></a> <a href="https://discord.gg/qJccbSp" target="_blank"><img src="/img/discord.svg" ></a></td></tr></table><br></div><br><table width="100%"><tr><td></body></html lang="en">
