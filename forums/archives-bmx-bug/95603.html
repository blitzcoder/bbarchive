<!DOCTYPE html><html lang="en" ><head ><title >DesktopWidth/Height fail in full-screen (Win32)</title><meta name='viewport' content='width=device-width, initial-scale=0.66'><meta name='description' content='language:basic, target:desktop, category:game development'><link rel="styleSheet" href="../skins/granite/style.css" type="text/css"><style type="text/css">div.bbcode {padding: 8px;background: #E5E5E5;color: #000000;border: 1px dashed #B4B4BE;}</style></head><body ><table width=100% cellspacing=0 cellpadding=0><tr ><td class="menubarleft"></td><td class="menubar"><table cellspacing="0" cellpadding="0"><tr ><td >&nbsp;</td><td class="menuitemleft"></td><td class="menuitem"><a href="/" class="menuitem">News</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/forums.php" class="menuitem">Forums</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/codearcs.php" class="menuitem">Code</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/logs.php" class="menuitem">Logs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/gallery.php" class="menuitem">Gallery</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/sdkspecs.php" class="menuitem">Specs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/search.php" class="menuitem">Search</a></td><td class="menuitemright"></td></tr></table></td><td class="menubarright"></td></tr></table><div class="main"><h1 >DesktopWidth/Height fail in full-screen (Win32)</h1><a href="forums.php" >Archives Forums</a>/<a href="topics.php?forum=105" >BlitzMax Bug Reports</a>/<a href="#bottom" >DesktopWidth/Height fail in full-screen (Win32)</a><br><br>
<a name="1102296"></a>

<a name="1102299"></a>

<a name="1102302"></a>

<a name="1102303"></a>

<a name="1102329"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >BlitzSupport</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#1">[#1]</a></td></tr></table></td></tr><tr ><td class="posttext"> [EDIT: Oh, God, apologies, Mark... see 4th post as to why I'm wrong, so far anyway. I think it's worth a read for people, though!]<br><br>I think this is something people have just assumed you have to call before going full-screen, but I think it's wrong...<br><br><pre class=code>
DesktopWidth...

int bbSystemDesktopWidth(){
	return GetDeviceCaps( GetDC( GetDesktopWindow() ),HORZRES );
}
</pre><br><br>According to the Win32 GetDeviceCaps docs, HORZRES is "Width, in pixels, of the screen". However, that relates to the <i>currently set display mode</i>, not the desktop size. (In fairness, the desktop is resized to the current display mode behind the scenes, but that's invisible to the user  if the program cleans up properly, and frankly not much use to us anyway.)<br><br>This was made clearer when I experimented in <a href="/posts.php?topic=95596#1102275" target="_blank">this thread</a>, which should show that this code should be updated to reflect MaxGUI's <i>GadgetWidth (Desktop ())</i>.<br><br>This shouldn't cause any problems as far as I can see. It will simply mean that programs get the correct desktop resolution on Windows, regardless of whether it's stored before Graphics or while running in another display mode.<br><br><i>* In full-screen mode -- it's already correct in windowed mode because the display size </i>is<i> the desktop size</i>.<br><br>In effect, in full-screen mode it currently just returns the current GraphicsWidth* instead of what it's meant to return.<br><br>Another reason I've jumped on this is because it caused me to have to provide a really ugly "InitVirtualGfx" hack in <a href="/codearcs.php?code=2879" target="_blank">this Code Archives entry</a>!<br><br><font class="tiny">Last edited 2011</font><br><br><font class="tiny">Last edited 2011</font> <br><br></td></tr></table><br>
<a name="1102312"></a>

<a name="1102316"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >GfK</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#2">[#2]</a></td></tr></table></td></tr><tr ><td class="posttext"> Reported this many months ago and was told it was normal behaviour. :/<br><br>[Edit] <a href="http://www.blitzbasic.com/Community/posts.php?topic=90148#1024959" target="_blank">http://www.blitzbasic.com/Community/posts.php?topic=90148#1024959</a><br><br><font class="tiny">Last edited 2011</font> <br><br></td></tr></table><br>
<a name="1102320"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >BlitzSupport</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#3">[#3]</a></td></tr></table></td></tr><tr ><td class="posttext"> Well, he said he couldn't find a way to get the right display size, but I reckon I've explained it in the <a href="/posts.php?topic=95596#1102275" target="_blank">linked post</a>. Hopefully what I've posted <a href="/posts.php?topic=95596#1102317" target="_blank">here</a> can be confirmed by RobA. I mean, like the man said, "I'm just gonna leave it as is for know unless someone has an better ideas"!<br><br>Dunno about the Mac, but I think this should actually trump consistent behaviour -- if the Mac can't provide the primary monitor's display size, that's its problem! (But again, no existing code should break anyway; if anything, it should 'fix', to get the correct size!) <br><br></td></tr></table><br>
<a name="1102327"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >BlitzSupport</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#4">[#4]</a></td></tr></table></td></tr><tr ><td class="posttext"> Oh, cripes, I think Mark was right, actually.<br><br>When you think about it, Windows can treat the desktop as if it's the size of combined multiple monitors' <i>current</i> resolutions, which can be independently set, though I'm not even going to go there:<br><br><pre class=code>
Monitor #1: 640 x 480
Monitor #2: 640 x 480

Windows desktop: 1280 x 480
</pre><br><br>This is (partially) dependent on whether the graphics drivers have been set to clone the desktop (which would return the 'correct' size of the first display) or to spread across both (or even <i>&gt; 2</i>).<br><br>Regardless, any attempt to return the (Windows) desktop size is going to return either a) the combined size of all monitors, or b) the primary monitor's current resolution, depending on driver settings, Windows monitor settings and how you try to retrieve them.<br><br>The Windows desktop takes on the resolution of the current display size, whether the driver is treating the display as a single monitor (which may be duplicated) or spreading it across multiple. It's restored when the display is set back to the original display mode (eg. 1920 x 1080 desktop, game opens 640 x 480 screen [at which point desktop is 640 x 480, and may remain that way if game crashes], restores display mode to original 1920 x 1080, on which the desktop resizes again to 1920 x 1080).<br><br>Take into account that another OS could treat its monitors and desktop completely differently, and I'm not surprised that so few products take multiple displays into account -- and I'll bet those that do could be easily tripped up.<br><br>My suggestion of using MaxGUI's <i>GadgetWidth (Desktop ())</i>, which returns the correct desktop size regardless of whether it's spread across one monitor or multiple, doesn't update when you Alt-Tab out and change the display resolution. In fact, after messing about with this too much, the Nvidia Control Panel kept freezing and eventually I hung the whole desktop! (Had to reboot.)<br><br>Still working on this... <br><br></td></tr></table><br>
<a name="1102333"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >BlitzSupport</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#5">[#5]</a></td></tr></table></td></tr><tr ><td class="posttext"> Nope! My belief, based on past explorations and this evening's experiments, is that the Windows desktop simply adapts to whatever the <u>current</u> physical display resolution is <i>on the monitor</i> (and this is dependent on the fact that the graphics card may be presenting two or more monitor/s as one), and that all you can do is store whatever it is <i>before</i> you change the display size.<br><br>I do have one last hope (based on EnumDisplayMonitors/GetMonitorInfo[A] and/or EnumDisplayDevices), but my tests are failing here so far... <br><br></td></tr></table><br>
<a name="1102334"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >GfK</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#6">[#6]</a></td></tr></table></td></tr><tr ><td class="posttext"> He probably is right - but then DesktopWidth shouldn't be called that if its not reporting the width of the desktop! <br><br></td></tr></table><br>
<a name="1102339"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Floyd</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#7">[#7]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote">  ...the Windows desktop simply adapts to whatever the current physical display resolution... <br></div><br>That's consistent with an aggravation from the distant past, back when 640x480 was a common resolution for full screen games. When one of them crashed the desktop was left in the same resolution. Icons were automatically relocated to fit the screen. I could reset a higher desktop resolution, but that left the icons stuffed into the upper left quadrant. <br><br></td></tr></table><br>
<a name="1102343"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >BlitzSupport</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#8">[#8]</a></td></tr></table></td></tr><tr ><td class="posttext"> I sort of agree, but I think if the docs were amended to state that you have to call it before a Graphics call, then it would be correct, based on how Windows's desktop appears to work. Unfortunately, I (mostly) believe that the above is true!<br><br>I'm fiddling with <a href="http://msdn.microsoft.com/en-us/library/dd162609(v=vs.85).aspx" target="_blank">EnumDisplayDevices</a>, which I should be able to force to the primary display device (monitor) (basing this on the DEVMODE structure used by <a href="http://msdn.microsoft.com/en-us/library/dd183411(v=vs.85).aspx" target="_blank">ChangeDisplaySettings</a>), but again it's crashing its ass off, so I'm going to have another go in (whisper) PB. However, I still think that even if I get it to work, it's going to read whatever the *current* monitor display mode is!<br><br>I'm pretty much resigned to having to store the desktop size before opening a display -- I believe this is how Windows works. <br><br></td></tr></table><br>
<a name="1102344"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >GfK</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#9">[#9]</a></td></tr></table></td></tr><tr ><td class="posttext"> Way I see it, Windows knows what your desktop resolution is.  Even if it changes when something goes full screen, it knows how to change it back.  So the info has to be in there somewhere. <br><br></td></tr></table><br>
<a name="1102347"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >BlitzSupport</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#10">[#10]</a></td></tr></table></td></tr><tr ><td class="posttext"> @Floyd: yeah, and this can still happen!<br><br>BTW If anyone here runs into this now and then, use <a href="http://www.midiox.com/desktoprestore.htm" target="_blank">DesktopRestore</a>. Install it, right-click on the desktop and choose Save Desktop.<br><br>After having your resolution screwed up, and after fixing your resolution, right-click on the desktop and choose Restore Desktop to put your icons back in place. It's great! <br><br></td></tr></table><br>
<a name="1102359"></a>

<a name="1102361"></a>

<a name="1102362"></a>

<a name="1102363"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >BlitzSupport</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#11">[#11]</a></td></tr></table></td></tr><tr ><td class="posttext"> @Gfk, it would seem logical for that to be the case, but I now believe it to be otherwise -- I believe any reference Windows makes to the desktop size is retrieved the way we've been doing in this post and my referenced post, on the fly; as far as I can see, the graphics driver stores the actual resolution the monitor is set to (in its own proprietary location) and sets things up on reboot, etc, and Windows adapts to that by querying the driver.<br><br>It seems that apps have to restore the original desktop size, or have it restored for them by the library they're using, eg. DirectX. I would <i>dearly</i> love to be proved otherwise on all this, by <i>anyone at all, anywhere</i>, but I've explored this almost as far as I possibly can anyway.<br><br>Have a look at "Part iii" of <a href="http://www.falloutsoftware.com/tutorials/gl/gl2.htm" target="_blank">this OpenGL tutorial</a>, for example; this is why I'm still looking into ChangeDisplaySettings, as mentioned above, but I'm not holding out much hope.<br><br>In fact, ChangeDisplaySettings is in <i>glgraphics.win32.c</i>, under <i>BlitzMax\mod\brl.mod\glgraphics.mod</i>. (Apparently DirectX stores the information itself and restores on exit, but, again, it can do this at the start.) Blitz uses Null/0 to reset the display size on loss of focus, as, according to the docs: "Passing NULL for the lpDevMode parameter and 0 for the dwFlags parameter is the easiest way to return to the default mode after a dynamic mode change."<br><br>There's quite an in-depth discussion of this stuff on the <a href="http://blogs.msdn.com/b/oldnewthing/archive/2008/01/04/6973747.aspx" target="_blank">OldNewThing</a>, which is a bit of a Windows Obscurity Bible, making reference to the weirdnesses that ChangeDisplaySettings can cause. (And I bet you anything that DirectX calls this.)<br><br>Still gonna fiddle with <i>EnumDisplayDevices</i>, but I'm pretty sure all I'll get is whatever the referenced monitor is *currently* set to and that the above is correct, however unbelievable it appears to me or anyone else!<br><br>EDIT: For what it's worth, and check out the OldNewThing link, I believe this is left to the running app (excepting possibly for DirectX handling it when it's in control), however poor a decision that would appear to be historically:<br><br><div class="quote"> <br>Even if it changes when something goes full screen, [Windows] knows how to change it back<br> <br></div><br><br><font class="tiny">Last edited 2011</font> <br><br></td></tr></table><br>
<a name="bottom"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td align="right"><a href="http://monkeycoder.co.nz" target="_blank"><img src="/img/monkey2.svg" ></a> <a href="https://github.com/blitz-research" target="_blank"><img src="/img/github.svg" ></a> <a href="https://discord.gg/qJccbSp" target="_blank"><img src="/img/discord.svg" ></a></td></tr></table><br></div><br><table width="100%"><tr><td></body></html lang="en">
