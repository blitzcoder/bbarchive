<!DOCTYPE html><html lang="en" ><head ><title >1.36 Memory Leak...</title><meta name='viewport' content='width=device-width, initial-scale=0.66'><meta name='description' content='language:basic, target:desktop, category:game development'><link rel="styleSheet" href="../skins/granite/style.css" type="text/css"><style type="text/css">div.bbcode {padding: 8px;background: #E5E5E5;color: #000000;border: 1px dashed #B4B4BE;}</style></head><body ><table width=100% cellspacing=0 cellpadding=0><tr ><td class="menubarleft"></td><td class="menubar"><table cellspacing="0" cellpadding="0"><tr ><td >&nbsp;</td><td class="menuitemleft"></td><td class="menuitem"><a href="/" class="menuitem">News</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/forums.php" class="menuitem">Forums</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/codearcs.php" class="menuitem">Code</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/logs.php" class="menuitem">Logs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/gallery.php" class="menuitem">Gallery</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/sdkspecs.php" class="menuitem">Specs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/search.php" class="menuitem">Search</a></td><td class="menuitemright"></td></tr></table></td><td class="menubarright"></td></tr></table><div class="main"><h1 >1.36 Memory Leak...</h1><a href="forums.php" >Archives Forums</a>/<a href="topics.php?forum=105" >BlitzMax Bug Reports</a>/<a href="#bottom" >1.36 Memory Leak...</a><br><br>
<a name="1003593"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Dabhand</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#1">[#1]</a></td></tr></table></td></tr><tr ><td class="posttext"> <pre class=code>
Strict

Graphics 800, 600
Local img:TImage
Repeat
	img:TImage = CreateImage(512, 512)
	
	Cls
	DrawImage img, 0, 0
	Flip
	
	img = Null
Until KeyDown(KEY_ESCAPE)
</pre><br><br>When I run this code, nothing is collected, memory usage rises at an astonishing rate, and thus, eventually, 30 or so seconds later, TaskManager is showing the app at 1.5gig memory usage (And is quite happy to keep on going), the memory counter in perfmon goes through the roof and my system eventually runs at a snail pace.<br><br>I'm not 100% sure how the garbage collector works, but, after a test by Gfk, he's found the same problem, though, Cygnus has confirmed memory does <strike>NOT</strike> rise on his machine.<br><br>Currently, Gfk has rolled back to version 1.24 and everything is okay.<br><br>My specs are:-<br><br>Windows XP Pro SP3<br>AMD Athlon(tm) 64 Processor 3500+<br>2.0 GB RAM<br>GeForce 8600 GTS 256mb<br><br>Any idea's?<br><br>Dabz <br><br></td></tr></table><br>
<a name="1003595"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Damien Sturdy</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#2">[#2]</a></td></tr></table></td></tr><tr ><td class="posttext"> It's odd- because I have had this kind of thing happen before. I get different behaviour between 1.28, 1.32 and 1.36, with 1.36 using around 30mb more than 1.32, but for me the memory is eventually freed.<br><br>[edit] I do seem to get a memory leak on my other machine.<br><br>AMD64 X2 5200 (I think) 2gb Ram, Nvidia 8400, Windows 7. <br><br></td></tr></table><br>
<a name="1003596"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Dabhand</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#3">[#3]</a></td></tr></table></td></tr><tr ><td class="posttext"> Update:<br><br>Ran the app above again, after the 1.5gig I mentioned above, around 1.6-1.7gig, the memory usage drops back down to 14 000K in TaskManager, though, the memory counter in perfmon is still sky high, and as such, my system is still crippled.<br><br>Dabz <br><br></td></tr></table><br>
<a name="1003597"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >GfK</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#4">[#4]</a></td></tr></table></td></tr><tr ><td class="posttext"> Granted the above code is pushing it a bit, but it serves to highlight the problem.<br><br>I've been testing all previous versions from 1.18 upwards - wish I'd started at the top and gone back as it'd save some time....<br><br>The first 'broken' version I have, is 1.35rc5.  Everything prior to that works perfectly:<br><br>1.18-1.34: Resource usage fluctuates between 18-60MB.  This is fine.<br>1.35+: Resource usage goes up to over 1.5GB, at which point my system is on its knees begging for mercy.  This is very, very bad.<br><br>I've tested this on two systems with identical results:<br><br>1. Athlon64 X2 5000+, 2GB RAM, Nvidia 512MB 8500GT, Windows 7.<br>2. Intel Dualcore laptop, 2GB RAM, Intel GMA965 graphics, Windows Vista SP2.<br><br>I note that the problem versions are the DX9 ones....<br><br>[edit] Just tested Blitzmax 1.35 with GLMax2dDriver - works fine.<br><br>Looks like a DX9 problem. <br><br></td></tr></table><br>
<a name="1003598"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Dabhand</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#5">[#5]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> <br>[edit] Just tested Blitzmax 1.35 with GLMax2dDriver - works fine.<br><br>Looks like a DX9 problem. <br> <br></div><br><br><pre class=code>
Strict

SetGraphicsDriver GLMax2DDriver()

Graphics 800, 600
Local img:TImage
Repeat
	img:TImage = CreateImage(512, 512)
	
	Cls
	DrawImage img, 0, 0
	Flip
	
	img = Null
Until KeyDown(KEY_ESCAPE)
</pre><br><br>Works a treat now here too!<br><br>Dabz <br><br></td></tr></table><br>
<a name="1003599"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Damien Sturdy</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#6">[#6]</a></td></tr></table></td></tr><tr ><td class="posttext"> Confirmed! DX9 driver causes my laptop to kill itself too! <br><br></td></tr></table><br>
<a name="1003600"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >GfK</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#7">[#7]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> Update:<br><br>Ran the app above again, after the 1.5gig I mentioned above, around 1.6-1.7gig, the memory usage drops back down to 14 000K in TaskManager, though, the memory counter in perfmon is still sky high, and as such, cripples my system. <br></div>Here's what happens on my 8500GT system if I leave it running for a minute or so:<br><br><img src="http://www.desktopgaming.net/junk/bmxleak.jpg"> <br><br></td></tr></table><br>
<a name="1003602"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Dabhand</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#8">[#8]</a></td></tr></table></td></tr><tr ><td class="posttext"> Beta-testing team must of had a cracking game of Jacks and Two's for that to get through! :D &lt;--- That was a joke BTW<br><br>Dabz <br><br></td></tr></table><br>
<a name="1003784"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >GfK</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#9">[#9]</a></td></tr></table></td></tr><tr ><td class="posttext"> Just a quick Q - has anybody tested this that *doesn't* get a huge memory leak? <br><br></td></tr></table><br>
<a name="1003803"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >therevills</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#10">[#10]</a></td></tr></table></td></tr><tr ><td class="posttext"> Ive just tested on my rig (see sig) and with DX9 it goes up to 1.7GB and dies... <br><br></td></tr></table><br>
<a name="1003804"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Dreamora</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#11">[#11]</a></td></tr></table></td></tr><tr ><td class="posttext"> Problem is the local variable in the global scope. Thats a known special case when it comes to garbage collection, which is biting you here, because locals aren't touched by the GC until their scope is left which never can happen with locals on application level.<br><br>use a global there or define the local variable in the loop and it should work fine. <br><br></td></tr></table><br>
<a name="1003808"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >SLotman</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#12">[#12]</a></td></tr></table></td></tr><tr ><td class="posttext"> On BMAX 1.28 and the unofficial DX9 module by DStastny works perfectly - it varies here from 50 to 120mb and keeps fluctuating on that. <br><br></td></tr></table><br>
<a name="1003842"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Damien Sturdy</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#13">[#13]</a></td></tr></table></td></tr><tr ><td class="posttext"> Dreamora- but it works fine in gl or dx7?! only the dx9 driver does this. <br><br></td></tr></table><br>
<a name="1003846"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Brucey</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#14">[#14]</a></td></tr></table></td></tr><tr ><td class="posttext"> Indeed, there's definitely an issue, but I haven't tracked it down yet.<br><br>Feel free to have a look yourselves, of course...  the source is provided :-p <br><br></td></tr></table><br>
<a name="1003849"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >GfK</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#15">[#15]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> Problem is the local variable in the global scope. Thats a known special case when it comes to garbage collection, which is biting you here, because locals aren't touched by the GC until their scope is left which never can happen with locals on application level.<br><br>use a global there or define the local variable in the loop and it should work fine. <br></div>Using a Global doesn't make a jot of difference.  Still a colossal memory leak.<br><br><div class="quote"> Feel free to have a look yourselves, of course... the source is provided :-p <br></div>It is, but not so many of us understand it.  I prefer to keep myself as high-level as possible, and leave the low-level stuff to those who know what they're doing. :) <br><br></td></tr></table><br>
<a name="1003855"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Damien Sturdy</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#16">[#16]</a></td></tr></table></td></tr><tr ><td class="posttext"> I've taken a dig into the source, but then everything turned into<br><br>i dnt no wt yr tkin boot man! source cd s unrdabl.<br><br>I think I tracked it down to pixmaps, but then it all went a bit over my head- I had very limited time to look at it though. <br><br></td></tr></table><br>
<a name="1003866"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >degac</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#17">[#17]</a></td></tr></table></td></tr><tr ><td class="posttext"> Debug Mode ON - Thread ON<br>With OpenGL driver the above example starts from 9/18000 to 250.000 and then restart.<br>In DirectX 7 loops from 18000 to 145-160000 (with CPU 98-99%)<br>In DirectX 9 raises from 14000 to 380-42000 then get down to 14-17 and stay quite stable for minutes with a max of 38-42000. CPU changes from 3 to 96%<br><br>Debug mode ON  - Single Thread<br><br>OpenGL    - it stays in the range 17000-93000<br>DirectX 7 - it stays in the range 17000-86000<br>DirectX 9 - it raises to 230-465 with CPU 4-63%<br><br>It seems that the MS garbage collector works better than the single-thread one...<br><br>In any case the system becomes very slow (with DX9 driver) after closing the application (I think the OS is clearing the caching...)<br><br>Tested with Bmax 1.36 on Athlon64 3500+ 1GB ram WindowsXP pro sp2<br><br>edited: the problem is not in the CreateImage commands, but in DrawImage (from my silly tests) <br><br></td></tr></table><br>
<a name="1003869"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >degac</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#18">[#18]</a></td></tr></table></td></tr><tr ><td class="posttext"> Probably not related with the bug, but there is a reason why Image/Pixmap cant' be forced to be in the 'right pixel format' as default FLAG without forcing a conversion?<br>I mean I've tested DX9 driver and every image created MUST be converted in the 'right DX format' PF_BGRA8888 (while under OpenGL seems to be PF_RGBA8888).<br>I think a better solutions should be: DX9 driver? CreateImage invoked? Default flags IS PF_BGRA8888, so we don't need conversion and we have a little time gain.<br>Same for OpenGL.<br><br>Just an idea... <br><br></td></tr></table><br>
<a name="1003877"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >skidracer</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#19">[#19]</a></td></tr></table></td></tr><tr ><td class="posttext"> this seems to fix it?<br><br>d3d9max2d.bmx[60]:<br><pre class=code>
Type TD3D9ImageFrame Extends TImageFrame
	
	Method Delete()
		If Not _texture Return
		_texture.Release_
	End Method
</pre> <br><br></td></tr></table><br>
<a name="1003880"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >degac</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#20">[#20]</a></td></tr></table></td></tr><tr ><td class="posttext"> Yes, it seems to work better.<br>I have no increments in the mem alloced (in TaskManager) (a part a 'peak' at the start to &gt;300K then it is stable 60-173K) <br><br></td></tr></table><br>
<a name="1003887"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Dabhand</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#21">[#21]</a></td></tr></table></td></tr><tr ><td class="posttext"> Yep, seems to do the job here too... Cheers skid!<br><br>Dabz <br><br></td></tr></table><br>
<a name="1004010"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >GfK</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#22">[#22]</a></td></tr></table></td></tr><tr ><td class="posttext"> Thanks - that's it sorted for me, too. <br><br></td></tr></table><br>
<a name="1004192"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Grey Alien</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#23">[#23]</a></td></tr></table></td></tr><tr ><td class="posttext"> Nice work all.  Will this be in 1.37 or a fixed 1.36? <br><br></td></tr></table><br>
<a name="1004345"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >GfK</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#24">[#24]</a></td></tr></table></td></tr><tr ><td class="posttext"> Just found out that this bug fix has introduced another major problem:<br><br><a href="http://www.blitzbasic.com/Community/posts.php?topic=88438" target="_blank">http://www.blitzbasic.com/Community/posts.php?topic=88438</a> <br><br></td></tr></table><br>
<a name="1004809"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >marksibly</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#25">[#25]</a></td></tr></table></td></tr><tr ><td class="posttext"> Hi,<br><br>Fix coming! <br><br></td></tr></table><br>
<a name="1004866"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Dabhand</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#26">[#26]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> <br>Hi,<br><br>Fix coming! <br> <br></div><br><br>Marvellous! :D<br><br>Dabz <br><br></td></tr></table><br>
<a name="1004919"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Arowx</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#27">[#27]</a></td></tr></table></td></tr><tr ><td class="posttext"> Is this the same memory leak that affects code with GrabImage() <br><a href="http://www.blitzbasic.com/Community/posts.php?topic=88461#1004788" target="_blank">http://www.blitzbasic.com/Community/posts.php?topic=88461#1004788</a><br>as the issue looks the same...<br> <br> DX9 gobbles up massive amounts of memory until it runs out<br> DX7 memory usage shoots up to hundreds of Mb then drops and yoyo's between.<br> OpenGL almost rock stead in comparison!<br><br>And will the fix sort out both? <br><br></td></tr></table><br>
<a name="1006454"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >therevills</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#28">[#28]</a></td></tr></table></td></tr><tr ><td class="posttext"> Just tested on BMax v1.37, looks good - using Dabz's code it goes up to 170MB then drops again.<br><br>And using Arowx code it goes up to around 280MB then drops :) <br><br></td></tr></table><br>
<a name="1006483"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >GfK</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#29">[#29]</a></td></tr></table></td></tr><tr ><td class="posttext"> Works fine here too :) <br><br></td></tr></table><br>
<a name="bottom"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td align="right"><a href="http://monkeycoder.co.nz" target="_blank"><img src="/img/monkey2.svg" ></a> <a href="https://github.com/blitz-research" target="_blank"><img src="/img/github.svg" ></a> <a href="https://discord.gg/qJccbSp" target="_blank"><img src="/img/discord.svg" ></a></td></tr></table><br></div><br><table width="100%"><tr><td></body></html lang="en">
