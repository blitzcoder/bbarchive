<!DOCTYPE html><html lang="en" ><head ><title >WriteStdout improper UTF8 output</title><meta name='viewport' content='width=device-width, initial-scale=0.66'><meta name='description' content='language:basic, target:desktop, category:game development'><link rel="styleSheet" href="../skins/granite/style.css" type="text/css"><style type="text/css">div.bbcode {padding: 8px;background: #E5E5E5;color: #000000;border: 1px dashed #B4B4BE;}</style></head><body ><table width=100% cellspacing=0 cellpadding=0><tr ><td class="menubarleft"></td><td class="menubar"><table cellspacing="0" cellpadding="0"><tr ><td >&nbsp;</td><td class="menuitemleft"></td><td class="menuitem"><a href="/" class="menuitem">News</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/forums.php" class="menuitem">Forums</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/codearcs.php" class="menuitem">Code</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/logs.php" class="menuitem">Logs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/gallery.php" class="menuitem">Gallery</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/sdkspecs.php" class="menuitem">Specs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/search.php" class="menuitem">Search</a></td><td class="menuitemright"></td></tr></table></td><td class="menubarright"></td></tr></table><div class="main"><h1 >WriteStdout improper UTF8 output</h1><a href="forums.php" >Archives Forums</a>/<a href="topics.php?forum=105" >BlitzMax Bug Reports</a>/<a href="#bottom" >WriteStdout improper UTF8 output</a><br><br>
<a name="1029721"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >plash</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#1">[#1]</a></td></tr></table></td></tr><tr ><td class="posttext"> <pre class=code>SuperStrict

Framework brl.blitz
Import brl.standardio

' The Japanese kana for 'a' (arrayified to avoid forum encoding issues)
Local ja_a:Short[] = [Short(12354)]
Local sja_a:String = String.FromShorts(ja_a, ja_a.Length)
Print(sja_a) ' This should look fine
WriteStdout(sja_a + "~n") ' This should not output "B", instead it should be this: http://en.wiktionary.org/wiki/Index:Japanese/%E3%81%82

' Now, simulate the WriteLine call
' WriteLine calls _FlushWrite once and WriteString twice (which also calls _FlushWrite)
Local ts:TTextStream = TTextStream(StandardIOStream)
ts.WriteString(sja_a + "~n")
' Here WriteLine would call WriteString again, with "~r~n" (another _FlushWrite)
' Instead of doing that, we'll just flush the stream
ts._FlushWrite()
TCStandardIO(ts._stream).Flush() ' Flush to stdio</pre><br><br>The problem is in the use of _FlushWrite in TTextStream. It should really be called <i>after</i> the WriteString call (though I don't know if this would mess with anything).<br>I'm using Ubuntu 10.04 with Max 1.39.<br><br>EDIT: You'll probably have to run this in a terminal to see the Japanese character. I don't know how it will appear on Windows. <br><br></td></tr></table><br>
<a name="1030744"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >marksibly</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#2">[#2]</a></td></tr></table></td></tr><tr ><td class="posttext"> Hi,<br><br>What problem?<br><br>The output is indeed messed up in the IDE (or is it? Not sure what I'm supposed to be seeing...), but that may be related to the richedit control used by stdout not being unicode friendly - something bmx can't and wont guarantee.<br><br>The important thing is whether it's getting sent the right data, and I find your example a little confusing in this respect - what's it supposed to do? Why all the downcasting? <br><br></td></tr></table><br>
<a name="1030760"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >plash</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#3">[#3]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> The output is indeed messed up in the IDE <br></div>That's not what I'm referring to, but yes it does not look correct in the IDE. I'm referring to places where it <i>should</i> look correct (a Linux terminal, for example).<br><br><div class="quote"> what's it supposed to do? Why all the downcasting? <br></div>The downcasting (I assume you're talking about the array thing) was done to preserve the character when posting here, because the forums do <i>not</i> like most non-english characters. The target of this thread is only the output of WriteStdout.<br><br>I don't know what more can be explained other than what is in the comments - simply that the TextStream needs to be flushed <b>after</b> calling WriteString.<br><br>Here is what the code outputs in gnome-terminal:<br><img src="http://img32.imageshack.us/img32/3990/bmaxwritestdout.png"><br><br>The first character is outputted using Print (sequence of calls is Print -&gt; WriteLine -&gt; {_FlushWrite, WriteString(str) -&gt; {_FlushWrite, WriteChar}, WriteString("~r~n") -&gt; {<b>_FlushWrite</b>, ..}}).<br>The second is WriteStdout (sequence is WriteStdout -&gt; WriteString -&gt; {<b>_FlushWrite</b>, WriteChar}; notice that there is only one _FlushWrite here, and it is <u>before</u> writing characters).<br>The third character is outputted simulating the sequence of calls from Print (that is, a _FlushWrite <u>after</u> WriteString). <br><br></td></tr></table><br>
<a name="1030913"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >marksibly</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#4">[#4]</a></td></tr></table></td></tr><tr ><td class="posttext"> Hi,<br><br>_FlushWrite is internal. It is used to align certain write ops to a new 'start of line', which is why it appears *before* those ops. From memory, it is purely a formatting feature, designed to make textstream output more readable.<br><br>It may indeed by doing something wrong, but you still haven't told me what the 'bug' is with your program, apart from it not calling _FlushWrite when you think it should be (and I think it shouldn't). <br><br></td></tr></table><br>
<a name="1030919"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >plash</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#5">[#5]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> It may indeed by doing something wrong, but you still haven't told me what the 'bug' is with your program, apart from it not calling _FlushWrite when you think it should be (and I think it shouldn't). <br></div>The bug is that WriteStdout doesn't output correctly (as noted in the thread title) - and calling _FlushWrite after writing the string is the only solution I see.<br>Clearly we do not agree.<br><br>EDIT: I've changed the comment at the WriteStdout call, it was unclear. What I mean is that it's outputting "B" where it should be this: http://en.wiktionary.org/wiki/Index:Japanese/%E3%81%82 (as all the others are). <br><br></td></tr></table><br>
<a name="1030925"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >marksibly</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#6">[#6]</a></td></tr></table></td></tr><tr ><td class="posttext"> Hi,<br><br>&gt; The bug is that WriteStdout doesn't output correctly (as noted in the thread title)<br><br>WriteStdout is not designed to handle unicode or UTF8 - it's just a very thin layer on top of 'printf' and only uses simple c style strings.<br><br>This could probably be amended to use UTF8 instead, but it's really just meant for debugging anyway, when Print isn't appropriate because you're debugging a module or something.<br><br>It has nothing to do with textstreams - although both WriteStdout AND Print go through stdout so operations like flush on one will affect the other.<br><br>Apologies for the confusion though. <br><br></td></tr></table><br>
<a name="1030942"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >plash</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#7">[#7]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> WriteStdout is not designed to handle unicode or UTF8 - it's just a very thin layer on top of 'printf' and only uses simple c style strings. <br></div>I did not realize this.<br><br>I don't know when I came to the conclusion that WriteStdout was even defined in brl.standardio (or that it even used the StandardIOStream). I seem to have lost my mind somewhere along the way when posting in this thread.<br>I do feel that there should be a UTF8 compliant non-newline-writing Print function though, as I've found WriteStdout very useful (specifically, checking the output of a parser/generator - which was actually the cause for this entire thing).<br><br><div class="quote"> Apologies for the confusion though. <br></div>Likewise. <br><br></td></tr></table><br>
<a name="bottom"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td align="right"><a href="http://monkeycoder.co.nz" target="_blank"><img src="/img/monkey2.svg" ></a> <a href="https://github.com/blitz-research" target="_blank"><img src="/img/github.svg" ></a> <a href="https://discord.gg/qJccbSp" target="_blank"><img src="/img/discord.svg" ></a></td></tr></table><br></div><br><table width="100%"><tr><td></body></html lang="en">
