<!DOCTYPE html><html lang="en" ><head ><title >Android input delay and crash</title><meta name='viewport' content='width=device-width, initial-scale=0.66'><meta name='description' content='language:basic, target:desktop, category:game development'><link rel="styleSheet" href="../skins/granite/style.css" type="text/css"><style type="text/css">div.bbcode {padding: 8px;background: #E5E5E5;color: #000000;border: 1px dashed #B4B4BE;}</style></head><body ><table width=100% cellspacing=0 cellpadding=0><tr ><td class="menubarleft"></td><td class="menubar"><table cellspacing="0" cellpadding="0"><tr ><td >&nbsp;</td><td class="menuitemleft"></td><td class="menuitem"><a href="/" class="menuitem">News</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/forums.php" class="menuitem">Forums</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/codearcs.php" class="menuitem">Code</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/logs.php" class="menuitem">Logs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/gallery.php" class="menuitem">Gallery</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/sdkspecs.php" class="menuitem">Specs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/search.php" class="menuitem">Search</a></td><td class="menuitemright"></td></tr></table></td><td class="menubarright"></td></tr></table><div class="main"><h1 >Android input delay and crash</h1><a href="forums.php" >Monkey Targets Forums</a>/<a href="topics.php?forum=502" >Android</a>/<a href="#bottom" >Android input delay and crash</a><br><br>
<a name="2124963"></a>

<a name="2124964"></a>

<a name="2124965"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >nullterm</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#1">[#1]</a></td></tr></table></td></tr><tr ><td class="posttext"> So I've been dealing with an issue with slower devices. When render/update is intense and taking longer than the device can keep up with, the GLThread has been causing the main thread to stall, so input gets delayed several seconds, and eventually the Android OS gets impatient and just kills my monkey app.<br><br>After some digging and monkeying around with the target .java code, I came to a solution which addresses most of the issue.  Needs some cleanup though and better handling of app switching from foreground-background-foreground, but thought I'd post this first step if it helps others.  Still working on a more robust solution.<br><br>Basically...<br>1. set the GLSurfaceView render mode to "when dirty" instead of continuous<br>2. post a runnable on the main thread that will request the view to be dirty and render<br><br>So the main and GLThread aren't fighting over the CPU and stalling the main.<br><br><pre class=code>
	//***** GLSurfaceView.Renderer *****

	Runnable dirtyHandler = new Runnable() {
		@Override
		public void run() {
			if( !_canRender ) return;
			//System.out.println( "dirtyHandler requestRender on " + Thread.currentThread() );
	       		_view.requestRender();
		}
	};

	public void onDrawFrame( GL10 gl ){
		if( !_canRender ) return;
		
		StartGame();
	
		if( _updateRate==0 ){
			UpdateGame();
			RenderGame();

		// BMH HACK STARTS HERE
		if ( true ) {
			//System.out.println( "RENDERMODE_WHEN_DIRTY" );
			_view.setRenderMode( GLSurfaceView.RENDERMODE_WHEN_DIRTY );
			_activity.runOnUiThread(dirtyHandler);
		}
		// BMH HACK ENDS HERE

			return;
		}
			
...
</pre> <br><br></td></tr></table><br>
<a name="2124962"></a>

<a name="2124968"></a>

<a name="2124969"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >nullterm</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#2">[#2]</a></td></tr></table></td></tr><tr ><td class="posttext"> Based on further testing, the foreground-background-foreground crash isn't related to my "dirty" change. It's based on some Monkey side OpenGL I wrote for rendering, guessing Android is flushing everything and I need to restore all the vertex buffer and texture data back to the GPU.<br><br>Edit - solved my GLES2 resource issue by reloading vertex buffer, shader, texture data and everything works great. Now my Samsung Tab3 doesn't crash and responds correctly to touch events. <br><br></td></tr></table><br>
<a name="2124973"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Leginus</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#3">[#3]</a></td></tr></table></td></tr><tr ><td class="posttext"> Thanks for posting a followup <br><br></td></tr></table><br>
<a name="2124991"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Simonsuuri</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#4">[#4]</a></td></tr></table></td></tr><tr ><td class="posttext"> i have problem with my android game that when it loads and draw images at first time (I suppose) it does freeze for a second here and there, <br>and i splitted my loading with menu stuff and game stuff just to make loading times shorter... <br><br>i wonder if this could be some sort of solution for freeze moments...?<br><br>also actually i wonder if images Pixels per Inch value or someting similiar, does make a difference? since basicly i think that freeze is not same length on some images as other (even if they are same size)?<br><br>and third what i have been thinking is that should i use GrabImage in loading, to make images of game objects smaller? <br><br></td></tr></table><br>
<a name="2124992"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Phil7</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#5">[#5]</a></td></tr></table></td></tr><tr ><td class="posttext"> @Simonsuuri<br>I had the same problem, but it had nothing to do with this post as far as I know. Android seems to copy the images in the gfx memory the first time it is rendered not when it is loaded. My solution was to render all the images once after loading. You can avoid showing it to the user by drawing it offscreen or with setalpha(0.0)(but you have to test it yourself ;-) ). <br>The freeze/copy time depends on the size of memory it needs, so an image with higher resolution takes longer to load. <br>As far as I know it doesn't make a difference if you use grabimage with a spritesheets. Here the copy freeze happened the first time I rendered a peace of your sheet. <br><br></td></tr></table><br>
<a name="2124993"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Simonsuuri</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#6">[#6]</a></td></tr></table></td></tr><tr ><td class="posttext"> hmm... ok.. is there any way to push prosessing of the image handling (when data is being sent to GPU) to background thread so that it would at least keep mobile to be responsive..?<br><br>and um.. i wonder... My main Image files are Global atm. would that help if i set them to be fields/local to Game Class? <br><br></td></tr></table><br>
<a name="2124994"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Phil7</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#7">[#7]</a></td></tr></table></td></tr><tr ><td class="posttext"> I don't think it makes a difference where you have the image variables. <br>Do you have a loading scene when starting your app? I would keep the images global and load them at this time and then display them just after that. <br>Can you explain why you don't want to do it like that? <br>Btw. I don't know if a thread would solve that problem, sorry. <br><br></td></tr></table><br>
<a name="2124997"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Simonsuuri</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#8">[#8]</a></td></tr></table></td></tr><tr ><td class="posttext"> thanks, well im trying to avoid a situation that i would need to split my game images physically smaller, since it would take so much work and code. :)<br><br>l Actually have a loading system that load images and then draw to gpu, it takes a laggy moments out from game itself but sometimes some images are deleted from memory so if game creates enemy that has that image game freezes for 1/2 -1 second. <br>And im trying to understand the reason why mobiles do that / how to handle it etc. <br>and today i realized that threading is indeed not a reason nor answer because freeze comes with writing stuff to gpu.<br><br>I think my plan for my game at next week is<br><br>1. To try if image variables in game/app class are handled differently, (easy to try)<br>2. To try if drawing image in rects to gpu is making differece / possible (propably not)<br>3. To try if using grabimage to make smaller images for assets helps with freezes (propably not in loading tho, but InGame freezes should ease)<br>4. cry, and split all images smaller and load them to earlier made grabimage variables. <br><br></td></tr></table><br>
<a name="2124999"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Phil7</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#9">[#9]</a></td></tr></table></td></tr><tr ><td class="posttext"> So you have the problem, that you have to many different enemies with to much memory usage, therefore you cannot load them all before the game starts and you want to keep on loading them during the game.action. In this case I don't have a clue, but would also be very interested, if you come up with a solution. :-)<br><br>Another solution might be to use larger (but within 1024x1024 for android) spitesheets. (just guessing you don't, because you wrote about loading each enemy separately.) This could save some memory and make the loading and first drawing easier to handle.<br><br>Please keep up your investigation! ;-) <br><br></td></tr></table><br>
<a name="2125028"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Simonsuuri</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#10">[#10]</a></td></tr></table></td></tr><tr ><td class="posttext"> Allright, I studied more about android limitation stuff during a weekend.. And desided to go bigger than smaller, and it seems to work..<br>My phone is Samsung Trend Plus so it's quite good for testing since it's not too fast, and it took 32 seconds to load my game with long freeze times...<br>Anyways I joined my game images and sized them to use more or less "power of two" resolutions..<br> <br>With menu images I joined 3 backgroundimages 640*1136 to 2 1024*1024 sized images and 2 loadingscreens I made 640*1136 to 512*1024, <br>I also joined some minor images with my buttonimages.. <br>And InGame images I chanced 6 background images from 1136*1136 to 1024*1024 and joined 4 Enemy images to 2 Enemy images.. Frame sizes was about 192*192 and 288*192<br>and so... Also I tried to save those files a bit smaller, with less colors.. <br><br>And after that the loading time in "stress test" load(loaded all images at game start) time redused from 32sec to 22sec <br><br>After that I optimized loading system by splitting stuff for menuLoad and gameLoad and made each 10th-tick to draw 1 image to GPU,<br>And now the loading time with my phone is around 10 seconds to menu and another 10 seconds to play (at first time).. So I am quite happy for now... <br><br>Also I found out the reason why android forgot some images, and that was because I was trying to draw images to GPU too rapidly so it skipped some images..  <br><br>There is still a bit long freeze(3-5seconds), when Sounds are loaded but I'll handlle that tomorrow.<br>  <br>Now after sound loading is done at early load my phone responds quite good for like chancing phone volume or close app commads.. :)<br>And I assume that since there is not that much different images in memory, the game takes less ram.<br><br>I will do more optimizing for loading/Image system, when my game is (soon) in "beta" testing. And I propably make SD/HD data system<br><br>Thanks for helping Phil07! <br><br></td></tr></table><br>
<a name="bottom"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td align="right"><a href="http://monkeycoder.co.nz" target="_blank"><img src="/img/monkey2.svg" ></a> <a href="https://github.com/blitz-research" target="_blank"><img src="/img/github.svg" ></a> <a href="https://discord.gg/qJccbSp" target="_blank"><img src="/img/discord.svg" ></a></td></tr></table><br></div><br><table width="100%"><tr><td></body></html lang="en">
