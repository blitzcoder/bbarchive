<!DOCTYPE html><html lang="en" ><head ><title >The dreaded Garbage Collector</title><meta name='viewport' content='width=device-width, initial-scale=0.66'><meta name='description' content='language:basic, target:desktop, category:game development'><link rel="styleSheet" href="../skins/granite/style.css" type="text/css"><style type="text/css">div.bbcode {padding: 8px;background: #E5E5E5;color: #000000;border: 1px dashed #B4B4BE;}</style></head><body ><table width=100% cellspacing=0 cellpadding=0><tr ><td class="menubarleft"></td><td class="menubar"><table cellspacing="0" cellpadding="0"><tr ><td >&nbsp;</td><td class="menuitemleft"></td><td class="menuitem"><a href="/" class="menuitem">News</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/forums.php" class="menuitem">Forums</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/codearcs.php" class="menuitem">Code</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/logs.php" class="menuitem">Logs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/gallery.php" class="menuitem">Gallery</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/sdkspecs.php" class="menuitem">Specs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/search.php" class="menuitem">Search</a></td><td class="menuitemright"></td></tr></table></td><td class="menubarright"></td></tr></table><div class="main"><h1 >The dreaded Garbage Collector</h1><a href="forums.php" >Monkey Targets Forums</a>/<a href="topics.php?forum=502" >Android</a>/<a href="#bottom" >The dreaded Garbage Collector</a><br><br>
<a name="2033481"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Nobuyuki</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#1">[#1]</a></td></tr></table></td></tr><tr ><td class="posttext"> oh my gooooooood.  My project's finally starting to reach the point where the GC is getting extremely aggressive towards it.  Does this happen to everyone at some point?  I'm looking for some tool that can maybe help me profile where the bottleneck is in my code, or some advice on how to use ddms to properly profile my app:<br><br><img src="http://i.imgur.com/CKhtl.png"><br><br>What tools and techniques do you guys have to reduce the number of times the GC sweeps your app?  I wish I could tell it to hold off on a sweep until a specific time.   My game does a lot of vector calculations with objects, so I'm wondering if having the GC go crazy like this is unavoidable..... <br><br></td></tr></table><br>
<a name="2033475"></a>

<a name="2033478"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >slenkar</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#2">[#2]</a></td></tr></table></td></tr><tr ><td class="posttext"> Recycle vector Objects <br><br></td></tr></table><br>
<a name="2033672"></a>

<a name="2033673"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Nobuyuki</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#3">[#3]</a></td></tr></table></td></tr><tr ><td class="posttext"> allllllllllocations everywhere, everywhere.<br><br>I've done some profiling and some other things recently, and it does seem like caching the vector objects improves the situation somewhat.  Here are some resources to help people struggling with this crap:<br><br><a href="http://developer.android.com/guide/practices/performance.html" target="_blank">http://developer.android.com/guide/practices/performance.html</a><br><a href="http://www.youtube.com/watch?v=U4Bk5rmIpic&amp;feature=player_embedded" target="_blank">http://www.youtube.com/watch?v=U4Bk5rmIpic&amp;feature=player_embedded</a><br><br>Some of it is java-specific, but the big things to note here are that short-lived object allocations will cause the GC to act up quite a bit.  Reducing the number of allocations made on the short term in your game loop will reduce the number of hiccups.  The only way to prevent any hiccups, though, would be to have no allocations being made while the game is "in play".  <br><br>This kinda requires one to change their coding style a bit such that pretty much everything relies on cached objects on a "screen" level.  Such management can become a bit of a pain, and I think it shouldn't be necessary if you're just starting out, but it is something to be aware of.  Once your game reaches any level of complexity, you -will- start having these issues on android, and the way to tackle them will probably involve caching some of your objects and re-using them.<br><br>Designing a good object-oriented game might sometimes clash with this notion unless you can supply references to your cache arrays, so that instances of your objects have something to work with when doing certain calculations.  Something to consider when creating game objects that have instance-level mutator methods, as my Vec2 class has.<br><br>For those of you who use my Vec2 class (in the code snippets forum), be aware that Reflect as a mutator method calls a number of short-lived vec2 objects, due to the OO way it was designed.  Here is an android-specific version of Reflect which takes a pre-initialized array of vec2s (basically, a vector cache) as an argument:<br><br>[monkeycode]<br>' ANDROID-SPECIFIC MODIFICATION:  This version of Reflect takes a reference to a vector cache, to reduce<br>' strain on the Android Garbage Collector.  This may also be useful for xna target.	<br>	Method Reflect:Void(v:Vec2, vectorCache:Vec2[], calcNormal:Bool = False) 'Reflects Self against normal vector v.		<br>		vectorCache[0].Set(Self)<br><br>		If calcNormal = True Then 'calculate the normal from surface v instead.<br>			vectorCache[1].Set(-v.y, v.x) 'Right-handed normal of v<br>			'Project self to n<br>			Local n:Vec2 = vectorCache[1] <br>			n.Scale( Dot(Self,n) / Dot(n,n) )<br>			Set (n)<br>		Else<br>			'Project self to n<br>			vectorCache[1].Set(v.x, v.y)<br>			Local n:Vec2 = vectorCache[1] <br>			n.Scale( Dot(Self,n) / Dot(n,n) )<br>			Set (n)<br>		End If<br><br>		Scale(2); Minus(vectorCache[0])<br>	End Method<br>[/monkeycode]<br><br>You can add this modification safely to vec2.monkey without any other changes;  the method signature is different, so it acts as an overload to the existing Reflect method.  In your code, simply change/add to the 2nd argument the location of your Vec2 cache. <br><br></td></tr></table><br>
<a name="2033671"></a>

<a name="2033729"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Sledge</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#4">[#4]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> The only way to prevent any hiccups, though, would be to have no allocations being made while the game is "in play". <br><br>This kinda requires one to change their coding style a bit such that pretty much everything relies on cached objects on a "screen" level. Such management can become a bit of a pain, and I think it shouldn't be necessary if you're just starting out, but it is something to be aware of. <br></div><br>I think it's a common mistake amongst game developers starting out with a managed language, that there's this assumption that OOP should mean that you can create and free objects in the game-loop willy nilly and the garbage collector should magically cope. Even with very capable hardware it's a poor paradigm (<a href="http://blogs.msdn.com/b/shawnhar/archive/2007/07/02/twin-paths-to-garbage-collector-nirvana.aspx" target="_blank">you're quite correct about XNA</a>) and on mobile... eugh *crunch!* I sympathise, though, because it's horrible, after discovering OOP and thinking that everything is going to be so easy now, to suddenly realise that you're still going to have to cache and pool everything for performant games -- we all go through it :D <br><br></td></tr></table><br>
<a name="bottom"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td align="right"><a href="http://monkeycoder.co.nz" target="_blank"><img src="/img/monkey2.svg" ></a> <a href="https://github.com/blitz-research" target="_blank"><img src="/img/github.svg" ></a> <a href="https://discord.gg/qJccbSp" target="_blank"><img src="/img/discord.svg" ></a></td></tr></table><br></div><br><table width="100%"><tr><td></body></html lang="en">
