<!DOCTYPE html><html lang="en" ><head ><title >[Win32] Bring Trayicon tooltip to front?</title><meta name='viewport' content='width=device-width, initial-scale=0.66'><meta name='description' content='language:basic, target:desktop, category:game development'><link rel="styleSheet" href="../skins/granite/style.css" type="text/css"><style type="text/css">div.bbcode {padding: 8px;background: #E5E5E5;color: #000000;border: 1px dashed #B4B4BE;}</style></head><body ><table width=100% cellspacing=0 cellpadding=0><tr ><td class="menubarleft"></td><td class="menubar"><table cellspacing="0" cellpadding="0"><tr ><td >&nbsp;</td><td class="menuitemleft"></td><td class="menuitem"><a href="/" class="menuitem">News</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/forums.php" class="menuitem">Forums</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/codearcs.php" class="menuitem">Code</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/logs.php" class="menuitem">Logs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/gallery.php" class="menuitem">Gallery</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/sdkspecs.php" class="menuitem">Specs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/search.php" class="menuitem">Search</a></td><td class="menuitemright"></td></tr></table></td><td class="menubarright"></td></tr></table><div class="main"><h1 >[Win32] Bring Trayicon tooltip to front?</h1><a href="forums.php" >BlitzMax Forums</a>/<a href="topics.php?forum=117" >MaxGUI Module</a>/<a href="#bottom" >[Win32] Bring Trayicon tooltip to front?</a><br><br>
<a name="1257835"></a>

<a name="1257836"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Grisu</td><td align="right"><font class=tiny>(Posted 2015)</font>&nbsp;<a href="#1">[#1]</a></td></tr></table></td></tr><tr ><td class="posttext"> Hello all,<br><br>the code below is a simple example how to set up a trayicon.<br><br><pre class=code>
' TrayIcon 

Framework Maxgui.Drivers
Import BRL.EventQueue
Import "object.o"         ' &lt;- YOU NEED TO CHANGE THAT TO ANOTHER ICON OBJ FILE OR COMMENT IT OUT (= NO ICON)

SuperStrict 
AppTitle = "TrayIcon Example"

?Win32
' Tray icon related stuff
Const NIM_ADD:Int		= 0
Const NIM_MODIFY:Int	= 1
Const NIM_DELETE:Int	= 2
Const NIM_SETFOCUS:Int	= 3
Const NIM_SETVERSION:Int= 4

Const NIF_MESSAGE:Int	= $1
Const NIF_ICON:Int		= $2
Const NIF_TIP:Int		= $4
Const NIF_STATE:Int		= $8
Const NIF_INFO:Int		= $10
Const NIF_GUID:Int		= $20

Global nid:TNotifyIconData

Type TNotifyIconData 
	Field Size:Int
	Field HWND:Int
	Field id:Int
	Field Flags:Int
	Field CallbackMessage:Int
	Field Icon:Int 				' HICON	
	Field Tip:Long				' array [0..63] of AnsiChar;
	Field Tip2:Long
	Field Tip3:Long
	Field Tip4:Long
	Field Tip5:Long
	Field Tip6:Long
	Field Tip7:Long
	Field Tip8:Long
EndType

Extern "win32"
	Function Shell_NotifyIcon:Int(message:Int, notifyicondata:Byte Ptr) = "Shell_NotifyIconA@8"
End Extern
?

Local FLAGS:Int
FLAGS:| WINDOW_TITLEBAR
FLAGS:| WINDOW_RESIZABLE
FLAGS:| WINDOW_MENU
FLAGS:| WINDOW_CLIENTCOORDS
'FLAGS:| WINDOW_HIDDEN
FLAGS:| WINDOW_ACCEPTFILES

Global MainWindow:TGadget = CreateWindow( AppTitle, 100, 100, 320, 240, Null, FLAGS )
Global TrayIconPanel:TGadget = CreatePanel(0, 0, 0, 0, MainWindow, 0 )

Global win_trayed:Int=0

Repeat
	WaitEvent()
	Print CurrentEvent.ToString()
	Select EventID()
		Case EVENT_AppSuspend
        '   DebugLog "App now suspended!"

		If WindowMinimized(Mainwindow) Then 
?win32
			HideGadget(MainWindow)

			RegisterTrayIcon(TrayIconPanel, "This is premade Tooltip!") 'show station currently on AIR!
?
       EndIf 

	Case EVENT_MOUSEDOWN
		Select EventSource()
		Case TrayIconPanel
			If EventData()=1 Then
				RemoveTrayIcon()
				RedrawGadget(Mainwindow) 
				ShowGadget(MainWindow)
				RedrawGadget (MainWindow)
				RestoreWindow(Mainwindow)
			EndIf 

			If EventData()=2 Then
			    ' Set a new Tooltip when you hit the right mouse button over the trayicon
		   		SetNotifyIconDataTip( nid, "I'm a reborn Tooltip! :)" )
				Shell_NotifyIcon( NIM_MODIFY, nid)
	 		EndIf

		End Select
   
		Case EVENT_APPTERMINATE, EVENT_WINDOWCLOSE
			End
	End Select
Forever

' Tray Icon Functions, Win 32 only! ----------------------------------------------------------
Function RegisterTrayIcon( window:TGadget, toolTip:String )
' Register tray icon

	?Win32
	nid = New TNotifyIconData
	nid.Size = SizeOf(TNotifyIconData)
	nid.hwnd = QueryGadget(window, QUERY_HWND)
	SetWindowLongW(nid.hwnd,GWL_WNDPROC,Int Byte Ptr SysTrayWndProc)
	nid.id = 0
	nid.CallbackMessage = WM_APP
	nid.Icon = LoadIconW(GetModuleHandleW(Null),Short Ptr(101))
	nid.Flags = NIF_MESSAGE | NIF_TIP | NIF_ICON  
	SetNotifyIconDataTip( nid, toolTip )

	Shell_NotifyIcon( NIM_ADD, nid)
	?
	
	Win_trayed:Int=1
End Function

Function SysTrayWndProc%(hwnd%,msg%,wp%,lp%) "win32"
'WndProc NotifyIcon -&gt; Blitz Event
	?Win32
	Select msg 
		Case WM_APP
                 Local owner:TGadget = TWindowsGUIDriver.GadgetFromHwnd(hwnd)
			If owner Then
				Select lp
				     Case WM_MOUSELEAVE
						PostGuiEvent( EVENT_MOUSELEAVE, owner )
 				     Case WM_MOUSEMOVE
						PostGuiEvent( EVENT_MOUSEMOVE, owner )
					Case WM_RBUTTONDOWN
						PostGuiEvent( EVENT_MOUSEDOWN, owner, MOUSE_RIGHT )
					Case WM_LBUTTONDOWN
						PostGuiEvent( EVENT_MOUSEDOWN, owner, MOUSE_LEFT )
					Case WM_RBUTTONDOWN	
						PostGuiEvent( EVENT_MOUSEDOWN, owner, MOUSE_RIGHT )
				EndSelect
			EndIf
	EndSelect
	Return TWindowsGUIDriver.ClassWndProc(hwnd,msg,wp,lp)
	?
EndFunction

Function RemoveTrayIcon()    
' Remove tray icon from taskbar
	?Win32
	Shell_NotifyIcon(NIM_DELETE, nid)
    win_trayed=0
	?
End Function

?Win32     
Function SetNotifyIconDataTip( nid:TNotifyIconData, s:String)
	MemClear( Varptr nid.Tip, 64)
	If s.length &gt; 0 Then
		Local p:Byte Ptr = s.ToCString()
		If s.length &lt; 64 Then
			MemCopy( Varptr nid.Tip, p, s.length)
		Else			
			MemCopy( Varptr nid.Tip, p, 63)			
		EndIf
		MemFree(p)
	EndIf
EndFunction
?	
</pre><br><br>I'm trying to figure out how I can change the tooltip of a trayicon so that it shows up in front. This way the user doesn't need to move the mouse over it in order to make it visible. <br><br>Is that possible?<br><br>Some research I did:<br><a href="https://msdn.microsoft.com/en-us/library/windows/desktop/bb773352%28v=vs.85%29.aspx" target="_blank">https://msdn.microsoft.com/en-us/library/windows/desktop/bb773352%28v=vs.85%29.aspx</a><br><a href="https://msdn.microsoft.com/de-de/library/windows/desktop/hh298401%28v=vs.85%29.aspx" target="_blank">https://msdn.microsoft.com/de-de/library/windows/desktop/hh298401%28v=vs.85%29.aspx</a><br><br>But I couldn't find a clue how to do that. :/ <br><br></td></tr></table><br>
<a name="1257952"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Henri</td><td align="right"><font class=tiny>(Posted 2015)</font>&nbsp;<a href="#2">[#2]</a></td></tr></table></td></tr><tr ><td class="posttext"> Hi,<br><br>there is the balloon infotip available which can be popuped with 'ShellNotifyInfo' function. I can take a look at it later if you want.<br><br>-Henri <br><br></td></tr></table><br>
<a name="1257953"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >col</td><td align="right"><font class=tiny>(Posted 2015)</font>&nbsp;<a href="#3">[#3]</a></td></tr></table></td></tr><tr ><td class="posttext"> A 'tooltip' by definition will show only when the user moves the mouse over an icon that has a tooltip associated with it. So what you have would be 'expected behavaiour'.<br>An 'infotip' on the other hand can be made to show information using the Shell_NotifyInfo function using a popup ( which you get when you plug in or remove a usb device into a usb port ). If you fill out the rest of the NOTIFYICONINFO structure ( you have the info and guid etc parts missing ) then it should work. <br><br></td></tr></table><br>
<a name="1258270"></a>

<a name="1258271"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Grisu</td><td align="right"><font class=tiny>(Posted 2015)</font>&nbsp;<a href="#4">[#4]</a></td></tr></table></td></tr><tr ><td class="posttext"> @Henri:<br>If you could take a look, that would be nice. I don't know anything about this API stuff.<br><br>As far as I know, balloon tips aren't supported by lower Windows versions. So I'd like to make this optional. Just in case the OS doesn't support it or the user doesn't want it (i.e. "If balloon_tip=true and OS &gt; WinXP then").<br><br>I would use the code to make a small notification when a new song is played and my apps sits in the system tray. <br><br></td></tr></table><br>
<a name="1258307"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Henri</td><td align="right"><font class=tiny>(Posted 2015)</font>&nbsp;<a href="#5">[#5]</a></td></tr></table></td></tr><tr ><td class="posttext"> I'll try to work it out on weekend.<br><br>-Henri <br><br></td></tr></table><br>
<a name="1258437"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Grisu</td><td align="right"><font class=tiny>(Posted 2015)</font>&nbsp;<a href="#6">[#6]</a></td></tr></table></td></tr><tr ><td class="posttext"> Great, thanks a lot. <br><br></td></tr></table><br>
<a name="1258486"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >col</td><td align="right"><font class=tiny>(Posted 2015)</font>&nbsp;<a href="#7">[#7]</a></td></tr></table></td></tr><tr ><td class="posttext"> Hiya,<br><br><div class="quote"> As far as I know, balloon tips aren't supported by lower Windows versions. <br></div><br>Infotips ( or balloon tips ) are supported down to and including XP, but that's it. <br><br></td></tr></table><br>
<a name="1258578"></a>

<a name="1258770"></a>

<a name="1258801"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Henri</td><td align="right"><font class=tiny>(Posted 2015)</font>&nbsp;<a href="#8">[#8]</a></td></tr></table></td></tr><tr ><td class="posttext"> Allrighty,<br><br>here is a working example for displaying balloon info in taskbar. I haven't tested it in other than Windows 7 64-bit, but should work from XP to Win 8 (if not then do let me know). This version is ANSI-standard so not sure how it behaves in all localizations, but making UNICODE version isn't that difficult if needed. I would perhaps wrap all this functionality inside a type just for neatness, but thats optional.<br><br>EDIT: Updated code for Unicode support and few fixes.<br><br>EDIT2: Fixed EditInfo() so that if no parameters are supplied<br>           then the balloontip is disabled.<br><br>Example:<br><textarea class=codebox name="code" wrap=OFF readonly="true" rows="15" cols="80">SuperStrict

' TrayIcon 

Framework Maxgui.Drivers
Import BRL.EventQueue
Import "object.o"         ' &lt;- YOU NEED TO CHANGE THAT TO ANOTHER ICON OBJ FILE OR COMMENT IT OUT (= NO ICON)
 
AppTitle = "TrayIcon Example"

?Win32
' Tray icon related stuff
Const NIM_ADD:Int		= 0
Const NIM_MODIFY:Int	= 1
Const NIM_DELETE:Int	= 2
Const NIM_SETFOCUS:Int	= 3
Const NIM_SETVERSION:Int= 4

Const NIF_MESSAGE:Int	= $1
Const NIF_ICON:Int		= $2
Const NIF_TIP:Int		= $4
Const NIF_STATE:Int		= $8
Const NIF_INFO:Int		= $10
Const NIF_GUID:Int		= $20
Const NIF_SHOWTIP:Int	= $80

Const NIIF_NONE:Int		= 0
Const NIIF_USER:Int		= 4

Const NOTIFYICON_VERSION_4:Int = 4

Global nid:TNotifyIconData

Extern "win32"
	Function Shell_NotifyIcon:Int(message:Int, notifyicondata:Byte Ptr) = "Shell_NotifyIconW@8"
End Extern
?

Local FLAGS:Int
FLAGS:| WINDOW_TITLEBAR
FLAGS:| WINDOW_RESIZABLE
FLAGS:| WINDOW_MENU
FLAGS:| WINDOW_CLIENTCOORDS
'FLAGS:| WINDOW_HIDDEN
FLAGS:| WINDOW_ACCEPTFILES

Global MainWindow:TGadget = CreateWindow( AppTitle, 100, 100, 320, 240, Null, FLAGS )
Global TrayIconPanel:TGadget = CreatePanel(0, 0, 0, 0, MainWindow, 0 )

Global win_trayed:Int=0

Repeat
	WaitEvent()
	Print CurrentEvent.ToString()
	Select EventID()
		Case EVENT_AppSuspend
        '   DebugLog "App now suspended!"

		If WindowMinimized(Mainwindow) Then 
			
			?win32
			HideGadget(MainWindow)
			
			If Not nid Then
				'Initial info
				RegisterTrayIcon(TrayIconPanel, "THIS IS MY COOL APP")
				EditInfo("Now playing live~n from Radio City!", "TITLE")
				ShowInfo()
			Else
				RegisterTrayIcon(TrayIconPanel)
				ShowInfo()
			EndIf
			?			
       EndIf 

	Case EVENT_MOUSEDOWN

		Select EventSource()
		Case TrayIconPanel
			If EventData()=1 Then
				RemoveTrayIcon()
				RedrawGadget(Mainwindow) 
				ShowGadget(MainWindow)
				RedrawGadget (MainWindow)
				RestoreWindow(Mainwindow)
			EndIf 

			If EventData()=2 Then
			   
				EditInfo("","")
				ShowInfo()
				
	 		EndIf

		End Select
   
		Case EVENT_APPTERMINATE, EVENT_WINDOWCLOSE
			RemoveTrayIcon() ; End
	End Select
Forever

' Tray Icon Functions, Win 32 only! ----------------------------------------------------------
Function RegisterTrayIcon( window:TGadget, toolTip:String="" )
' Register tray icon

	?Win32
	If Not nid Then

		nid = New TNotifyIconData
		nid.Size = SizeOf(TNotifyIconData)
		nid.hwnd = QueryGadget(window, QUERY_HWND)
		
		SetWindowLongW(nid.hwnd,GWL_WNDPROC,Int Byte Ptr SysTrayWndProc)
		
		nid.CallbackMessage = WM_APP
		nid.Icon = LoadIconW(GetModuleHandleW(Null),Short Ptr(101))

		nid.Flags = NIF_MESSAGE | NIF_TIP | NIF_ICON | NIF_INFO
	EndIf
	
	If toolTip Then _stringCopy( Varptr nid.Tip, toolTip, 128)

	Shell_NotifyIcon( NIM_ADD, nid)
	?
	
	Win_trayed:Int=1
End Function

' Display balloon
'---------------------
Function ShowInfo:Int()
	If nid Then Shell_NotifyIcon( NIM_MODIFY, nid)
EndFunction

' Edit balloon text
'---------------------
Function EditInfo:Int(info:String="", title:String="", icon:Int=NIIF_USER)

	If Not nid Then Return False
		
	nid.InfoFlags = icon ' Info icon. NIIF_NONE = no icon. There are few system icons available
	
	_stringCopy( Varptr nid.info, info, 256)
	Local pInfoTmp:Short Ptr = Varptr nid.InfoTitle
	_stringCopy( pInfoTmp, title, 64)

EndFunction

' Remove tray icon from taskbar
'--------------------------------
Function RemoveTrayIcon:Int()    

	If Not nid Then Return False
	
	?Win32
	Shell_NotifyIcon(NIM_DELETE, nid)
	?
	
	win_trayed=0
End Function


Function SysTrayWndProc%(hwnd%,msg%,wp%,lp%) "win32"
'WndProc NotifyIcon -&gt; Blitz Event
	?Win32
	Select msg 
		Case WM_APP
                 Local owner:TGadget = TWindowsGUIDriver.GadgetFromHwnd(hwnd)
			If owner Then
				Select lp
				     Case WM_MOUSELEAVE
						PostGuiEvent( EVENT_MOUSELEAVE, owner )
 				     Case WM_MOUSEMOVE
						PostGuiEvent( EVENT_MOUSEMOVE, owner )
					Case WM_RBUTTONDOWN
						PostGuiEvent( EVENT_MOUSEDOWN, owner, MOUSE_RIGHT )
					Case WM_LBUTTONDOWN
						PostGuiEvent( EVENT_MOUSEDOWN, owner, MOUSE_LEFT )
					Case WM_RBUTTONDOWN	
						PostGuiEvent( EVENT_MOUSEDOWN, owner, MOUSE_RIGHT )
				EndSelect
			EndIf
	EndSelect
	Return TWindowsGUIDriver.ClassWndProc(hwnd,msg,wp,lp)
	?
EndFunction

Function _stringCopy(dst:Short Ptr, str:String, size:Int)
	
	Local l:Int, src:Short Ptr = str.ToWString() 
	
	If str.length &gt;= size Then l=size - 1 ; Else l=str.length
	MemClear( Byte Ptr(dst), size*2)
	
	For Local i:Int = 0 Until l
		dst[i]=src[i]
	Next
	MemFree src

EndFunction

Type TNotifyIconData 
	Field Size:Int
	Field hwnd:Int
	Field id:Int
	Field Flags:Int
	Field CallbackMessage:Int
	Field Icon:Int 	
	
	Field Tip:Short 				
	Field Tip2:Short 
	Field Tip3:Int 
	Field Tip4:Long 
	Field Tip5:Long 
	Field Tip6:Long 
	Field Tip7:Long 
	Field Tip8:Long 	
	Field Tip9:Long 		
	Field Tip10:Long 
	Field Tip11:Long 
	Field Tip12:Long 
	Field Tip13:Long 
	Field Tip14:Long 
	Field Tip15:Long 
	Field Tip16:Long
	
	Field Tip17:Long 				
	Field Tip18:Long 
	Field Tip19:Long
	Field Tip20:Long
	Field Tip21:Long 
	Field Tip22:Long 
	Field Tip23:Long 
	Field Tip24:Long 
	Field Tip25:Long 	
	Field Tip26:Long 		
	Field Tip27:Long 
	Field Tip28:Long 
	Field Tip29:Long 
	Field Tip30:Long 
	Field Tip31:Long 
	Field Tip32:Long
	Field Tip33:Long 
	Field Tip34:Long 
	
	Field State:Int
	Field StateMask:Int
	
	Field info:Short
	Field info2:Short
	Field info3:Int
	Field info4:Long
	Field info5:Long
	Field info6:Long
	Field info7:Long
	Field info8:Long
	Field info9:Long
	Field info10:Long
	Field info11:Long
	Field info12:Long
	Field info13:Long
	Field info14:Long
	Field info15:Long
	Field info16:Long
	
	Field info17:Long
	Field info18:Long
	Field info19:Long
	Field info20:Long
	Field info21:Long
	Field info22:Long
	Field info23:Long
	Field info24:Long
	Field info25:Long
	Field info26:Long
	Field info27:Long
	Field info28:Long
	Field info29:Long
	Field info30:Long
	Field info31:Long
	Field info32:Long
	
	Field info33:Long
	Field info34:Long
	Field info35:Long
	Field info36:Long
	Field info37:Long
	Field info38:Long
	Field info39:Long 
	Field info40:Long
	Field info41:Long
	Field info42:Long
	Field info43:Long
	Field info44:Long
	Field info45:Long
	Field info46:Long
	Field info47:Long
	Field info48:Long
	
	Field info49:Long
	Field info50:Long
	Field info51:Long
	Field info52:Long
	Field info53:Long
	Field info54:Long
	Field info55:Long
	Field info56:Long
	Field info57:Long
	Field info58:Long
	Field info59:Long
	Field info60:Long
	Field info61:Long
	Field info62:Long
	Field info63:Long
	Field info64:Long
	Field info65:Long
	Field info66:Long

	Field Timeout:Int
	Field InfoTitle:Short
	Field InfoTitle2:Short
	Field InfoTitle3:Int
	Field InfoTitle4:Long
	Field InfoTitle5:Long
	Field InfoTitle6:Long
	Field InfoTitle7:Long
	Field InfoTitle8:Long
	Field InfoTitle9:Long
	Field InfoTitle10:Long
	Field InfoTitle11:Long
	Field InfoTitle12:Long
	Field InfoTitle13:Long
	Field InfoTitle14:Long
	Field InfoTitle15:Long
	Field InfoTitle16:Long
	Field InfoTitle17:Long
	Field InfoTitle18:Int
	
	Field InfoFlags:Int
EndType

</textarea><br><br>-Henri <br><br></td></tr></table><br>
<a name="1258626"></a>

<a name="1258627"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Grisu</td><td align="right"><font class=tiny>(Posted 2015)</font>&nbsp;<a href="#9">[#9]</a></td></tr></table></td></tr><tr ><td class="posttext"> Thanks for digging into this.<br><br>I'm need of a unicode version if that is possible. Because some stations transmit data in Cyrillic for instance.<br><br>So far it seems to work:<br><img src="http://i60.tinypic.com/ouw2g8_th.png"><br><br>Only thing I have noticed under windows 8 is that when I edited a balloon-tip, the normal tooltip for the tray icon itself will no longer show up if you move the mouse over it.<br><br>Use the line "RegisterTrayIcon(TrayIconPanel, "THIS IS MY COOL APP")" as replacement for your example code above.<br><br>Still testing... <br><br></td></tr></table><br>
<a name="1258670"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Henri</td><td align="right"><font class=tiny>(Posted 2015)</font>&nbsp;<a href="#10">[#10]</a></td></tr></table></td></tr><tr ><td class="posttext"> No problem, I'll see about that unicode version and tooltip.<br><br>-Henri <br><br></td></tr></table><br>
<a name="1258672"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Grisu</td><td align="right"><font class=tiny>(Posted 2015)</font>&nbsp;<a href="#11">[#11]</a></td></tr></table></td></tr><tr ><td class="posttext"> Thanks Henri! Do you have an e-mail address where I can contact you? <br><br></td></tr></table><br>
<a name="1258771"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Henri</td><td align="right"><font class=tiny>(Posted 2015)</font>&nbsp;<a href="#12">[#12]</a></td></tr></table></td></tr><tr ><td class="posttext"> OK, I've updated the example above for Unicode support and couple of fixes. <br><br><br>You can contact me at kp9176&lt;at&gt;gmail.com .I usually don't watch it frequently, but if you post within a week I can get back to you from a proper email address.<br><br>-Henri <br><br></td></tr></table><br>
<a name="1258795"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Grisu</td><td align="right"><font class=tiny>(Posted 2015)</font>&nbsp;<a href="#13">[#13]</a></td></tr></table></td></tr><tr ><td class="posttext"> Hi again!<br><br>For my testing the new code works fine, I only ran into one issue.<br><br>I need to enable and disable the tips from within the app.<br><br>For this I use a simple option "ini_dis_balloontip" to determine this. <br><br>It works if I have the balloontips disabled and then enable them.<br>But if they are disabled after being enabled, they always appear. Even though the EditInfo() and ShowInfo() aren't called anymore?	<br><br>Example function code:<br><pre class=code>
Function RegisterTrayIcon( window:TGadget, toolTip:String="" )
' Register tray icon

	?Win32
	Titlebak:String=""
	Artistbak:String=""
		If Not nid Then

		nid = New TNotifyIconData
		nid.Size = SizeOf(TNotifyIconData)
		nid.hwnd = QueryGadget(window, QUERY_HWND)
		
		SetWindowLongW(nid.hwnd,GWL_WNDPROC,Int Byte Ptr SysTrayWndProc)
		
		nid.CallbackMessage = WM_APP
		nid.Icon = LoadIconW(GetModuleHandleW(Null),Short Ptr(101))

		nid.Flags = NIF_MESSAGE | NIF_TIP | NIF_ICON | NIF_INFO
	EndIf
	
	If toolTip Then _stringCopy( Varptr nid.Tip, toolTip, 128)

        'Print "ini dis ball: "+ini_dis_balloontip
	If ini_dis_balloontip=0 Then 
	 EditInfo(station_genre, station_name)
    	 Showinfo()  
       EndIf

	Shell_NotifyIcon(NIM_ADD, nid)

	?
	
	prp_trayed:Int=1
End Function
</pre><br><br>Any idea, what might cause this behaviour?<br><br>P.S. You've got mail. <br><br></td></tr></table><br>
<a name="1258802"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Henri</td><td align="right"><font class=tiny>(Posted 2015)</font>&nbsp;<a href="#14">[#14]</a></td></tr></table></td></tr><tr ><td class="posttext"> I have revised the code above (see EDIT2:).<br><br><br><div class="quote"> P.S. You've got mail.  <br></div>Answered.<br><br>-Henri <br><br></td></tr></table><br>
<a name="1258803"></a>

<a name="1258804"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Chalky</td><td align="right"><font class=tiny>(Posted 2015)</font>&nbsp;<a href="#15">[#15]</a></td></tr></table></td></tr><tr ><td class="posttext"> . <br><br></td></tr></table><br>
<a name="1259926"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Grisu</td><td align="right"><font class=tiny>(Posted 2015)</font>&nbsp;<a href="#16">[#16]</a></td></tr></table></td></tr><tr ><td class="posttext"> I made a function to only update the tooltip itself.<br><br><pre class=code>
Function EditTrayTooltip(toolTip:String="")
?win32
 	If toolTip Then _stringCopy( Varptr nid.Tip, toolTip, 128)
	Shell_NotifyIcon( NIM_ADD, nid)
?
End Function 
</pre><br><br>The only issue left is that when the balloon tips are disabled, the function does no longer update the tooltip? <br><br></td></tr></table><br>
<a name="1259929"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Henri</td><td align="right"><font class=tiny>(Posted 2015)</font>&nbsp;<a href="#17">[#17]</a></td></tr></table></td></tr><tr ><td class="posttext"> Hi,<br><br>only thing I see a bit off is the use of NIM_ADD instead of NIM_MODIFY ?<br><br>-Henri <br><br></td></tr></table><br>
<a name="1259942"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Grisu</td><td align="right"><font class=tiny>(Posted 2015)</font>&nbsp;<a href="#18">[#18]</a></td></tr></table></td></tr><tr ><td class="posttext"> When I use NIM_MODIFY, the balloon tip will show up. But the tooltip on the tray icon stays the same. <br><br>I only need to set the tooltip on an already registered tray icon. I could remove and set it again for each new song, but this would look strange. :)<br><br>I uploaded the latest prp testbuild (III) to my website. If you want to see, how it currently works. <br><br></td></tr></table><br>
<a name="1259970"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Henri</td><td align="right"><font class=tiny>(Posted 2015)</font>&nbsp;<a href="#19">[#19]</a></td></tr></table></td></tr><tr ><td class="posttext"> I see :-).<br><br>Ok, modify ShowInfo() function a bit like so:<pre class=code>Function ShowInfo:Int()
	If nid Then
		nid.flags = NIF_MESSAGE | NIF_TIP | NIF_ICON | NIF_INFO
		Shell_NotifyIcon( NIM_MODIFY, nid)
	EndIf
EndFunction
</pre><br>Now modify the EditTrayTooltip() function a bit like so:<pre class=code>Function EditTrayTooltip(toolTip:String="")
?win32
 	If toolTip Then _stringCopy( Varptr nid.Tip, toolTip, 128)
	nid.flags = NIF_MESSAGE | NIF_TIP | NIF_ICON
	Shell_NotifyIcon( NIM_MODIFY, nid)
?
End Function 
</pre><br><br>And here is the newest version of the example in whole:<br><br><textarea class=codebox name="code" wrap=OFF readonly="true" rows="15" cols="80">SuperStrict

' TrayIcon 

Framework Maxgui.Drivers
Import BRL.EventQueue
Import "object.o"         ' &lt;- YOU NEED TO CHANGE THAT TO ANOTHER ICON OBJ FILE OR COMMENT IT OUT (= NO ICON)
 
AppTitle = "TrayIcon Example"

?Win32
' Tray icon related stuff
Const NIM_ADD:Int		= 0
Const NIM_MODIFY:Int	= 1
Const NIM_DELETE:Int	= 2
Const NIM_SETFOCUS:Int	= 3
Const NIM_SETVERSION:Int= 4

Const NIF_MESSAGE:Int	= $1
Const NIF_ICON:Int		= $2
Const NIF_TIP:Int		= $4
Const NIF_STATE:Int		= $8
Const NIF_INFO:Int		= $10
Const NIF_GUID:Int		= $20
Const NIF_SHOWTIP:Int	= $80

Const NIIF_NONE:Int		= 0
Const NIIF_USER:Int		= 4

Const NOTIFYICON_VERSION_4:Int = 4

Global nid:TNotifyIconData

Extern "win32"
	Function Shell_NotifyIcon:Int(message:Int, notifyicondata:Byte Ptr) = "Shell_NotifyIconW@8"
End Extern
?

Local FLAGS:Int
FLAGS:| WINDOW_TITLEBAR
FLAGS:| WINDOW_RESIZABLE
FLAGS:| WINDOW_MENU
FLAGS:| WINDOW_CLIENTCOORDS
'FLAGS:| WINDOW_HIDDEN
FLAGS:| WINDOW_ACCEPTFILES

Global MainWindow:TGadget = CreateWindow( AppTitle, 100, 100, 320, 240, Null, FLAGS )
Global TrayIconPanel:TGadget = CreatePanel(0, 0, 0, 0, MainWindow, 0 )

Global win_trayed:Int=0

Local tmpFlag:Int = 1

Repeat
	WaitEvent()
	Print CurrentEvent.ToString()
	Select EventID()
		Case EVENT_AppSuspend
        '   DebugLog "App now suspended!"

		If WindowMinimized(Mainwindow) Then 
			
			?win32
			HideGadget(MainWindow)
			
			If Not nid Then
				'Initial info
				RegisterTrayIcon(TrayIconPanel, "THIS IS MY COOL APP")
				EditInfo("Now playing live~n from Radio City!", "TITLE")
				ShowInfo()
			Else
				RegisterTrayIcon(TrayIconPanel)
				ShowInfo()
			EndIf
			?			
       EndIf 

	Case EVENT_MOUSEDOWN

		Select EventSource()
		Case TrayIconPanel
			If EventData()=1 Then
				RemoveTrayIcon()
				RedrawGadget(Mainwindow) 
				ShowGadget(MainWindow)
				RedrawGadget (MainWindow)
				RestoreWindow(Mainwindow)
			EndIf 

			If EventData()=2 Then
			   
				If tmpFlag Then
					EditInfo("Hello","World")
					ShowInfo()
				Else
					Print "new tooltip"
					EditTrayTooltip("My new tooltip")
				EndIf
				
				tmpFlag = Not tmpFlag					 	
			EndIf

		End Select
   
		Case EVENT_APPTERMINATE, EVENT_WINDOWCLOSE
			RemoveTrayIcon() ; End
	End Select
Forever

' Tray Icon Functions, Win 32 only! ----------------------------------------------------------
Function RegisterTrayIcon( window:TGadget, toolTip:String="" )
' Register tray icon

	?Win32
	If Not nid Then

		nid = New TNotifyIconData
		nid.Size = SizeOf(TNotifyIconData)
		nid.hwnd = QueryGadget(window, QUERY_HWND)
		
		SetWindowLongW(nid.hwnd,GWL_WNDPROC,Int Byte Ptr SysTrayWndProc)
		
		nid.CallbackMessage = WM_APP
		nid.Icon = LoadIconW(GetModuleHandleW(Null),Short Ptr(101))

		nid.Flags = NIF_MESSAGE | NIF_TIP | NIF_ICON | NIF_INFO
	EndIf
	
	If toolTip Then _stringCopy( Varptr nid.Tip, toolTip, 128)

	Shell_NotifyIcon( NIM_ADD, nid)
	?
	
	Win_trayed:Int=1
End Function

' Display balloon
'---------------------
Function ShowInfo:Int()
	If nid Then
		nid.flags = NIF_MESSAGE | NIF_TIP | NIF_ICON | NIF_INFO
		Shell_NotifyIcon( NIM_MODIFY, nid)
	EndIf
EndFunction

' Edit balloon text
'---------------------
Function EditInfo:Int(info:String="", title:String="", icon:Int=NIIF_USER)

	If Not nid Then Return False
		
	nid.InfoFlags = icon ' Info icon. NIIF_NONE = no icon. There are few system icons available
	
	_stringCopy( Varptr nid.info, info, 256)
	Local pInfoTmp:Short Ptr = Varptr nid.InfoTitle
	_stringCopy( pInfoTmp, title, 64)

EndFunction

Function EditTrayTooltip(toolTip:String="")
?win32
 	If toolTip Then _stringCopy( Varptr nid.Tip, toolTip, 128)
	nid.flags = NIF_MESSAGE | NIF_TIP | NIF_ICON
	Shell_NotifyIcon( NIM_MODIFY, nid)
?
End Function 

' Remove tray icon from taskbar
'--------------------------------
Function RemoveTrayIcon:Int()    

	If Not nid Then Return False
	
	?Win32
	Shell_NotifyIcon(NIM_DELETE, nid)
	?
	
	win_trayed=0
End Function


Function SysTrayWndProc%(hwnd%,msg%,wp%,lp%) "win32"
'WndProc NotifyIcon -&gt; Blitz Event
	?Win32
	Select msg 
		Case WM_APP
                 Local owner:TGadget = TWindowsGUIDriver.GadgetFromHwnd(hwnd)
			If owner Then
				Select lp
				     Case WM_MOUSELEAVE
						PostGuiEvent( EVENT_MOUSELEAVE, owner )
 				     Case WM_MOUSEMOVE
						PostGuiEvent( EVENT_MOUSEMOVE, owner )
					Case WM_RBUTTONDOWN
						PostGuiEvent( EVENT_MOUSEDOWN, owner, MOUSE_RIGHT )
					Case WM_LBUTTONDOWN
						PostGuiEvent( EVENT_MOUSEDOWN, owner, MOUSE_LEFT )
					Case WM_RBUTTONDOWN	
						PostGuiEvent( EVENT_MOUSEDOWN, owner, MOUSE_RIGHT )
				EndSelect
			EndIf
	EndSelect
	Return TWindowsGUIDriver.ClassWndProc(hwnd,msg,wp,lp)
	?
EndFunction

Function _stringCopy(dst:Short Ptr, str:String, size:Int)
	
	Local l:Int, src:Short Ptr = str.ToWString() 
	
	If str.length &gt;= size Then l=size - 1 ; Else l=str.length
	MemClear( Byte Ptr(dst), size*2)
	
	For Local i:Int = 0 Until l
		dst[i]=src[i]
	Next
	MemFree src

EndFunction

Type TNotifyIconData 
	Field Size:Int
	Field hwnd:Int
	Field id:Int
	Field Flags:Int
	Field CallbackMessage:Int
	Field Icon:Int 	
	
	Field Tip:Short 				
	Field Tip2:Short 
	Field Tip3:Int 
	Field Tip4:Long 
	Field Tip5:Long 
	Field Tip6:Long 
	Field Tip7:Long 
	Field Tip8:Long 	
	Field Tip9:Long 		
	Field Tip10:Long 
	Field Tip11:Long 
	Field Tip12:Long 
	Field Tip13:Long 
	Field Tip14:Long 
	Field Tip15:Long 
	Field Tip16:Long
	
	Field Tip17:Long 				
	Field Tip18:Long 
	Field Tip19:Long
	Field Tip20:Long
	Field Tip21:Long 
	Field Tip22:Long 
	Field Tip23:Long 
	Field Tip24:Long 
	Field Tip25:Long 	
	Field Tip26:Long 		
	Field Tip27:Long 
	Field Tip28:Long 
	Field Tip29:Long 
	Field Tip30:Long 
	Field Tip31:Long 
	Field Tip32:Long
	Field Tip33:Long 
	Field Tip34:Long 
	
	Field State:Int
	Field StateMask:Int
	
	Field info:Short
	Field info2:Short
	Field info3:Int
	Field info4:Long
	Field info5:Long
	Field info6:Long
	Field info7:Long
	Field info8:Long
	Field info9:Long
	Field info10:Long
	Field info11:Long
	Field info12:Long
	Field info13:Long
	Field info14:Long
	Field info15:Long
	Field info16:Long
	
	Field info17:Long
	Field info18:Long
	Field info19:Long
	Field info20:Long
	Field info21:Long
	Field info22:Long
	Field info23:Long
	Field info24:Long
	Field info25:Long
	Field info26:Long
	Field info27:Long
	Field info28:Long
	Field info29:Long
	Field info30:Long
	Field info31:Long
	Field info32:Long
	
	Field info33:Long
	Field info34:Long
	Field info35:Long
	Field info36:Long
	Field info37:Long
	Field info38:Long
	Field info39:Long 
	Field info40:Long
	Field info41:Long
	Field info42:Long
	Field info43:Long
	Field info44:Long
	Field info45:Long
	Field info46:Long
	Field info47:Long
	Field info48:Long
	
	Field info49:Long
	Field info50:Long
	Field info51:Long
	Field info52:Long
	Field info53:Long
	Field info54:Long
	Field info55:Long
	Field info56:Long
	Field info57:Long
	Field info58:Long
	Field info59:Long
	Field info60:Long
	Field info61:Long
	Field info62:Long
	Field info63:Long
	Field info64:Long
	Field info65:Long
	Field info66:Long

	Field Timeout:Int
	Field InfoTitle:Short
	Field InfoTitle2:Short
	Field InfoTitle3:Int
	Field InfoTitle4:Long
	Field InfoTitle5:Long
	Field InfoTitle6:Long
	Field InfoTitle7:Long
	Field InfoTitle8:Long
	Field InfoTitle9:Long
	Field InfoTitle10:Long
	Field InfoTitle11:Long
	Field InfoTitle12:Long
	Field InfoTitle13:Long
	Field InfoTitle14:Long
	Field InfoTitle15:Long
	Field InfoTitle16:Long
	Field InfoTitle17:Long
	Field InfoTitle18:Int
	
	Field InfoFlags:Int
EndType
</textarea><br><br>-Henri <br><br></td></tr></table><br>
<a name="1260198"></a>

<a name="1260199"></a>

<a name="1260201"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Grisu</td><td align="right"><font class=tiny>(Posted 2015)</font>&nbsp;<a href="#20">[#20]</a></td></tr></table></td></tr><tr ><td class="posttext"> Not working as expected. The balloon code isn't reliable from my testing so far. <br><br>Guess, I will fall back to the old code. More testing over the weekend. <br><br></td></tr></table><br>
<a name="1260348"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Henri</td><td align="right"><font class=tiny>(Posted 2015)</font>&nbsp;<a href="#21">[#21]</a></td></tr></table></td></tr><tr ><td class="posttext"> Okey,<br><br>I made some 'slight' modifications. Sorry if it's a 'bit' different , but I think it will be cleaner and more OO.<br><br><textarea class=codebox name="code" wrap=OFF readonly="true" rows="15" cols="80">SuperStrict

'-----------------
'TrayIcon example
'-----------------

Framework Maxgui.Drivers
Import BRL.EventQueue
Import "object.o"         ' &lt;- YOU NEED TO CHANGE THAT TO ANOTHER ICON OBJ FILE OR COMMENT IT OUT (= NO ICON)
 
AppTitle = "TrayIcon Example"

Local FLAGS:Int
FLAGS:| WINDOW_TITLEBAR
FLAGS:| WINDOW_RESIZABLE
FLAGS:| WINDOW_MENU
FLAGS:| WINDOW_CLIENTCOORDS
'FLAGS:| WINDOW_HIDDEN
FLAGS:| WINDOW_ACCEPTFILES

Local MainWindow:TGadget = CreateWindow( AppTitle, 100, 100, 320, 240, Null, FLAGS )
Local initFlag:Int = True
Local tmpFlag:Int = True

Repeat
	WaitEvent()
	'Print CurrentEvent.ToString()
	Select EventID()

	Case EVENT_AppSuspend

		If WindowMinimized(Mainwindow) Then 
			
			?win32
			HideGadget(MainWindow)
			
			If initFlag Then
				
				DebugLog "Setting for first time..."
				
				CreateTrayIcon(MainWindow)
				SetTrayTip("THIS IS MY COOL APP")
				SetTrayInfo("Now playing live~n from Radio City!", "TITLE")
				ShowTrayInfo()
			Else
			
				DebugLog "Showing trayicon with existing text"
			
				CreateTrayIcon(MainWindow)
				ShowTrayInfo()
			EndIf
			
			initFlag = False
			?			
       EndIf 

	Case EVENT_MOUSEDOWN

		Select EventSource()
		
		Case GetTrayGadget()
		
			'On LEFT_MOUSE restoring main window and deleting trayicon. Could be done inside SysTrayWndProc() also. 
			If EventData()=1 Then
				
				DeleteTrayIcon()
				RedrawGadget(Mainwindow) 
				ShowGadget(MainWindow)
				RedrawGadget (MainWindow)
				RestoreWindow(Mainwindow)
			EndIf 
			
			'Alternating actions when pressing RIGHT_MOUSE
			If EventData()=2 Then
			   
				If tmpFlag Then
					
					DebugLog "Setting info to ~qHello world~q and showing..."
					
					SetTrayInfo("World","HELLO")
					SetTrayTip("Hello world!")
					ShowTrayInfo()
				Else
					
					DebugLog "Setting only tooltip to ~qnew tooltip~q"
			
					SetTrayTip("My new tooltip")
				EndIf
				
				tmpFlag = Not tmpFlag					 	
			EndIf

		End Select
   
	Case EVENT_APPTERMINATE, EVENT_WINDOWCLOSE
	
		DeleteTrayIcon() ; End

	End Select
Forever


'-----------------------
'Windows Tray functions
'-----------------------
?Win32
Extern "win32"
	Function Shell_NotifyIcon:Int(message:Int, notifyicondata:Byte Ptr) = "Shell_NotifyIconW@8"
End Extern
?

Function CreateTrayIcon:Int(parent:tgadget)
	Return TTrayIcon.RegisterTrayIcon(parent)
EndFunction

Function DeleteTrayIcon:Int()
	Return TTrayIcon.DeleteTrayIcon()
EndFunction

Function SetTrayInfo:Int(info:String="", title:String="", icon:Int=-1)
	Return TTrayIcon.EditInfo(info, title, icon)
EndFunction

Function SetTrayTip:Int(toolTip:String="")
	Return TTrayIcon.EditToolTip(toolTip)
EndFunction

Function ShowTrayInfo:Int()
	Return TTrayIcon.ShowInfo()
EndFunction

Function IsTrayed:Int()
	Return TTrayIcon.win_trayed
EndFunction

Function GetTrayGadget:TGadget()
	Return TTrayIcon.TrayIconPanel
EndFunction

Type TTrayIcon

	' Tray icon related stuff
	Const NIM_ADD:Int		= 0
	Const NIM_MODIFY:Int	= 1
	Const NIM_DELETE:Int	= 2
	Const NIM_SETFOCUS:Int	= 3
	Const NIM_SETVERSION:Int= 4
	
	Const NIF_MESSAGE:Int	= $1
	Const NIF_ICON:Int		= $2
	Const NIF_TIP:Int		= $4
	Const NIF_STATE:Int		= $8
	Const NIF_INFO:Int		= $10
	Const NIF_GUID:Int		= $20
	Const NIF_SHOWTIP:Int	= $80
	
	'Icon's
	Const NIIF_NONE:Int		= 0
	Const NIIF_USER:Int		= 4

	Global nid:TNotifyIconData
	Global trayIconPanel:tgadget
	
	Global hwnd:Int, win_trayed:Int = 1
	Global tip:String, info:String

	' Register tray icon	
	'----------------------------------------------------------
	Function RegisterTrayIcon:Int(parent:tgadget)
	
		?Win32
		If Not nid Then
			
			If Not parent Then Return False
			TrayIconPanel = CreatePanel(0, 0, 0, 0, parent, 0 )
		
			nid = New TNotifyIconData
			nid.Size = SizeOf(TNotifyIconData)
			nid.hwnd = QueryGadget(TrayIconPanel , QUERY_HWND)
			hwnd = nid.hwnd
			
			SetWindowLongW(nid.hwnd,GWL_WNDPROC,Int Byte Ptr SysTrayWndProc)
			
			nid.CallbackMessage = WM_APP
			nid.Icon = LoadIconW(GetModuleHandleW(Null),Short Ptr(101))
	
			nid.Flags = NIF_MESSAGE | NIF_TIP | NIF_ICON | NIF_INFO
		EndIf
		
		'If toolTip Then _stringCopy( Varptr nid.Tip, toolTip, 128)
	
		Shell_NotifyIcon( NIM_ADD, nid)
		
		Return True
		?
		
	End Function
	
	' Display balloon
	'---------------------
	Function ShowInfo:Int()
		
		?Win32
		If Not nid Then Return False
	
		nid.flags = NIF_MESSAGE | NIF_TIP | NIF_ICON | NIF_INFO
		Shell_NotifyIcon( NIM_MODIFY, nid)
		
		Return True
		?
		
	EndFunction
	
	' Edit balloon text
	'---------------------
	Function EditInfo:Int(info:String="", title:String="", icon:Int)
		
		?Win32
		If Not nid Then Return False
		
		If icon = -1 Then icon = NIIF_USER	
		nid.InfoFlags = icon ' Info icon. NIIF_NONE = no icon. There are few system icons available
		
		_stringCopy( Varptr nid.info, info, 256)
		Local pInfoTmp:Short Ptr = Varptr nid.InfoTitle
		_stringCopy( pInfoTmp, title, 64)
		
		Return True
		?
		
	EndFunction
	
	' Edit tooltip text
	'---------------------
	Function EditTooltip:Int(toolTip:String="")
		
		?Win32
		If Not nid Then Return False
	 	
		_stringCopy( Varptr nid.Tip, toolTip, 128)
		nid.flags = NIF_MESSAGE | NIF_TIP | NIF_ICON
		Shell_NotifyIcon( NIM_MODIFY, nid)
		
		Return True
		?
		
	End Function 
	
	' Delete tray icon from taskbar
	'--------------------------------
	Function DeleteTrayIcon:Int()    
		
		?Win32
		If Not nid Then Return False
		
		Shell_NotifyIcon(NIM_DELETE, nid)
		win_trayed=0
		
		Return True
		?
		
	End Function

	'WndProc NotifyIcon -&gt; Blitz Event
	'--------------------------------------
	Function SysTrayWndProc%(hwnd%,msg%,wp%,lp%) "win32"
	
		Select msg 
			Case WM_APP
				Local owner:TGadget = TWindowsGUIDriver.GadgetFromHwnd(hwnd)
				If owner Then
					Select lp
					     Case WM_MOUSELEAVE
							PostGuiEvent( EVENT_MOUSELEAVE, owner )
	 				     Case WM_MOUSEMOVE
							PostGuiEvent( EVENT_MOUSEMOVE, owner )
						Case WM_RBUTTONDOWN
							PostGuiEvent( EVENT_MOUSEDOWN, owner, MOUSE_RIGHT )
						Case WM_LBUTTONDOWN
							PostGuiEvent( EVENT_MOUSEDOWN, owner, MOUSE_LEFT )
						Case WM_RBUTTONDOWN	
							PostGuiEvent( EVENT_MOUSEDOWN, owner, MOUSE_RIGHT )
					EndSelect
				EndIf
		EndSelect
		
		Return TWindowsGUIDriver.ClassWndProc(hwnd,msg,wp,lp)
	EndFunction
	
	'Copy string into memory
	'----------------------------------------
	Function _stringCopy(dst:Short Ptr, str:String, size:Int)
		
		Local l:Int, src:Short Ptr = str.ToWString() 
		
		If str.length &gt;= size Then l=size - 1 ; Else l=str.length
		MemClear( Byte Ptr(dst), size*2)
		
		For Local i:Int = 0 Until l
			dst[i]=src[i]
		Next
		
		MemFree src
		
	EndFunction
	
EndType


Type TNotifyIconData 
	Field Size:Int
	Field hwnd:Int
	Field id:Int
	Field Flags:Int
	Field CallbackMessage:Int
	Field Icon:Int 	
	
	Field Tip:Short 				
	Field Tip2:Short 
	Field Tip3:Int 
	Field Tip4:Long 
	Field Tip5:Long 
	Field Tip6:Long 
	Field Tip7:Long 
	Field Tip8:Long 	
	Field Tip9:Long 		
	Field Tip10:Long 
	Field Tip11:Long 
	Field Tip12:Long 
	Field Tip13:Long 
	Field Tip14:Long 
	Field Tip15:Long 
	Field Tip16:Long
	
	Field Tip17:Long 				
	Field Tip18:Long 
	Field Tip19:Long
	Field Tip20:Long
	Field Tip21:Long 
	Field Tip22:Long 
	Field Tip23:Long 
	Field Tip24:Long 
	Field Tip25:Long 	
	Field Tip26:Long 		
	Field Tip27:Long 
	Field Tip28:Long 
	Field Tip29:Long 
	Field Tip30:Long 
	Field Tip31:Long 
	Field Tip32:Long
	Field Tip33:Long 
	Field Tip34:Long 
	
	Field State:Int
	Field StateMask:Int
	
	Field info:Short
	Field info2:Short
	Field info3:Int
	Field info4:Long
	Field info5:Long
	Field info6:Long
	Field info7:Long
	Field info8:Long
	Field info9:Long
	Field info10:Long
	Field info11:Long
	Field info12:Long
	Field info13:Long
	Field info14:Long
	Field info15:Long
	Field info16:Long
	
	Field info17:Long
	Field info18:Long
	Field info19:Long
	Field info20:Long
	Field info21:Long
	Field info22:Long
	Field info23:Long
	Field info24:Long
	Field info25:Long
	Field info26:Long
	Field info27:Long
	Field info28:Long
	Field info29:Long
	Field info30:Long
	Field info31:Long
	Field info32:Long
	
	Field info33:Long
	Field info34:Long
	Field info35:Long
	Field info36:Long
	Field info37:Long
	Field info38:Long
	Field info39:Long 
	Field info40:Long
	Field info41:Long
	Field info42:Long
	Field info43:Long
	Field info44:Long
	Field info45:Long
	Field info46:Long
	Field info47:Long
	Field info48:Long
	
	Field info49:Long
	Field info50:Long
	Field info51:Long
	Field info52:Long
	Field info53:Long
	Field info54:Long
	Field info55:Long
	Field info56:Long
	Field info57:Long
	Field info58:Long
	Field info59:Long
	Field info60:Long
	Field info61:Long
	Field info62:Long
	Field info63:Long
	Field info64:Long
	Field info65:Long
	Field info66:Long

	Field Timeout:Int
	Field InfoTitle:Short
	Field InfoTitle2:Short
	Field InfoTitle3:Int
	Field InfoTitle4:Long
	Field InfoTitle5:Long
	Field InfoTitle6:Long
	Field InfoTitle7:Long
	Field InfoTitle8:Long
	Field InfoTitle9:Long
	Field InfoTitle10:Long
	Field InfoTitle11:Long
	Field InfoTitle12:Long
	Field InfoTitle13:Long
	Field InfoTitle14:Long
	Field InfoTitle15:Long
	Field InfoTitle16:Long
	Field InfoTitle17:Long
	Field InfoTitle18:Int
	
	Field InfoFlags:Int
EndType

</textarea><br><br>-Henri <br><br></td></tr></table><br>
<a name="1260562"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Grisu</td><td align="right"><font class=tiny>(Posted 2015)</font>&nbsp;<a href="#22">[#22]</a></td></tr></table></td></tr><tr ><td class="posttext"> Hi, under Win8 your newest code instantly closes the balloon tip the second time you resink the app into the task bar on Win 8.1.<br><br>1. run exampled code<br>2. minimise app -&gt; balloon shows up for 3 seconds.<br>3. maximise app<br>4. minimise app again -&gt; no ballon shows or only for a blink of time.<br><br>Will try to implement your new code structure into my main code now. <br><br></td></tr></table><br>
<a name="1260574"></a>

<a name="1260576"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Henri</td><td align="right"><font class=tiny>(Posted 2015)</font>&nbsp;<a href="#23">[#23]</a></td></tr></table></td></tr><tr ><td class="posttext"> Hmm, it's probably not a Win8 issue as it seems to work fine on my Win8. I believe whenever app is added to systemtray it's automatically focused and if you press somewhere else causing it to lose focus ignites the fading out pocess for the balloon tip. Maybe one thing to try out as Win8 notification time is defaulted to 5 seconds so you could try to change this from the 'Easy access settings' to longer time to see if it makes any difference.<br><br>EDIT:   Could you send me your manifest file for testing ?<br><br>-Henri <br><br></td></tr></table><br>
<a name="1260687"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Grisu</td><td align="right"><font class=tiny>(Posted 2015)</font>&nbsp;<a href="#24">[#24]</a></td></tr></table></td></tr><tr ><td class="posttext"> Hello again. Thanks for all your help. <br><br>After spending my saturday on this matter. I'm going back to the old code as I couldn't get it to work properly. <br><br></td></tr></table><br>
<a name="bottom"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td align="right"><a href="http://monkeycoder.co.nz" target="_blank"><img src="/img/monkey2.svg" ></a> <a href="https://github.com/blitz-research" target="_blank"><img src="/img/github.svg" ></a> <a href="https://discord.gg/qJccbSp" target="_blank"><img src="/img/discord.svg" ></a></td></tr></table><br></div><br><table width="100%"><tr><td></body></html lang="en">
