<!DOCTYPE html><html lang="en" ><head ><title >Massive multiple-canvas performance hit</title><meta name='viewport' content='width=device-width, initial-scale=0.66'><meta name='description' content='language:basic, target:desktop, category:game development'><link rel="styleSheet" href="../skins/granite/style.css" type="text/css"><style type="text/css">div.bbcode {padding: 8px;background: #E5E5E5;color: #000000;border: 1px dashed #B4B4BE;}</style></head><body ><table width=100% cellspacing=0 cellpadding=0><tr ><td class="menubarleft"></td><td class="menubar"><table cellspacing="0" cellpadding="0"><tr ><td >&nbsp;</td><td class="menuitemleft"></td><td class="menuitem"><a href="/" class="menuitem">News</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/forums.php" class="menuitem">Forums</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/codearcs.php" class="menuitem">Code</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/logs.php" class="menuitem">Logs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/gallery.php" class="menuitem">Gallery</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/sdkspecs.php" class="menuitem">Specs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/search.php" class="menuitem">Search</a></td><td class="menuitemright"></td></tr></table></td><td class="menubarright"></td></tr></table><div class="main"><h1 >Massive multiple-canvas performance hit</h1><a href="forums.php" >BlitzMax Forums</a>/<a href="topics.php?forum=117" >MaxGUI Module</a>/<a href="#bottom" >Massive multiple-canvas performance hit</a><br><br>
<a name="913907"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >SpaceAce</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#1">[#1]</a></td></tr></table></td></tr><tr ><td class="posttext"> I've noticed that, with one canvas, I can draw a rect and flip in 0-1ms. When I add a second canvas, the time taken to draw and flip (really, the draw is negligible, it's all in the flip) jumps to 18-25ms. There seems to be little or no difference between debug and release, both show pretty much identical slowdown.<br><br>Is this just inherent in trying to use multiple canvases, or is there some secret I am not aware of? The draw function looks like this:<br><br><pre class=code>
Function TemporaryDraw(Canvas:TGadget)
	SetGraphics CanvasGraphics ( Canvas )
	SetViewport 0, 0, GadgetWidth(Canvas), GadgetHeight(Canvas)
        Cls
        DrawRect(0, 0, 200, 200)
	Flip 0
End Function
</pre><br><br>I've tested each piece individually, and, not surprisingly, the time is all lost in the flip. Why do two flips take 20x longer than one? <br><br></td></tr></table><br>
<a name="914005"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Grisu</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#2">[#2]</a></td></tr></table></td></tr><tr ><td class="posttext"> You should get rid of the "viewport" command.<br>At least try to avoid "math" inside the drawing routine: <br>=&gt;e.g. GadgetHeight(Canvas)and GadgetWidth(Canvas)<br><br>That should speed things up a bit. <br><br></td></tr></table><br>
<a name="914010"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >tonyg</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#3">[#3]</a></td></tr></table></td></tr><tr ><td class="posttext"> Is there a simple example we can run that will show the performance issue? <br><br></td></tr></table><br>
<a name="914047"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >SpaceAce</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#4">[#4]</a></td></tr></table></td></tr><tr ><td class="posttext"> Hi, Grisu. Like I said, I tried each bit individually. All of the time is being lost to the Flip command. As to what you said about keeping math out of the function, I agree with you. The above function was generated by a tool I was using.<br><br>tonyg, I'll add some test code to this post. In the meantime, I've narrowed down the problem.<br><br>I am using event hooks and a single timer to refresh the canvases. Everything seems OK at 10 or 20, but as I creep the refresh timer up, the problem starts to appear. Around 65-70, the window becomes unresponsive to any events and the time taken to draw the canvases starts leaping up.<br><br>My first thought was that the timer was just firing too often and the drawing was hogging all the resources. I thought maybe the draw operation were getting stacked on top of one another - a second one starting before the first finished - but I added a "lock" to my logic loop, so the drawing function would not run again if it hadn't completed the last time, and it had no effect.<br><br>I have a sneaking suspicion I am doing something really obvious and really stupid, and that this is all refresh-rate related, somehow. Especially since my desktop refresh rate is at 75 and the draw time in the code below settles on 13-14ms as the timer Hz are increased, which seems like a bit much for coincidence.<br><br>Here's some hastily thrown together source code:<br><pre class=code>
SuperStrict

Import maxgui.drivers

SetGraphicsDriver(GLMax2DDriver())

Global MainWindow:TGadget
MainWindow = CreateWindow:TGadget("Logic_Gui", 220, 155, 830, 629, Null,
    WINDOW_TITLEBAR | WINDOW_RESIZABLE | WINDOW_MENU | WINDOW_STATUS | WINDOW_CLIENTCOORDS)
Global Canvas1:TGadget
Canvas1 = CreateCanvas:TGadget(2, 2, 300, 216, MainWindow, Null)
Global Canvas2:TGadget
Canvas2 = CreateCanvas:TGadget(518, 2, 300, 216, MainWindow, Null)

AddHook(EmitEventHook, HookHandler)
Global Which:Byte = 0
Global OneCanvas:Int = 0
Global TimeTakenSingle:Int = 0
Global TimeTakenDouble:Int = 0

Global DrawTimer:TTimer = CreateTimer(100)

While (WaitEvent() &lt;&gt; EVENT_WINDOWCLOSE)
Wend


Function HookHandler:Object(iId:Int, tData:Object, tContext:Object)
	Local Event:TEvent = TEvent(TData)
	
	Select Event.id
		Case EVENT_TIMERTICK
		  Select Event.source
			Case DrawTimer
			  Select Which &amp; 1
			    Case True
			      Local s:Int = MilliSecs()
		    	      SetGraphics(CanvasGraphics(Canvas1))
		  	      Flip 0
	  		      SetGraphics(CanvasGraphics(Canvas2))
  		              Cls
			      DrawText("Both canvases drawn in " + TimeTakenDouble + "ms.", 10, 60)
			      Flip 0
			      TimeTakenDouble = MilliSecs() - s
			      Which:~ 1
			      Return Null
			    Case False
			      Local s:Int = MilliSecs()
  			      SetGraphics(CanvasGraphics(Canvas1))
  			      Cls
			      DrawText("One canvas drawn in " + TimeTakenSingle + "ms.", 10, 60)
			      Flip 0
			      TimeTakenSingle = MilliSecs() - s
			      Which:~ 1
			      Return Null
			    End Select
			End Select
	End Select
	Return TData
End Function
</pre><br><br>Two things to note:<br>1) The timer refresh rate is really half of what it says, since every other loop draws a single canvas instead of both canvases.<br>2) There is a point between working smoothly and failing entirely as you push up the timer refresh rate where the draw time is high for the first 2-6 seconds of program execution, then settles down to a more reasonable rate. I tried throwing a "sleep" in before starting the timer, but it did nothing.<br><br>One other odd symptom: clicking (and/or holding) down a mouse button on the title bar causes a big spike in draw times when drawing two canvases, but not when only drawing one.<br><br>On my computer, total meltdown is achieved somewhere around 140 ticks/second. I need to be able to reliably refresh at around 60Hz for the application I have in mind. I could probably get things semi-working by only redrawing the canvases when they are "dirty", but a timer simplifies things for me, especially since the dirty canvases can come in big groups. <br><br></td></tr></table><br>
<a name="914147"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >REDi</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#5">[#5]</a></td></tr></table></td></tr><tr ><td class="posttext"> I'll second this bug, I've just spent ages trying to figure out why an old app of mine has started freezing, it came down to the same problem, multiple canvases on a timer.  This never used to happen so it must be something that's been changed quite recently.<br><br>I'm using the SVN version BTW. <br><br></td></tr></table><br>
<a name="914153"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >skidracer</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#6">[#6]</a></td></tr></table></td></tr><tr ><td class="posttext"> Please see the RedrawGadget example for best practise implementation. It uses a timer to tell the OS the canvas needs redrawing and redraws the canvas when the OS tells it to (EVENT_GADGETPAINT). <br><br></td></tr></table><br>
<a name="914154"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >REDi</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#7">[#7]</a></td></tr></table></td></tr><tr ><td class="posttext"> My app already uses RedrawGadget <br><br></td></tr></table><br>
<a name="914159"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >skidracer</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#8">[#8]</a></td></tr></table></td></tr><tr ><td class="posttext"> hmph, if possible can you try changing win32maxguiex.bmx[835] to:<br><pre class=code>
				InvalidateRect _hwnd,Null,0
</pre> <br><br></td></tr></table><br>
<a name="914167"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >REDi</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#9">[#9]</a></td></tr></table></td></tr><tr ><td class="posttext"> That's much better skid.  (line 840) <br><br></td></tr></table><br>
<a name="914181"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >SebHoll</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#10">[#10]</a></td></tr></table></td></tr><tr ><td class="posttext"> Eeekkk... I'm not sure that we could use that as a permanent solution as:<br><br>a) Iirc, InvalidateRect doesn't redraw the window's children.<br>b) InvalideRect only invalidates a control's client area, i.e. the gadget's frame is not invalidated.<br><br>Quite honestly, I'm finding it hard to reproduce the problem (maybe it's because of Vista's Desktop Composition), but I'm curious as to whether replacing the same line (which on my PC is 841) with...<br><br><pre class=code>Return RedrawWindow( _hwnd, Null, Null, RDW_INVALIDATE | RDW_ERASE | RDW_FRAME | RDW_ALLCHILDREN )</pre>...speeds thing up too. If so, then we should probably use this instead for the reasons outlined above. If not, then we may have to be a bit more creative. <br><br></td></tr></table><br>
<a name="914183"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >REDi</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#11">[#11]</a></td></tr></table></td></tr><tr ><td class="posttext"> Just tried that out Seb, still freezes with it :(<br><br>(freezes with 6 canvases at 20 hertz) <br><br></td></tr></table><br>
<a name="914184"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >skidracer</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#12">[#12]</a></td></tr></table></td></tr><tr ><td class="posttext"> Don't fret Seb, it was just a test to verify the problem, a canvas specific patch I think will be most optimal, still looking into original problem also. <br><br></td></tr></table><br>
<a name="914241"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >SpaceAce</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#13">[#13]</a></td></tr></table></td></tr><tr ><td class="posttext"> Hi, skidracer. I will update my code to reflect the proper practice shown in the RedrawGadget example, thanks for the heads-up. In the meantime, I gather there actually is something wrong besides my being a lousy programmer, so I'll keep an eye out for a fix.<br><br>SpaceAce <br><br></td></tr></table><br>
<a name="bottom"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td align="right"><a href="http://monkeycoder.co.nz" target="_blank"><img src="/img/monkey2.svg" ></a> <a href="https://github.com/blitz-research" target="_blank"><img src="/img/github.svg" ></a> <a href="https://discord.gg/qJccbSp" target="_blank"><img src="/img/discord.svg" ></a></td></tr></table><br></div><br><table width="100%"><tr><td></body></html lang="en">
