<!DOCTYPE html><html lang="en" ><head ><title >Open discussion on Collision Optimization</title><meta name='viewport' content='width=device-width, initial-scale=0.66'><meta name='description' content='language:basic, target:desktop, category:game development'><link rel="styleSheet" href="../skins/granite/style.css" type="text/css"><style type="text/css">div.bbcode {padding: 8px;background: #E5E5E5;color: #000000;border: 1px dashed #B4B4BE;}</style></head><body ><table width=100% cellspacing=0 cellpadding=0><tr ><td class="menubarleft"></td><td class="menubar"><table cellspacing="0" cellpadding="0"><tr ><td >&nbsp;</td><td class="menuitemleft"></td><td class="menuitem"><a href="/" class="menuitem">News</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/forums.php" class="menuitem">Forums</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/codearcs.php" class="menuitem">Code</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/logs.php" class="menuitem">Logs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/gallery.php" class="menuitem">Gallery</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/sdkspecs.php" class="menuitem">Specs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/search.php" class="menuitem">Search</a></td><td class="menuitemright"></td></tr></table></td><td class="menubarright"></td></tr></table><div class="main"><h1 >Open discussion on Collision Optimization</h1><a href="forums.php" >Monkey Archive Forums</a>/<a href="topics.php?forum=510" >Monkey Discussion</a>/<a href="#bottom" >Open discussion on Collision Optimization</a><br><br>
<a name="2081178"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Paul - Taiphoz</td><td align="right"><font class=tiny>(Posted 2014)</font>&nbsp;<a href="#1">[#1]</a></td></tr></table></td></tr><tr ><td class="posttext"> Lets have a chat about collisions and how to optimize them for lots of collide-able objects.<br><br>To help this chat we can use this basic scenario, <b>Player</b>, <b>Bullet</b>,<b>Terrain</b> and <b>Enemy</b> , these collections would be lists, arrays or maps or any other form of collection we have available in monkey.<br><br>So with our test scenario we need to check the player against all bullets being shot from the enemy and all enemy and players against the terrain, so the basic idea is then to iterate through these lists checking for collisions, and this is fine when your only dealing with a few objects but as you add more then things will start to really slow down.<br><br><b>The Basics</b><br>For example, if your checking 10 bullets which are flying across the screen from the player toward the enemy and there happen to be 100 enemy on the screen then were checking each bullet against all 1-100 enemy and that's 1-1000 collision checks, and early boost can come from getting out of the loop once a collision is detected, if the bullet hits something there is no point in checking it against everything else in most cases.<br><br><b>Bounding Box</b><br>Assuming that a check is using something more complex and slower than a simple rect overlaps, what you can do is do an initial bounding box check on your objects, if for example the bullet is not inside a bounding box around an alien then there is no point in proceeding with a more complex more accurate check, if however the alien and bullet's bounding box do overlap then checking for a more accurate collision will take place, this alone can drastically speed things up when your dealing with a lot of bullets or a lot of things those bullets can collide with. <br><br></td></tr></table><br>
<a name="2081177"></a>

<a name="2081176"></a>

<a name="2081188"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >wiebow</td><td align="right"><font class=tiny>(Posted 2014)</font>&nbsp;<a href="#2">[#2]</a></td></tr></table></td></tr><tr ><td class="posttext"> Use a quadtree? <br><br></td></tr></table><br>
<a name="2081195"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >AdamRedwoods</td><td align="right"><font class=tiny>(Posted 2014)</font>&nbsp;<a href="#3">[#3]</a></td></tr></table></td></tr><tr ><td class="posttext"> Grid system, quadtree, sweep and prune (SAP) are three slightly different ways you can use to reduce checks.<br><br><b>sweep and prune</b> is probably the easiest to implement, so i'll describe that (in my own words, may be slightly muddled):<br>1. sort your main list with respect to x-axis. use either "position minus circle radius" or "bounding box minimum" lowest to highest.<br>2. compare the first with the next item in the sorted list. what we're doing is checking for overlap with either position + radius or maxx&gt;minx bounding box.<br>3. does it overlap on that axis? if so, push to a "pairs" stack, and check the first one with the next+1 object. repeat until no overlap.<br>4. move on to the second object, and now check for overlap on the second+1 object (you already check the first one). repeat step 3.<br>5. and so on.<br>6. in your new pairs stack, check each pair for y-axis overlap. if so, push to a final "hit pair" stack. repeat until the first x-axis pair list is done.<br>7. you now have a stack of objects that have hit either by circle-circle or bounding box. you can do a narrow phase or just accept these results and do your collision response.<br><br>article on sweep and prune:<br><a href="http://jitter-physics.com/wordpress/?tag=sweep-and-prune" target="_blank">http://jitter-physics.com/wordpress/?tag=sweep-and-prune</a><br><br>i'm developing an octree for miniB3D, so if you want a conversation on quadtrees (similar to octrees), let me know.<br><a href="http://monkeycoder.co.nz/Community/posts.php?topic=6206&amp;post=81107" target="_blank">http://monkeycoder.co.nz/Community/posts.php?topic=6206&amp;post=81107</a> <br><br></td></tr></table><br>
<a name="2081194"></a>

<a name="2081193"></a>

<a name="2081192"></a>

<a name="2081191"></a>

<a name="2081190"></a>

<a name="2081196"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Paul - Taiphoz</td><td align="right"><font class=tiny>(Posted 2014)</font>&nbsp;<a href="#4">[#4]</a></td></tr></table></td></tr><tr ><td class="posttext"> Yeah saw your twitter graphic of it, looks really cool, Quadtree was a method I was going to mention but given its the main one used I felt it might end the thread prematurely if I had mentioned it .. glad some one else brought it up.<br><br>Used quadtree for a few of my max projects but not done any with monkey yet, not really had the need, there is a brilliant quadtree tutorial with a cool particle demo I have bookmarked some where tho that I might try and implement and port to monkey over the next few days or weeks, I have a feeling I might need to use a Quadtree for my little side project if I really want it to be the bullet hell I have in my mind.<br><br>In regard to quadtree's and monkey I was wondering if its performance boost is actually good given how people have complained about the GC in the past I was thinking that the process of creating short lists or maps could generate a lot of garbage.. ? <br><br></td></tr></table><br>
<a name="2081199"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >AdamRedwoods</td><td align="right"><font class=tiny>(Posted 2014)</font>&nbsp;<a href="#5">[#5]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> In regard to quadtree's and monkey I was wondering if its performance boost is actually good given how people have complained about the GC <br></div><br>quadtree is relatively static compared to SAP, so it's better for things like big scrolling levels. more static requires less GC. SAP is probably better for bullet hell, but you may need to sort lists in place to avoid the GC. but don't worry about that at first. <br><br></td></tr></table><br>
<a name="2081200"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >zoqfotpik</td><td align="right"><font class=tiny>(Posted 2014)</font>&nbsp;<a href="#6">[#6]</a></td></tr></table></td></tr><tr ><td class="posttext"> You can also use square bins.  Every tick each bullet decides what bin it's in, and then check only objects in the same or neighboring bins.  When everything can collide with everything you need a method like binning or quadtrees and binning is easier.  You can also do quadtrees semi-manually by having screen quadrant bins which are checked first, then quarters of the screen quadrants, then quarters of the quarters.  That's easy because you just have three bin systems and it doesn't require any sort of recursive quad system the way quadtrees typically work. <br><br></td></tr></table><br>
<a name="2081205"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Paul - Taiphoz</td><td align="right"><font class=tiny>(Posted 2014)</font>&nbsp;<a href="#7">[#7]</a></td></tr></table></td></tr><tr ><td class="posttext"> don't suppose you would go into some more detail with this bin method, I think I get the gist of it in that I may for example like a quadtree split my screen into 4 bins or lists, top left, top right bottom left and right, and then each tick I would remove a bullet from its current bin/list and add it to the correct one if its moved from one region to another, does all that pushing on and off of lists not cause a bit of a bottle neck ? <br><br></td></tr></table><br>
<a name="2081207"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >AdamRedwoods</td><td align="right"><font class=tiny>(Posted 2014)</font>&nbsp;<a href="#8">[#8]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> does all that pushing on and off of lists not cause a bit of a bottle neck ? <br></div><br>not compared to the savings. pushing on/off isn't like checking through a collision list at O(n*n). <br><br></td></tr></table><br>
<a name="2081208"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >SLotman</td><td align="right"><font class=tiny>(Posted 2014)</font>&nbsp;<a href="#9">[#9]</a></td></tr></table></td></tr><tr ><td class="posttext"> Doing sorts/quadtree/octree are really faster than using a simple AABB collision check? <br>I don't doubt that for 3D meshes/scenes this is really necessary - but on 2D... ?<br><br>I'm really serious - I can't see all that extra work, to be faster than this:<br><pre class=code>
If  (x &lt; bb.x + bb.w) then
   if  (x + w &gt; bb.x) then
       if  (y &lt; bb.y + bb.h) then 
           if (y + h &gt; bb.y) Then collision = True
</pre><br><br>If the first comparison fails, the collision check is done, and the game can move on to the next.<br>I never did a "bullet hell" game to stress test this - and I believe it may slow down on a really bad case like that - but otherwise, if you have less than 100 objects on screen, there is no need for such complexity. <br><br></td></tr></table><br>
<a name="2081209"></a>

<a name="2081210"></a>

<a name="2081211"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >AdamRedwoods</td><td align="right"><font class=tiny>(Posted 2014)</font>&nbsp;<a href="#10">[#10]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> if you have less than 100 objects on screen, there is no need for such complexity. <br></div><br>yes, less than 100 objects, there's no need.<br>but what if these 100 objects are checking against each other every frame? that's 5000 (100*100/2) bounding box checks . a simple grid/bin phase could cut this down into 900 checks if a 3x3 grid has 10-12 objects if evenly spread. let's say the grid/bin checks are an extra 100 checks, so that's 1000 checks vs 5000 checks.<br><br>i've tested this out already on a tower defense game i made. it was very slow on android, until i created a grid phase to check for targeting/bullet collisions. <br><br></td></tr></table><br>
<a name="2081216"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >zoqfotpik</td><td align="right"><font class=tiny>(Posted 2014)</font>&nbsp;<a href="#11">[#11]</a></td></tr></table></td></tr><tr ><td class="posttext"> Paul, you got it right.  And pushing pointers on and off lists is really quick especially if the list is a pool.<br><br>With quadrant binning you run into edge cases where two objects might be just on opposite sides of a division line but in practice this is not noticeable at all.<br><br>If you have physics response to collisions it also acts to limit the numbers of collisions somewhat because the objects crowd each other out of bins so there will be a smaller number in any given bin.<br><br>When I first ran into the x*x exponential collision problem I was first amazed that only a few thousand objects were bogging my system, then floored by the efficiency of the binning.<br><br>And as someone said, you have a huge amount of free CPU time to do physics or whatever because anything is better than the high end of that exponential curve.<br><br>I do it with two if/thens, one for x and then one for y, so many cases fall through and do not need to be tested. <br><br>Slotman: trust me, it's necessary above trivial numbers of collisions.  Code up a basic geometry wars game where all objects can collide with each other and you will very rapidly see your system slow to a crawl. <br><br></td></tr></table><br>
<a name="2081214"></a>

<a name="2081215"></a>

<a name="2081217"></a>

<a name="2081218"></a>

<a name="2081220"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >SLotman</td><td align="right"><font class=tiny>(Posted 2014)</font>&nbsp;<a href="#12">[#12]</a></td></tr></table></td></tr><tr ><td class="posttext"> But what type of game do you have to check everything against everything?!?<br><br>Really, in tower defenses, you have basically 2 checks:<br>- to see if an enemy is within range of a tower (basic radius check, could also be solved first with an AABB to speed the test up)<br>- if a tower shot hit the enemy<br><br>You don't check towers vs enemies, you don't check enemies against enemies. And towers don't shoot hundreds of bullets.<br>What you guys didn't see is that AABB collisions works like a grid system. If bullet.x &gt; enemy.x+enemy.width, and it's out of the enemy "grid", no further test is done. The worst case is when there *is* a collision, and you go by 4 "ifs" for each bullet.<br><br>This system works for something like 20-30 objects on screen on a 3.5Mhz computer (this, I have tested!). Should be pretty fast for 200-300 objects on any cell phone released in the last 5 years or so. <br><br></td></tr></table><br>
<a name="2081223"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >AdamRedwoods</td><td align="right"><font class=tiny>(Posted 2014)</font>&nbsp;<a href="#13">[#13]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> Really, in tower defenses, you have basically 2 checks: <br></div><br>you are correct, i did exactly as you described, but yet as soon as i got to android, the game broke down to a crawl. ( 100-200 units+enemies)<br>a simple grid based check helped nicely. <br><br></td></tr></table><br>
<a name="2081414"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Paul - Taiphoz</td><td align="right"><font class=tiny>(Posted 2014)</font>&nbsp;<a href="#14">[#14]</a></td></tr></table></td></tr><tr ><td class="posttext"> by grid you mean the bin method yeah ?<br><br>I'm wondering about the bin method and weather or not an overlapping grid might be a good idea, for example imagine a width of 4 hundred pixels, you might normally use two bins 200 pixels each but what if you used 3 with the extra bin overlapping the middle of the first two, which would cover any objects that are on that border line between bins, sure it would add potential double checks on a few objects but it might be worth while in the long run. <br><br></td></tr></table><br>
<a name="2081421"></a>

<a name="2081422"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >wiebow</td><td align="right"><font class=tiny>(Posted 2014)</font>&nbsp;<a href="#15">[#15]</a></td></tr></table></td></tr><tr ><td class="posttext"> For reference: I have a quadtree for monkey on my google code site: <a href="https://code.google.com/p/mutated-monkey/wiki/quadtree" target="_blank">https://code.google.com/p/mutated-monkey/wiki/quadtree</a><br><br>And indeed it is best for really large levels and stuff like that. You problably will not need this in static screen games and a decent rect check for each object. <br><br></td></tr></table><br>
<a name="2081486"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >AdamRedwoods</td><td align="right"><font class=tiny>(Posted 2014)</font>&nbsp;<a href="#16">[#16]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> I'm wondering about the bin method and weather or not an overlapping grid might be a good idea <br></div><br>what if the object is larger than the overlapping bin?<br>another way is to put an object into more than one bin, and remove duplicates during the search. i use a Map (an RB tree) for the octree. it's fast. <br><br></td></tr></table><br>
<a name="2082197"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >zoqfotpik</td><td align="right"><font class=tiny>(Posted 2014)</font>&nbsp;<a href="#17">[#17]</a></td></tr></table></td></tr><tr ><td class="posttext"> I check the current bin and all neighbors of the current bin.  If speed is a problem with that, check only the Von Neumann neighborhood of 4 fully adjacent bins. <br><br></td></tr></table><br>
<a name="bottom"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td align="right"><a href="http://monkeycoder.co.nz" target="_blank"><img src="/img/monkey2.svg" ></a> <a href="https://github.com/blitz-research" target="_blank"><img src="/img/github.svg" ></a> <a href="https://discord.gg/qJccbSp" target="_blank"><img src="/img/discord.svg" ></a></td></tr></table><br></div><br><table width="100%"><tr><td></body></html lang="en">
