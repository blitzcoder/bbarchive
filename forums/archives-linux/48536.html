<!DOCTYPE html><html lang="en" ><head ><title >Community Projects</title><meta name='viewport' content='width=device-width, initial-scale=0.66'><meta name='description' content='language:basic, target:desktop, category:game development'><link rel="styleSheet" href="../skins/granite/style.css" type="text/css"><style type="text/css">div.bbcode {padding: 8px;background: #E5E5E5;color: #000000;border: 1px dashed #B4B4BE;}</style></head><body ><table width=100% cellspacing=0 cellpadding=0><tr ><td class="menubarleft"></td><td class="menubar"><table cellspacing="0" cellpadding="0"><tr ><td >&nbsp;</td><td class="menuitemleft"></td><td class="menuitem"><a href="/" class="menuitem">News</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/forums.php" class="menuitem">Forums</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/codearcs.php" class="menuitem">Code</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/logs.php" class="menuitem">Logs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/gallery.php" class="menuitem">Gallery</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/sdkspecs.php" class="menuitem">Specs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/search.php" class="menuitem">Search</a></td><td class="menuitemright"></td></tr></table></td><td class="menubarright"></td></tr></table><div class="main"><h1 >Community Projects</h1><a href="forums.php" >Archives Forums</a>/<a href="topics.php?forum=109" >Linux Discussion</a>/<a href="#bottom" >Community Projects</a><br><br>
<a name="539653"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >skidracer</td><td align="right"><font class=tiny>(Posted 2005)</font>&nbsp;<a href="#1">[#1]</a></td></tr></table></td></tr><tr ><td class="posttext"> Given I have quite a bit of Cocoa development work underway on Apple and DirectX7 drivers were needed urgently under Windows it feels a little that things Linux haven't had much attention at Blitz Research.<br><br>Priority wise I'd say on the Linux jobs front there sits:<br><br>* compiling in embedded firefox / gtk widget (IDE online help)<br><br>* some form of packaged distribution for the popular distros that describes the x86vm(fullscreen) gl/glu(graphics) and stdc++6.0(legacy gcc) linking requirements<br><br>* ALSA sound driver<br><br>If anyone wants to lend a hand with any of these tasks free to email me.<br><br>I can provide some pointers for the ALSA driver, the package stuff needs someone with a bit more history of the Linux universe than I have and the Firefox widget I only just saw in action today in the distribution of some most excellent software I was playing with today ( Houdini Apprentice from www.sidefx.com ) so was quite chuffed an HTML browser solution for the IDE wasn't infact going to be that hard after all, whether BMK is up to the job of compiling a FireFox module may be another matter but i can provide some basic GTK2 code to get you started... <br><br></td></tr></table><br>
<a name="556244"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Craig Watson</td><td align="right"><font class=tiny>(Posted 2005)</font>&nbsp;<a href="#2">[#2]</a></td></tr></table></td></tr><tr ><td class="posttext"> I can take a look at ALSA but I can't make any promises of being able to get it working or the quality of the implementation if I do get it to work.<br><br>It is pretty easy to just get ALSA to just make some noise, so I'll see what I can do.  If I have any luck I'll send you an email.<br><br>I'll see if I can figure out a process for building RPMs too.  It seems most people's problems have been dependency related - packages would save us a lot of trouble.  I don't think I can help you with Debs though. <br><br></td></tr></table><br>
<a name="556283"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >computercoder</td><td align="right"><font class=tiny>(Posted 2005)</font>&nbsp;<a href="#3">[#3]</a></td></tr></table></td></tr><tr ><td class="posttext"> I can look into the DEBs.   If you get the ALSA stuff going, and maybe I could assist you in that, I can see what to do for getting the DEB files built :-) <br><br></td></tr></table><br>
<a name="556586"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Craig Watson</td><td align="right"><font class=tiny>(Posted 2005)</font>&nbsp;<a href="#4">[#4]</a></td></tr></table></td></tr><tr ><td class="posttext"> Like I said, it was pretty easy to get ALSA to make some noise.  I have it playing the OGG file and sound effects of Digesteroids, however the speed is messed up, there are latency issues, and some static depending on the settings.  I'm going to have to spend a fair bit more time on it, but at least so far it's making noise and not seg faulting or something :P<br><br>If you're interested computercoder, I can build an executable based on the ALSA code thus far so you can check whether sound through Freeaudio ALSA works.  It won't sound good, but it will make noise.  Let me know.<br><br>The RPM stuff looks pretty straightforward to set up, but getting it to handle the development dependencies may be a problem.  Basically I can pretty easily determine runtime dependencies by running ldd against a BlitzMax app (or RPM will do this for me) but it won't generate a list of required header files for example.  <br><br>We could ensure that BlitzMax installs all required dependencies to run and _I think_ compile applications, but you'd still need to find and install the development packages if you want to build modules.  I can probably determine all the development dependencies manually, but this would take a lot longer.<br><br>Oh, and I'll probably start a Worklog on this stuff for those who want to follow the progress. <br><br></td></tr></table><br>
<a name="556772"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Craig Watson</td><td align="right"><font class=tiny>(Posted 2005)</font>&nbsp;<a href="#5">[#5]</a></td></tr></table></td></tr><tr ><td class="posttext"> The sound is identical to the OSS version on my system.  So now I'm going to have to ask for you guys to volunteer to help.<br><br>If anyone feels like helping me to test it, please send me an email.  Click on my name at the top of the post to see the email in my profile.<br><br>To test, I have compiled the Rockout executable using the ALSA code.  I will send this to you as a tar.gz to extract and place in the BlitzMax/Samples/hitoro folder.<br><br>Please test for sound output, quality and latency.  Please ignore the other bugs in Rockout (flashing ship, etc.) as I'm only interested in testing the sound.  You should probably also compile a version of Rockout for yourself based on the current Freeaudio OSS code for comparison.<br><br>I would appreciate particularly feedback from those experiencing difficulty getting BlitzMax to play sound. <br><br></td></tr></table><br>
<a name="556824"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >BlitzSupport</td><td align="right"><font class=tiny>(Posted 2005)</font>&nbsp;<a href="#6">[#6]</a></td></tr></table></td></tr><tr ><td class="posttext"> Email sent.<br><br><div class="quote"> <br>Please ignore the other bugs in Rockout (flashing ship, etc.)<br> <br></div><br>Interestingly, I saw this for the first time last night -- it's stuck on the red 'hit' flash. Did you notice when this started (in terms of Max versions)? It used to be fine! Let me know via email if you don't want to clog up this thread... <br><br></td></tr></table><br>
<a name="556930"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Craig Watson</td><td align="right"><font class=tiny>(Posted 2005)</font>&nbsp;<a href="#7">[#7]</a></td></tr></table></td></tr><tr ><td class="posttext"> Reply sent.<br><br>It used to work but I think it broke after some update.  I think there was a change in the way some function worked which caused it.  My own stuff works fine though, so I've never worried about it.<br><br>You should also try out Digesteroids if you have time.  It's giving me Glibc Double Free errors.<br><br>You can download the compressed binary here: <a href="http://www.teamted.net/rockout.tar.gz" target="_blank">http://www.teamted.net/rockout.tar.gz</a><br><br>I'm going to clean up the source and then distribute it here also so people can try it out themselves.  I'm certainly no expert on ALSA so all comments will be appreciated.<br><br>Feedback to my email or in this thread please.  If necessary I'll start a new thread.<br><br>Oh, and ignore any messages you get in the console about buffer underruns.  Unless you get more than one or two. <br><br></td></tr></table><br>
<a name="557189"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Craig Watson</td><td align="right"><font class=tiny>(Posted 2005)</font>&nbsp;<a href="#8">[#8]</a></td></tr></table></td></tr><tr ><td class="posttext"> I've now uploaded the source to the changes here: <a href="http://www.teamted.net/freeaudioalsa.tar.gz" target="_blank">http://www.teamted.net/freeaudioalsa.tar.gz</a><br><br>These are the files freeaudio.bmx and freeaudio.cpp from BlitzMax/mod/pub.mod/freeaudio.mod.  I would suggest that you make a copy of freeaudio.bmx and freeaudio.cpp before you replace these files.  You could also just Synchronize Modules to get back the original versions.<br><br>For those interested, I'll post the changes to the source for both files.  I'll post the code around the changes for your reference.<br><pre class=code>freeaudio.bmx
?MacOS
Import "-framework AudioUnit"
Import "-framework AudioToolbox"
?
?Linux
Import "-lasound"
?
</pre>Added the Linux section with an import for ALSA libasound.  MacOS stuff wasn't changed, just for reference.<br><pre class=code>freeaudio.cpp
#ifdef __linux

#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;alsa/asoundlib.h&gt;
#include &lt;pthread.h&gt;

void *mixerthread(void *dev);

#define LINUXFRAG 2048

struct linuxaudio:audiodevice
{
	pthread_t	audiothread;
	int			threadid;
	snd_pcm_t 	*audio_fd;
	int 		playback;
	int			playing;
	int			fragsize,fragcount;
	int			buffersize;	//in bytes
	short		*buffer;
	
	int reset()
	{
		playing=0;
		mix=new mixer(LINUXFRAG);
		mix-&gt;freq=44100;
		mix-&gt;channels=2;
		buffer=new short[LINUXFRAG];
		buffersize=LINUXFRAG*2;
		pthread_attr_t	attr;
		pthread_attr_init(&amp;attr);
		threadid=pthread_create(&amp;audiothread,&amp;attr,mixerthread,(void*)this);	
		return 0;
	}
	
	int close()
	{	
		int		timeout;
		playing=0;
		timeout=5;
		while (timeout-- &amp;&amp; playback) sleep(1);
		return 0;
	}
};

audiodevice *OpenSystemAudio()
{
	return new linuxaudio();
}

void *mixerthread(void *v)
{
	sched_param		sched;	
	linuxaudio 		*dev;
	int			policy;
	unsigned int val;
	snd_pcm_uframes_t periodsize;
	snd_pcm_hw_params_t *hwparams;
	snd_pcm_hw_params_alloca(&amp;hwparams);
	int output_rate;
	int channels;
	int fragment_size;
	int fragment_count;
	fragment_size=LINUXFRAG;  //overall buffer size
	fragment_count=2; //2 - 16 fragment count - 2 minimum, the lower it is potentially the lower the latency

	pthread_getschedparam(pthread_self(),&amp;policy,&amp;sched);
	sched.sched_priority++;//policy=SCHED_RR;
	pthread_setschedparam(pthread_self(),policy,&amp;sched);

	//open audio device	
	dev=(linuxaudio*)v;	
	dev-&gt;playback=snd_pcm_open(&amp;dev-&gt;audio_fd, strdup("default"), SND_PCM_STREAM_PLAYBACK, 0); //uses default audio device..
	if (dev-&gt;playback==-1)
	{
		printf("linuxaudio failed\n");
		dev-&gt;playback=0;
		return 0;
	}		
	//configure device
	if (snd_pcm_hw_params_any(dev-&gt;audio_fd, hwparams) &lt; 0) {
		printf("linuxaudio failed at params any\n");
		return 0;
	}	
	if (snd_pcm_hw_params_set_access(dev-&gt;audio_fd, hwparams,SND_PCM_ACCESS_RW_INTERLEAVED) &lt; 0) {
		printf("linuxaudio failed at set access\n");
		return 0;
	}	
	
	if (snd_pcm_hw_params_set_format(dev-&gt;audio_fd, hwparams,SND_PCM_FORMAT_S16_LE) &lt; 0) {
		printf("linuxaudio failed at set format\n");
		return 0;
	}
	val = 44100;
	if (snd_pcm_hw_params_set_rate_near(dev-&gt;audio_fd, hwparams,&amp;val, 0) &lt; 0) {
		/* Try 48KHZ too */
		printf("linuxaudio - %d HZ not available, trying 48000HZ\n", output_rate);
		val = 48000;
		if (snd_pcm_hw_params_set_rate_near(dev-&gt;audio_fd, hwparams,&amp;val, 0) &lt; 0) {
			printf("linuxaudio failed at setting output rate (%d)\n", output_rate);
			return 0;
		}
		dev-&gt;mix-&gt;freq=val;		
	}
	channels=2;
	if (snd_pcm_hw_params_set_channels(dev-&gt;audio_fd, hwparams, channels) &lt; 0) {
		printf("linuxaudio failed at set channels (%d)\n", channels);
		return 0;
	}
	periodsize = (fragment_size) / 4; // bytes -&gt; frames for 16-bit,stereo - should be a minimum of 512
	if (snd_pcm_hw_params_set_period_size_near(dev-&gt;audio_fd, hwparams,&amp;periodsize, 0) &lt; 0) {
		printf("linuxaudio failed at set period size (%d)\n", (int)periodsize);			
		return 0;
	}
	val = fragment_count;
	if (snd_pcm_hw_params_set_periods_near(dev-&gt;audio_fd, hwparams,&amp;val, 0) &lt; 0) {
		printf("linuxaudio failed at set periods (%d)\n", val);			
		//should attempt a one by one period increase up to 16?
		return 0;
	}
	if (snd_pcm_hw_params(dev-&gt;audio_fd, hwparams) &lt; 0) {
		printf("linuxaudio failed at installing hw params\n");
		return 0;
	}
	//loop while playing sound
	dev-&gt;playing=1;
	while (dev-&gt;playing)
	{
		dev-&gt;mix-&gt;mix16(dev-&gt;buffer);
		if ((snd_pcm_writei (dev-&gt;audio_fd, dev-&gt;buffer,LINUXFRAG/2)) &lt; 0) {	//Half buffer for two channels?
			printf ("linuxaudio warning: buffer underrun occurred\n");
			if (snd_pcm_prepare(dev-&gt;audio_fd) &lt; 0) {
				printf ("linuxaudio failed at preparing pcm\n");
				dev-&gt;playing=0; //die gracefully
			}
		}	
	}
	snd_pcm_drop(dev-&gt;audio_fd);
	snd_pcm_close (dev-&gt;audio_fd);
	dev-&gt;audio_fd=0;
	dev-&gt;playback=0;
	return 0;
}

#endif
</pre>All code from ifdef ___linux has been modified, scroll almost right down to the bottom of the file for the linux section.<br><br>I've tried to retain the method used with OSS for ALSA.  Generally it would be recommended that we use interrupts and callbacks, but the thread stuff seems to work OK too.  This should make clear the differences between ALSA and OSS - it shows you can use ALSA very much like OSS.<br><br>Tweaking the LINUXFRAG and fragment_count values might lead to lower latency.<br><br>Any suggestions or critique is appreciated. <br><br></td></tr></table><br>
<a name="557435"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >computercoder</td><td align="right"><font class=tiny>(Posted 2005)</font>&nbsp;<a href="#9">[#9]</a></td></tr></table></td></tr><tr ><td class="posttext"> Craig,<br><br>I was thinking more about the audio in BlitzMax.   Seems to me that maybe it should do a 'detect' for the audio system on the linux distro at hand.  Granted OSS and ALSA are the primary sound support, but the others like aRts which we found out about for using inside of BlitzMax working on OSs like Linspire.   What I am getting at is that we as developers will not want to create a package for each kind of sound system, or tell the user to change this or that in their system.  Just have the BlitzMax app do it, and if the systems supported all fail, then tell the user.<br><br>Anyways, GREAT job working with OSS, ALSA, and aRts! <br><br></td></tr></table><br>
<a name="557636"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Craig Watson</td><td align="right"><font class=tiny>(Posted 2005)</font>&nbsp;<a href="#10">[#10]</a></td></tr></table></td></tr><tr ><td class="posttext"> While I would certainly like to provide an automatic detection routine, I'm not sure how this might affect the executable linking requirements, ie. would the user need to install libraries for eSound even if Blitz ends up using ALSA on their system?  I'll have to test it out, but I don't think actual libraries are needed unless we try to use functions from them.<br><br>The other problem with this is it would increase the development environment requirements.  It would mean the user would need the header files for aRts, ALSA, eSound, etc.  Granted most distros include dev packages for all of these, but it's an additional support headache.<br><br>If we had a configure system then we could check for the availability of headers and libraries during the build process and leave the parts out that aren't available, so for example, if you didn't install aRts packages, then your executables won't include aRts support.<br><br>This may be possible to do under the current system, I'll have to check it out.<br><br>We also have to get Mark and Simon to decide on how this will work.  I'm sure they're not keen to possibly have to support stuff they maybe don't understand and didn't program.  In this case it may be better for us to provide a separate public audio module instead, and if we're going to go that far, I'd rather provide an advanced library that supports Windows, Mac, Linux and plays tracker formats and does other nice stuff, like Audiere.  This was what I'd planned to attempt anyway after we got basic Linux Freeaudio working better. <br><br></td></tr></table><br>
<a name="558232"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >computercoder</td><td align="right"><font class=tiny>(Posted 2005)</font>&nbsp;<a href="#11">[#11]</a></td></tr></table></td></tr><tr ><td class="posttext"> Sounds GREAT Craig!  I'll help in any way I can if you need it. <br><br></td></tr></table><br>
<a name="560699"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Craig Watson</td><td align="right"><font class=tiny>(Posted 2005)</font>&nbsp;<a href="#12">[#12]</a></td></tr></table></td></tr><tr ><td class="posttext"> OK, I've wrapped up the work on ALSA for now.<br><br>As above:<br><pre class=code>freeaudio.bmx
?MacOS
Import "-framework AudioUnit"
Import "-framework AudioToolbox"
?
?Linux
Import "-lasound"
?
</pre><br><br>And:<br><pre class=code>
#ifdef __linux

#include &lt;sys/ioctl.h&gt;
#include &lt;unistd.h&gt;
#include &lt;fcntl.h&gt;
#include &lt;sys/soundcard.h&gt;
#include &lt;pthread.h&gt;
#include &lt;alsa/asoundlib.h&gt;

void *mixerthread(void *dev);

#define LINUXFRAG 2048

struct linuxaudio:audiodevice
{
	pthread_t	audiothread;
	int			threadid;
	int			audio_fd;
	snd_pcm_t 	*alsaaudio_fd;
	int			playing;
	int			fragsize,fragcount;
	int			buffersize;	//in bytes
	short		*buffer;
	
	int reset()
	{
		playing=0;
		mix=new mixer(LINUXFRAG);
		mix-&gt;freq=44100;
		mix-&gt;channels=2;
		buffer=new short[LINUXFRAG];
		buffersize=LINUXFRAG*2;
		pthread_attr_t	attr;
		pthread_attr_init(&amp;attr);
		threadid=pthread_create(&amp;audiothread,&amp;attr,mixerthread,(void*)this);	
		return 0;
	}
	
	int close()
	{	
		int		timeout;
		playing=0;
		timeout=5;
		while (timeout-- &amp;&amp; audio_fd) sleep(1);
		return 0;
	}
};

audiodevice *OpenSystemAudio()
{
	return new linuxaudio();
}

void initAudioALSA(linuxaudio *dev)
{
	if (snd_pcm_open(&amp;dev-&gt;alsaaudio_fd, strdup("default"), SND_PCM_STREAM_PLAYBACK, 0)==-1) 	//uses default audio device..
	{
	dev-&gt;alsaaudio_fd=0;
	}
}

void initAudioOSS(linuxaudio *dev)
{
	dev-&gt;audio_fd=open("/dev/dsp",O_WRONLY,0);		//|O_NONBLOCK
	if (dev-&gt;audio_fd==-1)
	{
	dev-&gt;audio_fd=0;
	}
}

void *playAudioOSS(linuxaudio *dev)
{
	int				data,res;

 		data=0x03000c;		//2 fragments of 4096 samples
		res=ioctl(dev-&gt;audio_fd,SNDCTL_DSP_SETFRAGMENT,&amp;data);		
		data=AFMT_S16_LE;
		res=ioctl(dev-&gt;audio_fd,SNDCTL_DSP_SETFMT,&amp;data);
		data=2;
		res=ioctl(dev-&gt;audio_fd,SNDCTL_DSP_CHANNELS,&amp;data);		
		data=44100;
		res=ioctl(dev-&gt;audio_fd,SNDCTL_DSP_SPEED,&amp;data);
		
		dev-&gt;playing=1;
		while (dev-&gt;playing)
		{
			dev-&gt;mix-&gt;mix16(dev-&gt;buffer);
			int n=write(dev-&gt;audio_fd,dev-&gt;buffer,dev-&gt;buffersize);
		}
		
		close(dev-&gt;audio_fd);
}

void *playAudioALSA(linuxaudio *dev)
{
	unsigned int val;
	snd_pcm_uframes_t periodsize;
	snd_pcm_hw_params_t *hwparams;
	snd_pcm_hw_params_alloca(&amp;hwparams);
	int output_rate;
	int channels;
	int fragment_size;
	int fragment_count;
	fragment_size=LINUXFRAG;  //overall buffer size
	fragment_count=2; //2 - 16 fragment count - 2 minimum, the lower it is potentially the lower the latency

	//configure device
		if (snd_pcm_hw_params_any(dev-&gt;alsaaudio_fd, hwparams) &lt; 0) {
			//printf("linuxaudio failed at params any\n");
			return 0;
		}	
		if (snd_pcm_hw_params_set_access(dev-&gt;alsaaudio_fd, hwparams,SND_PCM_ACCESS_RW_INTERLEAVED) &lt; 0) {
			//printf("linuxaudio failed at set access\n");
			return 0;
		}	
		
		if (snd_pcm_hw_params_set_format(dev-&gt;alsaaudio_fd, hwparams,SND_PCM_FORMAT_S16_LE) &lt; 0) {
			//printf("linuxaudio failed at set format\n");
			return 0;
		}
		val = 44100;
		if (snd_pcm_hw_params_set_rate_near(dev-&gt;alsaaudio_fd, hwparams,&amp;val, 0) &lt; 0) {
			/* Try 48KHZ too */
			//printf("linuxaudio - %d HZ not available, trying 48000HZ\n", output_rate);
			val = 48000;
			if (snd_pcm_hw_params_set_rate_near(dev-&gt;alsaaudio_fd, hwparams,&amp;val, 0) &lt; 0) {
				//printf("linuxaudio failed at setting output rate (%d)\n", output_rate);
				return 0;
			}
			dev-&gt;mix-&gt;freq=val;		
		}
		channels=2;
		if (snd_pcm_hw_params_set_channels(dev-&gt;alsaaudio_fd, hwparams, channels) &lt; 0) {
			//printf("linuxaudio failed at set channels (%d)\n", channels);
			return 0;
		}
		periodsize = (fragment_size) / 4; // bytes -&gt; frames for 16-bit,stereo - should be a minimum of 512
		if (snd_pcm_hw_params_set_period_size_near(dev-&gt;alsaaudio_fd, hwparams,&amp;periodsize, 0) &lt; 0) {
			//printf("linuxaudio failed at set period size (%d)\n", (int)periodsize);			
			return 0;
		}
		val = fragment_count;
		if (snd_pcm_hw_params_set_periods_near(dev-&gt;alsaaudio_fd, hwparams,&amp;val, 0) &lt; 0) {
			//printf("linuxaudio failed at set periods (%d)\n", val);			
			//should attempt a one by one period increase up to 16?
			return 0;
		}
		if (snd_pcm_hw_params(dev-&gt;alsaaudio_fd, hwparams) &lt; 0) {
			//printf("linuxaudio failed at installing hw params\n");
			return 0;
		}
		//loop while playing sound
		dev-&gt;playing=1;
		while (dev-&gt;playing)
		{
			dev-&gt;mix-&gt;mix16(dev-&gt;buffer);
			if ((snd_pcm_writei (dev-&gt;alsaaudio_fd, dev-&gt;buffer,LINUXFRAG/2)) &lt; 0) {	//Half buffer for two channels?
				//printf ("linuxaudio warning: buffer underrun occurred\n");
				if (snd_pcm_prepare(dev-&gt;alsaaudio_fd) &lt; 0) {
					//printf ("linuxaudio failed at preparing pcm\n");
					dev-&gt;playing=0; //die gracefully
				}
			}	
		}
		snd_pcm_drop(dev-&gt;alsaaudio_fd);
		snd_pcm_close (dev-&gt;alsaaudio_fd);
		dev-&gt;alsaaudio_fd=0; 
}

void *mixerthread(void *v)
{
	sched_param		sched;	
	linuxaudio 		*dev;
	int				policy;
	bool		usealsa;
	usealsa=1;
	pthread_getschedparam(pthread_self(),&amp;policy,&amp;sched);
	sched.sched_priority++;//policy=SCHED_RR;
	pthread_setschedparam(pthread_self(),policy,&amp;sched);
	
	dev=(linuxaudio*)v;
	//try alsa
	initAudioALSA(dev);
	if (dev-&gt;alsaaudio_fd==0) 	//uses default audio device..
	{
		//try OSS
		initAudioOSS(dev);
		if (dev-&gt;audio_fd==0)
		{
			printf("linuxaudio failed\n");
			return 0;
		}
		usealsa=0;				
	}		
	if (usealsa=1) {
	playAudioALSA(dev);
	}
	else {
	playAudioOSS(dev);
	}
	dev-&gt;audio_fd=0;
	return 0;
}

#endif
</pre><br>I've tried to separate OSS and ALSA functionality.  The system will try ALSA then fallback to OSS, and if that fails too, fail completely.  The way it is structured it should be relatively easy to add new sound system support.<br><br>I should point out this is the first time I've really tried to program anything in C in about six years.  Please feel free to offer any improvements.  The code I added is completely public domain. <br><br></td></tr></table><br>
<a name="560709"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >skidracer</td><td align="right"><font class=tiny>(Posted 2005)</font>&nbsp;<a href="#13">[#13]</a></td></tr></table></td></tr><tr ><td class="posttext"> Great stuff Craig, will test shortly. <br><br></td></tr></table><br>
<a name="bottom"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td align="right"><a href="http://monkeycoder.co.nz" target="_blank"><img src="/img/monkey2.svg" ></a> <a href="https://github.com/blitz-research" target="_blank"><img src="/img/github.svg" ></a> <a href="https://discord.gg/qJccbSp" target="_blank"><img src="/img/discord.svg" ></a></td></tr></table><br></div><br><table width="100%"><tr><td></body></html lang="en">
