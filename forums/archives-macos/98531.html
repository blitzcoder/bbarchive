<!DOCTYPE html><html lang="en" ><head ><title >TProcess</title><meta name='viewport' content='width=device-width, initial-scale=0.66'><meta name='description' content='language:basic, target:desktop, category:game development'><link rel="styleSheet" href="../skins/granite/style.css" type="text/css"><style type="text/css">div.bbcode {padding: 8px;background: #E5E5E5;color: #000000;border: 1px dashed #B4B4BE;}</style></head><body ><table width=100% cellspacing=0 cellpadding=0><tr ><td class="menubarleft"></td><td class="menubar"><table cellspacing="0" cellpadding="0"><tr ><td >&nbsp;</td><td class="menuitemleft"></td><td class="menuitem"><a href="/" class="menuitem">News</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/forums.php" class="menuitem">Forums</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/codearcs.php" class="menuitem">Code</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/logs.php" class="menuitem">Logs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/gallery.php" class="menuitem">Gallery</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/sdkspecs.php" class="menuitem">Specs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/search.php" class="menuitem">Search</a></td><td class="menuitemright"></td></tr></table></td><td class="menubarright"></td></tr></table><div class="main"><h1 >TProcess</h1><a href="forums.php" >Archives Forums</a>/<a href="topics.php?forum=107" >MacOS X Discussion</a>/<a href="#bottom" >TProcess</a><br><br>
<a name="1151700"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >MacSven</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#1">[#1]</a></td></tr></table></td></tr><tr ><td class="posttext"> TProcess makes me freaky under MacOS X<br><br>if i use the TProcess with this it should not work:<br><br>temp_proc:tproc = CreateProc("./avrdude -q -patmega1284p -cusbasp -Uflash:w:"+chr$(34)+"/Volumes/MacOS X/Applications/BlitzMax/SourceFiles/CocoaExt/LunaAVR Test/Examples/BitAccess.hex"+chr$(34)+":a",1)<br><br>This is the error:<br><br>avrdude: AVR device initialized and ready to accept instructions<br>avrdude: Device signature = 0x1e9705<br>avrdude: NOTE: FLASH memory has been specified, an erase cycle will be performed<br>         To disable this feature, specify the -D option.<br>avrdude: erasing chip<br>avrdude: reading input file ""/Volumes/MacOS"<br>avrdude: error opening "/Volumes/MacOS: No such file or directory<br>avrdude: input file "/Volumes/MacOS auto detected as invalid format<br>avrdude: can't open input file "/Volumes/MacOS: No such file or directory<br>avrdude: write to file '"/Volumes/MacOS' failed<br><br>It is a problem with spaces in the filename. If i use the same command in the Terminal.app it works fine: <br><br>localhost:LunaAVR Test Sven$ avrdude -q -patmega1284p -cusbasp -Uflash:w:"/Volumes/MacOS X/Applications/BlitzMax/SourceFiles/CocoaExt/LunaAVR Test/Examples/BitAccess.hex":a<br><br>avrdude: AVR device initialized and ready to accept instructions<br>avrdude: Device signature = 0x1e9705<br>avrdude: NOTE: FLASH memory has been specified, an erase cycle will be performed<br>         To disable this feature, specify the -D option.<br>avrdude: erasing chip<br>avrdude: reading input file "/Volumes/MacOS X/Applications/BlitzMax/SourceFiles/CocoaExt/LunaAVR Test/Examples/BitAccess.hex"<br>avrdude: input file /Volumes/MacOS X/Applications/BlitzMax/SourceFiles/CocoaExt/LunaAVR Test/Examples/BitAccess.hex auto detected as Intel Hex<br>avrdude: writing flash (2624 bytes):<br>avrdude: 2624 bytes of flash written<br>avrdude: verifying flash memory against /Volumes/MacOS X/Applications/BlitzMax/SourceFiles/CocoaExt/LunaAVR Test/Examples/BitAccess.hex:<br>avrdude: load data flash data from input file /Volumes/MacOS X/Applications/BlitzMax/SourceFiles/CocoaExt/LunaAVR Test/Examples/BitAccess.hex:<br>avrdude: input file /Volumes/MacOS X/Applications/BlitzMax/SourceFiles/CocoaExt/LunaAVR Test/Examples/BitAccess.hex auto detected as Intel Hex<br>avrdude: input file /Volumes/MacOS X/Applications/BlitzMax/SourceFiles/CocoaExt/LunaAVR Test/Examples/BitAccess.hex contains 2624 bytes<br>avrdude: reading on-chip flash data:<br>avrdude: verifying ...<br>avrdude: 2624 bytes of flash verified<br><br>Are the TProcess and the Terminal Command different! <br><br></td></tr></table><br>
<a name="1151776"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >skidracer</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#2">[#2]</a></td></tr></table></td></tr><tr ><td class="posttext"> Yes, CreateProcess will have problems with quotes used inside arguments. You will need to modify the makeargv code in freeprocess.c to get the above to work. <br><br></td></tr></table><br>
<a name="1152253"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >MacSven</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#3">[#3]</a></td></tr></table></td></tr><tr ><td class="posttext"> Ok,<br><br>But how, my c-programing is not so good as i realy want! <br><br></td></tr></table><br>
<a name="1152276"></a>

<a name="1152284"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Yasha</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#4">[#4]</a></td></tr></table></td></tr><tr ><td class="posttext"> I've made no attempt at all to test this (written on a Windows box, ha!), but here's my off-the-top-of-my-head suggested change:<br><br><b>freeprocess.c</b><br><textarea class=codebox name="code" wrap=OFF readonly="true" rows="15" cols="80">// freeprocess.c

#include &lt;brl.mod/blitz.mod/blitz.h&gt;

#include &lt;stdio.h&gt;
#include &lt;stdbool.h&gt;

#define HIDECONSOLE 1

#if __APPLE__ || __linux

#include &lt;sys/ioctl.h&gt;
#include &lt;unistd.h&gt;
#include &lt;sys/wait.h&gt;

int fdClose(int fd) {return close(fd);}
int fdRead(int fd,char *buffer,int count) {return read(fd,buffer,count);}
int fdWrite(int fd,char *buffer,int count) {return write(fd,buffer,count);}
int fdAvail(int fd) {int avail;if (ioctl(fd,FIONREAD,&amp;avail)) avail=avail;return avail;}
int fdFlush(int fd) {}//flush(fd);}

///return 1 for running, 0 for finished
//
int fdProcessStatus( int pid ){

	int status=0;
	return !waitpid( pid,&amp;status,WNOHANG );
}

//returns 0 for success, -1 for error
//
int fdTerminateProcess(int pid){

	if( !killpg( pid,SIGTERM ) ){
		int status=0;
		waitpid( pid,&amp;status,0 );
		return 0;
	}
	return -1;
}

static char **makeargv( const char *cmd ){
	int n;//,c;
	char *p;
	static char *args,**argv;
	
	if( args ) free( args );
	if( argv ) free( argv );
	
	int cmdlen = strlen(cmd);
	args = /*(char*)*/ malloc( cmdlen+1 );
	strcpy( args,cmd );
	
	char * temp_argv[cmdlen / 2]; // Max poss no. args if all 1 char
	
	n=0;
	p=args;
	while(*p) {
		int skipQ = 0;
		if( *p != ' ' ) {
			temp_argv[n] = p;
			bool inQ = false, esc = false;
			while (*p) {
				if (esc == false &amp;&amp; (*p == '\'' || *p == '\"')) {
					inQ = !inQ; skipQ ++;
				} else {
					if (*p == '\\') {
						esc = !esc; 
					} else {
						if (esc == false &amp;&amp; inQ == false &amp;&amp; *p == ' ') { break; }
						esc = false;
					}
					if (skipQ) { p[- skipQ] = *p; }
				}
				p ++;
			}
			++n;
		}
		if (p[- skipQ]) { p[- skipQ] = 0; ++p; }
	}
	
	argv=/*(char**)*/malloc( (n+1)/* *sizeof(char*)*/ );
	
	int a;
	for (a = 0; a &lt; n; a ++) {
		argv[a] = temp_argv[a];
	}
	argv[n] = NULL;
	
	return argv;
}

#define PIPEREAD 0
#define PIPEWRITE 1

static int in[2],out[2],errfd[2];

int fdProcess( BBString *bbcmd,int *procin,int *procout,int *procerr,int flags)
{
	char 	*const*argv;
	int   	procid;
	
	const char *cmd=bbTmpUTF8String(bbcmd);
	
	//Set-up interprocess communication
	if (pipe(in)) return 0;
  	if (pipe(out)) return 0;
  	if (pipe(errfd)) return 0;
	
	//Fork process (returned value used to distinguish between child and parent process)
	procid=vfork();	//vfork() avoids memory overhead of fork()
	
	//Child process
	if (procid==0)
	{
		#if __linux
			setsid(); //Linux doesn't mind setsid()
		#else
			setpgid(0,0);	//but OS X doesn't like it, therefore resort to using setpgid().
		#endif
		
		dup2(out[PIPEREAD],STDIN_FILENO);
		close(out[PIPEWRITE]);
		
		dup2(in[PIPEWRITE],STDOUT_FILENO);
		close(in[PIPEREAD]);
		
		dup2(errfd[PIPEWRITE],STDERR_FILENO);		
		close(errfd[PIPEREAD]);
		
		argv=makeargv(cmd);
		execvp(argv[0],argv);
		
		_exit( -1 );
		
		return 0;	//Supposedly, we need this for some compilers.
		
	}
	
	//Parent process
	
	if(procid==-1) return 0;	//Return if child process couldn't be started.
	
	close(out[PIPEREAD]);		//Close the end of the pipes in that the child
	close(in[PIPEWRITE]);		//process is using.
	close(errfd[PIPEWRITE]);
	
	*procin=in[PIPEREAD];		//And return the end of the pipes that we should
	*procout=out[PIPEWRITE];	//be using.
	*procerr=errfd[PIPEREAD];
	
	return procid;
}

#endif

#ifdef _WIN32

extern int _bbusew;

#define WIN32_LEAN_AND_MEAN
#include &lt;windows.h&gt;
#include &lt;tlhelp32.h&gt;

int TerminateProcessGroup(HANDLE prochandle,int procid)
{
	HANDLE snapshot,child;
	PROCESSENTRY32 procinfo;
	int gotinfo,res;

	snapshot=CreateToolhelp32Snapshot(TH32CS_SNAPPROCESS,0);
	if (snapshot!=INVALID_HANDLE_VALUE)
	{
		procinfo.dwSize=sizeof(procinfo);
		gotinfo=Process32First(snapshot,&amp;procinfo);
		while (gotinfo)
		{
			if (procinfo.th32ParentProcessID==procid)
			{
//				printf("process=%x parent=%x module=%x path=%s\n",procinfo.th32ProcessID,procinfo.th32ParentProcessID,procinfo.th32ModuleID,procinfo.szExeFile);
				child=OpenProcess(PROCESS_ALL_ACCESS,0,procinfo.th32ProcessID);
				if (child)
				{
					res=TerminateProcess(child,-1);
					CloseHandle(child);
				}
			}
			gotinfo=Process32Next(snapshot,&amp;procinfo);
		}
		CloseHandle(snapshot);
	}
	res=TerminateProcess(prochandle,-1);
	return res;
}

int fdClose(int fd)
{
	return CloseHandle((HANDLE)fd);
}

int fdRead(int fd,char *buffer,int bytes)
{
	int		res; 
	long	count;
	res=ReadFile((HANDLE)fd,buffer,bytes,&amp;count,0);
	if (res) return count;
	return 0;
}

int fdWrite(int fd,char *buffer,int bytes)
{
	int		res;
	long	count;
	res=WriteFile((HANDLE)fd,buffer,bytes,&amp;count,0);
	if (res) return count;
	return 0;
}

int fdFlush(int fd)
{
	int		res;
	res=FlushFileBuffers((HANDLE)fd);
	return res;
}

int fdAvail(int fd) 
{
	int		res;
	long	avail;
	res=PeekNamedPipe((HANDLE)fd,0,0,0,&amp;avail,0);
	if (res) return avail;
	return 0;
}

//returns 1 for running, 0 for finished
int fdProcessStatus( int pid ){

	PROCESS_INFORMATION *pi=(PROCESS_INFORMATION *)pid;
	
	long exitcode;
	
	if( GetExitCodeProcess( pi-&gt;hProcess,&amp;exitcode ) ){

		if( exitcode==STILL_ACTIVE ) return 1;
		
		CloseHandle( pi-&gt;hProcess );
		free( pi );
	}
	return 0;
}

//returns 0 for success
int fdTerminateProcess( int pid ){

	PROCESS_INFORMATION *pi=(PROCESS_INFORMATION *)pid;
	
	int res=TerminateProcessGroup( pi-&gt;hProcess,pi-&gt;dwProcessId );
	
	CloseHandle( pi-&gt;hProcess );
	free( pi );

	return res;
}

int fdProcess( BBString *cmd,int *procin,int *procout,int *procerr,int flags)
{
	int res;
	int pflags=CREATE_NEW_PROCESS_GROUP;
	PROCESS_INFORMATION *pi;
	SECURITY_ATTRIBUTES sa={sizeof(sa),0,1};
	HANDLE istr,p_ostr;	//our in-stream, process out-stream
	HANDLE ostr,p_istr;	//our out-stream, process in-stream
	HANDLE estr,p_estr;			//our errin-stream, process errout-stream

	if( !CreatePipe( &amp;istr,&amp;p_ostr,&amp;sa,0 ) ){
		//unable to create pipe
		return 0;
	}

	if( !CreatePipe( &amp;p_istr,&amp;ostr,&amp;sa,0 ) ){
		CloseHandle( istr );
		CloseHandle( p_ostr );
		//ditto
		return 0;
	}

	if (!CreatePipe(&amp;estr,&amp;p_estr,&amp;sa,0)) {
		CloseHandle( istr );
		CloseHandle( p_ostr );
		CloseHandle( ostr );
		CloseHandle( p_istr );
		//unable to create pipe
		return 0;
	}

	pi=(PROCESS_INFORMATION*)calloc(1,sizeof(PROCESS_INFORMATION));
	
	if( _bbusew ){
		STARTUPINFOW si={sizeof(si)};

		si.dwFlags=STARTF_USESTDHANDLES;
		si.wShowWindow=SW_HIDE;
		si.hStdInput=p_istr;
		si.hStdOutput=p_ostr;
		si.hStdError=p_estr;
		if (flags&amp;HIDECONSOLE) {
			si.dwFlags|=STARTF_USESHOWWINDOW;
			si.wShowWindow=SW_HIDE;
		}
		else {
			pflags|=DETACHED_PROCESS;
		}
		res=CreateProcessW( 0,bbTmpWString(cmd),0,0,-1,pflags,0,0,&amp;si,pi );
	}else{
		STARTUPINFO si={sizeof(si)};

		si.dwFlags=STARTF_USESTDHANDLES;
		si.wShowWindow=SW_HIDE;
		si.hStdInput=p_istr;
		si.hStdOutput=p_ostr;
		si.hStdError=p_estr;
		if (flags&amp;HIDECONSOLE) {
			si.dwFlags|=STARTF_USESHOWWINDOW;
			si.wShowWindow=SW_HIDE;
		}
		else {
			pflags|=DETACHED_PROCESS;
		}
		res=CreateProcess( 0,bbTmpCString(cmd),0,0,-1,pflags,0,0,&amp;si,pi );
	}
	
	if( !res ){
		CloseHandle( istr );
		CloseHandle( ostr );
		CloseHandle( estr );
		CloseHandle( p_istr );
		CloseHandle( p_ostr );
		CloseHandle( p_estr );
		return 0;
	}
	
	CloseHandle( pi-&gt;hThread );
	
	*procin=(int)istr;
	*procout=(int)ostr;
	*procerr=(int)estr;

	CloseHandle( p_istr );
	CloseHandle( p_ostr );
	CloseHandle( p_estr );
	
	return (int)pi;
}

#endif
</textarea><br><br>Changes are really just to makeargv, but it needs an extra #include so I pasted the whole thing.<br><br>In theory it should allow backslash escaped spaces and quotes, doublequoted and singlequoted substrings in arguments, and strip out the quotes before passing on the arg vector as expected by a command line. Makes no attempt to actually do backslash substitution though.<br><br>As warned above, I have not even tested to see if this so much as compiles correctly. Use at own risk.<br><br><font class="tiny">Last edited 2012</font> <br><br></td></tr></table><br>
<a name="1152280"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >MacSven</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#5">[#5]</a></td></tr></table></td></tr><tr ><td class="posttext"> Hi Yasha,<br><br>Replaces the code and try to build, i get this error:<br><br>/Applications/BlitzMax/mod/pub.mod/freeprocess.mod/freeprocess.c:84: error: 'for' loop initial declaration used outside C99 mode<br><br>The GCC Compiler does not supported the C99 mode. Any other idea? <br><br></td></tr></table><br>
<a name="1152283"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >MacSven</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#6">[#6]</a></td></tr></table></td></tr><tr ><td class="posttext"> Problem Solved:<br> Use this in you code it works fine on macos x<br><pre class=code>
	argv=/*(char**)*/malloc( (n+1)/* *sizeof(char*)*/ );
	int a;
	for (a = 0; a &lt; n; a ++) {
		argv[a] = temp_argv[a];
	}
	argv[n] = NULL;


</pre><br><br>Thanx you saved my life! <br><br></td></tr></table><br>
<a name="1152286"></a>

<a name="1152288"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Yasha</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#7">[#7]</a></td></tr></table></td></tr><tr ><td class="posttext"> Ha, I was just pasting that change into the above codebox at the same time you were finding it.<br><br>It's odd, that code uses three or four much more interesting C99 features and it chooses to complain about <i>that</i>? For instance, technically I think your solution is actually a C99 feature as well (ANSI C required all variables to be defined at the top of the function!).<br><br>(In general, you can tell GCC to shut up with --std=c99 or even --std=c11, but in this case you'd need to modify the BlitzMax build process to make that change.)<br><br><font class="tiny">Last edited 2012</font> <br><br></td></tr></table><br>
<a name="bottom"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td align="right"><a href="http://monkeycoder.co.nz" target="_blank"><img src="/img/monkey2.svg" ></a> <a href="https://github.com/blitz-research" target="_blank"><img src="/img/github.svg" ></a> <a href="https://discord.gg/qJccbSp" target="_blank"><img src="/img/discord.svg" ></a></td></tr></table><br></div><br><table width="100%"><tr><td></body></html lang="en">
