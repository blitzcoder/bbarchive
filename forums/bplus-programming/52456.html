<!DOCTYPE html><html lang="en" ><head ><title >Quicker GrabImage?</title><meta name='viewport' content='width=device-width, initial-scale=0.66'><meta name='description' content='language:basic, target:desktop, category:game development'><link rel="styleSheet" href="../skins/granite/style.css" type="text/css"><style type="text/css">div.bbcode {padding: 8px;background: #E5E5E5;color: #000000;border: 1px dashed #B4B4BE;}</style></head><body ><table width=100% cellspacing=0 cellpadding=0><tr ><td class="menubarleft"></td><td class="menubar"><table cellspacing="0" cellpadding="0"><tr ><td >&nbsp;</td><td class="menuitemleft"></td><td class="menuitem"><a href="/" class="menuitem">News</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/forums.php" class="menuitem">Forums</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/codearcs.php" class="menuitem">Code</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/logs.php" class="menuitem">Logs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/gallery.php" class="menuitem">Gallery</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/sdkspecs.php" class="menuitem">Specs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/search.php" class="menuitem">Search</a></td><td class="menuitemright"></td></tr></table></td><td class="menubarright"></td></tr></table><div class="main"><h1 >Quicker GrabImage?</h1><a href="forums.php" >BlitzPlus Forums</a>/<a href="topics.php?forum=81" >BlitzPlus Programming</a>/<a href="#bottom" >Quicker GrabImage?</a><br><br>
<a name="585546"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Grey Alien</td><td align="right"><font class=tiny>(Posted 2005)</font>&nbsp;<a href="#1">[#1]</a></td></tr></table></td></tr><tr ><td class="posttext"> This is slow:<br><pre class=code>
w=800
h=640
Graphics w,h,32,2

stT = MilliSecs()
grab = CreateImage(w, h, 1, 1)
GrabImage(grab, 0, 0)
EndT = MilliSecs() - stT
Text 0,0,EndT + "ms"
Flip
WaitKey
</pre><br>200ms on my 3.2GHz P4, ATI 9800XT, 1Gb RAM.<br>If I change the last parameter of CreateImage to 2, it's 0ms.  This is because the image held is on the videocard not in memory and thus it can be destroyed by Alt+Tabbing so this is not useful.<br><br>Can anyone thing of a quicker way to grab the backbuffer into a managed image? Btw I've tried locking it and reading the pixels with ReadPixelFast in a loop, but it's amost exactly the same speed!<br><br>I also tried this:<br><pre class=code>
w=800
h=640
Graphics w,h,32,2

stT = MilliSecs()
grab = CreateImage(w, h, 1, 2)
second = CreateImage(w, h, 1, 1)
GrabImage(grab, 0, 0)
second = CopyImage(grab)
EndT = MilliSecs() - stT
Text 0,0,EndT + "ms"
Flip
WaitKey
</pre><br>Wondering if I could fool it.  Notice the first image is dynamic and the second image is managed.  This appears to give a very fast time. Wooo I thought until I alt+tabbed and discovered that the second image is now dyanmic too.  Basically Copy image ignores the original flag state of the image (1) and actually copies the image in video memory (flag=2).  This is practically a bug!  What if you wanted to make a managed image in memory from an image grabbed in video RAM?  You'd have to read each pixel out and copy it "manually", lame.<br><br>Thanks in advance. <br><br></td></tr></table><br>
<a name="585552"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >TartanTangerine (was Indiepath)</td><td align="right"><font class=tiny>(Posted 2005)</font>&nbsp;<a href="#2">[#2]</a></td></tr></table></td></tr><tr ><td class="posttext"> Grabbing data from the backbuffer is always going to be a slow process. My suggestion would be to use a third buffer, one that resides in system ram. You draw all images to that 3rd buffer, calculate all your alpha and stuff and then send the complete buffer to the video card just before the flip. <br><br></td></tr></table><br>
<a name="585557"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Grey Alien</td><td align="right"><font class=tiny>(Posted 2005)</font>&nbsp;<a href="#3">[#3]</a></td></tr></table></td></tr><tr ><td class="posttext"> That's triple buffering isn't it?  Thanks for the idea.  Could try that but it means a fair bit or rewriting (maybe).  However, it will make alpha stuff much faster where the background has to be read in.  Hmm, I wonder how much faster! <br><br></td></tr></table><br>
<a name="585570"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >TartanTangerine (was Indiepath)</td><td align="right"><font class=tiny>(Posted 2005)</font>&nbsp;<a href="#4">[#4]</a></td></tr></table></td></tr><tr ><td class="posttext"> Loads faster! You should never read from the backbuffer (if the back buffer is in VideoRam) - it's like trying to download a file over the internet via dialup. <br><br></td></tr></table><br>
<a name="585586"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Grey Alien</td><td align="right"><font class=tiny>(Posted 2005)</font>&nbsp;<a href="#5">[#5]</a></td></tr></table></td></tr><tr ><td class="posttext"> It stinks for sure! <br><br></td></tr></table><br>
<a name="585631"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Grey Alien</td><td align="right"><font class=tiny>(Posted 2005)</font>&nbsp;<a href="#6">[#6]</a></td></tr></table></td></tr><tr ><td class="posttext"> Well triple buffering has reduced my Dim Screen code from 230ms to 40ms which is great.  But it has increased my draw time from 0-1ms to 4-5ms which is not great as this occurs every frame and could easily push people down a notch in FPS (i.e. halve it).<br><br>It seems that calling DrawBlock and DrawImage onto the backbuffer is VERY fast but calling them onto an Image Buffer e.g. SetBuffer ImageBuffer(Buffer3) is a lot slower.  This is a shame.  Naturally buffer3 was created with flag 1 on the end so it's managed so it doesn't corrupt when you alt+tab.  If I change the flag to 2 (dynamic) the draw time per frame drops back to 0-1ms but the Dim Screen code goes back up to 230ms, it's like some kinda hideous see-saw! <br><br></td></tr></table><br>
<a name="585635"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >TartanTangerine (was Indiepath)</td><td align="right"><font class=tiny>(Posted 2005)</font>&nbsp;<a href="#7">[#7]</a></td></tr></table></td></tr><tr ><td class="posttext"> Did you lock the buffers before writing? Would it be faster just to copy the memory to the buffer rather than using Blitz command set?<br><br>OR <br><br>Back to the old dirty rects scenario. Only Draw to the image buffer what has changed since the last frame. Only send to the back buffer those changes. Voila super fast thingie stuff. <br><br></td></tr></table><br>
<a name="585662"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Grey Alien</td><td align="right"><font class=tiny>(Posted 2005)</font>&nbsp;<a href="#8">[#8]</a></td></tr></table></td></tr><tr ><td class="posttext"> Thanks for the ideas.<br><br>You can't lockbuffer on an image buffer and then call DrawBlock or DrawImage, it doesn't work, I tried it (also says so in the docs, unless you know differently?).  Only the ReadPixelFast and WritePixelFast functions work.<br><br>I wrote my own DrawBlock which locked the buffer and used the Fast commands but it was uh about 10 times slower.  It was only two for loops, one nested (x and y), oh well.  Not sure if the speed problem is the loop or the read/write pixelfast line.  Could test I suppose.<br><br>How can I copy the memory back to the buffer? Command?  I presume the image handle is a memory pointer (but it might be a pointer to a blitz internal object) but how do I get the memory address for the BackBuffer?<br><br>Perhaps I should just use a massive array and write all by own image draw routines that use the array and finally draw it onto the image buffer.  Probably after trying this, I'll find out it's slower.  However, this sort of thing was LOADS fast for calculating fades, and alpha blends, it's what I currently do.<br><br>I could go "back" to dirty rects, but that was how I did it in the Amiga days and I can't be arsed, sigh.  Also on some screens there'd still be a lot of updates like when all the fruit fly around.  But maybe ...  Does your systemtrack which bits have been updated them and store them in a list so it can process/output them later? <br><br></td></tr></table><br>
<a name="588021"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Ross C</td><td align="right"><font class=tiny>(Posted 2005)</font>&nbsp;<a href="#9">[#9]</a></td></tr></table></td></tr><tr ><td class="posttext"> Isn't CopyRect, alot faster than GrabImage? <br><br></td></tr></table><br>
<a name="bottom"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td align="right"><a href="http://monkeycoder.co.nz" target="_blank"><img src="/img/monkey2.svg" ></a> <a href="https://github.com/blitz-research" target="_blank"><img src="/img/github.svg" ></a> <a href="https://discord.gg/qJccbSp" target="_blank"><img src="/img/discord.svg" ></a></td></tr></table><br></div><br><table width="100%"><tr><td></body></html lang="en">
