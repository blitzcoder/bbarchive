<!DOCTYPE html><html lang="en" ><head ><title >Slow first DrawImage</title><meta name='viewport' content='width=device-width, initial-scale=0.66'><meta name='description' content='language:basic, target:desktop, category:game development'><link rel="styleSheet" href="../skins/granite/style.css" type="text/css"><style type="text/css">div.bbcode {padding: 8px;background: #E5E5E5;color: #000000;border: 1px dashed #B4B4BE;}</style></head><body ><table width=100% cellspacing=0 cellpadding=0><tr ><td class="menubarleft"></td><td class="menubar"><table cellspacing="0" cellpadding="0"><tr ><td >&nbsp;</td><td class="menuitemleft"></td><td class="menuitem"><a href="/" class="menuitem">News</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/forums.php" class="menuitem">Forums</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/codearcs.php" class="menuitem">Code</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/logs.php" class="menuitem">Logs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/gallery.php" class="menuitem">Gallery</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/sdkspecs.php" class="menuitem">Specs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/search.php" class="menuitem">Search</a></td><td class="menuitemright"></td></tr></table></td><td class="menubarright"></td></tr></table><div class="main"><h1 >Slow first DrawImage</h1><a href="forums.php" >BlitzPlus Forums</a>/<a href="topics.php?forum=81" >BlitzPlus Programming</a>/<a href="#bottom" >Slow first DrawImage</a><br><br>
<a name="517880"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Grey Alien</td><td align="right"><font class=tiny>(Posted 2005)</font>&nbsp;<a href="#1">[#1]</a></td></tr></table></td></tr><tr ><td class="posttext"> OK I have a game that loads in graphics into templates and then makes objects with graphics that point to the templates.  Also sometimes I use CreateImage with the all important 1 flag on the end!  I time all the game routines in millisecs and output them for debugging/optimisation.<br><br>I have noticed that on some video cards the first time a graphic is drawn (with DrawImage or DrawBlock) there is a spike in the amount of millisecs taken to draw it e.g. normally takes 1 ms but suddenly takes 10ms.  Then the second time the graphic is drawn, all is fine.  This happens with tiles, enemies, pickups, fonts, all different types etc but not everything, to be honest it is a bit inconsistant and is not noticeable on some machines.  I have tested it with sound off to make sure that was not the problem.<br><br>So I am asking how are loaded and created images stored in Blitz?  I know they are "managed" based on the flags but what manages them, Blitz or the video card?  Is there some kind of video caching going on?  The game uses hardly any resources and I have run it on good machines so I doubt very much it is using virtual memory and my code loads everything before the level is displayed.<br><br>Any ideas?  I know this is quite a techincal point but I was hoping someone knew.  I realise it could be some kind of bug on my part, but before going on a wild goose chase I was hoping someone else knew for sure ...<br><br>Many thanks in advance. <br><br></td></tr></table><br>
<a name="517998"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rck</td><td align="right"><font class=tiny>(Posted 2005)</font>&nbsp;<a href="#2">[#2]</a></td></tr></table></td></tr><tr ><td class="posttext"> I have had to deal with this on my most recent project. I made my own kind of mem management with freeing and loading tiles from disk for a game I'm working on.<br><br>From what I've seen and guessed,<br>Managed images go into program memory but do not take up actual video mem until they are used by DrawImage, etc.  Also, soon after, the images are removed from video mem if where they were drawn to a buffer which is then freed.  Another case to handle is when you have a lot of images loaded as managed.  If their size (say 1024 x 768 x 4bytes x number of the screen sized images) bytes is too much for your card, a slower memory is used and CPU will go up.<br><br>In summary, its not just enough to LoadImage managed, actually drawing them to a 1,1 image's imagebuffer, or to  the BackBuffer, etc. will "push" them into vid mem.  From then on, things should run smooth. <br><br></td></tr></table><br>
<a name="518025"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Grey Alien</td><td align="right"><font class=tiny>(Posted 2005)</font>&nbsp;<a href="#3">[#3]</a></td></tr></table></td></tr><tr ><td class="posttext"> Aha, so basically I should draw all my graphics to a hidden buffer when I init the level and then it should run faster, hopefully, unless the video card is really pap.  Thanks Rck, I was beginning to think I was going mad. <br><br></td></tr></table><br>
<a name="518064"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Grisu</td><td align="right"><font class=tiny>(Posted 2005)</font>&nbsp;<a href="#4">[#4]</a></td></tr></table></td></tr><tr ><td class="posttext"> It might also be an issue how you organised your freeing of unused stuff (types, images etc).<br><br>But without having a look at the code, hard to tell. <br><br></td></tr></table><br>
<a name="518109"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Grey Alien</td><td align="right"><font class=tiny>(Posted 2005)</font>&nbsp;<a href="#5">[#5]</a></td></tr></table></td></tr><tr ><td class="posttext"> I have been very careful to free everyhting correctly and have done tests to see if any resources are missing after the game has been run.  Also the slow drawing time only occurs the first time you play the game which is before anything is freed.  But thanx anyway. <br><br></td></tr></table><br>
<a name="518433"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rck</td><td align="right"><font class=tiny>(Posted 2005)</font>&nbsp;<a href="#6">[#6]</a></td></tr></table></td></tr><tr ><td class="posttext"> Use some code like this and run it in the background to see how the mem is loaded only once images are drawn after loadimage<br><br><textarea class=codebox name="code" wrap=OFF readonly="true" rows="15" cols="80">
;rck109d

AppTitle "Vid Mem Meter"

Print "Close window to end"
Print""
t = CreateTimer(1)

Print "Video memory used"

Repeat
	Print CurrentTime$() + ", " + ((TotalVidMem()-AvailVidMem())/1000000) + "/" + (TotalVidMem()/1000000) + " MB"
	WaitTimer(t)
Forever
</textarea> <br><br></td></tr></table><br>
<a name="518859"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Grey Alien</td><td align="right"><font class=tiny>(Posted 2005)</font>&nbsp;<a href="#7">[#7]</a></td></tr></table></td></tr><tr ><td class="posttext"> thanks rck, I'll give it a shot soon. <br><br></td></tr></table><br>
<a name="bottom"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td align="right"><a href="http://monkeycoder.co.nz" target="_blank"><img src="/img/monkey2.svg" ></a> <a href="https://github.com/blitz-research" target="_blank"><img src="/img/github.svg" ></a> <a href="https://discord.gg/qJccbSp" target="_blank"><img src="/img/discord.svg" ></a></td></tr></table><br></div><br><table width="100%"><tr><td></body></html lang="en">
