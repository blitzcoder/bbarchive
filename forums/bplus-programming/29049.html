<!DOCTYPE html><html lang="en" ><head ><title >CPU load, VWait</title><meta name='viewport' content='width=device-width, initial-scale=0.66'><meta name='description' content='language:basic, target:desktop, category:game development'><link rel="styleSheet" href="../skins/granite/style.css" type="text/css"><style type="text/css">div.bbcode {padding: 8px;background: #E5E5E5;color: #000000;border: 1px dashed #B4B4BE;}</style></head><body ><table width=100% cellspacing=0 cellpadding=0><tr ><td class="menubarleft"></td><td class="menubar"><table cellspacing="0" cellpadding="0"><tr ><td >&nbsp;</td><td class="menuitemleft"></td><td class="menuitem"><a href="/" class="menuitem">News</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/forums.php" class="menuitem">Forums</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/codearcs.php" class="menuitem">Code</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/logs.php" class="menuitem">Logs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/gallery.php" class="menuitem">Gallery</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/sdkspecs.php" class="menuitem">Specs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/search.php" class="menuitem">Search</a></td><td class="menuitemright"></td></tr></table></td><td class="menubarright"></td></tr></table><div class="main"><h1 >CPU load, VWait</h1><a href="forums.php" >BlitzPlus Forums</a>/<a href="topics.php?forum=81" >BlitzPlus Programming</a>/<a href="#bottom" >CPU load, VWait</a><br><br>
<a name="306607"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >DrMartin</td><td align="right"><font class=tiny>(Posted 2004)</font>&nbsp;<a href="#1">[#1]</a></td></tr></table></td></tr><tr ><td class="posttext"> In a game I'm working on I have a pretty "normal" setup, with a main loop that calls a draw() function at the bottom. The game uses delta timing, and can run as fast as it likes without messing up the game timing.<br>The problem is that this loads the CPU a lot, and that's bad if you are running something in the background or have a laptop and don't want to drain the battery.<br>There is an option in the game to wait for the monitor, this adds a simple VWait before the draw() function is called. I thought using this would also prevent the game from using up all CPU, but I was wrong. If I use a VWait the CPU load goes up to almost 100%. If I add a timer it still goes up that high. But if I keep the timer and remove the VWait, it does NOT go up! FPS is stable at 75 at all times, but if I add the VWait the CPU load goes up to 100%. What is this?? Has anybody run into this problem?<br><br>--<br>Martin Gunnarsson <br><br></td></tr></table><br>
<a name="306679"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Warren</td><td align="right"><font class=tiny>(Posted 2004)</font>&nbsp;<a href="#2">[#2]</a></td></tr></table></td></tr><tr ><td class="posttext"> If you throw in a "Delay(10)" after your vwait/flip commands it'll force your game to give up the rest of its time slice each frame, and it'll use vastly less processor. <br><br></td></tr></table><br>
<a name="306686"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >DrMartin</td><td align="right"><font class=tiny>(Posted 2004)</font>&nbsp;<a href="#3">[#3]</a></td></tr></table></td></tr><tr ><td class="posttext"> But that will make the game run even slower on older systems where it probably is slow already. <br><br></td></tr></table><br>
<a name="306748"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Warren</td><td align="right"><font class=tiny>(Posted 2004)</font>&nbsp;<a href="#4">[#4]</a></td></tr></table></td></tr><tr ><td class="posttext"> Do you want to use 100% processor or not?  If you don't, you're going to have to give up your time slice of the processor. <br><br></td></tr></table><br>
<a name="306770"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Hansie</td><td align="right"><font class=tiny>(Posted 2004)</font>&nbsp;<a href="#5">[#5]</a></td></tr></table></td></tr><tr ><td class="posttext"> @all<br><br>For the best flickerfree performance use:<br><br><pre class=code>
		VWait
		Flip False
</pre> <br><br></td></tr></table><br>
<a name="306818"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >DrMartin</td><td align="right"><font class=tiny>(Posted 2004)</font>&nbsp;<a href="#6">[#6]</a></td></tr></table></td></tr><tr ><td class="posttext"> EpicBoy: I want to use 100% CPU on system that requires that to run the game smoothly, but not on ALL systems.<br><br>Hansie: I already use that, and it's completely flicker free, that's not the problem. Thanks for the tip though. <br><br></td></tr></table><br>
<a name="306887"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >MSW</td><td align="right"><font class=tiny>(Posted 2004)</font>&nbsp;<a href="#7">[#7]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> <br>I want to use 100% CPU on system that requires that to run the game smoothly, but not on ALL systems. <br> <br></div><br><br>You see that is the problem because:<br><br><div class="quote"> <br>The game uses delta timing, and can run as fast as it likes without messing up the game timing. <br> <br></div><br><br>You are going to have to decide on an acceptable frame rate...maybe when the game first starts up grab the millsec, then enter a loop to count out say 100 VWaits...see how long that took so you have some idea of what the users refresh rate is and calculate the target FPS... then as the game is running keep an internal FPS counter and every few seconds or so check if it's greater then the calculated target FPS rate...if it's over then start heavily useing the Delay 10, giveing up OS timeslices to other apps...if the FPS is lower fire up the delta time, frameskip routines, all that stuff...<br><br>If you want to use 100% CPU on system that *requires* that to run the game smoothly, but not on ALL systems....then you are going to have to qualify what those requirements are. <br><br></td></tr></table><br>
<a name="306935"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >skn3</td><td align="right"><font class=tiny>(Posted 2004)</font>&nbsp;<a href="#8">[#8]</a></td></tr></table></td></tr><tr ><td class="posttext"> Try something like this<br><br>Btw this part defines your Fps<br>FrameMs = 1000 / 60<br>This would be 60 frames a sec<br><br><pre class=code>
Graphics 320,240,32,2

FrameMs = 1000 / 60

SetBuffer BackBuffer()
Repeat
	ClsColor MilliSecs(),0,0
	Cls
	start_time = MilliSecs()
	;do your stuff here
	Flip
	end_time   = MilliSecs()
	
	delay_time = FrameMs - (end_time - start_time)
	If delay_time &gt; 0 Delay delay_time
Forever
</pre> <br><br></td></tr></table><br>
<a name="306978"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Zster</td><td align="right"><font class=tiny>(Posted 2004)</font>&nbsp;<a href="#9">[#9]</a></td></tr></table></td></tr><tr ><td class="posttext"> Use waitevent() and a timer (which can be caught as event $4001). When the program hits waitevent() it'll stop hogging the cpu and wait for an event (a timer in this case). One the event takes place the program can do all it calculating and rendering and then take a breather when it hits the next waitevent(). Waitevent() doesn't just have to be used when programming apps. <br><br></td></tr></table><br>
<a name="307000"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >DrMartin</td><td align="right"><font class=tiny>(Posted 2004)</font>&nbsp;<a href="#10">[#10]</a></td></tr></table></td></tr><tr ><td class="posttext"> Yes, I've tried using a timer, and that works great. I still don't understand why there is a difference between a timer that limits the framerate to 75 and a VWait with a refreshrate of 75. <br><br></td></tr></table><br>
<a name="307037"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Réno</td><td align="right"><font class=tiny>(Posted 2004)</font>&nbsp;<a href="#11">[#11]</a></td></tr></table></td></tr><tr ><td class="posttext"> FrameMs = 1000 / 60<br>&gt;&gt;&gt;This will never return you a floating point, so, it will never be a software 60hz... <br><br></td></tr></table><br>
<a name="307052"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >DrMartin</td><td align="right"><font class=tiny>(Posted 2004)</font>&nbsp;<a href="#12">[#12]</a></td></tr></table></td></tr><tr ><td class="posttext"> But can't you see the strange thing here? If I have a program running at 75 FPS, limited by a timer, it hardly uses any CPU at all. But if I add a VWait before or after the timer-wait, the program uses 100% CPU, just like that! I think it's very very strange. Am I missing something? <br><br></td></tr></table><br>
<a name="307134"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >MSW</td><td align="right"><font class=tiny>(Posted 2004)</font>&nbsp;<a href="#13">[#13]</a></td></tr></table></td></tr><tr ><td class="posttext"> Thats because timers are set-up by the OS...you use waitimer or delay and the OS will stop executeing your program and only return once the timer/deley event has occured....useing VWait means your program enters a loop where it checks the VWait refresh flag, if it has refreshed it exits the loop, if not it checks again...and again...and again untill the flag has been set...during this your program has 100% control of the CPU....but during a waittmer/delay...your program gives up CPU control to the OS, and the OS only returns CPU control to the program once it senses the correct time has elapsed. <br><br></td></tr></table><br>
<a name="307166"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >DrMartin</td><td align="right"><font class=tiny>(Posted 2004)</font>&nbsp;<a href="#14">[#14]</a></td></tr></table></td></tr><tr ><td class="posttext"> That's odd, shouldn't a VWait be able to work like a timer? I mean, that would be so much better. <br><br></td></tr></table><br>
<a name="307172"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >MSW</td><td align="right"><font class=tiny>(Posted 2004)</font>&nbsp;<a href="#15">[#15]</a></td></tr></table></td></tr><tr ><td class="posttext"> If you figure out what the users refreash rate is and create a timer at the same frequency, and use it to time your game then yes.<br><br>Windows doesn't require knowing about anything moniter refreash rates to function...but as it is a multi-tasking OS it does need to keep track of application time slices, and be able to switch from one application to another...so when you use VWait, you are hogging not only your applications timeslice, but other applications as well. <br><br></td></tr></table><br>
<a name="307201"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >DrMartin</td><td align="right"><font class=tiny>(Posted 2004)</font>&nbsp;<a href="#16">[#16]</a></td></tr></table></td></tr><tr ><td class="posttext"> Yeah. What I meant is that the VWait in Blitz should work like a timer, that would have been much nicer. <br><br></td></tr></table><br>
<a name="bottom"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td align="right"><a href="http://monkeycoder.co.nz" target="_blank"><img src="/img/monkey2.svg" ></a> <a href="https://github.com/blitz-research" target="_blank"><img src="/img/github.svg" ></a> <a href="https://discord.gg/qJccbSp" target="_blank"><img src="/img/discord.svg" ></a></td></tr></table><br></div><br><table width="100%"><tr><td></body></html lang="en">
