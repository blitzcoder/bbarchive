<!DOCTYPE html><html lang="en" ><head ><title >Blitz Zip Userlib (Create an manipulate zip files)</title><meta name='viewport' content='width=device-width, initial-scale=0.66'><meta name='description' content='language:basic, target:desktop, category:game development'><link rel="styleSheet" href="../skins/granite/style.css" type="text/css"><style type="text/css">div.bbcode {padding: 8px;background: #E5E5E5;color: #000000;border: 1px dashed #B4B4BE;}</style></head><body ><table width=100% cellspacing=0 cellpadding=0><tr ><td class="menubarleft"></td><td class="menubar"><table cellspacing="0" cellpadding="0"><tr ><td >&nbsp;</td><td class="menuitemleft"></td><td class="menuitem"><a href="/" class="menuitem">News</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/forums.php" class="menuitem">Forums</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/codearcs.php" class="menuitem">Code</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/logs.php" class="menuitem">Logs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/gallery.php" class="menuitem">Gallery</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/sdkspecs.php" class="menuitem">Specs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/search.php" class="menuitem">Search</a></td><td class="menuitemright"></td></tr></table></td><td class="menubarright"></td></tr></table><div class="main"><h1 >Blitz Zip Userlib (Create an manipulate zip files)</h1><a href="forums.php" >BlitzPlus Forums</a>/<a href="topics.php?forum=81" >BlitzPlus Programming</a>/<a href="#bottom" >Blitz Zip Userlib (Create an manipulate zip files)</a><br><br>
<a name="705745"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Phil Newton</td><td align="right"><font class=tiny>(Posted 2006)</font>&nbsp;<a href="#1">[#1]</a></td></tr></table></td></tr><tr ><td class="posttext"> <b>Latest Version</b>: 1.2 (27th August, 2007)<br><br>Here's a little something I've been working on for the past few days. It's a set of userlib declarations and wrapper functions that allow you to extract files from zip archives, and also to create your own zip files.<br><br>A quick example of creating a zip and adding files to it:<br><br><pre class=code>
; Open our new archive
Local zipOut	= ZipApi_CreateZip("my-zip.zip")
 
; Add some test files
ZipApi_AddFile(zipOut, "example1.bb")
ZipApi_AddFile(zipOut, "example2.bb")
ZipApi_AddFile(zipOut, "example3.bb") 

; Close the zip
ZipApi_CloseZip(zipOut)
</pre><br>You can also add data to a zip file directly from a Blitz bank.<br><br>Download: <a href="http://downloads.sodaware.net/blitz/libs/blitz.zipapi/blitz.zipapi-1.2.zip" target="_blank">Download Now (119.4KB)</a><br><br>More Information: <a href="http://www.sodaware.net/dev/blitz/libs/blitz.zipapi/" target="_blank">Blitz.ZipApi - Project Homepage</a><br><br>Online Documentation: <a href="http://docs.sodaware.net/blitz.zipapi/" target="_blank">http://docs.sodaware.net/blitz.zipapi/</a><br><br>Any feedback/bug reports are greatly appreciated. <br><br></td></tr></table><br>
<a name="705764"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Dock</td><td align="right"><font class=tiny>(Posted 2006)</font>&nbsp;<a href="#2">[#2]</a></td></tr></table></td></tr><tr ><td class="posttext"> Wow, great. I haven't tried this yet but it's a really useful feature to be able to have. <br><br></td></tr></table><br>
<a name="705770"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Andres</td><td align="right"><font class=tiny>(Posted 2006)</font>&nbsp;<a href="#3">[#3]</a></td></tr></table></td></tr><tr ><td class="posttext"> Very good stuff, is there anyway to use passwords too? <br><br></td></tr></table><br>
<a name="705774"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Phil Newton</td><td align="right"><font class=tiny>(Posted 2006)</font>&nbsp;<a href="#4">[#4]</a></td></tr></table></td></tr><tr ><td class="posttext"> @Dock: Thanks!<br>@Andres: Not yet, but I plan to add it in the next version. <br><br></td></tr></table><br>
<a name="713240"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Pineapple</td><td align="right"><font class=tiny>(Posted 2006)</font>&nbsp;<a href="#5">[#5]</a></td></tr></table></td></tr><tr ><td class="posttext"> This caught my eye... great stuff! :D<br><br>Thanks for sharing<br><br>Dabz <br><br></td></tr></table><br>
<a name="771363"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Phil Newton</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#6">[#6]</a></td></tr></table></td></tr><tr ><td class="posttext"> It took its sweet time, but version 1.1 is now available (see first post). This version supports passwords, both for extracting files and adding them to a new archive. <br><br></td></tr></table><br>
<a name="771573"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >b32</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#7">[#7]</a></td></tr></table></td></tr><tr ><td class="posttext"> Wow .. this is an amazing library. I've managed to extract a .zip file today, and it works very nice.<br><br>I tried using one of my own archives. At first, the first example stopped after showing one file.<br>I changed to loop to:<br>Until ZipApi_GotoNextFile(zipIn) ;;ZIPAPI_UNZ_END_OF_LIST_OF_FILE<br>and it showed all files in the archive. Maybe that happened because my archive had only one file in the first folder, all other files are placed in subfolders.<br>Then I converted this example to extract the archive.<br>Because the .zip I used contained (sub)folders, I needed Mr. Picklesworth FixPath routine from the archive to create the folders. (For that routine, I needed to replace the "/" with "\" in the searchpath.)<br><br>Finally, this is the code I used:<br><textarea class=codebox name="code" wrap=OFF readonly="true" rows="15" cols="80">
Graphics 800, 600, 0, 2
; --------------------------------------------------
; --
; -- examples/example1.bb
; --
; -- A short example of how to iterate through a 
; -- ZIP file's contents using the ZipApi library.
; --
; --------------------------------------------------

; Include required libraries
Include "../Blitz_Basic_Bank.bb"
Include "../Blitz_File_FileName.bb"
Include "../Blitz_File_ZipApi.bb"

; Open the zip file
Local zipIn = ZipApi_Open("test-file.zip")

; Check the zip file was valid
If zipIn = 0 Then
	; Not a valid ZIP file - display error and exit program
	Print "There was an error whilst trying to open the zip file."
	WaitKey()
	End
EndIf

; Set file pointer to first file
ZipApi_GotoFirstFile(zipIn)

; Print a fancy header
Print LSet("FileName", 30) + RSet("Packed Size", 14) + RSet("Normal Size", 14) + RSet("Ratio", 10)

; Begin iterating through files
Repeat
	
	; Get the current file's information
	Local fileInfo.ZIPAPI_UnzFileInfo	= ZipApi_GetCurrentFileInfo(zipIn)
	
	; Generate fancy file data, containing file name, size and compression ratio
	Local fileData$	= ""
	Local compressionRatio# = Float((fileInfo\CompressedSize) / Float(fileInfo\UnCompressedSize)) * 100.0

	fn$ = Replace$(fileinfo\Filename, "/", "\")
	FixPath(fn$)
	
	If FileType(fn$) &lt;&gt; 2 Then
		outname$ = ZipApi_ExtractFile(zipIn, fileinfo\Filename, fileinfo\Filename$)
	End If
		
	fileData$	= LSet(fileInfo\FileName, 30)
	fileData 	= fileData + RSet(fileInfo\CompressedSize, 14)
	fileData 	= fileData + RSet(fileInfo\UnCompressedSize, 14)
	fileData 	= fileData + RSet(compressionRatio + "%", 10)
	
	; Cleanup &amp; output
	ZIPAPI_UnzFileInfo_Dispose(fileInfo)
	Print fileData
	
	
Until ZipApi_GotoNextFile(zipIn) ;;ZIPAPI_UNZ_END_OF_LIST_OF_FILE

; Close &amp; Cleanup
ZipApi_Close(zipIn)

Print "Press any key.."
WaitKey()

End


;-----------------------------------------------------------------------------------------------------
;-----------------------------------------------------------------------------------------------------

; ID: 1567
; Author: Mr. Picklesworth
; Date: 2005-12-17 15:36:23
; Title: FixPath
; Description: Creates every missing folder in a file path

Function FixPath(path$)
;Creates every missing folder in a path. (Fills in gaps in a filepath)
;Handy for file saving.
;Written by Dylan McCall (Mr. Picklesworth)
	path$=extractfilepath(path$)
	Local c=1,pathTo$
	Repeat
		slash=Instr(path$,"\",c)
		If slash=0
			If c&gt;=Len(path$)+1
				Exit
			Else
				slash=Len(path$)+1
			EndIf
		EndIf
		
		folder$=Mid(path$,c,slash-c)
		If FileType(pathTo$+folder)=0 Then CreateDir(pathTo$+folder)
		c=slash+1
		pathTo$=pathTo$+folder+"\"
	Forever
	Return 1
End Function

;FUNCTION ExtractFilePath
;Accepts a filepath with filename and returns only the path
;i.e. pass c:\temp\test.txt the return value will be c:\temp\
Function ExtractFilePath$(sFilePath$) ;Written by Perturbatio
    ;LOCAL VARS
    Local iStartPos% = 0
    Local iSearchPos% = 0
    Local iFilePathLength = 0
    Local sFileExt$ = ""
    
    ;BEGIN FUNCTION CODE
    iFilePathLength = Len(sFilePath$)
    iSearchPos% = iFilePathLength
    
    While (iStartPos% &lt; 1) And (iSearchPos% &gt; 1)
        
        iStartPos% = Instr(sFilePath$, "\", iSearchPos%)
        iSearchPos% = iSearchPos% - 1
        
    Wend
    
    If iStartPos = 0 Then ;if the filepath contains no backslashes
        sFileExt$ = sFilePath$
    Else
        sFileExt$ = Left$(sFilePath$, iStartPos%)
    EndIf
    
    
    Return sFileExt$    
End Function
</textarea><br>Ow .. not really worth mentioning .. I needed to add WaitKey() commands to the examples to see their output.<br><br>The extract from/to banks functions seems very exciting, too. I can imagine this is very useful.<br>It works very well and thanks for showing this. I didn't knew this was possible at all. <br><br></td></tr></table><br>
<a name="771609"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Phil Newton</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#8">[#8]</a></td></tr></table></td></tr><tr ><td class="posttext"> Thanks for the feedback b32, it seems a bug crept into that example. The constant should actually be called "ZIPAPI_END_OF_LIST_OF_FILE" not "ZIPAPI_UNZ_END_OF_LIST_OF_FILE". Once that's changed it reads through all of the files. I've fixed the online example to reflect this change.<br><br>I think the "WaitKey" is required because it runs in a terminal window, and once it's completed the window closes. Still, great to see you're finding it useful, and thanks again for spotting that bug! <br><br></td></tr></table><br>
<a name="771742"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >b32</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#9">[#9]</a></td></tr></table></td></tr><tr ><td class="posttext"> I was trying to compress/decompress banks, when I noticed that sometimes the uncompressed bank is not created.<br>I first got an error saying 'bbBank does not exist' when I tried it on an empty bank. Later on, I got the same error with a bank that contains a bitmap that is filled with a solid color. I filled the image with purple (255..0..255) and drew a face on it in Paint.<br>On this example, I can't read a banksize because of an empty bank:<br><textarea class=codebox name="code" wrap=OFF readonly="true" rows="15" cols="80">
	
	; Include required libraries
	Include "../Blitz_Basic_Bank.bb"
	Include "../Blitz_File_FileName.bb"
	Include "../Blitz_File_ZipApi.bb"
		
	bank = CreateBank(255)
	bank1 = ZipApi_Compress(bank)
	bank2 = ZipApi_UnCompress(bank)
	Print BankSize(bank2)

	FreeBank bank
	FreeBank bank1
	FreeBank bank2
	
	End	
</textarea> <br><br></td></tr></table><br>
<a name="771757"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Phil Newton</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#10">[#10]</a></td></tr></table></td></tr><tr ><td class="posttext"> Shouldn't it read:<br><br><pre class=code>bank2 = ZipApi_UnCompress(bank1)</pre>  <br><br>The uncompress command will return an invalid handle because it's trying to uncompress invalid data (It returns ZIPAPI_DATA_ERROR instead). <br><br>Still, it might me more useful if it returned the original data in a new bank to stop runtime errors. The same goes for trying to compress an empty bank - it will return 0 instead of a new bank. Would it be better to return new banks in both of these cases? <br><br></td></tr></table><br>
<a name="771834"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >b32</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#11">[#11]</a></td></tr></table></td></tr><tr ><td class="posttext"> Ow .. that's stupid, the example was wrong .. I understand the error checking now. It seems my experiment returned a ZIPAPI_BUF_ERROR. <br>However, I don't understand why. When I poke random data in a bank, size 5000, the compressed version of the bank can be uncompressed. However, when I leave the original bank empty, or fill it with predicable numbers, it can't. Is that right ?<br><textarea class=codebox name="code" wrap=OFF readonly="true" rows="15" cols="80">
	; Include required libraries
	Include "../Blitz_Basic_Bank.bb"
	Include "../Blitz_File_FileName.bb"
	Include "../Blitz_File_ZipApi.bb"		

	;create bank	
	bank = CreateBank(5000)

;	;without these lines, it returns a data error
;   ;but with them, the bank can be extracted 
;
;	For i = 0 To BankSize(bank) / 2
;		PokeByte bank, i, Rand(255)
;	Next
	
	;compress
	bank1 = ZipApi_Compress(bank)
	bank2 = ZipApi_UnCompress(bank1)
	Print "org:" + BankSize(bank)
	Print "cmp:" + BankSize(bank1)
	
	;cmp. ratio
	Print "scale = " + BankSize(bank) / Float(BankSize(bank1))

	Print "error? " + bank2
	
	If bank2 &gt; 0 Then
	
		;test uncompressed bank
		Print "unc:" + BankSize(bank2)
	
	End If
	
	FreeBank bank
	FreeBank bank1
	FreeBank bank2

	WaitKey()
	End	

</textarea><br>I think the structure you chose is a good solution. I don't think is it necessary to be able to compress banks with a length of zero. If any error occurs, it might be better to abort, it will make debugging much easier I think. <br><br></td></tr></table><br>
<a name="771851"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Phil Newton</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#12">[#12]</a></td></tr></table></td></tr><tr ><td class="posttext"> That's an interesting problem. To uncompress packed data, zlib needs to know how big of an output buffer to use. You can pass this in the second parameter of ZipApi_UnCompress, but if it's not passed then the app will "guess" and create a bank 100 times bigger than the input bank's size. This works fine in most cases, but if you're compressing an empty bank it will be much smaller, so the output buffer would need to be more than 100 times bigger than the input.<br><br>The best solution I can think of would be to do the following:<br><br><pre class=code>
bank1 = CreateBank(5000)
bank2 = ZipApi_Compress(bank1)

; Resize the output, and store the original size at the last 4 bytes
ResizeBank(bank2, BankSize(bank2) + 4)
PokeInt(bank2, BankSize(bank2) - 4, BankSize(bank1))

; To unpack...

; Get the unpacked size
Local unpackedSize	= PeekInt(bank2, BankSize(bank2) - 4)

; Trim the size off the end
ResizeBank(bank2, BankSize(bank2) + 4)

; Unpack it
bank3	= ZipApi_UnCompress(bank2, unpackedSize)

Print BankSize(bank3)
</pre><br><br>This adds the original size to the packed data, so it can be extracted later. It works fine as long as you remember to trim the last 4 bytes before unpacking it. I could integrate this functionality into the library, but it would mean the packed data wouldn't be compatible with other libraries without some modification of the bank data (and it might break existing apps). <br><br>It wouldn't be too hard to add as two extra functions though (CompressBank and UncompressBank). This would preserve compatibility and also solve the problem.<br><br>Let me know if you'd find that useful, and if so I'll add it to the next release. Thanks for all your feedback too, it's extremely helpful! <br><br></td></tr></table><br>
<a name="771980"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >b32</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#13">[#13]</a></td></tr></table></td></tr><tr ><td class="posttext"> Ow .. now it makes sense. Again, I feel a bit stupid. Thanks for clearing this up. It works now, I was going by the example and didn't realise there was another optional parameter.<br><br>As for the extra functions, that is a good question. <br>When I downloaded this, I went by the examples to figure out what I should do.<br>From this perspective, I would say: adjust the example to use the "unpackedSize" parameter. Since this is the 'safe' method, I would consider it the 'official' method. Leaving the parameter out is optional. It is then up to the user to find a way to store the original size of the data.<br>Maybe, instead of estimating, you could define the temp. bank size with the maximum size that is available.<br><br>The CompressBank and UncompressBank functions are a good solution. Since they can co-exist next to the original functions, they would harm nobody. For me, I see no use in altering the compressed data, so it wouldn't matter if the size is stored there as well. For some reason I would say to store the 'size' at the start of the bank, but I don't know why. Maybe it is because I've seen that so often with other structures.<br><br>It works too good, this lib. I wanted to see if it is possible to make a single-file installer using the bank compression functions.<br>So I've converted all the files into banks, compressed them, converted them into Data statements and then with another program I uncompressed them and wrote them back to disk.<br>(To be able to use such a long source, I used "Include" to include it and didn't try to open it with the IDE.)<br>I've stored and restored 7.56 MB of files this way. It took BB about 5 minutes to compile, but it works! Amazing, don't you think ? Well, I've never done anything like it ..<br><br>So, actually, I didn't encounter any problems at all. It just works, and it is very good. <br><br></td></tr></table><br>
<a name="805620"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Phil Newton</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#14">[#14]</a></td></tr></table></td></tr><tr ><td class="posttext"> Version 1.2 is now available (see first post for links).<br><br>This version adds several new commands, but the most important are : ZipApi_CompressBank and ZipApi_UnCompressBank. CompressBank adds extra data to the end of the bank which is used by UnCompressBank to get the size of the unpacked data.<br><br>Another new command is ZipApi_GetUncompressedSize, which gets the total uncompressed size of a zip file. These are also a few bug-fixes here and there, but nothing major. <br><br></td></tr></table><br>
<a name="805674"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Abrexxes</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#15">[#15]</a></td></tr></table></td></tr><tr ><td class="posttext"> The first link is only 1.1. For 1.2 we must go to the homepage. ;)<br><br>Very cool stuff !<br><br>cu <br><br></td></tr></table><br>
<a name="805714"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Phil Newton</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#16">[#16]</a></td></tr></table></td></tr><tr ><td class="posttext"> Thanks for the heads-up Abrexxes - all fixed now :) <br><br></td></tr></table><br>
<a name="bottom"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td align="right"><a href="http://monkeycoder.co.nz" target="_blank"><img src="/img/monkey2.svg" ></a> <a href="https://github.com/blitz-research" target="_blank"><img src="/img/github.svg" ></a> <a href="https://discord.gg/qJccbSp" target="_blank"><img src="/img/discord.svg" ></a></td></tr></table><br></div><br><table width="100%"><tr><td></body></html lang="en">
