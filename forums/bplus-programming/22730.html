<!DOCTYPE html><html lang="en" ><head ><title >Raw pixel performance version 1.11 to 1.35 slowdown?</title><meta name='viewport' content='width=device-width, initial-scale=0.66'><meta name='description' content='language:basic, target:desktop, category:game development'><link rel="styleSheet" href="../skins/granite/style.css" type="text/css"><style type="text/css">div.bbcode {padding: 8px;background: #E5E5E5;color: #000000;border: 1px dashed #B4B4BE;}</style></head><body ><table width=100% cellspacing=0 cellpadding=0><tr ><td class="menubarleft"></td><td class="menubar"><table cellspacing="0" cellpadding="0"><tr ><td >&nbsp;</td><td class="menuitemleft"></td><td class="menuitem"><a href="/" class="menuitem">News</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/forums.php" class="menuitem">Forums</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/codearcs.php" class="menuitem">Code</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/logs.php" class="menuitem">Logs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/gallery.php" class="menuitem">Gallery</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/sdkspecs.php" class="menuitem">Specs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/search.php" class="menuitem">Search</a></td><td class="menuitemright"></td></tr></table></td><td class="menubarright"></td></tr></table><div class="main"><h1 >Raw pixel performance version 1.11 to 1.35 slowdown?</h1><a href="forums.php" >BlitzPlus Forums</a>/<a href="topics.php?forum=81" >BlitzPlus Programming</a>/<a href="#bottom" >Raw pixel performance version 1.11 to 1.35 slowdown?</a><br><br>
<a name="233550"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Kcarlino</td><td align="right"><font class=tiny>(Posted 2003)</font>&nbsp;<a href="#1">[#1]</a></td></tr></table></td></tr><tr ><td class="posttext"> Below is a code sample that runs much slower on versions 1.35 and 1.34 compared to version 1.11. <br><br>Basically it uses ReadPixelFast and WritePixelFast on an image bufer and the canvas.<br><br>The numbers I get are<br>version 1.11  -  1900 millisecs<br>version 1.35  -  14500 millisecs<br><br>That's about 7x slower.<br><br>I thought perhaps it was the canvas operations, but commenting out the write to the canvas is still slower.<br>version 1.11 - 600 millisecs<br>version 1.35 - 900 millisecs<br><br>I suspect I'm doing something wrong but I don't know what.<br><br><br>; Simple Speed test of read and write pixels<br><br>Const EVENT_MOUSEDOWN = $201<br>Const EVENT_CLOSE = $803<br><br>Const IMAGE_WIDTH = 400<br>Const IMAGE_HEIGHT = 400<br><br>; Create a main window<br>window = CreateWindow ("Speed Test of raw pixel ops", 0, 0, ClientWidth(Desktop()), ClientHeight(Desktop()))<br><br>If window<br><br>	; Create panel<br>	panel = CreatePanel (0, 0, ClientWidth(window), ClientHeight(window), window, 1)<br>	SetPanelColor panel, 64, 64, 64<br>	SetGadgetLayout panel, 1, 1, 1, 1<br><br>	; Create drawing canvas<br>	canvas = CreateCanvas (0, 0, IMAGE_WIDTH, IMAGE_HEIGHT, panel)<br>	SetGadgetLayout canvas,1,1,1,1<br><br>	; Create image buffer<br>	ibuffer = CreateImage (IMAGE_WIDTH, IMAGE_HEIGHT)<br>	SetBuffer ImageBuffer (ibuffer)<br><br>	; Main event loop...<br>	Repeat<br><br>		; Wait for a window event...<br>		e = WaitEvent ()<br>		<br>		; Process the event...<br>		If e = EVENT_MOUSEDOWN Then<br><br>			LockBuffer CanvasBuffer(canvas)<br>			LockBuffer ImageBuffer(ibuffer)<br><br>			startTime = MilliSecs()<br><br>			For count = 0 To 100<br>				For y = 0 To IMAGE_HEIGHT<br>					For x = 0 To IMAGE_WIDTH<br>						rrgb = ReadPixelFast(x,y)<br>						WritePixelFast x,y,rrgb<br>						<br>						SetBuffer CanvasBuffer (canvas)<br>						WritePixelFast x,y,rrgb<br>						SetBuffer ImageBuffer (ibuffer)<br>					Next<br>				Next<br>			Next<br><br>			UnlockBuffer CanvasBuffer(canvas)<br>			UnlockBuffer ImageBuffer(ibuffer)<br>				<br>			endTime = MilliSecs()<br>			Print endTime - startTime<br><br>			FlipCanvas (canvas)<br>		EndIf<br>		If e = EVENT_CLOSE Then End<br>	Forever<br><br>Else<br>	Notify ("Failed to create window!", True)<br>	End<br>EndIf <br><br></td></tr></table><br>
<a name="233624"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Snarty</td><td align="right"><font class=tiny>(Posted 2003)</font>&nbsp;<a href="#2">[#2]</a></td></tr></table></td></tr><tr ><td class="posttext"> ibuffer = CreateImage (IMAGE_WIDTH, IMAGE_HEIGHT) <br><br>Change the above line to either of the ones below, and re-run the test. I'll say no more.<br><br>Managed Style:<br>ibuffer = CreateImage (IMAGE_WIDTH, IMAGE_HEIGHT,1,2) <br><br>SysRam Style:<br>ibuffer = CreateImage (IMAGE_WIDTH, IMAGE_HEIGHT,1,4) <br><br>Enjoy! :) <br><br></td></tr></table><br>
<a name="233634"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Kcarlino</td><td align="right"><font class=tiny>(Posted 2003)</font>&nbsp;<a href="#3">[#3]</a></td></tr></table></td></tr><tr ><td class="posttext"> I've given these suggestions a try.  This first one resulted if very little change <br><br>Managed Style: <br>ibuffer = CreateImage (IMAGE_WIDTH, IMAGE_HEIGHT,1,2) <br><br>around 14500 millisecs<br><br><br>This second suggestion slowed things down even more.<br>SysRam Style: <br>ibuffer = CreateImage (IMAGE_WIDTH, IMAGE_HEIGHT,1,4) <br><br>around 26000 millisecs <br><br><br>Any other suggestions?  Has the management of canvases changed since 1.11?<br><br>Thanks<br>Ken <br><br></td></tr></table><br>
<a name="233669"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Snarty</td><td align="right"><font class=tiny>(Posted 2003)</font>&nbsp;<a href="#4">[#4]</a></td></tr></table></td></tr><tr ><td class="posttext"> Personally I never use a canvas for reading/writing direct to. I only use SysRam images for that. It's far quicker. Try your example with the main write loop as this. (in both versions). <br><br>I would be interested to know the results.<br><br><pre class=code>
; Process the event... 
If e = EVENT_MOUSEDOWN Then 

	SetBuffer ImageBuffer (ibuffer) 
	LockBuffer ImageBuffer(ibuffer) 
	
	startTime = MilliSecs() 
	
	For count = 0 To 100 
		For y = 0 To IMAGE_HEIGHT 
			For x = 0 To IMAGE_WIDTH 
				rrgb = ReadPixelFast(x,y) 
				WritePixelFast x,y,rrgb 
			Next 
		Next 
	Next 
	
	UnlockBuffer ImageBuffer(ibuffer) 
	SetBuffer CanvasBuffer(canvas)
	DrawBlock iBuffer,0,0
	
	endTime = MilliSecs() 
	Print endTime - startTime 
	
	FlipCanvas (canvas) 
EndIf 
If e = EVENT_CLOSE Then End 
</pre> <br><br></td></tr></table><br>
<a name="233670"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Snarty</td><td align="right"><font class=tiny>(Posted 2003)</font>&nbsp;<a href="#5">[#5]</a></td></tr></table></td></tr><tr ><td class="posttext"> Also, consider using LockedPixel()'s method. This again, is very fast. <br><br></td></tr></table><br>
<a name="233673"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >marksibly</td><td align="right"><font class=tiny>(Posted 2003)</font>&nbsp;<a href="#6">[#6]</a></td></tr></table></td></tr><tr ><td class="posttext"> HI,<br><br>The repeated use of SetBuffer inside the loop might be problem.<br><br>Use the 'buffer' options of ReadPixel/WritePixel to control which buffers are read/written and remove the SetBuffers. <br><br></td></tr></table><br>
<a name="233674"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Kcarlino</td><td align="right"><font class=tiny>(Posted 2003)</font>&nbsp;<a href="#7">[#7]</a></td></tr></table></td></tr><tr ><td class="posttext"> Snarty,<br><br>Thanks for your feedback.<br><br>I've tried your version and the results are<br><br>version 1.11 - 510 millisecs<br>version 1.35 - 720 millisecs<br><br>Of course this version changes the test so that the canvas is not updated along the way.  The reason I was writting the pixels directly to the canvas was that the information I may normally have to display is not very dense, and in earlier tests on 1.11 it was quicker to just update the pixels rather than the full dirty rect.  <br><br>I also had previously tried the LockedPixel() method and I couldn't get this to perform as well as the readpixelfast(), of course my approach may not have been the best.<br><br><br>Mark,<br>Thanks for this suggestion, not doing the SetBuffer()'s in the loop shaved 4000 millisecs (or 25 percent).<br><br>Are canvases created using video ram?  <br><br>Thanks<br>Ken <br><br></td></tr></table><br>
<a name="bottom"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td align="right"><a href="http://monkeycoder.co.nz" target="_blank"><img src="/img/monkey2.svg" ></a> <a href="https://github.com/blitz-research" target="_blank"><img src="/img/github.svg" ></a> <a href="https://discord.gg/qJccbSp" target="_blank"><img src="/img/discord.svg" ></a></td></tr></table><br></div><br><table width="100%"><tr><td></body></html lang="en">
