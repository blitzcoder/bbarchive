<!DOCTYPE html><html lang="en" ><head ><title >Spriter Importer for Monkey</title><meta name='viewport' content='width=device-width, initial-scale=0.66'><meta name='description' content='language:basic, target:desktop, category:game development'><link rel="styleSheet" href="../skins/granite/style.css" type="text/css"><style type="text/css">div.bbcode {padding: 8px;background: #E5E5E5;color: #000000;border: 1px dashed #B4B4BE;}</style></head><body ><table width=100% cellspacing=0 cellpadding=0><tr ><td class="menubarleft"></td><td class="menubar"><table cellspacing="0" cellpadding="0"><tr ><td >&nbsp;</td><td class="menuitemleft"></td><td class="menuitem"><a href="/" class="menuitem">News</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/forums.php" class="menuitem">Forums</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/codearcs.php" class="menuitem">Code</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/logs.php" class="menuitem">Logs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/gallery.php" class="menuitem">Gallery</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/sdkspecs.php" class="menuitem">Specs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/search.php" class="menuitem">Search</a></td><td class="menuitemright"></td></tr></table></td><td class="menubarright"></td></tr></table><div class="main"><h1 >Spriter Importer for Monkey</h1><a href="forums.php" >Community Forums</a>/<a href="topics.php?forum=201" >Monkey Talk</a>/<a href="#bottom" >Spriter Importer for Monkey</a><br><br>
<a name="1177210"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >therevills</td><td align="right"><font class=tiny>(Posted 2013)</font>&nbsp;<a href="#1">[#1]</a></td></tr></table></td></tr><tr ><td class="posttext"> A week or so I decided to update my Spriter importer, seems to work pretty well:<br><br><a href="http://www.therevillsgames.com/monkey/SpriterA4/MonkeyGame.html" target="_blank">http://www.therevillsgames.com/monkey/SpriterA4/MonkeyGame.html</a><br><br>And should be easy enough to move to BlitzMax too ;)<br><br><textarea class=codebox name="code" wrap=OFF readonly="true" rows="15" cols="80">#TEXT_FILES="*.txt|*.xml|*.json|*.SCML|*.scml"
Strict
Import mojo
Import diddy.xml

Function Main:Int()
	New Game()
	Return 0
End

'-------------------------- Monkey Spriter Demo --------------------------
Class Game Extends App
	
	Field monster:MonkeySpriter
	Field hero:MonkeySpriter

	Const IDLE:String = "Idle"
	Const POSTURE:String = "Posture"
	Field monsterAnimName:String = IDLE
	
	Const IDLEH:String = "idle_healthy"
	Const WALK:String = "walk"
	Field heroAnimName:String = IDLEH

	Field x:Float, y:Float
	
	Field lastMillisecs:Int
	Field currentMillisecs:Int 
	Field timeElapsed:Int
	Field tween:Bool = True
	Field loopType:Int
	
	Method OnCreate:Int()
		monster = SpriterImporter.ImportFile("monster", "Example.SCML")
		hero = SpriterImporter.ImportFile("example hero", "BetaFormatHero.SCML")
		x = DeviceWidth() / 2
		y = DeviceHeight() - 20
		monster.timer.Start()
		hero.timer.Start()		
		SetUpdateRate(60)
		lastMillisecs = Millisecs()
		loopType = MonkeySpriter.LOOPING_TRUE
		CreateGUI()
		Return 0
	End
	
	Method CreateGUI:Void()
		Local b:Button = New Button("Anim 1", 0, 10, 100, 20)
		b.SetColour(255, 0, 0)
		b = New Button("Anim 2", 110, 10, 100, 20)

		b = New Button("Loop Type", 220, 10, 100, 20)
		b.SetColour(255, 255, 0)
		
		b = New Button("Reset Timer", 330, 10, 100, 20)
		b.SetColour(255, 0, 255)
		
		b = New Button("Stop Timer", 440, 10, 100, 20)
		b.SetColour(0, 255, 255)
		
		b = New Button("Resume Timer", 550, 10, 100, 20)
		b.SetColour(0, 255, 0)
		
		b = New Button("Slower", 440, 40, 100, 20)
		b.SetColour(100, 100, 100)
		
		b = New Button("Faster", 550, 40, 100, 20)
		b.SetColour(0, 0, 255)
		
		b = New Button("Tween On/Off", 220, 40, 100, 20)
		b.SetColour(25, 255, 25)
	End
	
	Method OnUpdate:Int()
		' simple delta timing
		currentMillisecs = Millisecs()
		timeElapsed = currentMillisecs - lastMillisecs 
		lastMillisecs = currentMillisecs

		hero.Update(heroAnimName, loopType, timeElapsed)
		monster.Update(monsterAnimName, loopType, timeElapsed)
		
		Controls()
		Return 0
	End	
	
	Method OnRender:Int()
		Cls
		
		monster.Draw(x, y, tween)
		hero.Draw(x-100, y, tween)
		
		Button.DrawAll()
		DrawDebug()
		Return 0
	End
	
	Method Controls:Void()
		Button.UpdateAll()
		If Button.Clicked("Stop Timer") Then
			monster.timer.Stop()
			hero.timer.Stop()
		End
		If Button.Clicked("Resume Timer") Then
			monster.timer.Resume()
			hero.timer.Resume()
		End
		If Button.Clicked("Reset Timer") Then
			monster.timer.Start()
			hero.timer.Start()
			monster.mainlineKeyId = 0
			hero.mainlineKeyId = 0
		End
		If Button.Clicked("Faster") Then
			hero.timer.rate/=1.1
			monster.timer.rate/=1.1
		End
		If Button.Clicked("Slower") Then
			hero.timer.rate*=1.1
			monster.timer.rate*=1.1
		End
		If Button.Clicked("Anim 1") Then
			monsterAnimName = IDLE
			heroAnimName = IDLEH
			monster.mainlineKeyId = 0
			monster.timer.Start()
			hero.mainlineKeyId = 0
			hero.timer.Start()
		End
		If Button.Clicked("Anim 2") Then
			monsterAnimName = POSTURE
			heroAnimName = WALK
			monster.mainlineKeyId = 0
			monster.timer.Start()
			hero.mainlineKeyId = 0
			hero.timer.Start()
		End
		If Button.Clicked("Tween On/Off") Then
			tween = Not tween
		End
		If Button.Clicked("Loop Type") Then
			monster.timer.Start()
			hero.timer.Start()
			monster.mainlineKeyId = 0
			hero.mainlineKeyId = 0
			loopType += 1
			If loopType &gt; 2 loopType = 0
		End
		
		If KeyDown(KEY_W) y-=2
		If KeyDown(KEY_S) y+=2
		If KeyDown(KEY_A) x-=2
		If KeyDown(KEY_D) x+=2
	End
	
	Method DrawDebug:Void()
		Local y:Int = 100
		Local gap:Int = 15
		DrawText("MONKEY SPRITER IMPORTER", 10, y)
		y+=gap
		y+=gap
		DrawText("Monster Timer = " + monster.timer.GetTime(), 10, y)
		y+=gap
		DrawText("Hero Timer    = " + hero.timer.GetTime(), 10, y)
		y+=gap
		DrawText("Time Elapsed  = " + timeElapsed, 10, y)
		y+=gap
		Local loopString:String
		Select loopType
			Case 0
				loopString = "FALSE"
			Case 1
				loopString = "TRUE"
			Case 2
				loopString = "PING PONG"
		End
		DrawText("Looping Type  = " + loopString, 10, y)
		y+=gap
		DrawText("Timer Speed   = " + monster.timer.rate, 10, y)
		y+=gap
		If tween
			DrawText("Tweening      = TRUE", 10, y)
		Else
			DrawText("Tweening      = FALSE", 10, y)
		End
		y+=gap
	End
End
'-------------------------- Simple Button --------------------------
Class Button
	Field x:Int, y:Int
	Field w:Int, h:Int
	Field label:String
	Field name:String
	Field r:Int = 255, g:Int = 255, b:Int = 255
	Field mouseOver:Bool = False
	Field clicked:Bool = False
	Global clickedName:String = ""
	Global list:List&lt;Button&gt;
	
	Method New(label:String, x:Int, y:Int, w:Int, h:Int)
		If list = Null Then list = New List&lt;Button&gt;
		Self.label = label
		Self.name = label.ToUpper()
		Self.x = x
		Self.y = y
		Self.w = w
		Self.h = h
		
		list.AddLast(Self)
	End
	
	Method SetColour:Void(r:Int, g:Int, b:Int)
		Self.r = r
		Self.g = g
		Self.b = b
	End
	
	Method Update:Void()
		If RectsOverlap(MouseX(), MouseY(), 3, 3, Self.x, Self.y, Self.w, Self.h)
			mouseOver = True
			If MouseHit(MOUSE_LEFT)
				If Not clicked
					clicked = True
				End
			Else
				clicked = False
			End
		Else
			clicked = False
			mouseOver = False
		End
	End
	
	Method Draw:Void()
		Local light:Int = -25
		If mouseOver
			light = 120
		End
		SetColor (r + light, g + light, b + light)
		DrawRect (x, y, w, h)
		SetColor (255, 255, 255)
		DrawText (label, x + 2, y + 2)
	End
	
	Function DrawAll:Void()
		For Local b:Button = Eachin list
			b.Draw()
		End
	End
	
	Function Clicked:Int(name:String)
		name = name.ToUpper()
		If name = clickedName
			clickedName = ""
			Return 1		
		Else
			Return 0
		End
	End
	
	Function UpdateAll:Void()
		clickedName = ""
		For Local b:Button = Eachin list
			b.Update()
			If b.clicked Then clickedName = b.name
		End
	End
End

Function RectsOverlap:Int(x0:Float, y0:Float, w0:Float, h0:Float, x2:Float, y2:Float, w2:Float, h2:Float)
	If x0 &gt; (x2 + w2) Or (x0 + w0) &lt; x2 Then Return False
	If y0 &gt; (y2 + h2) Or (y0 + h0) &lt; y2 Then Return False
	Return True
End

'-------------------------- Monkey Spriter Code --------------------------
Class MonkeySpriter
	Field textures:TextureProvider = New TextureProvider()
	Field folders:IntMap&lt;SpriterFolder&gt;
	Field entities:IntMap&lt;SpriterEntity&gt;
	Field mainPath:String
	Field animationName:String
	Field nextKeyTime:Int
	Field mainlineKeyId:Int
	Field timer:Timer
	Const LOOPING_FALSE:Int = 0
	Const LOOPING_TRUE:Int = 1
	Const LOOPING_PING_PONG:Int = 2
	
	Method New()
		Self.folders = New IntMap&lt;SpriterFolder&gt;
		Self.entities = New IntMap&lt;SpriterEntity&gt;
		mainlineKeyId = 0
		timer = New Timer
	End

	Method Update:Void(animationName:String, looping:Int = LOOPING_TRUE, timeElapsed:Int)
		Self.animationName = animationName
		If Not timer.stopped
			timer.Update(timeElapsed)
			Local animation:SpriterAnimation = entities.Get(0).animations.Get(animationName)
			If looping &lt;&gt; "" Then
				animation.looping = looping
			End
			Local mainline:SpriterMainline = animation.mainline
			If timer.GetTime() &gt;= animation.length
				If animation.looping = LOOPING_TRUE
					timer.Reset()
				Else If animation.looping = LOOPING_PING_PONG
					timer.direction = timer.DOWN
				Else If animation.looping = LOOPING_FALSE
					timer.Stop()
				End
			End
			If animation.looping = LOOPING_PING_PONG And timer.GetTime() &lt;= 0
				timer.direction = timer.UP
				timer.Reset()
			End
		End		
	End
	
	Method Draw:Void(offsetX:Float, offsetY:Float, tween:Bool = False)
		Local anim:SpriterAnimation = entities.Get(0).animations.Get(animationName)
		Local mainline:SpriterMainline = anim.mainline
		
		Local time:Float = timer.GetTime()
		mainlineKeyId = mainline.GetKeyViaTime(time).id
		Local mainlineKey:SpriterKey = mainline.keys.Get(mainlineKeyId)

		For Local i:Int = Eachin mainlineKey.objectRefs.Keys()
			Local objRef:SpriterObjectRef = mainlineKey.objectRefs.Get(i)
			Local timeline:SpriterTimeline = anim.timelines.Get(objRef.timeline)
			Local timelineKey:SpriterKey = timeline.GetKeyViaTime(time)
			Local nextTimelineKey:SpriterKey = timeline.keys.Get(objRef.key + 1)
			Local nextKeyTime:Int
			
			If nextTimelineKey = Null Then
				If anim.looping = LOOPING_TRUE
					nextTimelineKey = timeline.keys.Get(0)
					nextKeyTime = anim.length
					' next timeline might not start at the beginning of the animation
					If nextTimelineKey.time &gt; 0 Then
						nextKeyTime += nextTimelineKey.time
					End
				Else If anim.looping = LOOPING_PING_PONG
					If timer.direction = timer.UP
						nextKeyTime = anim.length
					Else
						nextKeyTime = 0
					End
					nextTimelineKey = timelineKey
				Else If anim.looping = LOOPING_FALSE
					nextTimelineKey = timelineKey
					nextKeyTime = anim.length	
				End
			Else
				nextKeyTime = nextTimelineKey.time
			End
			
			Local nextO:SpriterObject = nextTimelineKey.objects.Last()

			For Local o:SpriterObject = Eachin timelineKey.objects
				Local folder:SpriterFolder = Self.folders.Get(o.folder)
				Local file:SpriterFile = folder.files.Get(o.file)
				Local texture:Image = textures.GetTexture(Self.mainPath + "/" + file.name.ToUpper())
				Local px:Float = o.pivotX * texture.Width()
				Local py:Float = texture.Height() + (-o.pivotY * texture.Height())
				If o.pivotY = 0 Then py = 0
				If o.pivotX = 0 Then px = 0
				texture.SetHandle(px, py)
				If tween
					Local tweenedX:Float = LinearInterpolation(o.x, nextO.x, timelineKey.time, nextKeyTime, timer.GetTime())
					Local tweenedY:Float = LinearInterpolation(o.y, nextO.y, timelineKey.time, nextKeyTime, timer.GetTime())
					Local tweenedAngle:Float = AngleLinearInterpolation(o.angle, nextO.angle, timelineKey.time, nextKeyTime, timer.GetTime())
					Local tweenedScaleX:Float = LinearInterpolation(o.scaleX, nextO.scaleX, timelineKey.time, nextKeyTime, timer.GetTime())
					Local tweenedScaleY:Float = LinearInterpolation(o.scaleY, nextO.scaleY, timelineKey.time, nextKeyTime, timer.GetTime())
					Local tweenedAlpha:Float = LinearInterpolation(o.alpha, nextO.alpha, timelineKey.time, nextKeyTime, timer.GetTime())
					SetAlpha(tweenedAlpha)
					DrawImage(texture, tweenedX + offsetX, -tweenedY + offsetY, tweenedAngle, tweenedScaleX, tweenedScaleY, 0)
				Else
					SetAlpha(o.alpha)
					DrawImage(texture, o.x + offsetX, -o.y + offsetY, o.angle, o.scaleX, o.scaleY, 0)
				End
			Next
			SetAlpha(1)
		Next
	End
	
	Method LinearInterpolation:Float(a:Float, b:Float, timeA:Float, timeB:Float, currentTime:Float)
		Return a + ((b - a) * ((currentTime - timeA) / (timeB - timeA)))
	End
	
	Method AngleLinearInterpolation:Float(a:Float, b:Float, timeA:Float, timeB:Float, currentTime:Float)
		return a + (AngleDifference(b, a) * ((currentTime - timeA) / (timeB - timeA)))
	End
	
	Method AngleDifference:Float(a:Float, b:Float)
		Return ((((a - b) Mod 360) + 540) Mod 360) - 180
	End
End

Class SpriterFolder
	Field files:IntMap&lt;SpriterFile&gt;
	Field id:Int
	Field name:String
	
	Method New()
		Self.files = New IntMap&lt;SpriterFile&gt;
	End
End

Class SpriterFile
	Field id:Int
	Field name:String
	Field width:Int
	Field height:Int
End

Class SpriterEntity
	Field id:Int
	Field name:String
	Field animations:StringMap&lt;SpriterAnimation&gt;
	
	Method New()
		Self.animations = New StringMap&lt;SpriterAnimation&gt;
	End
End

Class SpriterAnimation
	Field id:Int
	Field name:String
	Field length:Int
	Field looping:Int
	Field mainline:SpriterMainline
	Field timelines:IntMap&lt;SpriterTimeline&gt;
	Field maxKey:Int
	
	Method New()
		Self.mainline = New SpriterMainline
		Self.timelines = New IntMap&lt;SpriterTimeline&gt;
	End
End

Class SpriterMainline
	Field keys:IntMap&lt;SpriterKey&gt;
	Field keyId:Int = 0
	Field delay:Float = 0
	Field maxDelay:Int = 5
	Field speed:Float = 1.5
	Field maxKey:Int
		
	Method New()
		Self.keys = New IntMap&lt;SpriterKey&gt;
	End
		
	Method GetKey:SpriterKey(timer:Timer)
		Local rv:SpriterKey = Self.keys.Get(0)
		For Local i:Int = Eachin Self.keys.Keys()
			Local key:SpriterKey = Self.keys.Get(i)
			If key.time &gt; timer.GetTime()
				Return rv
			End
			rv = key
		Next
		Return rv
	End
	
	Method GetKeyViaTime:SpriterKey(time:Float)
		Local rv:SpriterKey = Self.keys.Get(0)
		For Local i:Int = Eachin Self.keys.Keys()
			Local key:SpriterKey = Self.keys.Get(i)
			If key.time &gt; time
				Return rv
			End
			rv = key
		Next
		Return rv
	End

End

Class SpriterKey
	Field id:Int
	Field time:Int
	Field spin:Int
	Field objectRefs:IntMap&lt;SpriterObjectRef&gt;
	Field objects:List&lt;SpriterObject&gt;
	
	Method New()
		Self.objectRefs = New IntMap&lt;SpriterObjectRef&gt;
		Self.objects = New List&lt;SpriterObject&gt;
	End
End

Class SpriterObjectRef
	Field id:Int
	Field timeline:Int
	Field key:Int
	Field zIndex:Int
End

Class SpriterTimeline
	Field id:Int
	Field keys:IntMap&lt;SpriterKey&gt;
	Field keyId:Int = 0
	Field delay:Float = 0
	Field maxDelay:Int = 5
	Field speed:Float = 1.5
	Field maxKey:Int
	
	Method New()
		Self.keys = New IntMap&lt;SpriterKey&gt;
	End
	
	Method GetKey:SpriterKey(timer:Timer)
		Local rv:SpriterKey = Self.keys.Get(0)
		For Local i:Int = Eachin Self.keys.Keys()
			Local key:SpriterKey = Self.keys.Get(i)
			If key.time &gt; timer.GetTime()
				Return rv
			End
			rv = key
		Next
		Return rv
	End
	
	Method GetKeyViaTime:SpriterKey(time:Float)
		Local rv:SpriterKey = Self.keys.Get(0)
		For Local i:Int = Eachin Self.keys.Keys()
			Local key:SpriterKey = Self.keys.Get(i)
			If key.time &gt; time
				Return rv
			End
			rv = key
		Next
		Return rv
	End

End

Class SpriterObject
	Field folder:Int
	Field file:Int
	Field x:Float
	Field y:Float
	Field pivotX:Float
	Field pivotY:Float
	Field angle:Float
	Field scaleX:Float
	Field scaleY:Float
	Field alpha:Float
End

Class SpriterImporter
	Function ImportFile:MonkeySpriter(path:String, file:String, debug:Bool = False)
		If debug Then Print "Importing " + path + "/" + file

		Local str:String = LoadString(path + "/" + file)
		If str = "" Then Error "Error loading file..."
		
		Local xmlReader:XMLParser = New XMLParser		
		Local doc:XMLDocument = xmlReader.ParseString(str)
		Local rootElement:XMLElement = doc.Root

		Local smo:MonkeySpriter = New MonkeySpriter()
		smo.mainPath = path
		For Local folderElement:XMLElement = Eachin rootElement.GetChildrenByName("folder")
			Local folder:SpriterFolder = New SpriterFolder()
			folder.id = Int(folderElement.GetAttribute("id"))
			folder.name = folderElement.GetAttribute("name")
			If debug Print "folder = " + folder.id + " " + folder.name
			
			For Local fileElement:XMLElement = Eachin folderElement.GetChildrenByName("file")
				Local file:SpriterFile = New SpriterFile()
				file.id = Int(fileElement.GetAttribute("id"))
				file.name = fileElement.GetAttribute("name")
				file.width = Int(fileElement.GetAttribute("width"))
				file.height = Int(fileElement.GetAttribute("height"))
				
				If debug Print "file = " + file.id + " " + file.name
				smo.textures.Load(path + "/" + file.name)
				
				folder.files.Add(file.id, file)
			Next
			smo.folders.Add(folder.id, folder)
		Next
		
		For Local entityElement:XMLElement = Eachin rootElement.GetChildrenByName("entity")
			Local entity:SpriterEntity = New SpriterEntity()
			Local id:String = entityElement.GetAttribute("id")
			Local name:String = entityElement.GetAttribute("name")
			
			If debug Print "entity = " + id + " " + name
			For Local animationElement:XMLElement = Eachin entityElement.GetChildrenByName("animation")
				Local animation:SpriterAnimation = New SpriterAnimation()
				animation.id  = Int(animationElement.GetAttribute("id"))
				animation.name = animationElement.GetAttribute("name")
				animation.length = Int(animationElement.GetAttribute("length"))
				Local looping:String = animationElement.GetAttribute("looping", MonkeySpriter.LOOPING_FALSE)
				Select looping
					Case "true"
						animation.looping = MonkeySpriter.LOOPING_TRUE
					Case "false"
						animation.looping = MonkeySpriter.LOOPING_FALSE
					Case "ping_pong"
						animation.looping = MonkeySpriter.LOOPING_PING_PONG
				End

				If debug Print "animation = " + animation.id + " " + animation.name
				
				' Should only be one mainline element
				For Local mainlineElement:XMLElement = Eachin animationElement.GetChildrenByName("mainline")
					For Local keyElement:XMLElement = Eachin mainlineElement.GetChildrenByName("key")
						Local skey:SpriterKey = New SpriterKey()
						skey.id = Int(keyElement.GetAttribute("id"))
						skey.time= Int(keyElement.GetAttribute("time", "0"))
						If debug Print "key = " + skey.id + " " + skey.time

						For Local objectRefElement:XMLElement = Eachin keyElement.GetChildrenByName("object_ref")
							Local objectRef:SpriterObjectRef = New SpriterObjectRef
							objectRef.id = Int(objectRefElement.GetAttribute("id"))
							objectRef.timeline = Int(objectRefElement.GetAttribute("timeline"))
							objectRef.key = Int(objectRefElement.GetAttribute("key"))
							objectRef.zIndex = Int(objectRefElement.GetAttribute("z_index"))
							If debug Print "object_ref = " + objectRef.id + " " + objectRef.timeline
							
							skey.objectRefs.Add(objectRef.id, objectRef)
						Next
						animation.mainline.keys.Add(skey.id, skey)
						animation.maxKey = skey.id
					Next	
				Next
				
				For Local timelineElement:XMLElement = Eachin animationElement.GetChildrenByName("timeline")
					Local timeline:SpriterTimeline = New SpriterTimeline()
					timeline.id = Int(timelineElement.GetAttribute("id"))
					If debug Print "timeline = " + timeline.id
					
					For Local keyElement:XMLElement = Eachin timelineElement.GetChildrenByName("key")
						Local key:SpriterKey = New SpriterKey()
						key.id = Int(keyElement.GetAttribute("id"))
						key.time = Int(keyElement.GetAttribute("time", "0"))
						key.spin = Int(keyElement.GetAttribute("spin", "1"))
						If debug Print "key = " + key.id + " " + key.time + " " + key.spin
						
						For Local objectElement:XMLElement = Eachin keyElement.GetChildrenByName("object")						
							Local o:SpriterObject = New SpriterObject()
							o.folder = Int(objectElement.GetAttribute("folder"))
							o.file = Int(objectElement.GetAttribute("file"))
							o.x = Float(objectElement.GetAttribute("x", "0"))
							o.y = Float(objectElement.GetAttribute("y", "0"))
							o.pivotX = Float(objectElement.GetAttribute("pivot_x", "0"))
							o.pivotY = Float(objectElement.GetAttribute("pivot_y", "0"))
							o.angle = Float(objectElement.GetAttribute("angle", "0"))
							o.scaleX = Float(objectElement.GetAttribute("scale_x", "1"))
							o.scaleY = Float(objectElement.GetAttribute("scale_y", "1"))
							o.alpha = Float(objectElement.GetAttribute("a", "1"))
							
							If debug Print "object = " + o.folder + " " + o.file + " " + o.angle
														
							key.objects.AddLast(o)
						Next
						timeline.keys.Add(key.id, key)
					Next
					animation.timelines.Add(timeline.id, timeline)
				Next
				entity.animations.Add(animation.name, animation)
			Next
			smo.entities.Add(entity.id, entity)
		Next
		Return smo
	End
End

Class TextureProvider Extends StringMap&lt;Image&gt;
	Method Load:Image(name:String)
		Local storeKey:String = name.ToUpper()

		Local i:Image = New Image
		Local imgName:String = name

		i = LoadImage(imgName )', 1, flags)
		If i = Null
			Error "Error loading image "+name
		End
		'Print "storing "+storeKey
		Self.Set(storeKey, i)
		Return i
	End
	
	Method DisplayAllStored:Void()
		' debug: print all keys in the map
		For Local key:String = Eachin Self.Keys()
			Print key + " is stored in the map."
		Next
	End
	
	Method GetTexture:Image(name:String)
		name = name.ToUpper()
	   	
		Local i:Image= Self.Get(name)
		If i = Null Then Error("Image '" + name + "' not found in the TextureProvider")
		Return i
	End	
End

Class Timer
	Field stopped:Bool
	Field rate:Float
	Const UP:Int = 1
	Const DOWN:Int = -1
	Field direction:Int
	Field count:Float
	
	Method New()
		stopped = True
		rate = 1
		direction = UP
	End
	
	Method Start:Void()
		Reset()
		Resume()
		rate = 1
	End
	
	Method Stop:Void()
		If Not stopped
			stopped = True
		End
	End
	
	Method Resume:Void()
		If stopped
			stopped = False
		End
	End
	
	Method Reset:Void()
		count = 0
		direction = UP
	End
	
	Method GetTime:Float()
		Return count / rate
	End

	Method Update:Void(timeElapsed:Int)
		If direction = UP
			count+=timeElapsed
		Else
			count-=timeElapsed
		End
	End
End</textarea> <br><br></td></tr></table><br>
<a name="1177248"></a>

<a name="1177263"></a>

<a name="1177264"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >SLotman</td><td align="right"><font class=tiny>(Posted 2013)</font>&nbsp;<a href="#2">[#2]</a></td></tr></table></td></tr><tr ><td class="posttext"> I had to change "MonkeySpriter" draw code to get it to work, but it worked really well here!<br><br><pre class=code>
	Method Draw:Void(offsetX:Float, offsetY:Float, tween:Bool = False)
		Local anim:SpriterAnimation = entities.Get(0).animations.Get(animationName)
		<b>If anim=Null Then Return</b>
(...)
</pre><br><br>Just added the null check and it's running solid :)<br>(I had to comment out everything "hero" related, since on their page they only have the monster example to download)<br><br>I can't thank you enough for this, I now have to write tons of code to see if this can be used in a game I'll make :D<br><br>Edit: Is it possible to mirror/scale the whole animation in code? Or even to 'hide' parts of the animation? (Like setting an arm alpha to zero or something?) <br><br></td></tr></table><br>
<a name="1177265"></a>

<a name="1177267"></a>

<a name="1177286"></a>

<a name="1177287"></a>

<a name="1177288"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >therevills</td><td align="right"><font class=tiny>(Posted 2013)</font>&nbsp;<a href="#3">[#3]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> If anim=Null Then Return <br></div><br>Thanks for that! I did mean to change on how that part works, but I totally forgot to do it when my head was in between tweening and keyframes...<br><br><div class="quote"> Is it possible to mirror/scale the whole animation in code? <br></div><br><strike>Should be... I'm using the local scale commands within the DrawImage, so using the global matrix it should work.</strike> See code below...<br><br><div class="quote"> Or even to 'hide' parts of the animation? (Like setting an arm alpha to zero or something?)  <br></div><br>You can change object's alpha in Spriter itself and the code should read that.<br><br>Updated code, to scale animation.... need to fix flipping animation, currently doesn't support flipping Y.<br><textarea class=codebox name="code" wrap=OFF readonly="true" rows="15" cols="80">#TEXT_FILES="*.txt|*.xml|*.json|*.SCML|*.scml"
Strict
Import mojo
Import diddy.xml

Function Main:Int()
	New Game()
	Return 0
End

'-------------------------- Monkey Spriter Demo --------------------------
Class Game Extends App
	
	Field monster:MonkeySpriter
	Field hero:MonkeySpriter

	Const IDLE:String = "Idle"
	Const POSTURE:String = "Posture"
	Field monsterAnimName:String = IDLE
	
	Const IDLEH:String = "idle_healthy"
	Const WALK:String = "walk"
	Field heroAnimName:String = IDLEH

	Field x:Float, y:Float
	Field flip:Bool
	Field lastMillisecs:Int
	Field currentMillisecs:Int 
	Field timeElapsed:Int
	Field tween:Bool = True
	Field loopType:Int
	Field scale:Float = 1
	
	Method OnCreate:Int()
		monster = SpriterImporter.ImportFile("monster", "Example.SCML")
		hero = SpriterImporter.ImportFile("example hero", "BetaFormatHero.SCML")
		x = DeviceWidth() / 2
		y = DeviceHeight() - 20
		monster.timer.Start()
		hero.timer.Start()		
		SetUpdateRate(60)
		lastMillisecs = Millisecs()
		loopType = MonkeySpriter.LOOPING_TRUE
		CreateGUI()
		Return 0
	End
	
	Method CreateGUI:Void()
		Local b:Button = New Button("Anim 1", 0, 10, 100, 20)
		b.SetColour(255, 0, 0)
		b = New Button("Anim 2", 110, 10, 100, 20)

		b = New Button("Loop Type", 220, 10, 100, 20)
		b.SetColour(255, 255, 0)
		
		b = New Button("Reset Timer", 330, 10, 100, 20)
		b.SetColour(255, 0, 255)
		
		b = New Button("Stop Timer", 440, 10, 100, 20)
		b.SetColour(0, 255, 255)
		
		b = New Button("Resume Timer", 550, 10, 100, 20)
		b.SetColour(0, 255, 0)
		
		b = New Button("Slower", 440, 40, 100, 20)
		b.SetColour(100, 100, 100)
		
		b = New Button("Faster", 550, 40, 100, 20)
		b.SetColour(0, 0, 255)
		
		b = New Button("Tween On/Off", 220, 40, 100, 20)
		b.SetColour(25, 255, 25)

		b = New Button("Flip", 330, 40, 100, 20)
		b.SetColour(25, 255, 125)	
			
		b = New Button("Scale Up", 0, 40, 100, 20)
		b.SetColour(255, 33, 125)	
		
		b = New Button("Scale Down", 110, 40, 100, 20)
		b.SetColour(125, 0, 125)	

	End
	
	
	Method OnUpdate:Int()
		' simple delta timing
		currentMillisecs = Millisecs()
		timeElapsed = currentMillisecs - lastMillisecs 
		lastMillisecs = currentMillisecs

		hero.Update(heroAnimName, loopType, timeElapsed)
		monster.Update(monsterAnimName, loopType, timeElapsed)
		
		Controls()
		Return 0
	End	
	
	Method OnRender:Int()
		Cls
		If Not flip
			monster.Draw(x, y, tween, scale, scale)
			hero.Draw(x-200, y, tween, scale, scale)
		Else
			monster.Draw(x, y, tween, -scale, scale)
			hero.Draw(x-200, y, tween, -scale, scale)
		End
		
		Button.DrawAll()
		DrawDebug()
		Return 0
	End
	
	Method Controls:Void()
		Button.UpdateAll()
		If Button.Clicked("Scale Up") Then
			scale += .05
		End
		If Button.Clicked("Scale Down") Then
			scale -= .05
		End
		If Button.Clicked("Flip") Then
			flip = Not flip
		End
		If Button.Clicked("Stop Timer") Then
			monster.timer.Stop()
			hero.timer.Stop()
		End
		If Button.Clicked("Resume Timer") Then
			monster.timer.Resume()
			hero.timer.Resume()
		End
		If Button.Clicked("Reset Timer") Then
			monster.timer.Start()
			hero.timer.Start()
			monster.mainlineKeyId = 0
			hero.mainlineKeyId = 0
		End
		If Button.Clicked("Faster") Then
			hero.timer.rate/=1.1
			monster.timer.rate/=1.1
		End
		If Button.Clicked("Slower") Then
			hero.timer.rate*=1.1
			monster.timer.rate*=1.1
		End
		If Button.Clicked("Anim 1") Then
			monsterAnimName = IDLE
			heroAnimName = IDLEH
			monster.mainlineKeyId = 0
			monster.timer.Start()
			hero.mainlineKeyId = 0
			hero.timer.Start()
		End
		If Button.Clicked("Anim 2") Then
			monsterAnimName = POSTURE
			heroAnimName = WALK
			monster.mainlineKeyId = 0
			monster.timer.Start()
			hero.mainlineKeyId = 0
			hero.timer.Start()
		End
		If Button.Clicked("Tween On/Off") Then
			tween = Not tween
		End
		If Button.Clicked("Loop Type") Then
			monster.timer.Start()
			hero.timer.Start()
			monster.mainlineKeyId = 0
			hero.mainlineKeyId = 0
			loopType += 1
			If loopType &gt; 2 loopType = 0
		End
		
		If KeyDown(KEY_W) y-=2
		If KeyDown(KEY_S) y+=2
		If KeyDown(KEY_A) x-=2
		If KeyDown(KEY_D) x+=2
	End
	
	Method DrawDebug:Void()
		Local y:Int = 100
		Local gap:Int = 15
		DrawText("MONKEY SPRITER IMPORTER", 10, y)
		y+=gap
		y+=gap
		DrawText("Monster Timer = " + monster.timer.GetTime(), 10, y)
		y+=gap
		DrawText("Hero Timer    = " + hero.timer.GetTime(), 10, y)
		y+=gap
		DrawText("Time Elapsed  = " + timeElapsed, 10, y)
		y+=gap
		Local loopString:String
		Select loopType
			Case 0
				loopString = "FALSE"
			Case 1
				loopString = "TRUE"
			Case 2
				loopString = "PING PONG"
		End
		DrawText("Looping Type  = " + loopString, 10, y)
		y+=gap
		DrawText("Timer Speed   = " + monster.timer.rate, 10, y)
		y+=gap
		If tween
			DrawText("Tweening      = TRUE", 10, y)
		Else
			DrawText("Tweening      = FALSE", 10, y)
		End
		y+=gap
	End
End
'-------------------------- Simple Button --------------------------
Class Button
	Field x:Int, y:Int
	Field w:Int, h:Int
	Field label:String
	Field name:String
	Field r:Int = 255, g:Int = 255, b:Int = 255
	Field mouseOver:Bool = False
	Field clicked:Bool = False
	Global clickedName:String = ""
	Global list:List&lt;Button&gt;
	
	Method New(label:String, x:Int, y:Int, w:Int, h:Int)
		If list = Null Then list = New List&lt;Button&gt;
		Self.label = label
		Self.name = label.ToUpper()
		Self.x = x
		Self.y = y
		Self.w = w
		Self.h = h
		
		list.AddLast(Self)
	End
	
	Method SetColour:Void(r:Int, g:Int, b:Int)
		Self.r = r
		Self.g = g
		Self.b = b
	End
	
	Method Update:Void()
		If RectsOverlap(MouseX(), MouseY(), 3, 3, Self.x, Self.y, Self.w, Self.h)
			mouseOver = True
			If MouseHit(MOUSE_LEFT)
				If Not clicked
					clicked = True
				End
			Else
				clicked = False
			End
		Else
			clicked = False
			mouseOver = False
		End
	End
	
	Method Draw:Void()
		Local light:Int = -25
		If mouseOver
			light = 120
		End
		SetColor (r + light, g + light, b + light)
		DrawRect (x, y, w, h)
		SetColor (255, 255, 255)
		DrawText (label, x + 2, y + 2)
	End
	
	Function DrawAll:Void()
		For Local b:Button = Eachin list
			b.Draw()
		End
	End
	
	Function Clicked:Int(name:String)
		name = name.ToUpper()
		If name = clickedName
			clickedName = ""
			Return 1		
		Else
			Return 0
		End
	End
	
	Function UpdateAll:Void()
		clickedName = ""
		For Local b:Button = Eachin list
			b.Update()
			If b.clicked Then clickedName = b.name
		End
	End
End

Function RectsOverlap:Int(x0:Float, y0:Float, w0:Float, h0:Float, x2:Float, y2:Float, w2:Float, h2:Float)
	If x0 &gt; (x2 + w2) Or (x0 + w0) &lt; x2 Then Return False
	If y0 &gt; (y2 + h2) Or (y0 + h0) &lt; y2 Then Return False
	Return True
End

'-------------------------- Monkey Spriter Code --------------------------
Class MonkeySpriter
	Field textures:TextureProvider = New TextureProvider()
	Field folders:IntMap&lt;SpriterFolder&gt;
	Field entities:IntMap&lt;SpriterEntity&gt;
	Field mainPath:String
	Field animationName:String
	Field nextKeyTime:Int
	Field mainlineKeyId:Int
	Field timer:Timer
	Const LOOPING_FALSE:Int = 0
	Const LOOPING_TRUE:Int = 1
	Const LOOPING_PING_PONG:Int = 2
	
	Method New()
		Self.folders = New IntMap&lt;SpriterFolder&gt;
		Self.entities = New IntMap&lt;SpriterEntity&gt;
		mainlineKeyId = 0
		timer = New Timer
	End

	Method Update:Void(animationName:String, looping:Int = LOOPING_TRUE, timeElapsed:Int)
		Self.animationName = animationName
		If Not timer.stopped
			timer.Update(timeElapsed)
			Local animation:SpriterAnimation = entities.Get(0).animations.Get(animationName)
			If looping &lt;&gt; "" Then
				animation.looping = looping
			End
			Local mainline:SpriterMainline = animation.mainline
			If timer.GetTime() &gt;= animation.length
				If animation.looping = LOOPING_TRUE
					timer.Reset()
				Else If animation.looping = LOOPING_PING_PONG
					timer.direction = timer.DOWN
				Else If animation.looping = LOOPING_FALSE
					timer.Stop()
				End
			End
			If animation.looping = LOOPING_PING_PONG And timer.GetTime() &lt;= 0
				timer.direction = timer.UP
				timer.Reset()
			End
		End		
	End
	
	Method Draw:Void(offsetX:Float, offsetY:Float, tween:Bool = False, scaleX:Float = 1, scaleY:Float = 1)
		Local anim:SpriterAnimation = entities.Get(0).animations.Get(animationName)
		If anim = Null Return
		Local mainline:SpriterMainline = anim.mainline
		
		Local time:Float = timer.GetTime()
		mainlineKeyId = mainline.GetKeyViaTime(time).id
		Local mainlineKey:SpriterKey = mainline.keys.Get(mainlineKeyId)

		For Local i:Int = Eachin mainlineKey.objectRefs.Keys()
			Local objRef:SpriterObjectRef = mainlineKey.objectRefs.Get(i)
			Local timeline:SpriterTimeline = anim.timelines.Get(objRef.timeline)
			Local timelineKey:SpriterKey = timeline.GetKeyViaTime(time)
			Local nextTimelineKey:SpriterKey = timeline.keys.Get(objRef.key + 1)
			Local nextKeyTime:Int
			
			If nextTimelineKey = Null Then
				If anim.looping = LOOPING_TRUE
					nextTimelineKey = timeline.keys.Get(0)
					nextKeyTime = anim.length
					' next timeline might not start at the beginning of the animation
					If nextTimelineKey.time &gt; 0 Then
						nextKeyTime += nextTimelineKey.time
					End
				Else If anim.looping = LOOPING_PING_PONG
					If timer.direction = timer.UP
						nextKeyTime = anim.length
					Else
						nextKeyTime = 0
					End
					nextTimelineKey = timelineKey
				Else If anim.looping = LOOPING_FALSE
					nextTimelineKey = timelineKey
					nextKeyTime = anim.length	
				End
			Else
				nextKeyTime = nextTimelineKey.time
			End
			
			Local nextO:SpriterObject = nextTimelineKey.objects.Last()

			For Local o:SpriterObject = Eachin timelineKey.objects
				Local folder:SpriterFolder = Self.folders.Get(o.folder)
				Local file:SpriterFile = folder.files.Get(o.file)
				Local texture:Image = textures.GetTexture(Self.mainPath + "/" + file.name.ToUpper())
				Local px:Float = o.pivotX * texture.Width()
				Local py:Float = texture.Height() + (-o.pivotY * texture.Height())
				If o.pivotY = 0 Then py = 0
				If o.pivotX = 0 Then px = 0
				texture.SetHandle(px, py)
				Local currentAngle:Float
				Local nextAngle:Float
				If scaleX &lt; 0
					currentAngle = -o.angle
					nextAngle = -nextO.angle
				Else
					currentAngle = o.angle
					nextAngle = nextO.angle
				End
				If tween
					Local tweenedX:Float = LinearInterpolation(o.x, nextO.x, timelineKey.time, nextKeyTime, timer.GetTime())
					Local tweenedY:Float = LinearInterpolation(o.y, nextO.y, timelineKey.time, nextKeyTime, timer.GetTime())
					Local tweenedAngle:Float = AngleLinearInterpolation(currentAngle, nextAngle, timelineKey.time, nextKeyTime, timer.GetTime())
					Local tweenedScaleX:Float = LinearInterpolation(o.scaleX, nextO.scaleX, timelineKey.time, nextKeyTime, timer.GetTime())
					Local tweenedScaleY:Float = LinearInterpolation(o.scaleY, nextO.scaleY, timelineKey.time, nextKeyTime, timer.GetTime())
					Local tweenedAlpha:Float = LinearInterpolation(o.alpha, nextO.alpha, timelineKey.time, nextKeyTime, timer.GetTime())
					SetAlpha(tweenedAlpha)
					DrawImage(texture, tweenedX * scaleX + offsetX, -tweenedY * scaleY + offsetY, tweenedAngle, tweenedScaleX * scaleX, tweenedScaleY * scaleY, 0)
				Else
					SetAlpha(o.alpha)
					DrawImage(texture, o.x * scaleX + offsetX, -o.y * scaleY + offsetY, currentAngle, o.scaleX * scaleX, o.scaleY * scaleY, 0)
				End
			Next		
			SetAlpha(1)
		Next
	End
	
	Method LinearInterpolation:Float(a:Float, b:Float, timeA:Float, timeB:Float, currentTime:Float)
		Return a + ((b - a) * ((currentTime - timeA) / (timeB - timeA)))
	End
	
	Method AngleLinearInterpolation:Float(a:Float, b:Float, timeA:Float, timeB:Float, currentTime:Float)
		return a + (AngleDifference(b, a) * ((currentTime - timeA) / (timeB - timeA)))
	End
	
	Method AngleDifference:Float(a:Float, b:Float)
		Return ((((a - b) Mod 360) + 540) Mod 360) - 180
	End
End

Class SpriterFolder
	Field files:IntMap&lt;SpriterFile&gt;
	Field id:Int
	Field name:String
	
	Method New()
		Self.files = New IntMap&lt;SpriterFile&gt;
	End
End

Class SpriterFile
	Field id:Int
	Field name:String
	Field width:Int
	Field height:Int
End

Class SpriterEntity
	Field id:Int
	Field name:String
	Field animations:StringMap&lt;SpriterAnimation&gt;
	
	Method New()
		Self.animations = New StringMap&lt;SpriterAnimation&gt;
	End
End

Class SpriterAnimation
	Field id:Int
	Field name:String
	Field length:Int
	Field looping:Int
	Field mainline:SpriterMainline
	Field timelines:IntMap&lt;SpriterTimeline&gt;
	Field maxKey:Int
	
	Method New()
		Self.mainline = New SpriterMainline
		Self.timelines = New IntMap&lt;SpriterTimeline&gt;
	End
End

Class SpriterMainline
	Field keys:IntMap&lt;SpriterKey&gt;
	Field keyId:Int = 0
	Field delay:Float = 0
	Field maxDelay:Int = 5
	Field speed:Float = 1.5
	Field maxKey:Int
		
	Method New()
		Self.keys = New IntMap&lt;SpriterKey&gt;
	End
		
	Method GetKey:SpriterKey(timer:Timer)
		Local rv:SpriterKey = Self.keys.Get(0)
		For Local i:Int = Eachin Self.keys.Keys()
			Local key:SpriterKey = Self.keys.Get(i)
			If key.time &gt; timer.GetTime()
				Return rv
			End
			rv = key
		Next
		Return rv
	End
	
	Method GetKeyViaTime:SpriterKey(time:Float)
		Local rv:SpriterKey = Self.keys.Get(0)
		For Local i:Int = Eachin Self.keys.Keys()
			Local key:SpriterKey = Self.keys.Get(i)
			If key.time &gt; time
				Return rv
			End
			rv = key
		Next
		Return rv
	End

End

Class SpriterKey
	Field id:Int
	Field time:Int
	Field spin:Int
	Field objectRefs:IntMap&lt;SpriterObjectRef&gt;
	Field objects:List&lt;SpriterObject&gt;
	
	Method New()
		Self.objectRefs = New IntMap&lt;SpriterObjectRef&gt;
		Self.objects = New List&lt;SpriterObject&gt;
	End
End

Class SpriterObjectRef
	Field id:Int
	Field timeline:Int
	Field key:Int
	Field zIndex:Int
End

Class SpriterTimeline
	Field id:Int
	Field keys:IntMap&lt;SpriterKey&gt;
	Field keyId:Int = 0
	Field delay:Float = 0
	Field maxDelay:Int = 5
	Field speed:Float = 1.5
	Field maxKey:Int
	
	Method New()
		Self.keys = New IntMap&lt;SpriterKey&gt;
	End
	
	Method GetKey:SpriterKey(timer:Timer)
		Local rv:SpriterKey = Self.keys.Get(0)
		For Local i:Int = Eachin Self.keys.Keys()
			Local key:SpriterKey = Self.keys.Get(i)
			If key.time &gt; timer.GetTime()
				Return rv
			End
			rv = key
		Next
		Return rv
	End
	
	Method GetKeyViaTime:SpriterKey(time:Float)
		Local rv:SpriterKey = Self.keys.Get(0)
		For Local i:Int = Eachin Self.keys.Keys()
			Local key:SpriterKey = Self.keys.Get(i)
			If key.time &gt; time
				Return rv
			End
			rv = key
		Next
		Return rv
	End

End

Class SpriterObject
	Field folder:Int
	Field file:Int
	Field x:Float
	Field y:Float
	Field pivotX:Float
	Field pivotY:Float
	Field angle:Float
	Field scaleX:Float
	Field scaleY:Float
	Field alpha:Float
End

Class SpriterImporter
	Function ImportFile:MonkeySpriter(path:String, file:String, debug:Bool = False)
		If debug Then Print "Importing " + path + "/" + file

		Local str:String = LoadString(path + "/" + file)
		If str = "" Then Error "Error loading file..."
		
		Local xmlReader:XMLParser = New XMLParser		
		Local doc:XMLDocument = xmlReader.ParseString(str)
		Local rootElement:XMLElement = doc.Root

		Local smo:MonkeySpriter = New MonkeySpriter()
		smo.mainPath = path
		For Local folderElement:XMLElement = Eachin rootElement.GetChildrenByName("folder")
			Local folder:SpriterFolder = New SpriterFolder()
			folder.id = Int(folderElement.GetAttribute("id"))
			folder.name = folderElement.GetAttribute("name")
			If debug Print "folder = " + folder.id + " " + folder.name
			
			For Local fileElement:XMLElement = Eachin folderElement.GetChildrenByName("file")
				Local file:SpriterFile = New SpriterFile()
				file.id = Int(fileElement.GetAttribute("id"))
				file.name = fileElement.GetAttribute("name")
				file.width = Int(fileElement.GetAttribute("width"))
				file.height = Int(fileElement.GetAttribute("height"))
				
				If debug Print "file = " + file.id + " " + file.name
				smo.textures.Load(path + "/" + file.name)
				
				folder.files.Add(file.id, file)
			Next
			smo.folders.Add(folder.id, folder)
		Next
		
		For Local entityElement:XMLElement = Eachin rootElement.GetChildrenByName("entity")
			Local entity:SpriterEntity = New SpriterEntity()
			Local id:String = entityElement.GetAttribute("id")
			Local name:String = entityElement.GetAttribute("name")
			
			If debug Print "entity = " + id + " " + name
			For Local animationElement:XMLElement = Eachin entityElement.GetChildrenByName("animation")
				Local animation:SpriterAnimation = New SpriterAnimation()
				animation.id  = Int(animationElement.GetAttribute("id"))
				animation.name = animationElement.GetAttribute("name")
				animation.length = Int(animationElement.GetAttribute("length"))
				Local looping:String = animationElement.GetAttribute("looping", MonkeySpriter.LOOPING_FALSE)
				Select looping
					Case "true"
						animation.looping = MonkeySpriter.LOOPING_TRUE
					Case "false"
						animation.looping = MonkeySpriter.LOOPING_FALSE
					Case "ping_pong"
						animation.looping = MonkeySpriter.LOOPING_PING_PONG
				End

				If debug Print "animation = " + animation.id + " " + animation.name
				
				' Should only be one mainline element
				For Local mainlineElement:XMLElement = Eachin animationElement.GetChildrenByName("mainline")
					For Local keyElement:XMLElement = Eachin mainlineElement.GetChildrenByName("key")
						Local skey:SpriterKey = New SpriterKey()
						skey.id = Int(keyElement.GetAttribute("id"))
						skey.time= Int(keyElement.GetAttribute("time", "0"))
						If debug Print "key = " + skey.id + " " + skey.time

						For Local objectRefElement:XMLElement = Eachin keyElement.GetChildrenByName("object_ref")
							Local objectRef:SpriterObjectRef = New SpriterObjectRef
							objectRef.id = Int(objectRefElement.GetAttribute("id"))
							objectRef.timeline = Int(objectRefElement.GetAttribute("timeline"))
							objectRef.key = Int(objectRefElement.GetAttribute("key"))
							objectRef.zIndex = Int(objectRefElement.GetAttribute("z_index"))
							If debug Print "object_ref = " + objectRef.id + " " + objectRef.timeline
							
							skey.objectRefs.Add(objectRef.id, objectRef)
						Next
						animation.mainline.keys.Add(skey.id, skey)
						animation.maxKey = skey.id
					Next	
				Next
				
				For Local timelineElement:XMLElement = Eachin animationElement.GetChildrenByName("timeline")
					Local timeline:SpriterTimeline = New SpriterTimeline()
					timeline.id = Int(timelineElement.GetAttribute("id"))
					If debug Print "timeline = " + timeline.id
					
					For Local keyElement:XMLElement = Eachin timelineElement.GetChildrenByName("key")
						Local key:SpriterKey = New SpriterKey()
						key.id = Int(keyElement.GetAttribute("id"))
						key.time = Int(keyElement.GetAttribute("time", "0"))
						key.spin = Int(keyElement.GetAttribute("spin", "1"))
						If debug Print "key = " + key.id + " " + key.time + " " + key.spin
						
						For Local objectElement:XMLElement = Eachin keyElement.GetChildrenByName("object")						
							Local o:SpriterObject = New SpriterObject()
							o.folder = Int(objectElement.GetAttribute("folder"))
							o.file = Int(objectElement.GetAttribute("file"))
							o.x = Float(objectElement.GetAttribute("x", "0"))
							o.y = Float(objectElement.GetAttribute("y", "0"))
							o.pivotX = Float(objectElement.GetAttribute("pivot_x", "0"))
							o.pivotY = Float(objectElement.GetAttribute("pivot_y", "0"))
							o.angle = Float(objectElement.GetAttribute("angle", "0"))
							o.scaleX = Float(objectElement.GetAttribute("scale_x", "1"))
							o.scaleY = Float(objectElement.GetAttribute("scale_y", "1"))
							o.alpha = Float(objectElement.GetAttribute("a", "1"))
							
							If debug Print "object = " + o.folder + " " + o.file + " " + o.angle
														
							key.objects.AddLast(o)
						Next
						timeline.keys.Add(key.id, key)
					Next
					animation.timelines.Add(timeline.id, timeline)
				Next
				entity.animations.Add(animation.name, animation)
			Next
			smo.entities.Add(entity.id, entity)
		Next
		Return smo
	End
End

Class TextureProvider Extends StringMap&lt;Image&gt;
	Method Load:Image(name:String)
		Local storeKey:String = name.ToUpper()

		Local i:Image = New Image
		Local imgName:String = name

		i = LoadImage(imgName )', 1, flags)
		If i = Null
			Error "Error loading image "+name
		End
		'Print "storing "+storeKey
		Self.Set(storeKey, i)
		Return i
	End
	
	Method DisplayAllStored:Void()
		' debug: print all keys in the map
		For Local key:String = Eachin Self.Keys()
			Print key + " is stored in the map."
		Next
	End
	
	Method GetTexture:Image(name:String)
		name = name.ToUpper()
	   	
		Local i:Image= Self.Get(name)
		If i = Null Then Error("Image '" + name + "' not found in the TextureProvider")
		Return i
	End	
End

Class Timer
	Field stopped:Bool
	Field rate:Float
	Const UP:Int = 1
	Const DOWN:Int = -1
	Field direction:Int
	Field count:Float
	
	Method New()
		stopped = True
		rate = 1
		direction = UP
	End
	
	Method Start:Void()
		Reset()
		Resume()
		rate = 1
	End
	
	Method Stop:Void()
		If Not stopped
			stopped = True
		End
	End
	
	Method Resume:Void()
		If stopped
			stopped = False
		End
	End
	
	Method Reset:Void()
		count = 0
		direction = UP
	End
	
	Method GetTime:Float()
		Return count / rate
	End

	Method Update:Void(timeElapsed:Int)
		If direction = UP
			count+=timeElapsed
		Else
			count-=timeElapsed
		End
	End
End</textarea> <br><br></td></tr></table><br>
<a name="1177289"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >therevills</td><td align="right"><font class=tiny>(Posted 2013)</font>&nbsp;<a href="#4">[#4]</a></td></tr></table></td></tr><tr ><td class="posttext"> Another update, flipping Y and X works now:<br><a href="http://www.therevillsgames.com/monkey/SpriterA4/MonkeyGame.html" target="_blank">http://www.therevillsgames.com/monkey/SpriterA4/MonkeyGame.html</a><br><br><textarea class=codebox name="code" wrap=OFF readonly="true" rows="15" cols="80">#TEXT_FILES="*.txt|*.xml|*.json|*.SCML|*.scml"
Strict
Import mojo
Import diddy.xml

Function Main:Int()
	New Game()
	Return 0
End

'-------------------------- Monkey Spriter Demo --------------------------
Class Game Extends App
	
	Field monster:MonkeySpriter
	Field hero:MonkeySpriter

	Const IDLE:String = "Idle"
	Const POSTURE:String = "Posture"
	Field monsterAnimName:String = IDLE
	
	Const IDLEH:String = "idle_healthy"
	Const WALK:String = "walk"
	Field heroAnimName:String = IDLEH

	Field x:Float, y:Float
	Field flipX:Bool
	Field flipY:Bool
	Field lastMillisecs:Int
	Field currentMillisecs:Int 
	Field timeElapsed:Int
	Field tween:Bool = True
	Field loopType:Int
	Field scaleX:Float = 1
	Field scaleY:Float = 1
	Field debug:Bool
	
	Method OnCreate:Int()
		monster = SpriterImporter.ImportFile("monster", "Example.SCML")
		hero = SpriterImporter.ImportFile("example hero", "BetaFormatHero.SCML")
		x = DeviceWidth() / 2
		y = DeviceHeight() - 20
		monster.timer.Start()
		hero.timer.Start()		
		SetUpdateRate(60)
		lastMillisecs = Millisecs()
		loopType = MonkeySpriter.LOOPING_TRUE
		debug = false
		CreateGUI()
		Return 0
	End
	
	Method CreateGUI:Void()
		Local b:Button = New Button("Anim 1", 0, 10, 100, 20)
		b.SetColour(255, 0, 0)
		b = New Button("Anim 2", 110, 10, 100, 20)

		b = New Button("Loop Type", 220, 10, 100, 20)
		b.SetColour(255, 255, 0)
		
		b = New Button("Reset Timer", 330, 10, 100, 20)
		b.SetColour(255, 0, 255)
		
		b = New Button("Stop Timer", 440, 10, 100, 20)
		b.SetColour(0, 255, 255)
		
		b = New Button("Resume Timer", 550, 10, 100, 20)
		b.SetColour(0, 255, 0)
		
		b = New Button("Slower", 440, 40, 100, 20)
		b.SetColour(100, 100, 100)
		
		b = New Button("Faster", 550, 40, 100, 20)
		b.SetColour(0, 0, 255)
		
		b = New Button("Tween On/Off", 330, 40, 100, 20)
		b.SetColour(25, 255, 25)

		b = New Button("Flip X", 0, 70, 100, 20)
		b.SetColour(25, 255, 125)	

		b = New Button("Flip Y", 110, 70, 100, 20)
		b.SetColour(123, 123, 255)	

		b = New Button("Scale Up", 0, 40, 100, 20)
		b.SetColour(255, 33, 125)	
		
		b = New Button("Scale Down", 110, 40, 100, 20)
		b.SetColour(125, 0, 125)
		
		b = New Button("Debug On/Off", 220, 40, 100, 20)
		b.SetColour(125, 230, 234)	
	End
	
	Method OnUpdate:Int()
		' simple delta timing
		currentMillisecs = Millisecs()
		timeElapsed = currentMillisecs - lastMillisecs 
		lastMillisecs = currentMillisecs

		hero.Update(heroAnimName, loopType, timeElapsed)
		monster.Update(monsterAnimName, loopType, timeElapsed)
		
		Controls()
		Return 0
	End	
	
	Method OnRender:Int()
		Cls
		monster.Draw(x, y, tween, scaleX, scaleY)
		hero.Draw(x-200, y, tween, scaleX, scaleY)
	
		Button.DrawAll()
		If debug Then DrawDebug()
		Return 0
	End
	
	Method Controls:Void()
		Button.UpdateAll()
		If Button.Clicked("Debug On/Off") Then
			debug = Not debug
		End
		If Button.Clicked("Scale Up") Then
			scaleX *= 1.1
			scaleY *= 1.1
		End
		If Button.Clicked("Scale Down") Then
			scaleX /= 1.1
			scaleY /= 1.1
		End
		If Button.Clicked("Flip X") Then
			scaleX = -scaleX
		End
		If Button.Clicked("Flip Y") Then
			scaleY = -scaleY
			y = DeviceHeight() - y
		End
		If Button.Clicked("Stop Timer") Then
			monster.timer.Stop()
			hero.timer.Stop()
		End
		If Button.Clicked("Resume Timer") Then
			monster.timer.Resume()
			hero.timer.Resume()
		End
		If Button.Clicked("Reset Timer") Then
			monster.timer.Start()
			hero.timer.Start()
			monster.mainlineKeyId = 0
			hero.mainlineKeyId = 0
		End
		If Button.Clicked("Faster") Then
			hero.timer.rate/=1.1
			monster.timer.rate/=1.1
		End
		If Button.Clicked("Slower") Then
			hero.timer.rate*=1.1
			monster.timer.rate*=1.1
		End
		If Button.Clicked("Anim 1") Then
			monsterAnimName = IDLE
			heroAnimName = IDLEH
			monster.mainlineKeyId = 0
			monster.timer.Start()
			hero.mainlineKeyId = 0
			hero.timer.Start()
		End
		If Button.Clicked("Anim 2") Then
			monsterAnimName = POSTURE
			heroAnimName = WALK
			monster.mainlineKeyId = 0
			monster.timer.Start()
			hero.mainlineKeyId = 0
			hero.timer.Start()
		End
		If Button.Clicked("Tween On/Off") Then
			tween = Not tween
		End
		If Button.Clicked("Loop Type") Then
			monster.timer.Start()
			hero.timer.Start()
			monster.mainlineKeyId = 0
			hero.mainlineKeyId = 0
			loopType += 1
			If loopType &gt; 2 loopType = 0
		End
		
		If KeyDown(KEY_W) y-=2
		If KeyDown(KEY_S) y+=2
		If KeyDown(KEY_A) x-=2
		If KeyDown(KEY_D) x+=2
	End
	
	Method DrawDebug:Void()
		Local y:Int = 100
		Local gap:Int = 15
		SetAlpha(0.75)
		DrawText("MONKEY SPRITER IMPORTER", 10, y)
		y+=gap
		y+=gap
		DrawText("Monster Timer = " + monster.timer.GetTime(), 10, y)
		y+=gap
		DrawText("Hero Timer    = " + hero.timer.GetTime(), 10, y)
		y+=gap
		DrawText("Time Elapsed  = " + timeElapsed, 10, y)
		y+=gap
		Local loopString:String
		Select loopType
			Case 0
				loopString = "FALSE"
			Case 1
				loopString = "TRUE"
			Case 2
				loopString = "PING PONG"
		End
		DrawText("Looping Type  = " + loopString, 10, y)
		y+=gap
		DrawText("Timer Rate    = " + monster.timer.rate, 10, y)
		y+=gap
		If tween
			DrawText("Tweening      = TRUE", 10, y)
		Else
			DrawText("Tweening      = FALSE", 10, y)
		End
		y+=gap
		DrawText("Scale X       = " + scaleX, 10, y)
		y+=gap
		DrawText("Scale Y       = " + scaleY, 10, y)

		SetAlpha(1)
	End
End
'-------------------------- Simple Button --------------------------
Class Button
	Field x:Int, y:Int
	Field w:Int, h:Int
	Field label:String
	Field name:String
	Field r:Int = 255, g:Int = 255, b:Int = 255
	Field mouseOver:Bool = False
	Field clicked:Bool = False
	Global clickedName:String = ""
	Global list:List&lt;Button&gt;
	
	Method New(label:String, x:Int, y:Int, w:Int, h:Int)
		If list = Null Then list = New List&lt;Button&gt;
		Self.label = label
		Self.name = label.ToUpper()
		Self.x = x
		Self.y = y
		Self.w = w
		Self.h = h
		
		list.AddLast(Self)
	End
	
	Method SetColour:Void(r:Int, g:Int, b:Int)
		Self.r = r
		Self.g = g
		Self.b = b
	End
	
	Method Update:Void()
		If RectsOverlap(MouseX(), MouseY(), 3, 3, Self.x, Self.y, Self.w, Self.h)
			mouseOver = True
			If MouseHit(MOUSE_LEFT)
				If Not clicked
					clicked = True
				End
			Else
				clicked = False
			End
		Else
			clicked = False
			mouseOver = False
		End
	End
	
	Method Draw:Void()
		Local light:Int = -25
		If mouseOver
			light = 120
			SetAlpha(1)
		End
		SetColor (r + light, g + light, b + light)
		DrawRect (x, y, w, h)
		SetColor (255, 255, 255)
		DrawText (label, x + 2, y + 2)
	End
	
	Function DrawAll:Void()
		For Local b:Button = Eachin list
			SetAlpha(0.75)
			b.Draw()
		End
		SetAlpha(1)		
	End
	
	Function Clicked:Int(name:String)
		name = name.ToUpper()
		If name = clickedName
			clickedName = ""
			Return 1		
		Else
			Return 0
		End
	End
	
	Function UpdateAll:Void()
		clickedName = ""
		For Local b:Button = Eachin list
			b.Update()
			If b.clicked Then clickedName = b.name
		End
	End
End

Function RectsOverlap:Int(x0:Float, y0:Float, w0:Float, h0:Float, x2:Float, y2:Float, w2:Float, h2:Float)
	If x0 &gt; (x2 + w2) Or (x0 + w0) &lt; x2 Then Return False
	If y0 &gt; (y2 + h2) Or (y0 + h0) &lt; y2 Then Return False
	Return True
End

'-------------------------- Monkey Spriter Code --------------------------
Class MonkeySpriter
	Field textures:TextureProvider = New TextureProvider()
	Field folders:IntMap&lt;SpriterFolder&gt;
	Field entities:IntMap&lt;SpriterEntity&gt;
	Field mainPath:String
	Field animationName:String
	Field nextKeyTime:Int
	Field mainlineKeyId:Int
	Field timer:Timer
	Const LOOPING_FALSE:Int = 0
	Const LOOPING_TRUE:Int = 1
	Const LOOPING_PING_PONG:Int = 2
	
	Method New()
		Self.folders = New IntMap&lt;SpriterFolder&gt;
		Self.entities = New IntMap&lt;SpriterEntity&gt;
		mainlineKeyId = 0
		timer = New Timer
	End

	Method Update:Void(animationName:String, looping:Int = LOOPING_TRUE, timeElapsed:Int)
		Self.animationName = animationName
		If Not timer.stopped
			timer.Update(timeElapsed)
			Local animation:SpriterAnimation = entities.Get(0).animations.Get(animationName)
			If looping &lt;&gt; "" Then
				animation.looping = looping
			End
			Local mainline:SpriterMainline = animation.mainline
			If timer.GetTime() &gt;= animation.length
				If animation.looping = LOOPING_TRUE
					timer.Reset()
				Else If animation.looping = LOOPING_PING_PONG
					timer.direction = timer.DOWN
				Else If animation.looping = LOOPING_FALSE
					timer.Stop()
				End
			End
			If animation.looping = LOOPING_PING_PONG And timer.GetTime() &lt;= 0
				timer.direction = timer.UP
				timer.Reset()
			End
		End		
	End
	
	Method Draw:Void(offsetX:Float, offsetY:Float, tween:Bool = False, scaleX:Float = 1, scaleY:Float = 1)
		Local anim:SpriterAnimation = entities.Get(0).animations.Get(animationName)
		If anim = Null Return
		Local mainline:SpriterMainline = anim.mainline
		
		Local time:Float = timer.GetTime()
		mainlineKeyId = mainline.GetKeyViaTime(time).id
		Local mainlineKey:SpriterKey = mainline.keys.Get(mainlineKeyId)

		For Local i:Int = Eachin mainlineKey.objectRefs.Keys()
			Local objRef:SpriterObjectRef = mainlineKey.objectRefs.Get(i)
			Local timeline:SpriterTimeline = anim.timelines.Get(objRef.timeline)
			Local timelineKey:SpriterKey = timeline.GetKeyViaTime(time)
			Local nextTimelineKey:SpriterKey = timeline.keys.Get(objRef.key + 1)
			Local nextKeyTime:Int
			
			If nextTimelineKey = Null Then
				If anim.looping = LOOPING_TRUE
					nextTimelineKey = timeline.keys.Get(0)
					nextKeyTime = anim.length
					' next timeline might not start at the beginning of the animation
					If nextTimelineKey.time &gt; 0 Then
						nextKeyTime += nextTimelineKey.time
					End
				Else If anim.looping = LOOPING_PING_PONG
					If timer.direction = timer.UP
						nextKeyTime = anim.length
					Else
						nextKeyTime = 0
					End
					nextTimelineKey = timelineKey
				Else If anim.looping = LOOPING_FALSE
					nextTimelineKey = timelineKey
					nextKeyTime = anim.length	
				End
			Else
				nextKeyTime = nextTimelineKey.time
			End
			
			Local nextO:SpriterObject = nextTimelineKey.objects.Last()

			For Local o:SpriterObject = Eachin timelineKey.objects
				Local folder:SpriterFolder = Self.folders.Get(o.folder)
				Local file:SpriterFile = folder.files.Get(o.file)
				Local texture:Image = textures.GetTexture(Self.mainPath + "/" + file.name.ToUpper())
				Local px:Float = o.pivotX * texture.Width()
				Local py:Float = texture.Height() + (-o.pivotY * texture.Height())
				If o.pivotY = 0 Then py = 0
				If o.pivotX = 0 Then px = 0
				texture.SetHandle(px, py)
				Local currentAngle:Float = o.angle
				Local nextAngle:Float = nextO.angle

				'XOR
				If (scaleX &lt; 0) &lt;&gt; (scaleY &lt; 0) Then
					currentAngle = -currentAngle
					nextAngle = -nextAngle
				End

				If tween
					Local tweenedX:Float = LinearInterpolation(o.x, nextO.x, timelineKey.time, nextKeyTime, timer.GetTime())
					Local tweenedY:Float = LinearInterpolation(o.y, nextO.y, timelineKey.time, nextKeyTime, timer.GetTime())
					Local tweenedAngle:Float = AngleLinearInterpolation(currentAngle, nextAngle, timelineKey.time, nextKeyTime, timer.GetTime())
					Local tweenedScaleX:Float = LinearInterpolation(o.scaleX, nextO.scaleX, timelineKey.time, nextKeyTime, timer.GetTime())
					Local tweenedScaleY:Float = LinearInterpolation(o.scaleY, nextO.scaleY, timelineKey.time, nextKeyTime, timer.GetTime())
					Local tweenedAlpha:Float = LinearInterpolation(o.alpha, nextO.alpha, timelineKey.time, nextKeyTime, timer.GetTime())
					SetAlpha(tweenedAlpha)
					DrawImage(texture, tweenedX * scaleX + offsetX, -tweenedY * scaleY + offsetY, tweenedAngle, tweenedScaleX * scaleX, tweenedScaleY * scaleY, 0)
				Else
					SetAlpha(o.alpha)
					DrawImage(texture, o.x * scaleX + offsetX, -o.y * scaleY + offsetY, currentAngle, o.scaleX * scaleX, o.scaleY * scaleY, 0)
				End
			Next		
			SetAlpha(1)
		Next
	End
	
	Method LinearInterpolation:Float(a:Float, b:Float, timeA:Float, timeB:Float, currentTime:Float)
		Return a + ((b - a) * ((currentTime - timeA) / (timeB - timeA)))
	End
	
	Method AngleLinearInterpolation:Float(a:Float, b:Float, timeA:Float, timeB:Float, currentTime:Float)
		return a + (AngleDifference(b, a) * ((currentTime - timeA) / (timeB - timeA)))
	End
	
	Method AngleDifference:Float(a:Float, b:Float)
		Return ((((a - b) Mod 360) + 540) Mod 360) - 180
	End
End

Class SpriterFolder
	Field files:IntMap&lt;SpriterFile&gt;
	Field id:Int
	Field name:String
	
	Method New()
		Self.files = New IntMap&lt;SpriterFile&gt;
	End
End

Class SpriterFile
	Field id:Int
	Field name:String
	Field width:Int
	Field height:Int
End

Class SpriterEntity
	Field id:Int
	Field name:String
	Field animations:StringMap&lt;SpriterAnimation&gt;
	
	Method New()
		Self.animations = New StringMap&lt;SpriterAnimation&gt;
	End
End

Class SpriterAnimation
	Field id:Int
	Field name:String
	Field length:Int
	Field looping:Int
	Field mainline:SpriterMainline
	Field timelines:IntMap&lt;SpriterTimeline&gt;
	Field maxKey:Int
	
	Method New()
		Self.mainline = New SpriterMainline
		Self.timelines = New IntMap&lt;SpriterTimeline&gt;
	End
End

Class SpriterMainline
	Field keys:IntMap&lt;SpriterKey&gt;
	Field keyId:Int = 0
	Field delay:Float = 0
	Field maxDelay:Int = 5
	Field speed:Float = 1.5
	Field maxKey:Int
		
	Method New()
		Self.keys = New IntMap&lt;SpriterKey&gt;
	End
		
	Method GetKey:SpriterKey(timer:Timer)
		Local rv:SpriterKey = Self.keys.Get(0)
		For Local i:Int = Eachin Self.keys.Keys()
			Local key:SpriterKey = Self.keys.Get(i)
			If key.time &gt; timer.GetTime()
				Return rv
			End
			rv = key
		Next
		Return rv
	End
	
	Method GetKeyViaTime:SpriterKey(time:Float)
		Local rv:SpriterKey = Self.keys.Get(0)
		For Local i:Int = Eachin Self.keys.Keys()
			Local key:SpriterKey = Self.keys.Get(i)
			If key.time &gt; time
				Return rv
			End
			rv = key
		Next
		Return rv
	End

End

Class SpriterKey
	Field id:Int
	Field time:Int
	Field spin:Int
	Field objectRefs:IntMap&lt;SpriterObjectRef&gt;
	Field objects:List&lt;SpriterObject&gt;
	
	Method New()
		Self.objectRefs = New IntMap&lt;SpriterObjectRef&gt;
		Self.objects = New List&lt;SpriterObject&gt;
	End
End

Class SpriterObjectRef
	Field id:Int
	Field timeline:Int
	Field key:Int
	Field zIndex:Int
End

Class SpriterTimeline
	Field id:Int
	Field keys:IntMap&lt;SpriterKey&gt;
	Field keyId:Int = 0
	Field delay:Float = 0
	Field maxDelay:Int = 5
	Field speed:Float = 1.5
	Field maxKey:Int
	
	Method New()
		Self.keys = New IntMap&lt;SpriterKey&gt;
	End
	
	Method GetKey:SpriterKey(timer:Timer)
		Local rv:SpriterKey = Self.keys.Get(0)
		For Local i:Int = Eachin Self.keys.Keys()
			Local key:SpriterKey = Self.keys.Get(i)
			If key.time &gt; timer.GetTime()
				Return rv
			End
			rv = key
		Next
		Return rv
	End
	
	Method GetKeyViaTime:SpriterKey(time:Float)
		Local rv:SpriterKey = Self.keys.Get(0)
		For Local i:Int = Eachin Self.keys.Keys()
			Local key:SpriterKey = Self.keys.Get(i)
			If key.time &gt; time
				Return rv
			End
			rv = key
		Next
		Return rv
	End

End

Class SpriterObject
	Field folder:Int
	Field file:Int
	Field x:Float
	Field y:Float
	Field pivotX:Float
	Field pivotY:Float
	Field angle:Float
	Field scaleX:Float
	Field scaleY:Float
	Field alpha:Float
End

Class SpriterImporter
	Function ImportFile:MonkeySpriter(path:String, file:String, debug:Bool = False)
		If debug Then Print "Importing " + path + "/" + file

		Local str:String = LoadString(path + "/" + file)
		If str = "" Then Error "Error loading file..."
		
		Local xmlReader:XMLParser = New XMLParser		
		Local doc:XMLDocument = xmlReader.ParseString(str)
		Local rootElement:XMLElement = doc.Root

		Local smo:MonkeySpriter = New MonkeySpriter()
		smo.mainPath = path
		For Local folderElement:XMLElement = Eachin rootElement.GetChildrenByName("folder")
			Local folder:SpriterFolder = New SpriterFolder()
			folder.id = Int(folderElement.GetAttribute("id"))
			folder.name = folderElement.GetAttribute("name")
			If debug Print "folder = " + folder.id + " " + folder.name
			
			For Local fileElement:XMLElement = Eachin folderElement.GetChildrenByName("file")
				Local file:SpriterFile = New SpriterFile()
				file.id = Int(fileElement.GetAttribute("id"))
				file.name = fileElement.GetAttribute("name")
				file.width = Int(fileElement.GetAttribute("width"))
				file.height = Int(fileElement.GetAttribute("height"))
				
				If debug Print "file = " + file.id + " " + file.name
				smo.textures.Load(path + "/" + file.name)
				
				folder.files.Add(file.id, file)
			Next
			smo.folders.Add(folder.id, folder)
		Next
		
		For Local entityElement:XMLElement = Eachin rootElement.GetChildrenByName("entity")
			Local entity:SpriterEntity = New SpriterEntity()
			Local id:String = entityElement.GetAttribute("id")
			Local name:String = entityElement.GetAttribute("name")
			
			If debug Print "entity = " + id + " " + name
			For Local animationElement:XMLElement = Eachin entityElement.GetChildrenByName("animation")
				Local animation:SpriterAnimation = New SpriterAnimation()
				animation.id  = Int(animationElement.GetAttribute("id"))
				animation.name = animationElement.GetAttribute("name")
				animation.length = Int(animationElement.GetAttribute("length"))
				Local looping:String = animationElement.GetAttribute("looping", MonkeySpriter.LOOPING_FALSE)
				Select looping
					Case "true"
						animation.looping = MonkeySpriter.LOOPING_TRUE
					Case "false"
						animation.looping = MonkeySpriter.LOOPING_FALSE
					Case "ping_pong"
						animation.looping = MonkeySpriter.LOOPING_PING_PONG
				End

				If debug Print "animation = " + animation.id + " " + animation.name
				
				' Should only be one mainline element
				For Local mainlineElement:XMLElement = Eachin animationElement.GetChildrenByName("mainline")
					For Local keyElement:XMLElement = Eachin mainlineElement.GetChildrenByName("key")
						Local skey:SpriterKey = New SpriterKey()
						skey.id = Int(keyElement.GetAttribute("id"))
						skey.time= Int(keyElement.GetAttribute("time", "0"))
						If debug Print "key = " + skey.id + " " + skey.time

						For Local objectRefElement:XMLElement = Eachin keyElement.GetChildrenByName("object_ref")
							Local objectRef:SpriterObjectRef = New SpriterObjectRef
							objectRef.id = Int(objectRefElement.GetAttribute("id"))
							objectRef.timeline = Int(objectRefElement.GetAttribute("timeline"))
							objectRef.key = Int(objectRefElement.GetAttribute("key"))
							objectRef.zIndex = Int(objectRefElement.GetAttribute("z_index"))
							If debug Print "object_ref = " + objectRef.id + " " + objectRef.timeline
							
							skey.objectRefs.Add(objectRef.id, objectRef)
						Next
						animation.mainline.keys.Add(skey.id, skey)
						animation.maxKey = skey.id
					Next	
				Next
				
				For Local timelineElement:XMLElement = Eachin animationElement.GetChildrenByName("timeline")
					Local timeline:SpriterTimeline = New SpriterTimeline()
					timeline.id = Int(timelineElement.GetAttribute("id"))
					If debug Print "timeline = " + timeline.id
					
					For Local keyElement:XMLElement = Eachin timelineElement.GetChildrenByName("key")
						Local key:SpriterKey = New SpriterKey()
						key.id = Int(keyElement.GetAttribute("id"))
						key.time = Int(keyElement.GetAttribute("time", "0"))
						key.spin = Int(keyElement.GetAttribute("spin", "1"))
						If debug Print "key = " + key.id + " " + key.time + " " + key.spin
						
						For Local objectElement:XMLElement = Eachin keyElement.GetChildrenByName("object")						
							Local o:SpriterObject = New SpriterObject()
							o.folder = Int(objectElement.GetAttribute("folder"))
							o.file = Int(objectElement.GetAttribute("file"))
							o.x = Float(objectElement.GetAttribute("x", "0"))
							o.y = Float(objectElement.GetAttribute("y", "0"))
							o.pivotX = Float(objectElement.GetAttribute("pivot_x", "0"))
							o.pivotY = Float(objectElement.GetAttribute("pivot_y", "0"))
							o.angle = Float(objectElement.GetAttribute("angle", "0"))
							o.scaleX = Float(objectElement.GetAttribute("scale_x", "1"))
							o.scaleY = Float(objectElement.GetAttribute("scale_y", "1"))
							o.alpha = Float(objectElement.GetAttribute("a", "1"))
							
							If debug Print "object = " + o.folder + " " + o.file + " " + o.angle
														
							key.objects.AddLast(o)
						Next
						timeline.keys.Add(key.id, key)
					Next
					animation.timelines.Add(timeline.id, timeline)
				Next
				entity.animations.Add(animation.name, animation)
			Next
			smo.entities.Add(entity.id, entity)
		Next
		Return smo
	End
End

Class TextureProvider Extends StringMap&lt;Image&gt;
	Method Load:Image(name:String)
		Local storeKey:String = name.ToUpper()

		Local i:Image = New Image
		Local imgName:String = name

		i = LoadImage(imgName )', 1, flags)
		If i = Null
			Error "Error loading image "+name
		End
		'Print "storing "+storeKey
		Self.Set(storeKey, i)
		Return i
	End
	
	Method DisplayAllStored:Void()
		' debug: print all keys in the map
		For Local key:String = Eachin Self.Keys()
			Print key + " is stored in the map."
		Next
	End
	
	Method GetTexture:Image(name:String)
		name = name.ToUpper()
	   	
		Local i:Image= Self.Get(name)
		If i = Null Then Error("Image '" + name + "' not found in the TextureProvider")
		Return i
	End	
End

Class Timer
	Field stopped:Bool
	Field rate:Float
	Const UP:Int = 1
	Const DOWN:Int = -1
	Field direction:Int
	Field count:Float
	
	Method New()
		stopped = True
		rate = 1
		direction = UP
	End
	
	Method Start:Void()
		Reset()
		Resume()
		rate = 1
	End
	
	Method Stop:Void()
		If Not stopped
			stopped = True
		End
	End
	
	Method Resume:Void()
		If stopped
			stopped = False
		End
	End
	
	Method Reset:Void()
		count = 0
		direction = UP
	End
	
	Method GetTime:Float()
		Return count / rate
	End

	Method Update:Void(timeElapsed:Int)
		If direction = UP
			count+=timeElapsed
		Else
			count-=timeElapsed
		End
	End
End</textarea> <br><br></td></tr></table><br>
<a name="1177295"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Shagwana</td><td align="right"><font class=tiny>(Posted 2013)</font>&nbsp;<a href="#5">[#5]</a></td></tr></table></td></tr><tr ><td class="posttext"> At very slow speeds the feet of the little knight don't look right when walking. Sort of jumps and snaps to location. Is that right? <br><br></td></tr></table><br>
<a name="1177299"></a>

<a name="1177300"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >therevills</td><td align="right"><font class=tiny>(Posted 2013)</font>&nbsp;<a href="#6">[#6]</a></td></tr></table></td></tr><tr ><td class="posttext"> The Knight`s file was based off the first version of Spriter and was converted by someone, I've slightly fixed it up myself but yeah it still looks a little off... But it does in Sprinter itself. <br><br></td></tr></table><br>
<a name="1177353"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >SLotman</td><td align="right"><font class=tiny>(Posted 2013)</font>&nbsp;<a href="#7">[#7]</a></td></tr></table></td></tr><tr ><td class="posttext"> I just did some changes in the code - don't know if anyone will find it useful, but it's really good for me:<br><br><textarea class=codebox name="code" wrap=OFF readonly="true" rows="15" cols="80">
#TEXT_FILES="*.txt|*.xml|*.json|*.SCML|*.scml"
Strict
Import mojo
Import diddy.xml
Import autofit

Function Main:Int()
	New Game()
	Return 0
End

'-------------------------- Monkey Spriter Demo --------------------------
Class Game Extends App
	
	Field monster:MonkeySpriter
	Field hero:MonkeySpriter

	Const IDLE:String = "Idle"
	Const POSTURE:String = "Posture"
	Field monsterAnimName:String = IDLE
	
	'Const IDLEH:String = "idle_healthy"
	'Const WALK:String = "walk"
	Field heroAnimName:String = POSTURE 'IDLEH

	Field lastMillisecs:Int
	Field currentMillisecs:Int 
	Field timeElapsed:Int
	Field tween:Bool = True
	Field loopType:Int
	Field debug:Bool
	
	Method OnCreate:Int()
	   SetVirtualDisplay 800,600
	   
		monster = SpriterImporter.ImportFile("monster", "Example.SCML")
		monster.x = VDeviceWidth() / 2
		monster.y = VDeviceHeight() - 20

		hero = monster.copy() 'SpriterImporter.ImportFile("monster", "Example.SCML")
		
		hero.x = hero.x - 200
		monster.x = monster.x + 200

		loopType = MonkeySpriter.LOOPING_TRUE
		debug = False
		CreateGUI()

		SetUpdateRate(60)
		monster.timer.Start()
		hero.timer.Start()		
		lastMillisecs = Millisecs()

		Return 0
	End
	
	Method CreateGUI:Void()
		Local b:Button = New Button("Anim 1", 0, 10, 100, 20)
		b.SetColour(255, 0, 0)
		b = New Button("Anim 2", 110, 10, 100, 20)

		b = New Button("Loop Type", 220, 10, 100, 20)
		b.SetColour(255, 255, 0)
		
		b = New Button("Reset Timer", 330, 10, 100, 20)
		b.SetColour(255, 0, 255)
		
		b = New Button("Stop Timer", 440, 10, 100, 20)
		b.SetColour(0, 255, 255)
		
		b = New Button("Resume Timer", 550, 10, 100, 20)
		b.SetColour(0, 255, 0)
		
		b = New Button("Slower", 440, 40, 100, 20)
		b.SetColour(100, 100, 100)
		
		b = New Button("Faster", 550, 40, 100, 20)
		b.SetColour(0, 0, 255)
		
		b = New Button("Tween On/Off", 330, 40, 100, 20)
		b.SetColour(25, 255, 25)

		b = New Button("Flip X", 0, 70, 100, 20)
		b.SetColour(25, 255, 125)	

		b = New Button("Flip Y", 110, 70, 100, 20)
		b.SetColour(123, 123, 255)	

		b = New Button("Scale Up", 0, 40, 100, 20)
		b.SetColour(255, 33, 125)	
		
		b = New Button("Scale Down", 110, 40, 100, 20)
		b.SetColour(125, 0, 125)
		
		b = New Button("Debug On/Off", 220, 40, 100, 20)
		b.SetColour(125, 230, 234)	
	End
	
	Method OnUpdate:Int()
		' simple delta timing
		currentMillisecs = Millisecs()
		timeElapsed = currentMillisecs - lastMillisecs 
		lastMillisecs = currentMillisecs

		hero.Update(heroAnimName, loopType, timeElapsed)
		monster.Update(monsterAnimName, loopType, timeElapsed)
		
		Controls()
		Return 0
	End	
	
	Method OnRender:Int()
	   UpdateVirtualDisplay()
		Cls
		hero.Draw(tween)
		monster.Draw(tween)
	
		Button.DrawAll()
		If debug Then DrawDebug()
		Return 0
	End
	
	Method Controls:Void()
		Button.UpdateAll()
		If Button.Clicked("Debug On/Off") Then
			debug = Not debug
		End
		If Button.Clicked("Scale Up") Then
			monster.scaleX *= 1.1
			monster.scaleY *= 1.1
		End
		If Button.Clicked("Scale Down") Then
			monster.scaleX /= 1.1
			monster.scaleY /= 1.1
		End
		If Button.Clicked("Flip X") Then
			monster.scaleX = -monster.scaleX
		End
		If Button.Clicked("Flip Y") Then
			monster.scaleY = -monster.scaleY
			monster.y = VDeviceHeight() - monster.y
		End
		If Button.Clicked("Stop Timer") Then
			monster.timer.Stop()
			hero.timer.Stop()
		End
		If Button.Clicked("Resume Timer") Then
			monster.timer.Resume()
			hero.timer.Resume()
		End
		If Button.Clicked("Reset Timer") Then
			monster.timer.Start()
			hero.timer.Start()
			monster.mainlineKeyId = 0
			hero.mainlineKeyId = 0
		End
		If Button.Clicked("Faster") Then
			hero.timer.rate/=1.1
			monster.timer.rate/=1.1
		End
		If Button.Clicked("Slower") Then
			hero.timer.rate*=1.1
			monster.timer.rate*=1.1
		End
		If Button.Clicked("Anim 1") Then
			monsterAnimName = IDLE
			heroAnimName = POSTURE 'IDLEH
			monster.mainlineKeyId = 0
			monster.timer.Start()
			hero.mainlineKeyId = 0
			hero.timer.Start()
		End
		If Button.Clicked("Anim 2") Then
			monsterAnimName = POSTURE
			heroAnimName = IDLE 'WALK
			monster.mainlineKeyId = 0
			monster.timer.Start()
			hero.mainlineKeyId = 0
			hero.timer.Start()
		End
		If Button.Clicked("Tween On/Off") Then
			tween = Not tween
		End
		If Button.Clicked("Loop Type") Then
			monster.timer.Start()
			hero.timer.Start()
			monster.mainlineKeyId = 0
			hero.mainlineKeyId = 0
			loopType += 1
			If loopType &gt; 2 loopType = 0
		End
		
		If KeyDown(KEY_W) monster.y-=2
		If KeyDown(KEY_S) monster.y+=2
		If KeyDown(KEY_A) monster.x-=2
		If KeyDown(KEY_D) monster.x+=2
	End
	
	Method DrawDebug:Void()
		Local y:Int = 100
		Local gap:Int = 15
		SetAlpha(0.75)
		DrawText("MONKEY SPRITER IMPORTER", 10, y)
		y+=gap
		y+=gap
		DrawText("Monster Timer = " + monster.timer.GetTime(), 10, y)
		y+=gap
		DrawText("Hero Timer    = " + hero.timer.GetTime(), 10, y)
		y+=gap
		DrawText("Time Elapsed  = " + timeElapsed, 10, y)
		y+=gap
		Local loopString:String
		Select loopType
			Case 0
				loopString = "FALSE"
			Case 1
				loopString = "TRUE"
			Case 2
				loopString = "PING PONG"
		End
		DrawText("Looping Type  = " + loopString, 10, y)
		y+=gap
		DrawText("Timer Rate    = " + monster.timer.rate, 10, y)
		y+=gap
		If tween
			DrawText("Tweening      = TRUE", 10, y)
		Else
			DrawText("Tweening      = FALSE", 10, y)
		End
		y+=gap
		DrawText("Scale X       = " + monster.scaleX, 10, y)
		y+=gap
		DrawText("Scale Y       = " + monster.scaleY, 10, y)

		SetAlpha(1)
	End
End
'-------------------------- Simple Button --------------------------
Class Button
	Field x:Int, y:Int
	Field w:Int, h:Int
	Field label:String
	Field name:String
	Field r:Int = 255, g:Int = 255, b:Int = 255
	Field mouseOver:Bool = False
	Field clicked:Bool = False
	Global clickedName:String = ""
	Global list:List&lt;Button&gt;
	
	Method New(label:String, x:Int, y:Int, w:Int, h:Int)
		If list = Null Then list = New List&lt;Button&gt;
		Self.label = label
		Self.name = label.ToUpper()
		Self.x = x
		Self.y = y
		Self.w = w
		Self.h = h
		
		list.AddLast(Self)
	End
	
	Method SetColour:Void(r:Int, g:Int, b:Int)
		Self.r = r
		Self.g = g
		Self.b = b
	End
	
	Method Update:Void()
		If RectsOverlap(VMouseX(), VMouseY(), 3, 3, Self.x, Self.y, Self.w, Self.h)
			mouseOver = True
			If MouseHit(MOUSE_LEFT)
				If Not clicked
					clicked = True
				End
			Else
				clicked = False
			End
		Else
			clicked = False
			mouseOver = False
		End
	End
	
	Method Draw:Void()
		Local light:Int = -25
		If mouseOver
			light = 120
			SetAlpha(1)
		End
		SetColor (r + light, g + light, b + light)
		DrawRect (x, y, w, h)
		SetColor (255, 255, 255)
		DrawText (label, x + 2, y + 2)
	End
	
	Function DrawAll:Void()
		For Local b:Button = Eachin list
			SetAlpha(0.75)
			b.Draw()
		End
		SetAlpha(1)		
	End
	
	Function Clicked:Int(name:String)
		name = name.ToUpper()
		If name = clickedName
			clickedName = ""
			Return 1		
		Else
			Return 0
		End
	End
	
	Function UpdateAll:Void()
		clickedName = ""
		For Local b:Button = Eachin list
			b.Update()
			If b.clicked Then clickedName = b.name
		End
	End
End

Function RectsOverlap:Int(x0:Float, y0:Float, w0:Float, h0:Float, x2:Float, y2:Float, w2:Float, h2:Float)
	If x0 &gt; (x2 + w2) Or (x0 + w0) &lt; x2 Then Return False
	If y0 &gt; (y2 + h2) Or (y0 + h0) &lt; y2 Then Return False
	Return True
End

'-------------------------- Monkey Spriter Code --------------------------
Class MonkeySpriter
	Field textures:TextureProvider = New TextureProvider()
	Field folders:IntMap&lt;SpriterFolder&gt;
	Field entities:IntMap&lt;SpriterEntity&gt;
	Field mainPath:String
	Field animationName:String
	Field nextKeyTime:Int
	Field mainlineKeyId:Int
	Field timer:Timer

	Field scaleX:Float = 1
	Field scaleY:Float = 1
	
	Field x:Float, y:Float

	Const LOOPING_FALSE:Int = 0
	Const LOOPING_TRUE:Int = 1
	Const LOOPING_PING_PONG:Int = 2

	
	Method New()
		Self.folders = New IntMap&lt;SpriterFolder&gt;
		Self.entities = New IntMap&lt;SpriterEntity&gt;
		mainlineKeyId = 0
		timer = New Timer
	End

	Method copy:MonkeySpriter()
	   Local ms:MonkeySpriter = New MonkeySpriter
	   
	   ms.textures = Self.textures
	   ms.folders  = Self.folders
	   ms.entities = Self.entities
	   ms.mainPath = Self.mainPath
	   ms.animationName = Self.animationName
	   ms.nextKeyTime   = Self.nextKeyTime
	   ms.mainlineKeyId = Self.mainlineKeyId
	   ms.timer         = New Timer
	   
	   ms.scaleX        = Self.scaleX
	   ms.scaleY        = Self.scaleY
	   ms.x             = Self.x
	   ms.y             = Self.y
	   
	   Return ms
	End Method
	
	Method Update:Void(animationName:String, looping:Int = LOOPING_TRUE, timeElapsed:Int)
		Self.animationName = animationName
		If Not timer.stopped
			timer.Update(timeElapsed)
			Local animation:SpriterAnimation = entities.Get(0).animations.Get(animationName)
			If animation=Null Then Return
			
			If looping &lt;&gt; "" Then
				animation.looping = looping
			End
			
			Local mainline:SpriterMainline = animation.mainline
			If timer.GetTime() &gt;= animation.length
				If animation.looping = LOOPING_TRUE
					timer.Reset()
				Else If animation.looping = LOOPING_PING_PONG
					timer.direction = timer.DOWN
				Else If animation.looping = LOOPING_FALSE
					timer.Stop()
				End
			End
			If animation.looping = LOOPING_PING_PONG And timer.GetTime() &lt;= 0
				timer.direction = timer.UP
				timer.Reset()
			End
		End		
	End
	
	Method Draw:Void(tween:Bool = False)
		Local anim:SpriterAnimation = entities.Get(0).animations.Get(animationName)
		If anim = Null Then Return

		Local mainline:SpriterMainline = anim.mainline
		
		Local time:Float = timer.GetTime()
		mainlineKeyId = mainline.GetKeyViaTime(time).id
		Local mainlineKey:SpriterKey = mainline.keys.Get(mainlineKeyId)

		For Local i:Int = Eachin mainlineKey.objectRefs.Keys()
			Local objRef:SpriterObjectRef = mainlineKey.objectRefs.Get(i)
			Local timeline:SpriterTimeline = anim.timelines.Get(objRef.timeline)
			Local timelineKey:SpriterKey = timeline.GetKeyViaTime(time)
			Local nextTimelineKey:SpriterKey = timeline.keys.Get(objRef.key + 1)
			Local nextKeyTime:Int
			
			If nextTimelineKey = Null Then
				If anim.looping = LOOPING_TRUE
					nextTimelineKey = timeline.keys.Get(0)
					nextKeyTime = anim.length
					' next timeline might not start at the beginning of the animation
					If nextTimelineKey.time &gt; 0 Then
						nextKeyTime += nextTimelineKey.time
					End
				Else If anim.looping = LOOPING_PING_PONG
					If timer.direction = timer.UP
						nextKeyTime = anim.length
					Else
						nextKeyTime = 0
					End
					nextTimelineKey = timelineKey
				Else If anim.looping = LOOPING_FALSE
					nextTimelineKey = timelineKey
					nextKeyTime = anim.length	
				End
			Else
				nextKeyTime = nextTimelineKey.time
			End
			
			Local nextO:SpriterObject = nextTimelineKey.objects.Last()

			For Local o:SpriterObject = Eachin timelineKey.objects
				Local folder:SpriterFolder = Self.folders.Get(o.folder)
				Local file:SpriterFile = folder.files.Get(o.file)
				Local texture:Image = textures.GetTexture(Self.mainPath + "/" + file.name.ToUpper())
				Local px:Float = o.pivotX * texture.Width()
				Local py:Float = texture.Height() + (-o.pivotY * texture.Height())
				If o.pivotY = 0 Then py = 0
				If o.pivotX = 0 Then px = 0
				texture.SetHandle(px, py)
				Local currentAngle:Float = o.angle
				Local nextAngle:Float = nextO.angle

				'XOR
				If (scaleX &lt; 0) &lt;&gt; (scaleY &lt; 0) Then
					currentAngle = -currentAngle
					nextAngle = -nextAngle
				End

				If tween
					Local tweenedX:Float = LinearInterpolation(o.x, nextO.x, timelineKey.time, nextKeyTime, timer.GetTime())
					Local tweenedY:Float = LinearInterpolation(o.y, nextO.y, timelineKey.time, nextKeyTime, timer.GetTime())
					Local tweenedAngle:Float = AngleLinearInterpolation(currentAngle, nextAngle, timelineKey.time, nextKeyTime, timer.GetTime())
					Local tweenedScaleX:Float = LinearInterpolation(o.scaleX, nextO.scaleX, timelineKey.time, nextKeyTime, timer.GetTime())
					Local tweenedScaleY:Float = LinearInterpolation(o.scaleY, nextO.scaleY, timelineKey.time, nextKeyTime, timer.GetTime())
					Local tweenedAlpha:Float = LinearInterpolation(o.alpha, nextO.alpha, timelineKey.time, nextKeyTime, timer.GetTime())
					SetAlpha(tweenedAlpha)
					DrawImage(texture, tweenedX * scaleX + x, -tweenedY * scaleY + y, tweenedAngle, tweenedScaleX * scaleX, tweenedScaleY * scaleY, 0)
				Else
					SetAlpha(o.alpha)
					DrawImage(texture, o.x * scaleX + x, -o.y * scaleY + y, currentAngle, o.scaleX * scaleX, o.scaleY * scaleY, 0)
				End
			Next		
			SetAlpha(1)
		Next
	End
	
	Method LinearInterpolation:Float(a:Float, b:Float, timeA:Float, timeB:Float, currentTime:Float)
		Return a + ((b - a) * ((currentTime - timeA) / (timeB - timeA)))
	End
	
	Method AngleLinearInterpolation:Float(a:Float, b:Float, timeA:Float, timeB:Float, currentTime:Float)
		Return a + (AngleDifference(b, a) * ((currentTime - timeA) / (timeB - timeA)))
	End
	
	Method AngleDifference:Float(a:Float, b:Float)
		Return ((((a - b) Mod 360) + 540) Mod 360) - 180
	End
End

Class SpriterFolder
	Field files:IntMap&lt;SpriterFile&gt;
	Field id:Int
	Field name:String
	
	Method New()
		Self.files = New IntMap&lt;SpriterFile&gt;
	End
End

Class SpriterFile
	Field id:Int
	Field name:String
	Field width:Int
	Field height:Int
End

Class SpriterEntity
	Field id:Int
	Field name:String
	Field animations:StringMap&lt;SpriterAnimation&gt;
	
	Method New()
		Self.animations = New StringMap&lt;SpriterAnimation&gt;
	End
End

Class SpriterAnimation
	Field id:Int
	Field name:String
	Field length:Int
	Field looping:Int
	Field mainline:SpriterMainline
	Field timelines:IntMap&lt;SpriterTimeline&gt;
	Field maxKey:Int
	
	Method New()
		Self.mainline = New SpriterMainline
		Self.timelines = New IntMap&lt;SpriterTimeline&gt;
	End
End

Class SpriterMainline
	Field keys:IntMap&lt;SpriterKey&gt;
	Field keyId:Int = 0
	Field delay:Float = 0
	Field maxDelay:Int = 5
	Field speed:Float = 1.5
	Field maxKey:Int
		
	Method New()
		Self.keys = New IntMap&lt;SpriterKey&gt;
	End
		
	Method GetKey:SpriterKey(timer:Timer)
		Local rv:SpriterKey = Self.keys.Get(0)
		For Local i:Int = Eachin Self.keys.Keys()
			Local key:SpriterKey = Self.keys.Get(i)
			If key.time &gt; timer.GetTime()
				Return rv
			End
			rv = key
		Next
		Return rv
	End
	
	Method GetKeyViaTime:SpriterKey(time:Float)
		Local rv:SpriterKey = Self.keys.Get(0)
		For Local i:Int = Eachin Self.keys.Keys()
			Local key:SpriterKey = Self.keys.Get(i)
			If key.time &gt; time
				Return rv
			End
			rv = key
		Next
		Return rv
	End

End

Class SpriterKey
	Field id:Int
	Field time:Int
	Field spin:Int
	Field objectRefs:IntMap&lt;SpriterObjectRef&gt;
	Field objects:List&lt;SpriterObject&gt;
	
	Method New()
		Self.objectRefs = New IntMap&lt;SpriterObjectRef&gt;
		Self.objects = New List&lt;SpriterObject&gt;
	End
End

Class SpriterObjectRef
	Field id:Int
	Field timeline:Int
	Field key:Int
	Field zIndex:Int
End

Class SpriterTimeline
	Field id:Int
	Field keys:IntMap&lt;SpriterKey&gt;
	Field keyId:Int = 0
	Field delay:Float = 0
	Field maxDelay:Int = 5
	Field speed:Float = 1.5
	Field maxKey:Int
	
	Method New()
		Self.keys = New IntMap&lt;SpriterKey&gt;
	End
	
	Method GetKey:SpriterKey(timer:Timer)
		Local rv:SpriterKey = Self.keys.Get(0)
		For Local i:Int = Eachin Self.keys.Keys()
			Local key:SpriterKey = Self.keys.Get(i)
			If key.time &gt; timer.GetTime()
				Return rv
			End
			rv = key
		Next
		Return rv
	End
	
	Method GetKeyViaTime:SpriterKey(time:Float)
		Local rv:SpriterKey = Self.keys.Get(0)
		For Local i:Int = Eachin Self.keys.Keys()
			Local key:SpriterKey = Self.keys.Get(i)
			If key.time &gt; time
				Return rv
			End
			rv = key
		Next
		Return rv
	End

End

Class SpriterObject
	Field folder:Int
	Field file:Int
	Field x:Float
	Field y:Float
	Field pivotX:Float
	Field pivotY:Float
	Field angle:Float
	Field scaleX:Float
	Field scaleY:Float
	Field alpha:Float
End

Class SpriterImporter
	Function ImportFile:MonkeySpriter(path:String, file:String, debug:Bool = False)
		If debug Then Print "Importing " + path + "/" + file

		Local str:String = LoadString(path + "/" + file)
		If str = "" Then Error "Error loading file..."
		
		Local xmlReader:XMLParser = New XMLParser		
		Local doc:XMLDocument = xmlReader.ParseString(str)
		Local rootElement:XMLElement = doc.Root

		Local smo:MonkeySpriter = New MonkeySpriter()
		smo.mainPath = path
		For Local folderElement:XMLElement = Eachin rootElement.GetChildrenByName("folder")
			Local folder:SpriterFolder = New SpriterFolder()
			folder.id = Int(folderElement.GetAttribute("id"))
			folder.name = folderElement.GetAttribute("name")
			If debug Print "folder = " + folder.id + " " + folder.name
			
			For Local fileElement:XMLElement = Eachin folderElement.GetChildrenByName("file")
				Local file:SpriterFile = New SpriterFile()
				file.id = Int(fileElement.GetAttribute("id"))
				file.name = fileElement.GetAttribute("name")
				file.width = Int(fileElement.GetAttribute("width"))
				file.height = Int(fileElement.GetAttribute("height"))
				
				If debug Print "file = " + file.id + " " + file.name
				smo.textures.Load(path + "/" + file.name)
				
				folder.files.Add(file.id, file)
			Next
			smo.folders.Add(folder.id, folder)
		Next
		
		For Local entityElement:XMLElement = Eachin rootElement.GetChildrenByName("entity")
			Local entity:SpriterEntity = New SpriterEntity()
			Local id:String = entityElement.GetAttribute("id")
			Local name:String = entityElement.GetAttribute("name")
			
			If debug Print "entity = " + id + " " + name
			For Local animationElement:XMLElement = Eachin entityElement.GetChildrenByName("animation")
				Local animation:SpriterAnimation = New SpriterAnimation()
				animation.id  = Int(animationElement.GetAttribute("id"))
				animation.name = animationElement.GetAttribute("name")
				animation.length = Int(animationElement.GetAttribute("length"))
				Local looping:String = animationElement.GetAttribute("looping", MonkeySpriter.LOOPING_FALSE)
				Select looping
					Case "true"
						animation.looping = MonkeySpriter.LOOPING_TRUE
					Case "false"
						animation.looping = MonkeySpriter.LOOPING_FALSE
					Case "ping_pong"
						animation.looping = MonkeySpriter.LOOPING_PING_PONG
				End

				If debug Print "animation = " + animation.id + " " + animation.name
				
				' Should only be one mainline element
				For Local mainlineElement:XMLElement = Eachin animationElement.GetChildrenByName("mainline")
					For Local keyElement:XMLElement = Eachin mainlineElement.GetChildrenByName("key")
						Local skey:SpriterKey = New SpriterKey()
						skey.id = Int(keyElement.GetAttribute("id"))
						skey.time= Int(keyElement.GetAttribute("time", "0"))
						If debug Print "key = " + skey.id + " " + skey.time

						For Local objectRefElement:XMLElement = Eachin keyElement.GetChildrenByName("object_ref")
							Local objectRef:SpriterObjectRef = New SpriterObjectRef
							objectRef.id = Int(objectRefElement.GetAttribute("id"))
							objectRef.timeline = Int(objectRefElement.GetAttribute("timeline"))
							objectRef.key = Int(objectRefElement.GetAttribute("key"))
							objectRef.zIndex = Int(objectRefElement.GetAttribute("z_index"))
							If debug Print "object_ref = " + objectRef.id + " " + objectRef.timeline
							
							skey.objectRefs.Add(objectRef.id, objectRef)
						Next
						animation.mainline.keys.Add(skey.id, skey)
						animation.maxKey = skey.id
					Next	
				Next
				
				For Local timelineElement:XMLElement = Eachin animationElement.GetChildrenByName("timeline")
					Local timeline:SpriterTimeline = New SpriterTimeline()
					timeline.id = Int(timelineElement.GetAttribute("id"))
					If debug Print "timeline = " + timeline.id
					
					For Local keyElement:XMLElement = Eachin timelineElement.GetChildrenByName("key")
						Local key:SpriterKey = New SpriterKey()
						key.id = Int(keyElement.GetAttribute("id"))
						key.time = Int(keyElement.GetAttribute("time", "0"))
						key.spin = Int(keyElement.GetAttribute("spin", "1"))
						If debug Print "key = " + key.id + " " + key.time + " " + key.spin
						
						For Local objectElement:XMLElement = Eachin keyElement.GetChildrenByName("object")						
							Local o:SpriterObject = New SpriterObject()
							o.folder = Int(objectElement.GetAttribute("folder"))
							o.file = Int(objectElement.GetAttribute("file"))
							o.x = Float(objectElement.GetAttribute("x", "0"))
							o.y = Float(objectElement.GetAttribute("y", "0"))
							o.pivotX = Float(objectElement.GetAttribute("pivot_x", "0"))
							o.pivotY = Float(objectElement.GetAttribute("pivot_y", "0"))
							o.angle = Float(objectElement.GetAttribute("angle", "0"))
							o.scaleX = Float(objectElement.GetAttribute("scale_x", "1"))
							o.scaleY = Float(objectElement.GetAttribute("scale_y", "1"))
							o.alpha = Float(objectElement.GetAttribute("a", "1"))
							
							If debug Print "object = " + o.folder + " " + o.file + " " + o.angle
														
							key.objects.AddLast(o)
						Next
						timeline.keys.Add(key.id, key)
					Next
					animation.timelines.Add(timeline.id, timeline)
				Next
				entity.animations.Add(animation.name, animation)
			Next
			smo.entities.Add(entity.id, entity)
		Next
		Return smo
	End
End

Class TextureProvider Extends StringMap&lt;Image&gt;
	Method Load:Image(name:String)
		Local storeKey:String = name.ToUpper()

		Local i:Image = New Image
		Local imgName:String = name

		i = LoadImage(imgName )', 1, flags)
		If i = Null
			Error "Error loading image "+name
		End
		'Print "storing "+storeKey
		Self.Set(storeKey, i)
		Return i
	End
	
	Method DisplayAllStored:Void()
		' debug: print all keys in the map
		For Local key:String = Eachin Self.Keys()
			Print key + " is stored in the map."
		Next
	End
	
	Method GetTexture:Image(name:String)
		name = name.ToUpper()
	   	
		Local i:Image= Self.Get(name)
		If i = Null Then Error("Image '" + name + "' not found in the TextureProvider")
		Return i
	End	
End

Class Timer
	Field stopped:Bool
	Field rate:Float
	Const UP:Int = 1
	Const DOWN:Int = -1
	Field direction:Int
	Field count:Float
	
	Method New()
		stopped = True
		rate = 1
		direction = UP
	End
	
	Method Start:Void()
		Reset()
		Resume()
		rate = 1
	End
	
	Method Stop:Void()
		If Not stopped
			stopped = True
		End
	End
	
	Method Resume:Void()
		If stopped
			stopped = False
		End
	End
	
	Method Reset:Void()
		count = 0
		direction = UP
	End
	
	Method GetTime:Float()
		Return count / rate
	End

	Method Update:Void(timeElapsed:Int)
		If direction = UP
			count+=timeElapsed
		Else
			count-=timeElapsed
		End
	End
End
</textarea><br><br>- Added another null check on MonkeySpriter.update - I was trying to play an animation that didn't exist and the program was crashing!<br><br>- Added a copy() method to MonkeySpriter - so I can clone any loaded animation - don't know how it will affect alpha or even hiding parts of the animation - but for all the rest it seems to work pretty well<br><br>- moved x/y/scale inside MonkeySpriter, so each animation can have it's own position/scale, even if cloned.<br><br>- Added autofit into the code ^_^ <br><br></td></tr></table><br>
<a name="1177394"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >SLotman</td><td align="right"><font class=tiny>(Posted 2013)</font>&nbsp;<a href="#8">[#8]</a></td></tr></table></td></tr><tr ><td class="posttext"> Hmmm... I just got worried about something: Spriter doesn't support multiple "parts" on a single image?<br><br>Isn't this going to create a huge overhead (because of several texture swapping) if you have lots of chars on screen? <br><br></td></tr></table><br>
<a name="1177395"></a>

<a name="1177396"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >therevills</td><td align="right"><font class=tiny>(Posted 2013)</font>&nbsp;<a href="#9">[#9]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> I just did some changes in the code <br></div><br>Cool! Sounds good!<br><br><div class="quote"> Spriter doesn't support multiple "parts" on a single image? <br></div><br>Not yet:<br><a href="http://www.brashmonkey.com/spriter%20features.htm" target="_blank">http://www.brashmonkey.com/spriter%20features.htm</a><br><pre class=code>Texture atlas (spritesheet) support via texturepacker integration. &lt;coming soon&gt;</pre><br>But it doesnt stop us for doing it before them, we can use TexturePacker to generate the atlas and use the TextureProvider class to lookup the texture instead of the single images ;)<br><br>I'm still thinking if having separate TextureProviders is a good idea or not... <br><br></td></tr></table><br>
<a name="1177494"></a>

<a name="1177495"></a>

<a name="1177496"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >SLotman</td><td align="right"><font class=tiny>(Posted 2013)</font>&nbsp;<a href="#10">[#10]</a></td></tr></table></td></tr><tr ><td class="posttext"> I've managed a hacky way to hide objects ^_^<br><br>First, I added a new class:<br><br><pre class=code>
Class FileFolder
  Field file:Int
  Field folder:Int  
End Class
</pre><br><br>Then, I added on SpriterMonkey:<br><br><textarea class=codebox name="code" wrap=OFF readonly="true" rows="15" cols="80">
Field hiddenList:List&lt;FileFolder&gt;

	Method hideObject:Void(folderObj:Int, fileObj:Int)
	   Local ff:FileFolder = New FileFolder
	   
	   ff.folder = folderObj
	   ff.file   = fileObj
	   hiddenList.AddLast(ff)
	End Method

	Method showObject:Void(folderObj:Int, fileObj:Int)
	   For Local ff:FileFolder = Eachin hiddenList
	      If ff.folder=folderObj And ff.file=fileObj Then
	         hiddenList.Remove(ff)
	         Exit
	      End If
	   Next
	End Method
</textarea><br><br>And changed the Draw method:<br><textarea class=codebox name="code" wrap=OFF readonly="true" rows="15" cols="80">
	Method Draw:Void(tween:Bool = False)
		Local anim:SpriterAnimation = entities.Get(0).animations.Get(animationName)
		If anim = Null Then Return

		Local mainline:SpriterMainline = anim.mainline
		
		Local time:Float = timer.GetTime()
		mainlineKeyId = mainline.GetKeyViaTime(time).id
		Local mainlineKey:SpriterKey = mainline.keys.Get(mainlineKeyId)

		For Local i:Int = Eachin mainlineKey.objectRefs.Keys()
			Local objRef:SpriterObjectRef = mainlineKey.objectRefs.Get(i)
			Local timeline:SpriterTimeline = anim.timelines.Get(objRef.timeline)
			Local timelineKey:SpriterKey = timeline.GetKeyViaTime(time)
			Local nextTimelineKey:SpriterKey = timeline.keys.Get(objRef.key + 1)
			Local nextKeyTime:Int
			
			If nextTimelineKey = Null Then
				If anim.looping = LOOPING_TRUE
					nextTimelineKey = timeline.keys.Get(0)
					nextKeyTime = anim.length
					' next timeline might not start at the beginning of the animation
					If nextTimelineKey.time &gt; 0 Then
						nextKeyTime += nextTimelineKey.time
					End
				Else If anim.looping = LOOPING_PING_PONG
					If timer.direction = timer.UP
						nextKeyTime = anim.length
					Else
						nextKeyTime = 0
					End
					nextTimelineKey = timelineKey
				Else If anim.looping = LOOPING_FALSE
					nextTimelineKey = timelineKey
					nextKeyTime = anim.length	
				End
			Else
				nextKeyTime = nextTimelineKey.time
			End
			
			Local nextO:SpriterObject = nextTimelineKey.objects.Last()

			For Local o:SpriterObject = Eachin timelineKey.objects
			   
				Local folder:SpriterFolder = Self.folders.Get(o.folder)
				Local file:SpriterFile = folder.files.Get(o.file)
				
				' added this here!
				Local renderThis:Int=True
				For Local ff:FileFolder = Eachin hiddenList
				    If folder.id=ff.folder And file.id=ff.file Then renderThis=False
				Next
				
            If renderThis Then
					Local texture:Image = textures.GetTexture(Self.mainPath + "/" + file.name.ToUpper())
					Local px:Float = o.pivotX * texture.Width()
					Local py:Float = texture.Height() + (-o.pivotY * texture.Height())
					If o.pivotY = 0 Then py = 0
					If o.pivotX = 0 Then px = 0
					texture.SetHandle(px, py)
					Local currentAngle:Float = o.angle
					Local nextAngle:Float = nextO.angle
	
					'XOR
					If (scaleX &lt; 0) &lt;&gt; (scaleY &lt; 0) Then
						currentAngle = -currentAngle
						nextAngle = -nextAngle
					End If
	
					If tween Then
						Local tweenedX:Float = LinearInterpolation(o.x, nextO.x, timelineKey.time, nextKeyTime, timer.GetTime())
						Local tweenedY:Float = LinearInterpolation(o.y, nextO.y, timelineKey.time, nextKeyTime, timer.GetTime())
						Local tweenedAngle:Float = AngleLinearInterpolation(currentAngle, nextAngle, timelineKey.time, nextKeyTime, timer.GetTime())
						Local tweenedScaleX:Float = LinearInterpolation(o.scaleX, nextO.scaleX, timelineKey.time, nextKeyTime, timer.GetTime())
						Local tweenedScaleY:Float = LinearInterpolation(o.scaleY, nextO.scaleY, timelineKey.time, nextKeyTime, timer.GetTime())
						Local tweenedAlpha:Float = LinearInterpolation(o.alpha, nextO.alpha, timelineKey.time, nextKeyTime, timer.GetTime())
						SetAlpha(tweenedAlpha)
						DrawImage(texture, tweenedX * scaleX + x, -tweenedY * scaleY + y, tweenedAngle, tweenedScaleX * scaleX, tweenedScaleY * scaleY, 0)
					Else
						SetAlpha(o.alpha)
						DrawImage(texture, o.x * scaleX + x, -o.y * scaleY + y, currentAngle, o.scaleX * scaleX, o.scaleY * scaleY, 0)
					End If
            End If  ' renderThis
            
			Next		
			SetAlpha(1)
		Next
	End

</textarea><br><br>Then I can just call monster.hideObject(0,0) to hide the monster shadow in the sample file :) <br><br></td></tr></table><br>
<a name="1177499"></a>

<a name="1177503"></a>

<a name="1177504"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >therevills</td><td align="right"><font class=tiny>(Posted 2013)</font>&nbsp;<a href="#11">[#11]</a></td></tr></table></td></tr><tr ><td class="posttext"> That seems like a bit of work remembering that 0,0 in the shadow... what about expanding the TextureProvider and altering GetTexture, so if the texture is hidden GetTexture returns null. Of course, change Draw to not access the null texture ;)<br><br>I've added the <b>importing</b> of bones, but at the moment I haven't got a clue how to code them into the animations.<br><br>Heres the updated code:<br><textarea class=codebox name="code" wrap=OFF readonly="true" rows="15" cols="80">#TEXT_FILES="*.txt|*.xml|*.json|*.SCML|*.scml"
Strict
Import mojo
Import diddy.xml

Function Main:Int()
	New Game()
	Return 0
End

'-------------------------- Monkey Spriter Demo --------------------------
Class Game Extends App
	
	Field monster:MonkeySpriter
	Field hero:MonkeySpriter
	Field bones:MonkeySpriter

	Const IDLE:String = "Idle"
	Const POSTURE:String = "Posture"
	Field monsterAnimName:String = IDLE
	
	Const IDLEH:String = "idle_healthy"
	Const WALK:String = "walk"
	Field heroAnimName:String = IDLEH
	Field flipX:Bool
	Field flipY:Bool
	Field lastMillisecs:Int
	Field currentMillisecs:Int 
	Field timeElapsed:Int
	Field tween:Bool = True
	Field loopType:Int
	Field scaleX:Float = 1
	Field scaleY:Float = 1
	Field debug:Bool
	
	Method OnCreate:Int()
		monster = SpriterImporter.ImportFile("monster", "Example.SCML")
		hero = SpriterImporter.ImportFile("example hero", "BetaFormatHero.SCML")
		bones = SpriterImporter.ImportFile("BoneExample", "Basic_Platformer.scml")
		
		monster.x = DeviceWidth() / 2
		monster.y = DeviceHeight() - 20
		hero.x = DeviceWidth() / 2 - 200
		hero.y = DeviceHeight() - 20
		bones.x = DeviceWidth() / 2
		bones.y = DeviceHeight() / 2
				
		bones.timer.Start()
		monster.timer.Start()
		hero.timer.Start()		
		SetUpdateRate(60)
		lastMillisecs = Millisecs()
		loopType = MonkeySpriter.LOOPING_TRUE
		debug = false
		CreateGUI()
		Return 0
	End
	
	Method CreateGUI:Void()
		Local b:Button = New Button("Anim 1", 0, 10, 100, 20)
		b.SetColour(255, 0, 0)
		b = New Button("Anim 2", 110, 10, 100, 20)

		b = New Button("Loop Type", 220, 10, 100, 20)
		b.SetColour(255, 255, 0)
		
		b = New Button("Reset Timer", 330, 10, 100, 20)
		b.SetColour(255, 0, 255)
		
		b = New Button("Stop Timer", 440, 10, 100, 20)
		b.SetColour(0, 255, 255)
		
		b = New Button("Resume Timer", 550, 10, 100, 20)
		b.SetColour(0, 255, 0)
		
		b = New Button("Slower", 440, 40, 100, 20)
		b.SetColour(100, 100, 100)
		
		b = New Button("Faster", 550, 40, 100, 20)
		b.SetColour(0, 0, 255)
		
		b = New Button("Tween On/Off", 330, 40, 100, 20)
		b.SetColour(25, 255, 25)

		b = New Button("Flip X", 0, 70, 100, 20)
		b.SetColour(25, 255, 125)	

		b = New Button("Flip Y", 110, 70, 100, 20)
		b.SetColour(123, 123, 255)	

		b = New Button("Scale Up", 0, 40, 100, 20)
		b.SetColour(255, 33, 125)	
		
		b = New Button("Scale Down", 110, 40, 100, 20)
		b.SetColour(125, 0, 125)
		
		b = New Button("Debug On/Off", 220, 40, 100, 20)
		b.SetColour(125, 230, 234)	
	End
	
	Method OnUpdate:Int()
		' simple delta timing
		currentMillisecs = Millisecs()
		timeElapsed = currentMillisecs - lastMillisecs 
		lastMillisecs = currentMillisecs

		hero.Update(heroAnimName, loopType, timeElapsed)
		monster.Update(monsterAnimName, loopType, timeElapsed)
		
		bones.Update("Player_Idle", loopType, timeElapsed)
		
		Controls()
		Return 0
	End	
	
	Method OnRender:Int()
		Cls
		monster.Draw(tween)
		hero.Draw(tween)
		bones.Draw(tween)
		
		Button.DrawAll()
		If debug Then DrawDebug()
		Return 0
	End
	
	Method Controls:Void()
		Button.UpdateAll()
		If Button.Clicked("Debug On/Off") Then
			debug = Not debug
		End
		If Button.Clicked("Scale Up") Then
			scaleX *= 1.1
			scaleY *= 1.1
			monster.SetScale(scaleX, scaleY)
			hero.SetScale(scaleX, scaleY)
			bones.SetScale(scaleX, scaleY)
		End
		If Button.Clicked("Scale Down") Then
			scaleX /= 1.1
			scaleY /= 1.1
			monster.SetScale(scaleX, scaleY)
			hero.SetScale(scaleX, scaleY)
			bones.SetScale(scaleX, scaleY)
		End
		If Button.Clicked("Flip X") Then
			scaleX = -scaleX
			monster.SetScale(scaleX, monster.scaleY)
			hero.SetScale(scaleX, monster.scaleY)
		End
		If Button.Clicked("Flip Y") Then
			scaleY = -scaleY
			monster.SetScale(monster.scaleX, scaleY)
			hero.SetScale(hero.scaleX, scaleY)
			monster.y = DeviceHeight() - monster.y
			hero.y = DeviceHeight() - hero.y
		End
		If Button.Clicked("Stop Timer") Then
			monster.timer.Stop()
			hero.timer.Stop()
		End
		If Button.Clicked("Resume Timer") Then
			monster.timer.Resume()
			hero.timer.Resume()
		End
		If Button.Clicked("Reset Timer") Then
			monster.timer.Start()
			hero.timer.Start()
			monster.mainlineKeyId = 0
			hero.mainlineKeyId = 0
		End
		If Button.Clicked("Faster") Then
			hero.timer.rate/=1.1
			monster.timer.rate/=1.1
		End
		If Button.Clicked("Slower") Then
			hero.timer.rate*=1.1
			monster.timer.rate*=1.1
		End
		If Button.Clicked("Anim 1") Then
			monsterAnimName = IDLE
			heroAnimName = IDLEH
			monster.mainlineKeyId = 0
			monster.timer.Start()
			hero.mainlineKeyId = 0
			hero.timer.Start()
		End
		If Button.Clicked("Anim 2") Then
			monsterAnimName = POSTURE
			heroAnimName = WALK
			monster.mainlineKeyId = 0
			monster.timer.Start()
			hero.mainlineKeyId = 0
			hero.timer.Start()
		End
		If Button.Clicked("Tween On/Off") Then
			tween = Not tween
		End
		If Button.Clicked("Loop Type") Then
			monster.timer.Start()
			hero.timer.Start()
			monster.mainlineKeyId = 0
			hero.mainlineKeyId = 0
			loopType += 1
			If loopType &gt; 2 loopType = 0
		End
		
		If KeyDown(KEY_W) hero.y-=2
		If KeyDown(KEY_S) hero.y+=2
		If KeyDown(KEY_A) hero.x-=2
		If KeyDown(KEY_D) hero.x+=2
	End
	
	Method DrawDebug:Void()
		Local y:Int = 100
		Local gap:Int = 15
		SetAlpha(0.75)
		DrawText("MONKEY SPRITER IMPORTER", 10, y)
		y+=gap
		y+=gap
		DrawText("Monster Timer = " + monster.timer.GetTime(), 10, y)
		y+=gap
		DrawText("Hero Timer    = " + hero.timer.GetTime(), 10, y)
		y+=gap
		DrawText("Time Elapsed  = " + timeElapsed, 10, y)
		y+=gap
		Local loopString:String
		Select loopType
			Case 0
				loopString = "FALSE"
			Case 1
				loopString = "TRUE"
			Case 2
				loopString = "PING PONG"
		End
		DrawText("Looping Type  = " + loopString, 10, y)
		y+=gap
		DrawText("Timer Rate    = " + monster.timer.rate, 10, y)
		y+=gap
		If tween
			DrawText("Tweening      = TRUE", 10, y)
		Else
			DrawText("Tweening      = FALSE", 10, y)
		End
		y+=gap
		DrawText("Scale X       = " + scaleX, 10, y)
		y+=gap
		DrawText("Scale Y       = " + scaleY, 10, y)

		SetAlpha(1)
	End
End
'-------------------------- Simple Button --------------------------
Class Button
	Field x:Int, y:Int
	Field w:Int, h:Int
	Field label:String
	Field name:String
	Field r:Int = 255, g:Int = 255, b:Int = 255
	Field mouseOver:Bool = False
	Field clicked:Bool = False
	Global clickedName:String = ""
	Global list:List&lt;Button&gt;
	
	Method New(label:String, x:Int, y:Int, w:Int, h:Int)
		If list = Null Then list = New List&lt;Button&gt;
		Self.label = label
		Self.name = label.ToUpper()
		Self.x = x
		Self.y = y
		Self.w = w
		Self.h = h
		
		list.AddLast(Self)
	End
	
	Method SetColour:Void(r:Int, g:Int, b:Int)
		Self.r = r
		Self.g = g
		Self.b = b
	End
	
	Method Update:Void()
		If RectsOverlap(MouseX(), MouseY(), 3, 3, Self.x, Self.y, Self.w, Self.h)
			mouseOver = True
			If MouseHit(MOUSE_LEFT)
				If Not clicked
					clicked = True
				End
			Else
				clicked = False
			End
		Else
			clicked = False
			mouseOver = False
		End
	End
	
	Method Draw:Void()
		Local light:Int = -25
		If mouseOver
			light = 120
			SetAlpha(1)
		End
		SetColor (r + light, g + light, b + light)
		DrawRect (x, y, w, h)
		SetColor (255, 255, 255)
		DrawText (label, x + 2, y + 2)
	End
	
	Function DrawAll:Void()
		For Local b:Button = Eachin list
			SetAlpha(0.75)
			b.Draw()
		End
		SetAlpha(1)		
	End
	
	Function Clicked:Int(name:String)
		name = name.ToUpper()
		If name = clickedName
			clickedName = ""
			Return 1		
		Else
			Return 0
		End
	End
	
	Function UpdateAll:Void()
		clickedName = ""
		For Local b:Button = Eachin list
			b.Update()
			If b.clicked Then clickedName = b.name
		End
	End
End

Function RectsOverlap:Int(x0:Float, y0:Float, w0:Float, h0:Float, x2:Float, y2:Float, w2:Float, h2:Float)
	If x0 &gt; (x2 + w2) Or (x0 + w0) &lt; x2 Then Return False
	If y0 &gt; (y2 + h2) Or (y0 + h0) &lt; y2 Then Return False
	Return True
End

'-------------------------- Monkey Spriter Code --------------------------
Class MonkeySpriter
	Field textures:TextureProvider = New TextureProvider()
	Field folders:IntMap&lt;SpriterFolder&gt;
	Field entities:IntMap&lt;SpriterEntity&gt;
	Field mainPath:String
	Field animationName:String
	Field nextKeyTime:Int
	Field mainlineKeyId:Int
	Field timer:Timer
	Field scaleX:Float = 1
	Field scaleY:Float = 1
	Field x:Float, y:Float
	Const LOOPING_FALSE:Int = 0
	Const LOOPING_TRUE:Int = 1
	Const LOOPING_PING_PONG:Int = 2
	
	Method New()
		Self.folders = New IntMap&lt;SpriterFolder&gt;
		Self.entities = New IntMap&lt;SpriterEntity&gt;
		mainlineKeyId = 0
		timer = New Timer
	End
	
	Method Copy:MonkeySpriter()
		Local ms:MonkeySpriter = New MonkeySpriter
		ms.textures = Self.textures
		ms.folders  = Self.folders
		ms.entities = Self.entities
		ms.mainPath = Self.mainPath
		ms.animationName = Self.animationName
		ms.nextKeyTime   = Self.nextKeyTime
		ms.mainlineKeyId = Self.mainlineKeyId
		ms.timer = New Timer
		ms.scaleX = Self.scaleX
		ms.scaleY = Self.scaleY
		ms.x = Self.x
		ms.y = Self.y
		Return ms
	End Method
	
	Method Update:Void(animationName:String, looping:Int = LOOPING_TRUE, timeElapsed:Int)
		Self.animationName = animationName
		If Not timer.stopped
			timer.Update(timeElapsed)
			Local animation:SpriterAnimation
			Try
				animation = entities.Get(0).animations.Get(animationName)
				If animation = Null Then Throw New Throwable
			Catch ex:Throwable
        		Print "Animation is null! Can not find animation " + animationName
			End
			
			If looping &lt;&gt; "" Then
				animation.looping = looping
			End
			Local mainline:SpriterMainline = animation.mainline
			If timer.GetTime() &gt;= animation.length
				If animation.looping = LOOPING_TRUE
					timer.Reset()
				Else If animation.looping = LOOPING_PING_PONG
					timer.direction = timer.DOWN
				Else If animation.looping = LOOPING_FALSE
					timer.Stop()
				End
			End
			If animation.looping = LOOPING_PING_PONG And timer.GetTime() &lt;= 0
				timer.direction = timer.UP
				timer.Reset()
			End
		End		
	End
	
	Method Draw:Void(tween:Bool = False)
		Local anim:SpriterAnimation = entities.Get(0).animations.Get(animationName)
		If anim = Null Return
		Local mainline:SpriterMainline = anim.mainline
		
		Local time:Float = timer.GetTime()
		mainlineKeyId = mainline.GetKeyViaTime(time).id
		Local mainlineKey:SpriterKey = mainline.keys.Get(mainlineKeyId)

		For Local i:Int = Eachin mainlineKey.objectRefs.Keys()
			Local objRef:SpriterObjectRef = mainlineKey.objectRefs.Get(i)
			Local timeline:SpriterTimeline = anim.timelines.Get(objRef.timeline)
			Local timelineKey:SpriterKey = timeline.GetKeyViaTime(time)
			Local nextTimelineKey:SpriterKey = timeline.keys.Get(objRef.key + 1)
			Local nextKeyTime:Int
			
			If nextTimelineKey = Null Then
				If anim.looping = LOOPING_TRUE
					nextTimelineKey = timeline.keys.Get(0)
					nextKeyTime = anim.length
					' next timeline might not start at the beginning of the animation
					If nextTimelineKey.time &gt; 0 Then
						nextKeyTime += nextTimelineKey.time
					End
				Else If anim.looping = LOOPING_PING_PONG
					If timer.direction = timer.UP
						nextKeyTime = anim.length
					Else
						nextKeyTime = 0
					End
					nextTimelineKey = timelineKey
				Else If anim.looping = LOOPING_FALSE
					nextTimelineKey = timelineKey
					nextKeyTime = anim.length	
				End
			Else
				nextKeyTime = nextTimelineKey.time
			End
			
			Local nextO:SpriterObject = nextTimelineKey.objects.Last()

			For Local o:SpriterObject = Eachin timelineKey.objects
				Local folder:SpriterFolder = Self.folders.Get(o.folder)
				Local file:SpriterFile = folder.files.Get(o.file)
				Local texture:Image = textures.GetTexture(Self.mainPath + "/" + file.name.ToUpper())
				Local px:Float = o.pivotX * texture.Width()
				Local py:Float = texture.Height() + (-o.pivotY * texture.Height())
				If o.pivotY = 0 Then py = 0
				If o.pivotX = 0 Then px = 0
				texture.SetHandle(px, py)
				Local currentAngle:Float = o.angle
				Local nextAngle:Float = nextO.angle

				'XOR
				If (scaleX &lt; 0) &lt;&gt; (scaleY &lt; 0) Then
					currentAngle = -currentAngle
					nextAngle = -nextAngle
				End

				If tween
					Local tweenedX:Float = LinearInterpolation(o.x, nextO.x, timelineKey.time, nextKeyTime, timer.GetTime())
					Local tweenedY:Float = LinearInterpolation(o.y, nextO.y, timelineKey.time, nextKeyTime, timer.GetTime())
					Local tweenedAngle:Float = AngleLinearInterpolation(currentAngle, nextAngle, timelineKey.time, nextKeyTime, timer.GetTime())
					Local tweenedScaleX:Float = LinearInterpolation(o.scaleX, nextO.scaleX, timelineKey.time, nextKeyTime, timer.GetTime())
					Local tweenedScaleY:Float = LinearInterpolation(o.scaleY, nextO.scaleY, timelineKey.time, nextKeyTime, timer.GetTime())
					Local tweenedAlpha:Float = LinearInterpolation(o.alpha, nextO.alpha, timelineKey.time, nextKeyTime, timer.GetTime())
					SetAlpha(tweenedAlpha)
					DrawImage(texture, tweenedX * scaleX + x, -tweenedY * scaleY + y, tweenedAngle, tweenedScaleX * scaleX, tweenedScaleY * scaleY, 0)
				Else
					SetAlpha(o.alpha)
					DrawImage(texture, o.x * scaleX + x, -o.y * scaleY + y, currentAngle, o.scaleX * scaleX, o.scaleY * scaleY, 0)
				End
			Next		
			SetAlpha(1)
		Next
	End
	
	Method LinearInterpolation:Float(a:Float, b:Float, timeA:Float, timeB:Float, currentTime:Float)
		Return a + ((b - a) * ((currentTime - timeA) / (timeB - timeA)))
	End
	
	Method AngleLinearInterpolation:Float(a:Float, b:Float, timeA:Float, timeB:Float, currentTime:Float)
		return a + (AngleDifference(b, a) * ((currentTime - timeA) / (timeB - timeA)))
	End
	
	Method AngleDifference:Float(a:Float, b:Float)
		Return ((((a - b) Mod 360) + 540) Mod 360) - 180
	End
	
	Method SetScale:Void(scaleX:Float, scaleY:Float)
		Self.scaleX = scaleX
		Self.scaleY = scaleY
	End
End

Class SpriterFolder
	Field files:IntMap&lt;SpriterFile&gt;
	Field id:Int
	Field name:String
	
	Method New()
		Self.files = New IntMap&lt;SpriterFile&gt;
	End
End

Class SpriterFile
	Field id:Int
	Field name:String
	Field width:Int
	Field height:Int
End

Class SpriterEntity
	Field id:Int
	Field name:String
	Field animations:StringMap&lt;SpriterAnimation&gt;
	
	Method New()
		Self.animations = New StringMap&lt;SpriterAnimation&gt;
	End
End

Class SpriterAnimation
	Field id:Int
	Field name:String
	Field length:Int
	Field looping:Int
	Field mainline:SpriterMainline
	Field timelines:IntMap&lt;SpriterTimeline&gt;
	Field maxKey:Int
	
	Method New()
		Self.mainline = New SpriterMainline
		Self.timelines = New IntMap&lt;SpriterTimeline&gt;
	End
End

Class SpriterMainline
	Field keys:IntMap&lt;SpriterKey&gt;
	Field keyId:Int = 0
	Field delay:Float = 0
	Field maxDelay:Int = 5
	Field speed:Float = 1.5
	Field maxKey:Int
		
	Method New()
		Self.keys = New IntMap&lt;SpriterKey&gt;
	End
		
	Method GetKey:SpriterKey(timer:Timer)
		Local rv:SpriterKey = Self.keys.Get(0)
		For Local i:Int = Eachin Self.keys.Keys()
			Local key:SpriterKey = Self.keys.Get(i)
			If key.time &gt; timer.GetTime()
				Return rv
			End
			rv = key
		Next
		Return rv
	End
	
	Method GetKeyViaTime:SpriterKey(time:Float)
		Local rv:SpriterKey = Self.keys.Get(0)
		For Local i:Int = Eachin Self.keys.Keys()
			Local key:SpriterKey = Self.keys.Get(i)
			If key.time &gt; time
				Return rv
			End
			rv = key
		Next
		Return rv
	End

End

Class SpriterKey
	Field id:Int
	Field time:Int
	Field spin:Int
	Field objectRefs:IntMap&lt;SpriterObjectRef&gt;
	Field objects:List&lt;SpriterObject&gt;
	Field boneRefs:IntMap&lt;SpriterBoneRef&gt;
	Field bones:List&lt;SpriterBone&gt;
	
	Method New()
		Self.objectRefs = New IntMap&lt;SpriterObjectRef&gt;
		Self.objects = New List&lt;SpriterObject&gt;
		Self.boneRefs = New IntMap&lt;SpriterBoneRef&gt;
		Self.bones = New List&lt;SpriterBone&gt;
	End
End

Class SpriterBoneRef
	Field id:Int
	Field timeline:Int
	Field parent:Int
	Field key:Int
End

Class SpriterObjectRef
	Field id:Int
	Field timeline:Int
	Field key:Int
	Field zIndex:Int
	Field parent:Int
End

Class SpriterTimeline
	Field id:Int
	Field keys:IntMap&lt;SpriterKey&gt;
	Field keyId:Int = 0
	Field delay:Float = 0
	Field maxDelay:Int = 5
	Field speed:Float = 1.5
	Field maxKey:Int
	Field name:String
	
	Method New()
		Self.keys = New IntMap&lt;SpriterKey&gt;
	End
	
	Method GetKey:SpriterKey(timer:Timer)
		Local rv:SpriterKey = Self.keys.Get(0)
		For Local i:Int = Eachin Self.keys.Keys()
			Local key:SpriterKey = Self.keys.Get(i)
			If key.time &gt; timer.GetTime()
				Return rv
			End
			rv = key
		Next
		Return rv
	End
	
	Method GetKeyViaTime:SpriterKey(time:Float)
		Local rv:SpriterKey = Self.keys.Get(0)
		For Local i:Int = Eachin Self.keys.Keys()
			Local key:SpriterKey = Self.keys.Get(i)
			If key.time &gt; time
				Return rv
			End
			rv = key
		Next
		Return rv
	End

End

Class SpriterObject
	Field folder:Int
	Field file:Int
	Field x:Float
	Field y:Float
	Field pivotX:Float
	Field pivotY:Float
	Field angle:Float
	Field scaleX:Float
	Field scaleY:Float
	Field alpha:Float
End

Class SpriterBone
	Field x:Float
	Field y:Float
	Field angle:Float
	Field scaleX:Float
	Field scaleY:Float
End

Class SpriterImporter
	Function ImportFile:MonkeySpriter(path:String, file:String, debug:Bool = False)
		If debug Then Print "Importing " + path + "/" + file

		Local str:String = LoadString(path + "/" + file)
		If str = "" Then Error "Error loading file..."
		
		Local xmlReader:XMLParser = New XMLParser		
		Local doc:XMLDocument = xmlReader.ParseString(str)
		Local rootElement:XMLElement = doc.Root

		Local smo:MonkeySpriter = New MonkeySpriter()
		smo.mainPath = path
		For Local folderElement:XMLElement = Eachin rootElement.GetChildrenByName("folder")
			Local folder:SpriterFolder = New SpriterFolder()
			folder.id = Int(folderElement.GetAttribute("id"))
			folder.name = folderElement.GetAttribute("name")
			If debug Print "folder = " + folder.id + " " + folder.name
			
			For Local fileElement:XMLElement = Eachin folderElement.GetChildrenByName("file")
				Local file:SpriterFile = New SpriterFile()
				file.id = Int(fileElement.GetAttribute("id"))
				file.name = fileElement.GetAttribute("name")
				file.width = Int(fileElement.GetAttribute("width"))
				file.height = Int(fileElement.GetAttribute("height"))
				
				If debug Print "file = " + file.id + " " + file.name
				smo.textures.Load(path + "/" + file.name)
				
				folder.files.Add(file.id, file)
			Next
			smo.folders.Add(folder.id, folder)
		Next
		
		For Local entityElement:XMLElement = Eachin rootElement.GetChildrenByName("entity")
			Local entity:SpriterEntity = New SpriterEntity()
			Local id:String = entityElement.GetAttribute("id")
			Local name:String = entityElement.GetAttribute("name")
			
			If debug Print "entity = " + id + " " + name
			For Local animationElement:XMLElement = Eachin entityElement.GetChildrenByName("animation")
				Local animation:SpriterAnimation = New SpriterAnimation()
				animation.id  = Int(animationElement.GetAttribute("id"))
				animation.name = animationElement.GetAttribute("name")
				animation.length = Int(animationElement.GetAttribute("length"))
				Local looping:String = animationElement.GetAttribute("looping", MonkeySpriter.LOOPING_FALSE)
				Select looping
					Case "true"
						animation.looping = MonkeySpriter.LOOPING_TRUE
					Case "false"
						animation.looping = MonkeySpriter.LOOPING_FALSE
					Case "ping_pong"
						animation.looping = MonkeySpriter.LOOPING_PING_PONG
				End

				If debug Print "animation = " + animation.id + " " + animation.name
				
				' Should only be one mainline element
				For Local mainlineElement:XMLElement = Eachin animationElement.GetChildrenByName("mainline")
					For Local keyElement:XMLElement = Eachin mainlineElement.GetChildrenByName("key")
						Local skey:SpriterKey = New SpriterKey()
						skey.id = Int(keyElement.GetAttribute("id"))
						skey.time= Int(keyElement.GetAttribute("time", "0"))
						If debug Print "key = " + skey.id + " " + skey.time

						For Local boneRefElement:XMLElement = Eachin keyElement.GetChildrenByName("bone_ref")
							Local boneRef:SpriterBoneRef = New SpriterBoneRef
							boneRef.id = Int(boneRefElement.GetAttribute("id"))
							boneRef.parent = Int(boneRefElement.GetAttribute("parent", "-1"))
							boneRef.timeline = Int(boneRefElement.GetAttribute("timeline"))
							boneRef.key = Int(boneRefElement.GetAttribute("key"))
							If debug Then Print "bone_ref = " + boneRef.id + " " + boneRef.timeline
							skey.boneRefs.Add(boneRef.id, boneRef)
						Next

						For Local objectRefElement:XMLElement = Eachin keyElement.GetChildrenByName("object_ref")
							Local objectRef:SpriterObjectRef = New SpriterObjectRef
							objectRef.id = Int(objectRefElement.GetAttribute("id"))
							objectRef.timeline = Int(objectRefElement.GetAttribute("timeline"))
							objectRef.key = Int(objectRefElement.GetAttribute("key"))
							objectRef.zIndex = Int(objectRefElement.GetAttribute("z_index"))
							objectRef.parent = Int(objectRefElement.GetAttribute("parent", "-1"))
							If debug Print "object_ref = " + objectRef.id + " " + objectRef.timeline + " " + objectRef.parent
							
							skey.objectRefs.Add(objectRef.id, objectRef)
						Next
						animation.mainline.keys.Add(skey.id, skey)
						animation.maxKey = skey.id
					Next	
				Next
				
				For Local timelineElement:XMLElement = Eachin animationElement.GetChildrenByName("timeline")
					Local timeline:SpriterTimeline = New SpriterTimeline()
					timeline.id = Int(timelineElement.GetAttribute("id"))
					timeline.name = timelineElement.GetAttribute("id", "")
					If debug Print "timeline = " + timeline.id + " " + timeline.name
					
					For Local keyElement:XMLElement = Eachin timelineElement.GetChildrenByName("key")
						Local key:SpriterKey = New SpriterKey()
						key.id = Int(keyElement.GetAttribute("id"))
						key.time = Int(keyElement.GetAttribute("time", "0"))
						key.spin = Int(keyElement.GetAttribute("spin", "1"))
						If debug Print "key = " + key.id + " " + key.time + " " + key.spin
						
						For Local boneElement:XMLElement = Eachin keyElement.GetChildrenByName("bone")
							Local b:SpriterBone = New SpriterBone()
							b.x = Float(boneElement.GetAttribute("x", "0"))
							b.y = Float(boneElement.GetAttribute("y", "0"))
							b.angle = Float(boneElement.GetAttribute("angle", "0"))
							b.scaleX = Float(boneElement.GetAttribute("scale_x", "1"))
							b.scaleY = Float(boneElement.GetAttribute("scale_y", "1"))
							
							If debug Print "bone = " + b.x + " " + b.y + " " + b.angle
							
							key.bones.AddLast(b)
						Next
						
						For Local objectElement:XMLElement = Eachin keyElement.GetChildrenByName("object")						
							Local o:SpriterObject = New SpriterObject()
							o.folder = Int(objectElement.GetAttribute("folder"))
							o.file = Int(objectElement.GetAttribute("file"))
							o.x = Float(objectElement.GetAttribute("x", "0"))
							o.y = Float(objectElement.GetAttribute("y", "0"))
							o.pivotX = Float(objectElement.GetAttribute("pivot_x", "0"))
							o.pivotY = Float(objectElement.GetAttribute("pivot_y", "0"))
							o.angle = Float(objectElement.GetAttribute("angle", "0"))
							o.scaleX = Float(objectElement.GetAttribute("scale_x", "1"))
							o.scaleY = Float(objectElement.GetAttribute("scale_y", "1"))
							o.alpha = Float(objectElement.GetAttribute("a", "1"))
							
							If debug Print "object = " + o.folder + " " + o.file + " " + o.angle
														
							key.objects.AddLast(o)
						Next
						timeline.keys.Add(key.id, key)
					Next
					animation.timelines.Add(timeline.id, timeline)
				Next
				entity.animations.Add(animation.name, animation)
			Next
			smo.entities.Add(entity.id, entity)
		Next
		Return smo
	End
End

Class TextureProvider Extends StringMap&lt;Image&gt;
	Method Load:Image(name:String)
		Local storeKey:String = name.ToUpper()

		Local i:Image = New Image
		Local imgName:String = name

		i = LoadImage(imgName )', 1, flags)
		If i = Null
			Error "Error loading image "+name
		End
		'Print "storing "+storeKey
		Self.Set(storeKey, i)
		Return i
	End
	
	Method DisplayAllStored:Void()
		' debug: print all keys in the map
		For Local key:String = Eachin Self.Keys()
			Print key + " is stored in the map."
		Next
	End
	
	Method GetTexture:Image(name:String)
		name = name.ToUpper()
	   	
		Local i:Image= Self.Get(name)
		If i = Null Then Error("Image '" + name + "' not found in the TextureProvider")
		Return i
	End	
End

Class Timer
	Field stopped:Bool
	Field rate:Float
	Const UP:Int = 1
	Const DOWN:Int = -1
	Field direction:Int
	Field count:Float
	
	Method New()
		stopped = True
		rate = 1
		direction = UP
	End
	
	Method Start:Void()
		Reset()
		Resume()
		rate = 1
	End
	
	Method Stop:Void()
		If Not stopped
			stopped = True
		End
	End
	
	Method Resume:Void()
		If stopped
			stopped = False
		End
	End
	
	Method Reset:Void()
		count = 0
		direction = UP
	End
	
	Method GetTime:Float()
		Return count / rate
	End

	Method Update:Void(timeElapsed:Int)
		If direction = UP
			count+=timeElapsed
		Else
			count-=timeElapsed
		End
	End
End</textarea> <br><br></td></tr></table><br>
<a name="1177706"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >SLotman</td><td align="right"><font class=tiny>(Posted 2013)</font>&nbsp;<a href="#12">[#12]</a></td></tr></table></td></tr><tr ><td class="posttext"> About the file/folder thing: I know - but the 0,0 part I can see right in the beginning of the scml file, so it won't bother me that much :)<br><br>As for bones... I'm not using them myself, no need to create any unnecessary overheads :) <br><br>But I just found out a problem with the code - one animation I made is being played incorrectly: body parts moving erratically, with some parts flying away very far from where they should be.<br><br>Get <a href="http://www.icongames.com.br/temp/bdevil1.zip" target="_blank">the problematic animation</a> to see it: it runs fine on Spriter, but on the test program, it's completely crazy. (I guess it has anything to do with changing the anchor rotation points in Spriter - It was the first animation where I actually did that) <br><br></td></tr></table><br>
<a name="1177734"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >therevills</td><td align="right"><font class=tiny>(Posted 2013)</font>&nbsp;<a href="#13">[#13]</a></td></tr></table></td></tr><tr ><td class="posttext"> Thanks for the test file, you can see its the tweening which is messing up as when you turn off tweening it displays the keyframes correctly. <br><br></td></tr></table><br>
<a name="1177788"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >therevills</td><td align="right"><font class=tiny>(Posted 2013)</font>&nbsp;<a href="#14">[#14]</a></td></tr></table></td></tr><tr ><td class="posttext"> Yep, you are correct its the pivot points changes in the timeline which is messing it up...<br><br>I'll have to have a think how to fix that... as when you set the pivot in Spriter it actually changes the X,Y position of the object. <br><br></td></tr></table><br>
<a name="1177803"></a>

<a name="1177804"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >therevills</td><td align="right"><font class=tiny>(Posted 2013)</font>&nbsp;<a href="#15">[#15]</a></td></tr></table></td></tr><tr ><td class="posttext"> Okay this is getting tricky...<br><br>Say on key frame 1 the pivot for the head is at 20, 74 and on key frame 2 its at 24, 150, but the actual image doesn't move. The tween is between 74 and 150 forcing the head to move upwards.<br><br>I could minus the pivots off the co-ords, but only if I don't use "SetHandle":<br><br><pre class=code>       |Frame 1 | Frame 2
-------+--------+---------
  x    | 20     | 24
  y    | 74     | 150
pivotX | 0.617  | 0.503
pivotY | 0.157  | 0.778

Image Height = 121 pixels

Just looking at Y:
Frame 1:
pivotYPoint = 0.157 * 121 = 18.997

newY = 74 - 18.997 = 55

Frame 2:
pivotYPoint = 0.778 * 121 = 94.138

newY = 150 - 94.138 = 56</pre><br><br>But of course now all the angles wont be rotated at the correct point.... :( <br><br></td></tr></table><br>
<a name="1177842"></a>

<a name="1177843"></a>

<a name="1177853"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >SLotman</td><td align="right"><font class=tiny>(Posted 2013)</font>&nbsp;<a href="#16">[#16]</a></td></tr></table></td></tr><tr ><td class="posttext"> Yikes! Maybe looking into other "plugins" may help a little?<br><br>Anyway - this isn't something "essential" for me - I can live with it (I've made several anims already just to stress test the system, and none changing the pivot position)<br><br>Edit: for me, the most concerning issue is the "texture packing" thing - I just made a test with almost 100 chars on screen, and the FPS dropped severely :( <br><br></td></tr></table><br>
<a name="1177992"></a>

<a name="1177993"></a>

<a name="1177994"></a>

<a name="1177995"></a>

<a name="1177996"></a>

<a name="1177997"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >therevills</td><td align="right"><font class=tiny>(Posted 2013)</font>&nbsp;<a href="#17">[#17]</a></td></tr></table></td></tr><tr ><td class="posttext"> Fixed it! Thank gawd!!!<br><br><textarea class=codebox name="code" wrap=OFF readonly="true" rows="15" cols="80">#TEXT_FILES="*.txt|*.xml|*.json|*.SCML|*.scml"
Strict
Import mojo
Import diddy.xml

Function Main:Int()
	New Game()
	Return 0
End

'-------------------------- Monkey Spriter Demo --------------------------
Class Game Extends App
	
	Field monster:MonkeySpriter
	Field hero:MonkeySpriter
	Field bones:MonkeySpriter
	Field devil:MonkeySpriter
	
	Const IDLE:String = "Idle"
	Const POSTURE:String = "Posture"
	Field monsterAnimName:String = IDLE
	
	Const IDLEH:String = "idle_healthy"
	Const WALK:String = "walk"
	Field heroAnimName:String = IDLEH
	Field flipX:Bool
	Field flipY:Bool
	Field lastMillisecs:Int
	Field currentMillisecs:Int 
	Field timeElapsed:Int
	Field tween:Bool = True
	Field loopType:Int
	Field scaleX:Float = 1
	Field scaleY:Float = 1
	Field debug:Bool
	
	Method OnCreate:Int()
		monster = SpriterImporter.ImportFile("monster", "Example.SCML")
		hero = SpriterImporter.ImportFile("example hero", "BetaFormatHero.SCML")
		bones = SpriterImporter.ImportFile("BoneExample", "Basic_Platformer.scml")
		devil = SpriterImporter.ImportFile("bdevil1", "bdevil1.scml")
	'	devil = SpriterImporter.ImportFile("testdevil", "testdevil.scml")
		
		monster.x = DeviceWidth() / 2
		monster.y = DeviceHeight() - 20
		hero.x = DeviceWidth() / 2 - 200
		hero.y = DeviceHeight() - 20
		bones.x = DeviceWidth() / 2
		bones.y = -100' DeviceHeight() / 2
		
		devil.x = 200
		devil.y = 400
		
		devil.timer.Start()
		bones.timer.Start()
		monster.timer.Start()
		hero.timer.Start()		
		SetUpdateRate(60)
		lastMillisecs = Millisecs()
		loopType = MonkeySpriter.LOOPING_TRUE
		debug = false
		CreateGUI()
		Return 0
	End
	
	Method CreateGUI:Void()
		Local b:Button = New Button("Anim 1", 0, 10, 100, 20)
		b.SetColour(255, 0, 0)
		b = New Button("Anim 2", 110, 10, 100, 20)

		b = New Button("Loop Type", 220, 10, 100, 20)
		b.SetColour(255, 255, 0)
		
		b = New Button("Reset Timer", 330, 10, 100, 20)
		b.SetColour(255, 0, 255)
		
		b = New Button("Stop Timer", 440, 10, 100, 20)
		b.SetColour(0, 255, 255)
		
		b = New Button("Resume Timer", 550, 10, 100, 20)
		b.SetColour(0, 255, 0)
		
		b = New Button("Slower", 440, 40, 100, 20)
		b.SetColour(100, 100, 100)
		
		b = New Button("Faster", 550, 40, 100, 20)
		b.SetColour(0, 0, 255)
		
		b = New Button("Tween On/Off", 330, 40, 100, 20)
		b.SetColour(25, 255, 25)

		b = New Button("Flip X", 0, 70, 100, 20)
		b.SetColour(25, 255, 125)	

		b = New Button("Flip Y", 110, 70, 100, 20)
		b.SetColour(123, 123, 255)	

		b = New Button("Scale Up", 0, 40, 100, 20)
		b.SetColour(255, 33, 125)	
		
		b = New Button("Scale Down", 110, 40, 100, 20)
		b.SetColour(125, 0, 125)
		
		b = New Button("Debug On/Off", 220, 40, 100, 20)
		b.SetColour(125, 230, 234)	
	End
	
	Method OnUpdate:Int()
		' simple delta timing
		currentMillisecs = Millisecs()
		timeElapsed = currentMillisecs - lastMillisecs 
		lastMillisecs = currentMillisecs

		hero.Update(heroAnimName, loopType, timeElapsed)
		monster.Update(monsterAnimName, loopType, timeElapsed)
		
		bones.Update("Player_Idle", loopType, timeElapsed)
		
		devil.Update("idle", loopType, timeElapsed)
		Controls()
		Return 0
	End	
	
	Method OnRender:Int()
		Cls
		monster.Draw(tween)
		hero.Draw(tween)
		bones.Draw(tween)
		devil.Draw(tween)
		
		Button.DrawAll()
		If debug Then DrawDebug()
		Return 0
	End
	
	Method Controls:Void()
		Button.UpdateAll()
		If Button.Clicked("Debug On/Off") Then
			debug = Not debug
		End
		If Button.Clicked("Scale Up") Then
			scaleX *= 1.1
			scaleY *= 1.1
			monster.SetScale(scaleX, scaleY)
			hero.SetScale(scaleX, scaleY)
			bones.SetScale(scaleX, scaleY)
		End
		If Button.Clicked("Scale Down") Then
			scaleX /= 1.1
			scaleY /= 1.1
			monster.SetScale(scaleX, scaleY)
			hero.SetScale(scaleX, scaleY)
			bones.SetScale(scaleX, scaleY)
		End
		If Button.Clicked("Flip X") Then
			scaleX = -scaleX
			monster.SetScale(scaleX, monster.scaleY)
			hero.SetScale(scaleX, monster.scaleY)
		End
		If Button.Clicked("Flip Y") Then
			scaleY = -scaleY
			monster.SetScale(monster.scaleX, scaleY)
			hero.SetScale(hero.scaleX, scaleY)
			monster.y = DeviceHeight() - monster.y
			hero.y = DeviceHeight() - hero.y
		End
		If Button.Clicked("Stop Timer") Then
			monster.timer.Stop()
			hero.timer.Stop()
			devil.timer.Stop()
		End
		If Button.Clicked("Resume Timer") Then
			monster.timer.Resume()
			hero.timer.Resume()
			devil.timer.Resume()
		End
		If Button.Clicked("Reset Timer") Then
			monster.timer.Start()
			hero.timer.Start()
			monster.mainlineKeyId = 0
			hero.mainlineKeyId = 0
		End
		If Button.Clicked("Faster") Then
			hero.timer.rate/=1.1
			monster.timer.rate/=1.1
		End
		If Button.Clicked("Slower") Then
			hero.timer.rate*=1.1
			monster.timer.rate*=1.1
			devil.timer.rate*=1.1
		End
		If Button.Clicked("Anim 1") Then
			monsterAnimName = IDLE
			heroAnimName = IDLEH
			monster.mainlineKeyId = 0
			monster.timer.Start()
			hero.mainlineKeyId = 0
			hero.timer.Start()
		End
		If Button.Clicked("Anim 2") Then
			monsterAnimName = POSTURE
			heroAnimName = WALK
			monster.mainlineKeyId = 0
			monster.timer.Start()
			hero.mainlineKeyId = 0
			hero.timer.Start()
		End
		If Button.Clicked("Tween On/Off") Then
			tween = Not tween
		End
		If Button.Clicked("Loop Type") Then
			monster.timer.Start()
			hero.timer.Start()
			monster.mainlineKeyId = 0
			hero.mainlineKeyId = 0
			loopType += 1
			If loopType &gt; 2 loopType = 0
		End
		
		If KeyDown(KEY_W) hero.y-=2
		If KeyDown(KEY_S) hero.y+=2
		If KeyDown(KEY_A) hero.x-=2
		If KeyDown(KEY_D) hero.x+=2
	End
	
	Method DrawDebug:Void()
		Local y:Int = 100
		Local gap:Int = 15
		SetAlpha(0.75)
		DrawText("MONKEY SPRITER IMPORTER", 10, y)
		y+=gap
		y+=gap
		DrawText("Monster Timer = " + monster.timer.GetTime(), 10, y)
		y+=gap
		DrawText("Hero Timer    = " + hero.timer.GetTime(), 10, y)
		y+=gap
		DrawText("Devil Timer   = " + devil.timer.GetTime(), 10, y)
		y+=gap
		DrawText("Time Elapsed  = " + timeElapsed, 10, y)
		y+=gap
		Local loopString:String
		Select loopType
			Case 0
				loopString = "FALSE"
			Case 1
				loopString = "TRUE"
			Case 2
				loopString = "PING PONG"
		End
		DrawText("Looping Type  = " + loopString, 10, y)
		y+=gap
		DrawText("Timer Rate    = " + monster.timer.rate, 10, y)
		y+=gap
		If tween
			DrawText("Tweening      = TRUE", 10, y)
		Else
			DrawText("Tweening      = FALSE", 10, y)
		End
		y+=gap
		DrawText("Scale X       = " + scaleX, 10, y)
		y+=gap
		DrawText("Scale Y       = " + scaleY, 10, y)

		SetAlpha(1)
	End
End
'-------------------------- Simple Button --------------------------
Class Button
	Field x:Int, y:Int
	Field w:Int, h:Int
	Field label:String
	Field name:String
	Field r:Int = 255, g:Int = 255, b:Int = 255
	Field mouseOver:Bool = False
	Field clicked:Bool = False
	Global clickedName:String = ""
	Global list:List&lt;Button&gt;
	
	Method New(label:String, x:Int, y:Int, w:Int, h:Int)
		If list = Null Then list = New List&lt;Button&gt;
		Self.label = label
		Self.name = label.ToUpper()
		Self.x = x
		Self.y = y
		Self.w = w
		Self.h = h
		
		list.AddLast(Self)
	End
	
	Method SetColour:Void(r:Int, g:Int, b:Int)
		Self.r = r
		Self.g = g
		Self.b = b
	End
	
	Method Update:Void()
		If RectsOverlap(MouseX(), MouseY(), 3, 3, Self.x, Self.y, Self.w, Self.h)
			mouseOver = True
			If MouseHit(MOUSE_LEFT)
				If Not clicked
					clicked = True
				End
			Else
				clicked = False
			End
		Else
			clicked = False
			mouseOver = False
		End
	End
	
	Method Draw:Void()
		Local light:Int = -25
		If mouseOver
			light = 120
			SetAlpha(1)
		End
		SetColor (r + light, g + light, b + light)
		DrawRect (x, y, w, h)
		SetColor (255, 255, 255)
		DrawText (label, x + 2, y + 2)
	End
	
	Function DrawAll:Void()
		For Local b:Button = Eachin list
			SetAlpha(0.75)
			b.Draw()
		End
		SetAlpha(1)		
	End
	
	Function Clicked:Int(name:String)
		name = name.ToUpper()
		If name = clickedName
			clickedName = ""
			Return 1		
		Else
			Return 0
		End
	End
	
	Function UpdateAll:Void()
		clickedName = ""
		For Local b:Button = Eachin list
			b.Update()
			If b.clicked Then clickedName = b.name
		End
	End
End

Function RectsOverlap:Int(x0:Float, y0:Float, w0:Float, h0:Float, x2:Float, y2:Float, w2:Float, h2:Float)
	If x0 &gt; (x2 + w2) Or (x0 + w0) &lt; x2 Then Return False
	If y0 &gt; (y2 + h2) Or (y0 + h0) &lt; y2 Then Return False
	Return True
End

'-------------------------- Monkey Spriter Code --------------------------
Class MonkeySpriter
	Field textures:TextureProvider = New TextureProvider()
	Field folders:IntMap&lt;SpriterFolder&gt;
	Field entities:IntMap&lt;SpriterEntity&gt;
	Field mainPath:String
	Field animationName:String
	Field nextKeyTime:Int
	Field mainlineKeyId:Int
	Field timer:Timer
	Field scaleX:Float = 1
	Field scaleY:Float = 1
	Field x:Float, y:Float
	Const LOOPING_FALSE:Int = 0
	Const LOOPING_TRUE:Int = 1
	Const LOOPING_PING_PONG:Int = 2
	
	Method New()
		Self.folders = New IntMap&lt;SpriterFolder&gt;
		Self.entities = New IntMap&lt;SpriterEntity&gt;
		mainlineKeyId = 0
		timer = New Timer
	End
	
	Method Copy:MonkeySpriter()
		Local ms:MonkeySpriter = New MonkeySpriter
		ms.textures = Self.textures
		ms.folders  = Self.folders
		ms.entities = Self.entities
		ms.mainPath = Self.mainPath
		ms.animationName = Self.animationName
		ms.nextKeyTime   = Self.nextKeyTime
		ms.mainlineKeyId = Self.mainlineKeyId
		ms.timer = New Timer
		ms.scaleX = Self.scaleX
		ms.scaleY = Self.scaleY
		ms.x = Self.x
		ms.y = Self.y
		Return ms
	End Method
	
	Method Update:Void(animationName:String, looping:Int = LOOPING_TRUE, timeElapsed:Int)
		Self.animationName = animationName
		If Not timer.stopped
			timer.Update(timeElapsed)
			Local animation:SpriterAnimation
			Try
				animation = entities.Get(0).animations.Get(animationName)
				If animation = Null Then Throw New Throwable
			Catch ex:Throwable
        		Print "Animation is null! Can not find animation " + animationName
			End
			
			If looping &lt;&gt; "" Then
				animation.looping = looping
			End
			Local mainline:SpriterMainline = animation.mainline
			If timer.GetTime() &gt;= animation.length
				If animation.looping = LOOPING_TRUE
					timer.Reset()
				Else If animation.looping = LOOPING_PING_PONG
					timer.direction = timer.DOWN
				Else If animation.looping = LOOPING_FALSE
					timer.Stop()
				End
			End
			If animation.looping = LOOPING_PING_PONG And timer.GetTime() &lt;= 0
				timer.direction = timer.UP
				timer.Reset()
			End
		End		
	End
	
	Method Draw:Void(tween:Bool = False)
		Local anim:SpriterAnimation = entities.Get(0).animations.Get(animationName)
		If anim = Null Return
		Local mainline:SpriterMainline = anim.mainline
		
		Local time:Float = timer.GetTime()
		mainlineKeyId = mainline.GetKeyViaTime(time).id
		Local mainlineKey:SpriterKey = mainline.keys.Get(mainlineKeyId)
		
		Local boneMap:IntMap&lt;SpriterBone&gt; = New IntMap&lt;SpriterBone&gt;
		For Local i:Int = Eachin mainlineKey.boneRefs.Keys()
			Local boneRef:SpriterBoneRef = mainlineKey.boneRefs.Get(i)
			Local timeline:SpriterTimeline = anim.timelines.Get(boneRef.timeline)
			Local timelineKey:SpriterKey = timeline.GetKeyViaTime(time)
			Local nextTimelineKey:SpriterKey = timeline.keys.Get(boneRef.key + 1)
			Local nextKeyTime:Int
			
			For Local b:SpriterBone = Eachin timelineKey.bones
				boneMap.Add(i, b)
			Next
		Next

		For Local i:Int = Eachin mainlineKey.objectRefs.Keys()
			Local objRef:SpriterObjectRef = mainlineKey.objectRefs.Get(i)
			Local timeline:SpriterTimeline = anim.timelines.Get(objRef.timeline)
			Local timelineKey:SpriterKey = timeline.GetKeyViaTime(time)
			Local nextTimelineKey:SpriterKey = timeline.keys.Get(objRef.key + 1)
			Local nextKeyTime:Int
			
			If nextTimelineKey = Null Then
				If anim.looping = LOOPING_TRUE
					nextTimelineKey = timeline.keys.Get(0)
					nextKeyTime = anim.length
					' next timeline might not start at the beginning of the animation
					If nextTimelineKey.time &gt; 0 Then
						nextKeyTime += nextTimelineKey.time
					End
				Else If anim.looping = LOOPING_PING_PONG
					If timer.direction = timer.UP
						nextKeyTime = anim.length
					Else
						nextKeyTime = 0
					End
					nextTimelineKey = timelineKey
				Else If anim.looping = LOOPING_FALSE
					nextTimelineKey = timelineKey
					nextKeyTime = anim.length	
				End
			Else
				nextKeyTime = nextTimelineKey.time
			End
			
			Local nextO:SpriterObject = nextTimelineKey.objects.Last()

			Local bone:SpriterBone
			If objRef.parent &gt; -1
			'	bone = boneMap.Get(objRef.parent)
			End

			For Local o:SpriterObject = Eachin timelineKey.objects
				Local folder:SpriterFolder = Self.folders.Get(o.folder)
				Local file:SpriterFile = folder.files.Get(o.file)
				Local texture:Image = textures.GetTexture(Self.mainPath + "/" + file.name.ToUpper())

				Local nextFolder:SpriterFolder = Self.folders.Get(nextO.folder)
				Local nextFile:SpriterFile = nextFolder.files.Get(nextO.file)
				Local nextTexture:Image = textures.GetTexture(Self.mainPath + "/" + nextFile.name.ToUpper())
			
				Local currentAngle:Float = o.angle
				Local nextAngle:Float = nextO.angle

				'XOR
				If (scaleX &lt; 0) &lt;&gt; (scaleY &lt; 0) Then
					currentAngle = -currentAngle
					nextAngle = -nextAngle
				End

				If 1=0'bone
					Local bx# = (bone.x)+ x
					Local by# = (bone.y) + y
					Local ba# = 90'bone.angle
					Local bsx# = 1'bone.scaleX' * scaleX
					Local bsy# =  1'bone.scaleY' * scaleY
					DrawImage(texture, bx, by, ba, bsx, bsy, 0)
				Else
					If tween
						Local x1# = o.x
						Local x2# = nextO.x
						Local y1# = o.y
						Local y2# = nextO.y
						
						Local tweenedPivotX:Float = LinearInterpolation(o.pivotX, nextO.pivotX, timelineKey.time, nextKeyTime, time)
						Local tweenedPivotY:Float = LinearInterpolation(o.pivotY, nextO.pivotY, timelineKey.time, nextKeyTime, time)
						
						Local tweenedX:Float = LinearInterpolation(x1, x2, timelineKey.time, nextKeyTime, time)
						Local tweenedY:Float = LinearInterpolation(y1, y2, timelineKey.time, nextKeyTime, time)
						Local tweenedAngle:Float = AngleLinearInterpolation(currentAngle, nextAngle, timelineKey.time, nextKeyTime, time)
						Local tweenedScaleX:Float = LinearInterpolation(o.scaleX, nextO.scaleX, timelineKey.time, nextKeyTime, time)
						Local tweenedScaleY:Float = LinearInterpolation(o.scaleY, nextO.scaleY, timelineKey.time, nextKeyTime, time)
						Local tweenedAlpha:Float = LinearInterpolation(o.alpha, nextO.alpha, timelineKey.time, nextKeyTime, time)

						texture.SetHandle(tweenedPivotX * texture.Width(),  nextTexture.Height() + (-tweenedPivotY * nextTexture.Height()))
						
						SetAlpha(tweenedAlpha)
						DrawImage(texture, tweenedX * scaleX + x, -tweenedY * scaleY + y, tweenedAngle, tweenedScaleX * scaleX, tweenedScaleY * scaleY, 0)
					Else
						texture.SetHandle(o.pivotX * texture.Width(),  nextTexture.Height() + (-o.pivotY * nextTexture.Height()))
						SetAlpha(o.alpha)
						DrawImage(texture, o.x * scaleX + x, -o.y * scaleY + y, currentAngle, o.scaleX * scaleX, o.scaleY * scaleY, 0)
					End
				End
			Next		
			SetAlpha(1)
			DrawText timelineKey.id +" " +nextTimelineKey.id, x, y
		Next
	End
	
	Method LinearInterpolation:Float(a:Float, b:Float, timeA:Float, timeB:Float, currentTime:Float)
		Return a + ((b - a) * ((currentTime - timeA) / (timeB - timeA)))
	End
	
	Method AngleLinearInterpolation:Float(a:Float, b:Float, timeA:Float, timeB:Float, currentTime:Float)
		return a + (AngleDifference(b, a) * ((currentTime - timeA) / (timeB - timeA)))
	End
	
	Method AngleDifference:Float(a:Float, b:Float)
		Return ((((a - b) Mod 360) + 540) Mod 360) - 180
	End
	
	Method SetScale:Void(scaleX:Float, scaleY:Float)
		Self.scaleX = scaleX
		Self.scaleY = scaleY
	End
End

Class SpriterFolder
	Field files:IntMap&lt;SpriterFile&gt;
	Field id:Int
	Field name:String
	
	Method New()
		Self.files = New IntMap&lt;SpriterFile&gt;
	End
End

Class SpriterFile
	Field id:Int
	Field name:String
	Field width:Int
	Field height:Int
End

Class SpriterEntity
	Field id:Int
	Field name:String
	Field animations:StringMap&lt;SpriterAnimation&gt;
	
	Method New()
		Self.animations = New StringMap&lt;SpriterAnimation&gt;
	End
End

Class SpriterAnimation
	Field id:Int
	Field name:String
	Field length:Int
	Field looping:Int
	Field mainline:SpriterMainline
	Field timelines:IntMap&lt;SpriterTimeline&gt;
	Field maxKey:Int
	
	Method New()
		Self.mainline = New SpriterMainline
		Self.timelines = New IntMap&lt;SpriterTimeline&gt;
	End
End

Class SpriterMainline
	Field keys:IntMap&lt;SpriterKey&gt;
	Field keyId:Int = 0
	Field delay:Float = 0
	Field maxDelay:Int = 5
	Field speed:Float = 1.5
	Field maxKey:Int
		
	Method New()
		Self.keys = New IntMap&lt;SpriterKey&gt;
	End
		
	Method GetKey:SpriterKey(timer:Timer)
		Local rv:SpriterKey = Self.keys.Get(0)
		For Local i:Int = Eachin Self.keys.Keys()
			Local key:SpriterKey = Self.keys.Get(i)
			If key.time &gt; timer.GetTime()
				Return rv
			End
			rv = key
		Next
		Return rv
	End
	
	Method GetKeyViaTime:SpriterKey(time:Float)
		Local rv:SpriterKey = Self.keys.Get(0)
		For Local i:Int = Eachin Self.keys.Keys()
			Local key:SpriterKey = Self.keys.Get(i)
			If key.time &gt; time
				Return rv
			End
			rv = key
		Next
		Return rv
	End

End

Class SpriterKey
	Field id:Int
	Field time:Int
	Field spin:Int
	Field objectRefs:IntMap&lt;SpriterObjectRef&gt;
	Field objects:List&lt;SpriterObject&gt;
	Field boneRefs:IntMap&lt;SpriterBoneRef&gt;
	Field bones:List&lt;SpriterBone&gt;
	
	Method New()
		Self.objectRefs = New IntMap&lt;SpriterObjectRef&gt;
		Self.objects = New List&lt;SpriterObject&gt;
		Self.boneRefs = New IntMap&lt;SpriterBoneRef&gt;
		Self.bones = New List&lt;SpriterBone&gt;
	End
End

Class SpriterBoneRef
	Field id:Int
	Field timeline:Int
	Field parent:Int
	Field key:Int
End

Class SpriterObjectRef
	Field id:Int
	Field timeline:Int
	Field key:Int
	Field zIndex:Int
	Field parent:Int
End

Class SpriterTimeline
	Field id:Int
	Field keys:IntMap&lt;SpriterKey&gt;
	Field keyId:Int = 0
	Field delay:Float = 0
	Field maxDelay:Int = 5
	Field speed:Float = 1.5
	Field maxKey:Int
	Field name:String
	
	Method New()
		Self.keys = New IntMap&lt;SpriterKey&gt;
	End
	
	Method GetKey:SpriterKey(timer:Timer)
		Local rv:SpriterKey = Self.keys.Get(0)
		For Local i:Int = Eachin Self.keys.Keys()
			Local key:SpriterKey = Self.keys.Get(i)
			If key.time &gt; timer.GetTime()
				Return rv
			End
			rv = key
		Next
		Return rv
	End
	
	Method GetKeyViaTime:SpriterKey(time:Float)
		Local rv:SpriterKey = Self.keys.Get(0)
		For Local i:Int = Eachin Self.keys.Keys()
			Local key:SpriterKey = Self.keys.Get(i)
			If key.time &gt; time
				Return rv
			End
			rv = key
		Next
		Return rv
	End

End

Class SpriterObject
	Field folder:Int
	Field file:Int
	Field x:Float
	Field y:Float
	Field pivotX:Float
	Field pivotY:Float
	Field angle:Float
	Field scaleX:Float
	Field scaleY:Float
	Field alpha:Float
End

Class SpriterBone
	Field x:Float
	Field y:Float
	Field angle:Float
	Field scaleX:Float
	Field scaleY:Float
End

Class SpriterImporter
	Function ImportFile:MonkeySpriter(path:String, file:String, debug:Bool = False)
		If debug Then Print "Importing " + path + "/" + file

		Local str:String = LoadString(path + "/" + file)
		If str = "" Then Error "Error loading file..."
		
		Local xmlReader:XMLParser = New XMLParser		
		Local doc:XMLDocument = xmlReader.ParseString(str)
		Local rootElement:XMLElement = doc.Root

		Local smo:MonkeySpriter = New MonkeySpriter()
		smo.mainPath = path
		For Local folderElement:XMLElement = Eachin rootElement.GetChildrenByName("folder")
			Local folder:SpriterFolder = New SpriterFolder()
			folder.id = Int(folderElement.GetAttribute("id"))
			folder.name = folderElement.GetAttribute("name")
			If debug Print "folder = " + folder.id + " " + folder.name
			
			For Local fileElement:XMLElement = Eachin folderElement.GetChildrenByName("file")
				Local file:SpriterFile = New SpriterFile()
				file.id = Int(fileElement.GetAttribute("id"))
				file.name = fileElement.GetAttribute("name")
				file.width = Int(fileElement.GetAttribute("width"))
				file.height = Int(fileElement.GetAttribute("height"))
				
				If debug Print "file = " + file.id + " " + file.name
				smo.textures.Load(path + "/" + file.name)
				
				folder.files.Add(file.id, file)
			Next
			smo.folders.Add(folder.id, folder)
		Next
		
		For Local entityElement:XMLElement = Eachin rootElement.GetChildrenByName("entity")
			Local entity:SpriterEntity = New SpriterEntity()
			Local id:String = entityElement.GetAttribute("id")
			Local name:String = entityElement.GetAttribute("name")
			
			If debug Print "entity = " + id + " " + name
			For Local animationElement:XMLElement = Eachin entityElement.GetChildrenByName("animation")
				Local animation:SpriterAnimation = New SpriterAnimation()
				animation.id  = Int(animationElement.GetAttribute("id"))
				animation.name = animationElement.GetAttribute("name")
				animation.length = Int(animationElement.GetAttribute("length"))
				Local looping:String = animationElement.GetAttribute("looping", MonkeySpriter.LOOPING_FALSE)
				Select looping
					Case "true"
						animation.looping = MonkeySpriter.LOOPING_TRUE
					Case "false"
						animation.looping = MonkeySpriter.LOOPING_FALSE
					Case "ping_pong"
						animation.looping = MonkeySpriter.LOOPING_PING_PONG
				End

				If debug Print "animation = " + animation.id + " " + animation.name
				
				' Should only be one mainline element
				For Local mainlineElement:XMLElement = Eachin animationElement.GetChildrenByName("mainline")
					For Local keyElement:XMLElement = Eachin mainlineElement.GetChildrenByName("key")
						Local skey:SpriterKey = New SpriterKey()
						skey.id = Int(keyElement.GetAttribute("id"))
						skey.time= Int(keyElement.GetAttribute("time", "0"))
						If debug Print "key = " + skey.id + " " + skey.time

						For Local boneRefElement:XMLElement = Eachin keyElement.GetChildrenByName("bone_ref")
							Local boneRef:SpriterBoneRef = New SpriterBoneRef
							boneRef.id = Int(boneRefElement.GetAttribute("id"))
							boneRef.parent = Int(boneRefElement.GetAttribute("parent", "-1"))
							boneRef.timeline = Int(boneRefElement.GetAttribute("timeline"))
							boneRef.key = Int(boneRefElement.GetAttribute("key"))
							If debug Then Print "bone_ref = " + boneRef.id + " " + boneRef.timeline
							skey.boneRefs.Add(boneRef.id, boneRef)
						Next

						For Local objectRefElement:XMLElement = Eachin keyElement.GetChildrenByName("object_ref")
							Local objectRef:SpriterObjectRef = New SpriterObjectRef
							objectRef.id = Int(objectRefElement.GetAttribute("id"))
							objectRef.timeline = Int(objectRefElement.GetAttribute("timeline"))
							objectRef.key = Int(objectRefElement.GetAttribute("key"))
							objectRef.zIndex = Int(objectRefElement.GetAttribute("z_index"))
							objectRef.parent = Int(objectRefElement.GetAttribute("parent", "-1"))
							If debug Print "object_ref = " + objectRef.id + " " + objectRef.timeline + " " + objectRef.parent
							
							skey.objectRefs.Add(objectRef.id, objectRef)
						Next
						animation.mainline.keys.Add(skey.id, skey)
						animation.maxKey = skey.id
					Next	
				Next
				
				For Local timelineElement:XMLElement = Eachin animationElement.GetChildrenByName("timeline")
					Local timeline:SpriterTimeline = New SpriterTimeline()
					timeline.id = Int(timelineElement.GetAttribute("id"))
					timeline.name = timelineElement.GetAttribute("id", "")
					If debug Print "timeline = " + timeline.id + " " + timeline.name
					
					For Local keyElement:XMLElement = Eachin timelineElement.GetChildrenByName("key")
						Local key:SpriterKey = New SpriterKey()
						key.id = Int(keyElement.GetAttribute("id"))
						key.time = Int(keyElement.GetAttribute("time", "0"))
						key.spin = Int(keyElement.GetAttribute("spin", "1"))
						If debug Print "key = " + key.id + " " + key.time + " " + key.spin
						
						For Local boneElement:XMLElement = Eachin keyElement.GetChildrenByName("bone")
							Local b:SpriterBone = New SpriterBone()
							b.x = Float(boneElement.GetAttribute("x", "0"))
							b.y = Float(boneElement.GetAttribute("y", "0"))
							b.angle = Float(boneElement.GetAttribute("angle", "0"))
							b.scaleX = Float(boneElement.GetAttribute("scale_x", "1"))
							b.scaleY = Float(boneElement.GetAttribute("scale_y", "1"))
							
							If debug Print "bone = " + b.x + " " + b.y + " " + b.angle
							
							key.bones.AddLast(b)
						Next
						
						For Local objectElement:XMLElement = Eachin keyElement.GetChildrenByName("object")						
							Local o:SpriterObject = New SpriterObject()
							o.folder = Int(objectElement.GetAttribute("folder"))
							o.file = Int(objectElement.GetAttribute("file"))
							o.x = Float(objectElement.GetAttribute("x", "0"))
							o.y = Float(objectElement.GetAttribute("y", "0"))
							o.pivotX = Float(objectElement.GetAttribute("pivot_x", "0"))
							o.pivotY = Float(objectElement.GetAttribute("pivot_y", "1"))
							o.angle = Float(objectElement.GetAttribute("angle", "0"))
							o.scaleX = Float(objectElement.GetAttribute("scale_x", "1"))
							o.scaleY = Float(objectElement.GetAttribute("scale_y", "1"))
							o.alpha = Float(objectElement.GetAttribute("a", "1"))
							
							If debug Print "object = " + o.folder + " " + o.file + " " + o.angle
														
							key.objects.AddLast(o)
						Next
						timeline.keys.Add(key.id, key)
					Next
					animation.timelines.Add(timeline.id, timeline)
				Next
				entity.animations.Add(animation.name, animation)
			Next
			smo.entities.Add(entity.id, entity)
		Next
		Return smo
	End
End

Class TextureProvider Extends StringMap&lt;Image&gt;
	Method Load:Image(name:String)
		Local storeKey:String = name.ToUpper()

		Local i:Image = New Image
		Local imgName:String = name

		i = LoadImage(imgName )', 1, flags)
		If i = Null
			Error "Error loading image "+name
		End
		'Print "storing "+storeKey
		Self.Set(storeKey, i)
		Return i
	End
	
	Method DisplayAllStored:Void()
		' debug: print all keys in the map
		For Local key:String = Eachin Self.Keys()
			Print key + " is stored in the map."
		Next
	End
	
	Method GetTexture:Image(name:String)
		name = name.ToUpper()
	   	
		Local i:Image= Self.Get(name)
		If i = Null Then Error("Image '" + name + "' not found in the TextureProvider")
		Return i
	End	
End

Class Timer
	Field stopped:Bool
	Field rate:Float
	Const UP:Int = 1
	Const DOWN:Int = -1
	Field direction:Int
	Field count:Float
	
	Method New()
		stopped = True
		rate = 1
		direction = UP
	End
	
	Method Start:Void()
		Reset()
		Resume()
		rate = 1
	End
	
	Method Stop:Void()
		If Not stopped
			stopped = True
		End
	End
	
	Method Resume:Void()
		If stopped
			stopped = False
		End
	End
	
	Method Reset:Void()
		count = 0
		direction = UP
	End
	
	Method GetTime:Float()
		Return count / rate
	End

	Method Update:Void(timeElapsed:Int)
		If direction = UP
			count+=timeElapsed
		Else
			count-=timeElapsed
		End
	End
End</textarea><br><br><br><div class="quote"> Edit: for me, the most concerning issue is the "texture packing" thing - I just made a test with almost 100 chars on screen, and the FPS dropped severely :(  <br></div><br>What target were you testing on? Also 100 characters is quite a lot...<br>Do you own TexturePacker? I'll have a look on how to use it with this code (Diddy already can load in TP files). <br><br></td></tr></table><br>
<a name="1178002"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >therevills</td><td align="right"><font class=tiny>(Posted 2013)</font>&nbsp;<a href="#18">[#18]</a></td></tr></table></td></tr><tr ><td class="posttext"> Decided on uploading the code to Google Code:<br><br><a href="https://code.google.com/p/monkey-spriter-importer/" target="_blank">https://code.google.com/p/monkey-spriter-importer/</a> <br><br></td></tr></table><br>
<a name="1178020"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >therevills</td><td align="right"><font class=tiny>(Posted 2013)</font>&nbsp;<a href="#19">[#19]</a></td></tr></table></td></tr><tr ><td class="posttext"> Added Sparrow Atlas support and updated the example to benchmark it...<br><br>I get 60FPS in HTML5 (IE10) using an Atlas and not using an Atlas, with 103 characters on screen... <br><br></td></tr></table><br>
<a name="1178136"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >therevills</td><td align="right"><font class=tiny>(Posted 2013)</font>&nbsp;<a href="#20">[#20]</a></td></tr></table></td></tr><tr ><td class="posttext"> WIP Bones Added... <br><br></td></tr></table><br>
<a name="1179854"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >therevills</td><td align="right"><font class=tiny>(Posted 2013)</font>&nbsp;<a href="#21">[#21]</a></td></tr></table></td></tr><tr ><td class="posttext"> Managed to "fake" bones flipping:<br><br><a href="http://www.therevillsgames.com/monkey/SpriterA4/MonkeyGame.html" target="_blank">http://www.therevillsgames.com/monkey/SpriterA4/MonkeyGame.html</a> <br><br></td></tr></table><br>
<a name="bottom"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td align="right"><a href="http://monkeycoder.co.nz" target="_blank"><img src="/img/monkey2.svg" ></a> <a href="https://github.com/blitz-research" target="_blank"><img src="/img/github.svg" ></a> <a href="https://discord.gg/qJccbSp" target="_blank"><img src="/img/discord.svg" ></a></td></tr></table><br></div><br><table width="100%"><tr><td></body></html lang="en">
