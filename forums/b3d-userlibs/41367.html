<!DOCTYPE html><html lang="en" ><head ><title >Tokamak possible in Multi-User Online?</title><meta name='viewport' content='width=device-width, initial-scale=0.66'><meta name='description' content='language:basic, target:desktop, category:game development'><link rel="styleSheet" href="../skins/granite/style.css" type="text/css"><style type="text/css">div.bbcode {padding: 8px;background: #E5E5E5;color: #000000;border: 1px dashed #B4B4BE;}</style></head><body ><table width=100% cellspacing=0 cellpadding=0><tr ><td class="menubarleft"></td><td class="menubar"><table cellspacing="0" cellpadding="0"><tr ><td >&nbsp;</td><td class="menuitemleft"></td><td class="menuitem"><a href="/" class="menuitem">News</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/forums.php" class="menuitem">Forums</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/codearcs.php" class="menuitem">Code</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/logs.php" class="menuitem">Logs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/gallery.php" class="menuitem">Gallery</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/sdkspecs.php" class="menuitem">Specs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/search.php" class="menuitem">Search</a></td><td class="menuitemright"></td></tr></table></td><td class="menubarright"></td></tr></table><div class="main"><h1 >Tokamak possible in Multi-User Online?</h1><a href="forums.php" >Blitz3D Forums</a>/<a href="topics.php?forum=94" >Blitz3D Userlibs</a>/<a href="#bottom" >Tokamak possible in Multi-User Online?</a><br><br>
<a name="465454"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Danny</td><td align="right"><font class=tiny>(Posted 2004)</font>&nbsp;<a href="#1">[#1]</a></td></tr></table></td></tr><tr ><td class="posttext"> Has anyone every attempted to use Tokamak in a multi-player online environment?<br><br>I understand that Tok's simulation results are extremely sensitive to the frame rate, so if a computer is just a tad slower or faster you get slightly different results. Making it very hard to get the same results on multiple computers. <br><br>A possible solution could be to have the fastest computer 'current in the network' do the physics simulation for the others...<br><br>Any thoughts on this?<br><br>cheer,<br>Danny. <br><br></td></tr></table><br>
<a name="465471"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >RepeatUntil</td><td align="right"><font class=tiny>(Posted 2004)</font>&nbsp;<a href="#2">[#2]</a></td></tr></table></td></tr><tr ><td class="posttext"> Yes, I use Tokamak for a multiplayer game. I think a lot about this issue of physics which should be identical on several computers.<br>Finally I have found a solution and I am very happy with that.<br>In a few words:<br>every computers run the physics at exactly the same rate (say, 30 cycle per second). So they will do exactly the same, since the deltatime of the physics will be the same (here, 1/30 s). In practice, I use render tweening to do that for the physics. <br><br></td></tr></table><br>
<a name="465870"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Danny</td><td align="right"><font class=tiny>(Posted 2004)</font>&nbsp;<a href="#3">[#3]</a></td></tr></table></td></tr><tr ><td class="posttext"> Thanks vincent,<br>Interesting to hear you got it working.<br>Render Tweening still scares me because on my (crappy) system it creates a choppy frame rate, and I've heard other people having the same problem as well.<br><br>Do you do any checking to see wich computer is the slowest and then limit the others to match. Or do you just 'force' a 30fps as a minimal safety sort of thing?!<br><br>cheers,<br>Danny <br><br></td></tr></table><br>
<a name="465903"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Jeroen</td><td align="right"><font class=tiny>(Posted 2004)</font>&nbsp;<a href="#4">[#4]</a></td></tr></table></td></tr><tr ><td class="posttext"> RepeatUntil, do you have a barebone example of this?<br>For me, physics slowly get out of sync. <br><br></td></tr></table><br>
<a name="465905"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Sweenie</td><td align="right"><font class=tiny>(Posted 2004)</font>&nbsp;<a href="#5">[#5]</a></td></tr></table></td></tr><tr ><td class="posttext"> Perhaps if you do as RepeatUntil suggest but with the addition of some kind of synchronization once in a while.<br>Let the server send out the exact positions &amp; velocities of all rigid bodies once every Nth second and let every client adjust it's bodies. <br><br></td></tr></table><br>
<a name="465917"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >RepeatUntil</td><td align="right"><font class=tiny>(Posted 2004)</font>&nbsp;<a href="#6">[#6]</a></td></tr></table></td></tr><tr ><td class="posttext"> Yes, you have to resynchronize bodies from time to time, especially when there is a lot of interactions...<br>I will post a barebone example as soon as I have some time (I have no access to Blitz right now). <br><br></td></tr></table><br>
<a name="468131"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Kalisme</td><td align="right"><font class=tiny>(Posted 2004)</font>&nbsp;<a href="#7">[#7]</a></td></tr></table></td></tr><tr ><td class="posttext"> this is probably the most stupid idea of all time... but what would happen if only one computer handles the physics data... then the others just take the locations and angles to update their objects... they can use pushes and things like that... they get sent to the main pc that handles the physics, the impulses get applied and so on....<br>yeah... I can see the flaws as well... but I figured it might work... sorry If I'm slowing people down <br><br></td></tr></table><br>
<a name="468370"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >skn3</td><td align="right"><font class=tiny>(Posted 2004)</font>&nbsp;<a href="#8">[#8]</a></td></tr></table></td></tr><tr ><td class="posttext"> You could adapt on that idea a little, and make it so all computers can control physics objects. But, only 1 computer (the host) can control who gets to control what.<br><br>So the server computer could dish of control of say a box, to user 1. This will then run the physics simulation for box and send the data along with its update packets. Which inturn is then delivered from server to all othere clients. That way you would have smoother interaction. <br><br></td></tr></table><br>
<a name="473828"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >RepeatUntil</td><td align="right"><font class=tiny>(Posted 2005)</font>&nbsp;<a href="#9">[#9]</a></td></tr></table></td></tr><tr ><td class="posttext"> A bit late for my answer, but here we go.<br><br>Here is a barebone example of a technics to have physics synchronized on every computers using a physics engine (eg Tokamak).<br>The idea is to run the physics engine 50 times per second on every computers (using tween method) which results in the same calculations on every computers (since the physics step would be the same everywhere)<br>For this to work, you need to give the same initial conditions (time, position, velocity) for every object when something happens to them (thrown by a player for ex.) <br><br>Hope this helps,<br><br><textarea class=codebox name="code" wrap=OFF readonly="true" rows="15" cols="80">
; 
; A barebone example of a technics to have physics synchronized on every computers
; using a physics engine (eg Tokamak).
; The idea is to run the physics engine 50 times per second on every computers (using
; tween method) which results in the same calculations on every computers (since the 
; physics step would be the same everywhere)
; For this to work, you need to give the same initial conditions (time, position, velocity) 
; for every object when something happens to them (thrown by a player for ex.) 
;
;
; Author: RepeatUntil
;

Const PHYS_FPS = 50 ; The FPS for the physics (only the physics, the rest of the game 
                    ; running at the quickest possible rate) 

Global physicsStep# = 0.8/PHYS_FPS  ; The step for physics (parameter given to Tokamak)

;
; Some game initialisations here...
;

; The function Ms() is the time synchronized on all computers, ie it's the same time (to the 
; best approximation) on all computers
; Ueful to guarantee that the physics happens at the same time on every computers


Local oldTime% = Ms()

; This loop permits to start when Ms() is a multiple of 1 sec (every computer do physics at the same time)
; There should be no heavy computation between this and the "For k=1 to ticks"
Repeat
Until (Ms() Mod 1000) &lt; 10  ; &lt; 10 is better than = 0 if the computer is slow 

period=1000/PHYS_FPS
time=Ms()-period

;	
; Main loop of game 
;
While Not abortGame

  ; Compute deltaTime
  newTime = Ms()
  deltaTime = newTime - oldTime
  oldTime = newTime


  ; Handle inputs from the player
  HandleInputs()


  ; Do tweening for the physics (and physics only as we want the same FPS for every player)
  Repeat
    elapsed=Ms()-time
  Until elapsed

  ;how many 'frames' have elapsed	
  ticks=elapsed/period	
  ;fractional remainder
  tween#=Float(elapsed Mod period)/Float(period)
  For k=1 To ticks
    time=time+period
    If k=ticks Then CaptureWorld

    ; Apply physics
    TOKSIM_Advance(physicsStep#)

    ; Check for collision and render world
    UpdateWorld
  Next  ; k ticks loop


  RenderWorld tween

  ; 
  ; Some useful routines here...
  ;

  ;
  ; Some network routines here...
  ;

  Flip

; End of the main loop
Wend
</textarea> <br><br></td></tr></table><br>
<a name="476356"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Danny</td><td align="right"><font class=tiny>(Posted 2005)</font>&nbsp;<a href="#10">[#10]</a></td></tr></table></td></tr><tr ><td class="posttext"> Cheers for the example RepeatUntil, I'll go check it out now..<br><br>D <br><br></td></tr></table><br>
<a name="480809"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Luke.H</td><td align="right"><font class=tiny>(Posted 2005)</font>&nbsp;<a href="#11">[#11]</a></td></tr></table></td></tr><tr ><td class="posttext"> Why not have:<br><br><textarea class=codebox name="code" wrap=OFF readonly="true" rows="15" cols="80">

Timer#=MilliSecs()
GameSpeed#=0
Frames=30

While Not KeyDown(1) ; Main loop of game 

GameSpeed#=((MilliSecs()-Timer#)/Float(Frames))
Timer#=MilliSecs()


UpdateGame#(GameSpeed#);Players, etc


TOKSIM_Advance(GameSpeed#)


RenderWorld()



Flip
Wend
End

</textarea><br><br><br>So you can faster computers can have high FPS. <br><br></td></tr></table><br>
<a name="480838"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >RepeatUntil</td><td align="right"><font class=tiny>(Posted 2005)</font>&nbsp;<a href="#12">[#12]</a></td></tr></table></td></tr><tr ><td class="posttext"> No, that doesn't work. Maybe I didn't explain it well enough: the parameter GameSpeed# (as you call it) given to TOKSIM_Advance() *must* be the SAME for every players on the network AND TOKSIM_Advance *must* be called the SAME number of time per second.<br>In your case, GameSpeed# will vary at each iteration, and will be never the same on two computers (= different physics!).<br><br>The solution that I propose obeys these 2 rules:<br>  - parameter given to TOKSIM_Advance() is <br>    physicsStep# = 0.8/PHYS_FPS<br><br>    (with PHYS_FPS = 50 for example)<br>    (so the computation is *strictly the same* on every computers)<br>  - TOKSIM_Advance() is called the same number of time per second on every computers thanks to the render tweening. In  my example (see above), it's called 50 times/sec (= PHYS_FPS) (only the physics, the rest of the game running at the best available speed) <br><br>  Hope it helps and explain a bit better the posted example (I have edited this example to make it more clear)... <br><br></td></tr></table><br>
<a name="482956"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Luke.H</td><td align="right"><font class=tiny>(Posted 2005)</font>&nbsp;<a href="#13">[#13]</a></td></tr></table></td></tr><tr ><td class="posttext"> Faster computers will run TOKSIM_Advance more because they are faster but GameSpeed# will be less, Slower computers will run TOKSIM_Advance less but GameSpeed# will be more.<br><br>Eg:<br><br>Fast computers may run:<br><br>TOKSIM_Advance 0.25<br>TOKSIM_Advance 0.25<br>TOKSIM_Advance 0.25<br>TOKSIM_Advance 0.25<br><br>(=1)<br><br>and slower computers may run:<br><br>TOKSIM_Advance 0.5<br>TOKSIM_Advance 0.5<br><br>(=1)<br><br>In the same amount of time <br><br></td></tr></table><br>
<a name="482960"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >RepeatUntil</td><td align="right"><font class=tiny>(Posted 2005)</font>&nbsp;<a href="#14">[#14]</a></td></tr></table></td></tr><tr ><td class="posttext"> In the code I have posted, only the physics is running at a fix FPS, the rest of the code (graphics eg) is running at the maximum available speed. And who cares about a fix FPS for the physics?<br><br>Also, I am not sure that:<br>TOKSIM_Advance 0.25 <br>TOKSIM_Advance 0.25 <br>is equivalent to <br>TOKSIM_Advance 0.5<br><br>This have to be check, but I bet it's not equivalent, and that a slight difference could happen from this... <br><br></td></tr></table><br>
<a name="bottom"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td align="right"><a href="http://monkeycoder.co.nz" target="_blank"><img src="/img/monkey2.svg" ></a> <a href="https://github.com/blitz-research" target="_blank"><img src="/img/github.svg" ></a> <a href="https://discord.gg/qJccbSp" target="_blank"><img src="/img/discord.svg" ></a></td></tr></table><br></div><br><table width="100%"><tr><td></body></html lang="en">
