<!DOCTYPE html><html lang="en" ><head ><title >UDP Network library v1.12</title><meta name='viewport' content='width=device-width, initial-scale=0.66'><meta name='description' content='language:basic, target:desktop, category:game development'><link rel="styleSheet" href="../skins/granite/style.css" type="text/css"><style type="text/css">div.bbcode {padding: 8px;background: #E5E5E5;color: #000000;border: 1px dashed #B4B4BE;}</style></head><body ><table width=100% cellspacing=0 cellpadding=0><tr ><td class="menubarleft"></td><td class="menubar"><table cellspacing="0" cellpadding="0"><tr ><td >&nbsp;</td><td class="menuitemleft"></td><td class="menuitem"><a href="/" class="menuitem">News</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/forums.php" class="menuitem">Forums</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/codearcs.php" class="menuitem">Code</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/logs.php" class="menuitem">Logs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/gallery.php" class="menuitem">Gallery</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/sdkspecs.php" class="menuitem">Specs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/search.php" class="menuitem">Search</a></td><td class="menuitemright"></td></tr></table></td><td class="menubarright"></td></tr></table><div class="main"><h1 >UDP Network library v1.12</h1><a href="forums.php" >Blitz3D Forums</a>/<a href="topics.php?forum=94" >Blitz3D Userlibs</a>/<a href="#bottom" >UDP Network library v1.12</a><br><br>
<a name="1289100"></a>

<a name="1289102"></a>

<a name="1289230"></a>

<a name="1290016"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Flanker</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#1">[#1]</a></td></tr></table></td></tr><tr ><td class="posttext"> To discuss the new version of the library, as the other thread is huge now :)<br><br>Worklog and examples : <a href="http://www.blitzbasic.com/logs/userlog.php?user=15074&amp;log=1916" target="_blank">http://www.blitzbasic.com/logs/userlog.php?user=15074&amp;log=1916</a> <br><br></td></tr></table><br>
<a name="1289111"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rick Nasher</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#2">[#2]</a></td></tr></table></td></tr><tr ><td class="posttext"> Appears pretty smooth! <br><br></td></tr></table><br>
<a name="1289112"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Flanker</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#3">[#3]</a></td></tr></table></td></tr><tr ><td class="posttext"> Yes, the advanced example should be smoother now and without flickering, as I fixed some interpolation issues :) You can use TAB key to see the pings and scores.<br><br>If you want to test it online, i'll be connected sometimes on channel #UDPNetwork_lib here : <a href="http://webchat.quakenet.org/" target="_blank">http://webchat.quakenet.org/</a> <br><br></td></tr></table><br>
<a name="1289128"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >stayne</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#4">[#4]</a></td></tr></table></td></tr><tr ><td class="posttext"> About to get started on a level for this.  Found some nice textures for testing. <br><br></td></tr></table><br>
<a name="1289129"></a>

<a name="1289132"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rick Nasher</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#5">[#5]</a></td></tr></table></td></tr><tr ><td class="posttext"> I've added a tile on the 'player creation spot' so easier to see where that is. To be added of course to Function CreateScene()<br><pre class=code>
start = CreateSphere():EntityColor start ,255,255,255
ScaleEntity start ,1,.1,1:PositionEntity start ,-20,.1,-20
</pre><br>I'll delve into the health upgrade/item stuff. For GF taking too long. lol ;-) <br><br></td></tr></table><br>
<a name="1289144"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Guy Fawkes</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#6">[#6]</a></td></tr></table></td></tr><tr ><td class="posttext"> Sorry guys. I got an urgent Skype call so I had to go. I will be testing out this stuff tonight and tomorrow as well.! :D <br><br></td></tr></table><br>
<a name="1289145"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >RustyKristi</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#7">[#7]</a></td></tr></table></td></tr><tr ><td class="posttext"> Heeey, this is awesome guys!! :D Wow, I was gone here for a couple of months and I did not expect something new and shiny like this library would come out. Big thanks Flanker for sharing!!! :) <br><br></td></tr></table><br>
<a name="1289146"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >RustyKristi</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#8">[#8]</a></td></tr></table></td></tr><tr ><td class="posttext"> I quickly got to test this out and I have a question with the switch host thing, which is totally awesome btw. So once someone quits and another takes over, you cannot join that game/server anymore?<br><br>I initially set it to port 2000 and when I tried to quit the original host, the port is now set to 58746 or within that range. I tried to spawn another client but I always got a "failed to connect server" or the client crashes. <br><br></td></tr></table><br>
<a name="1289150"></a>

<a name="1289151"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Guy Fawkes</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#9">[#9]</a></td></tr></table></td></tr><tr ><td class="posttext"> No, I don't think it should disconnect other players. You probably found another bug. Can you fix that one Flanker? Also, did you make SURE that you port forwarded port 2000 &amp; / or port 58746 on your router with TCP AND UDP? Did you also make sure that your firewall(s) are not blocking incoming connections? Some Anti Virus can do this as well. When another player takes over as a Server, others should still be able to connect. <br><br></td></tr></table><br>
<a name="1289152"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >RustyKristi</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#10">[#10]</a></td></tr></table></td></tr><tr ><td class="posttext"> Hey Guy,<br><br>No it's all under one pc so I don't think it's a port forwarding or router issue. I have not said it is disconnecting, but you can't join an on-going game (or at least it fails to connect) once the original server quits the game. Maybe it is currently coded this way?<br><br>Thanks. <br><br></td></tr></table><br>
<a name="1289156"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Guy Fawkes</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#11">[#11]</a></td></tr></table></td></tr><tr ><td class="posttext"> The new Server must ALWAYS be port forwarded. <br><br></td></tr></table><br>
<a name="1289157"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Guy Fawkes</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#12">[#12]</a></td></tr></table></td></tr><tr ><td class="posttext"> Also, I have a feeling that it's not changing IPs &amp; Ports from the old Server IP &amp; Port to the new Server IP &amp; Port. <br><br></td></tr></table><br>
<a name="1289164"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >RustyKristi</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#13">[#13]</a></td></tr></table></td></tr><tr ><td class="posttext"> It turns out I just got a weird connection glitch earlier but it seems to be all working now, yes! :D <br><br></td></tr></table><br>
<a name="1289165"></a>

<a name="1289166"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Flanker</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#14">[#14]</a></td></tr></table></td></tr><tr ><td class="posttext"> @RustyKristi<br>When the server quits, another player becomes the server, so if you want to join the on-going game, you will have to connect to that player, as the first server is not active anymore.<br><br>For example, let's say all players are on the same computer, so everyone has IP=127.0.0.1. You create a server on port 2000. You make a client join that server on port 2000, and this client port is 3000. Then, if the server quits, the new server is on port 3000.<br><br>As you said, nothing to do with router port forwarding if you are local, it's just the normal behaviour of the library.<br><br>@Guy Fawkes<br>It does change IP and port, but only if the server is closed with the escape key. If you close it with the cross, he won't send the "switch host" packets and the only thing that players can do in that case is constating a server timeout, then you'll have a "connection lost" runtime error. It could be changed, but I will probably never do it for some reasons ^^<br><br><br>EDIT : oh I forgot, I fixed an horrible issue in the v1.1, probably causing some lags. Just a very little thing in the code but it can have weird effects :S I'll post a v1.11 or something like that tonight. <br><br></td></tr></table><br>
<a name="1289169"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >RustyKristi</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#15">[#15]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> For example, let's say all players are on the same computer, so everyone has IP=127.0.0.1. You create a server on port 2000. You make a client join that server on port 2000, and this client port is 3000. Then, if the server quits, the new server is on port 3000. <br></div><br><br>Yes, I knew that beforehand, but for some reason my first test were crashes and I was not sure why, I did not change anything code or settings wise. Anyways, it's all good now! thanks again :) <br><br></td></tr></table><br>
<a name="1289175"></a>

<a name="1289176"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >RustyKristi</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#16">[#16]</a></td></tr></table></td></tr><tr ><td class="posttext"> I was also thinking of some feature additions that you might consider, like  dedicated server mode and a port to Blitzmax? <br><br></td></tr></table><br>
<a name="1289197"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >stayne</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#17">[#17]</a></td></tr></table></td></tr><tr ><td class="posttext"> Dedicated server is a must.  I'd just run it bare minimum 2D of course in a small console or systray app.  The ones I've seen and used are very simple with a few admin commands and chat logging. <br><br></td></tr></table><br>
<a name="1289202"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Guy Fawkes</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#18">[#18]</a></td></tr></table></td></tr><tr ><td class="posttext"> Or we can all FORGET elitist stayne's "suggestion" and continue working on this awesome library! We don't have to listen to you! :)<br><br>~GF <br><br></td></tr></table><br>
<a name="1289204"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >stayne</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#19">[#19]</a></td></tr></table></td></tr><tr ><td class="posttext"> Flanker could you post a list of entities so I can create their locations in the map?  Example: spawn, soandsotrigger, bullets, armor, light, etc.  That way when the map is parsed you can place the entities at their corresponding x/y/z location.  Makes things a whole lot easier!  I started on the map last night, keeping it simple in case it doesn't work for you.  I'm guessing you are looking for an FPS-type map similar to Quake? <br><br></td></tr></table><br>
<a name="1289205"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Guy Fawkes</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#20">[#20]</a></td></tr></table></td></tr><tr ><td class="posttext"> Yes. I'm thinking of Reading all positions, rotations, etc. from an Encrypted index.dat file. <br><br></td></tr></table><br>
<a name="1289206"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rick Nasher</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#21">[#21]</a></td></tr></table></td></tr><tr ><td class="posttext"> Don't you guys just love all the commotion this lib creates? :-)<br>Looks like this is the 'missing link' in Blitz3d.<br><br>@stayne: can you post a preview screenie for the map? <br><br></td></tr></table><br>
<a name="1289215"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >stayne</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#22">[#22]</a></td></tr></table></td></tr><tr ><td class="posttext"> I sure can around 7:00pm CST give or take a few ticks. <br><br></td></tr></table><br>
<a name="1289225"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rick Nasher</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#23">[#23]</a></td></tr></table></td></tr><tr ><td class="posttext"> Can't wait to see what you're fabricating. <br><br></td></tr></table><br>
<a name="1289229"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Flanker</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#24">[#24]</a></td></tr></table></td></tr><tr ><td class="posttext"> Added version 1.11, I suggest you to use it ;)<br>Also I added a "simple" 2D example, kind of a tutorial if you want to know how to use the library.<br><br>@RustyKristi, what i fixed in v1.11 could be the cause to the problem you encountered, i'm not quite sure yet, but I was routing pings like normal packets :S So I guess the network was badly saturated at a moment.<br><br>We had some ugly problems when testing yesterday and this could also be the cause. I will go on quakenet tonight if someone wants to test it online.<br><br>About dedicated server, in fact it is already possible. The library just handle connections beetween server/clients, proper packets routing and server switch. You can code your side a 3D game and a dedicated server to go with, using the library commands.<br><br>A port to blitzmax is not to be considered for now as i'm quite a noob with it. I'm writing this library because like other said, it will probably be compatible with Hardwired/Hybrid that I will use in the future (I trust in Ploppy :).<br><br>@stayne<br>You can make the kind of map you want, quake style is ok, just try to make it light weight so not hundreds of textures ^^<br>For the map, just add some basic things as I'm not writing a game, just an advanced example for the library :<br>- spawns<br>- health<br>- ammunition <br><br></td></tr></table><br>
<a name="1289232"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Guy Fawkes</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#25">[#25]</a></td></tr></table></td></tr><tr ><td class="posttext"> I'M GAME! Meet u on Quakenet! <br><br></td></tr></table><br>
<a name="1289235"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rick Nasher</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#26">[#26]</a></td></tr></table></td></tr><tr ><td class="posttext"> On there too. <br><br></td></tr></table><br>
<a name="1289261"></a>

<a name="1289266"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >stayne</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#27">[#27]</a></td></tr></table></td></tr><tr ><td class="posttext"> <a href="http://imgur.com/SSylzi7" target="_blank">http://imgur.com/SSylzi7</a> long way to go. <br><br></td></tr></table><br>
<a name="1289267"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Flanker</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#28">[#28]</a></td></tr></table></td></tr><tr ><td class="posttext"> Beautiful :) Maybe i'll write a little FPS example with your level.<br><br>We've tested the lib tonight again with Guy Fawkes and Rick Nasher. Still random connection problems but I finally found what is it. UDP packets can come in any order, and the connection routine didn't deal with that. It will be fixed soon. In local mode this doesn't appear as the connection is flawless, packets arrive in the right order. Another thing with UDP is that packets can never arrive, but it doesn't seems to appear too often, so for the moment I won't go into that, but I plan in the future to add a Net_SendCrucialMessage() command so it will ask an acknowledgement of the successful receipt. <br><br></td></tr></table><br>
<a name="1289270"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >stayne</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#29">[#29]</a></td></tr></table></td></tr><tr ><td class="posttext"> UDP is best at handling single packets like streaming media unless you code in some packet sequencing and arrange them client-side. <br><br></td></tr></table><br>
<a name="1289277"></a>

<a name="1289278"></a>

<a name="1289279"></a>

<a name="1289280"></a>

<a name="1289281"></a>

<a name="1289282"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Guy Fawkes</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#30">[#30]</a></td></tr></table></td></tr><tr ><td class="posttext"> Ok, so got a question for you advanced Blitzers. How would I make it so that when a user type's in a slash command, it can have UP TO 3 parameters separated by a comma, but do NOT have to be filled out? I started to create this code and it only works if I type the full command such as "/kick playername" (without the double-quotes ).<br><br><textarea class=codebox name="code" wrap=OFF readonly="true" rows="15" cols="80">;==========================================================================
; TOP OF PROGRAM
;==========================================================================

Dim command_name$ ( max_command_names )

command_name$ ( 0 ) = "/kick"

;==========================================================================
; LOOP OF PROGRAM
;==========================================================================

;Grab player's username &amp; exit

For p.player = Each player

    username$ = p\name

    Exit

Next
						
;Grab the command's name
cmdname$ = ( command_name$ ( 0 ) + " " + username$ )

;Check whether or not the command was typed into the Chatbox
cmd_is_in_str = ( Instr ( chatMessage, cmdname$ ) )

;Check if the command was typed into the Chatbox the correct way
If ( cmd_is_in_str )

    ;Check / use the command that was typed into the chat box
    chat_chk$ = ( Left ( cmdname$, Len ( cmdname$ ) ) )

    ;// Grab the kicked User's name
    kick_msg$ = ( Right ( cmdname$, Len ( cmdname$ ) - Instr ( cmdname$, " ", 1 ) ) )

    ;If the message was correct, then send the Kick Message from the Server to the Client(s)
    If chat_chk$ = cmdname$ Then Net_KickPlayer ( kick_msg$ )

EndIf
</textarea><br><br>Thank you for any help you can give me!<br><br>~GF <br><br></td></tr></table><br>
<a name="1289283"></a>

<a name="1289284"></a>

<a name="1289290"></a>

<a name="1289291"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >RustyKristi</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#31">[#31]</a></td></tr></table></td></tr><tr ><td class="posttext"> Nice work there! I agree with stayne, dedicated server mode is a must so I brought up the blitzmax port and it would be key to getting it ported to Linux and having it to run dedicated or headless. :-)<br><br><br><div class="quote"> what i fixed in v1.11 could be the cause to the problem you encountered, i'm not quite sure yet, but I was routing pings like normal packets :S So I guess the network was badly saturated at a moment. <br></div><br><br>Good to know!<br><br>@Guy Fawkes<br><br>Check how the CSV format works and look for some snippets in the code archives.<br><br>Edit <b>CSV Format</b> <br><br></td></tr></table><br>
<a name="1289286"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Guy Fawkes</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#32">[#32]</a></td></tr></table></td></tr><tr ><td class="posttext"> That doesn't make any sense. I just wanna be able to use slash commands with 1 to 3 parameters each, each parameter is NOT REQUIRED. <br><br></td></tr></table><br>
<a name="1289287"></a>

<a name="1289288"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >RustyKristi</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#33">[#33]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> That doesn't make any sense. I just wanna be able to use slash commands with 1 to 3 parameters each, each parameter is NOT REQUIRED.  <br></div><br><br>Yes, but how are you going to parse it? you mentioned "comma separated", right?...<br><br><div class="quote"> it can have UP TO 3 parameters separated by a comma, <br></div> <br><br></td></tr></table><br>
<a name="1289292"></a>

<a name="1289293"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >RustyKristi</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#34">[#34]</a></td></tr></table></td></tr><tr ><td class="posttext"> Typo at my end, I meant CSV format..<br><br>Maybe this is what you've been looking for:<br><br><a href="http://www.blitzbasic.com/codearcs/codearcs.php?code=824" target="_blank">http://www.blitzbasic.com/codearcs/codearcs.php?code=824</a> <br><br></td></tr></table><br>
<a name="1289298"></a>

<a name="1289299"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Guy Fawkes</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#35">[#35]</a></td></tr></table></td></tr><tr ><td class="posttext"> By checking each parameter and whether or not it's allowed to even be IN the parameter(s) in the slash commands. <br><br></td></tr></table><br>
<a name="1289310"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >RustyKristi</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#36">[#36]</a></td></tr></table></td></tr><tr ><td class="posttext"> Some more suggestions for enhancements:<br><br>- Animation States<br>- Client Side Prediction <br><br></td></tr></table><br>
<a name="1289329"></a>

<a name="1289330"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >stayne</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#37">[#37]</a></td></tr></table></td></tr><tr ><td class="posttext"> I'd make a Type called Commands and a Field called Name$.  When a command is entered, run through the list of names and verify it's an existing command before executing the command.<br><br>Type Command<br>  Field Name$<br>End Type<br><br>For c.Command = Each Command<br>  If c\Name$ = soandso$<br>    do stuff<br>  Else<br>    don't do stuff<br>  End If<br>Next <br><br></td></tr></table><br>
<a name="1289378"></a>

<a name="1289380"></a>

<a name="1289381"></a>

<a name="1289396"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rick Nasher</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#38">[#38]</a></td></tr></table></td></tr><tr ><td class="posttext"> @stayne:<br><br>The level is starting of interesting. You are using 3d World Studio. <br>Question: How quickly and good is that for developing multi-floor buildings and how low poly are the results?<br><br>Before I used Sketchup which is really good(intuitive) and quick, but sloppy and a pain to convert to b3d. <br><br></td></tr></table><br>
<a name="1289383"></a>

<a name="1289387"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Flanker</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#39">[#39]</a></td></tr></table></td></tr><tr ><td class="posttext"> @stayne<br><div class="quote">  UDP is best at handling single packets like streaming media unless you code in some packet sequencing and arrange them client-side. <br></div><br>Do you mean it's better to have a small amount of big packets instead of lots of small packets ? On the web I read that packets up to 576 bytes are safe on any network with UDP protocol, otherwise it increases packets loss. For the moment i'm very far from 576 bytes per packets and the advanced example doesn't use a lot of them, I think it's reliable but packets can still arrive in any order.<br><br>@RustyKristi<br>Animation states and client side prediction have to be coded in your game, according to the packets your send and receive using the network library.<br><br>@Guy Fawkes<br>Here is a function that will extract a command and all its parameters, the command will be in cmdParameter(0), and for example parameter 3 will be at cmdParameter(3). The function returns the number of parameters, you can have up to 255, and even more if you modify the table cmdParameter. It delete all spaces at the end if present. Putting two commas beetween 2 parameter will be considered as an empty parameter. Try the example :<br><br><textarea class=codebox name="code" wrap=OFF readonly="true" rows="15" cols="80">Graphics 800,600,32,2

Dim cmdParameter$(255) ; &lt;- you can have up to 255 parameters, should be enough ^^

;;;; TEST LOOP ;;;;
While Not KeyHit(1)

	Cls:Locate 0,0
	
	Print "Enter a command with slash '/'"
	Print "If you want parameters you must put a space after the command"
	Print "Then you can separate the parameters with comma ','"
	Print ""
	Print "For example /give me,money,hot girls,and pistols"
	Print ""
	
	command$ = Input("")
	
	Print ""
	
	params = Cmd_Extract(command$)
	
	Print cmdParameter(0) + " -&gt; " + params + " parameters"
	For i = 1 To params
		Print "{"+cmdParameter(i)+"}"
	Next
		
	WaitKey()

Wend

End

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function Cmd_Extract(cmd$)

	cmdParameter(0) = "none"
	If cmd = "" Then Return
	
	While Right(cmd,1) = " "
		cmd = Left(cmd,Len(cmd)-1)
	Wend
	
	If Left(cmd,1) = "/" And Len(cmd) &gt; 1
	
		offset1 = 0
		offset2 = Instr(cmd," ",1)
		
		If offset2
		
			cmdParameter(0) = Left(cmd,offset2-1)
			
			offset1 = offset2
			offset2 = Instr(cmd,",",offset2+1)
			
			While offset2 &gt; 0
			
				count = count + 1
				
				cmdParameter(count) = Mid(cmd,offset1+1,offset2-offset1-1)
				
				offset1 = offset2
				offset2 = Instr(cmd,",",offset2+1)
				
			Wend
			
			count = count + 1
			cmdParameter(count) = Right(cmd,Len(cmd)-offset1)
			
		Else
			cmdParameter(0) = cmd
		EndIf
		
	EndIf
	
	Return count
	
End Function</textarea> <br><br></td></tr></table><br>
<a name="1289386"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Guy Fawkes</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#40">[#40]</a></td></tr></table></td></tr><tr ><td class="posttext"> This is BEAUTIFUL, Flanker! Thank You! <br><br></td></tr></table><br>
<a name="1289417"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >stayne</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#41">[#41]</a></td></tr></table></td></tr><tr ><td class="posttext"> Is it not an issue that packets arrive out of order?  For instance if an entity is moving and its coordinates are sent every 10ms out of order won't it appear jerky?  what about chat string packets? <br><br></td></tr></table><br>
<a name="1289422"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Flanker</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#42">[#42]</a></td></tr></table></td></tr><tr ><td class="posttext"> You're right it's an issue, and I think that's why interpolation still appears a bit jerky, because we can receive a previous position packet instead of a next position packet. Seems that it can't be avoided with UDP, but it can be fixed by checking packets numbers, so that we would just ignore a position packet if his number is before the last position packet we received. For chat it's not a huge issue to receive the wrong order I think...<br><br>I'm working on it but still have to fix the connection issue caused by the same problem. <br><br></td></tr></table><br>
<a name="1289427"></a>

<a name="1289428"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >stayne</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#43">[#43]</a></td></tr></table></td></tr><tr ><td class="posttext"> Flanker send me an email so I can reply with the zipped up test map.  Only entity I included is "spawn".  No weapons, ammo, etc yet I just want to make sure you can parse it and everything looks ok.  You'll probably need to scale it down a good deal.  If you want to just load it leave out the parse code and just load the b3d to see how it looks. <br><br></td></tr></table><br>
<a name="1289432"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Flanker</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#44">[#44]</a></td></tr></table></td></tr><tr ><td class="posttext"> I updated my profile so you can see the email. I'll take a look at the map and see how to parse it :) <br><br></td></tr></table><br>
<a name="1289435"></a>

<a name="1289436"></a>

<a name="1289437"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >stayne</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#45">[#45]</a></td></tr></table></td></tr><tr ><td class="posttext"> Thanks man...sent.  Sent the textures (mind the license) along with the b3d and 3dw.  The map is nowhere near done just wanted you to see if you can load it.  Can't remember if the parser needs the 3dw or b3d.  Otherwise just load the b3d like normal. <br><br></td></tr></table><br>
<a name="1289438"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Flanker</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#46">[#46]</a></td></tr></table></td></tr><tr ><td class="posttext"> Thanks, it looks nice sor far, I like the lighting and textures. What do you use to make the map ? <br><br></td></tr></table><br>
<a name="1289440"></a>

<a name="1289441"></a>

<a name="1289442"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >stayne</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#47">[#47]</a></td></tr></table></td></tr><tr ><td class="posttext"> 3D World Studio.  Old school JoshK stuff still works great, I used to map for Quake 2 and Q3A (never was a texture artist).  Glad you like how it looks.  If it works decently I will add the other entity spawns and finish it.  Just remember to read the texture license, they are not mine. <br><br></td></tr></table><br>
<a name="1289444"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >stayne</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#48">[#48]</a></td></tr></table></td></tr><tr ><td class="posttext"> I drug out some animation code I use.  Works for me.  This way you can throw in one-shot animations (such as c\attackanim or c\hitanim) anywhere you want.<br><br><pre class=code>
If Animating(c\mesh) = False And AnimSeq(c\mesh) &lt;&gt; c\idleanim
  Animate (c\mesh,1,c\animspeed,c\idleanim,10)
EndIf
		
If c\moving = True And c\running = False And AnimSeq(c\mesh) &lt;&gt; c\walkanim
  Animate (c\mesh,1,c\animspeed,c\walkanim,10)
Else If c\moving = True And c\running = True And AnimSeq(c\mesh) &lt;&gt; c\runanim
  Animate (c\mesh,1,c\animspeed,c\runanim,10)
Else If c\moving = False And c\angry = True And (AnimSeq(c\mesh) &lt;&gt; c\attackanim And AnimSeq(c\mesh) &lt;&gt; c\hitanim And AnimSeq(c\mesh) &lt;&gt; c\combatidle)
  Animate (c\mesh,1,c\animspeed,c\combatidle,10)
Else If c\angry = False And c\moving = False And (AnimSeq(c\mesh) &lt;&gt; c\attackanim And AnimSeq(c\mesh) &lt;&gt; c\hitanim And AnimSeq(c\mesh) &lt;&gt; c\idleanim)
  Animate (c\mesh,1,c\animspeed,c\idleanim,10)
EndIf
</pre> <br><br></td></tr></table><br>
<a name="1289528"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Guy Fawkes</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#49">[#49]</a></td></tr></table></td></tr><tr ><td class="posttext"> Sweet, @stayne! <br><br></td></tr></table><br>
<a name="1289545"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Flanker</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#50">[#50]</a></td></tr></table></td></tr><tr ><td class="posttext"> Thanks, could be useful when I'll be at that point in the example.<br><br>I'm looking for someone to run some quick tests on UDP protocol. If interested, Quakenet at channel #UDPNetwork_lib. Thx. <br><br></td></tr></table><br>
<a name="1289547"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Guy Fawkes</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#51">[#51]</a></td></tr></table></td></tr><tr ><td class="posttext"> COUNT ME IN! &lt;3<br><br>~GF <br><br></td></tr></table><br>
<a name="1289815"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rick Nasher</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#52">[#52]</a></td></tr></table></td></tr><tr ><td class="posttext"> @Flamker:<br>Is the code of LAmaNet/Rottnet helpful to compare with or is it useless for resolving the internet connection issue? <br><br></td></tr></table><br>
<a name="1289877"></a>

<a name="1289909"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >stayne</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#53">[#53]</a></td></tr></table></td></tr><tr ><td class="posttext"> Flanker: emailed you the "almost" done FPS map.  Still just a spawn entity placed.  Making sure it works for you first before I finish it.<br><br>Edit: Also sent you some ugly hacked up FPS code instead of the chasecam stuff.  Change your camerazoom to 1.6 by the way, forgot to add that. <br><br></td></tr></table><br>
<a name="1289880"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Guy Fawkes</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#54">[#54]</a></td></tr></table></td></tr><tr ><td class="posttext"> Cannot WAIT to test this! :D <br><br></td></tr></table><br>
<a name="1289914"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Guy Fawkes</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#55">[#55]</a></td></tr></table></td></tr><tr ><td class="posttext"> @Flanker :: Me &amp; Rick are on the chat! :)<br><br>~GF <br><br></td></tr></table><br>
<a name="1289934"></a>

<a name="1289938"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Flanker</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#56">[#56]</a></td></tr></table></td></tr><tr ><td class="posttext"> @Rick Nasher<br>Unfortunately the LAmaNet/Rottnet code is huge and commented in german that I can't read :-/ I didn't look too much in it, it's a pain to understand someone else network code.<br><br>@stayne thanks, all that will be useful and the map looks good.<br><br>EDIT :<br>Also, I wrote a little code to test the UDP protocol beetween two computers. Tested with Guy Fawkes (i'm in Europe, he's in USA), it showed that unless you send a lot a data, UDP is reliable. For example when I uploaded data at 5 KB/s, GF received near 100% of it, with no order problems. When I uploaded at 100 KB/s (my connection upload limit), arrival dropped up to 25% and causing packets disordering. <br><br></td></tr></table><br>
<a name="1289939"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >stayne</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#57">[#57]</a></td></tr></table></td></tr><tr ><td class="posttext"> You are welcome.  Just a thrown together sealed map for testing. <br><br></td></tr></table><br>
<a name="1290011"></a>

<a name="1290013"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Flanker</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#58">[#58]</a></td></tr></table></td></tr><tr ><td class="posttext"> The connection issues we found over internet are fixed. Strange behaviour from Blitz3D, seems I can't write that on the same line :<br><pre class=code>If RecvUDPMsg(net_stream) And UDPMsgIP(net_stream) = net_serverIP And UDPMsgPort(net_stream) = net_serverPort</pre><br>Also, now, connection messages are sent multiple times until answer or timeout, to avoid packets loss.<br><br>@stayne we tested the map and your FPS code online, it works quite well for a "hack". I've been able to parse the spawn location and lights inside the b3d map file using the routine you provided on the other thread.<br><br>When the library is updated i'll start to write a little FPS with it. I converted a model from counter-strike to b3d with animations (not all) using milkshape, maybe it will be usable :<br><br><a href="http://i.imgbox.com/L0qUvy3P.jpg" target="_blank"><img src="http://9.t.imgbox.com/L0qUvy3P.jpg"></a><br><br>The gun is from Psionic's website. <br><br></td></tr></table><br>
<a name="1290015"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >stayne</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#59">[#59]</a></td></tr></table></td></tr><tr ><td class="posttext"> Cool I'm glad it works!  I'll go ahead and add 3 more spawns (hate spawn campers) some weapon/ammo spawns, check for leaks and do some texture tweaks. <br><br></td></tr></table><br>
<a name="1290025"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Flanker</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#60">[#60]</a></td></tr></table></td></tr><tr ><td class="posttext"> yes a lot of spawns because guy fawkes will spawnkill with minigun cheats... :D <br><br></td></tr></table><br>
<a name="1290032"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Guy Fawkes</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#61">[#61]</a></td></tr></table></td></tr><tr ><td class="posttext"> I DO THAT ON PURPOSE! &gt;.&lt; It helps find lag issues! LOL! ( And I get to murder Rick &amp; Flanker :D )<br><br>~GF <br><br></td></tr></table><br>
<a name="1290037"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Guy Fawkes</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#62">[#62]</a></td></tr></table></td></tr><tr ><td class="posttext"> I'm on the chat, Flanker! :)<br><br>~GF <br><br></td></tr></table><br>
<a name="1290038"></a>

<a name="1290039"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >stayne</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#63">[#63]</a></td></tr></table></td></tr><tr ><td class="posttext"> If RecvUDPMsg(net_stream) And UDPMsgIP(net_stream) = net_serverIP And UDPMsgPort(net_stream) = net_serverPort<br><br>Perhaps Blitz needs this:<br><br>If RecvUDPMsg(net_stream) = something And UDPMsgIP(net_stream) = net_serverIP And UDPMsgPort(net_stream) = net_serverPort<br><br>or<br><br>If RecvUDPMsg(net_stream) &lt;&gt; 0 And UDPMsgIP(net_stream) = net_serverIP And UDPMsgPort(net_stream) = net_serverPort <br><br></td></tr></table><br>
<a name="1290050"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rick Nasher</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#64">[#64]</a></td></tr></table></td></tr><tr ><td class="posttext"> Or just the booleans True/False, but I've once too encountered a situation that it was working fine when nested, but not in one line, peculiar enough. <br><br></td></tr></table><br>
<a name="1290054"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >stayne</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#65">[#65]</a></td></tr></table></td></tr><tr ><td class="posttext"> Yep like this:<br><pre class=code>
If RecvUDPMsg(net_stream)
  If UDPMsgIP(net_stream) = net_serverIP And UDPMsgPort(net_stream) = net_serverPort
    Do stuff
  End If
End If
</pre> <br><br></td></tr></table><br>
<a name="1290058"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rick Nasher</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#66">[#66]</a></td></tr></table></td></tr><tr ><td class="posttext"> Indeed. <br><br></td></tr></table><br>
<a name="1290072"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Guy Fawkes</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#67">[#67]</a></td></tr></table></td></tr><tr ><td class="posttext"> Nasher, Flanker. I'm on the chat! :)<br><br>~GF <br><br></td></tr></table><br>
<a name="1290076"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Flanker</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#68">[#68]</a></td></tr></table></td></tr><tr ><td class="posttext"> <pre class=code>If RecvUDPMsg(net_stream)
  If UDPMsgIP(net_stream) = net_serverIP And UDPMsgPort(net_stream) = net_serverPort
    Do stuff
  End If
End If</pre><br>Yes that's what I had to do. Maybe Blitz3D doesn't check If And/Or in order or something. Anyway it is fixed, took long to find. <br><br></td></tr></table><br>
<a name="1290077"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Guy Fawkes</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#69">[#69]</a></td></tr></table></td></tr><tr ><td class="posttext"> Stayne, we should add the ability for there to be Admins / Mods / Players, as well as multiple-parameter optional as well as non-optional slash command parameters. It would make the game MUCH more interesting (AND prevent alot more players from cheating).<br><br>~GF <br><br></td></tr></table><br>
<a name="1290078"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >stayne</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#70">[#70]</a></td></tr></table></td></tr><tr ><td class="posttext"> Nah I just wanted to help by making a decent map for the FPS example.  Not my code nor my project and I am a horrible coder always have been.  Flanker is doing a good job and is handling things just fine as far as I can tell.  There is no "we" as far as I can tell anyway. <br><br></td></tr></table><br>
<a name="1290257"></a>

<a name="1290258"></a>

<a name="1290266"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rick Nasher</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#71">[#71]</a></td></tr></table></td></tr><tr ><td class="posttext"> @Flanker: As colors are more or less the same, only slightly varying, isn't it likely that they are caused by some rounding/conversion of variables that hold the color values? <br><br></td></tr></table><br>
<a name="1290267"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Flanker</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#72">[#72]</a></td></tr></table></td></tr><tr ><td class="posttext"> Nope, this is because of the Net_RequestPlayer() command. I added it because when GF was the server, I often received player's color before the "new player" packet, I don't know why but it's like that. The problem is that you can't update a player you didn't create yet... So when you don't know a player you request it with that command, but this is handled by the library, and the library doesn't deal with colors or skins or things like that, it just resend the "new player" packet with name and ID. So something has to be added in the example to synchronize colors in any case. <br><br></td></tr></table><br>
<a name="1290276"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Guy Fawkes</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#73">[#73]</a></td></tr></table></td></tr><tr ><td class="posttext"> I'm on the chat guys! =D<br><br>~GF <br><br></td></tr></table><br>
<a name="1290278"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rick Nasher</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#74">[#74]</a></td></tr></table></td></tr><tr ><td class="posttext"> Hmm, so there's a whole lot more to this library than I thought. But.. if all playera are created first in the same color and once created you send the color to all players wouldn't that have the desired effect? <br>This could then also be used to temporary change color for instance when being hit.<br>Additionally a newly created player could also be having an alpha value set to be transparent so it won't be noticed and then when color is set it could slowly appear using a timer as if being transported to the spawn spot. Or is this a bad idea or hard to realize? <br><br></td></tr></table><br>
<a name="1290303"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Flanker</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#75">[#75]</a></td></tr></table></td></tr><tr ><td class="posttext"> Yes, with UDP you must consider that each packet can never arrive, or arrive in any order. I'll maybe add TCP for connection and such important packets when I have time. <br><br></td></tr></table><br>
<a name="1290312"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rick Nasher</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#76">[#76]</a></td></tr></table></td></tr><tr ><td class="posttext"> Hmm ok. <br><br></td></tr></table><br>
<a name="1290327"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >stayne</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#77">[#77]</a></td></tr></table></td></tr><tr ><td class="posttext"> Read RemiD's post near the bottom:<br><br><a href="http://www.blitzbasic.com/Community/posts.php?topic=100246" target="_blank">http://www.blitzbasic.com/Community/posts.php?topic=100246</a> <br><br></td></tr></table><br>
<a name="1290430"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >stayne</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#78">[#78]</a></td></tr></table></td></tr><tr ><td class="posttext"> More info for you Flanker:<br><br><a href="http://www.blitzbasic.com/Community/posts.php?topic=57491" target="_blank">http://www.blitzbasic.com/Community/posts.php?topic=57491</a> <br><br></td></tr></table><br>
<a name="1290466"></a>

<a name="1290468"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rick Nasher</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#79">[#79]</a></td></tr></table></td></tr><tr ><td class="posttext"> That's very interesting intel, thanks stayne. <br><br></td></tr></table><br>
<a name="1290467"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Guy Fawkes</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#80">[#80]</a></td></tr></table></td></tr><tr ><td class="posttext"> @Nasher, @Flanker, I'm in the chat! :)<br><br>~GF <br><br></td></tr></table><br>
<a name="1290572"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Flanker</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#81">[#81]</a></td></tr></table></td></tr><tr ><td class="posttext"> Yes I've also read that maximum packet size in UDP should be 576 bytes, not sure exactly why, but maybe to avoid packet splitting like RemiD says. About packets integrity, I read that once you receive an UDP packet, it is necessarily intact, because its lenght is in the header, and it's verified at arrival so broken packets are ignored. With this behaviour, it seems useless to me to add the packet lenght to the packet itself because it can be read with ReadAvail(stream). However, a packet number can be usefull to track certain packet loss (important ones), reorder them, or eventually ask them back or confirm arrival to server. UDP is used for fast transmission, where it is preferable to drop a packet and read the next one, instead of waiting for that packet. But the engine has to be prepared for this. Otherwise, TCP is the way to go :) <br><br></td></tr></table><br>
<a name="1290574"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >stayne</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#82">[#82]</a></td></tr></table></td></tr><tr ><td class="posttext"> Yep TCP is best for an FPS or any packet-sensitive game/app.  Sorry you had to find out the hard way. <br><br></td></tr></table><br>
<a name="1290582"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Raster Ron</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#83">[#83]</a></td></tr></table></td></tr><tr ><td class="posttext"> This is a nice udp library. Btw, I made some small quick changes to 3d example chat text panel to support player colors.<br><br><img src="http://i.imgur.com/iAXV2Ym.png"><br><br>I got the rgb to hex code here <a href="/post.php?topic=72763&amp;post=814117" target="_blank">(Hex8.bb)</a><br><br>This is the <a href="https://www.diffchecker.com/pxz5ho73" target="_blank"><b>diff</b></a> for reference.<br><br><textarea class=codebox name="code" wrap=OFF readonly="true" rows="15" cols="80">
SeedRnd MilliSecs()

Const gameLogicFPS = 60

Include "Hex8.bb"
Include "UDPNetwork_lib.bb"

Global localID
Global localName$ = Input("Enter your name : ")
If localName = "" Then localName = "player" + Rand(100,999)

Global localPlayerMesh

Type player
	Field id
	Field name$
	Field ping
	
	Field life
	Field kills
	Field deaths
	
	Field mesh
	Field r,g,b

	Field nextX#,nextY#,nextZ#
	Field previousX#,previousY#,previousZ#
	Field nextYaw#
	Field previousYaw#
	Field nextTime
	Field previousTime
	
	Field lastPacket
	
	Field currentY#
	Field velocityY#
End Type

Type bullet
	Field mesh
	Field angle#
	Field time
	Field id ; id of player who fired
End Type

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
; Camera code from jfk EO-11110, thanks
Global bounce_cam=1 ;  smooth camera motion? (0/1)
Global bounce_div#=10.0 ; the higher, the more sluggish the camera will follow. Recc: 3.0 to 20.0
; some globals used by ChaseCam
Global old_x#,old_y#,old_z#
; desired distance between camera and player mesh
Global x_dis#=7.0,y_dis#=3,z_dis#=7.0,y_dis_or#=y_dis#
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;

; network init ----------------------------------------;
Global localMode = Net_StartInput() ; bring the library "console" to connect

If localMode = 1 Or localMode = 2 ; 1 means we are client, 2 means we are server
	
	localId = Net_CreatePlayer(localName) ; this command inits the server or local client
	
	If localId = 0 ; error
		Net_StopNetwork() ; close the network properly
		RuntimeError("Failed to create player.")
	EndIf
	
	If localMode = 1 Then AppTitle("Client : " + localName + " (port:" + net_port + "/ ID=" + localID + ")")
	If localMode = 2 Then AppTitle("Server : " + localName + " (port:" + net_port + "/ ID=" + localID + ")")
	
Else ; error
	Net_StopNetwork()
	RuntimeError("Failed to start game.")
EndIf
;------------------------------------------------------;

Graphics3D 640,480,32,2
SetBuffer BackBuffer()

CreateScene()

Global camera = CreateCamera()
CameraRange camera,0.1,1000

; create our own local player
localPlayerMesh = CreatePlayer(localID,localName)
old_x = EntityX(localPlayerMesh):old_y = EntityY(localPlayerMesh):old_z = EntityZ(localPlayerMesh) ; update camera position

; we send our color to the server
p.player = Object.player(GetPlayer(localID))
Net_SendMessage(3,p\r + "/" + p\g + "/" + p\b)

Global cR = p\r
Global cG = p\g
Global cB = p\b

; variables used to send our positions at a constant delay (saves bandwidth but makes a constant ping)
Global updatePosition = MilliSecs()
Global updateTick = 50

; chat
Global messageDisplayNumber = 10
Global messageOffset
Dim message$(messageDisplayNumber)

Global chatMode
Global chatMessage$ = localName + "&gt; "
Global chatMillisecs = MilliSecs()
Global chatCursor

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
tweeningPeriod = 1000 / gameLogicFPS
tweeningTime = MilliSecs() - tweeningPeriod
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
While Not KeyHit(1)

	;; I use tweening from castle demo here :
	;;
	;; 		- this allows to have very fast execution outside the tweening loop,
	;; 		  so the network is updated as fast as possible (needs Flip False)
	;;
	;; 		- this makes the game logic updated at a constant rate (Const FPS=)
	;;		  so no need to set deltatime (and it saves CPU time for other things)


	;; -------------------------------------------------------------------------------------------------; FAST EXECUTION (outside of tweening)
	;; -------------------------------------------------------------------------------------------------;
	
	; see the function, the interpolation variables are set properly here
	UpdateNetwork()
		
	;; -------------------------------------------------------------------------------------------------;

	Repeat
		tweeningElapsed = MilliSecs() - tweeningTime
	Until tweeningElapsed
	tweeningTicks = tweeningElapsed / tweeningPeriod
	tweeningRate# = Float(tweeningElapsed Mod tweeningPeriod)/Float(tweeningPeriod)
	For k = 1 To tweeningTicks
		tweeningTime = tweeningTime + tweeningPeriod
		If k = tweeningTicks Then CaptureWorld
		
		;; ---------------------------------------------------------------------------------------------; MAIN UPDATE
		;; ---------------------------------------------------------------------------------------------;
		
		; update our player
		UpdateLocalPlayer()
		
		; the interpolation is made in this function
		UpdatePlayers()
		
		; update the bullets... only the server check for player kills
		UpdateBullets()

		UpdateWorld()
		
		UpdateChaseCam(camera,localPlayerMesh)
		
		;; ---------------------------------------------------------------------------------------------;
		
	Next
	
	RenderWorld tweeningRate

	;; -------------------------------------------------------------------------------------------------; 2D UPDATE
	;; -------------------------------------------------------------------------------------------------;
	
	DrawPlayersNames()
	
	If KeyHit(28) And chatMode = 0 Then chatMode = 1:FlushKeys()
	If chatMode = 1 Then UpdateChat()
	
	DrawMessages()
	
	If KeyDown(15) Then DrawScoreTable()
	
	;; -------------------------------------------------------------------------------------------------;
	
	Flip

Wend
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;

Net_StopNetwork()

End

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function UpdateNetwork()

	; update incoming packets (better check ALL incoming messages so use While Wend)
	While Net_CheckMessage() ; will check for a new message and fill Net_MsgType, Net_MsgString$, Net_MsgFrom and Net_MsgTo variables so we can read it
		
		p.player = Object.player(GetPlayer(Net_MsgFrom)) ; get the player handle

		If Handle(p) = 0 And Net_MsgType &lt; 100 ; we received an update packet from a player we don't know
			; so we ask the server who he is and return because we can't update him for now
			; the server will resend us the info in a new player "100" message
			Net_RequestPlayer(Net_MsgFrom)
			Return
		EndIf
		
		Select Net_MsgType ; check the type of message
						
			Case 1 ; chat message
			
				NewMessage(Net_MsgString)
									
			Case 2 ; player position and angle, example of packing data into string
				
				offset1 = Instr(Net_MsgString,"/",1)
				offset2 = Instr(Net_MsgString,"/",offset1+1)
				offset3 = Instr(Net_MsgString,"/",offset2+1)
								
				p\previousX = p\nextX
				p\previousY = p\nextY
				p\previousZ = p\nextZ
				p\previousYaw = p\nextYaw
				
				p\nextX = Left(Net_MsgString,offset1-1)
				p\nextY = Mid(Net_MsgString,offset1+1,offset2-offset1-1)
				p\nextZ = Mid(Net_MsgString,offset2+1,offset3-offset2-1)
				p\nextYaw = Right(Net_MsgString,Len(Net_MsgString)-offset3)

				p\previousTime = p\nextTime
				p\nextTime = MilliSecs()
							
			Case 3 ; update player colors
						
				offset1 = Instr(Net_MsgString,"/",1)
				offset2 = Instr(Net_MsgString,"/",offset1+1)
							
				p\r = Left(Net_MsgString,offset1-1)
				p\g = Mid(Net_MsgString,offset1+1,offset2-offset1-1)
				p\b = Right(Net_MsgString,Len(Net_MsgString)-offset2)
								
				EntityColor p\mesh,p\r,p\g,p\b
				
			Case 4 ; a player fired
			
				CreateBullet(Net_MsgFrom)
							
			Case 5 ; a player lost some life
			
				p\life = Net_MsgString
			
			Case 6 ; a player killed another one
			
				k.player = Object.player(GetPlayer(Net_MsgString)) ; killed player ID in MsgData
				NewMessage(p\name + " killed " + k\name)
				
				ResetPlayer(k\id)
			
			Case 7 ; the server sends us score update for a player
			
				offset = Instr(Net_MsgString,"/",1)
				
				p\kills = Left(Net_MsgString,offset-1)
				p\deaths = Right(Net_MsgString,Len(Net_MsgString)-offset)
						
			Case 100 ; new player connected, OR the server tells us who is already connected so we can create players when joining the game
							
				If localMode = 2
					For p.player = Each player
						Net_SendMessage(2,p\nextX + "/" + p\nextY + "/" + p\nextZ + "/" + p\nextYaw,p\id,Net_MsgFrom)
						Net_SendMessage(3,p\r + "/" + p\g + "/" + p\b,p\id,Net_MsgFrom)
						
						Net_SendMessage(5,p\life,p\id,Net_MsgFrom)
						Net_SendMessage(7,p\kills+"/"+p\deaths,p\id,Net_MsgFrom)
					Next
				EndIf
				
				NewMessage(Net_MsgString + " connected")
				CreatePlayer(Net_MsgFrom,Net_MsgString)
				
			Case 101 ; a player has quit
						
				For p.player = Each player
					If Net_MsgFrom = p\id
						NewMessage(p\name + " disconnected")
						FreeEntity p\mesh
						Delete p
					EndIf
				Next
							
			Case 102 ; host has changed
			
				For p.player = Each player
					If Net_MsgFrom = p\id
						If p\id = localID
							AppTitle("Server : " + localName + " (port:" + net_port + ")")
							NewMessage("You are the new host")
							localMode = 2
						Else
							NewMessage(p\name + " is the new host")
						EndIf					
					EndIf
				Next
			
			Case 103 ; ping update
			
				For p.player = Each player
					If Net_MsgFrom = p\id
						p\ping = Net_MsgString
					EndIf
				Next

		End Select

	Wend

End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function UpdateLocalPlayer()

	; update our player
	p.player = Object.player(GetPlayer(localID)) ; get our player

	; inputs
	If KeyDown(200) Then MoveEntity p\mesh,0,0,0.3
	If KeyDown(208) Then MoveEntity p\mesh,0,0,-0.3
	If KeyDown(203) Then TurnEntity p\mesh,0,3,0
	If KeyDown(205) Then TurnEntity p\mesh,0,-3,0
		
	; fire
	If MouseHit(1)
		Net_SendMessage(4,"")
		CreateBullet(localID)
	EndIf
	
	; jump
	If MouseHit(2)
		; check if player is one the ground
		LinePick(EntityX(p\mesh),EntityY(p\mesh),EntityZ(p\mesh),0,-1.2,0)
		If PickedEntity()
			p\velocityY = 0.5 ; set "inverse" of gravity velocity
		EndIf	
	EndIf
	
	; we create a message type "2" for player position
	If MilliSecs()-updatePosition &gt; updateTick
	
		Net_SendMessage(2,EntityX(p\mesh) + "/" + EntityY(p\mesh) + "/" + EntityZ(p\mesh) + "/" + EntityYaw(p\mesh))
		updatePosition = MilliSecs()
	EndIf
	
End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function UpdatePlayers()

	For p.player = Each player
				
		If p\id &lt;&gt; localID ; update other players only
						
			;; LINEAR INTERPOLATION ;;;;;;;;;;
			
			If p\nextTime &lt;&gt; p\previousTime ; if both packets arrived at the same time, we can't interpolate
				
				curTime# = Float(MilliSecs()-p\nextTime) / Float(p\nextTime-p\previousTime) ; curTime will be ideally 0.0-1.0, if it's &gt; 1.0 then it performs extrapolation
				
				If curTime &gt; 1 Then curTime = 1 ; extrapolation gives anoying jittering effects
				
				; special fix for yaw as EntityYaw returns a value beetween +180 ans -180, the interpolation can go backward
				If p\previousYaw &lt; 0 Then p\previousYaw = p\previousYaw + 360
				If p\nextYaw &lt; 0 Then p\nextYaw = p\nextYaw + 360
				If Abs(p\nextYaw-p\previousYaw) &gt; 180
					If p\nextYaw &gt; p\previousYaw
						p\previousYaw = p\previousYaw + 360
					Else
						p\previousYaw = p\previousYaw - 360
					EndIf
				EndIf
				
				PositionEntity p\mesh,p\previousX+(p\nextX-p\previousX)*curTime,p\previousY+(p\nextY-p\previousY)*curTime,p\previousZ+(p\nextZ-p\previousZ)*curTime
				RotateEntity p\mesh,0,p\previousYaw+(p\nextYaw-p\previousYaw)*curTime,0
				
			Else
			
				PositionEntity p\mesh,p\nextX,p\nextY,p\nextZ
				RotateEntity p\mesh,0,p\nextYaw,0
			
			EndIf
			;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
						
			ResetEntity p\mesh ; reset entity is useful here because of collisions

		Else ; update our player, basically it just compute gravity
		
			p\velocityY = p\velocityY - 0.03 ; fake gravity
			If EntityY(p\mesh) - p\currentY &gt;= 0 ; if player is not falling we limit the gravity
				If p\velocityY &lt; -0.03 Then p\velocityY = -0.03
			EndIf
		
			p\currentY = EntityY(p\mesh)
			TranslateEntity p\mesh,0,p\velocityY,0
						
		EndIf
	Next

End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function CreatePlayer(id,name$)

	For p.player = Each player
		If p\id = id Then Return ; player already connected
	Next

	p.player = New player
	p\id = id
	p\name = name
	
	p\life = 100
	
	p\mesh = CreateSphere()
	EntityType p\mesh,2
	EntityRadius p\mesh,1
	
	NameEntity p\mesh,Handle(p)
	
	nose = CreateSphere(8,p\mesh):EntityColor nose,255,0,0
	PositionEntity nose,0,0,1
	ScaleEntity nose,0.3,0.3,0.3
	
	eyeLeft = CreateSphere(8,p\mesh):EntityColor eyeLeft,255,255,255
	PositionEntity eyeLeft ,.29,.4,.7;1
	ScaleEntity eyeLeft ,0.2,0.2,0.2
	
	pupilLeft = CreateSphere(8,p\mesh):EntityColor pupilLeft ,0,0,0
	PositionEntity pupilLeft ,.3,.4,.9;1
	ScaleEntity pupilLeft ,0.05,0.05,0.02
	
	eyeRight = CreateSphere(8,p\mesh):EntityColor eyeRight ,255,255,255
	PositionEntity eyeRight ,-.29,.4,.7;1
	ScaleEntity eyeRight ,0.2,0.2,0.2
		
	pupilRight = CreateSphere(8,p\mesh):EntityColor pupilRight ,0,0,0
	PositionEntity pupilRight ,-.3,.4,.9;1
	ScaleEntity pupilRight ,0.05,0.05,0.02

	unaBrow = CreateCone(8,1,p\mesh):EntityColor unaBrow ,0,0,0
	PositionEntity unaBrow ,0,.45,.7
	RotateEntity unaBrow ,-180,0,0
	ScaleEntity unaBrow ,.7,.2,.3
	
	p\nextX = -20
	p\nextY = 1
	p\nextZ = -20
	p\nextYaw = -45
	
	p\previousX = p\nextX
	p\previousY = p\nextY
	p\previousZ = p\nextZ
	p\previousYaw = p\nextYaw
	
	p\r = Rand(255)
	p\g = Rand(255)
	p\b = Rand(255)
	EntityColor p\mesh,p\r,p\g,p\b
	
	PositionEntity p\mesh,p\nextX,p\nextY,p\nextZ
	RotateEntity p\mesh,0,p\nextYaw,0
	ResetEntity p\mesh
	
	p\currentY = p\nextY
	
	p\previousTime = MilliSecs()
	p\nextTime = MilliSecs()+1
	
	Return p\mesh

End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function ResetPlayer(id)

	p.player = Object.player(GetPlayer(id))

	p\life = 100

	p\nextX = -20
	p\nextY = 1
	p\nextZ = -20
	p\nextYaw = -45

	p\previousX = p\nextX
	p\previousY = p\nextY
	p\previousZ = p\nextZ
	p\previousYaw = p\nextYaw

	PositionEntity p\mesh,p\nextX,p\nextY,p\nextZ
	RotateEntity p\mesh,0,p\nextYaw,0
	ResetEntity p\mesh
	
	p\currentY = p\nextY
	
	p\previousTime = MilliSecs()
	p\nextTime = MilliSecs()+1

End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function GetPlayer(id)

	For p.player = Each player
		If p\id = id
			Return Handle(p)					
		EndIf
	Next
	
End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function DrawPlayersNames()

	For p.player = Each player
	
		Color 255,255,255
		CameraProject(camera,EntityX(p\mesh),EntityY(p\mesh),EntityZ(p\mesh)) 			
		If p\id &lt;&gt; localID Then Text ProjectedX(),ProjectedY()-60,p\name,1,1
		
		Color 255,(255./100.)*p\life,(255./100.)*p\life
		Text ProjectedX(),ProjectedY()-40,p\life,1,1

	Next
	
End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function CreateBullet(id)

	p.player = Object.player(GetPlayer(id))

	b.bullet = New bullet
	
	b\id = p\id
	
	b\mesh = CreateSphere(2)
	ScaleEntity b\mesh,0.2,0.2,0.2
	EntityColor b\mesh,255,0,0
		
	PositionEntity b\mesh,EntityX(p\mesh),EntityY(p\mesh),EntityZ(p\mesh)
	RotateEntity b\mesh,0,EntityYaw(p\mesh),0
	
	EntityType b\mesh,3
	EntityRadius b\mesh,0.2
		
	b\time = MilliSecs()

End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function UpdateBullets()

	For b.bullet = Each bullet
	
		MoveEntity b\mesh,0,0,1
		
		If CountCollisions(b\mesh)
		
			If localMode = 2 ; only the server compute bullets collision with player
				If GetEntityType(CollisionEntity(b\mesh,1)) = 2 ; a player is hit
				
					touchedPlayer.player = Object.player(EntityName(CollisionEntity(b\mesh,1)))
					touchedPlayer\life = touchedPlayer\life - 10
					
					If touchedPlayer\life &gt; 0 ; touched
						Net_SendMessage(5,touchedPlayer\life,touchedPlayer\id)
						Net_SendMessage(5,touchedPlayer\life,touchedPlayer\id,touchedPlayer\id)
					Else ; killed
						killerPlayer.player = Object.player(GetPlayer(b\id))
						
						killerPlayer\kills = killerPlayer\kills + 1
						touchedPlayer\deaths = touchedPlayer\deaths + 1						
						
						Net_SendMessage(6,touchedPlayer\id,killerPlayer\id)
						Net_SendMessage(6,touchedPlayer\id,killerPlayer\id,killerPlayer\id)
												
						Net_SendMessage(7,killerPlayer\kills+"/"+killerPlayer\deaths,killerPlayer\id)
						Net_SendMessage(7,killerPlayer\kills+"/"+killerPlayer\deaths,killerPlayer\id,killerPlayer\id)
						
						Net_SendMessage(7,touchedPlayer\kills+"/"+touchedPlayer\deaths,touchedPlayer\id)
						Net_SendMessage(7,touchedPlayer\kills+"/"+touchedPlayer\deaths,touchedPlayer\id,touchedPlayer\id)
						
						NewMessage(killerPlayer\name + " killed " + touchedPlayer\name)
						ResetPlayer(touchedPlayer\id)
					EndIf
				
				EndIf
			EndIf
			
			FreeEntity b\mesh
			Delete b
			
		ElseIf MilliSecs()-b\time &gt; 2000
		
			FreeEntity b\mesh
			Delete b
			
		EndIf
	
	Next

End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function NewMessage(msg$)

	messageOffset = messageOffset + 1
	
	If messageOffset &gt; messageDisplayNumber
	
		messageOffset = messageOffset - 1
		
		For i = 2 To messageDisplayNumber
			message(i-1) = message(i)		
		Next
		
		message(messageDisplayNumber) = msg
	
	Else
	
		message(messageOffset) = msg
	
	EndIf

End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function DrawMessages()

	Color 255,255,255

	For i = 1 To messageOffset
		loc = Instr (message(i), "",1)
		If loc &gt; 1 Then
			colorMessage$ = Mid$(message(i), 1, Len(message(i)) - 7 )
			Hex$ = Right$(message(i),6)		
			Set_Color_Hex(Hex$)
			Text 0,(i-1)*15,colorMessage$
		Else 
			Color 255,255,255
			Text 0,(i-1)*15,message(i)
		End If	
	Next

End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function UpdateChat()

	key = GetKey()

	If key
		If key = 13
			If chatMessage &lt;&gt; localName + "&gt; "
				For i = Len(localName + "&gt; ") To Len(chatMessage)
					If Mid(chatMessage,i,1) &lt;&gt; " "
						chatColor$ = RGB_To_TriHex(cR,cG,cB)
						chatMessage = chatMessage + "" + chatColor$					
						Net_SendMessage(1,chatMessage)
						NewMessage(chatMessage)
						Exit
					EndIf
				Next
			EndIf
			chatMessage = localName + "&gt; "
			chatMode = 0
		ElseIf key = 8 And Len(chatMessage) &gt; Len ( localName + "&gt; " )
			chatMessage = Left(chatMessage,Len(chatMessage)-1)
		ElseIf key &gt; 31 And key &lt; 127
			chatMessage = chatMessage + Chr(key)
		EndIf
	EndIf
	
	Color 255,255,255
	Rect 0,GraphicsHeight()-20,GraphicsWidth(),20,1
	
	Color 0,0,0
	Rect 0,GraphicsHeight()-20,GraphicsWidth(),20,0
	
	
	If MilliSecs()-chatMillisecs &gt; 500
		chatCursor = Not chatCursor
		chatMillisecs = MilliSecs()
	EndIf
	
	If chatCursor
		Text 5,GraphicsHeight()-17,chatMessage + "|"
	Else
		Text 5,GraphicsHeight()-17,chatMessage
	EndIf

End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function DrawScoreTable()

	For p.player = Each player
		count = count + 1
	Next
	
	baseX = (GraphicsWidth()-350)/2
	baseY = (GraphicsHeight()-(35+20*count))/2

	Color 0,0,0
	Rect baseX,baseY,350,35+20*count,1

	Color 255,192,0
	Rect baseX,baseY,350,35+20*count,0

	Text baseX+10,baseY+10,"Player          Kills     Deaths     Ping"
	Line baseX,baseY+25,baseX+349,baseY+25

	For p.player = Each player
	
		Color 255,255,255
		If p\id = localID Then Color 255,100,100
	
		i = i + 1
		Text baseX+10,baseY+10+20*i,p\name
		Text baseX+157,baseY+10+20*i,p\kills,1,0
		Text baseX+240,baseY+10+20*i,p\deaths,1,0
		Text baseX+322,baseY+10+20*i,p\ping,1,0
	Next

End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function UpdateChaseCam(camera,player) ; thanks to jfk EO-11110 on bb forums for this function !
	PositionEntity camera,EntityX(player,1),EntityY(player,1),EntityZ(player,1)
	ResetEntity camera
	x#=EntityX(player)+Sin(-EntityYaw(player)+180)*x_dis#
	y#=EntityY(player)+y_dis#
	z#=EntityZ(player)+Cos(-EntityYaw(player)+180)*z_dis#
	obstacle=LinePick(EntityX(player),EntityY(player),EntityZ(player),(x-EntityX(player)),y_dis#,(z-EntityZ(player)),0.1)
	If obstacle=0
		new_x#=x
		new_y#=y
		new_z#=z
	Else
		new_x#=PickedX()
		new_y#=PickedY()
		new_z#=PickedZ()
	EndIf
	If bounce_cam=0
		PositionEntity camera,new_x,new_y,new_z
	Else
		x=old_x+((New_x-old_x)/bounce_div#)
		y=old_y+((New_y-old_y)/bounce_div#)
		z=old_z+((New_z-old_z)/bounce_div#)
		PositionEntity camera,x,y,z
	EndIf
	PointEntity camera,player
	TurnEntity camera,-20,0,0     ; if you want the player mesh more on the bottom of the screen
	old_x#=EntityX(camera)
	old_y#=EntityY(camera)
	old_z#=EntityZ(camera)
End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function CreateScene()

	texture = TextureCreate(128)
	
	ground = CreatePlane()
	EntityColor ground,150,150,150
	EntityTexture ground,texture
	
	cube = CreateCube():EntityColor cube,150,200,150
	ScaleEntity cube,5,5,5:PositionEntity cube,0,5,0
	EntityTexture cube,texture
	
	sphere = CreateSphere(16):EntityColor sphere,200,150,150
	ScaleEntity sphere,3,1,3:PositionEntity sphere,0,9.7,0
	
	platform = CreateCube():EntityColor platform,150,150,200
	ScaleEntity platform,3,1,10:PositionEntity platform,0,4.13,-13.15
	TurnEntity platform,-30,0,0
	EntityTexture platform,texture
	
	FreeTexture texture
	
	EntityType ground,1:EntityPickMode ground,2
	EntityType cube,1:EntityPickMode cube,2
	EntityType sphere,1:EntityPickMode sphere,2
	EntityType platform,1:EntityPickMode platform,2

	light = CreateLight()
	TurnEntity light,30,70,0
	
	;; COLLISIONS
	Collisions 2,1,2,3 ; player to scene
	Collisions 2,2,1,3 ; player to player
	
	Collisions 3,1,2,1 ; bullet to scene
	Collisions 3,2,1,1 ; bullet to player
	
End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function TextureCreate(size)
	texture = CreateTexture(size,size,9)
	SetBuffer TextureBuffer(texture)
	Color 255,255,255
	Rect 0,0,size,size,1
	Color 0,0,0
	Rect 0,0,size,size,0
	Line 0,0,size,size
	Line 0,size,size,0
	SetBuffer BackBuffer()
	Return texture
End Function
</textarea><br><br>cheers. :) <br><br></td></tr></table><br>
<a name="1290588"></a>

<a name="1290595"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Guy Fawkes</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#84">[#84]</a></td></tr></table></td></tr><tr ><td class="posttext"> I love you! LOL!<br><br>Can I join you in beta testing?<br><br>I want to see 3 things.<br><br>1) Admin / Moderator / Player Status with different colors for Name tags as well as Status color.<br><br>2) Chat commands with multiple parameters ( optional AS WELL AS non-optional ) for Admins &amp; Moderators &amp; Players alike.<br><br>3) Status displayed in Name tag.<br><br>Thank you so much for the contribution! Keep up the great work! :)<br><br>~GF <br><br></td></tr></table><br>
<a name="1290596"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Guy Fawkes</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#85">[#85]</a></td></tr></table></td></tr><tr ><td class="posttext"> And for any of you nay-sayers out there who wanna bash me for asking for too much, I would like to inform you that I have done countless hours of beta testing to help make this dream a reality. So, @Raster Ron, if they try to bash me, or make you change your mind to help with these 3 requests, I ask that you kindly ignore them.<br><br>~GF <br><br></td></tr></table><br>
<a name="1290677"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rick Nasher</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#86">[#86]</a></td></tr></table></td></tr><tr ><td class="posttext"> This is indeed a nice addition. Thanks Raster Ron.<br><br>Flanker is steering the pudle with this lib, more and more appreciated. <br><br></td></tr></table><br>
<a name="1290711"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Flanker</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#87">[#87]</a></td></tr></table></td></tr><tr ><td class="posttext"> @stayne<br>I would say that UDP is better for FPS and action games in general. The only thing is to write something to ensure that important packets are received, something TCP-like with acknoledgments. I'll try to add that before adding TCP because I'd prefer only one protocol, but that's a lot more work.<br><br>@Raster Ron<br>Nice one that's a good idea :) Also I didn't know the diffchecker website, it can be very useful ! <br><br></td></tr></table><br>
<a name="1290731"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Guy Fawkes</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#88">[#88]</a></td></tr></table></td></tr><tr ><td class="posttext"> I'm on t3h chat, guys! :)<br><br>~GF <br><br></td></tr></table><br>
<a name="1290794"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Guy Fawkes</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#89">[#89]</a></td></tr></table></td></tr><tr ><td class="posttext"> This lib gets better &amp; better every time I wake up! =D<br><br>~GF <br><br></td></tr></table><br>
<a name="1290829"></a>

<a name="1290830"></a>

<a name="1290831"></a>

<a name="1290832"></a>

<a name="1290833"></a>

<a name="1290834"></a>

<a name="1290835"></a>

<a name="1290836"></a>

<a name="1290837"></a>

<a name="1290838"></a>

<a name="1290840"></a>

<a name="1290842"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Guy Fawkes</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#90">[#90]</a></td></tr></table></td></tr><tr ><td class="posttext"> Working on an actual MySQLi Login / Register for Username &amp; Password.<br><br>I got tired of people being able to use my name as their own.<br><br>-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=<br>Credits List :: <br><br>~* Guy Fawkes for creating / thinking of this idea<br>~* Flanker for the chat code &amp; the Network Library itself                                           <br><br>-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=<br>This is v.0.1 (Alpha) of the Login. I need your help guys.<br><br>What I wanna do is essentially create a Login form like WoW (World of Warcraft ), and I cannot get the username &amp; password to store in an array securely for later use to send it to the MySQLi Database using ETNA (Easy Database Network Access). I also want to have the form always display in the same place no matter WHAT size the resolution of the Game screen is. If you are interested, please help me fix it &amp; I will add your name to the credits.<br><br>It only shows the skeleton for a simple login at this point. It IS afterall, a W.I.P.! ^_^<br><br>Thank you all &amp; Enjoy! :) <br><br>-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=<br>Login.bb :: <br><br><textarea class=codebox name="code" wrap=OFF readonly="true" rows="15" cols="80">SeedRnd MilliSecs ( )

; User Register / Login
Global messageDisplayNumber = 2
Global messageOffset
Dim message$(messageDisplayNumber)

Global chatMode
Global chatMessage$
Global chatMillisecs = MilliSecs()
Global chatCursor
Global cursor$ = "|"

Global max_char_count = 23

Type button
	Field image$	;image containing button graphics
	Field x				;x position of button
	Field y				;y pos of button
	Field width		;width of button
	Field height		;height of button
	Field id			;so we know which button has been pressed
	Field state		;mouse over/up/down
End Type

Global mx,my,info$

Include "UDP_Networklib_1.12_MODIFIED_CLIENT.bb"
Include "Hex8.bb"

Global buttonheld, ID_clicked

Global tab_pos = 0

Global tab_ypos = 0

;if you use the centered option, the button will x position will be overidden and the button will center on the screen vertical axis
;centered.button = CreateTextButton ( "Centered long type", 50, 80, 150, 20, 1, 1 )

Graphics3D ( 800, 600, 0, 2 )

SetBuffer BackBuffer ( )

	While Not KeyDown ( 1 )
	
		Cls

			mx = MouseX () : my = MouseY() ; grab the mouse position at the top of the loop
		
			updatebuttons() ; check rollover state and draw buttons to screen. Call this every loop.
			buttonaction() ;this will execute the results of any button presses.

			UpdateWorld
			RenderWorld
			
			UpdateChat ( )
			DrawMessages ( )
			
			Text GraphicsWidth ( ) / 2, GraphicsHeight ( ) / 2+80, "tab_pos :: " + tab_pos, 1, 1

		Flip
	
	Wend

End

UpdateChat ( )

Function UpdateChat()

	key = GetKey()

	Local w1
	Local h1
	Local x1
	Local y1
	Local w2
	Local h2
	Local x2
	Local y2
	Local x11
	Local y11
	Local x22
	Local y22
	Local x3
	Local y3
	Local login_x
	Local login_y
	Local lbl1$
	Local lbl2$

	lbl1$ = "Username : "
	lbl2$ = "Password : "

	w1 = ( GraphicsWidth ( ) / 4.0 )
	h1 = ( 20 )
	x1 = ( GraphicsWidth ( ) / 2.0 - ( w1 / 2.0 ) )
	y1 = ( GraphicsHeight ( ) / 2.0 )

	w2 = ( GraphicsWidth ( ) / 4.0 )
	h2 = ( 20 )
	x2 = ( GraphicsWidth ( ) / 2.0 - ( w2 / 2.0 ) )
	y2 = ( GraphicsHeight ( ) / 2.0 - 20 )

	x11 =  ( x1 - StringWidth ( lbl1$ ) )
	y11 =  ( ( y1 - StringHeight ( lbl1$ ) ) - 3 )

	x22 =  ( x1 - StringWidth ( lbl2$ ) )
	y22 =  ( ( ( y1 - StringHeight ( lbl2$ ) ) - 3 ) + 20 )

	x3 = ( x1 + 2 )
	y3 = ( y1 + 4 )

	login_x = ( x1 + 40 )
	login_y = ( y1 + 40 )

		If key
			If key = 13
				For i = 1 To Len(chatMessage)
					If Mid(chatMessage,i,1) &lt;&gt; " "
						chatColor$ = RGB_To_TriHex(cR,cG,cB)
						;Uncomment to send Data to Database
						;Net_SendMessage(1,chatMessage)
						new_login$     =     NewLogin(tab_pos, chatMessage)
						If new_login$ &lt;&gt; ""  Then chatmessage = Left(chatMessage,Len(chatMessage)-Len(chatMessage))
						Exit
					EndIf
				Next
				chatMode = 0
			ElseIf key = 8 And Len(chatMessage) &lt; w1 And Len (chatMessage) &gt; 0
				chatMessage = Left(chatMessage,Len(chatMessage)-1)
			ElseIf key &gt; 31 And key &lt; 127
				If Len(chatMessage) &lt; ( max_char_count )
					chatMessage = chatMessage + Chr(key)
				EndIf
				If Len(chatMessage) = ( max_char_count )
					chatMessage = Left(chatMessage,Len(chatMessage)-1)
				EndIf
			EndIf
		EndIf

	;Username / Password Label
	Color 68, 207, 252
	Text x11, y11, lbl1$
	Color 68, 207, 252
	Text x22, y22, lbl2$

	;Build Login / Register form
	Color 68, 207, 252
	Rect x1, y1, w1, h1, 1
	Color 0, 0, 0
	Rect x1, y1, w1, h1, 0
	Color 68, 207, 252
	Rect x2, y2, w2, h2, 1
	Color 0, 0, 0
	Rect x2, y2, w2, h2, 0

	;Setup the Blinker
	If chatCursor &lt;&gt; 0 Then cursor$ = "|"
	If chatCursor  = 0 Then cursor$ = ""

	;If Tab is pressed, switch form inputs
	If tab_pos = 0 Then tab_ypos = 20
	If tab_pos = 1 Then tab_ypos =  0

	;Switch between Inputs
	If KeyHit ( 15 ) Then tab_pos = 1 - tab_pos
	If tab_pos &lt; 0 Then tab_pos = 1
	If tab_pos &gt; 1 Then tab_pos = 0

	;Blink the Cursor
	If MilliSecs()-chatMillisecs &gt; 500

		chatCursor = 1-chatCursor

		chatMillisecs = MilliSecs()

	EndIf

	;Set Chat Text
	Color 0, 0, 0
	Text x3, y3 - tab_ypos, chatMessage + cursor$

End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function NewMessage(msg$)

	messageOffset = messageOffset + 1
	
	If messageOffset &gt; messageDisplayNumber
	
		messageOffset = messageOffset - 1
		
		For i = 2 To messageDisplayNumber
			message(i-1) = message(i)
		Next

		message(messageDisplayNumber) = msg

	Else
	
		message(messageOffset) = msg
	
	EndIf
	
	Return msg

End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function NewLogin(which, msg$)

	messageOffset = messageOffset + 1

	If messageOffset &gt; messageDisplayNumber

		messageOffset = messageOffset - 1
		
		For i = 2 To messageDisplayNumber
			message(i-1) = message(i)
		Next

		message(messageDisplayNumber) = msg

	Else
	
		message(messageOffset) = msg
	
	EndIf
	
	Return msg

End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function DrawMessages()

	Color 255,255,255

	For i = 1 To messageOffset
		loc = Instr (message(i), "",1)
		If loc &gt; 1 Then
			colorMessage$ = Mid$(message(i), 1, Len(message(i)) - 7 )
			Hex$ = Right$(message(i),6)		
			Set_Color_Hex(Hex$)
			Text 0,(i-1)*15,colorMessage$
		Else 
			Color 255,255,255
			Text 0,(i-1)*15,message(i)
		End If
	Next

End Function

Function CreateTextButton.button (Label$,x,y,width,height,id,centered = False)
	b.button = New button

	b\image = CreateImage(width,height,3)

	;normal state of button
	SetBuffer ImageBuffer(b\image,0)
	Color 140,140,140
	Rect 0,0,width,height,1 ;fill
	Color 0,255,0
	Rect 0,0,width,height,0 ;outline
	Color 255,255,255
	Text width*.5,height*.5,label$,1,1

	;hit state of button
	SetBuffer ImageBuffer(b\image,1)
	Color 220,220,220
	Rect 0,0,width,height,1 ;fill
	Color 255,0,0
	Rect 0,0,width,height,0 ;outline
	Color 0,0,0
	Text width*.5,height*.5,label$,1,1

	;Rollover state of button
	SetBuffer ImageBuffer(b\image,2)
	Color 180,180,180
	Rect 0,0,width,height,1 ;fill
	Color 0,255,0
	Rect 0,0,width,height,0 ;outline
	Color 255,255,255
	Text width*.5,height*.5,label$,1,1

	SetBuffer BackBuffer()

	b\x = x
	b\y = y
	b\width = ImageWidth(b\image)
	b\height = ImageHeight(b\image)
	b\id = id
	b\state = 0

	If centered Then b\x = (GraphicsWidth()*.5) - (b\width*.5) ;center on screen vertically

	Return b
End Function

Function CreateImageButton.button (image,x,y,id,centered = False)
	b.button = New button
	b\image = image
	MaskImage b\image,255,0,255 ; mask out pink color
	b\x = x
	b\y = y
	b\width = ImageWidth(image)
	b\height = ImageHeight(image)
	b\id = id
	b\state = 0

	If centered Then b\x = (GraphicsWidth()*.5) - (b\width*.5) ;center on screen vertically

	Return b
End Function

Function updatebuttons()
	For b.button = Each button
		If RectsOverlap(mx,my,1,1,  b\x, b\y, b\width, b\height)
			If MouseDown(1) Then
				b\state = 1 ; button is being held down over button
				buttonheld = 1 
			Else
				b\state = 2 ; mouse is hovering over button with no button down
				If buttonheld = 1	; was the button down last time? If so, mouse has just clicked up.
					ID_clicked = b\id ;this button has been clicked. set to ID of clicked button
					buttonheld = 0	;reset the button down value
				EndIf 					
			EndIf
		Else		; mouse is not over button
			b\state = 0	;normal state of button				
		EndIf
		
		DrawImage b\image,b\x,b\y,b\state ; draw the button to screen
	Next 
End Function

Function ButtonAction()
	;Use this function to take action based on which button has been pressed. Each time you make a button, give it a unique ID.
	;Then add a new case for that ID here.
	Select ID_clicked
		Case 1
			;this button ID has been clicked. Do stuff here
			info$ = "Button A has been clicked"
						
		Case 2
			;this button ID has been clicked. Do stuff here
			info$ = "Button B has been clicked"

		Case 3
			;this button ID has been clicked. Do stuff here
			info$ = "Centered button has been clicked"

		Case 5
			;this button ID has been clicked. Do stuff here
			info$ = "Image button has been pressed"

	End Select

	ID_clicked = -1

End Function
</textarea><br><br>Please note :: When this is done it will have a Username, Password, &amp; Email form followed by a Register / Login interactive button.<br><br>I hope you all like!<br><br>~GF <br><br></td></tr></table><br>
<a name="1290855"></a>

<a name="1291294"></a>

<a name="1291295"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >RGR</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#91">[#91]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> Credits List :: <br><br>~* Guy Fawkes for creating / thinking of this idea <br></div><br>Wow - you are really the biggest thinker ever existed - not one has thought about a login with username and password or even email before ...<br><br>Lets not forget to announce that credits at CNN international and all mayor natworks of the globe ...<br><br><br>You got tired of people being able to use your name as their own?<br>Boy, the original Guy Fawkes would rotate in his grave if he'd knew what an ... is using his name! <br><br></td></tr></table><br>
<a name="1290866"></a>

<a name="1290928"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Guy Fawkes</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#92">[#92]</a></td></tr></table></td></tr><tr ><td class="posttext"> RGR, shut the HELL up, and get the HELL out of our thread! You have NOTHING to contribute but malice towards others &amp; quite frankly, we are all SICK of it! <br><br></td></tr></table><br>
<a name="1290882"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >RemiD</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#93">[#93]</a></td></tr></table></td></tr><tr ><td class="posttext"> Credits for ideas, really ? :P <br><br></td></tr></table><br>
<a name="1290917"></a>

<a name="1290918"></a>

<a name="1290919"></a>

<a name="1290921"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rick Nasher</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#94">[#94]</a></td></tr></table></td></tr><tr ><td class="posttext"> Can I please copyright your last remark/idea RemiD? ;-D<br><br>Ohoh - now I got sucked into it too.  No offence, but wish we all were a little bit less edgy and not so easily provoked though. Guess thread pollution is preferred over ignoring unimportant stuff(the smart thing to do). *guess this proves we're still kinda primal; monkeys with keyboards? Or is it just a p*ssing contest? ;-) No.. no need to reply to these rhetorical questions. I'm just typing out loud.. <br><br>-Peace on planet earth- (yes, I am a hippy) :-P<br><img src="http://images.sodahead.com/polls/001785423/5546771828__40127544_students_203152_answer_2_xlarge.gif"> <br><br></td></tr></table><br>
<a name="1290926"></a>

<a name="1290927"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >RemiD</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#95">[#95]</a></td></tr></table></td></tr><tr ><td class="posttext"> @Rick&gt;&gt;I agree with you, there is no point to create conflict for small unimportant things, but Guy Fawkes demonstrates a level of stupidity rarely seen. This is difficult to resist. :P (know that i  sometimes moderate my posts or don't post to not be banned) <br><br></td></tr></table><br>
<a name="1290931"></a>

<a name="1290932"></a>

<a name="1290933"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Guy Fawkes</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#96">[#96]</a></td></tr></table></td></tr><tr ><td class="posttext"> THIS ENDS HERE! EITHER RGR LEAVES ME &amp; MY FRIENDS ALONE, OR I WILL MAKE AS MANY THREADS AS NECESSARY TO KEEP THIS THREAD ALIVE AND TO STOP HIM FROM TREATING PEOPLE LIKE GARBAGE! That's ALL he god damn does and I'm SICK of it! He has NOTHING to contribute but B.S. &amp; being mean &amp; rude to people! I cannot WAIT until karma comes around and bites you in the ass. Incase you guys hadn't noticed, I was FINE til' someone decided to be rude, completely misguided, &amp; a waste of DNA.<br><br>I DID edit my post a bit, but it's only for the sake of the mods &amp; their rules.<br><br>But RGR DESERVES what he got!<br><br>All I want is to get back on track. But apparently, some minorly intelligent idiots decide to ruin a GOOD THING!<br><br>I WON'T LET THAT HAPPEN!<br><br>Lets get this thread back on track &amp; ignore RGR. <br><br></td></tr></table><br>
<a name="1290952"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Flanker</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#97">[#97]</a></td></tr></table></td></tr><tr ><td class="posttext"> A little video to show the base of the next example for the library : <a href="https://www.youtube.com/watch?v=fLbXhhSIIrA" target="_blank">https://www.youtube.com/watch?v=fLbXhhSIIrA</a><br><br>Just character control for the moment, it's not perfect because models are grabbed on internet and put together but it's quite responsive, it'll be enough. I'll probably add bones collision for bullets hits so hitting the head or the legs won't have the same effect. Then it will be time to add all collisions with the map (thanks stayne), and finally include the network library.<br><br>If someone knows how to animate one animated mesh with two different animations (example run for legs, reload for upper body), I'd like to know, I found nothing interesting in the forums and animating a bone returns an error (in my memory it was as simple...).<br><br>It would be cool if people on internet just don't post for only bashing people. I do it sometimes too, i'm human, but here about Guy Fawkes, I would just say that he helped me a lot testing the network library online with Rick Nasher. <br><br></td></tr></table><br>
<a name="1290955"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Guy Fawkes</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#98">[#98]</a></td></tr></table></td></tr><tr ><td class="posttext"> Sounds great, @Flanker! Thank you Flanker! :)<br><br>Nasher, Flanker, I'm in the chat!<br><br>~GF <br><br></td></tr></table><br>
<a name="1290962"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rick Nasher</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#99">[#99]</a></td></tr></table></td></tr><tr ><td class="posttext"> OWWWW. This is just tooo great. <br><br></td></tr></table><br>
<a name="1290967"></a>

<a name="1291009"></a>

<a name="1291016"></a>

<a name="1291018"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rick Nasher</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#100">[#100]</a></td></tr></table></td></tr><tr ><td class="posttext"> Talking about collisions..<br><br>I've added some simple stuff:<br>-added to initial selection; Enter=defaults.<br>-added spawner plate.<br>-added colored char txt by Raster Ron. <br>-added health upgrade(in progress), collision working, bug: health not upgrading..<br><br><br>Can anybody explain why these functions don't have the desired effect(health upgrade upon collision)?<br><b>Added 2 functions..</b><br><textarea class=codebox name="code" wrap=OFF readonly="true" rows="15" cols="80">

Function CreateHealthItem()

	;p.player = Object.player(GetPlayer(id))

	healthpowerup = CreateCube():EntityColor healthpowerup ,255,0,0	

	healthpowerup1= CopyEntity (healthpowerup)
	ScaleEntity healthpowerup ,.20,.5,.20 : PositionEntity healthpowerup ,-30,.5,-20
	ScaleEntity healthpowerup1,.20,.5,.20:PositionEntity healthpowerup1,-30,.5,-20
	RotateEntity healthpowerup1,90,0,0
	EntityParent healthpowerup1, healthpowerup

	EntityType healthpowerup ,type_healt
	EntityType healthpowerup1 ,type_healt
	EntityRadius healthpowerup,1;,1
	;EntityRadius healthpowerup1,1;,1
	
	PositionEntity healthpowerup ,0,12,0
	
End Function

Function UpdateHealthItem()
	TurnEntity healthpowerup,0,-2,0 
	
	If CountCollisions(healthpowerup)
		
		If localMode = 2 ; only the server computes collision with player
			If GetEntityType(CollisionEntity(healthpowerup,1)) = 2 ; a player collided
				
				touchedPlayer.player = Object.player(EntityName(CollisionEntity(healthpowerup,1)))
				touchedPlayer\life = touchedPlayer\life + 10
				
				If touchedPlayer\life &lt; 100 ; touched healthpowerup..
					Net_SendMessage(5,touchedPlayer\life,touchedPlayer\id)
					Net_SendMessage(5,touchedPlayer\life,touchedPlayer\id,touchedPlayer\id)
					NewMessage( touchedPlayer\name + " healtupgraded! " )
					
				EndIf
				
			EndIf
		EndIf
		
	EndIf

End Function
</textarea><br><img src="http://i64.tinypic.com/90dro0.jpg"><br><b>Perhaps more usefull: the full code..</b><br><textarea class=codebox name="code" wrap=OFF readonly="true" rows="15" cols="80">
; Mods:
; -added to initial selection; Enter=defaults
; -added spawner.
; -added colored char txt by Raster Ron 
; -added health upgrade(in progress), collision working, bug: health not upgrading..



SeedRnd MilliSecs()

Const gameLogicFPS = 60

; hex8 for converting RGB values to "Tri-Hex" string.
Include "Hex8.bb" ;&lt;&lt;&lt; Colored txt mod by Raster Ron 
; first we include the network library
Include "UDPNetwork_lib.bb"

.init
; we will also need to know wich identity the server gives To us :
Global localID

; we will need a nickname :

;Global myName$ = "RCX" ; 
;Print "Default name = " + myName$ ; &lt;&lt;

;Global localName$ = Input("Enter your name(if desired) : ")

;If localName = "" And myName$ = "" Then 
;	localName = "player" + Rand(100,999)
;Else
;	localName$=myName$ 
;EndIf


;&lt;&lt; Enter through mod..
Global localName$ = "", defaultName$ = "RCX" ; Predefined name, so just need To press enter.

Print "Change default name '"+ defaultName$ +"' ?"
Choic$ = Input$("Press [Y]es or [ENTER] for No: ")
If Choic$="y" Then ; so want to change..
	Cls:Locate 0,0
	Print "Type name &amp; press [ENTER] or"
	ChangeName$=Input$("just [ENTER] to autogenerate: ")
	If ChangeName$="" ; so pressed enter to autogen..
		localName = "player" + Rand(100,999)
	Else ; so entered a new name..
		localName$=ChangeName$
	EndIf
Else ; so entered without input.
	localName$ = defaultName$
EndIf
;&lt;&lt; End enter through mod.


Global localPlayerMesh

Type player
	Field id
	Field name$
	Field ping
	
	Field life
	Field kills
	Field deaths
	
	Field mesh
	Field r,g,b,a

	Field nextX#,nextY#,nextZ#
	Field previousX#,previousY#,previousZ#
	Field nextYaw#
	Field previousYaw#
	Field nextTime
	Field previousTime
	
	Field lastPacket
	
	Field currentY#
	Field velocityY#
End Type

Type bullet
	Field mesh
	Field angle#
	Field time
	Field id ; id of player who fired
End Type

Type healthpowerup ;&lt;&lt;&lt;	
	Field mesh
	Field angle#
	Field time
End Type

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
; Camera code from jfk EO-11110, thanks
Global bounce_cam=1 ;  smooth camera motion? (0/1)
Global bounce_div#=10.0 ; the higher, the more sluggish the camera will follow. Recc: 3.0 to 20.0
; some globals used by ChaseCam
Global old_x#,old_y#,old_z#
; desired distance between camera and player mesh
Global x_dis#=7.0,y_dis#=3,z_dis#=7.0,y_dis_or#=y_dis#
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;

; network init ----------------------------------------;


; time to init the network,  
Global localMode = Net_StartInput() ; bring the included library "console" to choose if we host or join a game..

If localMode = 1 Or localMode = 2 ; 1 means we are client, 2 means we are server, 0 means an error occured
	localID = Net_CreatePlayer(localName) ; this command inits the server or local client
	If localID = 0 ; error
		Net_StopNetwork() ; close the network properly
		RuntimeError("Failed to create player.")
	EndIf
	
	If localMode = 1 Then AppTitle("Client : " + localName + " (port:" + net_port + "/ ID=" + localID + ")")
	If localMode = 2 Then AppTitle("Server : " + localName + " (port:" + net_port + "/ ID=" + localID + ")")
	
Else ; error
	Net_StopNetwork() ; close the network properly
	RuntimeError("Failed to start game. Closing..")
EndIf
;------------------------------------------------------;

.beginGame
Graphics3D 640,480,32,2
SetBuffer BackBuffer()

;CreateScene() ;setup entities..

Global camera = CreateCamera()
CameraRange camera,0.1,1000

; create our own local player
localPlayerMesh = CreatePlayer(localID,localName)
old_x = EntityX(localPlayerMesh):old_y = EntityY(localPlayerMesh):old_z = EntityZ(localPlayerMesh) ; update camera position


; we send our color to the server
p.player = Object.player(GetPlayer(localID))
Net_SendMessage(3,p\r + "/" + p\g + "/" + p\b)
; &lt;&lt;&lt; colored txt mod by Raster Ron..
Global cR = p\r 
Global cG = p\g 
Global cB = p\b 
; &lt;&lt;&lt; end colored txt mod by Raster Ron..


; variables used to send our positions at a constant delay (saves bandwidth but makes a constant ping)
Global updatePosition = MilliSecs()
Global updateTick = 50

; chat
Global messageDisplayNumber = 10
Global messageOffset
Dim message$(messageDisplayNumber)

Global chatMode
Global chatMessage$ = localName + "&gt; "
Global chatMillisecs = MilliSecs()
Global chatCursor


;COLLISION GLOBALS..
Global ground, cube, sphere, platform, healthpowerup ,healthpowerup1


;Define Collision type values..
Global type_scene = 1 ; for scenery type entities like ground, obstacles.
Global type_chara = 2 ; for character type entities like players, bots.
Global type_projc = 3 ; for projectile type entities like bulits.
Global type_healt = 4 ; for healt power ups.

;methods - collision detection method..
Global meth_elp_to_elp = 1
Global meth_elp_to_pol = 2
Global meth_elp_to_box = 3

;responses - what the source entity does when a collision occurs..
Global resp_stop= 1 ;  - full stop
Global resp_sli1= 2 ;  - full sliding collision. 
Global resp_sli2= 3 ;  - prevent entities from sliding down slopes.


;DEFINE HOW &amp; WHAT COLLISIONS BETWEEN DIFFERENT TYPES SHOULD RESULT IN..
Collisions type_chara, type_scene ,meth_elp_to_pol  , resp_sli2 ; player to scene
Collisions type_chara, type_chara ,meth_elp_to_elp  , resp_sli2 ; player to player
Collisions type_chara, type_healt ,meth_elp_to_elp  , resp_sli2 ; player to health powerup ;needed?

Collisions type_projc, type_scene ,meth_elp_to_pol  , resp_stop ; bullet to scene
Collisions type_projc, type_chara ,meth_elp_to_elp  , resp_stop ; bullet to player
;Collisions type_healt, type_scene ,meth_elp_to_pol  , resp_sli2 ; health powerup to scene
Collisions type_healt, type_chara ,meth_elp_to_elp  , resp_sli2 ; health powerup to player


CreateScene() ;setup entities..

.mainLoop
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
tweeningPeriod = 1000 / gameLogicFPS
tweeningTime = MilliSecs() - tweeningPeriod
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
While Not KeyHit(1)

	;; I use tweening from castle demo here :
	;;
	;; 		- this allows to have very fast execution outside the tweening loop,
	;; 		  so the network is updated as fast as possible (needs Flip False)
	;;
	;; 		- this makes the game logic updated at a constant rate (Const FPS=)
	;;		  so no need to set deltatime (and it saves CPU time for other things)


	;; -------------------------------------------------------------------------------------------------; FAST EXECUTION (outside of tweening)
	;; -------------------------------------------------------------------------------------------------;
	
	; see the function, the interpolation variables are set properly here
	UpdateNetwork()
		
	;; -------------------------------------------------------------------------------------------------;

	Repeat
		tweeningElapsed = MilliSecs() - tweeningTime
	Until tweeningElapsed
	tweeningTicks = tweeningElapsed / tweeningPeriod
	tweeningRate# = Float(tweeningElapsed Mod tweeningPeriod)/Float(tweeningPeriod)
	For k = 1 To tweeningTicks
		tweeningTime = tweeningTime + tweeningPeriod
		If k = tweeningTicks Then CaptureWorld
		
		;; ---------------------------------------------------------------------------------------------; MAIN UPDATE
		;; ---------------------------------------------------------------------------------------------;
		
		; update our player
		UpdateLocalPlayer()
		
		; the interpolation is made in this function
		UpdatePlayers()
		
		; update the bullets... only the server check for player kills
		UpdateBullets()
		UpdateHealthItem()
		UpdateWorld()
		
		UpdateChaseCam(camera,localPlayerMesh)
		
		;; ---------------------------------------------------------------------------------------------;
		
	Next
	
	RenderWorld tweeningRate

	;; -------------------------------------------------------------------------------------------------; 2D UPDATE
	;; -------------------------------------------------------------------------------------------------;
	
	DrawPlayersNames()
	
	If KeyHit(28) And chatMode = 0 Then chatMode = 1:FlushKeys()
	If chatMode = 1 Then UpdateChat()
	
	DrawMessages()
	
	If KeyDown(15) Then DrawScoreTable()
	
	;; -------------------------------------------------------------------------------------------------;
	
	Flip

Wend
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;

Net_StopNetwork()

End

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function UpdateNetwork()

	; update incoming packets (better check ALL incoming messages so use While Wend)
	While Net_CheckMessage() ; will check for a new message and fill Net_MsgType, Net_MsgString$, Net_MsgFrom and Net_MsgTo variables so we can read it
		
		p.player = Object.player(GetPlayer(Net_MsgFrom)) ; get the player handle

		If Handle(p) = 0 And Net_MsgType &lt; 100 ; we received an update packet from a player we don't know
			; so we ask the server who he is and return because we can't update him for now
			; the server will resend us the info in a new player "100" message
			Net_RequestPlayer(Net_MsgFrom)
			Return
		EndIf
		
		Select Net_MsgType ; check the type of message
						
			Case 1 ; chat message
			
				NewMessage(Net_MsgString)
									
			Case 2 ; player position and angle, example of packing data into string
				
				offset1 = Instr(Net_MsgString,"/",1)
				offset2 = Instr(Net_MsgString,"/",offset1+1)
				offset3 = Instr(Net_MsgString,"/",offset2+1)
								
				p\previousX = p\nextX
				p\previousY = p\nextY
				p\previousZ = p\nextZ
				p\previousYaw = p\nextYaw
				
				p\nextX = Left(Net_MsgString,offset1-1)
				p\nextY = Mid(Net_MsgString,offset1+1,offset2-offset1-1)
				p\nextZ = Mid(Net_MsgString,offset2+1,offset3-offset2-1)
				p\nextYaw = Right(Net_MsgString,Len(Net_MsgString)-offset3)

				p\previousTime = p\nextTime
				p\nextTime = MilliSecs()
							
			Case 3 ; update player colors
						
				offset1 = Instr(Net_MsgString,"/",1)
				offset2 = Instr(Net_MsgString,"/",offset1+1)
							
				p\r = Left(Net_MsgString,offset1-1)
				p\g = Mid(Net_MsgString,offset1+1,offset2-offset1-1)
				p\b = Right(Net_MsgString,Len(Net_MsgString)-offset2)
								
				EntityColor p\mesh,p\r,p\g,p\b
				
			Case 4 ; a player fired
			
				CreateBullet(Net_MsgFrom)
											
			Case 5 ; a player lost some life
			
				p\life = Net_MsgString
			
			Case 6 ; a player killed another one
			
				k.player = Object.player(GetPlayer(Net_MsgString)) ; killed player ID in MsgData
				NewMessage(p\name + " killed " + k\name)
				
				ResetPlayer(k\id)
			
			Case 7 ; the server sends us score update for a player
			
				offset = Instr(Net_MsgString,"/",1)
				
				p\kills = Left(Net_MsgString,offset-1)
				p\deaths = Right(Net_MsgString,Len(Net_MsgString)-offset)
						
			Case 100 ; new player connected, OR the server tells us who is already connected so we can create players when joining the game
							
				If localMode = 2
					For p.player = Each player
						Net_SendMessage(2,p\nextX + "/" + p\nextY + "/" + p\nextZ + "/" + p\nextYaw,p\id,Net_MsgFrom)
						Net_SendMessage(3,p\r + "/" + p\g + "/" + p\b,p\id,Net_MsgFrom)
						
						Net_SendMessage(5,p\life,p\id,Net_MsgFrom)
						Net_SendMessage(7,p\kills+"/"+p\deaths,p\id,Net_MsgFrom)
					Next
				EndIf
				
				NewMessage(Net_MsgString + " connected")
				CreatePlayer(Net_MsgFrom,Net_MsgString)
				
			Case 101 ; a player has quit
						
				For p.player = Each player
					If Net_MsgFrom = p\id
						NewMessage(p\name + " disconnected")
						FreeEntity p\mesh
						Delete p
					EndIf
				Next
							
			Case 102 ; host has changed
			
				For p.player = Each player
					If Net_MsgFrom = p\id
						If p\id = localID
							AppTitle("Server : " + localName + " (port:" + net_port + ")")
							NewMessage("You are the new host")
							localMode = 2
						Else
							NewMessage(p\name + " is the new host")
						EndIf					
					EndIf
				Next
			
			Case 103 ; ping update
			
				For p.player = Each player
					If Net_MsgFrom = p\id
						p\ping = Net_MsgString
					EndIf
				Next

		End Select

	Wend

End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function UpdateLocalPlayer()

	; update our player
	p.player = Object.player(GetPlayer(localID)) ; get our player

	; inputs
	If KeyDown(200) Then MoveEntity p\mesh,0,0,0.3
	If KeyDown(208) Then MoveEntity p\mesh,0,0,-0.3
	If KeyDown(203) Then TurnEntity p\mesh,0,3,0
	If KeyDown(205) Then TurnEntity p\mesh,0,-3,0
		
	; fire
	If MouseHit(1)
		Net_SendMessage(4,"")
		CreateBullet(localID)
	EndIf
	
	; jump
	If MouseHit(2)
		; check if player is one the ground
		LinePick(EntityX(p\mesh),EntityY(p\mesh),EntityZ(p\mesh),0,-1.2,0)
		If PickedEntity()
			p\velocityY = 0.5 ; set "inverse" of gravity velocity
		EndIf	
	EndIf
	
	; we create a message type "2" for player position
	If MilliSecs()-updatePosition &gt; updateTick
	
		Net_SendMessage(2,EntityX(p\mesh) + "/" + EntityY(p\mesh) + "/" + EntityZ(p\mesh) + "/" + EntityYaw(p\mesh))
		updatePosition = MilliSecs()
	EndIf
	
End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function UpdatePlayers()

	For p.player = Each player
				
		If p\id &lt;&gt; localID ; update other players only
						
			;; LINEAR INTERPOLATION ;;;;;;;;;;
			
			If p\nextTime &lt;&gt; p\previousTime ; if both packets arrived at the same time, we can't interpolate
				
				curTime# = Float(MilliSecs()-p\nextTime) / Float(p\nextTime-p\previousTime) ; curTime will be ideally 0.0-1.0, if it's &gt; 1.0 then it performs extrapolation
				
				If curTime &gt; 1 Then curTime = 1 ; extrapolation gives anoying jittering effects
				
				; special fix for yaw as EntityYaw returns a value beetween +180 ans -180, the interpolation can go backward
				If p\previousYaw &lt; 0 Then p\previousYaw = p\previousYaw + 360
				If p\nextYaw &lt; 0 Then p\nextYaw = p\nextYaw + 360
				If Abs(p\nextYaw-p\previousYaw) &gt; 180
					If p\nextYaw &gt; p\previousYaw
						p\previousYaw = p\previousYaw + 360
					Else
						p\previousYaw = p\previousYaw - 360
					EndIf
				EndIf
				
				PositionEntity p\mesh,p\previousX+(p\nextX-p\previousX)*curTime,p\previousY+(p\nextY-p\previousY)*curTime,p\previousZ+(p\nextZ-p\previousZ)*curTime
				RotateEntity p\mesh,0,p\previousYaw+(p\nextYaw-p\previousYaw)*curTime,0
				
			Else
			
				PositionEntity p\mesh,p\nextX,p\nextY,p\nextZ
				RotateEntity p\mesh,0,p\nextYaw,0
			
			EndIf
			;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
						
			ResetEntity p\mesh ; reset entity is useful here because of collisions

		Else ; update our player, basically it just compute gravity
		
			p\velocityY = p\velocityY - 0.03 ; fake gravity
			If EntityY(p\mesh) - p\currentY &gt;= 0 ; if player is not falling we limit the gravity
				If p\velocityY &lt; -0.03 Then p\velocityY = -0.03
			EndIf
		
			p\currentY = EntityY(p\mesh)
			TranslateEntity p\mesh,0,p\velocityY,0
						
		EndIf
	Next

End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function CreatePlayer(id,name$)

	For p.player = Each player
		If p\id = id Then Return ; player already connected
	Next

	p.player = New player
	p\id = id
	p\name = name
	
	p\life = 60
	
	p\mesh = CreateSphere()
	EntityType p\mesh,2
	EntityRadius p\mesh,1
	
	NameEntity p\mesh,Handle(p)
	
	nose = CreateSphere(8,p\mesh):EntityColor nose,255,0,0
	PositionEntity nose,0,0,1
	ScaleEntity nose,0.3,0.3,0.3
	
	eyeLeft = CreateSphere(8,p\mesh):EntityColor eyeLeft,255,255,255
	PositionEntity eyeLeft ,.29,.4,.7;1
	ScaleEntity eyeLeft ,0.2,0.2,0.2
	
	pupilLeft = CreateSphere(8,p\mesh):EntityColor pupilLeft ,0,0,0
	PositionEntity pupilLeft ,.3,.4,.9;1
	ScaleEntity pupilLeft ,0.05,0.05,0.02
	
	eyeRight = CreateSphere(8,p\mesh):EntityColor eyeRight ,255,255,255
	PositionEntity eyeRight ,-.29,.4,.7;1
	ScaleEntity eyeRight ,0.2,0.2,0.2
		
	pupilRight = CreateSphere(8,p\mesh):EntityColor pupilRight ,0,0,0
	PositionEntity pupilRight ,-.3,.4,.9;1
	ScaleEntity pupilRight ,0.05,0.05,0.02

	unaBrow = CreateCone(8,1,p\mesh):EntityColor unaBrow ,0,0,0
	PositionEntity unaBrow ,0,.45,.7
	RotateEntity unaBrow ,-180,0,0
	ScaleEntity unaBrow ,.7,.2,.3
	
	p\nextX = -20
	p\nextY = 1
	p\nextZ = -20
	p\nextYaw = -45
	
	p\previousX = p\nextX
	p\previousY = p\nextY
	p\previousZ = p\nextZ
	p\previousYaw = p\nextYaw
	
	p\r = Rand(255)
	p\g = Rand(255)
	p\b = Rand(255)
	EntityColor p\mesh,p\r,p\g,p\b
	EntityAlpha p\mesh,1
		
	
	PositionEntity p\mesh,p\nextX,p\nextY,p\nextZ
	RotateEntity p\mesh,0,p\nextYaw,0
	ResetEntity p\mesh
	
	p\currentY = p\nextY
	
	p\previousTime = MilliSecs()
	p\nextTime = MilliSecs()+1
	
	Return p\mesh

End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function ResetPlayer(id)

	p.player = Object.player(GetPlayer(id))

	p\life = 100

	p\nextX = -20
	p\nextY = 1
	p\nextZ = -20
	p\nextYaw = -45

	p\previousX = p\nextX
	p\previousY = p\nextY
	p\previousZ = p\nextZ
	p\previousYaw = p\nextYaw

	PositionEntity p\mesh,p\nextX,p\nextY,p\nextZ
	RotateEntity p\mesh,0,p\nextYaw,0
	ResetEntity p\mesh
	
	p\currentY = p\nextY
	
	p\previousTime = MilliSecs()
	p\nextTime = MilliSecs()+1

End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function GetPlayer(id)

	For p.player = Each player
		If p\id = id
			Return Handle(p)					
		EndIf
	Next
	
End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function DrawPlayersNames()

	For p.player = Each player
	
		Color 255,255,255
		CameraProject(camera,EntityX(p\mesh),EntityY(p\mesh),EntityZ(p\mesh)) 			
		If p\id &lt;&gt; localID Then Text ProjectedX(),ProjectedY()-60,p\name,1,1
		
		Color 255,(255./100.)*p\life,(255./100.)*p\life
		Text ProjectedX(),ProjectedY()-40,p\life,1,1

	Next
	
End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function CreateBullet(id)

	p.player = Object.player(GetPlayer(id))

	b.bullet = New bullet
	
	b\id = p\id
	
	b\mesh = CreateSphere(2)
	ScaleEntity b\mesh,0.2,0.2,0.2
	EntityColor b\mesh,255,0,0

	PositionEntity b\mesh,EntityX(p\mesh),EntityY(p\mesh),EntityZ(p\mesh)
	RotateEntity b\mesh,0,EntityYaw(p\mesh),0
	
	EntityType b\mesh,3
	EntityRadius b\mesh,0.2
		
	b\time = MilliSecs()

End Function

Function CreateHealthItem()

	;p.player = Object.player(GetPlayer(id))

	healthpowerup = CreateCube():EntityColor healthpowerup ,255,0,0	

	healthpowerup1= CopyEntity (healthpowerup)
	ScaleEntity healthpowerup ,.20,.5,.20 : PositionEntity healthpowerup ,-30,.5,-20
	ScaleEntity healthpowerup1,.20,.5,.20:PositionEntity healthpowerup1,-30,.5,-20
	RotateEntity healthpowerup1,90,0,0
	EntityParent healthpowerup1, healthpowerup

	EntityType healthpowerup ,type_healt
	EntityType healthpowerup1 ,type_healt
	EntityRadius healthpowerup,1;,1
	;EntityRadius healthpowerup1,1;,1
	
	PositionEntity healthpowerup ,0,12,0
	
End Function

Function UpdateHealthItem()
	TurnEntity healthpowerup,0,-2,0 
	
	If CountCollisions(healthpowerup)
		
		If localMode = 2 ; only the server computes collision with player
			If GetEntityType(CollisionEntity(healthpowerup,1)) = 2 ; a player collided
				
				touchedPlayer.player = Object.player(EntityName(CollisionEntity(healthpowerup,1)))
				touchedPlayer\life = touchedPlayer\life + 10
				
				If touchedPlayer\life &lt; 100 ; touched healthpowerup..
					Net_SendMessage(5,touchedPlayer\life,touchedPlayer\id)
					Net_SendMessage(5,touchedPlayer\life,touchedPlayer\id,touchedPlayer\id)
					NewMessage( touchedPlayer\name + " healtupgraded! " )
					
				EndIf
				
			EndIf
		EndIf
		
	EndIf

End Function


;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function UpdateBullets()

	For b.bullet = Each bullet
	
		MoveEntity b\mesh,0,0,1
		
		If CountCollisions(b\mesh)
		
			If localMode = 2 ; only the server compute bullets collision with player
				If GetEntityType(CollisionEntity(b\mesh,1)) = 2 ; a player is hit
				
					touchedPlayer.player = Object.player(EntityName(CollisionEntity(b\mesh,1)))
					touchedPlayer\life = touchedPlayer\life - 10 ; decrease life with 10 units
					
					If touchedPlayer\life &gt; 0 ; touched
						Net_SendMessage(5,touchedPlayer\life,touchedPlayer\id)
						Net_SendMessage(5,touchedPlayer\life,touchedPlayer\id,touchedPlayer\id)
					Else ; killed
						killerPlayer.player = Object.player(GetPlayer(b\id))
						
						killerPlayer\kills = killerPlayer\kills + 1
						touchedPlayer\deaths = touchedPlayer\deaths + 1						
						
						Net_SendMessage(6,touchedPlayer\id,killerPlayer\id)
						Net_SendMessage(6,touchedPlayer\id,killerPlayer\id,killerPlayer\id)
												
						Net_SendMessage(7,killerPlayer\kills+"/"+killerPlayer\deaths,killerPlayer\id)
						Net_SendMessage(7,killerPlayer\kills+"/"+killerPlayer\deaths,killerPlayer\id,killerPlayer\id)
						
						Net_SendMessage(7,touchedPlayer\kills+"/"+touchedPlayer\deaths,touchedPlayer\id)
						Net_SendMessage(7,touchedPlayer\kills+"/"+touchedPlayer\deaths,touchedPlayer\id,touchedPlayer\id)
						
						NewMessage(killerPlayer\name + " killed " + touchedPlayer\name)
						ResetPlayer(touchedPlayer\id)
					EndIf
				
				EndIf
			EndIf
			
			FreeEntity b\mesh
			Delete b
			
		ElseIf MilliSecs()-b\time &gt; 2000
		
			FreeEntity b\mesh
			Delete b
			
		EndIf
	
	Next

End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function NewMessage(msg$)

	messageOffset = messageOffset + 1
	
	If messageOffset &gt; messageDisplayNumber
	
		messageOffset = messageOffset - 1
		
		For i = 2 To messageDisplayNumber
			message(i-1) = message(i)		
		Next
		
		message(messageDisplayNumber) = msg
	
	Else
	
		message(messageOffset) = msg
	
	EndIf

End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function DrawMessages()

	Color 255,255,255

	For i = 1 To messageOffset
		
		;Text 0,(i-1)*15,message(i)	
		
		; &lt;&lt;&lt; colored txt mod by Raster Ron
		loc = Instr (message(i), "",1)
		;Text 0,(i-1)*15,message(i)		
		If loc &gt; 1 Then 
			colorMessage$ = Mid$(message(i), 1, Len(message(i)) - 7 ) 
			Hex$ = Right$(message(i),6)		 
			Set_Color_Hex(Hex$) 
			Text 0,(i-1)*15,colorMessage$ 
		Else  
			Color 255,255,255 
			Text 0,(i-1)*15,message(i) 
		End If	
		; &lt;&lt;&lt; End colored txt mod by Raster Ron
	Next

End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function UpdateChat()

	key = GetKey()

	If key
		If key = 13
			If chatMessage &lt;&gt; localName + "&gt; "
				For i = Len(localName + "&gt; ") To Len(chatMessage)
					If Mid(chatMessage,i,1) &lt;&gt; " "
						
						; &lt;&lt;&lt; colored txt mod by Raster Ron
						chatColor$ = RGB_To_TriHex(cR,cG,cB)
						chatMessage = chatMessage + "" + chatColor$
						; &lt;&lt;&lt; end colored txt mod by Raster Ron
						
						Net_SendMessage(1,chatMessage)
						NewMessage(chatMessage)
						Exit
					EndIf
				Next
			EndIf
			chatMessage = localName + "&gt; "
			chatMode = 0
		ElseIf key = 8 And Len(chatMessage) &gt; Len ( localName + "&gt; " )
			chatMessage = Left(chatMessage,Len(chatMessage)-1)
		ElseIf key &gt; 31 And key &lt; 127
			chatMessage = chatMessage + Chr(key)
		EndIf
	EndIf
	
	Color 255,255,255
	Rect 0,GraphicsHeight()-20,GraphicsWidth(),20,1
	
	Color 0,0,0
	Rect 0,GraphicsHeight()-20,GraphicsWidth(),20,0
	
	
	If MilliSecs()-chatMillisecs &gt; 500
		chatCursor = Not chatCursor
		chatMillisecs = MilliSecs()
	EndIf
	
	If chatCursor
		Text 5,GraphicsHeight()-17,chatMessage + "|"
	Else
		Text 5,GraphicsHeight()-17,chatMessage
	EndIf

End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function DrawScoreTable()

	For p.player = Each player
		count = count + 1
	Next
	
	baseX = (GraphicsWidth()-350)/2
	baseY = (GraphicsHeight()-(35+20*count))/2

	Color 0,0,0
	Rect baseX,baseY,350,35+20*count,1

	Color 255,192,0
	Rect baseX,baseY,350,35+20*count,0

	Text baseX+10,baseY+10,"Player          Kills     Deaths     Ping"
	Line baseX,baseY+25,baseX+349,baseY+25

	For p.player = Each player
	
		Color 255,255,255
		If p\id = localID Then Color 255,100,100
	
		i = i + 1
		Text baseX+10,baseY+10+20*i,p\name
		Text baseX+157,baseY+10+20*i,p\kills,1,0
		Text baseX+240,baseY+10+20*i,p\deaths,1,0
		Text baseX+322,baseY+10+20*i,p\ping,1,0
	Next

End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function UpdateChaseCam(camera,player) ; thanks to jfk EO-11110 on bb forums for this function !
	PositionEntity camera,EntityX(player,1),EntityY(player,1),EntityZ(player,1)
	ResetEntity camera
	x#=EntityX(player)+Sin(-EntityYaw(player)+180)*x_dis#
	y#=EntityY(player)+y_dis#
	z#=EntityZ(player)+Cos(-EntityYaw(player)+180)*z_dis#
	obstacle=LinePick(EntityX(player),EntityY(player),EntityZ(player),(x-EntityX(player)),y_dis#,(z-EntityZ(player)),0.1)
	If obstacle=0
		new_x#=x
		new_y#=y
		new_z#=z
	Else
		new_x#=PickedX()
		new_y#=PickedY()
		new_z#=PickedZ()
	EndIf
	If bounce_cam=0
		PositionEntity camera,new_x,new_y,new_z
	Else
		x=old_x+((New_x-old_x)/bounce_div#)
		y=old_y+((New_y-old_y)/bounce_div#)
		z=old_z+((New_z-old_z)/bounce_div#)
		PositionEntity camera,x,y,z
	EndIf
	PointEntity camera,player
	TurnEntity camera,-20,0,0     ; if you want the player mesh more on the bottom of the screen
	old_x#=EntityX(camera)
	old_y#=EntityY(camera)
	old_z#=EntityZ(camera)
End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function CreateScene()
	
	; setup light..
	light = CreateLight()
	TurnEntity light,30,70,0
	
	
	texture = TextureCreate(128)
	
	; scenery entities..
	ground = CreatePlane()
	EntityColor ground,150,150,150
	EntityTexture ground,texture
	
	cube = CreateCube():EntityColor cube,150,200,150
	ScaleEntity cube,5,5,5:PositionEntity cube,0,5,0
	EntityTexture cube,texture
	
	sphere = CreateSphere(16):EntityColor sphere,200,150,150
	ScaleEntity sphere,3,1,3:PositionEntity sphere,0,9.7,0
	
	platform = CreateCube():EntityColor platform,150,150,200
	ScaleEntity platform,3,1,10:PositionEntity platform,0,4.13,-13.15
	TurnEntity platform,-30,0,0
	EntityTexture platform,texture
	
	FreeTexture texture ; no longer needed, so clean up.
	
	
	; special entities..
	
	; spawnpoint marker.
	spawner1 = CreateSphere():EntityColor spawner1 ,255,255,255      ;&lt;&lt;&lt;&lt;
	ScaleEntity spawner1 ,1,.1,1:PositionEntity spawner1 ,-20,.1,-20 ;&lt;&lt;&lt;&lt;

	; create health upgrade item.
	CreateHealthItem() 
	
	
	;----------------------
	
	
	; define entity types for collisions &amp; entity pickmode for line picking etc.
	;		   Entity    ,Collision_type  ;                entity    ,pick geometry   
;	EntityType ground    	,type_scene      : EntityPickMode ground    ,2
;	EntityType cube      	,type_scene      : EntityPickMode cube      ,2
;	EntityType sphere    	,type_scene      : EntityPickMode sphere    ,2
;	EntityType platform  	,type_scene      : EntityPickMode platform  ,2
;	EntityType spawner1  	,type_scene      : EntityPickMode spawner1  ,2
;	EntityType healthpowerup,type_healt      : EntityPickMode healthpowerup ,2
;   EntityType player       ,type_chara      : ; defined in CreatePlayer()
;   EntityType bullet       ,type_bulit      : ; defined in CreateBullit()	
	
   ;Collisions   src_type, dest_type, meth, resp 
;	Collisions          2,         1,    2,    3 ; player to scene
;	Collisions          2,         2,    1,    3 ; player to player
;	Collisions          3,         1,    2,    1 ; bullet to scene
;	Collisions          3,         2,    1,    1 ; bullet to player
	
	
;=========================================================	
	; define entity types for collisions &amp; entity pickmode for line picking etc.
	EntityType ground,type_scene   : EntityPickMode ground,2
	EntityType cube,type_scene: EntityPickMode cube,2
	EntityType sphere,type_scene: EntityPickMode sphere,2
	EntityType platform,type_scene : EntityPickMode platform,2
	
	
End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function TextureCreate(size)
	texture = CreateTexture(size,size,9)
	SetBuffer TextureBuffer(texture)
	Color 255,255,255
	Rect 0,0,size,size,1
	Color 0,0,0
	Rect 0,0,size,size,0
	Line 0,0,size,size
	Line 0,size,size,0
	SetBuffer BackBuffer()
	Return texture
End Function
</textarea> <br><br></td></tr></table><br>
<a name="1290970"></a>

<a name="1290994"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >RemiD</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#101">[#101]</a></td></tr></table></td></tr><tr ><td class="posttext"> . <br><br></td></tr></table><br>
<a name="1290971"></a>

<a name="1290972"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >RemiD</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#102">[#102]</a></td></tr></table></td></tr><tr ><td class="posttext"> Oh, even easier, and Rick probably has the files, since it is a test project not for commercial use, you can probably use the characters meshes from the old blitz3d project with the top down view "Alien Breed" if i remember correctly. <br><br></td></tr></table><br>
<a name="1290977"></a>

<a name="1290984"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rick Nasher</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#103">[#103]</a></td></tr></table></td></tr><tr ><td class="posttext"> Ah that one. I think I have the Alien model somewhere indeed. Don't have the new code from Flanker yet though, he just showed a preview on youtube.<br><br>The idea is to create 2 versions. 1 more basic with in code gfx without media for the code archives and a more full blown example with media, which we are probably going to tweak forever until it's the ultimate blitz3d multiplayer example and the forum menbers can use to play against each other . :-) <br><br></td></tr></table><br>
<a name="1290989"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >RemiD</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#104">[#104]</a></td></tr></table></td></tr><tr ><td class="posttext"> I have them here, they have only 5 animations per character :<br>upidleholdweapon<br>upidleshoot<br>upmoveforwardholdweapon<br>upmoveforwardshoot<br>upfallonground <br><br></td></tr></table><br>
<a name="1290996"></a>

<a name="1290997"></a>

<a name="1291000"></a>

<a name="1291001"></a>

<a name="1291010"></a>

<a name="1291011"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rick Nasher</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#105">[#105]</a></td></tr></table></td></tr><tr ><td class="posttext"> @RemiD: <br>Are these are the ones you mean, from the AlienBreed3D demo I have here:<br><img src="http://i65.tinypic.com/bf29w1.jpg"><br><img src="http://i67.tinypic.com/23sap77.jpg"><br>Animated b3d's.<br>Shame the sourcecode isn't included.. <br><br></td></tr></table><br>
<a name="1291015"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Flanker</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#106">[#106]</a></td></tr></table></td></tr><tr ><td class="posttext"> @Rick Nasher<br>You don't use your type for the health in your functions. To create the health you must write something like h.healthpowerup = New healthpowerup, h\mesh = CreateCube(). Then in update health you have to parse all health so For h.healthpowerup = Each healthpowerup and check collisions on h\mesh.<br><br>@RemiD I saw your work on animations, it's pretty neat. Here I have all the animations I want because the model is ripped from counter-strike. But the problem is, for example i'm running, then I reload my weapon, but I can't animate only the upper body by applying the animation on a bone. I though it was possible to animate a bone and its children with a specific animation sequence in Blitz3D, but it seems it's not the case natively... :(<br><br>Anyway, if you want the model, tell me what format you would prefer. I have the .ms3d from milkshape, fragmotion should be able to import it properly. <br><br></td></tr></table><br>
<a name="1291017"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rick Nasher</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#107">[#107]</a></td></tr></table></td></tr><tr ><td class="posttext"> @Flanker<br>I know. I first was trying with only 1 entity so could see how goes using just 1, for keeping it simple as possible. But shouldn't it work without this type too?<br>I'm a bit confused for I've used collision code before(on types and single entities), but been a long time and I can't see why it wouldn't work without a type..<br>. <br><br></td></tr></table><br>
<a name="1291019"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Flanker</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#108">[#108]</a></td></tr></table></td></tr><tr ><td class="posttext"> Then I guess you have to replace your Type healthpowerup at the top with a Global healthpowerup and it should work for the server. <br><br></td></tr></table><br>
<a name="1291020"></a>

<a name="1291021"></a>

<a name="1291022"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rick Nasher</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#109">[#109]</a></td></tr></table></td></tr><tr ><td class="posttext"> Nogo just yet. Dunno, I must be missing something. Probably someth silly. Anyway, bedtime. Tomorrow's another day. <br><br></td></tr></table><br>
<a name="1291023"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Flanker</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#110">[#110]</a></td></tr></table></td></tr><tr ><td class="posttext"> There isn't all the things you added but here it is for the health :<br><textarea class=codebox name="code" wrap=OFF readonly="true" rows="15" cols="80">SeedRnd MilliSecs()

Const gameLogicFPS = 60

Include "UDPNetwork_lib.bb"

Global localID
Global localName$ = Input("Enter your name : ")
If localName = "" Then localName = "player" + Rand(100,999)

Global localPlayerMesh

Type player
	Field id
	Field name$
	Field ping
	
	Field life
	Field kills
	Field deaths
	
	Field mesh
	Field r,g,b

	Field nextX#,nextY#,nextZ#
	Field previousX#,previousY#,previousZ#
	Field nextYaw#
	Field previousYaw#
	Field nextTime
	Field previousTime
	
	Field lastPacket
	
	Field currentY#
	Field velocityY#
End Type

Type bullet
	Field mesh
	Field angle#
	Field time
	Field id ; id of player who fired
End Type

Type health
	Field mesh
	Field pickupTime
	Field respawnDelay
End Type

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
; Camera code from jfk EO-11110, thanks
Global bounce_cam=1 ;  smooth camera motion? (0/1)
Global bounce_div#=10.0 ; the higher, the more sluggish the camera will follow. Recc: 3.0 to 20.0
; some globals used by ChaseCam
Global old_x#,old_y#,old_z#
; desired distance between camera and player mesh
Global x_dis#=7.0,y_dis#=3,z_dis#=7.0,y_dis_or#=y_dis#
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;

; network init ----------------------------------------;
Global localMode = Net_StartInput() ; bring the library "console" to connect

If localMode = 1 Or localMode = 2 ; 1 means we are client, 2 means we are server
	
	localId = Net_CreatePlayer(localName) ; this command inits the server or local client
	
	If localId = 0 ; error
		Net_StopNetwork() ; close the network properly
		RuntimeError("Failed to create player.")
	EndIf
	
	If localMode = 1 Then AppTitle("Client : " + localName + " (port:" + net_port + "/ ID=" + localID + ")")
	If localMode = 2 Then AppTitle("Server : " + localName + " (port:" + net_port + "/ ID=" + localID + ")")
	
Else ; error
	Net_StopNetwork()
	RuntimeError("Failed to start game.")
EndIf
;------------------------------------------------------;

Graphics3D 640,480,32,2
SetBuffer BackBuffer()

CreateScene()

Global camera = CreateCamera()
CameraRange camera,0.1,1000

; create our own local player
localPlayerMesh = CreatePlayer(localID,localName)
old_x = EntityX(localPlayerMesh):old_y = EntityY(localPlayerMesh):old_z = EntityZ(localPlayerMesh) ; update camera position

; we send our color to the server
p.player = Object.player(GetPlayer(localID))
Net_SendMessage(3,p\r + "/" + p\g + "/" + p\b)

; variables used to send our positions at a constant delay (saves bandwidth but makes a constant ping)
Global updatePosition = MilliSecs()
Global updateTick = 50

; chat
Global messageDisplayNumber = 10
Global messageOffset
Dim message$(messageDisplayNumber)

Global chatMode
Global chatMessage$ = localName + "&gt; "
Global chatMillisecs = MilliSecs()
Global chatCursor

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
tweeningPeriod = 1000 / gameLogicFPS
tweeningTime = MilliSecs() - tweeningPeriod
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
While Not KeyHit(1)

	;; I use tweening from castle demo here :
	;;
	;; 		- this allows to have very fast execution outside the tweening loop,
	;; 		  so the network is updated as fast as possible (needs Flip False)
	;;
	;; 		- this makes the game logic updated at a constant rate (Const FPS=)
	;;		  so no need to set deltatime (and it saves CPU time for other things)


	;; -------------------------------------------------------------------------------------------------; FAST EXECUTION (outside of tweening)
	;; -------------------------------------------------------------------------------------------------;
	
	; see the function, the interpolation variables are set properly here
	UpdateNetwork()
		
	;; -------------------------------------------------------------------------------------------------;

	Repeat
		tweeningElapsed = MilliSecs() - tweeningTime
	Until tweeningElapsed
	tweeningTicks = tweeningElapsed / tweeningPeriod
	tweeningRate# = Float(tweeningElapsed Mod tweeningPeriod)/Float(tweeningPeriod)
	For k = 1 To tweeningTicks
		tweeningTime = tweeningTime + tweeningPeriod
		If k = tweeningTicks Then CaptureWorld
		
		;; ---------------------------------------------------------------------------------------------; MAIN UPDATE
		;; ---------------------------------------------------------------------------------------------;
		
		; update our player
		UpdateLocalPlayer()
		
		; the interpolation is made in this function
		UpdatePlayers()
				
		UpdateWorld()
		
		; update the bullets... only the server check for player kills
		UpdateBullets()
		
		UpdateHealthItems()
		
		UpdateChaseCam(camera,localPlayerMesh)
		
		;; ---------------------------------------------------------------------------------------------;
		
	Next
	
	RenderWorld tweeningRate

	;; -------------------------------------------------------------------------------------------------; 2D UPDATE
	;; -------------------------------------------------------------------------------------------------;
	
	DrawPlayersNames()
	
	If KeyHit(28) And chatMode = 0 Then chatMode = 1:FlushKeys()
	If chatMode = 1 Then UpdateChat()
	
	DrawMessages()
	
	If KeyDown(15) Then DrawScoreTable()
	
	;; -------------------------------------------------------------------------------------------------;
	
	Flip

Wend
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;

Net_StopNetwork()

End

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function UpdateNetwork()

	; update incoming packets (better check ALL incoming messages so use While Wend)
	While Net_CheckMessage() ; will check for a new message and fill Net_MsgType, Net_MsgString$, Net_MsgFrom and Net_MsgTo variables so we can read it
		
		p.player = Object.player(GetPlayer(Net_MsgFrom)) ; get the player handle

		If Handle(p) = 0 And Net_MsgType &lt; 100 ; we received an update packet from a player we don't know
			; so we ask the server who he is and return because we can't update him for now
			; the server will resend us the info in a new player "100" message
			Net_RequestPlayer(Net_MsgFrom)
			Return
		EndIf
		
		Select Net_MsgType ; check the type of message
						
			Case 1 ; chat message
			
				NewMessage(Net_MsgString)
									
			Case 2 ; player position and angle, example of packing data into string
				
				offset1 = Instr(Net_MsgString,"/",1)
				offset2 = Instr(Net_MsgString,"/",offset1+1)
				offset3 = Instr(Net_MsgString,"/",offset2+1)
								
				p\previousX = p\nextX
				p\previousY = p\nextY
				p\previousZ = p\nextZ
				p\previousYaw = p\nextYaw
				
				p\nextX = Left(Net_MsgString,offset1-1)
				p\nextY = Mid(Net_MsgString,offset1+1,offset2-offset1-1)
				p\nextZ = Mid(Net_MsgString,offset2+1,offset3-offset2-1)
				p\nextYaw = Right(Net_MsgString,Len(Net_MsgString)-offset3)

				p\previousTime = p\nextTime
				p\nextTime = MilliSecs()
							
			Case 3 ; update player colors
						
				offset1 = Instr(Net_MsgString,"/",1)
				offset2 = Instr(Net_MsgString,"/",offset1+1)
							
				p\r = Left(Net_MsgString,offset1-1)
				p\g = Mid(Net_MsgString,offset1+1,offset2-offset1-1)
				p\b = Right(Net_MsgString,Len(Net_MsgString)-offset2)
								
				EntityColor p\mesh,p\r,p\g,p\b
				
			Case 4 ; a player fired
			
				CreateBullet(Net_MsgFrom)
							
			Case 5 ; a player lost some life
			
				p\life = Net_MsgString
			
			Case 6 ; a player killed another one
			
				k.player = Object.player(GetPlayer(Net_MsgString)) ; killed player ID in MsgData
				NewMessage(p\name + " killed " + k\name)
				
				ResetPlayer(k\id)
			
			Case 7 ; the server sends us score update for a player
			
				offset = Instr(Net_MsgString,"/",1)
				
				p\kills = Left(Net_MsgString,offset-1)
				p\deaths = Right(Net_MsgString,Len(Net_MsgString)-offset)
			
			Case 8 ; health pickup
			
				h.health = Object.health(Net_MsgString)
				HideEntity h\mesh
				h\pickupTime = MilliSecs()
						
			Case 100 ; new player connected, OR the server tells us who is already connected so we can create players when joining the game
							
				If localMode = 2
					For p.player = Each player
						Net_SendMessage(2,p\nextX + "/" + p\nextY + "/" + p\nextZ + "/" + p\nextYaw,p\id,Net_MsgFrom)
						Net_SendMessage(3,p\r + "/" + p\g + "/" + p\b,p\id,Net_MsgFrom)
						
						Net_SendMessage(5,p\life,p\id,Net_MsgFrom)
						Net_SendMessage(7,p\kills+"/"+p\deaths,p\id,Net_MsgFrom)
					Next
				EndIf
				
				NewMessage(Net_MsgString + " connected")
				CreatePlayer(Net_MsgFrom,Net_MsgString)
				
			Case 101 ; a player has quit
						
				For p.player = Each player
					If Net_MsgFrom = p\id
						NewMessage(p\name + " disconnected")
						FreeEntity p\mesh
						Delete p
					EndIf
				Next
							
			Case 102 ; host has changed
			
				For p.player = Each player
					If Net_MsgFrom = p\id
						If p\id = localID
							AppTitle("Server : " + localName + " (port:" + net_port + ")")
							NewMessage("You are the new host")
							localMode = 2
						Else
							NewMessage(p\name + " is the new host")
						EndIf					
					EndIf
				Next
			
			Case 103 ; ping update
			
				For p.player = Each player
					If Net_MsgFrom = p\id
						p\ping = Net_MsgString
					EndIf
				Next

		End Select

	Wend

End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function UpdateLocalPlayer()

	; update our player
	p.player = Object.player(GetPlayer(localID)) ; get our player

	; inputs
	If KeyDown(200) Then MoveEntity p\mesh,0,0,0.3
	If KeyDown(208) Then MoveEntity p\mesh,0,0,-0.3
	If KeyDown(203) Then TurnEntity p\mesh,0,3,0
	If KeyDown(205) Then TurnEntity p\mesh,0,-3,0
		
	; fire
	If MouseHit(1)
		Net_SendMessage(4,"")
		CreateBullet(localID)
	EndIf
	
	; jump
	If MouseHit(2)
		; check if player is one the ground
		LinePick(EntityX(p\mesh),EntityY(p\mesh),EntityZ(p\mesh),0,-1.2,0)
		If PickedEntity()
			p\velocityY = 0.5 ; set "inverse" of gravity velocity
		EndIf	
	EndIf
	
	; we create a message type "2" for player position
	If MilliSecs()-updatePosition &gt; updateTick
	
		Net_SendMessage(2,EntityX(p\mesh) + "/" + EntityY(p\mesh) + "/" + EntityZ(p\mesh) + "/" + EntityYaw(p\mesh))
		updatePosition = MilliSecs()
	EndIf
	
End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function UpdatePlayers()

	For p.player = Each player
				
		If p\id &lt;&gt; localID ; update other players only
						
			;; LINEAR INTERPOLATION ;;;;;;;;;;
			
			If p\nextTime &lt;&gt; p\previousTime ; if both packets arrived at the same time, we can't interpolate
				
				curTime# = Float(MilliSecs()-p\nextTime) / Float(p\nextTime-p\previousTime) ; curTime will be ideally 0.0-1.0, if it's &gt; 1.0 then it performs extrapolation
				
				If curTime &gt; 1 Then curTime = 1 ; extrapolation gives anoying jittering effects
				
				; special fix for yaw as EntityYaw returns a value beetween +180 ans -180, the interpolation can go backward
				If p\previousYaw &lt; 0 Then p\previousYaw = p\previousYaw + 360
				If p\nextYaw &lt; 0 Then p\nextYaw = p\nextYaw + 360
				If Abs(p\nextYaw-p\previousYaw) &gt; 180
					If p\nextYaw &gt; p\previousYaw
						p\previousYaw = p\previousYaw + 360
					Else
						p\previousYaw = p\previousYaw - 360
					EndIf
				EndIf
				
				PositionEntity p\mesh,p\previousX+(p\nextX-p\previousX)*curTime,p\previousY+(p\nextY-p\previousY)*curTime,p\previousZ+(p\nextZ-p\previousZ)*curTime
				RotateEntity p\mesh,0,p\previousYaw+(p\nextYaw-p\previousYaw)*curTime,0
				
			Else
			
				PositionEntity p\mesh,p\nextX,p\nextY,p\nextZ
				RotateEntity p\mesh,0,p\nextYaw,0
			
			EndIf
			;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
						
			;ResetEntity p\mesh ; reset entity is useful here because of collisions

		Else ; update our player, basically it just compute gravity
		
			p\velocityY = p\velocityY - 0.03 ; fake gravity
			If EntityY(p\mesh) - p\currentY &gt;= 0 ; if player is not falling we limit the gravity
				If p\velocityY &lt; -0.03 Then p\velocityY = -0.03
			EndIf
		
			p\currentY = EntityY(p\mesh)
			TranslateEntity p\mesh,0,p\velocityY,0
						
		EndIf
	Next

End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function CreatePlayer(id,name$)

	For p.player = Each player
		If p\id = id Then Return ; player already connected
	Next

	p.player = New player
	p\id = id
	p\name = name
	
	p\life = 100
	
	p\mesh = CreateSphere()
	EntityType p\mesh,2
	EntityRadius p\mesh,1
	
	NameEntity p\mesh,Handle(p)
	
	nose = CreateSphere(8,p\mesh):EntityColor nose,255,0,0
	PositionEntity nose,0,0,1
	ScaleEntity nose,0.3,0.3,0.3
	
	eyeLeft = CreateSphere(8,p\mesh):EntityColor eyeLeft,255,255,255
	PositionEntity eyeLeft ,.29,.4,.7;1
	ScaleEntity eyeLeft ,0.2,0.2,0.2
	
	pupilLeft = CreateSphere(8,p\mesh):EntityColor pupilLeft ,0,0,0
	PositionEntity pupilLeft ,.3,.4,.9;1
	ScaleEntity pupilLeft ,0.05,0.05,0.02
	
	eyeRight = CreateSphere(8,p\mesh):EntityColor eyeRight ,255,255,255
	PositionEntity eyeRight ,-.29,.4,.7;1
	ScaleEntity eyeRight ,0.2,0.2,0.2
		
	pupilRight = CreateSphere(8,p\mesh):EntityColor pupilRight ,0,0,0
	PositionEntity pupilRight ,-.3,.4,.9;1
	ScaleEntity pupilRight ,0.05,0.05,0.02

	unaBrow = CreateCone(8,1,p\mesh):EntityColor unaBrow ,0,0,0
	PositionEntity unaBrow ,0,.45,.7
	RotateEntity unaBrow ,-180,0,0
	ScaleEntity unaBrow ,.7,.2,.3
	
	p\nextX = -20
	p\nextY = 1
	p\nextZ = -20
	p\nextYaw = -45
	
	p\previousX = p\nextX
	p\previousY = p\nextY
	p\previousZ = p\nextZ
	p\previousYaw = p\nextYaw
	
	p\r = Rand(255)
	p\g = Rand(255)
	p\b = Rand(255)
	EntityColor p\mesh,p\r,p\g,p\b
	
	PositionEntity p\mesh,p\nextX,p\nextY,p\nextZ
	RotateEntity p\mesh,0,p\nextYaw,0
	ResetEntity p\mesh
	
	p\currentY = p\nextY
	
	p\previousTime = MilliSecs()
	p\nextTime = MilliSecs()+1
	
	Return p\mesh

End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function ResetPlayer(id)

	p.player = Object.player(GetPlayer(id))

	p\life = 100

	p\nextX = -20
	p\nextY = 1
	p\nextZ = -20
	p\nextYaw = -45

	p\previousX = p\nextX
	p\previousY = p\nextY
	p\previousZ = p\nextZ
	p\previousYaw = p\nextYaw

	PositionEntity p\mesh,p\nextX,p\nextY,p\nextZ
	RotateEntity p\mesh,0,p\nextYaw,0
	ResetEntity p\mesh
	
	p\currentY = p\nextY
	
	p\previousTime = MilliSecs()
	p\nextTime = MilliSecs()+1

End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function GetPlayer(id)

	For p.player = Each player
		If p\id = id
			Return Handle(p)					
		EndIf
	Next
	
End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function DrawPlayersNames()

	For p.player = Each player
	
		Color 255,255,255
		CameraProject(camera,EntityX(p\mesh),EntityY(p\mesh),EntityZ(p\mesh)) 			
		If p\id &lt;&gt; localID Then Text ProjectedX(),ProjectedY()-60,p\name,1,1
		
		Color 255,(255./100.)*p\life,(255./100.)*p\life
		Text ProjectedX(),ProjectedY()-40,p\life,1,1

	Next
	
End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function CreateBullet(id)

	p.player = Object.player(GetPlayer(id))

	b.bullet = New bullet
	
	b\id = p\id
	
	b\mesh = CreateSphere(2)
	ScaleEntity b\mesh,0.2,0.2,0.2
	EntityColor b\mesh,255,0,0
		
	PositionEntity b\mesh,EntityX(p\mesh),EntityY(p\mesh),EntityZ(p\mesh)
	RotateEntity b\mesh,0,EntityYaw(p\mesh),0
	
	EntityType b\mesh,3
	EntityRadius b\mesh,0.2
		
	b\time = MilliSecs()

End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function UpdateBullets()

	For b.bullet = Each bullet
	
		MoveEntity b\mesh,0,0,1
		
		If CountCollisions(b\mesh)
		
			If localMode = 2 ; only the server compute bullets collision with player
				If GetEntityType(CollisionEntity(b\mesh,1)) = 2 ; a player is hit
				
					touchedPlayer.player = Object.player(EntityName(CollisionEntity(b\mesh,1)))
					touchedPlayer\life = touchedPlayer\life - 10
					
					If touchedPlayer\life &gt; 0 ; touched
						Net_SendMessage(5,touchedPlayer\life,touchedPlayer\id)
						Net_SendMessage(5,touchedPlayer\life,touchedPlayer\id,touchedPlayer\id)
					Else ; killed
						killerPlayer.player = Object.player(GetPlayer(b\id))
						
						killerPlayer\kills = killerPlayer\kills + 1
						touchedPlayer\deaths = touchedPlayer\deaths + 1						
						
						Net_SendMessage(6,touchedPlayer\id,killerPlayer\id)
						Net_SendMessage(6,touchedPlayer\id,killerPlayer\id,killerPlayer\id)
												
						Net_SendMessage(7,killerPlayer\kills+"/"+killerPlayer\deaths,killerPlayer\id)
						Net_SendMessage(7,killerPlayer\kills+"/"+killerPlayer\deaths,killerPlayer\id,killerPlayer\id)
						
						Net_SendMessage(7,touchedPlayer\kills+"/"+touchedPlayer\deaths,touchedPlayer\id)
						Net_SendMessage(7,touchedPlayer\kills+"/"+touchedPlayer\deaths,touchedPlayer\id,touchedPlayer\id)
						
						NewMessage(killerPlayer\name + " killed " + touchedPlayer\name)
						ResetPlayer(touchedPlayer\id)
					EndIf
				
				EndIf
			EndIf
			
			FreeEntity b\mesh
			Delete b
			
		ElseIf MilliSecs()-b\time &gt; 2000
		
			FreeEntity b\mesh
			Delete b
			
		EndIf
	
	Next

End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function CreateHealthItem(x#,y#,z#)

	h.health = New health
	
	h\mesh = CreateMesh()
		
	h\respawnDelay = 10000
	
	mesh1 = CreateCube()
	mesh2 = CreateCube()
	
	ScaleMesh mesh1,.20,.5,.20
	ScaleMesh mesh2,.20,.5,.20:RotateMesh mesh2,90,0,0

	AddMesh(mesh1,h\mesh)
	AddMesh(mesh2,h\mesh)
	
	EntityColor h\mesh,255,0,0

	If localMode = 2 Then EntityType h\mesh,4
	EntityRadius h\mesh,0.5
	
	PositionEntity h\mesh,x,y,z
	
	NameEntity h\mesh,Handle(h)
	
End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function UpdateHealthItems()

	For h.health = Each health

		TurnEntity h\mesh,0,-2,0
				
		If CountCollisions(h\mesh)
			
			If localMode = 2 ; only the server computes collision with player
				If GetEntityType(CollisionEntity(h\mesh,1)) = 2 ; a player collided
					
					touchedPlayer.player = Object.player(EntityName(CollisionEntity(h\mesh,1)))
					
					h\pickupTime = MilliSecs()
					HideEntity h\mesh
					ResetEntity h\mesh
					
					Net_SendMessage(8,Handle(h))
					
					If touchedPlayer\life &lt; 100 ; touched healthpowerup..
										
						touchedPlayer\life = touchedPlayer\life + 10
					
						Net_SendMessage(5,touchedPlayer\life,touchedPlayer\id)
						Net_SendMessage(5,touchedPlayer\life,touchedPlayer\id,touchedPlayer\id)
						
					EndIf
										
				EndIf
			EndIf
			
		EndIf
	
		If MilliSecs() - h\pickupTime &gt; h\respawnDelay Then ShowEntity h\mesh
	
	Next

End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function NewMessage(msg$)

	messageOffset = messageOffset + 1
	
	If messageOffset &gt; messageDisplayNumber
	
		messageOffset = messageOffset - 1
		
		For i = 2 To messageDisplayNumber
			message(i-1) = message(i)		
		Next
		
		message(messageDisplayNumber) = msg
	
	Else
	
		message(messageOffset) = msg
	
	EndIf

End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function DrawMessages()

	Color 255,255,255

	For i = 1 To messageOffset
	
		Text 0,(i-1)*15,message(i)	
	
	Next

End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function UpdateChat()

	key = GetKey()

	If key
		If key = 13
			If chatMessage &lt;&gt; localName + "&gt; "
				For i = Len(localName + "&gt; ") To Len(chatMessage)
					If Mid(chatMessage,i,1) &lt;&gt; " "
						Net_SendMessage(1,chatMessage)
						NewMessage(chatMessage)
						Exit
					EndIf
				Next
			EndIf
			chatMessage = localName + "&gt; "
			chatMode = 0
		ElseIf key = 8 And Len(chatMessage) &gt; Len ( localName + "&gt; " )
			chatMessage = Left(chatMessage,Len(chatMessage)-1)
		ElseIf key &gt; 31 And key &lt; 127
			chatMessage = chatMessage + Chr(key)
		EndIf
	EndIf
	
	Color 255,255,255
	Rect 0,GraphicsHeight()-20,GraphicsWidth(),20,1
	
	Color 0,0,0
	Rect 0,GraphicsHeight()-20,GraphicsWidth(),20,0
	
	
	If MilliSecs()-chatMillisecs &gt; 500
		chatCursor = Not chatCursor
		chatMillisecs = MilliSecs()
	EndIf
	
	If chatCursor
		Text 5,GraphicsHeight()-17,chatMessage + "|"
	Else
		Text 5,GraphicsHeight()-17,chatMessage
	EndIf

End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function DrawScoreTable()

	For p.player = Each player
		count = count + 1
	Next
	
	baseX = (GraphicsWidth()-350)/2
	baseY = (GraphicsHeight()-(35+20*count))/2

	Color 0,0,0
	Rect baseX,baseY,350,35+20*count,1

	Color 255,192,0
	Rect baseX,baseY,350,35+20*count,0

	Text baseX+10,baseY+10,"Player          Kills     Deaths     Ping"
	Line baseX,baseY+25,baseX+349,baseY+25

	For p.player = Each player
	
		Color 255,255,255
		If p\id = localID Then Color 255,100,100
	
		i = i + 1
		Text baseX+10,baseY+10+20*i,p\name
		Text baseX+157,baseY+10+20*i,p\kills,1,0
		Text baseX+240,baseY+10+20*i,p\deaths,1,0
		Text baseX+322,baseY+10+20*i,p\ping,1,0
	Next

End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function UpdateChaseCam(camera,player) ; thanks to jfk EO-11110 on bb forums for this function !
	PositionEntity camera,EntityX(player,1),EntityY(player,1),EntityZ(player,1)
	ResetEntity camera
	x#=EntityX(player)+Sin(-EntityYaw(player)+180)*x_dis#
	y#=EntityY(player)+y_dis#
	z#=EntityZ(player)+Cos(-EntityYaw(player)+180)*z_dis#
	obstacle=LinePick(EntityX(player),EntityY(player),EntityZ(player),(x-EntityX(player)),y_dis#,(z-EntityZ(player)),0.1)
	If obstacle=0
		new_x#=x
		new_y#=y
		new_z#=z
	Else
		new_x#=PickedX()
		new_y#=PickedY()
		new_z#=PickedZ()
	EndIf
	If bounce_cam=0
		PositionEntity camera,new_x,new_y,new_z
	Else
		x=old_x+((New_x-old_x)/bounce_div#)
		y=old_y+((New_y-old_y)/bounce_div#)
		z=old_z+((New_z-old_z)/bounce_div#)
		PositionEntity camera,x,y,z
	EndIf
	PointEntity camera,player
	TurnEntity camera,-20,0,0     ; if you want the player mesh more on the bottom of the screen
	old_x#=EntityX(camera)
	old_y#=EntityY(camera)
	old_z#=EntityZ(camera)
End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function CreateScene()

	texture = TextureCreate(128)
	
	ground = CreatePlane()
	EntityColor ground,150,150,150
	EntityTexture ground,texture
	
	cube = CreateCube():EntityColor cube,150,200,150
	ScaleEntity cube,5,5,5:PositionEntity cube,0,5,0
	EntityTexture cube,texture
	
	sphere = CreateSphere(16):EntityColor sphere,200,150,150
	ScaleEntity sphere,3,1,3:PositionEntity sphere,0,9.7,0
	
	platform = CreateCube():EntityColor platform,150,150,200
	ScaleEntity platform,3,1,10:PositionEntity platform,0,4.13,-13.15
	TurnEntity platform,-30,0,0
	EntityTexture platform,texture
	
	FreeTexture texture
	
	EntityType ground,1:EntityPickMode ground,2
	EntityType cube,1:EntityPickMode cube,2
	EntityType sphere,1:EntityPickMode sphere,2
	EntityType platform,1:EntityPickMode platform,2

	light = CreateLight()
	TurnEntity light,30,70,0
	
	CreateHealthItem(0,12,0)
	CreateHealthItem(0,1,-10)
	CreateHealthItem(0,3,-20)

	
	;; COLLISIONS
	Collisions 2,1,2,3 ; player to scene
	Collisions 2,2,1,3 ; player to player
	
	Collisions 3,1,2,1 ; bullet to scene
	Collisions 3,2,1,1 ; bullet to player
	
	Collisions 2,4,1,2 ; player to health
	
End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function TextureCreate(size)
	texture = CreateTexture(size,size,9)
	SetBuffer TextureBuffer(texture)
	Color 255,255,255
	Rect 0,0,size,size,1
	Color 0,0,0
	Rect 0,0,size,size,0
	Line 0,0,size,size
	Line 0,size,size,0
	SetBuffer BackBuffer()
	Return texture
End Function</textarea><br><br>Notice the new message type "8" in the network function and update health function, to tell players wich health has been picked up. <br><br></td></tr></table><br>
<a name="1291026"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Guy Fawkes</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#111">[#111]</a></td></tr></table></td></tr><tr ><td class="posttext"> AWESOME! <br><br></td></tr></table><br>
<a name="1291027"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Raster Ron</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#112">[#112]</a></td></tr></table></td></tr><tr ><td class="posttext"> Thanks guys and sure thing. I'm glad to help out and will post new stuff if I have more ideas to share. We are having some problems with our port forwarding and service provider so I'll be glad to join in as soon as they have fixed it. :)<br><br>The new health feature looks awesome! Keep it up and Good Day to All. <br><br></td></tr></table><br>
<a name="1291029"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Guy Fawkes</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#113">[#113]</a></td></tr></table></td></tr><tr ><td class="posttext"> Raster Ron, the 1st thing I wanna test for you is admin / moderator / player colors / status / name tags, and then slash commands with optional parameters in the slash commands. :)<br><br>Can't WAIT to test this to pieces! &lt;3<br><br>~GF <br><br></td></tr></table><br>
<a name="1291043"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >stayne</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#114">[#114]</a></td></tr></table></td></tr><tr ><td class="posttext"> welp I for one am outta here.  I can't take this silly crap. <br><br></td></tr></table><br>
<a name="1291094"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rick Nasher</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#115">[#115]</a></td></tr></table></td></tr><tr ><td class="posttext"> Many thanks Flanker, will take a look at tonight.  Very curious to see where I'm taking a wrong turn with this. I must have gone daft during my burnout. :-/ <br><br></td></tr></table><br>
<a name="1291100"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >RemiD</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#116">[#116]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> <br>But the problem is, for example i'm running, then I reload my weapon, but I can't animate only the upper body by applying the animation on a bone. I though it was possible to animate a bone and its children with a specific animation sequence in Blitz3D, but it seems it's not the case natively...<br> <br></div><br>Ah ok, after having watched your video, i didn't understood what you wanted because the animations seem already pretty good imo.<br>If i understand correctly you want to have a run animation and a run + shoot animation ?<br>If yes i can probably create another animation by mixing the rotations/positions of the joints/bones of the lower body while the character is running and the rotations/positions of the joints/bones of the upper body while the character is shooting.<br><br>Another way which may work (not tested) would be to have 2 hidden skeleton with the same animations. And one skeleton for the character.<br>When you want to animate the character, you animate one hidden skeleton with the animation run, then you get the rotations/positions of the joints/bones of the lower body and you use rotateentity/positionentity to rotate/position the joints/bones of the lower body of your character.<br>Then you animate the other hidden skeleton with the animation shoot, then you get the rotations/positions of the joints/bones of the upper body and you use rotateentity/positionentity to rotate/position the joints/bones of the upper body of your character.<br><br>Another way would be to create 2 separate skeletons for each character (one for the lower body, one for the upper boddy) but you will probably have to modify the mesh and then rerigg, reskin, so for these tests i don't think it is worth it to do it. <br><br></td></tr></table><br>
<a name="1291359"></a>

<a name="1291361"></a>

<a name="1291363"></a>

<a name="1291364"></a>

<a name="1291367"></a>

<a name="1291370"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rick Nasher</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#117">[#117]</a></td></tr></table></td></tr><tr ><td class="posttext"> @Flanker<br>Well, that was a rather sad undertaking from my side. :-)<br>Main cause, was the location of CreateScene() along with some other bugs/silly mistakes I introduced after failure of the initial 'should have worked' version..<br>Fixed full code with colorchat, 2 spawnhills(anti spawncamper) and easyinputenter mods below. Also changed health increase +10 to a full 100 restore, which probably makes it more usefull, something GF is probably gonna love. ;-)<br><img src="http://i65.tinypic.com/2cfzaxf.jpg"><br><textarea class=codebox name="code" wrap=OFF readonly="true" rows="15" cols="80">
SeedRnd MilliSecs()

Const gameLogicFPS = 60

; first we include the network library
Include "UDPNetwork_lib.bb"
; for converting RGB values to "Tri-Hex" stringc inlude hex8.
Include "Hex8.bb" ;&lt;&lt;&lt; Colored txt mod by Raster Ron 

Global localID
;Global localName$ = Input("Enter your name : ")
;If localName = "" Then localName = "player" + Rand(100,999)


;&lt;&lt; Enter through mod..
Global localName$ = "", defaultName$ = "RCX" ; Predefined name, so just need To press enter.

Print "Change default name '"+ defaultName$ +"' ?"
Choic$ = Input$("Press [Y]es or [ENTER] for No: ")
If Choic$="y" Then ; so want to change..
	Cls:Locate 0,0
	Print "Type name &amp; press [ENTER] or"
	ChangeName$=Input$("just [ENTER] to autogenerate: ")
	If ChangeName$="" ; so pressed enter to autogen..
		localName = "player" + Rand(100,999)
	Else ; so entered a new name..
		localName$=ChangeName$
	EndIf
Else ; so entered without input.
	localName$ = defaultName$
EndIf
;&lt;&lt; End enter through mod.




Global localPlayerMesh

Type player
	Field id
	Field name$
	Field ping
	
	Field life
	Field kills
	Field deaths
	
	Field mesh
	Field r,g,b
	
	Field nextX#,nextY#,nextZ#
	Field previousX#,previousY#,previousZ#
	Field nextYaw#
	Field previousYaw#
	Field nextTime
	Field previousTime
	
	Field lastPacket
	
	Field currentY#
	Field velocityY#
End Type

Type bullet
	Field mesh
	Field angle#
	Field time
	Field id ; id of player who fired
End Type

Type health
	Field mesh
	Field pickupTime
	Field respawnDelay
End Type

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
; Camera code from jfk EO-11110, thanks
Global bounce_cam=1 ;  smooth camera motion? (0/1)
Global bounce_div#=10.0 ; the higher, the more sluggish the camera will follow. Recc: 3.0 to 20.0
; some globals used by ChaseCam
Global old_x#,old_y#,old_z#
; desired distance between camera and player mesh
Global x_dis#=7.0,y_dis#=3,z_dis#=7.0,y_dis_or#=y_dis#
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;

; network init ----------------------------------------;
Global localMode = Net_StartInput() ; bring the library "console" to connect

If localMode = 1 Or localMode = 2 ; 1 means we are client, 2 means we are server
	
	localID = Net_CreatePlayer(localName) ; this command inits the server or local client
	
	If localID = 0 ; error
		Net_StopNetwork() ; close the network properly
		RuntimeError("Failed to create player.")
	EndIf
	
	If localMode = 1 Then AppTitle("Client : " + localName + " (port:" + net_port + "/ ID=" + localID + ")")
	If localMode = 2 Then AppTitle("Server : " + localName + " (port:" + net_port + "/ ID=" + localID + ")")
	
Else ; error
	Net_StopNetwork()
	RuntimeError("Failed to start game.")
EndIf
;------------------------------------------------------;

Graphics3D 640,480,32,2
SetBuffer BackBuffer()

CreateScene()

Global camera = CreateCamera()
CameraRange camera,0.1,1000

; create our own local player
localPlayerMesh = CreatePlayer(localID,localName)
old_x = EntityX(localPlayerMesh):old_y = EntityY(localPlayerMesh):old_z = EntityZ(localPlayerMesh) ; update camera position

; we send our color to the server
p.player = Object.player(GetPlayer(localID))
Net_SendMessage(3,p\r + "/" + p\g + "/" + p\b)

; &lt;&lt;&lt; colored txt mod by Raster Ron..
;store colors for chattxt.
Global cR = p\r 
Global cG = p\g 
Global cB = p\b 
; &lt;&lt;&lt; end colored txt mod by Raster Ron..


; variables used to send our positions at a constant delay (saves bandwidth but makes a constant ping)
Global updatePosition = MilliSecs()
Global updateTick = 50

; chat
Global messageDisplayNumber = 10
Global messageOffset
Dim message$(messageDisplayNumber)

Global chatMode
Global chatMessage$ = localName + "&gt; "
Global chatMillisecs = MilliSecs()
Global chatCursor

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
tweeningPeriod = 1000 / gameLogicFPS
tweeningTime = MilliSecs() - tweeningPeriod
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
While Not KeyHit(1)
	
	;; I use tweening from castle demo here :
	;;
	;; 		- this allows to have very fast execution outside the tweening loop,
	;; 		  so the network is updated as fast as possible (needs Flip False)
	;;
	;; 		- this makes the game logic updated at a constant rate (Const FPS=)
	;;		  so no need to set deltatime (and it saves CPU time for other things)
	
	
	;; -------------------------------------------------------------------------------------------------; FAST EXECUTION (outside of tweening)
	;; -------------------------------------------------------------------------------------------------;
	
	; see the function, the interpolation variables are set properly here
	UpdateNetwork()
	
	;; -------------------------------------------------------------------------------------------------;
	
	Repeat
		tweeningElapsed = MilliSecs() - tweeningTime
	Until tweeningElapsed
	tweeningTicks = tweeningElapsed / tweeningPeriod
	tweeningRate# = Float(tweeningElapsed Mod tweeningPeriod)/Float(tweeningPeriod)
	For k = 1 To tweeningTicks
		tweeningTime = tweeningTime + tweeningPeriod
		If k = tweeningTicks Then CaptureWorld
		
		;; ---------------------------------------------------------------------------------------------; MAIN UPDATE
		;; ---------------------------------------------------------------------------------------------;
		
		; update our player
		UpdateLocalPlayer()
		
		; the interpolation is made in this function
		UpdatePlayers()
		
		UpdateWorld()
		
		; update the bullets... only the server check for player kills
		UpdateBullets()
		
		UpdateHealthItems()
		
		UpdateChaseCam(camera,localPlayerMesh)
		
		;; ---------------------------------------------------------------------------------------------;
		
	Next
	
	RenderWorld tweeningRate
	
	;; -------------------------------------------------------------------------------------------------; 2D UPDATE
	;; -------------------------------------------------------------------------------------------------;
	
	DrawPlayersNames()
	
	If KeyHit(28) And chatMode = 0 Then chatMode = 1:FlushKeys()
	If chatMode = 1 Then UpdateChat()
	
	DrawMessages()
	
	If KeyDown(15) Then DrawScoreTable()
	
	;; -------------------------------------------------------------------------------------------------;
	
	Flip
	
Wend
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;

Net_StopNetwork()

End

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function UpdateNetwork()
	
	; update incoming packets (better check ALL incoming messages so use While Wend)
	While Net_CheckMessage() ; will check for a new message and fill Net_MsgType, Net_MsgString$, Net_MsgFrom and Net_MsgTo variables so we can read it
		
		p.player = Object.player(GetPlayer(Net_MsgFrom)) ; get the player handle
		
		If Handle(p) = 0 And Net_MsgType &lt; 100 ; we received an update packet from a player we don't know
			; so we ask the server who he is and return because we can't update him for now
			; the server will resend us the info in a new player "100" message
			Net_RequestPlayer(Net_MsgFrom)
			Return
		EndIf
		
		Select Net_MsgType ; check the type of message
				
			Case 1 ; chat message
				
				NewMessage(Net_MsgString)
				
			Case 2 ; player position and angle, example of packing data into string
				
				offset1 = Instr(Net_MsgString,"/",1)
				offset2 = Instr(Net_MsgString,"/",offset1+1)
				offset3 = Instr(Net_MsgString,"/",offset2+1)
				
				p\previousX = p\nextX
				p\previousY = p\nextY
				p\previousZ = p\nextZ
				p\previousYaw = p\nextYaw
				
				p\nextX = Left(Net_MsgString,offset1-1)
				p\nextY = Mid(Net_MsgString,offset1+1,offset2-offset1-1)
				p\nextZ = Mid(Net_MsgString,offset2+1,offset3-offset2-1)
				p\nextYaw = Right(Net_MsgString,Len(Net_MsgString)-offset3)
				
				p\previousTime = p\nextTime
				p\nextTime = MilliSecs()
				
			Case 3 ; update player colors
				
				offset1 = Instr(Net_MsgString,"/",1)
				offset2 = Instr(Net_MsgString,"/",offset1+1)
				
				p\r = Left(Net_MsgString,offset1-1)
				p\g = Mid(Net_MsgString,offset1+1,offset2-offset1-1)
				p\b = Right(Net_MsgString,Len(Net_MsgString)-offset2)
				
				EntityColor p\mesh,p\r,p\g,p\b
				
			Case 4 ; a player fired
				
				CreateBullet(Net_MsgFrom)
				
			Case 5 ; a player lost some life
				
				p\life = Net_MsgString
				
			Case 6 ; a player killed another one
				
				k.player = Object.player(GetPlayer(Net_MsgString)) ; killed player ID in MsgData
				NewMessage(p\name + " killed " + k\name)
				
				ResetPlayer(k\id)
				
			Case 7 ; the server sends us score update for a player
				
				offset = Instr(Net_MsgString,"/",1)
				
				p\kills = Left(Net_MsgString,offset-1)
				p\deaths = Right(Net_MsgString,Len(Net_MsgString)-offset)
				
			Case 8 ; health pickup
				
				h.health = Object.health(Net_MsgString)
				HideEntity h\mesh
				h\pickupTime = MilliSecs()
					
				
			Case 100 ; new player connected, OR the server tells us who is already connected so we can create players when joining the game
				
				If localMode = 2
					For p.player = Each player
						Net_SendMessage(2,p\nextX + "/" + p\nextY + "/" + p\nextZ + "/" + p\nextYaw,p\id,Net_MsgFrom)
						Net_SendMessage(3,p\r + "/" + p\g + "/" + p\b,p\id,Net_MsgFrom)
						
						Net_SendMessage(5,p\life,p\id,Net_MsgFrom)
						Net_SendMessage(7,p\kills+"/"+p\deaths,p\id,Net_MsgFrom)
					Next
				EndIf
				
				NewMessage(Net_MsgString + " connected")
				CreatePlayer(Net_MsgFrom,Net_MsgString)
				
			Case 101 ; a player has quit
				
				For p.player = Each player
					If Net_MsgFrom = p\id
						NewMessage(p\name + " disconnected")
						FreeEntity p\mesh
						Delete p
					EndIf
				Next
				
			Case 102 ; host has changed
				
				For p.player = Each player
					If Net_MsgFrom = p\id
						If p\id = localID
							AppTitle("Server : " + localName + " (port:" + net_port + ")")
							NewMessage("You are the new host")
							localMode = 2
						Else
							NewMessage(p\name + " is the new host")
						EndIf					
					EndIf
				Next
				
			Case 103 ; ping update
				
				For p.player = Each player
					If Net_MsgFrom = p\id
						p\ping = Net_MsgString
					EndIf
				Next
				
		End Select
		
	Wend
	
End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function UpdateLocalPlayer()
	
	; update our player
	p.player = Object.player(GetPlayer(localID)) ; get our player
	
	; inputs
	If KeyDown(200) Then MoveEntity p\mesh,0,0,0.3
	If KeyDown(208) Then MoveEntity p\mesh,0,0,-0.3
	If KeyDown(203) Then TurnEntity p\mesh,0,3,0
	If KeyDown(205) Then TurnEntity p\mesh,0,-3,0
	
	; fire
	If MouseHit(1)
		Net_SendMessage(4,"")
		CreateBullet(localID)
	EndIf
	
	; jump
	If MouseHit(2)
		; check if player is one the ground
		LinePick(EntityX(p\mesh),EntityY(p\mesh),EntityZ(p\mesh),0,-1.2,0)
		If PickedEntity()
			p\velocityY = 0.5 ; set "inverse" of gravity velocity
		EndIf	
	EndIf
	
	; we create a message type "2" for player position
	If MilliSecs()-updatePosition &gt; updateTick
		
		Net_SendMessage(2,EntityX(p\mesh) + "/" + EntityY(p\mesh) + "/" + EntityZ(p\mesh) + "/" + EntityYaw(p\mesh))
		updatePosition = MilliSecs()
	EndIf
	
End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function UpdatePlayers()
	
	For p.player = Each player
		
		If p\id &lt;&gt; localID ; update other players only
			
			;; LINEAR INTERPOLATION ;;;;;;;;;;
			
			If p\nextTime &lt;&gt; p\previousTime ; if both packets arrived at the same time, we can't interpolate
				
				curTime# = Float(MilliSecs()-p\nextTime) / Float(p\nextTime-p\previousTime) ; curTime will be ideally 0.0-1.0, if it's &gt; 1.0 then it performs extrapolation
				
				If curTime &gt; 1 Then curTime = 1 ; extrapolation gives anoying jittering effects
				
				; special fix for yaw as EntityYaw returns a value beetween +180 ans -180, the interpolation can go backward
				If p\previousYaw &lt; 0 Then p\previousYaw = p\previousYaw + 360
				If p\nextYaw &lt; 0 Then p\nextYaw = p\nextYaw + 360
				If Abs(p\nextYaw-p\previousYaw) &gt; 180
					If p\nextYaw &gt; p\previousYaw
						p\previousYaw = p\previousYaw + 360
					Else
						p\previousYaw = p\previousYaw - 360
					EndIf
				EndIf
				
				PositionEntity p\mesh,p\previousX+(p\nextX-p\previousX)*curTime,p\previousY+(p\nextY-p\previousY)*curTime,p\previousZ+(p\nextZ-p\previousZ)*curTime
				RotateEntity p\mesh,0,p\previousYaw+(p\nextYaw-p\previousYaw)*curTime,0
				
			Else
				
				PositionEntity p\mesh,p\nextX,p\nextY,p\nextZ
				RotateEntity p\mesh,0,p\nextYaw,0
				
			EndIf
			;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
			
			;ResetEntity p\mesh ; reset entity is useful here because of collisions
			
		Else ; update our player, basically it just compute gravity
			
			p\velocityY = p\velocityY - 0.03 ; fake gravity
			If EntityY(p\mesh) - p\currentY &gt;= 0 ; if player is not falling we limit the gravity
				If p\velocityY &lt; -0.03 Then p\velocityY = -0.03
			EndIf
			
			p\currentY = EntityY(p\mesh)
			TranslateEntity p\mesh,0,p\velocityY,0
			
		EndIf
	Next
	
End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function CreatePlayer(id,name$)
	
	For p.player = Each player
		If p\id = id Then Return ; player already connected
	Next
	
	p.player = New player
	p\id = id
	p\name = name
	
	p\life = 80
	
	;build player entity
	p\mesh = CreateSphere()
	EntityType p\mesh,2
	EntityRadius p\mesh,1
	
	NameEntity p\mesh,Handle(p)
	
	nose = CreateSphere(8,p\mesh):EntityColor nose,255,0,0
	PositionEntity nose,0,0,1
	ScaleEntity nose,0.3,0.3,0.3
	
	eyeLeft = CreateSphere(8,p\mesh):EntityColor eyeLeft,255,255,255
	PositionEntity eyeLeft ,.29,.4,.7;1
	ScaleEntity eyeLeft ,0.2,0.2,0.2
	
	pupilLeft = CreateSphere(8,p\mesh):EntityColor pupilLeft ,0,0,0
	PositionEntity pupilLeft ,.3,.4,.9;1
	ScaleEntity pupilLeft ,0.05,0.05,0.02
	
	eyeRight = CreateSphere(8,p\mesh):EntityColor eyeRight ,255,255,255
	PositionEntity eyeRight ,-.29,.4,.7;1
	ScaleEntity eyeRight ,0.2,0.2,0.2
	
	pupilRight = CreateSphere(8,p\mesh):EntityColor pupilRight ,0,0,0
	PositionEntity pupilRight ,-.3,.4,.9;1
	ScaleEntity pupilRight ,0.05,0.05,0.02
	
	unaBrow = CreateCone(8,1,p\mesh):EntityColor unaBrow ,0,0,0
	PositionEntity unaBrow ,0,.45,.7
	RotateEntity unaBrow ,-180,0,0
	ScaleEntity unaBrow ,.7,.2,.3
	
	;positions
	location=Rand (1,2)
	If location=1
	
		p\nextX = -20
		p\nextY = 6.5
		p\nextZ = -20
	
	Else 
	
		p\nextX = 20
		p\nextY = 6.5
		p\nextZ = 20
	EndIf
	p\nextYaw = -45
	
	p\previousX = p\nextX
	p\previousY = p\nextY
	p\previousZ = p\nextZ
	p\previousYaw = p\nextYaw
	
	p\r = Rand(255)
	p\g = Rand(255)
	p\b = Rand(255)
	EntityColor p\mesh,p\r,p\g,p\b
	
	PositionEntity p\mesh,p\nextX,p\nextY,p\nextZ
	RotateEntity p\mesh,0,p\nextYaw,0
	ResetEntity p\mesh
	
	p\currentY = p\nextY
	
	p\previousTime = MilliSecs()
	p\nextTime = MilliSecs()+1
	
	Return p\mesh
	
End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function ResetPlayer(id)
	
	p.player = Object.player(GetPlayer(id))
	
	p\life = 100
	
	location=Rand (1,2)
	If location=1
	
		p\nextX = -20
		p\nextY = 6.5
		p\nextZ = -20
	
	Else 
	
		p\nextX = 20
		p\nextY = 6.5
		p\nextZ = 20
	EndIf
	
	p\nextYaw = -45
	
	
	
	p\previousX = p\nextX
	p\previousY = p\nextY
	p\previousZ = p\nextZ
	p\previousYaw = p\nextYaw
	;back to origin.
	PositionEntity p\mesh,p\nextX,p\nextY,p\nextZ
	RotateEntity p\mesh,0,p\nextYaw,0
	ResetEntity p\mesh
	
	p\currentY = p\nextY
	
	p\previousTime = MilliSecs()
	p\nextTime = MilliSecs()+1
	
End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function GetPlayer(id)
	
	For p.player = Each player
		If p\id = id
			Return Handle(p)					
		EndIf
	Next
	
End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function DrawPlayersNames()
	
	For p.player = Each player
		
		Color 255,255,255
		CameraProject(camera,EntityX(p\mesh),EntityY(p\mesh),EntityZ(p\mesh)) 			
		If p\id &lt;&gt; localID Then Text ProjectedX(),ProjectedY()-60,p\name,1,1
		
		Color 255,(255./100.)*p\life,(255./100.)*p\life
		Text ProjectedX(),ProjectedY()-40,p\life,1,1
		
	Next
	
End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function CreateBullet(id)
	
	p.player = Object.player(GetPlayer(id))
	
	b.bullet = New bullet
	
	b\id = p\id
	
	b\mesh = CreateSphere(2)
	ScaleEntity b\mesh,0.2,0.2,0.2
	EntityColor b\mesh,255,255,0
	
	PositionEntity b\mesh,EntityX(p\mesh),EntityY(p\mesh),EntityZ(p\mesh)
	RotateEntity b\mesh,0,EntityYaw(p\mesh),0
	
	EntityType b\mesh,3
	EntityRadius b\mesh,0.2
	
	b\time = MilliSecs()
	
End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function UpdateBullets()
	
	For b.bullet = Each bullet
		
		MoveEntity b\mesh,0,0,1
		
		If CountCollisions(b\mesh)
			
			If localMode = 2 ; only the server compute bullets collision with player
				If GetEntityType(CollisionEntity(b\mesh,1)) = 2 ; a player is hit
					
					touchedPlayer.player = Object.player(EntityName(CollisionEntity(b\mesh,1)))
					touchedPlayer\life = touchedPlayer\life - 10
					
					If touchedPlayer\life &gt; 0 ; touched
						Net_SendMessage(5,touchedPlayer\life,touchedPlayer\id)
						Net_SendMessage(5,touchedPlayer\life,touchedPlayer\id,touchedPlayer\id)
					Else ; killed
						killerPlayer.player = Object.player(GetPlayer(b\id))
						
						killerPlayer\kills = killerPlayer\kills + 1
						touchedPlayer\deaths = touchedPlayer\deaths + 1						
						
						Net_SendMessage(6,touchedPlayer\id,killerPlayer\id)
						Net_SendMessage(6,touchedPlayer\id,killerPlayer\id,killerPlayer\id)
						
						Net_SendMessage(7,killerPlayer\kills+"/"+killerPlayer\deaths,killerPlayer\id)
						Net_SendMessage(7,killerPlayer\kills+"/"+killerPlayer\deaths,killerPlayer\id,killerPlayer\id)
						
						Net_SendMessage(7,touchedPlayer\kills+"/"+touchedPlayer\deaths,touchedPlayer\id)
						Net_SendMessage(7,touchedPlayer\kills+"/"+touchedPlayer\deaths,touchedPlayer\id,touchedPlayer\id)
						
						NewMessage(killerPlayer\name + " killed " + touchedPlayer\name)
						ResetPlayer(touchedPlayer\id)
					EndIf
					
				EndIf
			EndIf
			
			FreeEntity b\mesh
			Delete b
			
		ElseIf MilliSecs()-b\time &gt; 2000
			
			FreeEntity b\mesh
			Delete b
			
		EndIf
		
	Next
	
End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function CreateHealthItem(x#,y#,z#)
	
	h.health = New health
	
	h\mesh = CreateMesh()
	
	h\respawnDelay = 10000
	
	mesh1 = CreateCube()
	mesh2 = CreateCube()
	
	ScaleMesh mesh1,.20,.5,.20
	ScaleMesh mesh2,.20,.5,.20:RotateMesh mesh2,90,0,0
	
	AddMesh(mesh1,h\mesh)
	AddMesh(mesh2,h\mesh)
	
	EntityColor h\mesh,255,0,0
	
	If localMode = 2 Then EntityType h\mesh,4
	EntityRadius h\mesh,0.5
	
	PositionEntity h\mesh,x,y,z
	
	NameEntity h\mesh,Handle(h)
	
End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function UpdateHealthItems()
	
	For h.health = Each health
		
		TurnEntity h\mesh,0,-2,0
		
		If CountCollisions(h\mesh)
			
			If localMode = 2 ; only the server computes collision with player
				If GetEntityType(CollisionEntity(h\mesh,1)) = 2 ; a player collided
					
					touchedPlayer.player = Object.player(EntityName(CollisionEntity(h\mesh,1)))
					
					h\pickupTime = MilliSecs()
					HideEntity h\mesh
					ResetEntity h\mesh
					
					Net_SendMessage(8,Handle(h))
					
					If touchedPlayer\life &lt; 100 ; touched healthpowerup..
						
						;touchedPlayer\life = touchedPlayer\life + 10
						touchedPlayer\life = 100

						Net_SendMessage(5,touchedPlayer\life,touchedPlayer\id)
						Net_SendMessage(5,touchedPlayer\life,touchedPlayer\id,touchedPlayer\id)

					EndIf
					
				EndIf
			EndIf
			
		EndIf
		
		If MilliSecs() - h\pickupTime &gt; h\respawnDelay Then ShowEntity h\mesh
		
	Next
	
End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function NewMessage(msg$)
	
	messageOffset = messageOffset + 1
	
	If messageOffset &gt; messageDisplayNumber
		
		messageOffset = messageOffset - 1
		
		For i = 2 To messageDisplayNumber
			message(i-1) = message(i)		
		Next
		
		message(messageDisplayNumber) = msg
		
	Else
		
		message(messageOffset) = msg
		
	EndIf
	
End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function DrawMessages()
	
	Color 255,255,255
	
	For i = 1 To messageOffset
		
		;Text 0,(i-1)*15,message(i)	
		
		; &lt;&lt;&lt; colored txt mod by Raster Ron
		loc = Instr (message(i), "",1)
		If loc &gt; 1 Then 
			colorMessage$ = Mid$(message(i), 1, Len(message(i)) - 7 ) 
			Hex$ = Right$(message(i),6)		 
			Set_Color_Hex(Hex$) 
			Text 0,(i-1)*15,colorMessage$ 
		Else  
			Color 255,255,255 
			Text 0,(i-1)*15,message(i) 
		End If	
		; &lt;&lt;&lt; End colored txt mod by Raster Ron
		
	Next
	
End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function UpdateChat()
	
	key = GetKey()
	
	If key
		If key = 13
			If chatMessage &lt;&gt; localName + "&gt; "
				For i = Len(localName + "&gt; ") To Len(chatMessage)
					If Mid(chatMessage,i,1) &lt;&gt; " "
					
						; &lt;&lt;&lt; colored txt mod by Raster Ron
						chatColor$ = RGB_To_TriHex(cR,cG,cB)
						chatMessage = chatMessage + "" + chatColor$
						; &lt;&lt;&lt; end colored txt mod by Raster Ron					
					
					
						Net_SendMessage(1,chatMessage)
						NewMessage(chatMessage)
						Exit
					EndIf
				Next
			EndIf
			chatMessage = localName + "&gt; "
			chatMode = 0
		ElseIf key = 8 And Len(chatMessage) &gt; Len ( localName + "&gt; " )
			chatMessage = Left(chatMessage,Len(chatMessage)-1)
		ElseIf key &gt; 31 And key &lt; 127
			chatMessage = chatMessage + Chr(key)
		EndIf
	EndIf
	
	Color 255,255,255
	Rect 0,GraphicsHeight()-20,GraphicsWidth(),20,1
	
	Color 0,0,0
	Rect 0,GraphicsHeight()-20,GraphicsWidth(),20,0
	
	
	If MilliSecs()-chatMillisecs &gt; 500
		chatCursor = Not chatCursor
		chatMillisecs = MilliSecs()
	EndIf
	
	If chatCursor
		Text 5,GraphicsHeight()-17,chatMessage + "|"
	Else
		Text 5,GraphicsHeight()-17,chatMessage
	EndIf
	
End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function DrawScoreTable()
	
	For p.player = Each player
		count = count + 1
	Next
	
	baseX = (GraphicsWidth()-350)/2
	baseY = (GraphicsHeight()-(35+20*count))/2
	
	Color 0,0,0
	Rect baseX,baseY,350,35+20*count,1
	
	Color 255,192,0
	Rect baseX,baseY,350,35+20*count,0
	
	Text baseX+10,baseY+10,"Player          Kills     Deaths     Ping"
	Line baseX,baseY+25,baseX+349,baseY+25
	
	For p.player = Each player
		
		Color 255,255,255
		If p\id = localID Then Color 255,100,100
		
		i = i + 1
		Text baseX+10,baseY+10+20*i,p\name
		Text baseX+157,baseY+10+20*i,p\kills,1,0
		Text baseX+240,baseY+10+20*i,p\deaths,1,0
		Text baseX+322,baseY+10+20*i,p\ping,1,0
	Next
	
End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function UpdateChaseCam(camera,player) ; thanks to jfk EO-11110 on bb forums for this function !
	PositionEntity camera,EntityX(player,1),EntityY(player,1),EntityZ(player,1)
	ResetEntity camera
	x#=EntityX(player)+Sin(-EntityYaw(player)+180)*x_dis#
	y#=EntityY(player)+y_dis#
	z#=EntityZ(player)+Cos(-EntityYaw(player)+180)*z_dis#
	obstacle=LinePick(EntityX(player),EntityY(player),EntityZ(player),(x-EntityX(player)),y_dis#,(z-EntityZ(player)),0.1)
	If obstacle=0
		new_x#=x
		new_y#=y
		new_z#=z
	Else
		new_x#=PickedX()
		new_y#=PickedY()
		new_z#=PickedZ()
	EndIf
	If bounce_cam=0
		PositionEntity camera,new_x,new_y,new_z
	Else
		x=old_x+((New_x-old_x)/bounce_div#)
		y=old_y+((New_y-old_y)/bounce_div#)
		z=old_z+((New_z-old_z)/bounce_div#)
		PositionEntity camera,x,y,z
	EndIf
	PointEntity camera,player
	TurnEntity camera,-20,0,0     ; if you want the player mesh more on the bottom of the screen
	old_x#=EntityX(camera)
	old_y#=EntityY(camera)
	old_z#=EntityZ(camera)
End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function CreateScene()
	
	texture = TextureCreate(128)
	
	ground = CreatePlane()
	EntityColor ground,150,150,150
	EntityTexture ground,texture
	
	cube = CreateCube():EntityColor cube,150,200,150
	ScaleEntity cube,5,5,5:PositionEntity cube,0,5,0
	EntityTexture cube,texture
	
	sphere = CreateSphere(16):EntityColor sphere,200,150,150
	ScaleEntity sphere,3,1,3:PositionEntity sphere,0,9.7,0
	
	platform = CreateCube():EntityColor platform,150,150,200
	ScaleEntity platform,3,1,10:PositionEntity platform,0,4.13,-13.15
	TurnEntity platform,-30,0,0
	EntityTexture platform,texture
	
	; spawnpoint 
	spawner1 = CreateSphere() :EntityColor spawner1 ,150,150,150;  &lt;&lt;&lt;&lt;
	ScaleEntity spawner1 ,2,3,2:PositionEntity spawner1 ,-20,.1,-20 ;&lt;&lt;&lt;&lt;
	EntityTexture spawner1 ,texture
	
	column= CreateCylinder()
	ScaleEntity column,2,3,2:PositionEntity column,20,.1,20 ;&lt;&lt;&lt;&lt;
	EntityTexture column,texture
	
	FreeTexture texture
	
	
	
	EntityType ground,1:EntityPickMode ground,2
	EntityType cube,1:EntityPickMode cube,2
	EntityType sphere,1:EntityPickMode sphere,2
	EntityType platform,1:EntityPickMode platform,2
	EntityType spawner1,1:EntityPickMode spawner1,2
	EntityType column,1:EntityPickMode column,2


	
	; setup light..
	light = CreateLight()
	TurnEntity light,30,70,0
	
	; create health upgrade items.	
	CreateHealthItem(0,12,0)
	CreateHealthItem(0,1,-10)
	CreateHealthItem(0,3,-20)
	
	
	;; COLLISIONS
	Collisions 2,1,2,3 ; player to scene
	Collisions 2,2,1,3 ; player to player
	
	Collisions 3,1,2,1 ; bullet to scene
	Collisions 3,2,1,1 ; bullet to player
	
	Collisions 2,4,1,2 ; player to health
	
End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function TextureCreate(size)
	texture = CreateTexture(size,size,9)
	SetBuffer TextureBuffer(texture)
	Color 255,255,255
	Rect 0,0,size,size,1
	Color 0,0,0
	Rect 0,0,size,size,0
	Line 0,0,size,size
	Line 0,size,size,0
	SetBuffer BackBuffer()
	Return texture
End Function
</textarea><br><br><br>All fine now, but I also noticed what appears to be a very slight performance slowdown when using:<br><pre class=code>
Collisions type_chara, type_scene ,meth_elp_to_pol  , resp_sli2 ; player to scene
Collisions type_chara, type_chara ,meth_elp_to_elp  , resp_sli2 ; player to player
	
Collisions type_projc, type_scene ,meth_elp_to_pol  , resp_stop ; bullet to scene
Collisions type_projc, type_chara ,meth_elp_to_elp  , resp_stop ; bullet to player
	
Collisions type_chara, type_healt ,meth_elp_to_elp  , resp_sli1 ; health powerup to player
	
</pre><br>instead of:<br><pre class=code>
Collisions 2,1,2,3 ; player to scene
Collisions 2,2,1,3 ; player to player
	
Collisions 3,1,2,1 ; bullet to scene
Collisions 3,2,1,1 ; bullet to player
	
Collisions 2,4,1,2 ; player to health
</pre><br><br>-Is Blitz really taking a bit of a punch when using global variables for these kind of matters? Are constants better performance wise? I thought it shouldn't make any difference, only would contribute to easy usage. Also running from iDEal shouldn't make a difference right, as it's using the same compiler stuff? <br><br></td></tr></table><br>
<a name="1291409"></a>

<a name="1291410"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Flanker</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#118">[#118]</a></td></tr></table></td></tr><tr ><td class="posttext"> @Rick Nasher<br>I always see that people use constants to set collisions types, because there is no point to change them during the game. Using constants for that is just to avoid to have to remember that 3 is bullet type, 1 is elipsoid to elipsoid etc... But this shouldn't make a performance difference I guess...<br><br>The anti spawn kill dome is a good idea :D<br><br>@RemiD<br><div class="quote"> Another way which may work (not tested) would be to have 2 hidden skeleton with the same animations. And one skeleton for the character.<br>When you want to animate the character, you animate one hidden skeleton with the animation run, then you get the rotations/positions of the joints/bones of the lower body and you use rotateentity/positionentity to rotate/position the joints/bones of the lower body of your character.<br>Then you animate the other hidden skeleton with the animation shoot, then you get the rotations/positions of the joints/bones of the upper body and you use rotateentity/positionentity to rotate/position the joints/bones of the upper body of your character. <br></div><br>Yes you're right, that would be the best solution. Quite surprising that Blitz3D doesn't handle that natively. <br><br></td></tr></table><br>
<a name="1291419"></a>

<a name="1291421"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rick Nasher</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#119">[#119]</a></td></tr></table></td></tr><tr ><td class="posttext"> It's randomly selecting between 2 re-entry places, so less easy to hang round at the same spot and shoot on site. <br><br></td></tr></table><br>
<a name="1291422"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Guy Fawkes</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#120">[#120]</a></td></tr></table></td></tr><tr ><td class="posttext"> I'm on chat you guys :)<br><br>~GF <br><br></td></tr></table><br>
<a name="1291425"></a>

<a name="1291426"></a>

<a name="1291427"></a>

<a name="1291428"></a>

<a name="1291455"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >RemiD</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#121">[#121]</a></td></tr></table></td></tr><tr ><td class="posttext"> @Flanker&gt;&gt;If i remember correctly there is a blitz3d function to get the current animframe (after the animation has been updated) and also a blitz3d function to set the current animframe (before the animation is updated).<br>This would allow you to use only one skeleton for all characters and only store the current animframe of the lowerbody and the current animframe of the upper body after the animations have been updated.<br><br>(That's why i have asked Bobysait recently to take a look at the Blitz3d source code, to see if there is a way to separate updateworld() in 2 separate functions like updateanimations() and detectcollisions(), so that we could update animations or collisions separately, or even better would be the possibility to update an animation per animated entity...) <br><br></td></tr></table><br>
<a name="1291459"></a>

<a name="1291460"></a>

<a name="1291462"></a>

<a name="1291463"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >stayne</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#122">[#122]</a></td></tr></table></td></tr><tr ><td class="posttext"> Take a look at the .md3 (Quake 3) animation importer/format for torso/legs animations.<br><br><a href="http://www.blitzmax.com/Community/posts.php?topic=30083" target="_blank">http://www.blitzmax.com/Community/posts.php?topic=30083</a><br><br><a href="http://www.oocities.org/drago_blitz/" target="_blank">http://www.oocities.org/drago_blitz/</a><br><br>Also you might want to write some code that checks the enemy(s) coordinates and then pick the farthest spawn point to prevent spawn camping. <br><br></td></tr></table><br>
<a name="1291533"></a>

<a name="1291534"></a>

<a name="1291535"></a>

<a name="1291537"></a>

<a name="1291538"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rick Nasher</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#123">[#123]</a></td></tr></table></td></tr><tr ><td class="posttext"> Added: <br>-Different health strengths and spawn times for each item, so have different value to the player when picked up and also the higher the value the longer it takes for the health item  to get re-spawn, so gets more rare.<br>-Hide entities names when can't see each other(obscurers), so no more psychic abilities to see each other coming for a mile. Effectively: can now play hide and seek/sneak. ;-)<br><br>full code:<br><textarea class=codebox name="code" wrap=OFF readonly="true" rows="15" cols="80">

;last known good.
;added differemt health strengths and spawm times.
;added hide entities names when cant see each other.

SeedRnd MilliSecs()

Const gameLogicFPS = 60

; first we include the network library
Include "UDPNetwork_lib.bb"
; for converting RGB values to "Tri-Hex" stringc inlude hex8.
Include "Hex8.bb" ;&lt;&lt;&lt; Colored txt mod by Raster Ron 

Global localID
;Global localName$ = Input("Enter your name : ")
;If localName = "" Then localName = "player" + Rand(100,999)


;&lt;&lt; Enter through mod..
Global localName$ = "", defaultName$ = "RCX" ; Predefined name, so just need To press enter.

Print "Change default name: '"+ defaultName$ +"' ?"
Choic$ = Input$("[Press [Y]es or [ENTER] for No: ")
If Choic$="y" Then ; so want to change..
	Cls:Locate 0,0
	Print "Type name &amp; press [ENTER] or"
	ChangeName$=Input$("just [ENTER] to autogenerate: ")
	If ChangeName$="" ; so pressed enter to autogen..
		localName = "player" + Rand(100,999)
	Else ; so entered a new name..
		localName$=ChangeName$
	EndIf
Else ; so entered without input.
	localName$ = defaultName$
EndIf
;&lt;&lt; End enter through mod.




Global localPlayerMesh

Type player
	Field id
	Field name$
	Field ping
	
	Field life
	Field kills
	Field deaths
	
	Field mesh
	Field r,g,b
	
	Field nextX#,nextY#,nextZ#
	Field previousX#,previousY#,previousZ#
	Field nextYaw#
	Field previousYaw#
	Field nextTime
	Field previousTime
	
	Field lastPacket
	
	Field currentY#
	Field velocityY#
End Type

Type bullet
	Field mesh
	Field angle#
	Field time
	Field id ; id of player who fired
End Type

Type health
	Field mesh
	Field pickupTime ; to store when was pickedup and can hide for a certain time set in 
	Field respawnDelay ; &lt; see above
	
	;Field id  ; to hold healthitem's id
	Field power ; to hold strength of upgrade
	;Field pid ; id of player who updated health
End Type



;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
; Camera code from jfk EO-11110, thanks
Global bounce_cam=1 ;  smooth camera motion? (0/1)
Global bounce_div#=10.0 ; the higher, the more sluggish the camera will follow. Recc: 3.0 to 20.0
; some globals used by ChaseCam
Global old_x#,old_y#,old_z#
; desired distance between camera and player mesh
Global x_dis#=7.0,y_dis#=3,z_dis#=7.0,y_dis_or#=y_dis#
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;

; network init ----------------------------------------;
Global localMode = Net_StartInput() ; bring the library "console" to connect

If localMode = 1 Or localMode = 2 ; 1 means we are client, 2 means we are server
	
	localID = Net_CreatePlayer(localName) ; this command inits the server or local client
	
	If localID = 0 ; error
		Net_StopNetwork() ; close the network properly
		RuntimeError("Failed to create player.")
	EndIf
	
	If localMode = 1 Then AppTitle("Client : " + localName + " (port:" + net_port + "/ ID=" + localID + ")")
	If localMode = 2 Then AppTitle("Server : " + localName + " (port:" + net_port + "/ ID=" + localID + ")")
	
Else ; error
	Net_StopNetwork()
	RuntimeError("Failed to start game.")
EndIf
;------------------------------------------------------;

Graphics3D 640,480,32,2
SetBuffer BackBuffer()

CreateScene()

Global camera = CreateCamera()
CameraRange camera,0.1,1000

; create our own local player
localPlayerMesh = CreatePlayer(localID,localName)
old_x = EntityX(localPlayerMesh):old_y = EntityY(localPlayerMesh):old_z = EntityZ(localPlayerMesh) ; update camera position

; we send our color to the server
p.player = Object.player(GetPlayer(localID))
Net_SendMessage(3,p\r + "/" + p\g + "/" + p\b)

; &lt;&lt;&lt; colored txt mod by Raster Ron..
;store colors for chattxt.
Global cR = p\r 
Global cG = p\g 
Global cB = p\b 
; &lt;&lt;&lt; end colored txt mod by Raster Ron..


; variables used to send our positions at a constant delay (saves bandwidth but makes a constant ping)
Global updatePosition = MilliSecs()
Global updateTick = 50

; chat
Global messageDisplayNumber = 10
Global messageOffset
Dim message$(messageDisplayNumber)

Global chatMode
Global chatMessage$ = localName + "&gt; "
Global chatMillisecs = MilliSecs()
Global chatCursor

.mainLoop
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
tweeningPeriod = 1000 / gameLogicFPS
tweeningTime = MilliSecs() - tweeningPeriod
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
While Not KeyHit(1)
	
	;; I use tweening from castle demo here :
	;;
	;; 		- this allows to have very fast execution outside the tweening loop,
	;; 		  so the network is updated as fast as possible (needs Flip False)
	;;
	;; 		- this makes the game logic updated at a constant rate (Const FPS=)
	;;		  so no need to set deltatime (and it saves CPU time for other things)
	
	
	;; -------------------------------------------------------------------------------------------------; FAST EXECUTION (outside of tweening)
	;; -------------------------------------------------------------------------------------------------;
	
	; see the function, the interpolation variables are set properly here
	UpdateNetwork()
	
	;; -------------------------------------------------------------------------------------------------;
	
	Repeat
		tweeningElapsed = MilliSecs() - tweeningTime
	Until tweeningElapsed
	tweeningTicks = tweeningElapsed / tweeningPeriod
	tweeningRate# = Float(tweeningElapsed Mod tweeningPeriod)/Float(tweeningPeriod)
	For k = 1 To tweeningTicks
		tweeningTime = tweeningTime + tweeningPeriod
		If k = tweeningTicks Then CaptureWorld
		
		;; ---------------------------------------------------------------------------------------------; MAIN UPDATE
		;; ---------------------------------------------------------------------------------------------;
		
		; update our player
		UpdateLocalPlayer()
		
		; the interpolation is made in this function
		UpdatePlayers()
		
		UpdateWorld()
		
		; update the bullets... only the server check for player kills
		UpdateBullets()
		
		UpdateHealthItems()
		
		UpdateChaseCam(camera,localPlayerMesh)
		
		;; ---------------------------------------------------------------------------------------------;
		
	Next
	
	RenderWorld tweeningRate
	
	;; -------------------------------------------------------------------------------------------------; 2D UPDATE
	;; -------------------------------------------------------------------------------------------------;
	
	DrawPlayersNames()
	DrawHealthItemStrengths()
	
	
	If KeyHit(28) And chatMode = 0 Then chatMode = 1:FlushKeys() ; Enter for chat on/off
	If chatMode = 1 Then UpdateChat()
	
	DrawMessages() 
	
	If KeyDown(15) Then DrawScoreTable() ; Tab for scores
	
	;; -------------------------------------------------------------------------------------------------;
	
	Flip
	
Wend
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;

Net_StopNetwork()

End

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function UpdateNetwork()
	
	; update incoming packets (better check ALL incoming messages so use While Wend)
	While Net_CheckMessage() ; will check for a new message and fill Net_MsgType, Net_MsgString$, Net_MsgFrom and Net_MsgTo variables so we can read it
		
		p.player = Object.player(GetPlayer(Net_MsgFrom)) ; get the player handle
		
		If Handle(p) = 0 And Net_MsgType &lt; 100 ; we received an update packet from a player we don't know
			; so we ask the server who he is and return because we can't update him for now
			; the server will resend us the info in a new player "100" message
			Net_RequestPlayer(Net_MsgFrom)
			Return
		EndIf
		
		Select Net_MsgType ; check the type of message
				
			Case 1 ; chat message
				
				NewMessage(Net_MsgString)
				
			Case 2 ; player position and angle, example of packing data into string
				
				offset1 = Instr(Net_MsgString,"/",1)
				offset2 = Instr(Net_MsgString,"/",offset1+1)
				offset3 = Instr(Net_MsgString,"/",offset2+1)
				
				p\previousX = p\nextX
				p\previousY = p\nextY
				p\previousZ = p\nextZ
				p\previousYaw = p\nextYaw
				
				p\nextX = Left(Net_MsgString,offset1-1)
				p\nextY = Mid(Net_MsgString,offset1+1,offset2-offset1-1)
				p\nextZ = Mid(Net_MsgString,offset2+1,offset3-offset2-1)
				p\nextYaw = Right(Net_MsgString,Len(Net_MsgString)-offset3)
				
				p\previousTime = p\nextTime
				p\nextTime = MilliSecs()
				
			Case 3 ; update player colors
				
				offset1 = Instr(Net_MsgString,"/",1)
				offset2 = Instr(Net_MsgString,"/",offset1+1)
				
				p\r = Left(Net_MsgString,offset1-1)
				p\g = Mid(Net_MsgString,offset1+1,offset2-offset1-1)
				p\b = Right(Net_MsgString,Len(Net_MsgString)-offset2)
				
				EntityColor p\mesh,p\r,p\g,p\b
				
			Case 4 ; a player fired
				
				CreateBullet(Net_MsgFrom)
				
			Case 5 ; a player lost some life
				
				p\life = Net_MsgString
				
			Case 6 ; a player killed another one
				
				k.player = Object.player(GetPlayer(Net_MsgString)) ; killed player ID in MsgData
				NewMessage(p\name + " killed " + k\name)
				
				ResetPlayer(k\id)
				
			Case 7 ; the server sends us score update for a player
				
				offset = Instr(Net_MsgString,"/",1)
				
				p\kills = Left(Net_MsgString,offset-1)
				p\deaths = Right(Net_MsgString,Len(Net_MsgString)-offset)
				
			Case 8 ; health pickup
				
				h.health = Object.health(Net_MsgString)
				HideEntity h\mesh
				h\pickupTime = MilliSecs()
				
				
			Case 100 ; new player connected, OR the server tells us who is already connected so we can create players when joining the game
				
				If localMode = 2
					For p.player = Each player
						Net_SendMessage(2,p\nextX + "/" + p\nextY + "/" + p\nextZ + "/" + p\nextYaw,p\id,Net_MsgFrom)
						Net_SendMessage(3,p\r + "/" + p\g + "/" + p\b,p\id,Net_MsgFrom)
						
						Net_SendMessage(5,p\life,p\id,Net_MsgFrom)
						Net_SendMessage(7,p\kills+"/"+p\deaths,p\id,Net_MsgFrom)
					Next
				EndIf
				
				NewMessage(Net_MsgString + " connected")
				CreatePlayer(Net_MsgFrom,Net_MsgString)
				
			Case 101 ; a player has quit
				
				For p.player = Each player
					If Net_MsgFrom = p\id
						NewMessage(p\name + " disconnected")
						FreeEntity p\mesh
						Delete p
					EndIf
				Next
				
			Case 102 ; host has changed
				
				For p.player = Each player
					If Net_MsgFrom = p\id
						If p\id = localID
							AppTitle("Server : " + localName + " (port:" + net_port + ")")
							NewMessage("You are the new host")
							localMode = 2
						Else
							NewMessage(p\name + " is the new host")
						EndIf					
					EndIf
				Next
				
			Case 103 ; ping update
				
				For p.player = Each player
					If Net_MsgFrom = p\id
						p\ping = Net_MsgString
					EndIf
				Next
				
		End Select
		
	Wend
	
End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function UpdateLocalPlayer()
	
	; update our player
	p.player = Object.player(GetPlayer(localID)) ; get our player
	
	; inputs
	If KeyDown(200) Or KeyDown(17) Then MoveEntity p\mesh,0,0,0.3  ; up
	If KeyDown(208) Or KeyDown(31) Then MoveEntity p\mesh,0,0,-0.3 ; down
	If KeyDown(203) Or KeyDown(30) Then TurnEntity p\mesh,0,3,0    ; left
	If KeyDown(205) Or KeyDown(32) Then TurnEntity p\mesh,0,-3,0   ; right
	
	; fire
	If MouseHit(1) Or KeyHit(157) ; left mse or right Ctrl
		Net_SendMessage(4,"")
		CreateBullet(localID)
	EndIf
	
	; jump
	If MouseHit(2) Or KeyHit(57) ; right mse or Spacebar
		; check if player is one the ground
		LinePick(EntityX(p\mesh),EntityY(p\mesh),EntityZ(p\mesh),0,-1.2,0)
		If PickedEntity()
			p\velocityY = 0.5 ; set "inverse" of gravity velocity
		EndIf	
	EndIf
	
	; we create a message type "2" for player position
	If MilliSecs()-updatePosition &gt; updateTick
		
		Net_SendMessage(2,EntityX(p\mesh) + "/" + EntityY(p\mesh) + "/" + EntityZ(p\mesh) + "/" + EntityYaw(p\mesh))
		updatePosition = MilliSecs()
	EndIf
	
End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function UpdatePlayers()
	
	For p.player = Each player
		
		If p\id &lt;&gt; localID ; update other players only
			
			;; LINEAR INTERPOLATION ;;;;;;;;;;
			
			If p\nextTime &lt;&gt; p\previousTime ; if both packets arrived at the same time, we can't interpolate
				
				curTime# = Float(MilliSecs()-p\nextTime) / Float(p\nextTime-p\previousTime) ; curTime will be ideally 0.0-1.0, if it's &gt; 1.0 then it performs extrapolation
				
				If curTime &gt; 1 Then curTime = 1 ; extrapolation gives anoying jittering effects
				
				; special fix for yaw as EntityYaw returns a value beetween +180 ans -180, the interpolation can go backward
				If p\previousYaw &lt; 0 Then p\previousYaw = p\previousYaw + 360
				If p\nextYaw &lt; 0 Then p\nextYaw = p\nextYaw + 360
				If Abs(p\nextYaw-p\previousYaw) &gt; 180
					If p\nextYaw &gt; p\previousYaw
						p\previousYaw = p\previousYaw + 360
					Else
						p\previousYaw = p\previousYaw - 360
					EndIf
				EndIf
				
				PositionEntity p\mesh,p\previousX+(p\nextX-p\previousX)*curTime,p\previousY+(p\nextY-p\previousY)*curTime,p\previousZ+(p\nextZ-p\previousZ)*curTime
				RotateEntity p\mesh,0,p\previousYaw+(p\nextYaw-p\previousYaw)*curTime,0
				
			Else
				
				PositionEntity p\mesh,p\nextX,p\nextY,p\nextZ
				RotateEntity p\mesh,0,p\nextYaw,0
				
			EndIf
			;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
			
			;ResetEntity p\mesh ; reset entity is useful here because of collisions
			
		Else ; update our player, basically it just compute gravity
			
			p\velocityY = p\velocityY - 0.03 ; fake gravity
			If EntityY(p\mesh) - p\currentY &gt;= 0 ; if player is not falling we limit the gravity
				If p\velocityY &lt; -0.03 Then p\velocityY = -0.03
			EndIf
			
			p\currentY = EntityY(p\mesh)
			TranslateEntity p\mesh,0,p\velocityY,0
			
		EndIf
	Next
	
End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function CreatePlayer(id,name$)
	
	For p.player = Each player
		If p\id = id Then Return ; player already connected
	Next
	
	p.player = New player
	p\id = id
	p\name = name
	
	p\life = 80
	
	;build player entity
	p\mesh = CreateSphere()
	EntityType p\mesh,2
	EntityRadius p\mesh,1
	
	NameEntity p\mesh,Handle(p)
	
	nose = CreateSphere(8,p\mesh):EntityColor nose,255,0,0
	PositionEntity nose,0,0,1
	ScaleEntity nose,0.3,0.3,0.3
	
	eyeLeft = CreateSphere(8,p\mesh):EntityColor eyeLeft,255,255,255
	PositionEntity eyeLeft ,.29,.4,.7;1
	ScaleEntity eyeLeft ,0.2,0.2,0.2
	
	pupilLeft = CreateSphere(8,p\mesh):EntityColor pupilLeft ,0,0,0
	PositionEntity pupilLeft ,.3,.4,.9;1
	ScaleEntity pupilLeft ,0.05,0.05,0.02
	
	eyeRight = CreateSphere(8,p\mesh):EntityColor eyeRight ,255,255,255
	PositionEntity eyeRight ,-.29,.4,.7;1
	ScaleEntity eyeRight ,0.2,0.2,0.2
	
	pupilRight = CreateSphere(8,p\mesh):EntityColor pupilRight ,0,0,0
	PositionEntity pupilRight ,-.3,.4,.9;1
	ScaleEntity pupilRight ,0.05,0.05,0.02
	
	unaBrow = CreateCone(8,1,p\mesh):EntityColor unaBrow ,0,0,0
	PositionEntity unaBrow ,0,.45,.7
	RotateEntity unaBrow ,-180,0,0
	ScaleEntity unaBrow ,.7,.2,.3
	
	;positions
	location=Rand (1,2)
	If location=1
	
		p\nextX = -20
		p\nextY = 6.5
		p\nextZ = -20
	
	Else 
	
		p\nextX = 20
		p\nextY = 6.5
		p\nextZ = 20
	EndIf
	p\nextYaw = -45
	
	p\previousX = p\nextX
	p\previousY = p\nextY
	p\previousZ = p\nextZ
	p\previousYaw = p\nextYaw
	
	p\r = Rand(255)
	p\g = Rand(255)
	p\b = Rand(255)
	EntityColor p\mesh,p\r,p\g,p\b
	
	PositionEntity p\mesh,p\nextX,p\nextY,p\nextZ
	RotateEntity p\mesh,0,p\nextYaw,0
	ResetEntity p\mesh
	
	p\currentY = p\nextY
	
	p\previousTime = MilliSecs()
	p\nextTime = MilliSecs()+1
	
	Return p\mesh
	
End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function ResetPlayer(id)
	
	p.player = Object.player(GetPlayer(id))
	
	p\life = 100
	
	location=Rand (1,2)
	If location=1
	
		p\nextX = -20
		p\nextY = 6.5
		p\nextZ = -20
	
	Else 
	
		p\nextX = 20
		p\nextY = 6.5
		p\nextZ = 20
	EndIf
	
	p\nextYaw = -45
	
	
	
	p\previousX = p\nextX
	p\previousY = p\nextY
	p\previousZ = p\nextZ
	p\previousYaw = p\nextYaw
	;back to origin.
	PositionEntity p\mesh,p\nextX,p\nextY,p\nextZ
	RotateEntity p\mesh,0,p\nextYaw,0
	ResetEntity p\mesh
	
	p\currentY = p\nextY
	
	p\previousTime = MilliSecs()
	p\nextTime = MilliSecs()+1
	
End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function GetPlayer(id)
	
	For p.player = Each player
		If p\id = id
			Return Handle(p)					
		EndIf
	Next
	
End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function DrawPlayersNames()
	
	For p.player = Each player
		If EntityVisible (p\mesh,camera)
			
			Color 255,255,255
			CameraProject(camera,EntityX(p\mesh),EntityY(p\mesh),EntityZ(p\mesh)) 	
		
			; only when not the host
			If p\id &lt;&gt; localID Then Text ProjectedX(),ProjectedY()-60,p\name,1,1 ; the more health, the brighter the color..
			
			Color 255,(255./100.)*p\life,(255./100.)*p\life ;?
			Text ProjectedX(),ProjectedY()-40,p\life,1,1
		EndIf
	Next
	
End Function
Function DrawHealthItemStrengths()
	
	For h.health = Each health
		If EntityVisible (h\mesh,camera)
			Color 255,0,0
			CameraProject(camera,EntityX(h\mesh),EntityY(h\mesh),EntityZ(h\mesh)) 
		
			Color 255,(255./100.)*h\power,(255./100.)*h\power
			If MilliSecs() - h\pickupTime &gt; h\respawnDelay Then ;ShowEntity h\mesh
				Text ProjectedX(),ProjectedY()-35,h\power,1,1
			EndIf
		EndIf
	Next
	
End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function CreateBullet(id)
	
	p.player = Object.player(GetPlayer(id))
	
	b.bullet = New bullet
	
	b\id = p\id
	
	b\mesh = CreateSphere(2)
	ScaleEntity b\mesh,0.2,0.2,0.2
	EntityColor b\mesh,255,255,0
	
	PositionEntity b\mesh,EntityX(p\mesh),EntityY(p\mesh),EntityZ(p\mesh)
	RotateEntity b\mesh,0,EntityYaw(p\mesh),0
	
	EntityType b\mesh,3
	EntityRadius b\mesh,0.2
	
	b\time = MilliSecs()
	
End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function UpdateBullets()
	
	For b.bullet = Each bullet
		
		MoveEntity b\mesh,0,0,1
		
		If CountCollisions(b\mesh)
			
			If localMode = 2 ; only the server compute bullets collision with player
				If GetEntityType(CollisionEntity(b\mesh,1)) = 2 ; a player is hit
					
					touchedPlayer.player = Object.player(EntityName(CollisionEntity(b\mesh,1)))
					touchedPlayer\life = touchedPlayer\life - 10
					
					If touchedPlayer\life &gt; 0 ; touched
						Net_SendMessage(5,touchedPlayer\life,touchedPlayer\id)
						Net_SendMessage(5,touchedPlayer\life,touchedPlayer\id,touchedPlayer\id)
					Else ; killed
						killerPlayer.player = Object.player(GetPlayer(b\id))
						
						killerPlayer\kills = killerPlayer\kills + 1
						touchedPlayer\deaths = touchedPlayer\deaths + 1						
						
						Net_SendMessage(6,touchedPlayer\id,killerPlayer\id)
						Net_SendMessage(6,touchedPlayer\id,killerPlayer\id,killerPlayer\id)
						
						Net_SendMessage(7,killerPlayer\kills+"/"+killerPlayer\deaths,killerPlayer\id)
						Net_SendMessage(7,killerPlayer\kills+"/"+killerPlayer\deaths,killerPlayer\id,killerPlayer\id)
						
						Net_SendMessage(7,touchedPlayer\kills+"/"+touchedPlayer\deaths,touchedPlayer\id)
						Net_SendMessage(7,touchedPlayer\kills+"/"+touchedPlayer\deaths,touchedPlayer\id,touchedPlayer\id)
						
						NewMessage(killerPlayer\name + " killed " + touchedPlayer\name)
						ResetPlayer(touchedPlayer\id)
					EndIf
					
				EndIf
			EndIf
			
			FreeEntity b\mesh
			Delete b
			
		ElseIf MilliSecs()-b\time &gt; 2000
			
			FreeEntity b\mesh
			Delete b
			
		EndIf
		
	Next
	
End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function CreateHealthItem(x#,y#,z#,power#,respawnDelay#)
	
	h.health = New health
	
	h\mesh = CreateMesh()
	
	h\power = power ; set item strength
	
	;h\respawnDelay = 10000
	h\respawnDelay = respawnDelay ; set according to valuableness(strength actually)..
	
	
	
	; create the object..
	mesh1 = CreateCube()
	mesh2 = CreateCube()
	
	ScaleMesh mesh1,.20,.5,.20
	ScaleMesh mesh2,.20,.5,.20:RotateMesh mesh2,90,0,0
	
	AddMesh(mesh1,h\mesh)
	AddMesh(mesh2,h\mesh)
	
	EntityColor h\mesh,255,0,0
	
	
	; if we are the host..
	If localMode = 2 Then EntityType h\mesh,4
	EntityRadius h\mesh,0.5
	
	PositionEntity h\mesh,x,y,z
	
	NameEntity h\mesh,Handle(h)
	
End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function UpdateHealthItems()
	
	For h.health = Each health
		
		TurnEntity h\mesh,0,-2,0
		
		If CountCollisions(h\mesh)
			
			If localMode = 2 ; only the server computes collision with player
				If GetEntityType(CollisionEntity(h\mesh,1)) = 2 ; a player collided
					
					touchedPlayer.player = Object.player(EntityName(CollisionEntity(h\mesh,1)))
					
					h\pickupTime = MilliSecs() ;store time of pickup 
					HideEntity h\mesh
					ResetEntity h\mesh ;empty collisions buffer for this entity
					
					Net_SendMessage(8,Handle(h))
					
					If touchedPlayer\life &lt; 100 ; touched healthpowerup..
						
						;touchedPlayer\life = touchedPlayer\life + 10
						;touchedPlayer\life = touchedPlayer\life + 50
						touchedPlayer\life = touchedPlayer\life + h\power
						
						If touchedPlayer\life &gt;100
							touchedPlayer\life = 100
							
						EndIf
						Net_SendMessage(5,touchedPlayer\life,touchedPlayer\id)
						Net_SendMessage(5,touchedPlayer\life,touchedPlayer\id,touchedPlayer\id)

					EndIf
					
				EndIf
			EndIf
			
		EndIf
		
		If MilliSecs() - h\pickupTime &gt; h\respawnDelay Then ShowEntity h\mesh
		
	Next
	
End Function
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function NewMessage(msg$)
	
	messageOffset = messageOffset + 1
	
	If messageOffset &gt; messageDisplayNumber
		
		messageOffset = messageOffset - 1
		
		For i = 2 To messageDisplayNumber
			message(i-1) = message(i)		
		Next
		
		message(messageDisplayNumber) = msg
		
	Else
		
		message(messageOffset) = msg
		
	EndIf
	
End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function DrawMessages()
	
	Color 255,255,255
	
	For i = 1 To messageOffset
		
		;Text 0,(i-1)*15,message(i)	
		
		; &lt;&lt;&lt; colored txt mod by Raster Ron
		loc = Instr (message(i), "",1)
		If loc &gt; 1 Then 
			colorMessage$ = Mid$(message(i), 1, Len(message(i)) - 7 ) 
			Hex$ = Right$(message(i),6)		 
			Set_Color_Hex(Hex$) 
			Text 0,(i-1)*15,colorMessage$ 
		Else  
			Color 255,255,255 
			Text 0,(i-1)*15,message(i) 
		End If	
		; &lt;&lt;&lt; End colored txt mod by Raster Ron
		
	Next
	
End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function UpdateChat()
	
	key = GetKey()
	
	If key
		If key = 13
			If chatMessage &lt;&gt; localName + "&gt; "
				For i = Len(localName + "&gt; ") To Len(chatMessage)
					If Mid(chatMessage,i,1) &lt;&gt; " "
					
						; &lt;&lt;&lt; colored txt mod by Raster Ron
						chatColor$ = RGB_To_TriHex(cR,cG,cB)
						chatMessage = chatMessage + "" + chatColor$
						; &lt;&lt;&lt; end colored txt mod by Raster Ron					
					
					
						Net_SendMessage(1,chatMessage)
						NewMessage(chatMessage)
						Exit
					EndIf
				Next
			EndIf
			chatMessage = localName + "&gt; "
			chatMode = 0
		ElseIf key = 8 And Len(chatMessage) &gt; Len ( localName + "&gt; " )
			chatMessage = Left(chatMessage,Len(chatMessage)-1)
		ElseIf key &gt; 31 And key &lt; 127
			chatMessage = chatMessage + Chr(key)
		EndIf
	EndIf
	
	Color 255,255,255
	Rect 0,GraphicsHeight()-20,GraphicsWidth(),20,1
	
	Color 0,0,0
	Rect 0,GraphicsHeight()-20,GraphicsWidth(),20,0
	
	
	If MilliSecs()-chatMillisecs &gt; 500
		chatCursor = Not chatCursor
		chatMillisecs = MilliSecs()
	EndIf
	
	If chatCursor
		Text 5,GraphicsHeight()-17,chatMessage + "|"
	Else
		Text 5,GraphicsHeight()-17,chatMessage
	EndIf
	
End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function DrawScoreTable()
	
	For p.player = Each player
		count = count + 1
	Next
	
	baseX = (GraphicsWidth()-350)/2
	baseY = (GraphicsHeight()-(35+20*count))/2
	
	Color 0,0,0
	Rect baseX,baseY,350,35+20*count,1
	
	Color 255,192,0
	Rect baseX,baseY,350,35+20*count,0
	
	Text baseX+10,baseY+10,"Player          Kills     Deaths     Ping"
	Line baseX,baseY+25,baseX+349,baseY+25
	
	For p.player = Each player
		
		Color 255,255,255
		If p\id = localID Then Color 255,100,100
		
		i = i + 1
		Text baseX+10,baseY+10+20*i,p\name
		Text baseX+157,baseY+10+20*i,p\kills,1,0
		Text baseX+240,baseY+10+20*i,p\deaths,1,0
		Text baseX+322,baseY+10+20*i,p\ping,1,0
	Next
	
End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function UpdateChaseCam(camera,player) ; thanks to jfk EO-11110 on bb forums for this function !
	PositionEntity camera,EntityX(player,1),EntityY(player,1),EntityZ(player,1)
	ResetEntity camera
	x#=EntityX(player)+Sin(-EntityYaw(player)+180)*x_dis#
	y#=EntityY(player)+y_dis#
	z#=EntityZ(player)+Cos(-EntityYaw(player)+180)*z_dis#
	obstacle=LinePick(EntityX(player),EntityY(player),EntityZ(player),(x-EntityX(player)),y_dis#,(z-EntityZ(player)),0.1)
	If obstacle=0
		new_x#=x
		new_y#=y
		new_z#=z
	Else
		new_x#=PickedX()
		new_y#=PickedY()
		new_z#=PickedZ()
	EndIf
	If bounce_cam=0
		PositionEntity camera,new_x,new_y,new_z
	Else
		x=old_x+((New_x-old_x)/bounce_div#)
		y=old_y+((New_y-old_y)/bounce_div#)
		z=old_z+((New_z-old_z)/bounce_div#)
		PositionEntity camera,x,y,z
	EndIf
	PointEntity camera,player
	TurnEntity camera,-20,0,0     ; if you want the player mesh more on the bottom of the screen
	old_x#=EntityX(camera)
	old_y#=EntityY(camera)
	old_z#=EntityZ(camera)
End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function CreateScene()
	
	texture = TextureCreate(128)
	
	ground = CreatePlane()
	EntityColor ground,150,150,150
	EntityTexture ground,texture
	
	cube = CreateCube():EntityColor cube,150,200,150
	ScaleEntity cube,5,5,5:PositionEntity cube,0,5,0
	EntityTexture cube,texture
	
	sphere = CreateSphere(16):EntityColor sphere,200,150,150
	ScaleEntity sphere,3,1,3:PositionEntity sphere,0,9.7,0
	
	platform = CreateCube():EntityColor platform,150,150,200
	ScaleEntity platform,3,1,10:PositionEntity platform,0,4.13,-13.15
	TurnEntity platform,-30,0,0
	EntityTexture platform,texture
	
	; spawnpoint 
	spawner1 = CreateSphere() :EntityColor spawner1 ,150,150,150;  &lt;&lt;&lt;&lt;
	ScaleEntity spawner1 ,2,3,2:PositionEntity spawner1 ,-20,.1,-20 ;&lt;&lt;&lt;&lt;
	EntityTexture spawner1 ,texture
	
	column= CreateCylinder()
	ScaleEntity column,2,3,2:PositionEntity column,20,.1,20 ;&lt;&lt;&lt;&lt;
	EntityTexture column,texture
	
	FreeTexture texture
	
	
	
	EntityType ground,1:EntityPickMode ground,2
	EntityType cube,1:EntityPickMode cube,2
	EntityType sphere,1:EntityPickMode sphere,2
	EntityType platform,1:EntityPickMode platform,2
	EntityType spawner1,1:EntityPickMode spawner1,2
	EntityType column,1:EntityPickMode column,2


	
	; setup light..
	light = CreateLight()
	TurnEntity light,30,70,0
	
	; create health upgrade items.	
	CreateHealthItem(0,12,0,100,100000) ; the one on top
	CreateHealthItem(0,1,-10,10,10000)  ; undenneath the ramp
	CreateHealthItem(0,3,-20,30,30000)  ; on the ramp
	
	
	;; COLLISIONS
	Collisions 2,1,2,3 ; player to scene
	Collisions 2,2,1,3 ; player to player
	
	Collisions 3,1,2,1 ; bullet to scene
	Collisions 3,2,1,1 ; bullet to player
	
	Collisions 2,4,1,2 ; player to health
	
End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function TextureCreate(size)
	texture = CreateTexture(size,size,9)
	SetBuffer TextureBuffer(texture)
	Color 255,255,255
	Rect 0,0,size,size,1
	Color 0,0,0
	Rect 0,0,size,size,0
	Line 0,0,size,size
	Line 0,size,size,0
	SetBuffer BackBuffer()
	Return texture
End Function
</textarea><br><br>BTW: change your default player name so you don't need to type it in every time in the line:<br><pre class=code>
Global localName$ = "", defaultName$ = "RCX" ; Predefined name, so just need To press enter.
</pre><br>You can then just press enter when the playername question comes up.<br>(will develop a neat and decent frontend with saveable prefs later, this is just easy for testing) <br><br></td></tr></table><br>
<a name="1291545"></a>

<a name="1291547"></a>

<a name="1291549"></a>

<a name="1291560"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >RemiD</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#124">[#124]</a></td></tr></table></td></tr><tr ><td class="posttext"> A note about lower body animation and upper body animation : recently i have taken a look at how the animations of the game Rune (same engine than Unreal tournament) were made and i was surprised to see that the animations of  the lower body and of the upper body were not separated but mixed. For example, there is an idle animation and an idle + shoot/attack animation, and a run forward animation and a run forward + shoot/attack animation, etc... Unlike some games (Quake 3 ?) where there are 2 skeletons, one for the lower body, one for the upper body... <br><br></td></tr></table><br>
<a name="1291558"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rick Nasher</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#125">[#125]</a></td></tr></table></td></tr><tr ><td class="posttext"> @RemiD:<br>That's rather peculiar. When I'm ready to move onto the character animation stage, I want to be able to cut/shoot off limbs(arms,legs eventually the head :D  ) with for instance a sword or gun. I've seen it been done in an little codearchive example: <br><a href="http://www.blitzbasic.com/codearcs/codearcs.php?code=1736" target="_blank">http://www.blitzbasic.com/codearcs/codearcs.php?code=1736</a><br><br>But haven't really gone into depth analyzing code, skeletons etc, so not entirely sure where the magic happens. Sofar I only used premade animated MD2 and B3D models. <br><br>-You think something like that would be possible in Blitz3d or should I go for a more simple approach? <br><br></td></tr></table><br>
<a name="1291562"></a>

<a name="1291564"></a>

<a name="1291565"></a>

<a name="1291566"></a>

<a name="1291567"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >RemiD</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#126">[#126]</a></td></tr></table></td></tr><tr ><td class="posttext"> @Rick&gt;&gt;Destroying body parts has nothing to do with having separate skeletons or animations for the lower body and for the upper body, but rather how you can rebuild your mesh in code with parts (notskinned or skinned).<br><br>For this there are 2 methods, either you use separate notskinned parts ("limbs") and you build the character by positioning orienting each part depending on the appropriate joint/bone, then set it as child of the joint/bone so that it will turn move with the joint/bone, or you use separate skinned parts and you build the character by recreating the rigged skinned mesh with a skeleton (joints/bones) + the necessary skinned meshes (body parts, clothes, armors)<br>For this you will need to use the upgrade vB by Bobysait here : <a href="http://www.blitzbasic.com/Community/posts.php?topic=105408" target="_blank">http://www.blitzbasic.com/Community/posts.php?topic=105408</a> (it is doable but not easy to do, because you need to model your mesh in a certain way so that some body parts can be removed without messing the skinning near the joints...)<br><br>(i don't understand the usefulness of the lib that you linked to...) <br><br></td></tr></table><br>
<a name="1291579"></a>

<a name="1291580"></a>

<a name="1291581"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rick Nasher</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#127">[#127]</a></td></tr></table></td></tr><tr ><td class="posttext"> Thanks for the explanation RemiD. The code example was just one where the dwarf cuts the other guy in half.<br><img src="http://i67.tinypic.com/2m2um92.jpg"> <br><br></td></tr></table><br>
<a name="1291602"></a>

<a name="1291604"></a>

<a name="1291607"></a>

<a name="1291608"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >RemiD</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#128">[#128]</a></td></tr></table></td></tr><tr ><td class="posttext"> @Rick&gt;&gt;Can you share the code example + files, the link does not seem to work anymore.<br>Thanks, <br><br></td></tr></table><br>
<a name="1291643"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Flanker</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#129">[#129]</a></td></tr></table></td></tr><tr ><td class="posttext"> If i'm not wrong Quake III use 2 different meshes for animations, one for legs/pelvis and another for the upper body so they are not connected in the middle. It's an easy way but not the best looking IMO (and I'm a Q3 fan !). I'll try RemiD's suggestion to merge animations, it shouldn't be too heavy to compute for a low players count.<br><br>Currently i'm on another project so the network library and example won't advance much for some time...<br><br>@Rick Nasher I didn't go deep in skeletons and animations with B3D too, the only test I made was the same animated mesh from CFX converted to B3D, X and MD2. MD2 was by far the lightest to use in Blitz3D, but it doesn't use skeletons so impossible to place a weapon in the hand for example, and vertices positions were not accurate. MD2 can be very useful to render a lot of animated meshes though, in an RTS for example. <br><br></td></tr></table><br>
<a name="1291672"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rick Nasher</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#130">[#130]</a></td></tr></table></td></tr><tr ><td class="posttext"> @Flanker:<br>I'm already very grateful for the work you did on the library and examples so far. Appears to be working quite good and stable so many many thanks for that, this was just what I was looking for and apparently not only me. CFX probably is the way to go then I guess for the example was looking pretty good already. BTW if it looks like you're not going to be working on it for some time, then I hope you are willing to share what you achieved up till now, for I'm pretty sure I/we can learn a lot from what you've done to accomplish all that?<br><br>@RemiD:<br>Oh, thought you would have known the anim example, for it was pretty common little while back. Good thing I've downloaded pretty much nearly all that's Blitz3d :-) so here you go: <a href="https://www.mediafire.com/?8993lt60m5jl1zc" target="_blank">1736(animation).rar</a> <br><br></td></tr></table><br>
<a name="1291687"></a>

<a name="1291688"></a>

<a name="1291689"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >RemiD</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#131">[#131]</a></td></tr></table></td></tr><tr ><td class="posttext"> @Rick&gt;&gt;Thanks, i had not seen this code example...<br>I have taken a look at the code and the meshes.<br>The character which is cut is made in separate notskinned parts ("limbs"), and as i have explained in my previous post, each part is probably set as a child of a joint/bone, and in this example the character is not cut but rather its parts ("limbs") are separated by the animation... <br><br>But now that we have the upgrade vB, we can get the position of skinned vertices so it is probably possible to code a routine to decide where to destroy a mesh and rebuild several static parts in code and then use a physics system (or a simple random linearvelocity + random angularvelocity + gravity) to make the parts turn move, rebound, until they reach the ground. (if that's your thing :P) <br><br></td></tr></table><br>
<a name="1291698"></a>

<a name="1291700"></a>

<a name="1291702"></a>

<a name="1291703"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rick Nasher</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#132">[#132]</a></td></tr></table></td></tr><tr ><td class="posttext"> You're welcome. Sounds pretty cool to me. Dunno if you know/remember the decapitation action scene in Barbarian on the Amiga: <iframe width="560" height="345" src="http://www.youtube.com/embed/C4Ii_YfJNvw" frameborder="0" allowfullscreen></iframe><br>Now that should look awesome in a 3d knight kinda game. (love te troll/lizard kicking the head and dragging the body btw lol) <br><br></td></tr></table><br>
<a name="1291769"></a>

<a name="1291770"></a>

<a name="1291772"></a>

<a name="1291780"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >RemiD</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#133">[#133]</a></td></tr></table></td></tr><tr ><td class="posttext"> If you like this kind of action games with sword axe hammer fighting, i suggest to try Rune, Severance : blade of darkness, Drakan : order of the flame, Blood omen 2. <br><br></td></tr></table><br>
<a name="1291811"></a>

<a name="1291813"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Flanker</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#134">[#134]</a></td></tr></table></td></tr><tr ><td class="posttext"> @Rick Nasher<br>If you want to take a look, here is what I have for animations for the moment : <a href="http://www.mediafire.com/download/t554acdttuhhgsc/animtest.zip" target="_blank">http://www.mediafire.com/download/t554acdttuhhgsc/animtest.zip</a><br><br>Turn around with mouse, fire with mouse left, move with ZQSD or WASD and crouch with left shift. Change weapons with 1,2,3.<br><br>Next step would be to add all of that in types and functions to handle players like in the network example, maybe add bones collider adjusted properly for bullets and finally recode the network example. For collisions with the scene, I think 2 or 3 spheres would be enough for each player. <br><br></td></tr></table><br>
<a name="1291845"></a>

<a name="1291856"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rick Nasher</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#135">[#135]</a></td></tr></table></td></tr><tr ><td class="posttext"> @Flanker:<br>Ah thought you went for the networking thing right away. Nevertheless interesting piece of code, as always. Many thanks.<br><br>@RemiD:<br>Can't say I've played these games, I'm not a fanatic gamer, but I've heard of some of these indeed, like Rune. Some things could be done better I believe. <br><br></td></tr></table><br>
<a name="1291860"></a>

<a name="1291863"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rick Nasher</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#136">[#136]</a></td></tr></table></td></tr><tr ><td class="posttext"> [double post] <br><br></td></tr></table><br>
<a name="1292267"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rick Nasher</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#137">[#137]</a></td></tr></table></td></tr><tr ><td class="posttext"> Hmm. ResetPlayer (when killed) doesn't appear to always update the new position of the usage to the other players correctly. Perhaps it needs a separate update..? <br><br></td></tr></table><br>
<a name="1292322"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Flanker</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#138">[#138]</a></td></tr></table></td></tr><tr ><td class="posttext"> This can only happen if the killed player didn't receive the notification that he was killed, so he will still send his "normal" position. For the moment there is nothing to ensure packets arrival in the library or in the example, so you can experience that with any packet... That's what I called "important" messages. They definitely need to be checked for arrival. Something that could be handled by TCP.<br><br>Eventually you can create a new message type for player reset, and send it 10 times to the killed player but that's a dirty hack... <br><br></td></tr></table><br>
<a name="1292329"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Guy Fawkes</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#139">[#139]</a></td></tr></table></td></tr><tr ><td class="posttext"> Any updates yet, Flanker?<br><br>~GF <br><br></td></tr></table><br>
<a name="1292333"></a>

<a name="1292334"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rick Nasher</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#140">[#140]</a></td></tr></table></td></tr><tr ><td class="posttext"> Well, dirty or not, it's better than nothing. I'll try to go the 10x road, otherwise it's looking funny. <br><br></td></tr></table><br>
<a name="1292335"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >stayne</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#141">[#141]</a></td></tr></table></td></tr><tr ><td class="posttext"> You might want to try hiding the mesh before positioning during a resetplayer due to collisions. <br><br></td></tr></table><br>
<a name="1292353"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rick Nasher</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#142">[#142]</a></td></tr></table></td></tr><tr ><td class="posttext"> Hmm, well dunno if that would help for when re-spawning on getting killed the player sometimes doesn't show up on the correct spot for all players, however for the player itself (locally)it appears in the normal spot. This probably means it doesn't transmit/receive the data probably to the other players. But worth the try. won't hurt.. <br><br></td></tr></table><br>
<a name="1292476"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >stayne</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#143">[#143]</a></td></tr></table></td></tr><tr ><td class="posttext"> Ah I see what you mean.  Probably due to the x/y/z packets being transmitted outta whack. <br><br></td></tr></table><br>
<a name="1292484"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rick Nasher</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#144">[#144]</a></td></tr></table></td></tr><tr ><td class="posttext"> Strangely enough, not noticeable(or at least not that I can see) when just moving round etc. Only happens when resetting the entity at the spawn location. Also I never noticed it before, until I introduced another spawn location for it to choose between randomly. Don't get why that would be occurring. Perhaps more packets are missed normally but doesn't show due to interpolation? <br><br></td></tr></table><br>
<a name="1292501"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rick Nasher</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#145">[#145]</a></td></tr></table></td></tr><tr ><td class="posttext"> [Update]<br>In <b>UpdatePlayers()</b> I changed the line:<br><pre class=code>
If p\id &lt;&gt; localID  ; update other players only
</pre><br>into:<br><pre class=code>
If p\id &lt;&gt; localID  And p\nextX&lt;&gt;-20 And  p\nextZ&lt;&gt;-20 And p\nextX&lt;&gt;20 And p\nextZ&lt;&gt;20 ; update other players only
</pre><br>Thinking it might have been because of the interpolation routine there, for the player reset difference between locations is much larger then the usual difference between movements when a packet was dropped. Even more strengthened in my believe was that the player would appear half way spawn platforms.<br><br>However above code doesn't have the desired effect: <i>the player shows up at spawn location1 while should be at spawn location2. So it appears this has something to with it indeed. Not sure how to fix it yet though..</i> <br><br></td></tr></table><br>
<a name="1292509"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Guy Fawkes</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#146">[#146]</a></td></tr></table></td></tr><tr ><td class="posttext"> Can't you just add some special code that will only check CERTAIN packets before they're sent to ensure this doesn't happen? That way it's like a FAST version of TCP. =)<br><br>~GF <br><br></td></tr></table><br>
<a name="1292520"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rick Nasher</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#147">[#147]</a></td></tr></table></td></tr><tr ><td class="posttext"> Well, not me. Way above my network skill stuff.<br>Love this library though working on a front end for the settings etc. Even did an ugly little test logo for the gui - nothing final, was late  :-) - just a try for size/positioning on the gui screen.<br><img src="http://i65.tinypic.com/i2mzqe.jpg"><br>But this is an issue that requires a fix/workaround. <br><br>Next I'll try Flanker's suggestion, but my guess is that it's because of the interpolation working on positions constantly, while should only be when moving around normally I think(may be wrong). <br><br></td></tr></table><br>
<a name="1292521"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Guy Fawkes</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#148">[#148]</a></td></tr></table></td></tr><tr ><td class="posttext"> <pre class=code>If KeyDown ( blah ) Then MoveEntity ( ent, ..., ..., ... ) : moving = 1

If moving = 1 THEN activate_interpolation = 1</pre> <br><br></td></tr></table><br>
<a name="1292523"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rick Nasher</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#149">[#149]</a></td></tr></table></td></tr><tr ><td class="posttext"> Is an idea I was thinking about too. However the result is still the same:<br><img src="http://i64.tinypic.com/28vawif.jpg"> <br><br></td></tr></table><br>
<a name="1292532"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Guy Fawkes</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#150">[#150]</a></td></tr></table></td></tr><tr ><td class="posttext"> What about if the packet drops then realign to the default spawn point? <br><br></td></tr></table><br>
<a name="1292534"></a>

<a name="1292536"></a>

<a name="1292537"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rick Nasher</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#151">[#151]</a></td></tr></table></td></tr><tr ><td class="posttext"> @ GF: Uh, but how would you know package dropped? If that happens could just as well go to the other spawn point. BTW; Did you try the modified example in post <a href="/post.php?topic=105608&amp;post=1291538" target="_blank">#123</a>?<br><br>If you like we can try see if online is different? ;-) <br><br></td></tr></table><br>
<a name="1292544"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Guy Fawkes</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#152">[#152]</a></td></tr></table></td></tr><tr ><td class="posttext"> Yes! Lets DO this! &lt;3<br><br>~GF <br><br></td></tr></table><br>
<a name="1292548"></a>

<a name="1292551"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rick Nasher</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#153">[#153]</a></td></tr></table></td></tr><tr ><td class="posttext"> Well I'm in the usual chat. I'll let you kill me if you like. But it's a bit less easy because of the hidden stuff. ;-)<br><br><a href="http://webchat.quakenet.org/" target="_blank">http://webchat.quakenet.org/</a><br>channel #UDPNetwork_lib <br><br></td></tr></table><br>
<a name="1292557"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rick Nasher</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#154">[#154]</a></td></tr></table></td></tr><tr ><td class="posttext"> @Flanker: too busy to join? It's funny. The odd spawning bug isn't manifesting itself anymore right now somehow. <br><br></td></tr></table><br>
<a name="1292593"></a>

<a name="1292607"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rick Nasher</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#155">[#155]</a></td></tr></table></td></tr><tr ><td class="posttext"> Ok played round a bit. We(GF and me) added some stuff to it(not wise, should focus on bug fixing,  but nevertheless much fun):<br>-no more spinning when clicked outside window and keycodes (GF)<br>-crude audio, 2 min add-on, shot and boom sounds(me).<br>Full download: <a href="https://www.mediafire.com/?uioea2w2ro76olw" target="_blank">here</a><br><br>Spawn issue returned 1x though while playing over the internet. <br><br></td></tr></table><br>
<a name="1292632"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rick Nasher</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#156">[#156]</a></td></tr></table></td></tr><tr ><td class="posttext"> @GF:<br>It's not possible to fix the chat in that it will automatically do a linefeed due to the nature of the GetKey command: it will allow you to type in continuously until enter is being pressed.<br> <br>For this we would need to rewrite the chat input routines to use KeyHit/ KeyDown, which is doable, but would take quite a bit of time. I'd rather get the bugs ironed out of the system first, for otherwise wouldn't be of much use anyway huh?<br><br>We can however set a custom limit to the input accepted as a msg(not on the input console)to reflect what's on screen.<br>Add in main under the chat variables:<br><pre class=code>Global maxlinelength% =79</pre><br>and<br>In UpdateChat():<br><pre class=code>
				If Len(chatMessage) &gt; maxlinelength-(Len(localName)+2)  ; so exceeds max line length
					chatMessage = Left$(chatMessage,maxlinelength) ; so ignoring all surpassing max chars.
				EndIf	</pre><br>Now this is not what you're after, but in due time it will be done, if bugs are gone. <br><br></td></tr></table><br>
<a name="1292641"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Flanker512</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#157">[#157]</a></td></tr></table></td></tr><tr ><td class="posttext"> Sorry guys as I said I can't focus on it for now but I will probably add TCP in the future to handle important messages.<br><br>For the spawn location problem, if you have two or more different player spawns, when you reset a player you need to know where to reset it. So you have to make a new message type and send the location to everyone. To reset properly, you must set nextX, nextY, nextZ AND previousX, previousY, previousZ so you won't have interpolation. Also, use a ResetEntity to avoid collision when reseting. <br><br></td></tr></table><br>
<a name="1292646"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Guy Fawkes</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#158">[#158]</a></td></tr></table></td></tr><tr ><td class="posttext"> :( <br><br></td></tr></table><br>
<a name="1292647"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rick Nasher</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#159">[#159]</a></td></tr></table></td></tr><tr ><td class="posttext"> @Flanker(512). A pity, but understandable. <i>Life is hard, then you die as some may say.</i> ;-)<br><pre class=code>
Function ResetPlayer(id)
	
	p.player = Object.player(GetPlayer(id))
	
	p\life = 100
	
	location=Rand (1,2)
	If location=1
		
		p\nextX = -20
		p\nextY = 6.5
		p\nextZ = -20
		
	Else 
		
		p\nextX = 20
		p\nextY = 6.5
		p\nextZ = 20
	EndIf
	
	p\nextYaw = -45
	
	
	
	p\previousX = p\nextX
	p\previousY = p\nextY
	p\previousZ = p\nextZ
	p\previousYaw = p\nextYaw
	;back to origin.
	PositionEntity p\mesh,p\nextX,p\nextY,p\nextZ
	RotateEntity p\mesh,0,p\nextYaw,0
	ResetEntity p\mesh
	
	p\currentY = p\nextY
	
	p\previousTime = MilliSecs()
	p\nextTime = MilliSecs()+1
	
End Function
</pre>Thanks for thinking along. I figured it was something like that. Above code appears to take that into account. <br><br>Somehow it didn't do the trick, gives strange results. Locally it shows up correctly, but the other players sometimes see it appearing half way the 2 spawnlocations(so on the cube scenery) instead of at the spawnlocation *with* correct spawn height though, so Y position gets across correctly, but *not* X and Z. That's why I was thinking has something to do with UpdatPlayers() still performing an action on it that's not taken into account by ResetPlayer(). Or perhaps I made a mistake somewhere. I'll retry. <br><br></td></tr></table><br>
<a name="1292653"></a>

<a name="1292654"></a>

<a name="1292655"></a>

<a name="1292656"></a>

<a name="1292657"></a>

<a name="1292658"></a>

<a name="1292659"></a>

<a name="1292660"></a>

<a name="1292661"></a>

<a name="1292662"></a>

<a name="1292663"></a>

<a name="1292664"></a>

<a name="1292665"></a>

<a name="1292718"></a>

<a name="1292719"></a>

<a name="1292721"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rick Nasher</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#160">[#160]</a></td></tr></table></td></tr><tr ><td class="posttext"> <b>[Update] Even more weird:</b> <br>When I change the 2nd spawn location's X to -20(so both locations are in each others line of site) it doesn't happen anymore that the player is displayed half way these spawn locations when reset. I've changed these X -positions in the CreateScene(), CreatePlayer() and ResetPlayer(). <br><br>I was then remembering stayne's comment about hiding entities when spawning could be the key and that this was just a collision issue(with the scenery). So I restored the spawnlocation to original and tested, then added HideEntity p\mesh in ResetPlayer(), repositioned the entity and then ShowEntity p\mesh, but that didn't resolve it.<br><br><b>So now I'm clueless.. Why on earth would it matter where the spawnlocation is located?? Why would it create a bug? </b><br><br><i>(BTW: For anybody interested in the library I've assembled all; lib, latest examples/tests, media and docs into one cleaned-up rar file. Download <a href="https://www.mediafire.com/?m412elhdkimlg7f" target="_blank"> <b>&lt;here&gt;</a>)</b></i> <br><br>[EDIT: updated archive, for didn't contain correct 'fixed' version] <br><br></td></tr></table><br>
<a name="1292671"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Guy Fawkes</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#161">[#161]</a></td></tr></table></td></tr><tr ><td class="posttext"> @Rick Nasher :: I'm in the chat! Lets test! :)<br><br>Also, it matters because I don't want players spawning INSIDE my 3D trees. LOL!<br><br>~GF <br><br></td></tr></table><br>
<a name="1292712"></a>

<a name="1292713"></a>

<a name="1292714"></a>

<a name="1292720"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rick Nasher</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#162">[#162]</a></td></tr></table></td></tr><tr ><td class="posttext"> @ GF: Oops.. Sorry, didn't see your msg. Had to turn in early for need to do some work round the house. <br><br>But it's not a real fix of course, for I don't know why it works and if is consistent all of the time. First thing to try is a number of times re-spawning again and again to see if holds up. Then, if remains ok, I want to put a large cube or wall in between the spawn locations to see if has an adverse effect, similar as the cube scenery in the middle appears to affect the spawning. Guess we could also try hiding the cube scenery in the middle while spawning, just to see what happens.<br><br>Well need to do some work now. Perhaps later today? <br><br></td></tr></table><br>
<a name="1292836"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Guy Fawkes</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#163">[#163]</a></td></tr></table></td></tr><tr ><td class="posttext"> Yes<br><br>~GF <br><br></td></tr></table><br>
<a name="1292853"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rick Nasher</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#164">[#164]</a></td></tr></table></td></tr><tr ><td class="posttext"> Bad news; my burnout has re-emerged in form of bad headache when concentrating/thinking just a little bit even. I have to postpone today unfortunately. Hope some good night sleep will help otherwise I'm screwed tomorrow at work.. :-( <br><br></td></tr></table><br>
<a name="1293189"></a>

<a name="1293192"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rick Nasher</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#165">[#165]</a></td></tr></table></td></tr><tr ><td class="posttext"> Back from outta space. Well, just a little.. at least feel ready for a little testing. <br><br></td></tr></table><br>
<a name="1293311"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Guy Fawkes</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#166">[#166]</a></td></tr></table></td></tr><tr ><td class="posttext"> Lets test today! :)<br><br>~GF <br><br></td></tr></table><br>
<a name="1293357"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rick Nasher</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#167">[#167]</a></td></tr></table></td></tr><tr ><td class="posttext"> Ok, it's now dinner time here, but in 1 hour I'm on. <br><br></td></tr></table><br>
<a name="1293431"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Guy Fawkes</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#168">[#168]</a></td></tr></table></td></tr><tr ><td class="posttext"> I'm here! :)<br><br>~GF <br><br></td></tr></table><br>
<a name="1293569"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Guy Fawkes</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#169">[#169]</a></td></tr></table></td></tr><tr ><td class="posttext"> Any updates lately?<br><br>~GF <br><br></td></tr></table><br>
<a name="1293571"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rick Nasher</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#170">[#170]</a></td></tr></table></td></tr><tr ><td class="posttext"> Nah. Just had some fun experimenting with differrent cams to see what works best in our little test game. I took the one from stayne's example level to see if gives a better experience in the regular in game gfx version. <br>But I think my own combo cam works a slight bit better. Also I like the one from a code example with the flash light in the dark. Would be nice for a day/night cycle, which I'll implement later.<br><br>But now I'm gonna try see if the 'fix' (which isn't a real fix) is consistently showing the entity correctly. <br><br></td></tr></table><br>
<a name="1293572"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >stayne</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#171">[#171]</a></td></tr></table></td></tr><tr ><td class="posttext"> Hey guys...maybe you should start a new thread?  This one is getting gigantitron. <br><br></td></tr></table><br>
<a name="1293578"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rick Nasher</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#172">[#172]</a></td></tr></table></td></tr><tr ><td class="posttext"> Hehehe. You are probably right. I'm moving to my <a href="/posts.php?topic=104840" target="_blank">own thread</a> until, (hopefully, one day..) Flanker, our fearless UDP hero, returns for the unexplainable spawn bug fix. ;-) <br><br></td></tr></table><br>
<a name="1294058"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Flanker</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#173">[#173]</a></td></tr></table></td></tr><tr ><td class="posttext"> Here is an example for random multiple spawns. Find everything that involves "spawn" in the code. The spawn location is chosen by the server.<br><br><textarea class=codebox name="code" wrap=OFF readonly="true" rows="15" cols="80">SeedRnd MilliSecs()

Const gameLogicFPS = 60

Include "UDPNetwork_lib.bb"

Global localID
Global localName$ = Input("Enter your name : ")
If localName = "" Then localName = "player" + Rand(100,999)

Global localPlayerMesh

Type player
	Field id
	Field name$
	Field ping
	
	Field life
	Field kills
	Field deaths
	
	Field mesh
	Field r,g,b

	Field nextX#,nextY#,nextZ#
	Field previousX#,previousY#,previousZ#
	Field nextYaw#
	Field previousYaw#
	Field nextTime
	Field previousTime
	
	Field lastPacket
	
	Field currentY#
	Field velocityY#
End Type

Type bullet
	Field mesh
	Field angle#
	Field time
	Field id ; id of player who fired
End Type

Type spawn
	Field spawnId
	Field x#,y#,z#
	Field yaw#
End Type
Global spawns ; number of spawn points

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
; Camera code from jfk EO-11110, thanks
Global bounce_cam=1 ;  smooth camera motion? (0/1)
Global bounce_div#=10.0 ; the higher, the more sluggish the camera will follow. Recc: 3.0 to 20.0
; some globals used by ChaseCam
Global old_x#,old_y#,old_z#
; desired distance between camera and player mesh
Global x_dis#=7.0,y_dis#=3,z_dis#=7.0,y_dis_or#=y_dis#
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;

; network init ----------------------------------------;
Global localMode = Net_StartInput() ; bring the library "console" to connect

If localMode = 1 Or localMode = 2 ; 1 means we are client, 2 means we are server
	
	localId = Net_CreatePlayer(localName) ; this command inits the server or local client
	
	If localId = 0 ; error
		Net_StopNetwork() ; close the network properly
		RuntimeError("Failed to create player.")
	EndIf
	
	If localMode = 1 Then AppTitle("Client : " + localName + " (port:" + net_port + "/ ID=" + localID + ")")
	If localMode = 2 Then AppTitle("Server : " + localName + " (port:" + net_port + "/ ID=" + localID + ")")
	
Else ; error
	Net_StopNetwork()
	RuntimeError("Failed to start game.")
EndIf
;------------------------------------------------------;

Graphics3D 640,480,32,2
SetBuffer BackBuffer()

CreateScene()


CreateSpawn(-15,1,-30,-45)
CreateSpawn(15,1,-30,45)
CreateSpawn(-15,1,15,-135)
CreateSpawn(15,1,15,135)
CreateSpawn(0,12,0,0)
CreateSpawn(0,1,-9,180)


Global camera = CreateCamera()
CameraRange camera,0.1,1000

; create our own local player
localPlayerMesh = CreatePlayer(localID,localName)
old_x = EntityX(localPlayerMesh):old_y = EntityY(localPlayerMesh):old_z = EntityZ(localPlayerMesh) ; update camera position

; we send our color to the server
p.player = Object.player(GetPlayer(localID))
Net_SendMessage(3,p\r + "/" + p\g + "/" + p\b)

; variables used to send our positions at a constant delay (saves bandwidth but makes a constant ping)
Global updatePosition = MilliSecs()
Global updateTick = 50

; chat
Global messageDisplayNumber = 10
Global messageOffset
Dim message$(messageDisplayNumber)

Global chatMode
Global chatMessage$ = localName + "&gt; "
Global chatMillisecs = MilliSecs()
Global chatCursor

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
tweeningPeriod = 1000 / gameLogicFPS
tweeningTime = MilliSecs() - tweeningPeriod
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
While Not KeyHit(1)

	;; I use tweening from castle demo here :
	;;
	;; 		- this allows to have very fast execution outside the tweening loop,
	;; 		  so the network is updated as fast as possible (needs Flip False)
	;;
	;; 		- this makes the game logic updated at a constant rate (Const FPS=)
	;;		  so no need to set deltatime (and it saves CPU time for other things)


	;; -------------------------------------------------------------------------------------------------; FAST EXECUTION (outside of tweening)
	;; -------------------------------------------------------------------------------------------------;
	
	; see the function, the interpolation variables are set properly here
	UpdateNetwork()
		
	;; -------------------------------------------------------------------------------------------------;

	Repeat
		tweeningElapsed = MilliSecs() - tweeningTime
	Until tweeningElapsed
	tweeningTicks = tweeningElapsed / tweeningPeriod
	tweeningRate# = Float(tweeningElapsed Mod tweeningPeriod)/Float(tweeningPeriod)
	For k = 1 To tweeningTicks
		tweeningTime = tweeningTime + tweeningPeriod
		If k = tweeningTicks Then CaptureWorld
		
		;; ---------------------------------------------------------------------------------------------; MAIN UPDATE
		;; ---------------------------------------------------------------------------------------------;
		
		; update our player
		UpdateLocalPlayer()
		
		; the interpolation is made in this function
		UpdatePlayers()
		
		; update the bullets... only the server check for player kills
		UpdateBullets()

		UpdateWorld()
		
		UpdateChaseCam(camera,localPlayerMesh)
		
		;; ---------------------------------------------------------------------------------------------;
		
	Next
	
	RenderWorld tweeningRate

	;; -------------------------------------------------------------------------------------------------; 2D UPDATE
	;; -------------------------------------------------------------------------------------------------;
	
	DrawPlayersNames()
	
	If KeyHit(28) And chatMode = 0 Then chatMode = 1:FlushKeys()
	If chatMode = 1 Then UpdateChat()
	
	DrawMessages()
	
	If KeyDown(15) Then DrawScoreTable()
	
	;; -------------------------------------------------------------------------------------------------;
	
	Flip

Wend
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;

Net_StopNetwork()

End

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function UpdateNetwork()

	; update incoming packets (better check ALL incoming messages so use While Wend)
	While Net_CheckMessage() ; will check for a new message and fill Net_MsgType, Net_MsgString$, Net_MsgFrom and Net_MsgTo variables so we can read it
		
		p.player = Object.player(GetPlayer(Net_MsgFrom)) ; get the player handle

		If Handle(p) = 0 And Net_MsgType &lt; 100 ; we received an update packet from a player we don't know
			; so we ask the server who he is and return because we can't update him for now
			; the server will resend us the info in a new player "100" message
			Net_RequestPlayer(Net_MsgFrom)
			Return
		EndIf
		
		Select Net_MsgType ; check the type of message
						
			Case 1 ; chat message
			
				NewMessage(Net_MsgString)
									
			Case 2 ; player position and angle, example of packing data into string
				
				offset1 = Instr(Net_MsgString,"/",1)
				offset2 = Instr(Net_MsgString,"/",offset1+1)
				offset3 = Instr(Net_MsgString,"/",offset2+1)
								
				p\previousX = p\nextX
				p\previousY = p\nextY
				p\previousZ = p\nextZ
				p\previousYaw = p\nextYaw
				
				p\nextX = Left(Net_MsgString,offset1-1)
				p\nextY = Mid(Net_MsgString,offset1+1,offset2-offset1-1)
				p\nextZ = Mid(Net_MsgString,offset2+1,offset3-offset2-1)
				p\nextYaw = Right(Net_MsgString,Len(Net_MsgString)-offset3)

				p\previousTime = p\nextTime
				p\nextTime = MilliSecs()
							
			Case 3 ; update player colors
						
				offset1 = Instr(Net_MsgString,"/",1)
				offset2 = Instr(Net_MsgString,"/",offset1+1)
							
				p\r = Left(Net_MsgString,offset1-1)
				p\g = Mid(Net_MsgString,offset1+1,offset2-offset1-1)
				p\b = Right(Net_MsgString,Len(Net_MsgString)-offset2)
								
				EntityColor p\mesh,p\r,p\g,p\b
				
			Case 4 ; a player fired
			
				CreateBullet(Net_MsgFrom)
							
			Case 5 ; a player lost some life
			
				p\life = Net_MsgString
			
			Case 6 ; a player killed another one
			
				k.player = Object.player(GetPlayer(Net_MsgString)) ; killed player ID in MsgData
				NewMessage(p\name + " killed " + k\name)
							
			Case 7 ; the server sends us score update for a player
			
				offset = Instr(Net_MsgString,"/",1)
				
				p\kills = Left(Net_MsgString,offset-1)
				p\deaths = Right(Net_MsgString,Len(Net_MsgString)-offset)
			
			Case 9 ; player spawn
			
				SpawnPlayer(p\id,Net_MsgString)				
						
			Case 100 ; new player connected, OR the server tells us who is already connected so we can create players when joining the game
							
				If localMode = 2
					For p.player = Each player
						Net_SendMessage(2,p\nextX + "/" + p\nextY + "/" + p\nextZ + "/" + p\nextYaw,p\id,Net_MsgFrom)
						Net_SendMessage(3,p\r + "/" + p\g + "/" + p\b,p\id,Net_MsgFrom)
						
						Net_SendMessage(5,p\life,p\id,Net_MsgFrom)
						Net_SendMessage(7,p\kills+"/"+p\deaths,p\id,Net_MsgFrom)
					Next
				EndIf
				
				NewMessage(Net_MsgString + " connected")
				CreatePlayer(Net_MsgFrom,Net_MsgString)
				
			Case 101 ; a player has quit
						
				For p.player = Each player
					If Net_MsgFrom = p\id
						NewMessage(p\name + " disconnected")
						FreeEntity p\mesh
						Delete p
					EndIf
				Next
							
			Case 102 ; host has changed
			
				For p.player = Each player
					If Net_MsgFrom = p\id
						If p\id = localID
							AppTitle("Server : " + localName + " (port:" + net_port + ")")
							NewMessage("You are the new host")
							localMode = 2
						Else
							NewMessage(p\name + " is the new host")
						EndIf					
					EndIf
				Next
			
			Case 103 ; ping update
			
				For p.player = Each player
					If Net_MsgFrom = p\id
						p\ping = Net_MsgString
					EndIf
				Next

		End Select

	Wend

End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function UpdateLocalPlayer()

	; update our player
	p.player = Object.player(GetPlayer(localID)) ; get our player

	; inputs
	If KeyDown(200) Then MoveEntity p\mesh,0,0,0.3
	If KeyDown(208) Then MoveEntity p\mesh,0,0,-0.3
	If KeyDown(203) Then TurnEntity p\mesh,0,3,0
	If KeyDown(205) Then TurnEntity p\mesh,0,-3,0
		
	; fire
	If MouseHit(1)
		Net_SendMessage(4,"")
		CreateBullet(localID)
	EndIf
	
	; jump
	If MouseHit(2)
		; check if player is one the ground
		LinePick(EntityX(p\mesh),EntityY(p\mesh),EntityZ(p\mesh),0,-1.2,0)
		If PickedEntity()
			p\velocityY = 0.5 ; set "inverse" of gravity velocity
		EndIf	
	EndIf
	
	; we create a message type "2" for player position
	If MilliSecs()-updatePosition &gt; updateTick
	
		Net_SendMessage(2,EntityX(p\mesh) + "/" + EntityY(p\mesh) + "/" + EntityZ(p\mesh) + "/" + EntityYaw(p\mesh))
		updatePosition = MilliSecs()
	EndIf
	
End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function UpdatePlayers()

	For p.player = Each player
				
		If p\id &lt;&gt; localID ; update other players only
						
			;; LINEAR INTERPOLATION ;;;;;;;;;;
			
			If p\nextTime &lt;&gt; p\previousTime ; if both packets arrived at the same time, we can't interpolate
				
				curTime# = Float(MilliSecs()-p\nextTime) / Float(p\nextTime-p\previousTime) ; curTime will be ideally 0.0-1.0, if it's &gt; 1.0 then it performs extrapolation
				
				If curTime &gt; 1 Then curTime = 1 ; extrapolation gives anoying jittering effects
				
				; special fix for yaw as EntityYaw returns a value beetween +180 ans -180, the interpolation can go backward
				If p\previousYaw &lt; 0 Then p\previousYaw = p\previousYaw + 360
				If p\nextYaw &lt; 0 Then p\nextYaw = p\nextYaw + 360
				If Abs(p\nextYaw-p\previousYaw) &gt; 180
					If p\nextYaw &gt; p\previousYaw
						p\previousYaw = p\previousYaw + 360
					Else
						p\previousYaw = p\previousYaw - 360
					EndIf
				EndIf
				
				PositionEntity p\mesh,p\previousX+(p\nextX-p\previousX)*curTime,p\previousY+(p\nextY-p\previousY)*curTime,p\previousZ+(p\nextZ-p\previousZ)*curTime
				RotateEntity p\mesh,0,p\previousYaw+(p\nextYaw-p\previousYaw)*curTime,0
				
			Else
			
				PositionEntity p\mesh,p\nextX,p\nextY,p\nextZ
				RotateEntity p\mesh,0,p\nextYaw,0
			
			EndIf
			;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
						
			ResetEntity p\mesh ; reset entity is useful here because of collisions

		Else ; update our player, basically it just compute gravity
		
			p\velocityY = p\velocityY - 0.03 ; fake gravity
			If EntityY(p\mesh) - p\currentY &gt;= 0 ; if player is not falling we limit the gravity
				If p\velocityY &lt; -0.03 Then p\velocityY = -0.03
			EndIf
		
			p\currentY = EntityY(p\mesh)
			TranslateEntity p\mesh,0,p\velocityY,0
						
		EndIf
	Next

End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function CreatePlayer(id,name$)

	DebugLog "create player"

	For p.player = Each player
		If p\id = id Then Return ; player already connected
	Next

	p.player = New player
	p\id = id
	p\name = name
	
	p\life = 100
	
	p\mesh = CreateSphere()
	EntityType p\mesh,2
	EntityRadius p\mesh,1
	
	NameEntity p\mesh,Handle(p)
	
	nose = CreateSphere(8,p\mesh):EntityColor nose,255,0,0
	PositionEntity nose,0,0,1
	ScaleEntity nose,0.3,0.3,0.3
	
	eyeLeft = CreateSphere(8,p\mesh):EntityColor eyeLeft,255,255,255
	PositionEntity eyeLeft ,.29,.4,.7;1
	ScaleEntity eyeLeft ,0.2,0.2,0.2
	
	pupilLeft = CreateSphere(8,p\mesh):EntityColor pupilLeft ,0,0,0
	PositionEntity pupilLeft ,.3,.4,.9;1
	ScaleEntity pupilLeft ,0.05,0.05,0.02
	
	eyeRight = CreateSphere(8,p\mesh):EntityColor eyeRight ,255,255,255
	PositionEntity eyeRight ,-.29,.4,.7;1
	ScaleEntity eyeRight ,0.2,0.2,0.2
		
	pupilRight = CreateSphere(8,p\mesh):EntityColor pupilRight ,0,0,0
	PositionEntity pupilRight ,-.3,.4,.9;1
	ScaleEntity pupilRight ,0.05,0.05,0.02

	unaBrow = CreateCone(8,1,p\mesh):EntityColor unaBrow ,0,0,0
	PositionEntity unaBrow ,0,.45,.7
	RotateEntity unaBrow ,-180,0,0
	ScaleEntity unaBrow ,.7,.2,.3
	
	RandomSpawn(p\id)
		
	p\r = Rand(255)
	p\g = Rand(255)
	p\b = Rand(255)
	EntityColor p\mesh,p\r,p\g,p\b
		
	Return p\mesh

End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function SpawnPlayer(id,spawnId)

	p.player = Object.player(GetPlayer(id))
	
	For s.spawn = Each spawn
		If s\spawnId = spawnId Then Exit
	Next

	p\life = 100

	p\nextX = s\x
	p\nextY = s\y
	p\nextZ = s\z
	p\nextYaw = s\yaw

	p\previousX = p\nextX
	p\previousY = p\nextY
	p\previousZ = p\nextZ
	p\previousYaw = p\nextYaw

	PositionEntity p\mesh,p\nextX,p\nextY,p\nextZ
	RotateEntity p\mesh,0,p\nextYaw,0
	ResetEntity p\mesh
	
	p\currentY = p\nextY
	
	p\previousTime = MilliSecs()
	p\nextTime = MilliSecs()+1

End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function RandomSpawn(id)

	p.player = Object.player(GetPlayer(id))

	; if we are server, spawn player at random location
	If localMode = 2
		randSpawn = Rand(spawns)
		SpawnPlayer(p\id,randSpawn)
		Net_SendMessage(9,randSpawn,p\id)
		Net_SendMessage(9,randSpawn,p\id,p\id)
	Else ; else default spawn = first spawn created
		SpawnPlayer(p\id,1)
	EndIf

End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function CreateSpawn(x#,y#,z#,yaw#)

	spawns = spawns + 1

	s.spawn = New spawn
	s\spawnId = spawns
	s\x = x
	s\y = y
	s\z = z
	s\yaw = yaw

End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function GetPlayer(id)

	For p.player = Each player
		If p\id = id
			Return Handle(p)					
		EndIf
	Next
	
End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function DrawPlayersNames()

	For p.player = Each player
	
		Color 255,255,255
		CameraProject(camera,EntityX(p\mesh),EntityY(p\mesh),EntityZ(p\mesh)) 			
		If p\id &lt;&gt; localID Then Text ProjectedX(),ProjectedY()-60,p\name,1,1
		
		Color 255,(255./100.)*p\life,(255./100.)*p\life
		Text ProjectedX(),ProjectedY()-40,p\life,1,1

	Next
	
End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function CreateBullet(id)

	p.player = Object.player(GetPlayer(id))

	b.bullet = New bullet
	
	b\id = p\id
	
	b\mesh = CreateSphere(2)
	ScaleEntity b\mesh,0.2,0.2,0.2
	EntityColor b\mesh,255,0,0
		
	PositionEntity b\mesh,EntityX(p\mesh),EntityY(p\mesh),EntityZ(p\mesh)
	RotateEntity b\mesh,0,EntityYaw(p\mesh),0
	
	EntityType b\mesh,3
	EntityRadius b\mesh,0.2
		
	b\time = MilliSecs()

End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function UpdateBullets()

	For b.bullet = Each bullet
	
		MoveEntity b\mesh,0,0,1
		
		If CountCollisions(b\mesh)
		
			If localMode = 2 ; only the server compute bullets collision with player
				If GetEntityType(CollisionEntity(b\mesh,1)) = 2 ; a player is hit
				
					touchedPlayer.player = Object.player(EntityName(CollisionEntity(b\mesh,1)))
					touchedPlayer\life = touchedPlayer\life - 10
					
					If touchedPlayer\life &gt; 0 ; touched
						Net_SendMessage(5,touchedPlayer\life,touchedPlayer\id)
						Net_SendMessage(5,touchedPlayer\life,touchedPlayer\id,touchedPlayer\id)
					Else ; killed
						killerPlayer.player = Object.player(GetPlayer(b\id))
						
						killerPlayer\kills = killerPlayer\kills + 1
						touchedPlayer\deaths = touchedPlayer\deaths + 1						
						
						Net_SendMessage(6,touchedPlayer\id,killerPlayer\id)
						Net_SendMessage(6,touchedPlayer\id,killerPlayer\id,killerPlayer\id)
												
						Net_SendMessage(7,killerPlayer\kills+"/"+killerPlayer\deaths,killerPlayer\id)
						Net_SendMessage(7,killerPlayer\kills+"/"+killerPlayer\deaths,killerPlayer\id,killerPlayer\id)
						
						Net_SendMessage(7,touchedPlayer\kills+"/"+touchedPlayer\deaths,touchedPlayer\id)
						Net_SendMessage(7,touchedPlayer\kills+"/"+touchedPlayer\deaths,touchedPlayer\id,touchedPlayer\id)
						
						NewMessage(killerPlayer\name + " killed " + touchedPlayer\name)
						
						RandomSpawn(touchedPlayer\id)
						
					EndIf
				
				EndIf
			EndIf
			
			FreeEntity b\mesh
			Delete b
			
		ElseIf MilliSecs()-b\time &gt; 2000
		
			FreeEntity b\mesh
			Delete b
			
		EndIf
	
	Next

End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function NewMessage(msg$)

	messageOffset = messageOffset + 1
	
	If messageOffset &gt; messageDisplayNumber
	
		messageOffset = messageOffset - 1
		
		For i = 2 To messageDisplayNumber
			message(i-1) = message(i)		
		Next
		
		message(messageDisplayNumber) = msg
	
	Else
	
		message(messageOffset) = msg
	
	EndIf

End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function DrawMessages()

	Color 255,255,255

	For i = 1 To messageOffset
	
		Text 0,(i-1)*15,message(i)	
	
	Next

End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function UpdateChat()

	key = GetKey()

	If key
		If key = 13
			If chatMessage &lt;&gt; localName + "&gt; "
				For i = Len(localName + "&gt; ") To Len(chatMessage)
					If Mid(chatMessage,i,1) &lt;&gt; " "
						Net_SendMessage(1,chatMessage)
						NewMessage(chatMessage)
						Exit
					EndIf
				Next
			EndIf
			chatMessage = localName + "&gt; "
			chatMode = 0
		ElseIf key = 8 And Len(chatMessage) &gt; Len ( localName + "&gt; " )
			chatMessage = Left(chatMessage,Len(chatMessage)-1)
		ElseIf key &gt; 31 And key &lt; 127
			chatMessage = chatMessage + Chr(key)
		EndIf
	EndIf
	
	Color 255,255,255
	Rect 0,GraphicsHeight()-20,GraphicsWidth(),20,1
	
	Color 0,0,0
	Rect 0,GraphicsHeight()-20,GraphicsWidth(),20,0
	
	
	If MilliSecs()-chatMillisecs &gt; 500
		chatCursor = Not chatCursor
		chatMillisecs = MilliSecs()
	EndIf
	
	If chatCursor
		Text 5,GraphicsHeight()-17,chatMessage + "|"
	Else
		Text 5,GraphicsHeight()-17,chatMessage
	EndIf

End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function DrawScoreTable()

	For p.player = Each player
		count = count + 1
	Next
	
	baseX = (GraphicsWidth()-350)/2
	baseY = (GraphicsHeight()-(35+20*count))/2

	Color 0,0,0
	Rect baseX,baseY,350,35+20*count,1

	Color 255,192,0
	Rect baseX,baseY,350,35+20*count,0

	Text baseX+10,baseY+10,"Player          Kills     Deaths     Ping"
	Line baseX,baseY+25,baseX+349,baseY+25

	For p.player = Each player
	
		Color 255,255,255
		If p\id = localID Then Color 255,100,100
	
		i = i + 1
		Text baseX+10,baseY+10+20*i,p\name
		Text baseX+157,baseY+10+20*i,p\kills,1,0
		Text baseX+240,baseY+10+20*i,p\deaths,1,0
		Text baseX+322,baseY+10+20*i,p\ping,1,0
	Next

End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function UpdateChaseCam(camera,player) ; thanks to jfk EO-11110 on bb forums for this function !
	PositionEntity camera,EntityX(player,1),EntityY(player,1),EntityZ(player,1)
	ResetEntity camera
	x#=EntityX(player)+Sin(-EntityYaw(player)+180)*x_dis#
	y#=EntityY(player)+y_dis#
	z#=EntityZ(player)+Cos(-EntityYaw(player)+180)*z_dis#
	obstacle=LinePick(EntityX(player),EntityY(player),EntityZ(player),(x-EntityX(player)),y_dis#,(z-EntityZ(player)),0.1)
	If obstacle=0
		new_x#=x
		new_y#=y
		new_z#=z
	Else
		new_x#=PickedX()
		new_y#=PickedY()
		new_z#=PickedZ()
	EndIf
	If bounce_cam=0
		PositionEntity camera,new_x,new_y,new_z
	Else
		x=old_x+((New_x-old_x)/bounce_div#)
		y=old_y+((New_y-old_y)/bounce_div#)
		z=old_z+((New_z-old_z)/bounce_div#)
		PositionEntity camera,x,y,z
	EndIf
	PointEntity camera,player
	TurnEntity camera,-20,0,0     ; if you want the player mesh more on the bottom of the screen
	old_x#=EntityX(camera)
	old_y#=EntityY(camera)
	old_z#=EntityZ(camera)
End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function CreateScene()

	texture = TextureCreate(128)
	
	ground = CreatePlane()
	EntityColor ground,150,150,150
	EntityTexture ground,texture
	
	cube = CreateCube():EntityColor cube,150,200,150
	ScaleEntity cube,5,5,5:PositionEntity cube,0,5,0
	EntityTexture cube,texture
	
	sphere = CreateSphere(16):EntityColor sphere,200,150,150
	ScaleEntity sphere,3,1,3:PositionEntity sphere,0,9.7,0
	
	platform = CreateCube():EntityColor platform,150,150,200
	ScaleEntity platform,3,1,10:PositionEntity platform,0,4.13,-13.15
	TurnEntity platform,-30,0,0
	EntityTexture platform,texture
	
	FreeTexture texture
	
	EntityType ground,1:EntityPickMode ground,2
	EntityType cube,1:EntityPickMode cube,2
	EntityType sphere,1:EntityPickMode sphere,2
	EntityType platform,1:EntityPickMode platform,2

	light = CreateLight()
	TurnEntity light,30,70,0
	
	;; COLLISIONS
	Collisions 2,1,2,3 ; player to scene
	Collisions 2,2,1,3 ; player to player
	
	Collisions 3,1,2,1 ; bullet to scene
	Collisions 3,2,1,1 ; bullet to player
	
End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function TextureCreate(size)
	texture = CreateTexture(size,size,9)
	SetBuffer TextureBuffer(texture)
	Color 255,255,255
	Rect 0,0,size,size,1
	Color 0,0,0
	Rect 0,0,size,size,0
	Line 0,0,size,size
	Line 0,size,size,0
	SetBuffer BackBuffer()
	Return texture
End Function</textarea> <br><br></td></tr></table><br>
<a name="1294068"></a>

<a name="1294069"></a>

<a name="1294070"></a>

<a name="1294072"></a>

<a name="1294073"></a>

<a name="1294074"></a>

<a name="1294075"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Guy Fawkes</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#174">[#174]</a></td></tr></table></td></tr><tr ><td class="posttext"> Guys, lets test this. I found a few glitches that need tending to with the spawn points. Here's my current version for 1.12 with all the fixes added &amp; now spawn points added as well.<br><br>============================USER32 DECLS===================================<br><br>user32.decls: <br><br><a href="https://www.mediafire.com/?fkydso97l65ztew" target="_blank">https://www.mediafire.com/?fkydso97l65ztew</a><br><br> ---The above goes in your "<b><i>blitz3d/userlibs</i></b>" folder<br><br>=============================KEYFIX_CONSTANTS==============================<br><br>KeyFix_Constants.bb: <br><br><textarea class=codebox name="code" wrap=OFF readonly="true" rows="15" cols="80">
; Common keys:
Const VK_LEFTMOUSE 				= $01	; Left physical mouse button 
Const VK_RIGHTMOUSE 			= $02	; Right physical mouse button
Const VK_MIDDLEMOUSE			= $04	; Middle physical mouse button 
Const VK_BACKSPACE				= $08	; BACKSPACE key
Const VK_TAB 					= $09	; TAB key
Const VK_ENTER 					= $0D	; ENTER key (Main keyboard or keypad)
Const VK_SHIFT 					= $10	; SHIFT key (Left or right)
Const VK_CONTROL 				= $11	; CTRL key (Left or right)
Const VK_ALT 					= $12	; ALT key (Left or right)
Const VK_PAUSE 					= $13	; PAUSE key
Const VK_CAPITAL 				= $14	; CAPS LOCK key
Const VK_ESCAPE 				= $1B	; ESC key
Const VK_SPACE 					= $20	; SPACEBAR
Const VK_PGUP 					= $21	; PAGE UP key
Const VK_PGDN 					= $22	; PAGE DOWN key
Const VK_END 					= $23	; END key
Const VK_HOME 					= $24	; HOME key
Const VK_LEFT 					= $25	; LEFT ARROW key
Const VK_UP 					= $26	; UP ARROW key
Const VK_RIGHT 					= $27	; RIGHT ARROW key
Const VK_DOWN 					= $28	; DOWN ARROW key
Const VK_PRINTSCRN 				= $2C	; PRINT SCREEN key
Const VK_INSERT 				= $2D	; INSERT key
Const VK_DELETE 				= $2E	; DELETE key
Const VK_0 						= $30
Const VK_1 						= $31
Const VK_2 						= $32
Const VK_3 						= $33
Const VK_4 						= $34
Const VK_5 						= $35
Const VK_6 						= $36
Const VK_7 						= $37
Const VK_8 						= $38
Const VK_9 						= $39
Const VK_A 						= $41
Const VK_B 						= $42
Const VK_C 						= $43
Const VK_D 						= $44
Const VK_E 						= $45
Const VK_F 						= $46
Const VK_G 						= $47
Const VK_H 						= $48
Const VK_I 						= $49
Const VK_J 						= $4A
Const VK_K 						= $4B
Const VK_L 						= $4C
Const VK_M 						= $4D
Const VK_N 						= $4E
Const VK_O 						= $4F
Const VK_P 						= $50
Const VK_Q 						= $51
Const VK_R 						= $52
Const VK_S 						= $53
Const VK_T 						= $54
Const VK_U	 					= $55
Const VK_V 						= $56
Const VK_W 						= $57
Const VK_X 						= $58
Const VK_Y		 				= $59
Const VK_Z 						= $5A
Const VK_LEFTWIN				= $5B	; Left Windows key 
Const VK_RIGHTWIN				= $5C	; Right Windows key
Const VK_NUMPAD0 				= $60
Const VK_NUMPAD1 				= $61
Const VK_NUMPAD2 				= $62
Const VK_NUMPAD3 				= $63
Const VK_NUMPAD4 				= $64
Const VK_NUMPAD5 				= $65
Const VK_NUMPAD6 				= $66
Const VK_NUMPAD7 				= $67
Const VK_NUMPAD8 				= $68
Const VK_NUMPAD9 				= $69
Const VK_MULTIPLY 				= $6A	; Keypad *
Const VK_ADD 					= $6B	; Keypad +
Const VK_SEPARATOR 				= $6C	; Keypad /
Const VK_SUBTRACT 				= $6D	; Keypad -
Const VK_DECIMAL 				= $6E	; Keypad .
Const VK_DIVIDE 				= $6F	; Keypad \
Const VK_F1 					= $70
Const VK_F2 					= $71
Const VK_F3 					= $72
Const VK_F4 					= $73
Const VK_F5 					= $74
Const VK_F6 					= $75
Const VK_F7 					= $76
Const VK_F8 					= $77
Const VK_F9 					= $78
Const VK_F10 					= $79
Const VK_F11 					= $7A
Const VK_F12 					= $7B
Const VK_NUMLOCK 				= $90	
Const VK_SCROLLLOCK 			= $91	
Const VK_LEFTSHIFT				= $A0	; Windows 95 does not support the left and right distinguishing constants.	
Const VK_RIGHTSHIFT				= $A1	
Const VK_LEFTCTRL				= $A2	
Const VK_RIGHTCTRL				= $A3	
Const VK_LEFTALT				= $A4	
Const VK_RIGHTALT				= $A5

; Less common keys:
; Some of the keys here would seem to be common keys, but the documentation does not say they work in 95/98,
; so I did not include them with the other keys above just to be safe.
Const VK_CANCEL 				= $03	; Control-break processing
Const VK_X1MOUSE				= $05	; Windows 2000/XP: X1 mouse button
Const VK_X2MOUSE				= $06	; Windows 2000/XP: X2 mouse button
Const VK_CLEAR 					= $0C	; CLEAR key
Const VK_SELECT 				= $29	; SELECT key
Const VK_EXECUTE 				= $2B	; EXECUTE key
Const VK_PRINT 					= $2A	; PRINT key
Const VK_HELP 					= $2F	; HELP key
Const VK_KANA					= $15	; Input Method Editor (IME) Kana mode
Const VK_HANGUL					= $15	; IME Hangul mode
Const VK_JUNJA					= $17	; IME Junja mode
Const VK_FINAL 					= $18	; IME final mode
Const VK_KANJI 					= $19	; IME Hanja/Kanji mode	
Const VK_CONVERT 				= $1C	; IME convert
Const VK_NONCONVERT				= $1D	; IME nonconvert
Const VK_ACCEPT					= $1E	; IME accept
Const CK_MODECHANGE				= $1F	; IME mode change request
Const VK_APPS 					= $5D	; Applications key 
Const VK_SLEEP					= $5F	; Computer Sleep key
Const VK_F13 					= $7C
Const VK_F14 					= $7D
Const VK_F15 					= $7E
Const VK_F16 					= $7F
Const VK_F17 					= $80
Const VK_F18 					= $81
Const VK_F19 					= $82
Const VK_F20 					= $83
Const VK_F21 					= $84
Const VK_F22 					= $85
Const VK_F23 					= $86
Const VK_F24 					= $87
Const VK_BROWSER_BACK			= $A6	; Windows 2000/XP: Browser Back key
Const VK_BROWSER_FORWARD		= $A7	; Windows 2000/XP: Browser Forward key
Const VK_BROWSER_REFRESH 		= $A8	; Windows 2000/XP: Browser Refresh key
Const VK_BROWSER_STOP 			= $A9	; Windows 2000/XP: Browser Stop key
Const VK_BROWSER_SEARCH 		= $AA	; Windows 2000/XP: Browser Search key 
Const VK_BROWSER_FAVORITES		= $AB	; Windows 2000/XP: Browser Favorites key
Const VK_BROWSER_HOME 			= $AC	; Windows 2000/XP: Browser Start And Home key
Const VK_VOLUME_MUTE 			= $AD	; Windows 2000/XP: Volume Mute key
Const VK_VOLUME_DOWN 			= $AE	; Windows 2000/XP: Volume Down key
Const VK_VOLUME_UP 				= $AF	; Windows 2000/XP: Volume Up key
Const VK_MEDIA_NEXT_TRACK		= $B0	; Windows 2000/XP: Next Track key
Const VK_MEDIA_PREV_TRACK 		= $B1	; Windows 2000/XP: Previous Track key
Const VK_MEDIA_STOP 			= $B2	; Windows 2000/XP: Stop Media key
Const VK_MEDIA_PLAY_PAUSE 		= $B3	; Windows 2000/XP: Play/Pause Media key
Const VK_LAUNCH_MAIL 			= $B4	; Windows 2000/XP: Start Mail key
Const VK_LAUNCH_MEDIA_SELECT	= $B5	; Windows 2000/XP: Select Media key
Const VK_LAUNCH_APP1 			= $B6	; Windows 2000/XP: Start Application 1 key
Const VK_LAUNCH_APP2 			= $B7	; Windows 2000/XP: Start Application 2 key	
Const VK_OEM_1 					= $BA	; Windows 2000/XP: For the US standard keyboard, the ';:' key
Const VK_OEM_PLUS 				= $BB	; Windows 2000/XP: For any country/region, the '+' key
Const VK_OEM_COMMA 				= $BC	; Windows 2000/XP: For any country/region, the ',' key
Const VK_OEM_MINUS 				= $BD	; Windows 2000/XP: For any country/region, the '-' key
Const VK_OEM_PERIOD 			= $BE	; Windows 2000/XP: For any country/region, the '.' key
Const VK_OEM_2 					= $BF	; Windows 2000/XP: For the US standard keyboard, the '/?' key
Const VK_OEM_3 					= $C0	; Windows 2000/XP: For the US standard keyboard, the '`~' key
Const VK_OEM_4 					= $DB	; Windows 2000/XP: For the US standard keyboard, the '[{' key
Const VK_OEM_5 					= $DC	; Windows 2000/XP: For the US standard keyboard, the '\|' key
Const VK_OEM_6 					= $DD	; Windows 2000/XP: For the US standard keyboard, the ']}' key
Const VK_OEM_7					= $DE	; Windows 2000/XP: For the US standard keyboard, the 'single-quote/double-quote' key
Const VK_OEM_8					= $DF	; Used for miscellaneous characters; it can vary by keyboard.
Const VK_ICO_F17				= $E0	
Const VK_ICO_F18				= $E1	
Const VK_OEM102					= $E2	; Windows 2000/XP: Either the angle bracket key or the backslash key on the RT 102-key keyboard
Const VK_ICO_HELP				= $E3
Const VK_ICO_00					= $E4	
Const VK_PROCESSKEY				= $E5	; Windows 95/98/Me, Windows NT 4.0, Windows 2000/XP: IME PROCESS key
Const VK_ICO_CLEAR				= $E6
Const VK_PACKET					= $E7	; Windows 2000/XP: Used to pass Unicode characters as if they were keystrokes.
Const VK_OEM_RESET				= $E9
Const VK_OEM_JUMP				= $EA
Const VK_OEM_PA1				= $EB
Const VK_OEM_PA2				= $EC
Const VK_OEM_PA3				= $ED
Const VK_OEM_WSCTRL				= $EE
Const VK_OEM_CUSEL				= $EF
Const VK_OEM_ATTN				= $F0
Const VK_OEM_FINNISH			= $F1
Const VK_OEM_COPY				= $F2
Const VK_OEM_AUTO				= $F3
Const VK_OEM_ENLW				= $F4
Const VK_OEM_BACKTAB			= $F5
Const VK_ATTN					= $F6	; Attn key
Const VK_CRSEL					= $F7	; CrSel key
Const VK_EXSEL					= $F8	; ExSel key
Const VK_EREOF 					= $F9	; Erase EOF key
Const VK_PLAY 					= $FA	; Play key
Const VK_ZOOM 					= $FB	; Zoom key
Const VK_NONAME 				= $FC	; Reserved
Const VK_PA1 					= $FD	; PA1 key
Const VK_OEM_CLEAR				= $FE	; Clear key
</textarea><br><br>=================================HEX8==============================<br><br>Hex8.bb: <br><br><textarea class=codebox name="code" wrap=OFF readonly="true" rows="15" cols="80">; Ascii value for each hex digit
Dim giHexDigit(15)
giHexDigit(0) = 48
giHexDigit(1) = 49
giHexDigit(2) = 50
giHexDigit(3) = 51
giHexDigit(4) = 52
giHexDigit(5) = 53
giHexDigit(6) = 54
giHexDigit(7) = 55
giHexDigit(8) = 56
giHexDigit(9) = 57
giHexDigit(10) = 65
giHexDigit(11) = 66
giHexDigit(12) = 67
giHexDigit(13) = 68
giHexDigit(14) = 69
giHexDigit(15) = 70


Function RGB_To_TriHex$(iR%,iG%,iB%)
	Return ToHex8(iR) + ToHex8(iG) + ToHex8(iB)
End Function


Function FromHex8%(sHex$)
	Local iValue%
	If Len(sHex) &lt;&gt; 2 Then Return 0

	sHex = Upper(sHex)
	
	For i = 0 To 15
		If giHexDigit(i) = Asc(Right(sHex,1)) Then
			iValue = i
			Exit
		End If
	Next

	For i = 0 To 15
		If giHexDigit(i) = Asc(Left(sHex,1)) Then
			iValue = iValue + i * 16
			Exit
		End If
	Next
	
	Return iValue
End Function


Function ToHex8$(iValue%)
	; iValue must be 0-255 (8-bits)
	If iValue &gt; 255 Or iValue &lt; 0 Then RuntimeError("Invalid value passed to ToHex8() function.")
	Local iLow% = iValue Mod 16
	Local iHi% = iValue Shr 4
	
	Return Chr(giHexDigit(iHi)) + Chr(giHexDigit(iLow))
End Function


Function Set_Color_Hex(sColorHex$)
	Color FromHex8(Left(sColorHex,2)),FromHex8(Mid(sColorHex,3,2)),FromHex8(Right(sColorHex,2))
End Function
</textarea><br><br>=============================MAIN SOURCE===================================<br><br>UDPNetwork_Test_1.12.bb: <br><br><textarea class=codebox name="code" wrap=OFF readonly="true" rows="15" cols="80">;last known good.
;added different health strengths and spawn times.
;added hide entities names when one player cannot see each other.
;added sound fx (crude hack)

SeedRnd MilliSecs()

Const gameLogicFPS = 60

; first we include the KeyFix library
Include "KeyFix_Constants.bb"

; we now include the network library
Include "UDPNetwork_lib.bb"
; for converting RGB values to "Tri-Hex" stringc inlude hex8.
Include "Hex8.bb" ;&lt;&lt;&lt; Colored txt mod by Raster Ron 

Global localID
;Global localName$ = Input("Enter your name : ")
;If localName = "" Then localName = "player" + Rand(100,999)


;&lt;&lt; Enter through mod..
Global localName$ = "", defaultName$ = "RCX" ; Predefined name, so just need To press enter.

Print "Change default name: '"+ defaultName$ +"' ?"
Choic$ = Input$("[Press [Y]es or [ENTER] for No: ")
If Choic$="y" Then ; so want to change..
	Cls:Locate 0,0
	Print "Type name &amp; press [ENTER] or"
	ChangeName$=Input$("just [ENTER] to autogenerate: ")
	If ChangeName$="" ; so pressed enter to autogen..
		localName = "player" + Rand(100,999)
	Else ; so entered a new name..
		localName$=ChangeName$
	EndIf
Else ; so entered without input.
	localName$ = defaultName$
EndIf
;&lt;&lt; End enter through mod.

Global localPlayerMesh

Type player
	Field id
	Field name$
	Field ping
	
	Field life
	Field kills
	Field deaths
	
	Field mesh
	Field r,g,b
	
	Field nextX#,nextY#,nextZ#
	Field previousX#,previousY#,previousZ#
	Field nextYaw#
	Field previousYaw#
	Field nextTime
	Field previousTime
	
	Field lastPacket
	
	Field currentY#
	Field velocityY#
End Type

Type bullet
	Field mesh
	Field angle#
	Field time
	Field id ; id of player who fired
End Type

Type health
	Field mesh
	Field pickupTime ; to store when was pickedup and can hide for a certain time set in 
	Field respawnDelay ; &lt; see above
	
	;Field id  ; to hold healthitem's id
	Field power ; to hold strength of upgrade
	;Field pid ; id of player who updated health
End Type

Type spawn
	Field spawnId
	Field x#,y#,z#
	Field yaw#
End Type

Global spawns ; number of spawn points

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
; Camera code from jfk EO-11110, thanks
Global bounce_cam=1 ;  smooth camera motion? (0/1)
Global bounce_div#=10.0 ; the higher, the more sluggish the camera will follow. Recc: 3.0 to 20.0
; some globals used by ChaseCam
Global old_x#,old_y#,old_z#
; desired distance between camera and player mesh
Global x_dis#=7.0,y_dis#=3,z_dis#=7.0,y_dis_or#=y_dis#
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;

; network init ----------------------------------------;
Global localMode = Net_StartInput() ; bring the library "console" to connect

If localMode = 1 Or localMode = 2 ; 1 means we are client, 2 means we are server
	
	localID = Net_CreatePlayer(localName) ; this command inits the server or local client
	
	If localID = 0 ; error
		Net_StopNetwork() ; close the network properly
		RuntimeError("Failed to create player.")
	EndIf
	
	If localMode = 1 Then AppTitle("Client : " + localName + " (port:" + net_port + "/ ID=" + localID + ")")
	If localMode = 2 Then AppTitle("Server : " + localName + " (port:" + net_port + "/ ID=" + localID + ")")
	
Else ; error
	Net_StopNetwork()
	RuntimeError("Failed to start game.")
EndIf
;------------------------------------------------------;

Graphics3D 640,480,32,2
SetBuffer BackBuffer()

;--------------audio-------------
Global musicOn=False, musiclevel#=.5, danger=False												 ;music 
Global bgmusic_vol#=.5, bgmusicChannel, bgmusic 
Global dangermusic_vol#=0, dangermusicChannel, dangermusic     		     			             ;music
Global wade_vol#, run_vol#, wadechannel, runchannel                  							 ;player sfx
Global shoot, boom, uh                                                                           ;projectile

;Make audio
;If gamelevel=1 Then LoadMusic("spacepanic.mp3") ; load gamemusic
;If gamelevel=2 Then LoadMusic("Shadow Of The Beast - To The Castle.mp3") 
LoadSFX()
If musicOn=False     ; if music is off then turn off volume
	musiclevel#=0
EndIf

;--------------audio end---------

CreateScene()

CreateSpawn(-15,1,-30,-45)
CreateSpawn(15,1,-30,45)
CreateSpawn(-15,1,15,-135)
CreateSpawn(15,1,15,135)
CreateSpawn(0,12,0,0)
CreateSpawn(0,1,-9,180)

Global camera = CreateCamera()
CameraRange camera,0.1,1000

; create our own local player
localPlayerMesh = CreatePlayer(localID,localName)
old_x = EntityX(localPlayerMesh):old_y = EntityY(localPlayerMesh):old_z = EntityZ(localPlayerMesh) ; update camera position

; we send our color to the server
p.player = Object.player(GetPlayer(localID))
Net_SendMessage(3,p\r + "/" + p\g + "/" + p\b)

; &lt;&lt;&lt; colored txt mod by Raster Ron..
;store colors for chattxt.
Global cR = p\r 
Global cG = p\g 
Global cB = p\b 
; &lt;&lt;&lt; end colored txt mod by Raster Ron..


; variables used to send our positions at a constant delay (saves bandwidth but makes a constant ping)
Global updatePosition = MilliSecs()
Global updateTick = 50

; chat
Global messageDisplayNumber = 10
Global messageOffset
Dim message$(messageDisplayNumber)

Global chatMode
Global chatMessage$ = localName + "&gt; "
Global chatMillisecs = MilliSecs()
Global chatCursor

.mainLoop
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
tweeningPeriod = 1000 / gameLogicFPS
tweeningTime = MilliSecs() - tweeningPeriod
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
While Not KeyHit(1)
	
	;; I use tweening from castle demo here :
	;;
	;; 		- this allows to have very fast execution outside the tweening loop,
	;; 		  so the network is updated as fast as possible (needs Flip False)
	;;
	;; 		- this makes the game logic updated at a constant rate (Const FPS=)
	;;		  so no need to set deltatime (and it saves CPU time for other things)
	
	
	;; -------------------------------------------------------------------------------------------------; FAST EXECUTION (outside of tweening)
	;; -------------------------------------------------------------------------------------------------;
	
	; see the function, the interpolation variables are set properly here
	UpdateNetwork()
	
	;; -------------------------------------------------------------------------------------------------;
	
	Repeat
		tweeningElapsed = MilliSecs() - tweeningTime
	Until tweeningElapsed
	tweeningTicks = tweeningElapsed / tweeningPeriod
	tweeningRate# = Float(tweeningElapsed Mod tweeningPeriod)/Float(tweeningPeriod)
	For k = 1 To tweeningTicks
		tweeningTime = tweeningTime + tweeningPeriod
		If k = tweeningTicks Then CaptureWorld
		
		;; ---------------------------------------------------------------------------------------------; MAIN UPDATE
		;; ---------------------------------------------------------------------------------------------;
		
		;sound
		ChannelVolume wadechannel, wade_vol# ; adjust wadesound volume 0-1
		ChannelVolume runchannel, run_vol#   ; adjust runsound volume 0-1
		ChannelVolume bgmusicChannel, bgmusic_vol# ;
		ChannelVolume dangermusicChannel, dangermusic_vol# ;
		
		
		
		; update our player
		UpdateLocalPlayer()
		
		; the interpolation is made in this function
		UpdatePlayers()
		
		UpdateWorld()
		
		; update the bullets... only the server check for player kills
		UpdateBullets()
		
		UpdateHealthItems()
		
		UpdateChaseCam(camera,localPlayerMesh)
		
		;; ---------------------------------------------------------------------------------------------;
		
	Next
	
	RenderWorld tweeningRate
	
	;; -------------------------------------------------------------------------------------------------; 2D UPDATE
	;; -------------------------------------------------------------------------------------------------;
	
	DrawPlayersNames()
	DrawHealthItemStrengths()

	If ( KeyHit ( 28 ) ) And chatMode = 0 Then chatMode = 1 : FlushKeys() ; Enter for chat on/off
	If ( KeyHit ( 53 ) ) And chatMode = 0 Then chatMode = 1 ;/ for chat on

	If chatMode Then UpdateChat()

	DrawMessages()

	If KeyDown(15) Then DrawScoreTable() ; Tab for scores
	
	;; -------------------------------------------------------------------------------------------------;
	
	Flip
	
Wend
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;

Net_StopNetwork()

End

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function UpdateNetwork()
	
	; update incoming packets (better check ALL incoming messages so use While Wend)
	While Net_CheckMessage() ; will check for a new message and fill Net_MsgType, Net_MsgString$, Net_MsgFrom and Net_MsgTo variables so we can read it
		
		p.player = Object.player(GetPlayer(Net_MsgFrom)) ; get the player handle
		
		If Handle(p) = 0 And Net_MsgType &lt; 100 ; we received an update packet from a player we don't know
			; so we ask the server who he is and return because we can't update him for now
			; the server will resend us the info in a new player "100" message
			Net_RequestPlayer(Net_MsgFrom)
			Return
		EndIf
		
		Select Net_MsgType ; check the type of message
				
			Case 1 ; chat message
				
				NewMessage(Net_MsgString)
				
			Case 2 ; player position and angle, example of packing data into string
				
				offset1 = Instr(Net_MsgString,"/",1)
				offset2 = Instr(Net_MsgString,"/",offset1+1)
				offset3 = Instr(Net_MsgString,"/",offset2+1)
				
				p\previousX = p\nextX
				p\previousY = p\nextY
				p\previousZ = p\nextZ
				p\previousYaw = p\nextYaw
				
				p\nextX = Left(Net_MsgString,offset1-1)
				p\nextY = Mid(Net_MsgString,offset1+1,offset2-offset1-1)
				p\nextZ = Mid(Net_MsgString,offset2+1,offset3-offset2-1)
				p\nextYaw = Right(Net_MsgString,Len(Net_MsgString)-offset3)
				
				p\previousTime = p\nextTime
				p\nextTime = MilliSecs()
				
			Case 3 ; update player colors
				
				offset1 = Instr(Net_MsgString,"/",1)
				offset2 = Instr(Net_MsgString,"/",offset1+1)
				
				p\r = Left(Net_MsgString,offset1-1)
				p\g = Mid(Net_MsgString,offset1+1,offset2-offset1-1)
				p\b = Right(Net_MsgString,Len(Net_MsgString)-offset2)
				
				EntityColor p\mesh,p\r,p\g,p\b
				
			Case 4 ; a player fired
				
				CreateBullet(Net_MsgFrom)
				
			Case 5 ; a player lost some life
				
				p\life = Net_MsgString
				
			Case 6 ; a player killed another one

				k.player = Object.player(GetPlayer(Net_MsgString)) ; killed player ID in MsgData
				NewMessage(p\name + " killed " + k\name)
				
				shootChannel = PlaySound (boom) ;boom sound is started. 
				
				ResetPlayer(k\id)
				
			Case 7 ; the server sends us score update for a player
				
				offset = Instr(Net_MsgString,"/",1)
				
				p\kills = Left(Net_MsgString,offset-1)
				p\deaths = Right(Net_MsgString,Len(Net_MsgString)-offset)
				
			Case 8 ; health pickup
				
				h.health = Object.health(Net_MsgString)
				HideEntity h\mesh
				h\pickupTime = MilliSecs()
				
				
			Case 100 ; new player connected, OR the server tells us who is already connected so we can create players when joining the game
				
				If localMode = 2
					For p.player = Each player
						Net_SendMessage(2,p\nextX + "/" + p\nextY + "/" + p\nextZ + "/" + p\nextYaw,p\id,Net_MsgFrom)
						Net_SendMessage(3,p\r + "/" + p\g + "/" + p\b,p\id,Net_MsgFrom)
						
						Net_SendMessage(5,p\life,p\id,Net_MsgFrom)
						Net_SendMessage(7,p\kills+"/"+p\deaths,p\id,Net_MsgFrom)
					Next
				EndIf
				
				NewMessage(Net_MsgString + " connected")
				CreatePlayer(Net_MsgFrom,Net_MsgString)
				
			Case 101 ; a player has quit
				
				For p.player = Each player
					If Net_MsgFrom = p\id
						NewMessage(p\name + " disconnected")
						FreeEntity p\mesh
						Delete p
					EndIf
				Next
				
			Case 102 ; host has changed
				
				For p.player = Each player
					If Net_MsgFrom = p\id
						If p\id = localID
							AppTitle("Server : " + localName + " (port:" + net_port + ")")
							NewMessage("You are the new host")
							localMode = 2
						Else
							NewMessage(p\name + " is the new host")
						EndIf					
					EndIf
				Next
				
			Case 103 ; ping update
				
				For p.player = Each player
					If Net_MsgFrom = p\id
						p\ping = Net_MsgString
					EndIf
				Next
				
		End Select
		
	Wend
	
End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function UpdateLocalPlayer()
	
	; update our player
	p.player = Object.player(GetPlayer(localID)) ; get our player
	
	; inputs
	
	If Not chatmode
	
		If WK_DOWN ( ) Then MoveEntity p\mesh,0,0,0.3  ; up
		If SK_DOWN ( ) Then MoveEntity p\mesh,0,0,-0.3 ; down
		If AK_DOWN ( ) Then TurnEntity p\mesh,0,3,0    ; left
		If DK_DOWN ( ) Then TurnEntity p\mesh,0,-3,0   ; right
		
	EndIf

	If UP_KDOWN ( ) Then MoveEntity p\mesh,0,0,0.3 ; up
	If DOWN_KDOWN ( ) Then MoveEntity p\mesh,0,0,-0.3 ; down
	If LEFT_KDOWN ( ) Then TurnEntity p\mesh,0,3,0 ; left
	If RIGHT_KDOWN ( ) Then TurnEntity p\mesh,0,-3,0 ; right

	; jump
	If ( ( chatMode = 0 ) And ( KeyHit ( 57 ) ) Or ( MouseHit ( 2 ) ) ) ; right mse or Spacebar
		; check if player is one the ground
		LinePick(EntityX(p\mesh),EntityY(p\mesh),EntityZ(p\mesh),0,-1.2,0)
	If PickedEntity()
			p\velocityY = 0.5 ; set "inverse" of gravity velocity
		EndIf	
	EndIf
	
	; fire
	If ( ( chatMode = 0 ) And ( LM_DOWN ( ) ) ) ; left mouse down
		Net_SendMessage(4,"")
		CreateBullet(localID)
	EndIf
	
	; we create a message type "2" for player position
	If MilliSecs()-updatePosition &gt; updateTick
		
		Net_SendMessage(2,EntityX(p\mesh) + "/" + EntityY(p\mesh) + "/" + EntityZ(p\mesh) + "/" + EntityYaw(p\mesh))
		
		updatePosition = MilliSecs()
		
	EndIf
	
End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function UpdatePlayers()
	
	For p.player = Each player
		
		If p\id &lt;&gt; localID ; update other players only
			
			;; LINEAR INTERPOLATION ;;;;;;;;;;
			
			If p\nextTime &lt;&gt; p\previousTime ; if both packets arrived at the same time, we can't interpolate
				
				curTime# = Float(MilliSecs()-p\nextTime) / Float(p\nextTime-p\previousTime) ; curTime will be ideally 0.0-1.0, if it's &gt; 1.0 then it performs extrapolation
				
				If curTime &gt; 1 Then curTime = 1 ; extrapolation gives anoying jittering effects
				
				; special fix for yaw as EntityYaw returns a value beetween +180 ans -180, the interpolation can go backward
				If p\previousYaw &lt; 0 Then p\previousYaw = p\previousYaw + 360
				If p\nextYaw &lt; 0 Then p\nextYaw = p\nextYaw + 360
				If Abs(p\nextYaw-p\previousYaw) &gt; 180
					If p\nextYaw &gt; p\previousYaw
						p\previousYaw = p\previousYaw + 360
					Else
						p\previousYaw = p\previousYaw - 360
					EndIf
				EndIf
				
				PositionEntity p\mesh,p\previousX+(p\nextX-p\previousX)*curTime,p\previousY+(p\nextY-p\previousY)*curTime,p\previousZ+(p\nextZ-p\previousZ)*curTime
				RotateEntity p\mesh,0,p\previousYaw+(p\nextYaw-p\previousYaw)*curTime,0
				
			Else
				
				PositionEntity p\mesh,p\nextX,p\nextY,p\nextZ
				RotateEntity p\mesh,0,p\nextYaw,0
				
			EndIf
			;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
			
			;ResetEntity p\mesh ; reset entity is useful here because of collisions
			
		Else ; update our player, basically it just compute gravity
			
			p\velocityY = p\velocityY - 0.03 ; fake gravity
			If EntityY(p\mesh) - p\currentY &gt;= 0 ; if player is not falling we limit the gravity
				If p\velocityY &lt; -0.03 Then p\velocityY = -0.03
			EndIf
			
			p\currentY = EntityY(p\mesh)
			TranslateEntity p\mesh,0,p\velocityY,0
			
		EndIf
	Next
	
End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function CreatePlayer(id,name$)
	
	For p.player = Each player
		If p\id = id Then Return ; player already connected
	Next
	
	p.player = New player
	p\id = id
	p\name = name
	
	p\life = 80
	
	;build player entity
	p\mesh = CreateSphere()
	EntityType p\mesh,2
	EntityRadius p\mesh,1
	
	NameEntity p\mesh,Handle(p)
	
	nose = CreateSphere(8,p\mesh):EntityColor nose,255,0,0
	PositionEntity nose,0,0,1
	ScaleEntity nose,0.3,0.3,0.3
	
	eyeLeft = CreateSphere(8,p\mesh):EntityColor eyeLeft,255,255,255
	PositionEntity eyeLeft ,.29,.4,.7;1
	ScaleEntity eyeLeft ,0.2,0.2,0.2
	
	pupilLeft = CreateSphere(8,p\mesh):EntityColor pupilLeft ,0,0,0
	PositionEntity pupilLeft ,.3,.4,.9;1
	ScaleEntity pupilLeft ,0.05,0.05,0.02
	
	eyeRight = CreateSphere(8,p\mesh):EntityColor eyeRight ,255,255,255
	PositionEntity eyeRight ,-.29,.4,.7;1
	ScaleEntity eyeRight ,0.2,0.2,0.2
	
	pupilRight = CreateSphere(8,p\mesh):EntityColor pupilRight ,0,0,0
	PositionEntity pupilRight ,-.3,.4,.9;1
	ScaleEntity pupilRight ,0.05,0.05,0.02
	
	unaBrow = CreateCone(8,1,p\mesh):EntityColor unaBrow ,0,0,0
	PositionEntity unaBrow ,0,.45,.7
	RotateEntity unaBrow ,-180,0,0
	ScaleEntity unaBrow ,.7,.2,.3

	RandomSpawn(p\id)	

	;positions
	location=Rand (1,2)
	If location=1
		
		p\nextX = -20
		p\nextY = 6.5
		p\nextZ = -20
		
	Else 
		
		p\nextX = 20
		p\nextY = 6.5
		p\nextZ = 20
	EndIf
	p\nextYaw = -45
	
	p\previousX = p\nextX
	p\previousY = p\nextY
	p\previousZ = p\nextZ
	p\previousYaw = p\nextYaw
	
	p\r = Rand(255)
	p\g = Rand(255)
	p\b = Rand(255)
	EntityColor p\mesh,p\r,p\g,p\b
	
	PositionEntity p\mesh,p\nextX,p\nextY,p\nextZ
	RotateEntity p\mesh,0,p\nextYaw,0
	ResetEntity p\mesh
	
	p\currentY = p\nextY
	
	p\previousTime = MilliSecs()
	p\nextTime = MilliSecs()+1
	
	Return p\mesh
	
End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function ResetPlayer(id)
	
	p.player = Object.player(GetPlayer(id))
	
	p\life = 100
	
	location=Rand (1,2)
	If location=1
		
		p\nextX = -20
		p\nextY = 6.5
		p\nextZ = -20
		
	Else 
		
		p\nextX = 20
		p\nextY = 6.5
		p\nextZ = 20
	EndIf
	
	p\nextYaw = -45
	
	
	
	p\previousX = p\nextX
	p\previousY = p\nextY
	p\previousZ = p\nextZ
	p\previousYaw = p\nextYaw
	;back to origin.
	PositionEntity p\mesh,p\nextX,p\nextY,p\nextZ
	RotateEntity p\mesh,0,p\nextYaw,0
	ResetEntity p\mesh
	
	p\currentY = p\nextY
	
	p\previousTime = MilliSecs()
	p\nextTime = MilliSecs()+1
	
End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function GetPlayer(id)
	
	For p.player = Each player
		If p\id = id
			Return Handle(p)					
		EndIf
	Next
	
End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function DrawPlayersNames()
	
	For p.player = Each player
		If EntityVisible (p\mesh,camera)
			
			Color 255,255,255
			CameraProject(camera,EntityX(p\mesh),EntityY(p\mesh),EntityZ(p\mesh)) 	
			
			; only when not the host
			If p\id &lt;&gt; localID Then Text ProjectedX(),ProjectedY()-60,p\name,1,1 ; the more health, the brighter the color..
			
			Color 255,(255./100.)*p\life,(255./100.)*p\life ;?
			Text ProjectedX(),ProjectedY()-40,p\life,1,1
		EndIf
	Next
	
End Function
Function DrawHealthItemStrengths()
	
	For h.health = Each health
		If EntityVisible (h\mesh,camera)
			Color 255,0,0
			CameraProject(camera,EntityX(h\mesh),EntityY(h\mesh),EntityZ(h\mesh)) 
			
			Color 255,(255./100.)*h\power,(255./100.)*h\power
			If MilliSecs() - h\pickupTime &gt; h\respawnDelay Then ;ShowEntity h\mesh
				Text ProjectedX(),ProjectedY()-35,h\power,1,1
			EndIf
		EndIf
	Next
	
End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function CreateBullet(id)
	
	p.player = Object.player(GetPlayer(id))
	
	b.bullet = New bullet
	
	b\id = p\id
	
	b\mesh = CreateSphere(2)
	ScaleEntity b\mesh,0.2,0.2,0.2
	EntityColor b\mesh,255,255,0
	
	PositionEntity b\mesh,EntityX(p\mesh),EntityY(p\mesh),EntityZ(p\mesh)
	RotateEntity b\mesh,0,EntityYaw(p\mesh),0
	
	EntityType b\mesh,3
	EntityRadius b\mesh,0.2
	
	shootChannel = PlaySound (shoot) ;shooting sound is started.
	
	b\time = MilliSecs()
	
End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function UpdateBullets()
	
	For b.bullet = Each bullet
		
		MoveEntity b\mesh,0,0,1
		
		If CountCollisions(b\mesh)
			
			If localMode = 2 ; only the server compute bullets collision with player
				If GetEntityType(CollisionEntity(b\mesh,1)) = 2 ; a player is hit
					
					touchedPlayer.player = Object.player(EntityName(CollisionEntity(b\mesh,1)))
					touchedPlayer\life = touchedPlayer\life - 10
					
					If touchedPlayer\life &gt; 0 ; touched
						Net_SendMessage(5,touchedPlayer\life,touchedPlayer\id)
						Net_SendMessage(5,touchedPlayer\life,touchedPlayer\id,touchedPlayer\id)
					Else ; killed
						killerPlayer.player = Object.player(GetPlayer(b\id))
						
						killerPlayer\kills = killerPlayer\kills + 1
						touchedPlayer\deaths = touchedPlayer\deaths + 1						
						
						Net_SendMessage(6,touchedPlayer\id,killerPlayer\id)
						Net_SendMessage(6,touchedPlayer\id,killerPlayer\id,killerPlayer\id)
						
						Net_SendMessage(7,killerPlayer\kills+"/"+killerPlayer\deaths,killerPlayer\id)
						Net_SendMessage(7,killerPlayer\kills+"/"+killerPlayer\deaths,killerPlayer\id,killerPlayer\id)
						
						Net_SendMessage(7,touchedPlayer\kills+"/"+touchedPlayer\deaths,touchedPlayer\id)
						Net_SendMessage(7,touchedPlayer\kills+"/"+touchedPlayer\deaths,touchedPlayer\id,touchedPlayer\id)
						
						NewMessage(killerPlayer\name + " killed " + touchedPlayer\name)
						ResetPlayer(touchedPlayer\id)
					EndIf
					
				EndIf
			EndIf
			
			FreeEntity b\mesh
			Delete b
			
		ElseIf MilliSecs()-b\time &gt; 2000
			
			FreeEntity b\mesh
			Delete b
			
		EndIf
		
	Next
	
End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function CreateHealthItem(x#,y#,z#,power#,respawnDelay#)
	
	h.health = New health
	
	h\mesh = CreateMesh()
	
	h\power = power ; set item strength
	
	;h\respawnDelay = 10000
	h\respawnDelay = respawnDelay ; set according to valuableness(strength actually)..
	
	
	
	; create the object..
	mesh1 = CreateCube()
	mesh2 = CreateCube()
	
	ScaleMesh mesh1,.20,.5,.20
	ScaleMesh mesh2,.20,.5,.20:RotateMesh mesh2,90,0,0
	
	AddMesh(mesh1,h\mesh)
	AddMesh(mesh2,h\mesh)
	
	EntityColor h\mesh,255,0,0
	
	
	; if we are the host..
	If localMode = 2 Then EntityType h\mesh,4
	EntityRadius h\mesh,0.5
	
	PositionEntity h\mesh,x,y,z
	
	NameEntity h\mesh,Handle(h)
	
End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function UpdateHealthItems()
	
	For h.health = Each health
		
		TurnEntity h\mesh,0,-2,0
		
		If CountCollisions(h\mesh)
			
			If localMode = 2 ; only the server computes collision with player
				If GetEntityType(CollisionEntity(h\mesh,1)) = 2 ; a player collided
					
					touchedPlayer.player = Object.player(EntityName(CollisionEntity(h\mesh,1)))
					
					h\pickupTime = MilliSecs() ;store time of pickup 
					HideEntity h\mesh
					ResetEntity h\mesh ;empty collisions buffer for this entity
					
					Net_SendMessage(8,Handle(h))
					
					If touchedPlayer\life &lt; 100 ; touched healthpowerup..
						
						;touchedPlayer\life = touchedPlayer\life + 10
						;touchedPlayer\life = touchedPlayer\life + 50
						touchedPlayer\life = touchedPlayer\life + h\power
						
						If touchedPlayer\life &gt;100
							touchedPlayer\life = 100
							
						EndIf
						Net_SendMessage(5,touchedPlayer\life,touchedPlayer\id)
						Net_SendMessage(5,touchedPlayer\life,touchedPlayer\id,touchedPlayer\id)
						
					EndIf
					
				EndIf
			EndIf
			
		EndIf
		
		If MilliSecs() - h\pickupTime &gt; h\respawnDelay Then ShowEntity h\mesh
		
	Next
	
End Function
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function NewMessage(msg$)
	
	messageOffset = messageOffset + 1
	
	If messageOffset &gt; messageDisplayNumber
		
		messageOffset = messageOffset - 1
		
		For i = 2 To messageDisplayNumber
			message(i-1) = message(i)		
		Next
		
		message(messageDisplayNumber) = msg
		
	Else
		
		message(messageOffset) = msg
		
	EndIf
	
End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function DrawMessages()
	
	Color 255,255,255
	
	For i = 1 To messageOffset
		
		;Text 0,(i-1)*15,message(i)	
		
		; &lt;&lt;&lt; colored txt mod by Raster Ron
		loc = Instr (message(i), "",1)
		If loc &gt; 1 Then 
			colorMessage$ = Mid$(message(i), 1, Len(message(i)) - 7 ) 
			Hex$ = Right$(message(i),6)		 
			Set_Color_Hex(Hex$) 
			Text 0,(i-1)*15,colorMessage$ 
		Else  
			Color 255,255,255 
			Text 0,(i-1)*15,message(i) 
		End If	
		; &lt;&lt;&lt; End colored txt mod by Raster Ron
		
	Next
	
End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function UpdateChat()
	
	key = GetKey()
	
	If key
		If key = 13
			If chatMessage &lt;&gt; localName + "&gt; "
				For i = Len(localName + "&gt; ") To Len(chatMessage)
					If Mid(chatMessage,i,1) &lt;&gt; " "
						
						; &lt;&lt;&lt; colored txt mod by Raster Ron
						chatColor$ = RGB_To_TriHex(cR,cG,cB)
						chatMessage = chatMessage + "" + chatColor$
						; &lt;&lt;&lt; end colored txt mod by Raster Ron					
						
						
						Net_SendMessage(1,chatMessage)
						NewMessage(chatMessage)
						Exit
					EndIf
				Next
			EndIf
			chatMessage = localName + "&gt; "
			chatMode = 0
		ElseIf key = 8 And Len(chatMessage) &gt; Len ( localName + "&gt; " )
			chatMessage = Left(chatMessage,Len(chatMessage)-1)
		ElseIf key &gt; 31 And key &lt; 127
			chatMessage = chatMessage + Chr(key)
		EndIf
	EndIf
	
	Color 255,255,255
	Rect 0,GraphicsHeight()-20,GraphicsWidth(),20,1
	
	Color 0,0,0
	Rect 0,GraphicsHeight()-20,GraphicsWidth(),20,0
	
	
	If MilliSecs()-chatMillisecs &gt; 500
		chatCursor = Not chatCursor
		chatMillisecs = MilliSecs()
	EndIf
	
	If chatCursor
		Text 5,GraphicsHeight()-17,chatMessage + "|"
	Else
		Text 5,GraphicsHeight()-17,chatMessage
	EndIf
	
End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function DrawScoreTable()
	
	For p.player = Each player
		count = count + 1
	Next
	
	baseX = (GraphicsWidth()-350)/2
	baseY = (GraphicsHeight()-(35+20*count))/2
	
	Color 0,0,0
	Rect baseX,baseY,350,35+20*count,1
	
	Color 255,192,0
	Rect baseX,baseY,350,35+20*count,0
	
	Text baseX+10,baseY+10,"Player          Kills     Deaths     Ping"
	Line baseX,baseY+25,baseX+349,baseY+25
	
	For p.player = Each player
		
		Color 255,255,255
		If p\id = localID Then Color 255,100,100
		
		i = i + 1
		Text baseX+10,baseY+10+20*i,p\name
		Text baseX+157,baseY+10+20*i,p\kills,1,0
		Text baseX+240,baseY+10+20*i,p\deaths,1,0
		Text baseX+322,baseY+10+20*i,p\ping,1,0
	Next
	
End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function UpdateChaseCam(camera,player) ; thanks to jfk EO-11110 on bb forums for this function !
	PositionEntity camera,EntityX(player,1),EntityY(player,1),EntityZ(player,1)
	ResetEntity camera
	x#=EntityX(player)+Sin(-EntityYaw(player)+180)*x_dis#
	y#=EntityY(player)+y_dis#
	z#=EntityZ(player)+Cos(-EntityYaw(player)+180)*z_dis#
	obstacle=LinePick(EntityX(player),EntityY(player),EntityZ(player),(x-EntityX(player)),y_dis#,(z-EntityZ(player)),0.1)
	If obstacle=0
		new_x#=x
		new_y#=y
		new_z#=z
	Else
		new_x#=PickedX()
		new_y#=PickedY()
		new_z#=PickedZ()
	EndIf
	If bounce_cam=0
		PositionEntity camera,new_x,new_y,new_z
	Else
		x=old_x+((New_x-old_x)/bounce_div#)
		y=old_y+((New_y-old_y)/bounce_div#)
		z=old_z+((New_z-old_z)/bounce_div#)
		PositionEntity camera,x,y,z
	EndIf
	PointEntity camera,player
	TurnEntity camera,-20,0,0     ; if you want the player mesh more on the bottom of the screen
	old_x#=EntityX(camera)
	old_y#=EntityY(camera)
	old_z#=EntityZ(camera)
End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function CreateScene()
	
	texture = TextureCreate(128)
	
	ground = CreatePlane()
	EntityColor ground,150,150,150
	EntityTexture ground,texture
	
	cube = CreateCube():EntityColor cube,150,200,150
	ScaleEntity cube,5,5,5:PositionEntity cube,0,5,0
	EntityTexture cube,texture
	
	sphere = CreateSphere(16):EntityColor sphere,200,150,150
	ScaleEntity sphere,3,1,3:PositionEntity sphere,0,9.7,0
	
	platform = CreateCube():EntityColor platform,150,150,200
	ScaleEntity platform,3,1,10:PositionEntity platform,0,4.13,-13.15
	TurnEntity platform,-30,0,0
	EntityTexture platform,texture
	
	; spawnpoint 
	spawner1 = CreateSphere() :EntityColor spawner1 ,150,150,150;  &lt;&lt;&lt;&lt;
	ScaleEntity spawner1 ,2,3,2:PositionEntity spawner1 ,-20,.1,-20 ;&lt;&lt;&lt;&lt;
	EntityTexture spawner1 ,texture
	
	column= CreateCylinder()
	ScaleEntity column,2,3,2:PositionEntity column,20,.1,20 ;&lt;&lt;&lt;&lt;
	EntityTexture column,texture
	
	FreeTexture texture
	
	
	
	EntityType ground,1:EntityPickMode ground,2
	EntityType cube,1:EntityPickMode cube,2
	EntityType sphere,1:EntityPickMode sphere,2
	EntityType platform,1:EntityPickMode platform,2
	EntityType spawner1,1:EntityPickMode spawner1,2
	EntityType column,1:EntityPickMode column,2
	
	
	
	; setup light..
	light = CreateLight()
	TurnEntity light,30,70,0
	
	; create health upgrade items.	
	CreateHealthItem(0,12,0,100,100000) ; the one on top
	CreateHealthItem(0,1,-10,10,10000)  ; undenneath the ramp
	CreateHealthItem(0,3,-20,30,30000)  ; on the ramp
	
	
	;; COLLISIONS
	Collisions 2,1,2,3 ; player to scene
	Collisions 2,2,1,3 ; player to player
	
	Collisions 3,1,2,1 ; bullet to scene
	Collisions 3,2,1,1 ; bullet to player

	Collisions 2,4,1,2 ; player to health
	
End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function TextureCreate(size)
	texture = CreateTexture(size,size,9)
	SetBuffer TextureBuffer(texture)
	Color 255,255,255
	Rect 0,0,size,size,1
	Color 0,0,0
	Rect 0,0,size,size,0
	Line 0,0,size,size
	Line 0,size,size,0
	SetBuffer BackBuffer()
	Return texture
End Function

Function GDI_VKeyDown ( VirtualKey, IgnoreFocus = False )
	
	If ( IgnoreFocus = True ) And ( api_GetActiveWindow ( ) = 0 ) Then Return
	Return ( api_GetAsyncKeyState% ( VirtualKey ) And %1000000000000000 ) &gt; 0
	
End Function

Function UP_KDOWN ( ignore_focus% = 1 )
	
	Return ( GDI_VKeyDown ( VK_UP, ignore_focus% ) )
	
End Function

Function DOWN_KDOWN ( ignore_focus% = 1 )
	
	Return ( GDI_VKeyDown ( VK_DOWN, ignore_focus% ) )
	
End Function

Function LEFT_KDOWN ( ignore_focus% = 1 )
	
	Return ( GDI_VKeyDown ( VK_LEFT, ignore_focus% ) )
	
End Function

Function RIGHT_KDOWN ( ignore_focus% = 1 )
	
	Return ( GDI_VKeyDown ( VK_RIGHT, ignore_focus% ) )
	
End Function

Function WK_DOWN ( ignore_focus% = 1 )
	
	Return ( GDI_VKeyDown ( VK_W, ignore_focus% ) )
	
End Function

Function SK_DOWN ( ignore_focus% = 1 )
	
	Return ( GDI_VKeyDown ( VK_S, ignore_focus% ) )
	
End Function

Function AK_DOWN ( ignore_focus% = 1 )
	
	Return ( GDI_VKeyDown ( VK_A, ignore_focus% ) )
	
End Function

Function DK_DOWN ( ignore_focus% = 1 )
	
	Return ( GDI_VKeyDown ( VK_D, ignore_focus% ) )
	
End Function

Function LM_DOWN ( ignore_focus% = 1 )
	
	Return ( GDI_VKeyDown ( VK_LEFTMOUSE, ignore_focus% ) )
	
End Function

Function RM_DOWN ( ignore_focus% = 1 )
	
	Return ( GDI_VKeyDown ( VK_RIGHTMOUSE, ignore_focus% ) )
	
End Function

Function W_UP ( ignore_focus% = 1 )
	
	Return ( ( WK_DOWN ( ignore_focus% ) + ( UP_KDOWN ( ignore_focus% ) ) ) )
	
End Function

Function S_DOWN ( ignore_focus% = 1 )
	
	Return ( ( SK_DOWN ( ignore_focus% ) + ( DOWN_KDOWN ( ignore_focus% ) ) ) )
	
End Function

Function A_LEFT ( ignore_focus% = 1 )
	
	Return ( ( AK_DOWN ( ignore_focus% ) + ( LEFT_KDOWN ( ignore_focus% ) ) ) )
	
End Function

Function D_RIGHT ( ignore_focus% = 1 )
	
	Return ( ( DK_DOWN ( ignore_focus% ) + ( RIGHT_KDOWN ( ignore_focus% ) ) ) )
	
End Function

;======================================================================================
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function LoadSFX()
	run = LoadSound ("sounds\gravel.wav")
	wade = LoadSound ("sounds\water.wav")
	SoundVolume run, 0
	SoundVolume wade, 0
	LoopSound run
	LoopSound wade
	
	runchannel = PlaySound (run)
	wadechannel = PlaySound (wade)
	
    ;------------------------------
	
	shoot=LoadSound( "sounds\shoot.wav" )
	SoundVolume shoot, .9
	
	boom=LoadSound( "sounds\boom.wav" )
	SoundVolume boom, .5
	
	bark = LoadSound("sounds\bark.wav")
	SoundVolume bark, .5
		;		   		barkChannel = PlaySound (bark) ;barking sound is started.
	
	uh=LoadSound( "sounds\Asthma_Sound.wav_10720.wav" )
	SoundVolume uh, .9
End Function

Function LoadMusic(files$)

	bgmusic = LoadSound (files$)
	SoundVolume bgmusic,.5 
	LoopSound bgmusic
	bgmusicChannel= PlaySound (bgmusic)

	dangermusic = LoadSound ("Shadow Of The Beast - Aarbronsrevenge.mp3")
    SoundVolume dangermusic,0
    LoopSound dangermusic
	dangermusicChannel= PlaySound(dangermusic)

End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function SpawnPlayer(id,spawnId)

	p.player = Object.player(GetPlayer(id))
	
	For s.spawn = Each spawn
		If s\spawnId = spawnId Then Exit
	Next

	p\life = 100

	p\nextX = s\x
	p\nextY = s\y
	p\nextZ = s\z
	p\nextYaw = s\yaw

	p\previousX = p\nextX
	p\previousY = p\nextY
	p\previousZ = p\nextZ
	p\previousYaw = p\nextYaw

	PositionEntity p\mesh,p\nextX,p\nextY,p\nextZ
	RotateEntity p\mesh,0,p\nextYaw,0
	ResetEntity p\mesh
	
	p\currentY = p\nextY
	
	p\previousTime = MilliSecs()
	p\nextTime = MilliSecs()+1

End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function RandomSpawn(id)

	p.player = Object.player(GetPlayer(id))

	; if we are server, spawn player at random location
	If localMode = 2
		randSpawn = Rand(spawns)
		SpawnPlayer(p\id,randSpawn)
		Net_SendMessage(9,randSpawn,p\id)
		Net_SendMessage(9,randSpawn,p\id,p\id)
	Else ; else default spawn = first spawn created
		SpawnPlayer(p\id,1)
	EndIf

End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function CreateSpawn(x#,y#,z#,yaw#)

	spawns = spawns + 1

	s.spawn = New spawn
	s\spawnId = spawns
	s\x = x
	s\y = y
	s\z = z
	s\yaw = yaw

End Function
</textarea><br><br>~GF <br><br></td></tr></table><br>
<a name="1294077"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rick Nasher</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#175">[#175]</a></td></tr></table></td></tr><tr ><td class="posttext"> I'm now testing, many thanks Flanker. At first sight your code fix seems to solve the issue by doing it on the server (case 9).<br>I'll do some more testing with GF. <br><br></td></tr></table><br>
<a name="1294085"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >RGR</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#176">[#176]</a></td></tr></table></td></tr><tr ><td class="posttext"> You may want to calculate the Hexvalues instead of looping and searching through an array<br><br><br>Hex8.bb:<br><br><pre class=code>
Function RGB_To_TriHex$(iR%,iG%,iB%)
	Return ToHex8(iR) + ToHex8(iG) + ToHex8(iB)
End Function


Function FromHex8%(sHex$)
	Local iValue%, iValue2%
	sHex=Upper(Right$("0"+sHex$,2))
	iValue=(Asc(Right(sHex, 1))-48)
	iValue=iValue-(iValue&gt;9)*7

	iValue2=(Asc(Left(sHex, 1))-48)
	iValue2=(iValue2-(iValue2&gt;9)*7)*16+iValue

	Return iValue2
End Function


Function ToHex8$(iValue%)
	Return Right("0"+Hex$(iValue And 255),2)
End Function


Function Set_Color_Hex(sColorHex$)
	Color FromHex8(Left(sColorHex,2)),FromHex8(Mid(sColorHex,3,2)),FromHex8(Right(sColorHex,2))
End Function
</pre> <br><br></td></tr></table><br>
<a name="1294086"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Guy Fawkes</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#177">[#177]</a></td></tr></table></td></tr><tr ><td class="posttext"> Good point. Thanks, @RGR.<br><br>~GF <br><br></td></tr></table><br>
<a name="1294087"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Guy Fawkes</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#178">[#178]</a></td></tr></table></td></tr><tr ><td class="posttext"> @Flanker : It seems the spawn code works, BUT now it's created a new problem. When a player is either shot or killed by another player, the player killed once respawned cannot grab health at all.<br><br>It looks like it's a network thing from our Beta tests.<br><br>~GF <br><br></td></tr></table><br>
<a name="1294088"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rick Nasher</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#179">[#179]</a></td></tr></table></td></tr><tr ><td class="posttext"> @Flanker:<br>fixed, though the fix may mess up other stuff.. <br><br></td></tr></table><br>
<a name="1294146"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Guy Fawkes</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#180">[#180]</a></td></tr></table></td></tr><tr ><td class="posttext"> Not necessarily, @Rick Nasher. I just tested it last night after you left me with the Server. Whenever someone becomes the Server after the original user of the Server leaves, the same thing happens. I can't grab any health.<br><br>~GF <br><br></td></tr></table><br>
<a name="1294173"></a>

<a name="1294174"></a>

<a name="1294175"></a>

<a name="1294177"></a>

<a name="1294291"></a>

<a name="1294292"></a>

<a name="1294293"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rick Nasher</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#181">[#181]</a></td></tr></table></td></tr><tr ><td class="posttext"> <b>@Flanker:</b><br>Indeed it appears to fix the spawning issues, for which we thank you. However, after adding your previous health-upgrade code to this it introduces another issue: <br><b>only the host can now upgrade it's health.</b> Don't really get why. <br><br><u>After comparing your 2 versions I see the following changes:</u><br>-ResetPlayer() has been replaced by SpawnPlayer() in UpdateNetwork().<br>-UpdateWorld() in the main loop has moved from just after UpdatePlayers() to after UpdateBullets().<br>-In UpdatePlayers() the line ";ResetEntity p\mesh" has been re-activated by removing the ";".<br><br>If I put back the ";" then it appears to work, but as GF pointed out, when the original host leaves, then the unable-to-upgrade-health issue re-emerges and remains and applies also when adding a new client. <br><br>Your 2 original code examples combined into 1 below.<br><b>ADVANCED 3D EXAMPLE(spawn and healthupgrade).bb</b><br><textarea class=codebox name="code" wrap=OFF readonly="true" rows="15" cols="80">
; Flanker's Spawn fixed version combined with his health upgrade version.

SeedRnd MilliSecs()

Const gameLogicFPS = 60

Include "UDPNetwork_lib.bb"

Global localID
Global localName$ = Input("Enter your name : ")
If localName = "" Then localName = "player" + Rand(100,999)

Global localPlayerMesh

Type player
	Field id
	Field name$
	Field ping
	
	Field life
	Field kills
	Field deaths
	
	Field mesh
	Field r,g,b
	
	Field nextX#,nextY#,nextZ#
	Field previousX#,previousY#,previousZ#
	Field nextYaw#
	Field previousYaw#
	Field nextTime
	Field previousTime
	
	Field lastPacket
	
	Field currentY#
	Field velocityY#
End Type

Type bullet
	Field mesh
	Field angle#
	Field time
	Field id ; id of player who fired
End Type

Type spawn
	Field spawnId
	Field x#,y#,z#
	Field yaw#
End Type
Global spawns ; number of spawn points

Type health
	Field mesh
	Field pickupTime
	Field respawnDelay
End Type

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
; Camera code from jfk EO-11110, thanks
Global bounce_cam=1 ;  smooth camera motion? (0/1)
Global bounce_div#=10.0 ; the higher, the more sluggish the camera will follow. Recc: 3.0 to 20.0
; some globals used by ChaseCam
Global old_x#,old_y#,old_z#
; desired distance between camera and player mesh
Global x_dis#=7.0,y_dis#=3,z_dis#=7.0,y_dis_or#=y_dis#
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;

; network init ----------------------------------------;
Global localMode = Net_StartInput() ; bring the library "console" to connect

If localMode = 1 Or localMode = 2 ; 1 means we are client, 2 means we are server
	
	localID = Net_CreatePlayer(localName) ; this command inits the server or local client
	
	If localID = 0 ; error
		Net_StopNetwork() ; close the network properly
		RuntimeError("Failed to create player.")
	EndIf
	
	If localMode = 1 Then AppTitle("Client : " + localName + " (port:" + net_port + "/ ID=" + localID + ")")
	If localMode = 2 Then AppTitle("Server : " + localName + " (port:" + net_port + "/ ID=" + localID + ")")
	
Else ; error
	Net_StopNetwork()
	RuntimeError("Failed to start game.")
EndIf
;------------------------------------------------------;

Graphics3D 640,480,32,2
SetBuffer BackBuffer()

CreateScene()


CreateSpawn(-15,1,-30,-45)
CreateSpawn(15,1,-30,45)
CreateSpawn(-15,1,15,-135)
CreateSpawn(15,1,15,135)
CreateSpawn(0,12,0,0)
CreateSpawn(0,1,-9,180)


Global camera = CreateCamera()
CameraRange camera,0.1,1000

; create our own local player
localPlayerMesh = CreatePlayer(localID,localName)
old_x = EntityX(localPlayerMesh):old_y = EntityY(localPlayerMesh):old_z = EntityZ(localPlayerMesh) ; update camera position

; we send our color to the server
p.player = Object.player(GetPlayer(localID))
Net_SendMessage(3,p\r + "/" + p\g + "/" + p\b)

; variables used to send our positions at a constant delay (saves bandwidth but makes a constant ping)
Global updatePosition = MilliSecs()
Global updateTick = 50

; chat
Global messageDisplayNumber = 10
Global messageOffset
Dim message$(messageDisplayNumber)

Global chatMode
Global chatMessage$ = localName + "&gt; "
Global chatMillisecs = MilliSecs()
Global chatCursor

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
tweeningPeriod = 1000 / gameLogicFPS
tweeningTime = MilliSecs() - tweeningPeriod
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
While Not KeyHit(1)
	
	;; I use tweening from castle demo here :
	;;
	;; 		- this allows to have very fast execution outside the tweening loop,
	;; 		  so the network is updated as fast as possible (needs Flip False)
	;;
	;; 		- this makes the game logic updated at a constant rate (Const FPS=)
	;;		  so no need to set deltatime (and it saves CPU time for other things)
	
	
	;; -------------------------------------------------------------------------------------------------; FAST EXECUTION (outside of tweening)
	;; -------------------------------------------------------------------------------------------------;
	
	; see the function, the interpolation variables are set properly here
	UpdateNetwork()
	
	;; -------------------------------------------------------------------------------------------------;
	
	Repeat
		tweeningElapsed = MilliSecs() - tweeningTime
	Until tweeningElapsed
	tweeningTicks = tweeningElapsed / tweeningPeriod
	tweeningRate# = Float(tweeningElapsed Mod tweeningPeriod)/Float(tweeningPeriod)
	For k = 1 To tweeningTicks
		tweeningTime = tweeningTime + tweeningPeriod
		If k = tweeningTicks Then CaptureWorld
		
		;; ---------------------------------------------------------------------------------------------; MAIN UPDATE
		;; ---------------------------------------------------------------------------------------------;
		
		; update our player
		UpdateLocalPlayer()
		
		; the interpolation is made in this function
		UpdatePlayers()
		
		;UpdateWorld()
		
		; update the bullets... only the server check for player kills
		UpdateBullets()
		
		UpdateHealthItems()	
		
		UpdateWorld()
		
		
		UpdateChaseCam(camera,localPlayerMesh)
		
		;; ---------------------------------------------------------------------------------------------;
		
	Next
	
	RenderWorld tweeningRate
	
	;; -------------------------------------------------------------------------------------------------; 2D UPDATE
	;; -------------------------------------------------------------------------------------------------;
	
	DrawPlayersNames()
	
	If KeyHit(28) And chatMode = 0 Then chatMode = 1:FlushKeys()
	If chatMode = 1 Then UpdateChat()
	
	DrawMessages()
	
	If KeyDown(15) Then DrawScoreTable()
	
	;; -------------------------------------------------------------------------------------------------;
	
	Flip
	
Wend
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;

Net_StopNetwork()

End

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function UpdateNetwork()
	
	; update incoming packets (better check ALL incoming messages so use While Wend)
	While Net_CheckMessage() ; will check for a new message and fill Net_MsgType, Net_MsgString$, Net_MsgFrom and Net_MsgTo variables so we can read it
		
		p.player = Object.player(GetPlayer(Net_MsgFrom)) ; get the player handle
		
		If Handle(p) = 0 And Net_MsgType &lt; 100 ; we received an update packet from a player we don't know
			; so we ask the server who he is and return because we can't update him for now
			; the server will resend us the info in a new player "100" message
			Net_RequestPlayer(Net_MsgFrom)
			Return
		EndIf
		
		Select Net_MsgType ; check the type of message
				
			Case 1 ; chat message
				
				NewMessage(Net_MsgString)
				
			Case 2 ; player position and angle, example of packing data into string
				
				offset1 = Instr(Net_MsgString,"/",1)
				offset2 = Instr(Net_MsgString,"/",offset1+1)
				offset3 = Instr(Net_MsgString,"/",offset2+1)
				
				p\previousX = p\nextX
				p\previousY = p\nextY
				p\previousZ = p\nextZ
				p\previousYaw = p\nextYaw
				
				p\nextX = Left(Net_MsgString,offset1-1)
				p\nextY = Mid(Net_MsgString,offset1+1,offset2-offset1-1)
				p\nextZ = Mid(Net_MsgString,offset2+1,offset3-offset2-1)
				p\nextYaw = Right(Net_MsgString,Len(Net_MsgString)-offset3)
				
				p\previousTime = p\nextTime
				p\nextTime = MilliSecs()
				
			Case 3 ; update player colors
				
				offset1 = Instr(Net_MsgString,"/",1)
				offset2 = Instr(Net_MsgString,"/",offset1+1)
				
				p\r = Left(Net_MsgString,offset1-1)
				p\g = Mid(Net_MsgString,offset1+1,offset2-offset1-1)
				p\b = Right(Net_MsgString,Len(Net_MsgString)-offset2)
				
				EntityColor p\mesh,p\r,p\g,p\b
				
			Case 4 ; a player fired
				
				CreateBullet(Net_MsgFrom)
				
			Case 5 ; a player lost some life
				
				p\life = Net_MsgString
				
			Case 6 ; a player killed another one
				
				k.player = Object.player(GetPlayer(Net_MsgString)) ; killed player ID in MsgData
				NewMessage(p\name + " killed " + k\name)
				
			Case 7 ; the server sends us score update for a player
				
				offset = Instr(Net_MsgString,"/",1)
				
				p\kills = Left(Net_MsgString,offset-1)
				p\deaths = Right(Net_MsgString,Len(Net_MsgString)-offset)
				
			Case 8 ; health pickup
				
				h.health = Object.health(Net_MsgString)
				HideEntity h\mesh
				h\pickupTime = MilliSecs()
				
			Case 9 ; player spawn
				
				SpawnPlayer(p\id,Net_MsgString)				
				
			Case 100 ; new player connected, OR the server tells us who is already connected so we can create players when joining the game
				
				If localMode = 2
					For p.player = Each player
						Net_SendMessage(2,p\nextX + "/" + p\nextY + "/" + p\nextZ + "/" + p\nextYaw,p\id,Net_MsgFrom)
						Net_SendMessage(3,p\r + "/" + p\g + "/" + p\b,p\id,Net_MsgFrom)
						
						Net_SendMessage(5,p\life,p\id,Net_MsgFrom)
						Net_SendMessage(7,p\kills+"/"+p\deaths,p\id,Net_MsgFrom)
					Next
				EndIf
				
				NewMessage(Net_MsgString + " connected")
				CreatePlayer(Net_MsgFrom,Net_MsgString)
				
			Case 101 ; a player has quit
				
				For p.player = Each player
					If Net_MsgFrom = p\id
						NewMessage(p\name + " disconnected")
						FreeEntity p\mesh
						Delete p
					EndIf
				Next
				
			Case 102 ; host has changed
				
				For p.player = Each player
					If Net_MsgFrom = p\id
						If p\id = localID
							AppTitle("Server : " + localName + " (port:" + net_port + ")")
							NewMessage("You are the new host")
							localMode = 2
						Else
							NewMessage(p\name + " is the new host")
						EndIf					
					EndIf
				Next
				
			Case 103 ; ping update
				
				For p.player = Each player
					If Net_MsgFrom = p\id
						p\ping = Net_MsgString
					EndIf
				Next
				
		End Select
		
	Wend
	
End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function UpdateLocalPlayer()
	
	; update our player
	p.player = Object.player(GetPlayer(localID)) ; get our player
	
	; inputs
	If KeyDown(200) Then MoveEntity p\mesh,0,0,0.3
	If KeyDown(208) Then MoveEntity p\mesh,0,0,-0.3
	If KeyDown(203) Then TurnEntity p\mesh,0,3,0
	If KeyDown(205) Then TurnEntity p\mesh,0,-3,0
	
	; fire
	If MouseHit(1)
		Net_SendMessage(4,"")
		CreateBullet(localID)
	EndIf
	
	; jump
	If MouseHit(2)
		; check if player is one the ground
		LinePick(EntityX(p\mesh),EntityY(p\mesh),EntityZ(p\mesh),0,-1.2,0)
		If PickedEntity()
			p\velocityY = 0.5 ; set "inverse" of gravity velocity
		EndIf	
	EndIf
	
	; we create a message type "2" for player position
	If MilliSecs()-updatePosition &gt; updateTick
		
		Net_SendMessage(2,EntityX(p\mesh) + "/" + EntityY(p\mesh) + "/" + EntityZ(p\mesh) + "/" + EntityYaw(p\mesh))
		updatePosition = MilliSecs()
	EndIf
	
End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function UpdatePlayers()
	
	For p.player = Each player
		
		If p\id &lt;&gt; localID ; update other players only
			
			;; LINEAR INTERPOLATION ;;;;;;;;;;
			
			If p\nextTime &lt;&gt; p\previousTime ; if both packets arrived at the same time, we can't interpolate
				
				curTime# = Float(MilliSecs()-p\nextTime) / Float(p\nextTime-p\previousTime) ; curTime will be ideally 0.0-1.0, if it's &gt; 1.0 then it performs extrapolation
				
				If curTime &gt; 1 Then curTime = 1 ; extrapolation gives anoying jittering effects
				
				; special fix for yaw as EntityYaw returns a value beetween +180 ans -180, the interpolation can go backward
				If p\previousYaw &lt; 0 Then p\previousYaw = p\previousYaw + 360
				If p\nextYaw &lt; 0 Then p\nextYaw = p\nextYaw + 360
				If Abs(p\nextYaw-p\previousYaw) &gt; 180
					If p\nextYaw &gt; p\previousYaw
						p\previousYaw = p\previousYaw + 360
					Else
						p\previousYaw = p\previousYaw - 360
					EndIf
				EndIf
				
				PositionEntity p\mesh,p\previousX+(p\nextX-p\previousX)*curTime,p\previousY+(p\nextY-p\previousY)*curTime,p\previousZ+(p\nextZ-p\previousZ)*curTime
				RotateEntity p\mesh,0,p\previousYaw+(p\nextYaw-p\previousYaw)*curTime,0
				
			Else
				
				PositionEntity p\mesh,p\nextX,p\nextY,p\nextZ
				RotateEntity p\mesh,0,p\nextYaw,0
				
			EndIf
			;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
			
			;ResetEntity p\mesh ; reset entity is useful here because of collisions  &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt; diff.
			
		Else ; update our player, basically it just compute gravity
			
			p\velocityY = p\velocityY - 0.03 ; fake gravity
			If EntityY(p\mesh) - p\currentY &gt;= 0 ; if player is not falling we limit the gravity
				If p\velocityY &lt; -0.03 Then p\velocityY = -0.03
			EndIf
			
			p\currentY = EntityY(p\mesh)
			TranslateEntity p\mesh,0,p\velocityY,0
			
		EndIf
	Next
	
End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function CreatePlayer(id,name$)
	
	DebugLog "create player"
	
	For p.player = Each player
		If p\id = id Then Return ; player already connected
	Next
	
	p.player = New player
	p\id = id
	p\name = name
	
	p\life = 100
	
	p\mesh = CreateSphere()
	EntityType p\mesh,2
	EntityRadius p\mesh,1
	
	NameEntity p\mesh,Handle(p)
	
	nose = CreateSphere(8,p\mesh):EntityColor nose,255,0,0
	PositionEntity nose,0,0,1
	ScaleEntity nose,0.3,0.3,0.3
	
	eyeLeft = CreateSphere(8,p\mesh):EntityColor eyeLeft,255,255,255
	PositionEntity eyeLeft ,.29,.4,.7;1
	ScaleEntity eyeLeft ,0.2,0.2,0.2
	
	pupilLeft = CreateSphere(8,p\mesh):EntityColor pupilLeft ,0,0,0
	PositionEntity pupilLeft ,.3,.4,.9;1
	ScaleEntity pupilLeft ,0.05,0.05,0.02
	
	eyeRight = CreateSphere(8,p\mesh):EntityColor eyeRight ,255,255,255
	PositionEntity eyeRight ,-.29,.4,.7;1
	ScaleEntity eyeRight ,0.2,0.2,0.2
	
	pupilRight = CreateSphere(8,p\mesh):EntityColor pupilRight ,0,0,0
	PositionEntity pupilRight ,-.3,.4,.9;1
	ScaleEntity pupilRight ,0.05,0.05,0.02
	
	unaBrow = CreateCone(8,1,p\mesh):EntityColor unaBrow ,0,0,0
	PositionEntity unaBrow ,0,.45,.7
	RotateEntity unaBrow ,-180,0,0
	ScaleEntity unaBrow ,.7,.2,.3
	
	RandomSpawn(p\id)
	
	p\r = Rand(255)
	p\g = Rand(255)
	p\b = Rand(255)
	EntityColor p\mesh,p\r,p\g,p\b
	
	Return p\mesh
	
End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function SpawnPlayer(id,spawnId)
	
	p.player = Object.player(GetPlayer(id))
	
	For s.spawn = Each spawn
		If s\spawnId = spawnId Then Exit
	Next
	
	p\life = 100
	
	p\nextX = s\x
	p\nextY = s\y
	p\nextZ = s\z
	p\nextYaw = s\yaw
	
	p\previousX = p\nextX
	p\previousY = p\nextY
	p\previousZ = p\nextZ
	p\previousYaw = p\nextYaw
	
	PositionEntity p\mesh,p\nextX,p\nextY,p\nextZ
	RotateEntity p\mesh,0,p\nextYaw,0
	ResetEntity p\mesh
	
	p\currentY = p\nextY
	
	p\previousTime = MilliSecs()
	p\nextTime = MilliSecs()+1
	
End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function RandomSpawn(id)
	
	p.player = Object.player(GetPlayer(id))
	
	; if we are server, spawn player at random location
	If localMode = 2
		randSpawn = Rand(spawns)
		SpawnPlayer(p\id,randSpawn)
		Net_SendMessage(9,randSpawn,p\id)
		Net_SendMessage(9,randSpawn,p\id,p\id)
	Else ; else default spawn = first spawn created
		SpawnPlayer(p\id,1)
	EndIf
	
End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function CreateSpawn(x#,y#,z#,yaw#)
	
	spawns = spawns + 1
	
	s.spawn = New spawn
	s\spawnId = spawns
	s\x = x
	s\y = y
	s\z = z
	s\yaw = yaw
	
End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function GetPlayer(id)
	
	For p.player = Each player
		If p\id = id
			Return Handle(p)					
		EndIf
	Next
	
End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function DrawPlayersNames()
	
	For p.player = Each player
		
		Color 255,255,255
		CameraProject(camera,EntityX(p\mesh),EntityY(p\mesh),EntityZ(p\mesh)) 			
		If p\id &lt;&gt; localID Then Text ProjectedX(),ProjectedY()-60,p\name,1,1
		
		Color 255,(255./100.)*p\life,(255./100.)*p\life
		Text ProjectedX(),ProjectedY()-40,p\life,1,1
		
	Next
	
End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function CreateBullet(id)
	
	p.player = Object.player(GetPlayer(id))
	
	b.bullet = New bullet
	
	b\id = p\id
	
	b\mesh = CreateSphere(2)
	ScaleEntity b\mesh,0.2,0.2,0.2
	EntityColor b\mesh,255,0,0
	
	PositionEntity b\mesh,EntityX(p\mesh),EntityY(p\mesh),EntityZ(p\mesh)
	RotateEntity b\mesh,0,EntityYaw(p\mesh),0
	
	EntityType b\mesh,3
	EntityRadius b\mesh,0.2
	
	b\time = MilliSecs()
	
End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function UpdateBullets()
	
	For b.bullet = Each bullet
		
		MoveEntity b\mesh,0,0,1
		
		If CountCollisions(b\mesh)
			
			If localMode = 2 ; only the server compute bullets collision with player
				If GetEntityType(CollisionEntity(b\mesh,1)) = 2 ; a player is hit
					
					touchedPlayer.player = Object.player(EntityName(CollisionEntity(b\mesh,1)))
					touchedPlayer\life = touchedPlayer\life - 10
					
					If touchedPlayer\life &gt; 0 ; touched
						Net_SendMessage(5,touchedPlayer\life,touchedPlayer\id)
						Net_SendMessage(5,touchedPlayer\life,touchedPlayer\id,touchedPlayer\id)
					Else ; killed
						killerPlayer.player = Object.player(GetPlayer(b\id))
						
						killerPlayer\kills = killerPlayer\kills + 1
						touchedPlayer\deaths = touchedPlayer\deaths + 1						
						
						Net_SendMessage(6,touchedPlayer\id,killerPlayer\id)
						Net_SendMessage(6,touchedPlayer\id,killerPlayer\id,killerPlayer\id)
						
						Net_SendMessage(7,killerPlayer\kills+"/"+killerPlayer\deaths,killerPlayer\id)
						Net_SendMessage(7,killerPlayer\kills+"/"+killerPlayer\deaths,killerPlayer\id,killerPlayer\id)
						
						Net_SendMessage(7,touchedPlayer\kills+"/"+touchedPlayer\deaths,touchedPlayer\id)
						Net_SendMessage(7,touchedPlayer\kills+"/"+touchedPlayer\deaths,touchedPlayer\id,touchedPlayer\id)
						
						NewMessage(killerPlayer\name + " killed " + touchedPlayer\name)
						
						RandomSpawn(touchedPlayer\id)
						
					EndIf
					
				EndIf
			EndIf
			
			FreeEntity b\mesh
			Delete b
			
		ElseIf MilliSecs()-b\time &gt; 2000
			
			FreeEntity b\mesh
			Delete b
			
		EndIf
		
	Next
	
End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function CreateHealthItem(x#,y#,z#)
	
	h.health = New health
	
	h\mesh = CreateMesh()
	
	h\respawnDelay = 10000
	
	mesh1 = CreateCube()
	mesh2 = CreateCube()
	
	ScaleMesh mesh1,.20,.5,.20
	ScaleMesh mesh2,.20,.5,.20:RotateMesh mesh2,90,0,0
	
	AddMesh(mesh1,h\mesh)
	AddMesh(mesh2,h\mesh)
	
	EntityColor h\mesh,255,0,0
	
	If localMode = 2 Then EntityType h\mesh,4
	EntityRadius h\mesh,0.5
	
	PositionEntity h\mesh,x,y,z
	
	NameEntity h\mesh,Handle(h)
	
End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function UpdateHealthItems()
	
	For h.health = Each health
		
		TurnEntity h\mesh,0,-2,0
		
		If CountCollisions(h\mesh)
			
			If localMode = 2 ; only the server computes collision with player
				If GetEntityType(CollisionEntity(h\mesh,1)) = 2 ; a player collided
					
					touchedPlayer.player = Object.player(EntityName(CollisionEntity(h\mesh,1)))
					
					h\pickupTime = MilliSecs()
					HideEntity h\mesh
					ResetEntity h\mesh
					
					Net_SendMessage(8,Handle(h))
					
					If touchedPlayer\life &lt; 100 ; touched healthpowerup..
						
						touchedPlayer\life = touchedPlayer\life + 10
						
						Net_SendMessage(5,touchedPlayer\life,touchedPlayer\id)
						Net_SendMessage(5,touchedPlayer\life,touchedPlayer\id,touchedPlayer\id)
						
					EndIf
					
				EndIf
			EndIf
			
		EndIf
		
		If MilliSecs() - h\pickupTime &gt; h\respawnDelay Then ShowEntity h\mesh
		
	Next
	
End Function
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function NewMessage(msg$)
	
	messageOffset = messageOffset + 1
	
	If messageOffset &gt; messageDisplayNumber
		
		messageOffset = messageOffset - 1
		
		For i = 2 To messageDisplayNumber
			message(i-1) = message(i)		
		Next
		
		message(messageDisplayNumber) = msg
		
	Else
		
		message(messageOffset) = msg
		
	EndIf
	
End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function DrawMessages()
	
	Color 255,255,255
	
	For i = 1 To messageOffset
		
		Text 0,(i-1)*15,message(i)	
		
	Next
	
End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function UpdateChat()
	
	key = GetKey()
	
	If key
		If key = 13
			If chatMessage &lt;&gt; localName + "&gt; "
				For i = Len(localName + "&gt; ") To Len(chatMessage)
					If Mid(chatMessage,i,1) &lt;&gt; " "
						Net_SendMessage(1,chatMessage)
						NewMessage(chatMessage)
						Exit
					EndIf
				Next
			EndIf
			chatMessage = localName + "&gt; "
			chatMode = 0
		ElseIf key = 8 And Len(chatMessage) &gt; Len ( localName + "&gt; " )
			chatMessage = Left(chatMessage,Len(chatMessage)-1)
		ElseIf key &gt; 31 And key &lt; 127
			chatMessage = chatMessage + Chr(key)
		EndIf
	EndIf
	
	Color 255,255,255
	Rect 0,GraphicsHeight()-20,GraphicsWidth(),20,1
	
	Color 0,0,0
	Rect 0,GraphicsHeight()-20,GraphicsWidth(),20,0
	
	
	If MilliSecs()-chatMillisecs &gt; 500
		chatCursor = Not chatCursor
		chatMillisecs = MilliSecs()
	EndIf
	
	If chatCursor
		Text 5,GraphicsHeight()-17,chatMessage + "|"
	Else
		Text 5,GraphicsHeight()-17,chatMessage
	EndIf
	
End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function DrawScoreTable()
	
	For p.player = Each player
		count = count + 1
	Next
	
	baseX = (GraphicsWidth()-350)/2
	baseY = (GraphicsHeight()-(35+20*count))/2
	
	Color 0,0,0
	Rect baseX,baseY,350,35+20*count,1
	
	Color 255,192,0
	Rect baseX,baseY,350,35+20*count,0
	
	Text baseX+10,baseY+10,"Player          Kills     Deaths     Ping"
	Line baseX,baseY+25,baseX+349,baseY+25
	
	For p.player = Each player
		
		Color 255,255,255
		If p\id = localID Then Color 255,100,100
		
		i = i + 1
		Text baseX+10,baseY+10+20*i,p\name
		Text baseX+157,baseY+10+20*i,p\kills,1,0
		Text baseX+240,baseY+10+20*i,p\deaths,1,0
		Text baseX+322,baseY+10+20*i,p\ping,1,0
	Next
	
End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function UpdateChaseCam(camera,player) ; thanks to jfk EO-11110 on bb forums for this function !
	PositionEntity camera,EntityX(player,1),EntityY(player,1),EntityZ(player,1)
	ResetEntity camera
	x#=EntityX(player)+Sin(-EntityYaw(player)+180)*x_dis#
	y#=EntityY(player)+y_dis#
	z#=EntityZ(player)+Cos(-EntityYaw(player)+180)*z_dis#
	obstacle=LinePick(EntityX(player),EntityY(player),EntityZ(player),(x-EntityX(player)),y_dis#,(z-EntityZ(player)),0.1)
	If obstacle=0
		new_x#=x
		new_y#=y
		new_z#=z
	Else
		new_x#=PickedX()
		new_y#=PickedY()
		new_z#=PickedZ()
	EndIf
	If bounce_cam=0
		PositionEntity camera,new_x,new_y,new_z
	Else
		x=old_x+((New_x-old_x)/bounce_div#)
		y=old_y+((New_y-old_y)/bounce_div#)
		z=old_z+((New_z-old_z)/bounce_div#)
		PositionEntity camera,x,y,z
	EndIf
	PointEntity camera,player
	TurnEntity camera,-20,0,0     ; if you want the player mesh more on the bottom of the screen
	old_x#=EntityX(camera)
	old_y#=EntityY(camera)
	old_z#=EntityZ(camera)
End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function CreateScene()
	
	texture = TextureCreate(128)
	
	ground = CreatePlane()
	EntityColor ground,150,150,150
	EntityTexture ground,texture
	
	cube = CreateCube():EntityColor cube,150,200,150
	ScaleEntity cube,5,5,5:PositionEntity cube,0,5,0
	EntityTexture cube,texture
	
	sphere = CreateSphere(16):EntityColor sphere,200,150,150
	ScaleEntity sphere,3,1,3:PositionEntity sphere,0,9.7,0
	
	platform = CreateCube():EntityColor platform,150,150,200
	ScaleEntity platform,3,1,10:PositionEntity platform,0,4.13,-13.15
	TurnEntity platform,-30,0,0
	EntityTexture platform,texture
	
	FreeTexture texture
	
	EntityType ground,1:EntityPickMode ground,2
	EntityType cube,1:EntityPickMode cube,2
	EntityType sphere,1:EntityPickMode sphere,2
	EntityType platform,1:EntityPickMode platform,2
	
	light = CreateLight()
	TurnEntity light,30,70,0
	
	
	CreateHealthItem(0,12,0)
	CreateHealthItem(0,1,-10)
	CreateHealthItem(0,3,-20)
	
	;; COLLISIONS
	Collisions 2,1,2,3 ; player to scene
	Collisions 2,2,1,3 ; player to player
	
	Collisions 3,1,2,1 ; bullet to scene
	Collisions 3,2,1,1 ; bullet to player
	
	Collisions 2,4,1,2 ; player to health
	
End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function TextureCreate(size)
	texture = CreateTexture(size,size,9)
	SetBuffer TextureBuffer(texture)
	Color 255,255,255
	Rect 0,0,size,size,1
	Color 0,0,0
	Rect 0,0,size,size,0
	Line 0,0,size,size
	Line 0,size,size,0
	SetBuffer BackBuffer()
	Return texture
End Function
</textarea><br><br>&gt; Any idea what we are doing wrong here? &lt; <br><br></td></tr></table><br>
<a name="1294178"></a>

<a name="1294179"></a>

<a name="1294180"></a>

<a name="1294188"></a>

<a name="1294204"></a>

<a name="1294216"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >RemiD</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#182">[#182]</a></td></tr></table></td></tr><tr ><td class="posttext"> I have not followed the discussion in its entirety, but i see that you are talking about updateworld(), so maybe your positionning problem is because resetentity() does not seem reliable to desactivate an ellipsoid collider. See : <a href="http://www.blitzbasic.com/Community/posts.php?topic=98459" target="_blank">http://www.blitzbasic.com/Community/posts.php?topic=98459</a><br><br>The solution is to destroy the ellipsoid collider, then reposition, then recreate the ellipsoid collider, then you can turn move your entity again...<br><br>(i don't have time now, but i have several ideas to improve the Blitz3d collisions system, for example add the possibility to activate or desactivate an ellipsoid collider before turning moving an entity so that it is considered or not considered for the calculations of collisions...) <br><br></td></tr></table><br>
<a name="1294184"></a>

<a name="1294187"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rick Nasher</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#183">[#183]</a></td></tr></table></td></tr><tr ><td class="posttext"> Thanks for the info RemiD. That's really odd(and interesting) to hear, will study this more closely. But I don't know this is the issue here, because it worked ok before the latest modifications.<br><br>BTW if you're interested in trying the Multiplayer Host switching(Peer2Peer) code then you can download the lib from the worklog link <a href="/logs/userlog.php?user=15074&amp;log=1916" target="_blank">here</a>. <br><br></td></tr></table><br>
<a name="1294192"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Guy Fawkes</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#184">[#184]</a></td></tr></table></td></tr><tr ><td class="posttext"> @Rick Nasher, @Flanker | I am in the chat! :) <br><br>~GF <br><br></td></tr></table><br>
<a name="1294220"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >RemiD</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#185">[#185]</a></td></tr></table></td></tr><tr ><td class="posttext"> Well, apparently hideentity() showentity() can be used to desactivate or activate collisions for an ellipsoid collider during one or several frame(s) see : <a href="http://www.blitzbasic.com/Community/posts.php?topic=98459" target="_blank">http://www.blitzbasic.com/Community/posts.php?topic=98459</a> #6<br><br>Apparently my old code example has an error somewhere... So don't consider it... <br><br></td></tr></table><br>
<a name="1294253"></a>

<a name="1294254"></a>

<a name="1294258"></a>

<a name="1294259"></a>

<a name="1294260"></a>

<a name="1294261"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rick Nasher</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#186">[#186]</a></td></tr></table></td></tr><tr ><td class="posttext"> @RemiD:<br>I tried this earlier as stayne pointed it out to me in post #141 when we were trying to solve the re-spawning bug(non local player sometimes showed up at incorrect locations), but it didn't have the desired effect. <br><br>This bug got fixed by Flanker, however it didn't take his earlier health upgrade routine into account and when I tried to add it back in, it resulted in a the new bug; not being able to collide with health items so not upgrading the health, especially when not being the host or original host.<br><br>I guess as Flanker said: "ResetEntity to avoid collision when reseting", or as said on the blitz site:<div class="quote"> <br>Zethrax (Posted 1+ years ago) <br> <br>'ResetEntity' is the command to use when you want to reposition a collision enabled entity without it being stopped by the first object it encounters that it is enabled to collide with.<br><br>Just use 'ResetEntity' immediately after the positioning command (it can actually be used anywhere between the positioning command and the 'UpdateWorld' command) and the collision data for the entity will be reset, fooling the collision system into thinking that the entity was already at the new position, and had not been moved.<br><br>Very useful when you want to teleport game characters and items, for example. <br> <br></div> <br><br></td></tr></table><br>
<a name="1294294"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rick Nasher</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#187">[#187]</a></td></tr></table></td></tr><tr ><td class="posttext"> Surely hope this health upgrade issue is fixable, for then we have a solid working Multi Player framework example and can extend from there. <br><br></td></tr></table><br>
<a name="1294297"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >RemiD</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#188">[#188]</a></td></tr></table></td></tr><tr ><td class="posttext"> @Rick&gt;&gt;ResetEntity() is not reliable, test it you will see.<br>To reposition an ellipsoid or a pivot parent of a hull (made of several ellipsoids) you want to use either hideentity, then reposition, then showentity or delete all ellipsoids, then reposition, then recreate all ellipsoids. <br><br></td></tr></table><br>
<a name="1294298"></a>

<a name="1294299"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rick Nasher</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#189">[#189]</a></td></tr></table></td></tr><tr ><td class="posttext"> Uhuh, but at the moment I don't think it's even registering a collision to a health upgrade item when the user isn't the host, while before the alternations, it did work very well, so I'm pretty sure it's a logic issue(somewhere).<br><br>To summarize: <br>before the spawn update code we had a glitch where sometimes the non-local player would show up on different location, like it collided with something(scenery), so that indeed would indicate what you describe.<br>After the spawn fix, which didn't hold the health update code, I brought it back in, but it didn't register collisions anymore to the healtupgrade items when not being the host. <br>So yes, I do believe it may have something to do with what you describe, but I'm not quite sure how to fix without killing the spawn glitch fix.. <br><br></td></tr></table><br>
<a name="1294309"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Flanker</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#190">[#190]</a></td></tr></table></td></tr><tr ><td class="posttext"> Ok I'll look at it. In fact I guess the health code I posted didn't handle host change because collision with health are enabled only for the server, but I forgot to enable them for the new host if it changes. <br><br></td></tr></table><br>
<a name="1294313"></a>

<a name="1294315"></a>

<a name="1294317"></a>

<a name="1294320"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >RemiD</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#191">[#191]</a></td></tr></table></td></tr><tr ><td class="posttext"> I have updated the code examples, see for yourself what works (hide ellipsoids, then reposition root, then show ellipsoids, or delete ellipsoids, then reposition root, then recreate ellipsoids) and what does not work (reset ellipsoids, then reposition root)<br><a href="http://www.blitzbasic.com/Community/posts.php?topic=98459" target="_blank">http://www.blitzbasic.com/Community/posts.php?topic=98459</a> #6<br><br>(Note that you can use only one ellipsoid same as the root and turn move the ellipsoid to be able detect collisions and to benefit from the automatic response of Blitz3d (repositioning...), but if you want to use several ellipsoids childs of a root (to create a hull) and turn move the root to be able to detect collisions, you have to manage the response yourself (for example by repositioning the root and then the ellipsoids using tformpoint)) <br><br></td></tr></table><br>
<a name="1294321"></a>

<a name="1294323"></a>

<a name="1294324"></a>

<a name="1294325"></a>

<a name="1294326"></a>

<a name="1294327"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Flanker</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#192">[#192]</a></td></tr></table></td></tr><tr ><td class="posttext"> Ok for the health, just remove that  in the UpdatePlayers() function :<br><pre class=code>ResetEntity p\mesh ; reset entity is useful here because of collisions</pre>It's funny because when I added it there, I stated that it was useful for collisions :D But if you look back at the health example I already commented this line. I added it at the time of extrapolation but it's useless now as extrapolation is deactivated.<br><br>And here is the new UpdateHealthItems() function to handle server change :<br><textarea class=codebox name="code" wrap=OFF readonly="true" rows="15" cols="80">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function UpdateHealthItems()

	For h.health = Each health

		TurnEntity h\mesh,0,-2,0
		
		If localMode = 2 And GetEntityType(h\mesh) &lt;&gt; 4
			EntityType h\mesh,4
			EntityRadius h\mesh,0.5
		EndIf
		
		If CountCollisions(h\mesh)
			
			If localMode = 2 ; only the server computes collision with player
				If GetEntityType(CollisionEntity(h\mesh,1)) = 2 ; a player collided
					
					touchedPlayer.player = Object.player(EntityName(CollisionEntity(h\mesh,1)))
					
					h\pickupTime = MilliSecs()
					HideEntity h\mesh
					ResetEntity h\mesh
					
					Net_SendMessage(8,Handle(h))
					
					If touchedPlayer\life &lt; 100 ; touched healthpowerup..
										
						touchedPlayer\life = touchedPlayer\life + 10
					
						Net_SendMessage(5,touchedPlayer\life,touchedPlayer\id)
						Net_SendMessage(5,touchedPlayer\life,touchedPlayer\id,touchedPlayer\id)
						
					EndIf
										
				EndIf
			EndIf
			
		EndIf
	
		If MilliSecs() - h\pickupTime &gt; h\respawnDelay Then ShowEntity h\mesh
	
	Next

End Function</textarea><br><br>@RemiD HideEntity seems to work fine in the network example to deactivate a collider when it's been picked. <br><br></td></tr></table><br>
<a name="1294333"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >RemiD</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#193">[#193]</a></td></tr></table></td></tr><tr ><td class="posttext"> @Flanker&gt;&gt;if you use hideentity (before updateworld), then reposition (before updateworld), then showentity (after updateworld), it works well, you don't need to use resetentity... <br><br></td></tr></table><br>
<a name="1294338"></a>

<a name="1294345"></a>

<a name="1294347"></a>

<a name="1294348"></a>

<a name="1294349"></a>

<a name="1294350"></a>

<a name="1294351"></a>

<a name="1294352"></a>

<a name="1294353"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rick Nasher</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#194">[#194]</a></td></tr></table></td></tr><tr ><td class="posttext"> @Flanker: <br>Thanks for the update. Testing..<br><br>Update:<br>Appears to work marvelously, already put it into our full whistles and bells version. Well.. not the full whistles &amp; bells, but we've added:<br>- can't see players name/strength through walls(so can play hide&amp;seek).<br>- different health item strengths, which are also displayed above the item and take time to become available again depending on strenght.<br>- chattext colors matched to playercolors.<br>- fixes to keybd input and window focus.<br>- shooting sounds.<br><br>Your health item fix should also be adaptable into weapon or other items systems, which is next on my list(I will see what I can come up with lol), along with adding some stuff from the Code Archives e.g. the <a href="/codearcs.php?code=470" target="_blank">Moving Platforms Demo</a>, the <a href="/codearcs.php?code=2724" target="_blank">Chasecam with Flashlight</a>, a day and night cycle, fixes to the  chat system for; input, cheat, kick(when being a server) etc.. blitz terrain, AI enemies, a nice portal for storable settings such as resolution, sound and network prefs. <br><br>Then put this All-In-One Multiplayer example with all in-game procedural gfx into Code Archives so anybody can use it even without media and then move all over to stayne's level, add character animations and all else that may come to mind that requires media.<br><br>Again: many, many thanks Flanker. <br><br></td></tr></table><br>
<a name="1296601"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Guy Fawkes</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#195">[#195]</a></td></tr></table></td></tr><tr ><td class="posttext"> Flanker, where are you man? The project needs you! :/<br><br>~GF <br><br></td></tr></table><br>
<a name="1304651"></a>

<a name="1304652"></a>

<a name="1304653"></a>

<a name="1304654"></a>

<a name="1304655"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rick Nasher</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#196">[#196]</a></td></tr></table></td></tr><tr ><td class="posttext"> Little updates. Had bit of time to spare.. :-)<br><textarea class=codebox name="code" wrap=OFF readonly="true" rows="15" cols="80">
; *** ROADMAP/HISTORY ***
;
; ADDED SO FAR: 
; -chattext colors matched to playercolors.
; -different health strengths and spawn times.
; -hide entities names when one player cannot see each other(so can play hide&amp;seek)..
; -different health item strengths, which are also displayed above the 
;  item and take time to become available again depending on strenght.
; -fixes to keybd input and window focus.
; -sound fx(quicky, needs work).
;
; UPDATE 27-04-2016:
; -some sound fx fixes.
; -lock/unlock mse + hud.focus to window switch 'f'.
; -F1=help.
; -F2=change player color on the fly.
; -rapidfire toggle command.
; -Attempted fix for friendly fire hits.&lt;nogo yet, for this also disables server to kill others.. ;-( need to rethink this.
;
;
; TODO UPTO VERSION 2.0 (not nesacerrily in this order, all using procedural gfx, without ext libs/media, except sound):
; -test w gf, flanker or others. ;-) 
; -reduce life when fells off too high cliff(using if linepick&lt;&gt; and entity distance&lt;&gt;ground.
; -scorch marks on hit objects.
; -fps /tps switch.
; -weapon upgrades.
; -'/' cheatmodes and additional commands.
; -flashlight  + day nightcycle.
; -add moving platforms demo code.
; -game music. playing more exited when near an enemy.
; -robo players with simple ai.
; -gui with saveable prefs.
; -simple animated chars.
; -ladder climbing/crouching.
; -walking, running and sounds to match.
; -superjump powerup.
; -schields.
; -teleportation.
; -weather conditions. 
;
; TODO FOR VERSION 3.0 (more advanced, incorporating media and ext libs):
; -move to stayne's level.
; -3d animated chars.
; -AlienBreed 3d characters?
; -Special effects, doors, etc.
; -Vehicals/terrian.
; -PhysX.
; -Shadows.

; Bugs:
; - audio only on local player. fixed for jump sound. others? (need to check).
; - getting hit by friendly fire when jumping with rapid fire enabled.
;
SeedRnd MilliSecs()

Const gameLogicFPS = 60

Global enableFocus=True  ; lock mouse to screen and hide pointer 'f' key toggles locked/unlocked mode.
Global enableRapidFire=False  ; 'r' key toggles normal/rapidfire mode.

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
; first we include the KeyFix library
Include "KeyFix_Constants.bb"

; we now include the network library
Include "UDPNetwork_lib.bb"
; for converting RGB values to "Tri-Hex" stringc inlude hex8.
Include "Hex8.bb" ;&lt;&lt;&lt; Colored txt mod by Raster Ron 

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Global localID
;Global localName$ = Input("Enter your name : ")
;If localName = "" Then localName = "player" + Rand(100,999)

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;&lt;&lt; Enter through mod..
Global localName$ = "", defaultName$ = "RCX" ; My own pre-defined username, so just need to press enter to save typing ;-) 
;change above username to your own liking.

Print "Change default name: '"+ defaultName$ +"' ?"
Choic$ = Input$("[Press [Y]es or [ENTER] for No: ")
If Choic$="y" Then ; so want to change..
	Cls:Locate 0,0
	Print "Type name &amp; press [ENTER] or"
	ChangeName$=Input$("just [ENTER] to autogenerate: ")
	If ChangeName$="" ; so pressed enter to autogen..
		localName = "player" + Rand(100,999)
	Else ; so entered a new name..
		localName$=ChangeName$
	EndIf
Else ; so entered without input.
	localName$ = defaultName$
EndIf

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Global localPlayerMesh

Type player
	Field id
	Field name$
	Field ping
	Field ip
	
	Field life
	Field kills
	Field deaths
	
	Field mesh
	Field r,g,b
	
	Field nextX#,nextY#,nextZ#
	Field previousX#,previousY#,previousZ#
	Field nextYaw#
	Field previousYaw#
	Field nextTime
	Field previousTime
	
	Field lastPacket
	
	Field currentY#
	Field velocityY#
	
	Field jumped
	
End Type

Type bullet
	Field mesh
	Field angle#
	Field time
	Field id ; id of player who fired
End Type

Type health
	Field mesh
	Field pickupTime ; to store when was pickedup and can hide for a certain time set in 
	Field respawnDelay ; &lt; see above
	Field visible
	Field power ; to hold strength of upgrade
End Type

Type spawn
	Field spawnId
	Field x#,y#,z#
	Field yaw#
End Type

Global spawns ; number of spawn points
Global firsttimehealth=True

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
; Camera code from jfk EO-11110, thanks
Global bounce_cam=1 ;  smooth camera motion? (0/1)
Global bounce_div#=10.0 ; the higher, the more sluggish the camera will follow. Recc: 3.0 to 20.0
; some globals used by ChaseCam
Global old_x#,old_y#,old_z#
; desired distance between camera and player mesh
Global x_dis#=7.0,y_dis#=3,z_dis#=7.0,y_dis_or#=y_dis#


;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;

; network init ----------------------------------------;
Global localMode = Net_StartInput() ; bring the library "console" to connect

If localMode = 1 Or localMode = 2 ; 1 means we are client, 2 means we are server
	
	localID = Net_CreatePlayer(localName) ; this command inits the server or local client
	
	If localID = 0 ; error
		Net_StopNetwork() ; close the network properly
		RuntimeError("Failed to create player.")
	EndIf
	
	If localMode = 1 Then AppTitle("Client : " + localName + " (port:" + net_port + "/ ID=" + localID +" / IP= "+ net_ip+ ")                   [F1] = Help!")
	If localMode = 2 Then AppTitle("Server : " + localName + " (port:" + net_port + "/ ID=" + localID +" / IP= "+ net_ip+ ")                   [F1] = Help!")
	 
Else ; error
	Net_StopNetwork()
	RuntimeError("Failed to start game.")
EndIf
;------------------------------------------------------;
grphicsWidth = 640
grphicsHeight= 480
Graphics3D grphicsWidth ,grphicsHeight,32,2
SetBuffer BackBuffer()

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
; audio
Global musicOn=False, musiclevel#=.5, danger=False												 ;music 
Global bgmusic_vol#=.5, bgmusicChannel, bgmusic 
Global dangermusic_vol#=0, dangermusicChannel, dangermusic     		     			             ;music

Global wade_vol#, run_vol#, wadechannel, runchannel , shootchannel, boomchannel, pwrchannel	     ;player sfx
Global shoot, boom, uh, pwr, pwrappear, pickup , pickupchannel ,jumpchannel, jumpsound , hitsnd, hitchannel   
Global deathsnd, appearsnd

;Game music
;If gamelevel=1 Then LoadMusic("spacepanic.mp3") ; load gamemusic
;If gamelevel=2 Then LoadMusic("Shadow Of The Beast - To The Castle.mp3") 
;(If entitydistance &lt; theshold then play "battle music").
;If musicOn=False     ; if music is off then turn off volume
;	musiclevel#=0
;EndIf

LoadSFX()


;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
CreateScene()

;create spawn locations to randomly pick from, currently 3.
CreateSpawn(0,12,0,0)
CreateSpawn( 20,10, 20, 45)
CreateSpawn(-20,10,-20,-45)


Global camera = CreateCamera()
CameraRange camera,0.1,1000

; create our own local player
localPlayerMesh = CreatePlayer(localID,localName)
old_x = EntityX(localPlayerMesh):old_y = EntityY(localPlayerMesh):old_z = EntityZ(localPlayerMesh) ; update camera position

; we send our color to the server
p.player = Object.player(GetPlayer(localID))
Net_SendMessage(3,p\r + "/" + p\g + "/" + p\b)

; &lt;&lt;&lt; colored txt mod by Raster Ron..
;store colors for chattxt.
Global cR = p\r 
Global cG = p\g 
Global cB = p\b 
; &lt;&lt;&lt; end colored txt mod by Raster Ron..


; variables used to send our positions at a constant delay (saves bandwidth but makes a constant ping)
Global updatePosition = MilliSecs()
Global updateTick = 50

; chat
Global maxlinelength% = 79
Global messageDisplayNumber = 10
Global messageOffset
Dim message$(messageDisplayNumber)

Global chatMode
Global chatMessage$ = localName + "&gt; "
Global chatMillisecs = MilliSecs()
Global chatCursor

.mainLoop
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
tweeningPeriod = 1000 / gameLogicFPS
tweeningTime = MilliSecs() - tweeningPeriod
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
While Not KeyHit(1)
	
	;; I use tweening from castle demo here :
	;;
	;; 		- this allows to have very fast execution outside the tweening loop,
	;; 		  so the network is updated as fast as possible (needs Flip False)
	;;
	;; 		- this makes the game logic updated at a constant rate (Const FPS=)
	;;		  so no need to set deltatime (and it saves CPU time for other things)
	
	
	;; -------------------------------------------------------------------------------------------------; FAST EXECUTION (outside of tweening)
	;; -------------------------------------------------------------------------------------------------;
	
	; see the function, the interpolation variables are set properly here
	UpdateNetwork()
	
	;; -------------------------------------------------------------------------------------------------;
	
	Repeat
		tweeningElapsed = MilliSecs() - tweeningTime
	Until tweeningElapsed
	tweeningTicks = tweeningElapsed / tweeningPeriod
	tweeningRate# = Float(tweeningElapsed Mod tweeningPeriod)/Float(tweeningPeriod)
	For k = 1 To tweeningTicks
		tweeningTime = tweeningTime + tweeningPeriod
		If k = tweeningTicks Then CaptureWorld
		
		;; ---------------------------------------------------------------------------------------------; MAIN UPDATE
		;; ---------------------------------------------------------------------------------------------;
		;sound
		;ChannelVolume wadechannel, wade_vol# ; adjust wadesound volume 0-1
		;ChannelVolume runchannel , run_vol#  ; adjust runsound volume 0-1
		;ChannelVolume bgmusicChannel    , bgmusic_vol# ;
		;ChannelVolume dangermusicChannel, dangermusic_vol# ;
		
		
		; update our player
		UpdateLocalPlayer() 
		
		; the interpolation is made in this function
		UpdatePlayers() ;network players and gravity
		
		UpdateWorld()
		
		; update the bullets... only the server checks for player kills
		UpdateBullets()
		UpdateHealthItems()
		UpdateChaseCam(camera,localPlayerMesh)
		;; ---------------------------------------------------------------------------------------------;
	Next
	
	RenderWorld tweeningRate
	
	;; -------------------------------------------------------------------------------------------------; 2D UPDATE
	
	DrawPlayersNames()
	DrawHealthItemStrengths()
	
	;; -------------------------------------------------------------------------------------------------;
	; Gereral input checks..
	If ( KeyHit ( 28 ) ) And chatMode = 0 Then chatMode = 1 : FlushKeys() ; Enter key for chat on/off
	If ( KeyHit ( 53 ) ) And chatMode = 0 Then chatMode = 1 ; / comnands &lt;&lt; will result in remembering prev input so not very good!
	If chatMode Then UpdateChat() 
	DrawMessages()
	
	If KeyDown(15) Then DrawScoreTable() ; Tab for scores
	
	If KeyDown(33) Then enableFocus=1-enableFocus : Delay 300 ; F key toggle focus locally.
	If enableFocus=False Then 
		ShowPointer 
	Else
		HidePointer
		MoveMouse(grphicsWidth/2, grphicsHeight/2)
	EndIf
	
	If KeyDown (59) Then ; F1 key for help locally .
		DisplayKeyHelpTxt()
	EndIf
	
	If KeyHit (60)  Then ; F2 change color of local player.
		;Give a random color to our player.
		p\r = Rand(255)
		p\g = Rand(255)
		p\b = Rand(255)
		EntityColor p\mesh,p\r,p\g,p\b
		;p.player = Object.player(GetPlayer(localID))
		Net_SendMessage(3,p\r + "/" + p\g + "/" + p\b) ; send new color to all players..
	EndIf
	;; -------------------------------------------------------------------------------------------------;
	
	Flip
	
Wend
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;

Net_StopNetwork()
End

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function UpdateNetwork()
	
	; update incoming packets (better check ALL incoming messages so use While Wend)
	While Net_CheckMessage() ; will check for a new message and fill Net_MsgType, Net_MsgString$, Net_MsgFrom and Net_MsgTo variables so we can read it
		
		p.player = Object.player(GetPlayer(Net_MsgFrom)) ; get the player handle
		
		If Handle(p) = 0 And Net_MsgType &lt; 100 ; we received an update packet from a player we don't know
			; so we ask the server who he is and return because we can't update him for now
			; the server will resend us the info in a new player "100" message
			Net_RequestPlayer(Net_MsgFrom)
			Return
		EndIf
		
		Select Net_MsgType ; check the type of message
				
			Case 1 ; chat message
				NewMessage(Net_MsgString)
				
			Case 2 ; player position and angle, example of packing data into string
				;unravel packed string data..
				offset1 = Instr(Net_MsgString,"/",1)
				offset2 = Instr(Net_MsgString,"/",offset1+1)
				offset3 = Instr(Net_MsgString,"/",offset2+1)
				offset4 = Instr(Net_MsgString,"/",offset3+1)
				offset5 = Instr(Net_MsgString,"/",offset4+1)
				
				p\previousX = p\nextX
				p\previousY = p\nextY
				p\previousZ = p\nextZ
				p\previousYaw = p\nextYaw
				
				p\nextX =  Left(Net_MsgString,offset1-1)
				p\nextY =   Mid(Net_MsgString,offset1+1,offset2-offset1-1)
				p\nextZ =   Mid(Net_MsgString,offset2+1,offset3-offset2-1)
				p\nextYaw = Mid(Net_MsgString,offset3+1,offset4-offset3-1)
				
				;p\nextYaw = Right(Net_MsgString,Len(Net_MsgString)-offset3)
 
				
				p\previousTime = p\nextTime
				p\nextTime = MilliSecs()
				

				
			Case 3 ; update player colors
				offset1 = Instr(Net_MsgString,"/",1)
				offset2 = Instr(Net_MsgString,"/",offset1+1)
				
				p\r = Left(Net_MsgString,offset1-1)
				p\g = Mid(Net_MsgString,offset1+1,offset2-offset1-1)
				p\b = Right(Net_MsgString,Len(Net_MsgString)-offset2)
				
				EntityColor p\mesh,p\r,p\g,p\b
				;add bodyparts update here..
				
			Case 4 ; a player fired
				CreateBullet(Net_MsgFrom)
				
			Case 5 ; a player lost some life
				p\life = Net_MsgString
				;hitchannel = PlaySound (hitsnd) ;currently disabled for creates unwanted hitsounds..dunno why yet, need to check..
				
			Case 6 ; a player killed another one
				k.player = Object.player(GetPlayer(Net_MsgString)) ; killed player ID in MsgData
				NewMessage(p\name + " killed " + k\name)
				boomchannel = PlaySound (boom) ;boom sound is started. 
				;ResetPlayer(k\id)
				
			Case 7 ; the server sends us score update for a player
				offset = Instr(Net_MsgString,"/",1)
				p\kills = Left(Net_MsgString,offset-1)
				p\deaths = Right(Net_MsgString,Len(Net_MsgString)-offset)
				
			Case 8 ; health pickup
				h.health = Object.health(Net_MsgString)
				HideEntity h\mesh
				h\pickupTime = MilliSecs()
				h\visible=False
				
				SoundVolume pwr, .2 
				pwrchannel = PlaySound (pwr) ; pwrup sound is started when collected.

				
				
			Case 9 ; player spawn
				SpawnPlayer(p\id,Net_MsgString)	
				;rather play reborn sound here?
				
				
			Case 10 ;so jump msg has been sent to notify other players so they too can play sound.
				SoundVolume jympsound, .2 ; lower volume as is further away(usually).
				jumpchannel= PlaySound (jumpsound) 	
				
					
				
			Case 11 ;
				
					
				
			;Net managing stuff here..	
			Case 100 ; new player connected, OR the server tells us who is already connected so we can create players when joining the game..
				If localMode = 2 ; if = server..
					For p.player = Each player ;
						Net_SendMessage(2,p\nextX + "/" + p\nextY + "/" + p\nextZ + "/" + p\nextYaw,p\id,Net_MsgFrom)
						Net_SendMessage(3,p\r + "/" + p\g + "/" + p\b,p\id,Net_MsgFrom)
						
						Net_SendMessage(5,p\life,p\id,Net_MsgFrom)
						Net_SendMessage(7,p\kills+"/"+p\deaths,p\id,Net_MsgFrom)
					Next
				EndIf
				
				NewMessage(Net_MsgString + " connected")
				CreatePlayer(Net_MsgFrom,Net_MsgString)
				
			Case 101 ; a player has quit..
				For p.player = Each player
					If Net_MsgFrom = p\id
						NewMessage(p\name + " disconnected")
						FreeEntity p\mesh
						Delete p
					EndIf
				Next
				
			Case 102 ; host has changed..
				For p.player = Each player
					If Net_MsgFrom = p\id
						If p\id = localID
							AppTitle("Server : " + localName + " (port:" + net_port + ")")
							NewMessage("You are the new host")
							localMode = 2
						Else
							NewMessage(p\name + " is the new host")
						EndIf					
					EndIf
				Next
				
			Case 103 ; ping update..
				For p.player = Each player
					If Net_MsgFrom = p\id
						p\ping = Net_MsgString
					EndIf
				Next
				
		End Select
		
	Wend
	
End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function UpdateLocalPlayer()  
		
		
	; UPDATE LOCAL PLAYER..
	p.player = Object.player(GetPlayer(localID)) ; get our local player id..
	
	; check inputs.. 	(note: needs to be replaced by circular algorithm..)
	
	If Not chatMode
		; movements
		If WK_DOWN ( ) Or UP_KDOWN    ( ) Then MoveEntity p\mesh,0,0,0.3  ; up
		If SK_DOWN ( ) Or DOWN_KDOWN    ( ) Then MoveEntity p\mesh,0,0,-0.3 ; down
		If AK_DOWN ( ) Or LEFT_KDOWN  ( ) Then TurnEntity p\mesh,0,3,0    ; left
		If DK_DOWN ( ) Or RIGHT_KDOWN ( ) Then TurnEntity p\mesh,0,-3,0   ; right
	
		; jump
		If  ( KeyHit ( 57 ) ) Or ( MouseHit ( 2 ) )  ; right mse or Spacebar
			; check if player is on the ground
			LinePick(EntityX(p\mesh),EntityY(p\mesh),EntityZ(p\mesh),0,-1.2,0)
			If PickedEntity() ;so if picked an entiry underneath so on some sort of ground/object..
				p\velocityY = 0.5 ; set "inverse" of gravity velocity, so can jump.
				
				; play jump sound locally..
				SoundVolume jympsound, .5
				jumpchannel= PlaySound (jumpsound) ;jump sound is started, but only for local player. (sound volume should be set here to medium)
				Net_SendMessage(10,"") ; notify other players a jump has taken place
			EndIf	
		EndIf
		
		; fire
		;If LM_DOWN ( )  ; left mouse down
		If enableRapidFire=True ; use keydown for keyscan..
			If ( KeyDown( 157 ) ) Or ( KeyDown( 29 ) )  Or ( MouseDown ( 1 ) ); left mouse down
				Net_SendMessage(4,"") ; notify other players a shot has been fired.
				CreateBullet(localID)
			EndIf
		Else ; use keyhit for keyscan..
			If ( KeyHit( 157 ) ) Or ( KeyHit( 29 ) )  Or ( MouseHit ( 1 ) ) ; left mouse hit
				Net_SendMessage(4,"") ; notify other players a shot has been fired.
				CreateBullet(localID)
			EndIf
		EndIf
		
		;If KeyDown(19) Then enableRapidFire=1-enableRapidFire: Delay 300 ; R key, disabled and moved to chat commands.
		
	EndIf
	

	; we create a message Type "2" For player position..
	If MilliSecs()-updatePosition &gt; updateTick ; 
		; sent the position and jumpstatus over the network so other players can adjust/act accordingly..
		; pack a msg string containing x,y,z,jump data..
		Net_SendMessage(2,EntityX(p\mesh) + "/" + EntityY(p\mesh) + "/" + EntityZ(p\mesh) + "/" + EntityYaw(p\mesh)+ "/" ) 
		updatePosition = MilliSecs()
	EndIf	
		

	
End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function UpdatePlayers()


		
	For p.player = Each player ; check all players..
	
		If p\id &lt;&gt; localID ; ; UPDATE NON LOCAL PLAYERS..
			;; LINEAR INTERPOLATION ;;;;;;;;;;
			If p\nextTime &lt;&gt; p\previousTime ; if both packets arrived at the same time, we can't interpolate
				curTime# = Float(MilliSecs()-p\nextTime) / Float(p\nextTime-p\previousTime) ; curTime will be ideally 0.0-1.0, if it's &gt; 1.0 then it performs extrapolation
				If curTime &gt; 1 Then curTime = 1 ; extrapolation gives anoying jittering effects
				; special fix for yaw as EntityYaw returns a value beetween +180 ans -180, the interpolation can go backward
				If p\previousYaw &lt; 0 Then p\previousYaw = p\previousYaw + 360
				If p\nextYaw &lt; 0 Then p\nextYaw = p\nextYaw + 360
				If Abs(p\nextYaw-p\previousYaw) &gt; 180
					If p\nextYaw &gt; p\previousYaw
						p\previousYaw = p\previousYaw + 360
					Else
						p\previousYaw = p\previousYaw - 360
					EndIf
				EndIf
				PositionEntity p\mesh,p\previousX+(p\nextX-p\previousX)*curTime,p\previousY+(p\nextY-p\previousY)*curTime,p\previousZ+(p\nextZ-p\previousZ)*curTime
				RotateEntity p\mesh,0,p\previousYaw+(p\nextYaw-p\previousYaw)*curTime,0
			Else
				PositionEntity p\mesh,p\nextX,p\nextY,p\nextZ
				RotateEntity p\mesh,0,p\nextYaw,0
			EndIf
			;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
			
		Else ; So if p\id = localID  thus update (local) player stuff. 
			 ; (Can't be combined with other local player stuff
			 ; for will somehow make jumping bit more laggy??)
			
			
			; basically below just computes gravity for local player. Actual positions will be updated across other player next loop. 
            ;[if done outside this loop(so at update local player) then jumping is more jurkey??]
			
			p\velocityY = p\velocityY - 0.03 ; increase fake gravity by substracting every time when passing by in this loop.
			Falling=True
			If EntityY(p\mesh) - p\currentY &gt;= 0 ; if player is not falling we limit the gravity
			If p\velocityY &lt; -0.03 Then p\velocityY = -0.03
				Falling=False
			EndIf
			p\currentY = EntityY(p\mesh)
			TranslateEntity p\mesh,0,p\velocityY,0
			
			
			; local sounds..
			;If p\jumped = True
			;	jumpchannel= PlaySound (jumpsound) ;jump sound is started, but only for local player 
			;	p\jumped = False ; and turn off again once done.
			;EndIf
			
			
		EndIf
	Next
	
End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function CreatePlayer(id,name$)
	
	For p.player = Each player
		If p\id = id Then Return ; player already connected
	Next
	
	p.player = New player
	p\id = id
	p\name = name
	
	
	;build player entity
	p\mesh = CreateSphere()
	
	NameEntity p\mesh,Handle(p)
	
	nose = CreateSphere(8,p\mesh):EntityColor nose,255,0,0
	PositionEntity nose,0,0,1
	ScaleEntity nose,0.3,0.3,0.3
	
	eyeLeft = CreateSphere(8,p\mesh):EntityColor eyeLeft,255,255,255
	PositionEntity eyeLeft ,.29,.4,.7;1
	ScaleEntity eyeLeft ,0.2,0.2,0.2
	
	pupilLeft = CreateSphere(8,p\mesh):EntityColor pupilLeft ,0,0,0
	PositionEntity pupilLeft ,.3,.4,.9;1
	ScaleEntity pupilLeft ,0.05,0.05,0.02
	
	eyeRight = CreateSphere(8,p\mesh):EntityColor eyeRight ,255,255,255
	PositionEntity eyeRight ,-.29,.4,.7;1
	ScaleEntity eyeRight ,0.2,0.2,0.2
	
	pupilRight = CreateSphere(8,p\mesh):EntityColor pupilRight ,0,0,0
	PositionEntity pupilRight ,-.3,.4,.9;1
	ScaleEntity pupilRight ,0.05,0.05,0.02
	
	unaBrow = CreateCone(8,1,p\mesh):EntityColor unaBrow ,0,0,0
	PositionEntity unaBrow ,0,.45,.7
	RotateEntity unaBrow ,-180,0,0
	ScaleEntity unaBrow ,.7,.2,.3
	
	
	
	;Give a random color to our player.
	p\r = Rand(255)
	p\g = Rand(255)
	p\b = Rand(255)
	EntityColor p\mesh,p\r,p\g,p\b
	
	r=p\r
	g=p\g
	b=p\b
	;create arms &amp; hands.,
	upperArmLeft = CreateSphere(8,p\mesh):EntityColor upperArmLeft,150,150,150 ; ,r,g,b
	PositionEntity upperArmLeft ,0.9,0.2,.2
	RotateEntity upperArmLeft ,0,0,20
	ScaleEntity upperArmLeft ,0.2,0.4,0.2
	
	lowerArmLeft = CreateSphere(8,p\mesh):EntityColor lowerArmLeft,150,150,150 ; ,r,g,b
	PositionEntity lowerArmLeft ,0.9,-.1,.45
	RotateEntity lowerArmLeft ,0,15,20
	ScaleEntity lowerArmLeft ,0.2,0.2,0.4
	
	handLeft = CreateSphere(8,p\mesh):EntityColor handLeft,255,255,255
	PositionEntity handLeft ,.7,-.1,.7
	RotateEntity handLeft ,0,15,20
	ScaleEntity handLeft ,0.22,0.22,0.22



	upperArmRight = CreateSphere(8,p\mesh):EntityColor upperArmRight ,150,150,150
	PositionEntity upperArmRight ,-0.9,0.2,.2
	RotateEntity upperArmRight ,0,0,-20
	ScaleEntity upperArmRight ,0.2,0.4,0.2
	
	lowerArmRight = CreateSphere(8,p\mesh):EntityColor lowerArmRight ,150,150,150
	PositionEntity lowerArmRight ,-0.9,-.1,.45
	RotateEntity lowerArmRight ,0,-15,-20
	ScaleEntity lowerArmRight ,0.2,0.2,0.4
	
	handRight = CreateSphere(8,p\mesh):EntityColor handRight ,255,255,255
	PositionEntity handRight ,-.7,-.1,.7
	RotateEntity handRight ,0,15,-20
	ScaleEntity handRight ,0.22,0.22,0.22

	
	
	; create a simple gun..
	gunHandle = CreateCube(p\mesh):EntityColor gunHandle ,70,70,70
	PositionEntity gunHandle ,.6,-.2,1
	ScaleEntity gunHandle ,0.07,0.3,0.1
	RotateEntity gunHandle ,0,20,20
	
	gun = CreateCube(p\mesh):EntityColor gun,70,70,70
	PositionEntity gun,.5,.2,1
	ScaleEntity gun ,0.07,.12,0.7
	RotateEntity gun ,0,20,20
	
	
	
	EntityType p\mesh,2
	;EntityRadius p\mesh,1.2,1.0
	EntityRadius p\mesh,1.0

	
	;start at one of our random spawn positions.
	RandomSpawn(p\id)	
	
	
	Return p\mesh
	
End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function SpawnPlayer(id,spawnId)
	
	p.player = Object.player(GetPlayer(id))
	
	For s.spawn = Each spawn
		If s\spawnId = spawnId Then Exit
	Next
	
	p\life = 80
	
	p\nextX = s\x
	p\nextY = s\y
	p\nextZ = s\z
	p\nextYaw = s\yaw
	
	p\previousX = p\nextX
	p\previousY = p\nextY
	p\previousZ = p\nextZ
	p\previousYaw = p\nextYaw
	
	PositionEntity p\mesh,p\nextX,p\nextY,p\nextZ
	RotateEntity p\mesh,0,p\nextYaw,0
	ResetEntity p\mesh
	
	p\currentY = p\nextY
	
	p\previousTime = MilliSecs()
	p\nextTime = MilliSecs()+1
	
End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function RandomSpawn(id)
	
	p.player = Object.player(GetPlayer(id))
	
	; if we are server, spawn player at random location
	If localMode = 2
		randSpawn = Rand(1,spawns)
		SpawnPlayer(p\id,randSpawn)
		Net_SendMessage(9,randSpawn,p\id)
		Net_SendMessage(9,randSpawn,p\id,p\id)
	Else ; else default spawn = first spawn created
		SpawnPlayer(p\id,1)

	EndIf
	;is this heard on local and networked playerside?
	SoundVolume appearsnd, .2 
	appearchannel= PlaySound (appearsnd)
	
End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function CreateSpawn(x#,y#,z#,yaw#)
	
	spawns = spawns + 1
	
	s.spawn = New spawn
	s\spawnId = spawns
	s\x = x
	s\y = y
	s\z = z
	s\yaw = yaw
	
End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function GetPlayer(id)
	
	For p.player = Each player
		If p\id = id
			Return Handle(p)					
		EndIf
	Next
	
End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function DrawPlayersNames()
	
	For p.player = Each player
		If EntityVisible (p\mesh,camera)
			
			Color 255,255,255
			CameraProject(camera,EntityX(p\mesh),EntityY(p\mesh),EntityZ(p\mesh)) 	
			
			; only when not the host
			If p\id &lt;&gt; localID Then Text ProjectedX(),ProjectedY()-60,p\name,1,1 ; the more health, the brighter the color..
			
			Color 255,(255./100.)*p\life,(255./100.)*p\life ;?
			Text ProjectedX(),ProjectedY()-40,p\life,1,1
		EndIf
	Next
	
End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function DrawHealthItemStrengths()
	
	For h.health = Each health
		If EntityVisible (h\mesh,camera)
			Color 255,0,0
			CameraProject(camera,EntityX(h\mesh),EntityY(h\mesh),EntityZ(h\mesh)) 
			
			Color 255,(255./100.)*h\power,(255./100.)*h\power
			If MilliSecs() - h\pickupTime &gt; h\respawnDelay Then ;ShowEntity h\mesh only when it's spawn time has passed..
				Text ProjectedX(),ProjectedY()-35,h\power,1,1
			EndIf
		EndIf
	Next
	
End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function CreateBullet(id)
	; this will create a bullet
	
	p.player = Object.player(GetPlayer(id)) ; tie the shooter's id to the bullit..
	b.bullet = New bullet
	b\id = p\id
	
	b\mesh = CreateSphere(2)
	ScaleEntity b\mesh,0.2,0.2,0.2
	EntityColor b\mesh,255,255,0
	
	PositionEntity b\mesh,EntityX(p\mesh),EntityY(p\mesh),EntityZ(p\mesh)
	RotateEntity b\mesh,0,EntityYaw(p\mesh),0
	
	MoveEntity b\mesh,0,0,2 ; so can't hit own player little less easy..(no sure fix, as bullets do not have ownership on them)
	EntityType b\mesh,3
	EntityRadius b\mesh,0.2
	
	SoundVolume shoot, .5
	shootchannel = PlaySound (shoot) ;shooting sound is started.
	
	
	
	b\time = MilliSecs()
	
End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function UpdateBullets()
	
	For b.bullet = Each bullet
		
		MoveEntity b\mesh,0,0,1.5; increase speed so player can't outrun bullets and hit himself easily(unless someth weird happens..)
		
		If CountCollisions(b\mesh)
			
			If localMode = 2 ; so when is server. only the server compute bullets collision with player
				
				If GetEntityType(CollisionEntity(b\mesh,1)) = 2 
					
					;If b\id&lt;&gt;localID ; check if player hit is not hit by own bullit. &lt;&lt;&lt; not solving the issue- causes server not being able to shoot others..
					
						touchedPlayer.player = Object.player(EntityName(CollisionEntity(b\mesh,1)))
						;NewMessage( "localID ="+localID + " bullit\id= " + b\id)
						
						touchedPlayer\life = touchedPlayer\life - 10 ; reduce health when hit.
					
				
						If touchedPlayer\life &gt; 0 ; touched and still has health to spare..
							Net_SendMessage(5,touchedPlayer\life,touchedPlayer\id)
							Net_SendMessage(5,touchedPlayer\life,touchedPlayer\id,touchedPlayer\id)
							hitchannel = PlaySound (hitsnd)
						Else ; killed (all out of health)
							boomchannel = PlaySound (boom) ;boom sound is started. 

							
							killerPlayer.player = Object.player(GetPlayer(b\id))
						
							killerPlayer\kills = killerPlayer\kills + 1
							touchedPlayer\deaths = touchedPlayer\deaths + 1						
						
						
						
							Net_SendMessage(6,touchedPlayer\id,killerPlayer\id)
							Net_SendMessage(6,touchedPlayer\id,killerPlayer\id,killerPlayer\id)
						
							Net_SendMessage(7,killerPlayer\kills+"/"+killerPlayer\deaths,killerPlayer\id)
							Net_SendMessage(7,killerPlayer\kills+"/"+killerPlayer\deaths,killerPlayer\id,killerPlayer\id)
						
							Net_SendMessage(7,touchedPlayer\kills+"/"+touchedPlayer\deaths,touchedPlayer\id)
							Net_SendMessage(7,touchedPlayer\kills+"/"+touchedPlayer\deaths,touchedPlayer\id,touchedPlayer\id)
						
							NewMessage(killerPlayer\name + " killed " + touchedPlayer\name)
							RandomSpawn(touchedPlayer\id)
											
 					
							;ResetPlayer(touchedPlayer\id) ;&lt;&lt;
						EndIf
						
						
					;EndIf
				
				EndIf
				
			EndIf
			
			FreeEntity b\mesh
			Delete b
			
		ElseIf MilliSecs()-b\time &gt; 2000
			
			FreeEntity b\mesh
			Delete b
			
		EndIf
		
	Next
	
End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function CreateHealthItem(x#,y#,z#,power#,respawnDelay#)
	
	h.health = New health
	
	h\mesh = CreateMesh()
	
	h\power = power ; set item strength
	
	;h\respawnDelay = 10000
	h\respawnDelay = respawnDelay ; set according to valuableness(strength actually)..
	
	; create the object..
	mesh1 = CreateCube()
	mesh2 = CreateCube()
	
	ScaleMesh mesh1,.20,.5,.20
	ScaleMesh mesh2,.20,.5,.20:RotateMesh mesh2,90,0,0
	
	AddMesh(mesh1,h\mesh)
	AddMesh(mesh2,h\mesh)
	
	EntityColor h\mesh,255,0,0
	
	; if we are the host..
	If localMode = 2 Then EntityType h\mesh,4
	EntityRadius h\mesh,0.5
	
	PositionEntity h\mesh,x,y,z
	
	NameEntity h\mesh,Handle(h)

End Function




;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function UpdateHealthItems()
	
	For h.health = Each health
		
		TurnEntity h\mesh,0,-2,0
		
		If localMode = 2 And GetEntityType(h\mesh) &lt;&gt; 4
			EntityType h\mesh,4
			EntityRadius h\mesh,0.5
		EndIf
		
		If CountCollisions(h\mesh)
			
			If localMode = 2 ; only the server computes collision with player
				If GetEntityType(CollisionEntity(h\mesh,1)) = 2 ; a player collided
					
					touchedPlayer.player = Object.player(EntityName(CollisionEntity(h\mesh,1)))
					
					h\pickupTime = MilliSecs()
					HideEntity h\mesh
					h\visible = False
					ResetEntity h\mesh
					
					Net_SendMessage(8,Handle(h))
					
					If touchedPlayer\life &lt; 100 ; touched healthpowerup MAYBE REMOVE DUE TO REDUNDANCY!(See lines below)
						touchedPlayer\life = touchedPlayer\life + h\power ;add power of the healthitem to touched players life.

						If touchedPlayer\life &gt;100
							touchedPlayer\life = 100
						EndIf
						
						Net_SendMessage(5,touchedPlayer\life,touchedPlayer\id)
						Net_SendMessage(5,touchedPlayer\life,touchedPlayer\id,touchedPlayer\id)
						pwrchannel = PlaySound (pwr) ; pwrup sound is started when collected.
						
					Else	
						pickupchannel = PlaySound (pickup) ; pickup sound is started when collected and already full.
						; notify other players here so can play sound too.
					EndIf
					
				EndIf
				
				; sound for non-localmode(so clients) here..
				
			EndIf
			
		EndIf
		
		If MilliSecs() - h\pickupTime &gt; h\respawnDelay And h\visible = False
			ShowEntity h\mesh ; show entity when spawn time passed,,
			If firsttimehealth=False
				pwrchannel = PlaySound (pwrappear) ; appear sound is started when h\mesh appears
			EndIf
			h\visible= True
		EndIf
	Next
	
End Function


;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;


;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function NewMessage(msg$)
	
	; this routine checks and updates the message buffer.
	messageOffset = messageOffset + 1
	
	If messageOffset &gt; messageDisplayNumber
		
		messageOffset = messageOffset - 1
		
		For i = 2 To messageDisplayNumber
			message(i-1) = message(i)		
		Next
		
		message(messageDisplayNumber) = msg
		
	Else
		
		message(messageOffset) = msg
		
	EndIf
	
End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function DrawMessages()
	
	; this routine does the actual on screen drawing of the chat..
	
	Color 255,255,255
	
	For i = 1 To messageOffset
		
		;Text 0,(i-1)*15,message(i)	
		
		; &lt;&lt;&lt; colored txt mod by Raster Ron
		loc = Instr (message(i), "",1)
		If loc &gt; 1 Then 
			colorMessage$ = Mid$(message(i), 1, Len(message(i)) - 7 ) 
			Hex$ = Right$(message(i),6)		 
			Set_Color_Hex(Hex$) 
			Text 0,(i-1)*15,colorMessage$ 
		Else  
			Color 255,255,255 
			Text 0,(i-1)*15,message(i) 
		End If	
		; &lt;&lt;&lt; End colored txt mod by Raster Ron
		
	Next
	
End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function UpdateChat()
	
	; this routine does the input check..
	key = GetKey()
	If key
		If key = 13 ;carriage return, so entered, msgline finished.
			If chatMessage &lt;&gt; localName + "&gt; " ; so msg is larger than the prompt.
				
				If Len(chatMessage) &gt; maxlinelength-(Len(localName)+2)  ; so exceeds max line length
					chatMessage = Left$(chatMessage,maxlinelength) ; so ignoring all surpassing max chars.
				EndIf	
				
				
				For i = Len(localName + "&gt; ") To Len(chatMessage) ;check all characters from afte name+promtsign to end of msg..
					If Mid(chatMessage,i,1) &lt;&gt; " " ; trap all spaces input, so no empty jibberish..
						
						
						; '/' commands..
						
						
						If Mid(chatMessage,i,1) = "/"  ; check for the command trigger '/' if so, go into command mode..
							
							;check 2nd part(command) &lt;&lt; later to be done from data statements holding all commands..
							If Mid(chatMessage,i+1,5) = "kick " ; if at $location name+promptsign+/+5 chars= "kick "
								playerToBeKickedName$ = Mid(chatMessage,i+6, Len(chatMessage) )    ;
						
								For p.player = Each player ; check each player
									If p\name = playerToBeKickedName$  ;so only if playername exists..
									
										If localMode = 2 ; only the host/server can kick/ban players..(ban not requires keeping a dbase).
											If playerToBeKickedName$ &lt;&gt; localName$ ; so host is not kicking himself.
												
												chatMessage=playerToBeKickedName$ + " has been kicked by host! "
												;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
												; &lt;&lt;&lt; colored txt mod by Raster Ron
												chatColor$ = RGB_To_TriHex(cR,cG,cB)
												chatMessage = chatMessage + "" + chatColor$
												;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
																					
												
												Net_SendMessage(1,chatMessage) ; send msg to all.
												Net_KickPlayer(playerToBeKickedName$) 
									
											Else 
												NewMessage( "-Selfkicking not allowed.. ") ; display msg.
											EndIf
											
										;ElseIf localMode = 3 ; moderator &lt;&lt; to be introduced into code stil..	
											;moderator commands go here.
												
										Else ; so  localMode &lt;&gt; 2 or 3 ;so no server/host or moderator..
											;Net_SendMessage(1,"") ; send msg to all.
											NewMessage( "-Kicking not allowed for non-admins.. ") ; display msg.
										EndIf
										;Exit
									EndIf
								Next
								
							; other commands..	list, changetype(only allowed by host, can create moderator), wizz(unlimited ammo/health etc).	
							ElseIf Mid(chatMessage,i+1,5) = "list" ; if at $location name+promptsign+/+5 chars= "list"
								
								NewMessage( "Players:" ) ; display msg.
								NewMessage( "--------" ) ; display msg.
								For p.player = Each player ; check each player
									lst=lst+1
									playerList$=lst + ". Name: " + p\name + " | ID: " +  p\id + " | Ping: " + p\ping 
									NewMessage( playerList$ ) ; display msg.
									
									;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
									; &lt;&lt;&lt; colored txt mod by Raster Ron
									;chatColor$ = RGB_To_TriHex(cR,cG,cB)
									;chatMessage = chatMessage + "" + chatColor$
									;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
									
								Next
								Lst=0
								; count players
								For n.net_client = Each net_client
									Lst = Lst + 1	
									CID = n\ID
									CName = n\name
									CIP=DottedIP$(n\IP)
									CPort= n\port			
									clientList$=Lst + ". Name: " + CName + " | ID: " +  CID+ " | Port: " + CPort + " | IP:   " + CIP  
									
									NewMessage( clientList$ ) ; display msg.
								Next
								
								
							ElseIf Mid(chatMessage,i+1,10) = "rapidfire" ; 
								enableRapidFire=1-enableRapidFire
								If enableRapidFire=True
									statusMsg$="Rapid Fire Enabled!" 
								Else
									statusMsg$="Rapid Fire Disabled!" 
								EndIf
								NewMessage( statusMsg$ ) ; display msg.
							EndIf
							
							
							
							
						Else ; so if not in command mode.
							;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
							; &lt;&lt;&lt; colored txt mod by Raster Ron
							chatColor$ = RGB_To_TriHex(cR,cG,cB)
							chatMessage = chatMessage + "" + chatColor$
							;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
					
							Net_SendMessage(1,chatMessage) ; send msg to all.
							NewMessage(chatMessage)        ; put in the msg buffer for display on screen.
											
						EndIf	; 
						
						Exit	
							
					EndIf ; trap all spaces input, so no empty jibberish..
				Next ;check all characters from afte name+promtsign to end of msg..
			EndIf ;chatMessage &lt;&gt; localName + "&gt; " 
			
			chatMessage = localName + "&gt; "
			chatMode = 0
			
			
		ElseIf key = 8 And Len(chatMessage) &gt; Len ( localName + "&gt; " ) ; backspace and msg length longer then..
			chatMessage = Left(chatMessage,Len(chatMessage)-1) ; reduce lenght of msg with 1.
			
		ElseIf key &gt; 31 And key &lt; 127 ; if msg is valid range between 'US'(unit separator) and 'DEL' , so from 'SPACE' to '~'
			chatMessage = chatMessage + Chr(key)
			
		EndIf ;key = 
	EndIf ;key
	
	Color 255,255,255
	Rect 0,GraphicsHeight()-20,GraphicsWidth(),20,1
	Color 0,0,0
	Rect 0,GraphicsHeight()-20,GraphicsWidth(),20,0
	
	
	If MilliSecs()-chatMillisecs &gt; 500
		chatCursor = Not chatCursor
		chatMillisecs = MilliSecs()
	EndIf
	
	If chatCursor
		Text 5,GraphicsHeight()-17,chatMessage + "|"
	Else
		Text 5,GraphicsHeight()-17,chatMessage
	EndIf
	
End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function DrawScoreTable()
	
	For p.player = Each player
		count = count + 1
	Next
	
	baseX = (GraphicsWidth()-350)/2
	baseY = (GraphicsHeight()-(35+20*count))/2
	
	Color 0,0,0
	Rect baseX,baseY,350,35+20*count,1
	
	Color 255,192,0
	Rect baseX,baseY,350,35+20*count,0
	
	Text baseX+10,baseY+10,"Player          Kills     Deaths     Ping"
	Line baseX,baseY+25,baseX+349,baseY+25
	
	For p.player = Each player
		
		Color 255,255,255
		If p\id = localID Then Color 255,100,100
		
		i = i + 1
		Text baseX+10,baseY+10+20*i,p\name
		Text baseX+157,baseY+10+20*i,p\kills,1,0
		Text baseX+240,baseY+10+20*i,p\deaths,1,0
		Text baseX+322,baseY+10+20*i,p\ping,1,0
	Next
	
End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function UpdateChaseCam(camera,player) ; thanks to jfk EO-11110 on bb forums for this function !
	PositionEntity camera,EntityX(player,1),EntityY(player,1),EntityZ(player,1)
	ResetEntity camera
	x#=EntityX(player)+Sin(-EntityYaw(player)+180)*x_dis#
	y#=EntityY(player)+y_dis#
	z#=EntityZ(player)+Cos(-EntityYaw(player)+180)*z_dis#
	obstacle=LinePick(EntityX(player),EntityY(player),EntityZ(player),(x-EntityX(player)),y_dis#,(z-EntityZ(player)),0.1)
	If obstacle=0
		new_x#=x
		new_y#=y
		new_z#=z
	Else
		new_x#=PickedX()
		new_y#=PickedY()
		new_z#=PickedZ()
	EndIf
	If bounce_cam=0
		PositionEntity camera,new_x,new_y,new_z
	Else
		x=old_x+((New_x-old_x)/bounce_div#)
		y=old_y+((New_y-old_y)/bounce_div#)
		z=old_z+((New_z-old_z)/bounce_div#)
		PositionEntity camera,x,y,z
	EndIf
	PointEntity camera,player
	TurnEntity camera,-20,0,0     ; if you want the player mesh more on the bottom of the screen
	old_x#=EntityX(camera)
	old_y#=EntityY(camera)
	old_z#=EntityZ(camera)
End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function CreateScene()
	
	texture = TextureCreate(128)
	
	ground = CreatePlane()
	EntityColor ground,150,150,150
	EntityTexture ground,texture
	
	cube = CreateCube():EntityColor cube,150,200,150
	ScaleEntity cube,5,5,5:PositionEntity cube,0,5,0
	EntityTexture cube,texture
	
	sphere = CreateSphere(16):EntityColor sphere,200,150,150
	ScaleEntity sphere,3,1,3:PositionEntity sphere,0,9.7,0
	
	platform = CreateCube():EntityColor platform,150,150,200
	ScaleEntity platform,3,1,10:PositionEntity platform,0,4.13,-13.15
	TurnEntity platform,-30,0,0
	EntityTexture platform,texture
	
	; spawn locations
	spawner1 = CreateSphere() :EntityColor spawner1 ,150,150,150;  &lt;&lt;&lt;&lt;
	ScaleEntity spawner1 ,2,3,2:PositionEntity spawner1 ,-20,.1,-20 ;&lt;&lt;&lt;&lt;
	EntityTexture spawner1 ,texture
	
	column= CreateCylinder()
	ScaleEntity column,2,3,2:PositionEntity column,20,.1,20 ;&lt;&lt;&lt;&lt;
	EntityTexture column,texture
	
	FreeTexture texture
	
	
	
	EntityType ground,1:EntityPickMode ground,2
	EntityType cube,1:EntityPickMode cube,2
	EntityType sphere,1:EntityPickMode sphere,2
	EntityType platform,1:EntityPickMode platform,2
	EntityType spawner1,1:EntityPickMode spawner1,2
	EntityType column,1:EntityPickMode column,2
	
	
	
	; setup light..
	light = CreateLight()
	TurnEntity light,30,70,0
	
	; create health upgrade items.	
	CreateHealthItem(0,12,0,100,100000) ; the one on top
	CreateHealthItem(0,1,-10,10,10000)  ; undenneath the ramp
	CreateHealthItem(0,3,-20,30,30000)  ; on the ramp
	firsttimehealth=True
	
	;; COLLISIONS
	Collisions 2,1,2,3 ; player to scene
	Collisions 2,2,1,3 ; player to player
	
	Collisions 3,1,2,1 ; bullet to scene
	Collisions 3,2,1,1 ; bullet to player
	
	Collisions 2,4,1,2 ; player to health
	
End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function TextureCreate(size)
	texture = CreateTexture(size,size,9)
	SetBuffer TextureBuffer(texture)
	Color 255,255,255
	Rect 0,0,size,size,1
	Color 0,0,0
	Rect 0,0,size,size,0
	Line 0,0,size,size
	Line 0,size,size,0
	SetBuffer BackBuffer()
	Return texture
End Function


;======================================================================================
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function LoadSFX()
	;run = LoadSound ("sounds\gravel.wav")
	;wade = LoadSound ("sounds\water.wav")
	;SoundVolume run, 0
	;SoundVolume wade, 0
	;LoopSound run
	;LoopSound wade
	;runchannel = PlaySound (run)
	;wadechannel = PlaySound (wade)
;------------------------------
	
	shoot=LoadSound( "sounds\shoot.wav" ) ; shooting sound
	SoundVolume shoot, .5
	
	boom=LoadSound( "sounds\boom.wav" ) ; explosion sound
	SoundVolume boom, .8
	
	hitsnd=LoadSound( "sounds\bump1.wav" ) ; ugh sound
	SoundVolume hitsnd, .8
	
	
	deathsnd=LoadSound("sounds\" ) ; die sound
	
	appearsnd=LoadSound("sounds\XCMAKERS.WAV") ; player reappears sound
	
	
	pwrappear =  LoadSound( "sounds\mtruc.wav" ) ; healing item appear sound
	SoundVolume pwrappear , .8  
	
	pwr=LoadSound( "sounds\belltree.wav" ) ; healing sound
	SoundVolume pwr, .8  
	
	pickup=LoadSound( "sounds\click1.wav" ) ; pick up health sound
	SoundVolume pickup, .9  
	
	
	
	
	jumpsound=LoadSound( "sounds\boing.wav" ) ; jumping sound
	SoundVolume jumpsound, .9
	
	
;------------------------------	
	;bark = LoadSound("sounds\bark.wav")
	;SoundVolume bark, .5
	;barkChannel = PlaySound (bark) ;barking sound is started.
	
	;uh=LoadSound( "sounds\Asthma_Sound.wav_10720.wav" )
	;SoundVolume uh, .9
	
End Function

Function LoadMusic(files$)
	
;	bgmusic = LoadSound (files$)
;	SoundVolume bgmusic,.5 
;	LoopSound bgmusic
;	bgmusicChannel= PlaySound (bgmusic)
	
;	dangermusic = LoadSound ("Shadow Of The Beast - Aarbronsrevenge.mp3")
;   SoundVolume dangermusic,0
;   LoopSound dangermusic
;	dangermusicChannel= PlaySound(dangermusic)
	
End Function

Function DisplayKeyHelpTxt()
	xcor=30	
	Text GraphicsWidth/2+xcor*2, 10+ycor,"                *** Multiplayer Example Help ***               "
	Text GraphicsWidth/2+xcor*2, 20+ycor," ------------------------------------------------------------- " 
	Text GraphicsWidth/2+xcor*2, 35+ycor," Game Controls                          | In Chat mode         " 	
	Text GraphicsWidth/2+xcor*2, 50+ycor," ------------------------------------------------------------- " 	
	Text GraphicsWidth/2+xcor*2, 65+ycor," Move            : Cursor / WASD        | Command prefix :'/'  " 
	Text GraphicsWidth/2+xcor*2, 80+ycor," Jump            : Space  / Right mouse | e.g:                 "
	Text GraphicsWidth/2+xcor*2, 95+ycor," Shoot           : Ctrl   / Left  mouse | /kick &lt;playername&gt;   "  
	Text GraphicsWidth/2+xcor*2,110+ycor," ---------------------------------------| /list                "  
	Text GraphicsWidth/2+xcor*2,125+ycor," Score           : Tab                  |                      "
    Text GraphicsWidth/2+xcor*2,140+ycor," Focus (toggle)  : F                    | (Also to be used for "
	Text GraphicsWidth/2+xcor*2,155+ycor," Chat            : Enter                | cheats such as       "
	Text GraphicsWidth/2+xcor*2,170+ycor," Help(this text) : F1                   | 'rapidfire')         " 
	Text GraphicsWidth/2+xcor*2,185+ycor," Player color    : F2                   |                      " 	
	Text GraphicsWidth/2+xcor*2,200+ycor," Exit            : Esc                  |                      " 
	Text GraphicsWidth/2+xcor*2,215+ycor," ------------------------------------------------------------- " 
	
End Function
;~IDEal Editor Parameters:
;~C#Blitz3D
</textarea><br><br>code + media:<br><a href="http://www.mediafire.com/download/5upk73mvgwwq2wm/UDPlib_V1.12_and_examples%28share%29.rar" target="_blank">UDPlib V1.12 and examples(share).rar</a> <br><br></td></tr></table><br>
<a name="1305247"></a>

<a name="1305255"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rick Nasher</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#197">[#197]</a></td></tr></table></td></tr><tr ><td class="posttext"> small update: Friendly fire bugfix(really easy actually).<br><textarea class=codebox name="code" wrap=OFF readonly="true" rows="15" cols="80">
; *** ROADMAP/HISTORY ***
;
; ADDED SO FAR: 
; -chattext colors matched to playercolors.
; -different health strengths and spawn times.
; -hide entities names when one player cannot see each other(so can play hide&amp;seek)..
; -different health item strengths, which are also displayed above the 
;  item and take time to become available again depending on strenght.
; -fixes to keybd input and window focus.
; -sound fx(quicky, needs more work).
;
; UPDATE 29-04-2016:
; -lock/unlock mse + hud.focus to window switch 'f'.
; -F1=help.
; -F2=change player color on the fly.
; -rapidfire toggle command.
; 
; UPDATE 05-05-2016:
; -V1.66   fixed friendly fire bug.(no more shooting yourself in the foot, stommach or whatever :-)
;
; -V1.66.2 working on: messaging system to e.g. correctly display msg+snd.
;
; TODO UPTO VERSION 2.0 (not nesacerrily in this order, all using procedural gfx, without ext libs/media, except sound):
; -test w gf, flanker or others. ;-) 
; -reduce life when fell off too high cliff(using if linepick&lt;&gt; and entity distance&lt;&gt;ground.
; -scorch marks on hit objects.
; -fps /tps switch.
; -weapon upgrades.
; -'/' cheatmodes and additional commands.
; -flashlight  + day nightcycle.
; -add moving platforms demo code.
; -game music. playing more exited when near an enemy.
; -robo players with simple ai.
; -gui with saveable prefs.
; -simple animated chars.
; -ladder climbing/crouching.
; -walking, running and sounds to match.
; -superjump powerup.
; -schields.
; -teleportation.
; -weather conditions. 
;
; TODO FOR VERSION 3.0 (more advanced, incorporating media and ext libs):
; -move to stayne's level.
; -3d animated chars.
; -AlienBreed 3d characters?
; -Special effects, doors, etc.
; -Vehicals/terrian.
; -PhysX.
; -Shadows.

; Bugs:
; - audio only on local player. fixed for jump sound. others? (need to check).

;
SeedRnd MilliSecs()

Const gameLogicFPS = 60

Global enableFocus=True  ; lock mouse to screen and hide pointer 'f' key toggles locked/unlocked mode.
Global enableRapidFire=False  ; 'r' key toggles normal/rapidfire mode.

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
; first we include the KeyFix library
Include "KeyFix_Constants.bb"

; we now include the network library
Include "UDPNetwork_lib.bb"
; for converting RGB values to "Tri-Hex" stringc inlude hex8.
Include "Hex8.bb" ;&lt;&lt;&lt; Colored txt mod by Raster Ron 

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Global localID
;Global localName$ = Input("Enter your name : ")
;If localName = "" Then localName = "player" + Rand(100,999)

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;&lt;&lt; Enter through mod..
Global localName$ = "", defaultName$ = "RCX" ; My own pre-defined username, so just need to press enter to save typing ;-) 
;change above username to your own liking.

Print "Change default name: '"+ defaultName$ +"' ?"
Choic$ = Input$("[Press [Y]es or [ENTER] for No: ")
If Choic$="y" Then ; so want to change..
	Cls:Locate 0,0
	Print "Type name &amp; press [ENTER] or"
	ChangeName$=Input$("just [ENTER] to autogenerate: ")
	If ChangeName$="" ; so pressed enter to autogen..
		localName = "player" + Rand(100,999)
	Else ; so entered a new name..
		localName$=ChangeName$
	EndIf
Else ; so entered without input.
	localName$ = defaultName$
EndIf

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Global localPlayerMesh

Type player
	Field id
	Field name$
	Field ping
	Field ip
	
	Field life
	Field kills
	Field deaths
	
	Field mesh
	Field r,g,b
	
	Field nextX#,nextY#,nextZ#
	Field previousX#,previousY#,previousZ#
	Field nextYaw#
	Field previousYaw#
	Field nextTime
	Field previousTime
	
	Field lastPacket
	
	Field currentY#
	Field velocityY#
	
	Field jumped
	
End Type

Type bullet
	Field mesh
	Field angle#
	Field time
	Field id ; id of player who fired
End Type

Type health
	Field mesh
	Field pickupTime ; to store when was pickedup and can hide for a certain time set in 
	Field respawnDelay ; &lt; see above
	Field visible
	Field power ; to hold strength of upgrade
	Field id ; id of player who collected
End Type

Type spawn
	Field spawnId
	Field x#,y#,z#
	Field yaw#
End Type

Global spawns ; number of spawn points
Global firsttimehealth=True

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
; Camera code from jfk EO-11110, thanks
Global bounce_cam=1 ;  smooth camera motion? (0/1)
Global bounce_div#=10.0 ; the higher, the more sluggish the camera will follow. Recc: 3.0 to 20.0
; some globals used by ChaseCam
Global old_x#,old_y#,old_z#
; desired distance between camera and player mesh
Global x_dis#=7.0,y_dis#=3,z_dis#=7.0,y_dis_or#=y_dis#


;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;

; network init ----------------------------------------;
Global localMode = Net_StartInput() ; bring the library "console" to connect

If localMode = 1 Or localMode = 2 ; 1 means we are client, 2 means we are server
	
	localID = Net_CreatePlayer(localName) ; this command inits the server or local client
	
	If localID = 0 ; error
		Net_StopNetwork() ; close the network properly
		RuntimeError("Failed to create player.")
	EndIf
	
	If localMode = 1 Then AppTitle("Client : " + localName + " (port:" + net_port + "/ ID=" + localID +" / IP= "+ net_ip+ ")                   [F1] = Help!")
	If localMode = 2 Then AppTitle("Server : " + localName + " (port:" + net_port + "/ ID=" + localID +" / IP= "+ net_ip+ ")                   [F1] = Help!")
	 
Else ; error
	Net_StopNetwork()
	RuntimeError("Failed to start game.")
EndIf
;------------------------------------------------------;
grphicsWidth = 640
grphicsHeight= 480
Graphics3D grphicsWidth ,grphicsHeight,32,2
SetBuffer BackBuffer()

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
; audio
Global musicOn=False, musiclevel#=.5, danger=False												 ;music 
Global bgmusic_vol#=.5, bgmusicChannel, bgmusic 
Global dangermusic_vol#=0, dangermusicChannel, dangermusic     		     			             ;music

Global wade_vol#, run_vol#, wadechannel, runchannel , shootchannel, boomchannel, pwrchannel	     ;player sfx
Global shoot, boom, uh, pwr, pwrappear, pickup , pickupchannel ,jumpchannel, jumpsound , hitsnd, hitchannel   
Global deathsnd, appearsnd

;Game music
;If gamelevel=1 Then LoadMusic("spacepanic.mp3") ; load gamemusic
;If gamelevel=2 Then LoadMusic("Shadow Of The Beast - To The Castle.mp3") 
;(If entitydistance &lt; theshold then play "battle music").
;If musicOn=False     ; if music is off then turn off volume
;	musiclevel#=0
;EndIf

LoadSFX()


;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
CreateScene()

;create spawn locations to randomly pick from, currently 3.
CreateSpawn(0,12,0,0)
CreateSpawn( 20,10, 20, 45)
CreateSpawn(-20,10,-20,-45)


Global camera = CreateCamera()
CameraRange camera,0.1,1000

; create our own local player
localPlayerMesh = CreatePlayer(localID,localName)
old_x = EntityX(localPlayerMesh):old_y = EntityY(localPlayerMesh):old_z = EntityZ(localPlayerMesh) ; update camera position

; we send our color to the server
p.player = Object.player(GetPlayer(localID))
Net_SendMessage(3,p\r + "/" + p\g + "/" + p\b)

; &lt;&lt;&lt; colored txt mod by Raster Ron..
;store colors for chattxt.
Global cR = p\r 
Global cG = p\g 
Global cB = p\b 
; &lt;&lt;&lt; end colored txt mod by Raster Ron..


; variables used to send our positions at a constant delay (saves bandwidth but makes a constant ping)
Global updatePosition = MilliSecs()
Global updateTick = 50

; chat
Global maxlinelength% = 79
Global messageDisplayNumber = 10
Global messageOffset
Dim message$(messageDisplayNumber)

Global chatMode
Global chatMessage$ = localName + "&gt; "
Global chatMillisecs = MilliSecs()
Global chatCursor

.mainLoop
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
tweeningPeriod = 1000 / gameLogicFPS
tweeningTime = MilliSecs() - tweeningPeriod
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
While Not KeyHit(1)
	
	;; I use tweening from castle demo here :
	;;
	;; 		- this allows to have very fast execution outside the tweening loop,
	;; 		  so the network is updated as fast as possible (needs Flip False)
	;;
	;; 		- this makes the game logic updated at a constant rate (Const FPS=)
	;;		  so no need to set deltatime (and it saves CPU time for other things)
	
	
	;; -------------------------------------------------------------------------------------------------; FAST EXECUTION (outside of tweening)
	;; -------------------------------------------------------------------------------------------------;
	
	; see the function, the interpolation variables are set properly here
	UpdateNetwork()
	
	;; -------------------------------------------------------------------------------------------------;
	
	Repeat
		tweeningElapsed = MilliSecs() - tweeningTime
	Until tweeningElapsed
	tweeningTicks = tweeningElapsed / tweeningPeriod
	tweeningRate# = Float(tweeningElapsed Mod tweeningPeriod)/Float(tweeningPeriod)
	For k = 1 To tweeningTicks
		tweeningTime = tweeningTime + tweeningPeriod
		If k = tweeningTicks Then CaptureWorld
		
		;; ---------------------------------------------------------------------------------------------; MAIN UPDATE
		;; ---------------------------------------------------------------------------------------------;
		;sound
		;ChannelVolume wadechannel, wade_vol# ; adjust wadesound volume 0-1
		;ChannelVolume runchannel , run_vol#  ; adjust runsound volume 0-1
		;ChannelVolume bgmusicChannel    , bgmusic_vol# ;
		;ChannelVolume dangermusicChannel, dangermusic_vol# ;
		
		
		; update our player
		UpdateLocalPlayer() 
		
		; the interpolation is made in this function
		UpdatePlayers() ;network players and gravity
		
		UpdateWorld()
		
		; update the bullets... only the server checks for player kills
		UpdateBullets()
		UpdateHealthItems()
		UpdateChaseCam(camera,localPlayerMesh)
		;; ---------------------------------------------------------------------------------------------;
	Next
	
	RenderWorld tweeningRate
	
	;; -------------------------------------------------------------------------------------------------; 2D UPDATE
	
	DrawPlayersNames()
	DrawHealthItemStrengths()
	
	;; -------------------------------------------------------------------------------------------------;
	; Gereral input checks..
	If ( KeyHit ( 28 ) ) And chatMode = 0 Then chatMode = 1 : FlushKeys() ; Enter key for chat on/off
	If ( KeyHit ( 53 ) ) And chatMode = 0 Then chatMode = 1 ; / comnands &lt;&lt; will result in remembering prev input so not very good!
	If chatMode Then UpdateChat() 
	DrawMessages()
	
	If KeyDown(15) Then DrawScoreTable() ; Tab for scores
	
	If KeyDown(33) Then enableFocus=1-enableFocus : Delay 300 ; F key toggle focus locally.
	If enableFocus=False Then 
		ShowPointer 
	Else
		HidePointer
		MoveMouse(grphicsWidth/2, grphicsHeight/2)
	EndIf
	
	If KeyDown (59) Then ; F1 key for help locally .
		DisplayKeyHelpTxt()
	EndIf
	
	If KeyHit (60)  Then ; F2 change color of local player.
		;Give a random color to our player.
		p\r = Rand(255)
		p\g = Rand(255)
		p\b = Rand(255)
		EntityColor p\mesh,p\r,p\g,p\b
		;p.player = Object.player(GetPlayer(localID))
		Net_SendMessage(3,p\r + "/" + p\g + "/" + p\b) ; send new color to all players..
	EndIf
	;; -------------------------------------------------------------------------------------------------;
	
	Flip
	
Wend
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;

Net_StopNetwork()
End

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function UpdateNetwork()
	
	; update incoming packets (better check ALL incoming messages so use While Wend)
	While Net_CheckMessage() ; will check for a new message and fill Net_MsgType, Net_MsgString$, Net_MsgFrom and Net_MsgTo variables so we can read it
		
		p.player = Object.player(GetPlayer(Net_MsgFrom)) ; get the player handle
		
		If Handle(p) = 0 And Net_MsgType &lt; 100 ; we received an update packet from a player we don't know
			; so we ask the server who he is and return because we can't update him for now
			; the server will resend us the info in a new player "100" message
			Net_RequestPlayer(Net_MsgFrom)
			Return
		EndIf
		
		Select Net_MsgType ; check the type of message
				
			Case 1 ; chat message
				NewMessage(Net_MsgString)
				
			Case 2 ; player position and angle, example of packing data into string
				;unravel packed string data..
				offset1 = Instr(Net_MsgString,"/",1)
				offset2 = Instr(Net_MsgString,"/",offset1+1)
				offset3 = Instr(Net_MsgString,"/",offset2+1)
				offset4 = Instr(Net_MsgString,"/",offset3+1)
				offset5 = Instr(Net_MsgString,"/",offset4+1)
				
				p\previousX = p\nextX
				p\previousY = p\nextY
				p\previousZ = p\nextZ
				p\previousYaw = p\nextYaw
				
				p\nextX =  Left(Net_MsgString,offset1-1)
				p\nextY =   Mid(Net_MsgString,offset1+1,offset2-offset1-1)
				p\nextZ =   Mid(Net_MsgString,offset2+1,offset3-offset2-1)
				p\nextYaw = Mid(Net_MsgString,offset3+1,offset4-offset3-1)
				
				;p\nextYaw = Right(Net_MsgString,Len(Net_MsgString)-offset3)
 
				
				p\previousTime = p\nextTime
				p\nextTime = MilliSecs()
				

				
			Case 3 ; update player colors 
				offset1 = Instr(Net_MsgString,"/",1)
				offset2 = Instr(Net_MsgString,"/",offset1+1)
				
				p\r = Left(Net_MsgString,offset1-1)
				p\g = Mid(Net_MsgString,offset1+1,offset2-offset1-1)
				p\b = Right(Net_MsgString,Len(Net_MsgString)-offset2)
				
				EntityColor p\mesh,p\r,p\g,p\b
				;add bodyparts update here..
				
			Case 4 ; a player fired
				CreateBullet(Net_MsgFrom)
				
			Case 5 ; a player lost some life
				p\life = Net_MsgString
				;hitchannel = PlaySound (hitsnd) ;currently disabled for creates unwanted hitsounds..dunno why yet, need to check..
				
			Case 6 ; a player killed another one (out of life)
				k.player = Object.player(GetPlayer(Net_MsgString)) ; killed player ID in MsgData
				NewMessage(p\name + " killed " + k\name)
				boomchannel = PlaySound (boom) ;boom sound is started. 
				;ResetPlayer(k\id)
				
				
			Case 7 ; the server sends us score update for a player
				offset = Instr(Net_MsgString,"/",1)
				p\kills = Left(Net_MsgString,offset-1)
				p\deaths = Right(Net_MsgString,Len(Net_MsgString)-offset)
				
			Case 8 ; health pickup
				h.health = Object.health(Net_MsgString)
				HideEntity h\mesh
				h\pickupTime = MilliSecs()
				h\visible=False
				
				SoundVolume pwr, .2 
				pwrchannel = PlaySound (pwr) ; pwrup sound is started when collected.
				
				
			Case 81 ; fully restored health
				i.player = Object.player(GetPlayer(Net_MsgString)) ; killed player ID in MsgData
				NewMessage(i\name + " fully restored health!" ) ;&lt;&lt;&lt;
				;PlaySound ("revived")	
				
				
				
			Case 9 ; player spawn
				SpawnPlayer(p\id,Net_MsgString)	
				; play reborn sound here?
				
				
			Case 10 ;so jump msg has been sent to notify other players so they too can play sound.
				SoundVolume jympsound, .2 ; lower volume as is further away(usually).
				jumpchannel= PlaySound (jumpsound) 	
				
					
				
				
				

				
				
				
				
				
					
				
			;Net managing stuff here..	
			Case 100 ; new player connected, OR the server tells us who is already connected so we can create players when joining the game..
				If localMode = 2 ; if = server..
					For p.player = Each player ;
						Net_SendMessage(2,p\nextX + "/" + p\nextY + "/" + p\nextZ + "/" + p\nextYaw,p\id,Net_MsgFrom)
						Net_SendMessage(3,p\r + "/" + p\g + "/" + p\b,p\id,Net_MsgFrom)
						
						Net_SendMessage(5,p\life,p\id,Net_MsgFrom)
						Net_SendMessage(7,p\kills+"/"+p\deaths,p\id,Net_MsgFrom)
					Next
				EndIf
				
				NewMessage(Net_MsgString + " connected")
				CreatePlayer(Net_MsgFrom,Net_MsgString)
				
			Case 101 ; a player has quit..
				For p.player = Each player
					If Net_MsgFrom = p\id
						NewMessage(p\name + " disconnected")
						FreeEntity p\mesh
						Delete p
					EndIf
				Next
				
			Case 102 ; host has changed..
				For p.player = Each player
					If Net_MsgFrom = p\id
						If p\id = localID
							AppTitle("Server : " + localName + " (port:" + net_port + ")")
							NewMessage("You are the new host")
							localMode = 2
						Else
							NewMessage(p\name + " is the new host")
						EndIf					
					EndIf
				Next
				
			Case 103 ; ping update..
				For p.player = Each player
					If Net_MsgFrom = p\id
						p\ping = Net_MsgString
					EndIf
				Next
				
		End Select
		
	Wend
	
End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function UpdateLocalPlayer()  
		
		
	; UPDATE LOCAL PLAYER..
	p.player = Object.player(GetPlayer(localID)) ; get our local player id..
	
	; check inputs.. 	(note: needs to be replaced by circular algorithm..)
	
	If Not chatMode
		; movements
		If WK_DOWN ( ) Or UP_KDOWN    ( ) Then MoveEntity p\mesh,0,0,0.3  ; up
		If SK_DOWN ( ) Or DOWN_KDOWN    ( ) Then MoveEntity p\mesh,0,0,-0.3 ; down
		If AK_DOWN ( ) Or LEFT_KDOWN  ( ) Then TurnEntity p\mesh,0,3,0    ; left
		If DK_DOWN ( ) Or RIGHT_KDOWN ( ) Then TurnEntity p\mesh,0,-3,0   ; right
	
		; jump
		If  ( KeyHit ( 57 ) ) Or ( MouseHit ( 2 ) )  ; right mse or Spacebar
			; check if player is on the ground
			LinePick(EntityX(p\mesh),EntityY(p\mesh),EntityZ(p\mesh),0,-1.2,0)
			If PickedEntity() ;so if picked an entiry underneath so on some sort of ground/object..
				p\velocityY = 0.5 ; set "inverse" of gravity velocity, so can jump.
				
				; play jump sound locally..
				SoundVolume jympsound, .5
				jumpchannel= PlaySound (jumpsound) ;jump sound is started, but only for local player. (sound volume should be set here to medium)
				Net_SendMessage(10,"") ; notify other players a jump has taken place
			EndIf	
		EndIf
		
		; fire
		;If LM_DOWN ( )  ; left mouse down
		If enableRapidFire=True ; use keydown for keyscan..
			If ( KeyDown( 157 ) ) Or ( KeyDown( 29 ) )  Or ( MouseDown ( 1 ) ); left mouse down
				Net_SendMessage(4,"") ; notify other players a shot has been fired.
				CreateBullet(localID)
			EndIf
		Else ; use keyhit for keyscan..
			If ( KeyHit( 157 ) ) Or ( KeyHit( 29 ) )  Or ( MouseHit ( 1 ) ) ; left mouse hit
				Net_SendMessage(4,"") ; notify other players a shot has been fired.
				CreateBullet(localID)
			EndIf
		EndIf
		
		If KeyDown(19) Then enableRapidFire=1-enableRapidFire: Delay 300 ; R key, disabled and moved to chat commands.
		
	EndIf
	

	; we create a message Type "2" For player position..
	If MilliSecs()-updatePosition &gt; updateTick ; 
		; sent the position and jumpstatus over the network so other players can adjust/act accordingly..
		; pack a msg string containing x,y,z,jump data..
		Net_SendMessage(2,EntityX(p\mesh) + "/" + EntityY(p\mesh) + "/" + EntityZ(p\mesh) + "/" + EntityYaw(p\mesh)+ "/" ) 
		updatePosition = MilliSecs()
	EndIf	
		

	
End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function UpdatePlayers()


		
	For p.player = Each player ; check all players..
	
		If p\id &lt;&gt; localID ; ; UPDATE NON LOCAL PLAYERS..
			;; LINEAR INTERPOLATION ;;;;;;;;;;
			If p\nextTime &lt;&gt; p\previousTime ; if both packets arrived at the same time, we can't interpolate
				curTime# = Float(MilliSecs()-p\nextTime) / Float(p\nextTime-p\previousTime) ; curTime will be ideally 0.0-1.0, if it's &gt; 1.0 then it performs extrapolation
				If curTime &gt; 1 Then curTime = 1 ; extrapolation gives anoying jittering effects
				; special fix for yaw as EntityYaw returns a value beetween +180 ans -180, the interpolation can go backward
				If p\previousYaw &lt; 0 Then p\previousYaw = p\previousYaw + 360
				If p\nextYaw &lt; 0 Then p\nextYaw = p\nextYaw + 360
				If Abs(p\nextYaw-p\previousYaw) &gt; 180
					If p\nextYaw &gt; p\previousYaw
						p\previousYaw = p\previousYaw + 360
					Else
						p\previousYaw = p\previousYaw - 360
					EndIf
				EndIf
				PositionEntity p\mesh,p\previousX+(p\nextX-p\previousX)*curTime,p\previousY+(p\nextY-p\previousY)*curTime,p\previousZ+(p\nextZ-p\previousZ)*curTime
				RotateEntity p\mesh,0,p\previousYaw+(p\nextYaw-p\previousYaw)*curTime,0
			Else
				PositionEntity p\mesh,p\nextX,p\nextY,p\nextZ
				RotateEntity p\mesh,0,p\nextYaw,0
			EndIf
			;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
			
		Else ; So if p\id = localID  thus update (local) player stuff. 
			 ; (Can't be combined with other local player stuff
			 ; for will somehow make jumping bit more laggy??)
			
			
			; basically below just computes gravity for local player. Actual positions will be updated across other player next loop. 
            ;[if done outside this loop(so at update local player) then jumping is more jurkey??]
			
			p\velocityY = p\velocityY - 0.03 ; increase fake gravity by substracting every time when passing by in this loop.
			Falling=True
			If EntityY(p\mesh) - p\currentY &gt;= 0 ; if player is not falling we limit the gravity
			If p\velocityY &lt; -0.03 Then p\velocityY = -0.03
				Falling=False
			EndIf
			p\currentY = EntityY(p\mesh)
			TranslateEntity p\mesh,0,p\velocityY,0
			
			
			; local sounds..
			;If p\jumped = True
			;	jumpchannel= PlaySound (jumpsound) ;jump sound is started, but only for local player 
			;	p\jumped = False ; and turn off again once done.
			;EndIf
			
			
		EndIf
	Next
	
End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function CreatePlayer(id,name$)
	
	For p.player = Each player
		If p\id = id Then Return ; player already connected
	Next
	
	p.player = New player
	p\id = id
	p\name = name
	
	
	;build player entity
	p\mesh = CreateSphere()
	
	NameEntity p\mesh,Handle(p)
	
	nose = CreateSphere(8,p\mesh):EntityColor nose,255,0,0
	PositionEntity nose,0,0,1
	ScaleEntity nose,0.3,0.3,0.3
	
	eyeLeft = CreateSphere(8,p\mesh):EntityColor eyeLeft,255,255,255
	PositionEntity eyeLeft ,.29,.4,.7;1
	ScaleEntity eyeLeft ,0.2,0.2,0.2
	
	pupilLeft = CreateSphere(8,p\mesh):EntityColor pupilLeft ,0,0,0
	PositionEntity pupilLeft ,.3,.4,.9;1
	ScaleEntity pupilLeft ,0.05,0.05,0.02
	
	eyeRight = CreateSphere(8,p\mesh):EntityColor eyeRight ,255,255,255
	PositionEntity eyeRight ,-.29,.4,.7;1
	ScaleEntity eyeRight ,0.2,0.2,0.2
	
	pupilRight = CreateSphere(8,p\mesh):EntityColor pupilRight ,0,0,0
	PositionEntity pupilRight ,-.3,.4,.9;1
	ScaleEntity pupilRight ,0.05,0.05,0.02
	
	unaBrow = CreateCone(8,1,p\mesh):EntityColor unaBrow ,0,0,0
	PositionEntity unaBrow ,0,.45,.7
	RotateEntity unaBrow ,-180,0,0
	ScaleEntity unaBrow ,.7,.2,.3
	
	
	
	;Give a random color to our player.
	p\r = Rand(255)
	p\g = Rand(255)
	p\b = Rand(255)
	EntityColor p\mesh,p\r,p\g,p\b
	
	r=p\r
	g=p\g
	b=p\b
	;create arms &amp; hands.,
	upperArmLeft = CreateSphere(8,p\mesh):EntityColor upperArmLeft,150,150,150 ; ,r,g,b
	PositionEntity upperArmLeft ,0.9,0.2,.2
	RotateEntity upperArmLeft ,0,0,20
	ScaleEntity upperArmLeft ,0.2,0.4,0.2
	
	lowerArmLeft = CreateSphere(8,p\mesh):EntityColor lowerArmLeft,150,150,150 ; ,r,g,b
	PositionEntity lowerArmLeft ,0.9,-.1,.45
	RotateEntity lowerArmLeft ,0,15,20
	ScaleEntity lowerArmLeft ,0.2,0.2,0.4
	
	handLeft = CreateSphere(8,p\mesh):EntityColor handLeft,255,255,255
	PositionEntity handLeft ,.7,-.1,.7
	RotateEntity handLeft ,0,15,20
	ScaleEntity handLeft ,0.22,0.22,0.22



	upperArmRight = CreateSphere(8,p\mesh):EntityColor upperArmRight ,150,150,150
	PositionEntity upperArmRight ,-0.9,0.2,.2
	RotateEntity upperArmRight ,0,0,-20
	ScaleEntity upperArmRight ,0.2,0.4,0.2
	
	lowerArmRight = CreateSphere(8,p\mesh):EntityColor lowerArmRight ,150,150,150
	PositionEntity lowerArmRight ,-0.9,-.1,.45
	RotateEntity lowerArmRight ,0,-15,-20
	ScaleEntity lowerArmRight ,0.2,0.2,0.4
	
	handRight = CreateSphere(8,p\mesh):EntityColor handRight ,255,255,255
	PositionEntity handRight ,-.7,-.1,.7
	RotateEntity handRight ,0,15,-20
	ScaleEntity handRight ,0.22,0.22,0.22

	
	
	; create a simple gun..
	gunHandle = CreateCube(p\mesh):EntityColor gunHandle ,70,70,70
	PositionEntity gunHandle ,.6,-.2,1
	ScaleEntity gunHandle ,0.07,0.3,0.1
	RotateEntity gunHandle ,0,20,20
	
	gun = CreateCube(p\mesh):EntityColor gun,70,70,70
	PositionEntity gun,.5,.2,1
	ScaleEntity gun ,0.07,.12,0.7
	RotateEntity gun ,0,20,20
	
	
	
	EntityType p\mesh,2
	;EntityRadius p\mesh,1.2,1.0
	EntityRadius p\mesh,1.0

	
	;start at one of our random spawn positions.
	RandomSpawn(p\id)	
	
	
	Return p\mesh
	
End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function SpawnPlayer(id,spawnId)
	
	p.player = Object.player(GetPlayer(id))
	
	For s.spawn = Each spawn
		If s\spawnId = spawnId Then Exit
	Next
	
	p\life = 80 ;start off slightly unhealthy..
	
	p\nextX = s\x
	p\nextY = s\y
	p\nextZ = s\z
	p\nextYaw = s\yaw
	
	p\previousX = p\nextX
	p\previousY = p\nextY
	p\previousZ = p\nextZ
	p\previousYaw = p\nextYaw
	
	PositionEntity p\mesh,p\nextX,p\nextY,p\nextZ
	RotateEntity p\mesh,0,p\nextYaw,0
	ResetEntity p\mesh
	
	p\currentY = p\nextY
	
	p\previousTime = MilliSecs()
	p\nextTime = MilliSecs()+1
	
End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function RandomSpawn(id)
	
	p.player = Object.player(GetPlayer(id))
	
	; if we are server, spawn player at random location
	If localMode = 2
		randSpawn = Rand(1,spawns)
		SpawnPlayer(p\id,randSpawn)
		Net_SendMessage(9,randSpawn,p\id)
		Net_SendMessage(9,randSpawn,p\id,p\id)
	Else ; else default spawn = first spawn created
		SpawnPlayer(p\id,1)

	EndIf
	;is this heard on local and networked playerside?
	SoundVolume appearsnd, .2 
	appearchannel= PlaySound (appearsnd)
	
End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function CreateSpawn(x#,y#,z#,yaw#)
	
	spawns = spawns + 1
	
	s.spawn = New spawn
	s\spawnId = spawns
	s\x = x
	s\y = y
	s\z = z
	s\yaw = yaw
	
End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function GetPlayer(id)
	
	For p.player = Each player
		If p\id = id
			Return Handle(p)					
		EndIf
	Next
	
End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function DrawPlayersNames()
	
	For p.player = Each player
		If EntityVisible (p\mesh,camera)
			
			Color 255,255,255
			CameraProject(camera,EntityX(p\mesh),EntityY(p\mesh),EntityZ(p\mesh)) 	
			
			; only when not the host
			If p\id &lt;&gt; localID Then Text ProjectedX(),ProjectedY()-60,p\name,1,1 ; the more health, the brighter the color..
			
			Color 255,(255./100.)*p\life,(255./100.)*p\life ;?
			Text ProjectedX(),ProjectedY()-40,p\life,1,1
		EndIf
	Next
	
End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function DrawHealthItemStrengths()
	
	For h.health = Each health
		If EntityVisible (h\mesh,camera)
			Color 255,0,0
			CameraProject(camera,EntityX(h\mesh),EntityY(h\mesh),EntityZ(h\mesh)) 
			
			Color 255,(255./100.)*h\power,(255./100.)*h\power
			If MilliSecs() - h\pickupTime &gt; h\respawnDelay Then ;ShowEntity h\mesh only when it's spawn time has passed..
				Text ProjectedX(),ProjectedY()-35,h\power,1,1
			EndIf
		EndIf
	Next
	
End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function CreateBullet(id)
	; this will create a bullet
	
	p.player = Object.player(GetPlayer(id)) ; tie the shooter's id to the bullit..
	b.bullet = New bullet
	b\id = p\id
	
	b\mesh = CreateSphere(2)
	ScaleEntity b\mesh,0.2,0.2,0.2
	EntityColor b\mesh,255,255,0
	
	PositionEntity b\mesh,EntityX(p\mesh),EntityY(p\mesh),EntityZ(p\mesh)
	RotateEntity b\mesh,0,EntityYaw(p\mesh),0
	
	MoveEntity b\mesh,0,0,2 ; so can't hit own player little less easy..(no sure fix, as bullets do not have ownership on them)
	EntityType b\mesh,3
	EntityRadius b\mesh,0.2
	
	SoundVolume shoot, .5
	shootchannel = PlaySound (shoot) ;shooting sound is started.
	
	
	
	b\time = MilliSecs()
	
End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function UpdateBullets()
	
	For b.bullet = Each bullet
		
		MoveEntity b\mesh,0,0,1.5; increase speed so player can't outrun bullets and hit himself easily(unless someth weird happens..)
		
		If CountCollisions(b\mesh)
			
			If localMode = 2 ; so when is server. only the server compute bullets collision with player
				
				If GetEntityType(CollisionEntity(b\mesh,1)) = 2 
					
					touchedPlayer.player = Object.player(EntityName(CollisionEntity(b\mesh,1)))
					
					;selfhit detection..
					killerPlayer.player = Object.player(GetPlayer(b\id)) ; whodunnit? get id of player tied to bullit..
					If touchedPlayer.player &lt;&gt; killerPlayer.player
						touchedPlayer\life = touchedPlayer\life - 10 ; reduce health when hit.
					;Else
						;NewMessage( "Debugmsg: Player only hit himself, no loss though. ;-)" ) ; 
					EndIf
				
				
					If touchedPlayer\life &gt; 0 ; touched and still has health to spare..
						Net_SendMessage(5,touchedPlayer\life,touchedPlayer\id) ; notify 
						Net_SendMessage(5,touchedPlayer\life,touchedPlayer\id,touchedPlayer\id)
						hitchannel = PlaySound (hitsnd)
											
					Else ; killed (all out of health)
						boomchannel = PlaySound (boom) ;boom sound is started. 
							
						;killerPlayer.player = Object.player(GetPlayer(b\id)) ; redundant now..
						
						killerPlayer\kills = killerPlayer\kills + 1
						touchedPlayer\deaths = touchedPlayer\deaths + 1						
						
												
						Net_SendMessage(6,touchedPlayer\id,killerPlayer\id)
						Net_SendMessage(6,touchedPlayer\id,killerPlayer\id,killerPlayer\id)
						
						Net_SendMessage(7,killerPlayer\kills+"/"+killerPlayer\deaths,killerPlayer\id)
						Net_SendMessage(7,killerPlayer\kills+"/"+killerPlayer\deaths,killerPlayer\id,killerPlayer\Id)
						
						Net_SendMessage(7,touchedPlayer\kills+"/"+touchedPlayer\deaths,touchedPlayer\id)
						Net_SendMessage(7,touchedPlayer\kills+"/"+touchedPlayer\deaths,touchedPlayer\id,touchedPlayer\id)
						
						NewMessage(killerPlayer\name + " killed " + touchedPlayer\name)
						RandomSpawn(touchedPlayer\id)
											
 					
						;ResetPlayer(touchedPlayer\id) ;&lt;&lt;
					EndIf
						
					
				EndIf
				
			EndIf
			
			FreeEntity b\mesh
			Delete b
			
		ElseIf MilliSecs()-b\time &gt; 2000
			
			FreeEntity b\mesh
			Delete b
			
		EndIf
		
	Next
	
End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function CreateHealthItem(x#,y#,z#,power#,respawnDelay#)
	
	h.health = New health
	
	h\mesh = CreateMesh()
	
	h\power = power ; set item strength
	
	;h\respawnDelay = 10000
	h\respawnDelay = respawnDelay ; set according to valuableness(strength actually)..
	
	; create the object..
	mesh1 = CreateCube()
	mesh2 = CreateCube()
	
	ScaleMesh mesh1,.20,.5,.20
	ScaleMesh mesh2,.20,.5,.20:RotateMesh mesh2,90,0,0
	
	AddMesh(mesh1,h\mesh)
	AddMesh(mesh2,h\mesh)
	
	EntityColor h\mesh,255,0,0
	
	; if we are the host..
	If localMode = 2 Then EntityType h\mesh,4
	EntityRadius h\mesh,0.5
	
	PositionEntity h\mesh,x,y,z
	
	NameEntity h\mesh,Handle(h)

End Function




;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function UpdateHealthItems()
	
	For h.health = Each health
		
		TurnEntity h\mesh,0,-2,0
		
		If localMode = 2 And GetEntityType(h\mesh) &lt;&gt; 4
			EntityType h\mesh,4
			EntityRadius h\mesh,0.5
		EndIf
		
		If CountCollisions(h\mesh)
			
			If localMode = 2 ; only the server computes collision with player
				If GetEntityType(CollisionEntity(h\mesh,1)) = 2 ; a player collided
					
					touchedPlayer.player = Object.player(EntityName(CollisionEntity(h\mesh,1)))
					;
					;h\id=touchedPlayer\id
					;
					
					h\pickupTime = MilliSecs()
					HideEntity h\mesh
					h\visible = False
					ResetEntity h\mesh
					
					Net_SendMessage(8,Handle(h))
					
					If touchedPlayer\life &lt; 100 ; touched healthpowerup MAYBE REMOVE DUE TO REDUNDANCY!(See lines below)
						touchedPlayer\life = touchedPlayer\life + h\power ;add power of the healthitem to touched players life.

						If touchedPlayer\life &gt;100 Or touchedPlayer\life=100
							touchedPlayer\life = 100
							;
							NewMessage(touchedPlayer\name + " fully restored health! " ); &lt;&lt; on server only(so local)
							;PlaySound "revived"
							Net_SendMessage(81,touchedPlayer\id) ; notify non server players too.
							;
						EndIf
						
						Net_SendMessage(5,touchedPlayer\life,touchedPlayer\id)
						Net_SendMessage(5,touchedPlayer\life,touchedPlayer\id,touchedPlayer\id)
						pwrchannel = PlaySound (pwr) ; pwrup sound is started when collected. 
						
						;
					Else	
						pickupchannel = PlaySound (pickup) ; pickup sound is started when collected and already full.
						; notify other players here so can play sound too.
					EndIf
					
				EndIf
				
				; sound for non-localmode(so clients) here..
				
			EndIf
			
		EndIf
		
		If MilliSecs() - h\pickupTime &gt; h\respawnDelay And h\visible = False
			ShowEntity h\mesh ; show entity when spawn time passed,,
			If firsttimehealth=False
				pwrchannel = PlaySound (pwrappear) ; appear sound is started when h\mesh appears
			EndIf
			h\visible= True
		EndIf
	Next
	
End Function


;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;


;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function NewMessage(msg$)
	
	; this routine checks and updates the message buffer.
	messageOffset = messageOffset + 1
	
	If messageOffset &gt; messageDisplayNumber
		
		messageOffset = messageOffset - 1
		
		For i = 2 To messageDisplayNumber
			message(i-1) = message(i)		
		Next
		
		message(messageDisplayNumber) = msg
		
	Else
		
		message(messageOffset) = msg
		
	EndIf
	
End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function DrawMessages()
	
	; this routine does the actual on screen drawing of the chat..
	
	Color 255,255,255
	
	For i = 1 To messageOffset
		
		;Text 0,(i-1)*15,message(i)	
		
		; &lt;&lt;&lt; colored txt mod by Raster Ron
		loc = Instr (message(i), "",1)
		If loc &gt; 1 Then 
			colorMessage$ = Mid$(message(i), 1, Len(message(i)) - 7 ) 
			Hex$ = Right$(message(i),6)		 
			Set_Color_Hex(Hex$) 
			Text 0,(i-1)*15,colorMessage$ 
		Else  
			Color 255,255,255 
			Text 0,(i-1)*15,message(i) 
		End If	
		; &lt;&lt;&lt; End colored txt mod by Raster Ron
		
	Next
	
End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function UpdateChat()
	
	; this routine does the input check..
	key = GetKey()
	If key
		If key = 13 ;carriage return, so entered, msgline finished.
			If chatMessage &lt;&gt; localName + "&gt; " ; so msg is larger than the prompt.
				
				If Len(chatMessage) &gt; maxlinelength-(Len(localName)+2)  ; so exceeds max line length
					chatMessage = Left$(chatMessage,maxlinelength) ; so ignoring all surpassing max chars.
				EndIf	
				
				
				For i = Len(localName + "&gt; ") To Len(chatMessage) ;check all characters from afte name+promtsign to end of msg..
					If Mid(chatMessage,i,1) &lt;&gt; " " ; trap all spaces input, so no empty jibberish..
						
						
						; '/' commands..
						
						
						If Mid(chatMessage,i,1) = "/"  ; check for the command trigger '/' if so, go into command mode..
							
							;check 2nd part(command) &lt;&lt; later to be done from data statements holding all commands..
							If Mid(chatMessage,i+1,5) = "kick " ; if at $location name+promptsign+/+5 chars= "kick "
								playerToBeKickedName$ = Mid(chatMessage,i+6, Len(chatMessage) )    ;
						
								For p.player = Each player ; check each player
									If p\name = playerToBeKickedName$  ;so only if playername exists..
									
										If localMode = 2 ; only the host/server can kick/ban players..(ban not requires keeping a dbase).
											If playerToBeKickedName$ &lt;&gt; localName$ ; so host is not kicking himself.
												
												chatMessage=playerToBeKickedName$ + " has been kicked by host! "
												;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
												; &lt;&lt;&lt; colored txt mod by Raster Ron
												chatColor$ = RGB_To_TriHex(cR,cG,cB)
												chatMessage = chatMessage + "" + chatColor$
												;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
																					
												
												Net_SendMessage(1,chatMessage) ; send msg to all.
												Net_KickPlayer(playerToBeKickedName$) 
									
											Else 
												NewMessage( "-Selfkicking not allowed.. ") ; display msg.
											EndIf
											
										;ElseIf localMode = 3 ; moderator &lt;&lt; to be introduced into code stil..	
											;moderator commands go here.
												
										Else ; so  localMode &lt;&gt; 2 or 3 ;so no server/host or moderator..
											;Net_SendMessage(1,"") ; send msg to all.
											NewMessage( "-Kicking not allowed for non-admins.. ") ; display msg.
										EndIf
										;Exit
									EndIf
								Next
								
							; other commands..	list, changetype(only allowed by host, can create moderator), wizz(unlimited ammo/health etc).	
							ElseIf Mid(chatMessage,i+1,5) = "list" ; if at $location name+promptsign+/+5 chars= "list"
								
								NewMessage( "Players:" ) ; display msg.
								NewMessage( "--------" ) ; display msg.
								For p.player = Each player ; check each player
									lst=lst+1
									playerList$=lst + ". Name: " + p\name + " | ID: " +  p\id + " | Ping: " + p\ping 
									NewMessage( playerList$ ) ; display msg.
									
									;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
									; &lt;&lt;&lt; colored txt mod by Raster Ron
									;chatColor$ = RGB_To_TriHex(cR,cG,cB)
									;chatMessage = chatMessage + "" + chatColor$
									;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
									
								Next
								Lst=0
								; count players
								For n.net_client = Each net_client
									Lst = Lst + 1	
									CID = n\ID
									CName = n\name
									CIP=DottedIP$(n\IP)
									CPort= n\port			
									clientList$=Lst + ". Name: " + CName + " | ID: " +  CID+ " | Port: " + CPort + " | IP:   " + CIP  
									
									NewMessage( clientList$ ) ; display msg.
								Next
								
								
							ElseIf Mid(chatMessage,i+1,10) = "rapidfire" ; 
								enableRapidFire=1-enableRapidFire
								If enableRapidFire=True
									statusMsg$="Rapid Fire Enabled!" 
								Else
									statusMsg$="Rapid Fire Disabled!" 
								EndIf
								NewMessage( statusMsg$ ) ; display msg.
							EndIf
							
							
							
							
						Else ; so if not in command mode.
							;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
							; &lt;&lt;&lt; colored txt mod by Raster Ron
							chatColor$ = RGB_To_TriHex(cR,cG,cB)
							chatMessage = chatMessage + "" + chatColor$
							;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
					
							Net_SendMessage(1,chatMessage) ; send msg to all.
							NewMessage(chatMessage)        ; put in the msg buffer for display on screen.
											
						EndIf	; 
						
						Exit	
							
					EndIf ; trap all spaces input, so no empty jibberish..
				Next ;check all characters from afte name+promtsign to end of msg..
			EndIf ;chatMessage &lt;&gt; localName + "&gt; " 
			
			chatMessage = localName + "&gt; "
			chatMode = 0
			
			
		ElseIf key = 8 And Len(chatMessage) &gt; Len ( localName + "&gt; " ) ; backspace and msg length longer then..
			chatMessage = Left(chatMessage,Len(chatMessage)-1) ; reduce lenght of msg with 1.
			
		ElseIf key &gt; 31 And key &lt; 127 ; if msg is valid range between 'US'(unit separator) and 'DEL' , so from 'SPACE' to '~'
			chatMessage = chatMessage + Chr(key)
			
		EndIf ;key = 
	EndIf ;key
	
	Color 255,255,255
	Rect 0,GraphicsHeight()-20,GraphicsWidth(),20,1
	Color 0,0,0
	Rect 0,GraphicsHeight()-20,GraphicsWidth(),20,0
	
	
	If MilliSecs()-chatMillisecs &gt; 500
		chatCursor = Not chatCursor
		chatMillisecs = MilliSecs()
	EndIf
	
	If chatCursor
		Text 5,GraphicsHeight()-17,chatMessage + "|"
	Else
		Text 5,GraphicsHeight()-17,chatMessage
	EndIf
	
End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function DrawScoreTable()
	
	For p.player = Each player
		count = count + 1
	Next
	
	baseX = (GraphicsWidth()-350)/2
	baseY = (GraphicsHeight()-(35+20*count))/2
	
	Color 0,0,0
	Rect baseX,baseY,350,35+20*count,1
	
	Color 255,192,0
	Rect baseX,baseY,350,35+20*count,0
	
	Text baseX+10,baseY+10,"Player          Kills     Deaths     Ping"
	Line baseX,baseY+25,baseX+349,baseY+25
	
	For p.player = Each player
		
		Color 255,255,255
		If p\id = localID Then Color 255,100,100
		
		i = i + 1
		Text baseX+10,baseY+10+20*i,p\name
		Text baseX+157,baseY+10+20*i,p\kills,1,0
		Text baseX+240,baseY+10+20*i,p\deaths,1,0
		Text baseX+322,baseY+10+20*i,p\ping,1,0
	Next
	
End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function UpdateChaseCam(camera,player) ; thanks to jfk EO-11110 on bb forums for this function !
	PositionEntity camera,EntityX(player,1),EntityY(player,1),EntityZ(player,1)
	ResetEntity camera
	x#=EntityX(player)+Sin(-EntityYaw(player)+180)*x_dis#
	y#=EntityY(player)+y_dis#
	z#=EntityZ(player)+Cos(-EntityYaw(player)+180)*z_dis#
	obstacle=LinePick(EntityX(player),EntityY(player),EntityZ(player),(x-EntityX(player)),y_dis#,(z-EntityZ(player)),0.1)
	If obstacle=0
		new_x#=x
		new_y#=y
		new_z#=z
	Else
		new_x#=PickedX()
		new_y#=PickedY()
		new_z#=PickedZ()
	EndIf
	If bounce_cam=0
		PositionEntity camera,new_x,new_y,new_z
	Else
		x=old_x+((New_x-old_x)/bounce_div#)
		y=old_y+((New_y-old_y)/bounce_div#)
		z=old_z+((New_z-old_z)/bounce_div#)
		PositionEntity camera,x,y,z
	EndIf
	PointEntity camera,player
	TurnEntity camera,-20,0,0     ; if you want the player mesh more on the bottom of the screen
	old_x#=EntityX(camera)
	old_y#=EntityY(camera)
	old_z#=EntityZ(camera)
End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function CreateScene()
	
	texture = TextureCreate(128)
	
	ground = CreatePlane()
	EntityColor ground,150,150,150
	EntityTexture ground,texture
	
	cube = CreateCube():EntityColor cube,150,200,150
	ScaleEntity cube,5,5,5:PositionEntity cube,0,5,0
	EntityTexture cube,texture
	
	sphere = CreateSphere(16):EntityColor sphere,200,150,150
	ScaleEntity sphere,3,1,3:PositionEntity sphere,0,9.7,0
	
	platform = CreateCube():EntityColor platform,150,150,200
	ScaleEntity platform,3,1,10:PositionEntity platform,0,4.13,-13.15
	TurnEntity platform,-30,0,0
	EntityTexture platform,texture
	
	; spawn locations
	spawner1 = CreateSphere() :EntityColor spawner1 ,150,150,150;  &lt;&lt;&lt;&lt;
	ScaleEntity spawner1 ,2,3,2:PositionEntity spawner1 ,-20,.1,-20 ;&lt;&lt;&lt;&lt;
	EntityTexture spawner1 ,texture
	
	column= CreateCylinder()
	ScaleEntity column,2,3,2:PositionEntity column,20,.1,20 ;&lt;&lt;&lt;&lt;
	EntityTexture column,texture
	
	FreeTexture texture
	
	
	
	EntityType ground,1:EntityPickMode ground,2
	EntityType cube,1:EntityPickMode cube,2
	EntityType sphere,1:EntityPickMode sphere,2
	EntityType platform,1:EntityPickMode platform,2
	EntityType spawner1,1:EntityPickMode spawner1,2
	EntityType column,1:EntityPickMode column,2
	
	
	
	; setup light..
	light = CreateLight()
	TurnEntity light,30,70,0
	
	; create health upgrade items.	
	CreateHealthItem(0,1,-10,10, 10000) ; undenneath the ramp
	CreateHealthItem(0,3,-20,30, 30000) ; on the ramp
	CreateHealthItem(0,12,0,100, 50000) ; the one on top
	firsttimehealth=True
	
	;; COLLISIONS
	Collisions 2,1,2,3 ; player to scene
	Collisions 2,2,1,3 ; player to player
	
	Collisions 3,1,2,1 ; bullet to scene
	Collisions 3,2,1,1 ; bullet to player
	
	Collisions 2,4,1,2 ; player to health
	
End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function TextureCreate(size)
	texture = CreateTexture(size,size,9)
	SetBuffer TextureBuffer(texture)
	Color 255,255,255
	Rect 0,0,size,size,1
	Color 0,0,0
	Rect 0,0,size,size,0
	Line 0,0,size,size
	Line 0,size,size,0
	SetBuffer BackBuffer()
	Return texture
End Function


;======================================================================================
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function LoadSFX()
	;run = LoadSound ("sounds\gravel.wav")
	;wade = LoadSound ("sounds\water.wav")
	;SoundVolume run, 0
	;SoundVolume wade, 0
	;LoopSound run
	;LoopSound wade
	;runchannel = PlaySound (run)
	;wadechannel = PlaySound (wade)
;------------------------------
	
	shoot=LoadSound( "sounds\shoot.wav" ) ; shooting sound
	SoundVolume shoot, .5
	
	boom=LoadSound( "sounds\boom.wav" ) ; explosion sound
	SoundVolume boom, .8
	
	hitsnd=LoadSound( "sounds\bump1.wav" ) ; ugh sound
	SoundVolume hitsnd, .8
	
	
	deathsnd=LoadSound("sounds\" ) ; die sound
	
	appearsnd=LoadSound("sounds\XCMAKERS.WAV") ; player reappears sound
	
	
	pwrappear =  LoadSound( "sounds\mtruc.wav" ) ; healing item appear sound
	SoundVolume pwrappear , .8  
	
	pwr=LoadSound( "sounds\belltree.wav" ) ; healing sound
	SoundVolume pwr, .8  
	
	pickup=LoadSound( "sounds\click1.wav" ) ; pick up health sound
	SoundVolume pickup, .9  
	
	
	
	
	jumpsound=LoadSound( "sounds\boing.wav" ) ; jumping sound
	SoundVolume jumpsound, .9
	
	
;------------------------------	
	;bark = LoadSound("sounds\bark.wav")
	;SoundVolume bark, .5
	;barkChannel = PlaySound (bark) ;barking sound is started.
	
	;uh=LoadSound( "sounds\Asthma_Sound.wav_10720.wav" )
	;SoundVolume uh, .9
	
End Function

Function LoadMusic(files$)
	
;	bgmusic = LoadSound (files$)
;	SoundVolume bgmusic,.5 
;	LoopSound bgmusic
;	bgmusicChannel= PlaySound (bgmusic)
	
;	dangermusic = LoadSound ("Shadow Of The Beast - Aarbronsrevenge.mp3")
;   SoundVolume dangermusic,0
;   LoopSound dangermusic
;	dangermusicChannel= PlaySound(dangermusic)
	
End Function

Function DisplayKeyHelpTxt()
	xcor=30	
	Text GraphicsWidth/2+xcor*2, 10+ycor,"                *** Multiplayer Example Help ***               "
	Text GraphicsWidth/2+xcor*2, 20+ycor," ------------------------------------------------------------- " 
	Text GraphicsWidth/2+xcor*2, 35+ycor," Game Controls                          | In Chat mode         " 	
	Text GraphicsWidth/2+xcor*2, 50+ycor," ------------------------------------------------------------- " 	
	Text GraphicsWidth/2+xcor*2, 65+ycor," Move            : Cursor / WASD        | Command prefix :'/'  " 
	Text GraphicsWidth/2+xcor*2, 80+ycor," Jump            : Space  / Right mouse | e.g:                 "
	Text GraphicsWidth/2+xcor*2, 95+ycor," Shoot           : Ctrl   / Left  mouse | /kick &lt;playername&gt;   "  
	Text GraphicsWidth/2+xcor*2,110+ycor," ---------------------------------------| /list                "  
	Text GraphicsWidth/2+xcor*2,125+ycor," Score           : Tab                  |                      "
    Text GraphicsWidth/2+xcor*2,140+ycor," Focus (toggle)  : F                    | (Also to be used for "
	Text GraphicsWidth/2+xcor*2,155+ycor," Chat            : Enter                | cheats such as       "
	Text GraphicsWidth/2+xcor*2,170+ycor," Help(this text) : F1                   | 'rapidfire')         " 
	Text GraphicsWidth/2+xcor*2,185+ycor," Player color    : F2                   |                      " 	
	Text GraphicsWidth/2+xcor*2,200+ycor," Exit            : Esc                  |                      " 
	Text GraphicsWidth/2+xcor*2,215+ycor," ------------------------------------------------------------- " 
	
End Function</textarea> <br><br></td></tr></table><br>
<a name="1305311"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Guy Fawkes</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#198">[#198]</a></td></tr></table></td></tr><tr ><td class="posttext"> Glad to see you're actively still working on this, Nasher! =) I LOVE the enthusiasm! :)<br><br>~GF <br><br></td></tr></table><br>
<a name="1305397"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rick Nasher</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#199">[#199]</a></td></tr></table></td></tr><tr ><td class="posttext"> Absolutely. Slowly but surely. :-) <br><br></td></tr></table><br>
<a name="1306039"></a>

<a name="1306040"></a>

<a name="1306041"></a>

<a name="1306042"></a>

<a name="1306043"></a>

<a name="1306044"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rick Nasher</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#200">[#200]</a></td></tr></table></td></tr><tr ><td class="posttext"> UPDATE 12-05-2016:<br>V1.66.2 correctly displaying msg+snd.<br>V1.69.2:<br> -Added 2nd (and higher) ramp to fall and die from.<br> -F3=display current player coords.<br> -Exploring health loss when falling ability: back to v1, for too buggy.<br>V1.69.3:<br> -fixed bug where chat held onto keys that would turn into player controls after submit.e.g. space=jump.<br> -Temporary disabled health loss when falling ability.<br> -Changed death sound, fixed all sounds to play local and on networked players, added typwrittersounds for chat(only Local) and submit snd on network to attract attention. Only 1 audio bug remaining: producing hit sound while actually collecting an item or when player(client) gets introduced into game (unclear why).<br><br>KNOWN BUGS:<br> -producing hitsound while actually collecting health item or when player(client) gets introduced into game .<br> -when enabled 'health loss when falling ability' it works, but also kills the player when running down a ramp.<br><br><img src="http://i66.tinypic.com/ra6q9x.jpg"><br><br><textarea class=codebox name="code" wrap=OFF readonly="true" rows="15" cols="80">
; *** ROADMAP/HISTORY ***
;
; ADDED SO FAR: 
; -chattext colors matched to playercolors.
; -different health strengths and spawn times.
; -hide entities names when one player cannot see each other(so can play hide&amp;seek)..
; -different health item strengths, which are also displayed above the 
;  item and take time to become available again depending on strenght.
; -fixes to keybd input and window focus.
; -sound fx(quicky, needs more work).
;
; UPDATE 29-04-2016:
; -lock/unlock mse + hud.focus to window switch 'f'.
; -F1=help.
; -F2=change player color on the fly.
; -rapidfire toggle command.
; 
; UPDATE 12-05-2016:
; V1.66 fixed friendly fire bug.(no more shooting yourself in the foot, stommach or whatever :-)
; V1.66.2 correctly displaying msg+snd.
; V1.69.2:
; -Added 2nd (and higher) ramp to fall and die from.
; -F3=display current player coords.
; -Exploring health loss when falling ability: back to v1, for too buggy.
; V1.69.3:
; -fixed bug where chat held onto keys that would turn into player controls after submit.e.g. space=jump.
; -Temporary disabled health loss when falling ability.
; -Changed death sound, fixed all sounds to play local and on networked players, 
;  added typwrittersounds for chat(only Local) and submit snd on network to attract attention.
;  only 1 audio bug remaining: producing hit sound while actually collecting an item or when player(client)
;  gets introduced into game (unclear why).
;  
;
; TODO UPTO VERSION 2.0 (not nesacerrily in this order, all using procedural gfx, without ext libs/media, except sound):
; -delay timer for after death..reintroducing player into game.
; -test w gf, flanker or others. ;-) 
; -reduce life when fell off too high cliff(using if linepick&lt;&gt; and entity distance&lt;&gt;ground.
; -scorch marks on hit objects.
; -fps /tps switch.
; -weapon upgrades.
; -push each other ability.
; -'/' cheatmodes and additional commands.
; -flashlight  + day nightcycle.
; -add moving platforms demo code.
; -game music. playing more exited when near an enemy.
; -robo players with simple ai.
; -gui with saveable prefs.
; -simple animated chars.
; -ladder climbing/crouching.
; -walking, running and sounds to match.
; -superjump powerup.
; -schields.
; -teleportation.
; -weather conditions. 
;
; TODO FOR VERSION 3.0 (more advanced, incorporating media and ext libs):
; -move to stayne's level.
; -3d animated chars.
; -AlienBreed 3d characters?
; -Special effects, doors, etc.
; -Vehicals/terrian.
; -PhysX.
; -Shadows.

; KNOWN BUGS:
; -producing hit sound while actually collecting or when player(client) gets introduced into game .
; -when enabled 'health loss when falling ability' it works, but also kills the player when running down a ramp.
; 
SeedRnd MilliSecs()

Const gameLogicFPS = 60

Global enableFocus=True  ; lock mouse to screen and hide pointer 'f' key toggles locked/unlocked mode.
Global enableRapidFire=False  ; 'r' key toggles normal/rapidfire mode.

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
; first we include the KeyFix library
Include "KeyFix_Constants.bb"
; we now include the network library
Include "UDPNetwork_lib.bb"
; for converting RGB values to "Tri-Hex" stringc inlude hex8.
Include "Hex8.bb" ;&lt;&lt;&lt; Colored txt mod by Raster Ron 

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Global localID ; the id of the current local player. (figures..)

;original code..
;Global localName$ = Input("Enter your name : ")
;If localName = "" Then localName = "player" + Rand(100,999)

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;&lt;&lt; Enter through mod..(for ease of use)
Global localName$ = "", defaultName$ = "RCX" ; My own pre-defined username, so just need to press enter to save typing ;-) 
;change above username to your own liking.

Print "Change default name: '"+ defaultName$ +"' ?"
Choic$ = Input$("[Press [Y]es or [ENTER] for No: ")
If Choic$="y" Then ; so want to change..
	Cls:Locate 0,0
	Print "Type name &amp; press [ENTER] or"
	ChangeName$=Input$("just [ENTER] to autogenerate: ")
	If ChangeName$="" ; so pressed enter to autogen..
		localName = "player" + Rand(100,999)
	Else ; so entered a new name..
		localName$=ChangeName$
	EndIf
Else ; so entered without input.
	localName$ = defaultName$
EndIf
;&lt;&lt;
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Global localPlayerMesh , ground

Type player
	Field id
	Field name$
	Field ping
	Field ip
	
	Field life
	Field kills
	Field deaths
	
	Field mesh
	Field r,g,b
	
	Field nextX#,nextY#,nextZ#
	Field previousX#,previousY#,previousZ#
	Field nextYaw#
	Field previousYaw#
	Field nextTime
	Field previousTime
	
	Field lastPacket
	
	Field currentY#
	Field velocityY#
	
	Field jumped
	
End Type

Type bullet
	Field mesh
	Field angle#
	Field time
	Field id ; id of player who fired
End Type

Type health
	Field mesh
	Field pickupTime ; to store when was pickedup and can hide for a certain time set in 
	Field respawnDelay ; &lt; see above
	Field visible
	Field power ; to hold strength of upgrade
	;Field id ; id of player who collected
End Type

Type spawn
	Field spawnId
	Field x#,y#,z#
	Field yaw#
End Type

Global spawns ; number of spawn points
Global firsttimehealth=True
Global firsttime=True
Global falling=False, highFall=False, tooHighFall=False,maxReachedVelocityY#=0.0



;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
; Camera code from jfk EO-11110, thanks
Global bounce_cam=1 ;  smooth camera motion? (0/1)
Global bounce_div#=10.0 ; the higher, the more sluggish the camera will follow. Recc: 3.0 to 20.0
; some globals used by ChaseCam
Global old_x#,old_y#,old_z#
; desired distance between camera and player mesh
Global x_dis#=7.0,y_dis#=3,z_dis#=7.0,y_dis_or#=y_dis#


;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;

; network init ----------------------------------------;
Global localMode = Net_StartInput() ; bring the library "console" to connect

If localMode = 1 Or localMode = 2 ; 1 means we are client, 2 means we are server
	
	localID = Net_CreatePlayer(localName) ; this command inits the server or local client
	
	If localID = 0 ; error
		Net_StopNetwork() ; close the network properly
		RuntimeError("Failed to create player.")
	EndIf
	
	If localMode = 1 Then AppTitle("Client : " + localName + " (port:" + net_port + "/ ID=" + localID +" / IP= "+ net_ip+ ")                   [F1] = Help!")
	If localMode = 2 Then AppTitle("Server : " + localName + " (port:" + net_port + "/ ID=" + localID +" / IP= "+ net_ip+ ")                   [F1] = Help!")
	 
Else ; error
	Net_StopNetwork()
	RuntimeError("Failed to start game.")
EndIf
;------------------------------------------------------;
grphicsWidth = 640
grphicsHeight= 480
Graphics3D grphicsWidth ,grphicsHeight,32,2
SetBuffer BackBuffer()

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
; audio
Global musicOn=False, musiclevel#=.5, danger=False												 ;music 
Global bgmusic_vol#=.5, bgmusicChannel, bgmusic 
Global dangermusic_vol#=0, dangermusicChannel, dangermusic     		     			             ;music

Global wade_vol#, run_vol#, wadechannel, runchannel , shootchannel, boomchannel, pwrchannel	     ;player sfx
Global shoot, boom, uh, pwr, pwrappear, fullhealth, pickupnogo , pickupchannel ,jumpchannel, jumpsound , hitsnd, hitchannel   
Global deathsnd, appearsnd, typesnd,newlinesnd

;Game music
;If gamelevel=1 Then LoadMusic("spacepanic.mp3") ; load gamemusic
;If gamelevel=2 Then LoadMusic("Shadow Of The Beast - To The Castle.mp3") 
;(If entitydistance &lt; theshold then play "battle music").
;If musicOn=False     ; if music is off then turn off volume
;	musiclevel#=0
;EndIf

LoadSFX()


;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Global n_c=50
Dim cubes(n_c)

CreateScene()

;create spawn locations to randomly pick from, currently 3.
CreateSpawn(0,12,0,0) ;top of cube
;CreateSpawn(0.07,17,17,0) ;top of cube2
CreateSpawn( 20,10, 20, 45) ; hill1
CreateSpawn(-20,10,-20,-45) ; hill2


Global camera = CreateCamera()
CameraRange camera,0.1,1000

; create our own local player
localPlayerMesh = CreatePlayer(localID,localName)
old_x = EntityX(localPlayerMesh):old_y = EntityY(localPlayerMesh):old_z = EntityZ(localPlayerMesh) ; update camera position

; we send our color to the server
p.player = Object.player(GetPlayer(localID))
Net_SendMessage(3,p\r + "/" + p\g + "/" + p\b)
;Net_SendMessage(3,p\r + "/" + p\g + "/" + p\b)


; &lt;&lt;&lt; colored txt mod by Raster Ron..
;store colors for chattxt.
Global cR = p\r 
Global cG = p\g 
Global cB = p\b 
; &lt;&lt;&lt; end colored txt mod by Raster Ron..


; variables used to send our positions at a constant delay (saves bandwidth but makes a constant ping)
Global updatePosition = MilliSecs()
Global updateTick = 50

; chat
Global maxlinelength% = 79
Global messageDisplayNumber = 10
Global messageOffset
Dim message$(messageDisplayNumber)

Global chatMode
Global chatMessage$ = localName + "&gt; "
Global chatMillisecs = MilliSecs()
Global chatCursor

.mainLoop
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
tweeningPeriod = 1000 / gameLogicFPS
tweeningTime = MilliSecs() - tweeningPeriod
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
While Not KeyHit(1)
	
	;; I use tweening from castle demo here :
	;;
	;; 		- this allows to have very fast execution outside the tweening loop,
	;; 		  so the network is updated as fast as possible (needs Flip False)
	;;
	;; 		- this makes the game logic updated at a constant rate (Const FPS=)
	;;		  so no need to set deltatime (and it saves CPU time for other things)
	
	
	;; -------------------------------------------------------------------------------------------------; FAST EXECUTION (outside of tweening)
	;; -------------------------------------------------------------------------------------------------;
	
	; see the function, the interpolation variables are set properly here
	UpdateNetwork()
	
	;; -------------------------------------------------------------------------------------------------;
	
	Repeat
		tweeningElapsed = MilliSecs() - tweeningTime
	Until tweeningElapsed
	tweeningTicks = tweeningElapsed / tweeningPeriod
	tweeningRate# = Float(tweeningElapsed Mod tweeningPeriod)/Float(tweeningPeriod)
	For k = 1 To tweeningTicks
		tweeningTime = tweeningTime + tweeningPeriod
		If k = tweeningTicks Then CaptureWorld
		
		;; ---------------------------------------------------------------------------------------------; MAIN UPDATE
		;; ---------------------------------------------------------------------------------------------;
		
		; update our player
		UpdateLocalPlayer() 
		
		; the interpolation is made in this function
		UpdatePlayers() ;network players and gravity
		
		UpdateWorld()
		
		; update the bullets... only the server checks for player kills
		UpdateBullets()
		
		UpdateHealthItems()
		UpdateChaseCam(camera,localPlayerMesh)
		;; ---------------------------------------------------------------------------------------------;
	Next
	
	RenderWorld tweeningRate
	
	;; -------------------------------------------------------------------------------------------------; 2D UPDATE
	
	DrawPlayersNames()
	DrawHealthItemStrengths()
	
	;; -------------------------------------------------------------------------------------------------;
	; Gereral input checks..
	If ( KeyHit ( 28 ) ) And chatMode = 0 Then chatMode = 1 : FlushKeys() ; Enter key for chat on/off
	If ( KeyHit ( 53 ) ) And chatMode = 0 Then chatMode = 1 ; / comnands &lt;&lt; will result in remembering prev input so not very good!
	If chatMode Then UpdateChat() 
	DrawMessages()
	
	If KeyDown(15) Then DrawScoreTable() ; Tab for scores
	
	If KeyDown(33) Then enableFocus=1-enableFocus : Delay 300 ; F key toggle focus locally.
	If enableFocus=False Then 
		ShowPointer 
	Else
		HidePointer
		MoveMouse(grphicsWidth/2, grphicsHeight/2)
	EndIf
	
	If KeyDown (59) Then ; F1 key for help locally .
		DisplayKeyHelpTxt()
	EndIf
	
	If KeyHit (60)  Then ; F2 change color of local player.
		;Give a random color to our player.
		p\r = Rand(255)
		p\g = Rand(255)
		p\b = Rand(255)
		EntityColor p\mesh,p\r,p\g,p\b
		;p.player = Object.player(GetPlayer(localID))
		Net_SendMessage(3,p\r + "/" + p\g + "/" + p\b) ; send new color to all players..
	EndIf
	
	
	If KeyHit(61) Then ; display player x,y,z (debug)
		NewMessage(" X= "+EntityX(p\mesh)+", Y= "+EntityY(p\mesh)+" ,Z= "+EntityZ(p\mesh))
	EndIf	
	;; -------------------------------------------------------------------------------------------------;
	
	Flip
	
Wend
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;

Net_StopNetwork()
End

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function UpdateNetwork()
	
	; update incoming packets (better check ALL incoming messages so use While Wend)
	While Net_CheckMessage() ; will check for a new message and fill Net_MsgType, Net_MsgString$, Net_MsgFrom and Net_MsgTo variables so we can read it
		
		p.player = Object.player(GetPlayer(Net_MsgFrom)) ; get the player handle
		
		If Handle(p) = 0 And Net_MsgType &lt; 100 ; we received an update packet from a player we don't know
			; so we ask the server who he is and return because we can't update him for now
			; the server will resend us the info in a new player "100" message
			Net_RequestPlayer(Net_MsgFrom)
			Return
		EndIf
		
		Select Net_MsgType ; check the type of message
				
			Case 1 ; chat message
				NewMessage(Net_MsgString)
				SoundVolume newlinesnd,.2
				PlaySound(newlinesnd)
				
				
			Case 2 ; player position and angle, example of packing data into string
				;unravel packed string data..
				offset1 = Instr(Net_MsgString,"/",1)
				offset2 = Instr(Net_MsgString,"/",offset1+1)
				offset3 = Instr(Net_MsgString,"/",offset2+1)
				offset4 = Instr(Net_MsgString,"/",offset3+1)
				;offset5 = Instr(Net_MsgString,"/",offset4+1)
				
				p\previousX = p\nextX
				p\previousY = p\nextY
				p\previousZ = p\nextZ
				p\previousYaw = p\nextYaw
				
				p\nextX =  Left(Net_MsgString,offset1-1)
				p\nextY =   Mid(Net_MsgString,offset1+1,offset2-offset1-1)
				p\nextZ =   Mid(Net_MsgString,offset2+1,offset3-offset2-1)
				p\nextYaw = Mid(Net_MsgString,offset3+1,offset4-offset3-1)
				
				;p\nextYaw = Right(Net_MsgString,Len(Net_MsgString)-offset3)
 
				
				p\previousTime = p\nextTime
				p\nextTime = MilliSecs()
				
			Case 21 ; so jump msg has been sent to notify other players so they too can play sound.
				SoundVolume jympsound, .2 ; lower volume as is further away(usually).
				PlaySound (jumpsound) 	
				
				
			Case 3 ; update player colors 
				offset1 = Instr(Net_MsgString,"/",1)
				offset2 = Instr(Net_MsgString,"/",offset1+1)
				
				p\r = Left(Net_MsgString,offset1-1)
				p\g = Mid(Net_MsgString,offset1+1,offset2-offset1-1)
				p\b = Right(Net_MsgString,Len(Net_MsgString)-offset2)
				
				EntityColor p\mesh,p\r,p\g,p\b
				;add bodyparts update here..
				
			Case 4 ; a player fired
				CreateBullet(Net_MsgFrom)
				
			Case 5 ; a player lost some life/health
				p\life = Net_MsgString ; update this players health
				SoundVolume hitsnd, .2
				PlaySound (hitsnd) ;currently disabled for creates unwanted hitsounds..dunno why yet, need to check..
				
			Case 6 ; a player killed another one ( and is out of life)
				k.player = Object.player(GetPlayer(Net_MsgString)) ; killed player ID in MsgData
				NewMessage(p\name + " killed " + k\name)
				SoundVolume deathsnd, .2 
				PlaySound (deathsnd) ;die sound is started. 
				Delay 100
				;ResetPlayer(k\id)
				
			Case 61 ; player died due to another reason
				;SoundVolume deathsnd, .2 
				;PlaySound (deathsnd) ;die sound is started. 
				;Delay 100
				
				
			Case 7 ; the server sends us score update for a player
				offset = Instr(Net_MsgString,"/",1)
				p\kills = Left(Net_MsgString,offset-1)
				p\deaths = Right(Net_MsgString,Len(Net_MsgString)-offset)
				
			Case 8 ; health pickup
				h.health = Object.health(Net_MsgString)
				HideEntity h\mesh
				h\pickupTime = MilliSecs()
				h\visible=False
				
			Case 81	
				SoundVolume pwr, .2 
				PlaySound (pwr) ; pwrup sound is started when collected.
				
			Case 82 ; fully restored health
				i.player = Object.player(GetPlayer(Net_MsgString)) ; killed player ID in MsgData
				NewMessage(i\name + " fully restored health!" ) ;&lt;&lt;&lt;
				SoundVolume fullhealth, .2 
				PlaySound (fullhealth)	
				
			Case 83 ; pickup health nogo(full already)	
				SoundVolume pickupnogo, .2 
				PlaySound (pickupnogo)
				
			Case 9 ; player spawn 
				SpawnPlayer(p\id,Net_MsgString)	
				; play reborn sound here?
				
				
				
				
				
				
				
					
				
			;Net managing stuff here..	
			Case 100 ; new player connected, OR the server tells us who is already connected so we can create players when joining the game..
				If localMode = 2 ; if = server..
					For p.player = Each player ;
						Net_SendMessage(2,p\nextX + "/" + p\nextY + "/" + p\nextZ + "/" + p\nextYaw,p\id,Net_MsgFrom)
						Net_SendMessage(3,p\r + "/" + p\g + "/" + p\b,p\id,Net_MsgFrom)
						
						Net_SendMessage(5,p\life,p\id,Net_MsgFrom)
						Net_SendMessage(7,p\kills+"/"+p\deaths,p\id,Net_MsgFrom)
					Next
				EndIf
				
				NewMessage(Net_MsgString + " connected")
				CreatePlayer(Net_MsgFrom,Net_MsgString)
				
			Case 101 ; a player has quit..
				For p.player = Each player
					If Net_MsgFrom = p\id
						NewMessage(p\name + " disconnected")
						FreeEntity p\mesh
						Delete p
					EndIf
				Next
				
			Case 102 ; host has changed..
				For p.player = Each player
					If Net_MsgFrom = p\id
						If p\id = localID
							AppTitle("Server : " + localName + " (port:" + net_port + ")")
							NewMessage("You are the new host")
							localMode = 2
						Else
							NewMessage(p\name + " is the new host")
						EndIf					
					EndIf
				Next
				
			Case 103 ; ping update..
				For p.player = Each player
					If Net_MsgFrom = p\id
						p\ping = Net_MsgString
					EndIf
				Next
				
		End Select
		
	Wend
	
End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function UpdateLocalPlayer()  
	
	; UPDATE LOCAL PLAYER..
	p.player = Object.player(GetPlayer(localID)) ; get our local player id..
	
	; check inputs.. 	(note: needs to be replaced by circular algorithm..)
	
	If Not chatMode
		; movements
		If WK_DOWN ( ) Or UP_KDOWN    ( ) Then MoveEntity p\mesh,0,0,0.3  ; up
		If SK_DOWN ( ) Or DOWN_KDOWN    ( ) Then MoveEntity p\mesh,0,0,-0.3 ; down
		If AK_DOWN ( ) Or LEFT_KDOWN  ( ) Then TurnEntity p\mesh,0,3,0    ; left
		If DK_DOWN ( ) Or RIGHT_KDOWN ( ) Then TurnEntity p\mesh,0,-3,0   ; right
	
		; jump
		If  ( KeyHit ( 57 ) ) Or ( MouseHit ( 2 ) )  ; right mse or Spacebar
			
			; check if player is on the ground
			LinePick(EntityX(p\mesh),EntityY(p\mesh),EntityZ(p\mesh),0,-1.2,0)
			;If PickedEntity() ;so if picked an entiry underneath so on some sort of ground/object..
			targetentity= PickedEntity()
			If targetentity&lt;&gt;0 ;so if picked an entiry underneath so on some sort of ground/object..
				p\velocityY = 0.5 ; set "inverse" of gravity velocity, so can jump.
				
				; play jump sound locally..
				SoundVolume jympsound, .5
				PlaySound (jumpsound) ;jump sound is started, but only for local player. (sound volume should be set here to medium)
				Net_SendMessage(21,"") ; notify other players a jump has taken place
				
			EndIf	
		EndIf
		
		
		; fire
		;If LM_DOWN ( )  ; left mouse down
		If enableRapidFire=True ; use keydown for keyscan..
			If ( KeyDown( 157 ) ) Or ( KeyDown( 29 ) )  Or ( MouseDown ( 1 ) ); left mouse down
				Net_SendMessage(4,"") ; notify other players a shot has been fired.
				CreateBullet(localID)
			EndIf
		Else ; use keyhit for keyscan..
			If ( KeyHit( 157 ) ) Or ( KeyHit( 29 ) )  Or ( MouseHit ( 1 ) ) ; left mouse hit
				Net_SendMessage(4,"") ; notify other players a shot has been fired.
				CreateBullet(localID)
			EndIf
		EndIf
		
		If KeyDown(19) Then enableRapidFire=1-enableRapidFire: Delay 300 ; R key, disabled and moved to chat commands.
		
	EndIf
	

	; we create a message Type "2" For player position..
	If MilliSecs()-updatePosition &gt; updateTick ; 
		; sent the position and jumpstatus over the network so other players can adjust/act accordingly..
		Net_SendMessage(2,EntityX(p\mesh) + "/" + EntityY(p\mesh) + "/" + EntityZ(p\mesh) + "/" + EntityYaw(p\mesh)+ "/" ) 
		updatePosition = MilliSecs()
	EndIf	
		
End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function UpdatePlayers()
	
	For p.player = Each player ; check all players..
	
		If p\id &lt;&gt; localID ; ; UPDATE NON LOCAL PLAYERS..
			;; LINEAR INTERPOLATION ;;;;;;;;;;
			If p\nextTime &lt;&gt; p\previousTime ; if both packets arrived at the same time, we can't interpolate
				curTime# = Float(MilliSecs()-p\nextTime) / Float(p\nextTime-p\previousTime) ; curTime will be ideally 0.0-1.0, if it's &gt; 1.0 then it performs extrapolation
				If curTime &gt; 1 Then curTime = 1 ; extrapolation gives anoying jittering effects
				; special fix for yaw as EntityYaw returns a value beetween +180 ans -180, the interpolation can go backward
				If p\previousYaw &lt; 0 Then p\previousYaw = p\previousYaw + 360
				If p\nextYaw &lt; 0 Then p\nextYaw = p\nextYaw + 360
				If Abs(p\nextYaw-p\previousYaw) &gt; 180
					If p\nextYaw &gt; p\previousYaw
						p\previousYaw = p\previousYaw + 360
					Else
						p\previousYaw = p\previousYaw - 360
					EndIf
				EndIf
				PositionEntity p\mesh,p\previousX+(p\nextX-p\previousX)*curTime,p\previousY+(p\nextY-p\previousY)*curTime,p\previousZ+(p\nextZ-p\previousZ)*curTime
				RotateEntity p\mesh,0,p\previousYaw+(p\nextYaw-p\previousYaw)*curTime,0
			Else
				PositionEntity p\mesh,p\nextX,p\nextY,p\nextZ
				RotateEntity p\mesh,0,p\nextYaw,0
			EndIf
			;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
			
		Else ; So if p\id = localID  thus update (local) player stuff. 
			 ; (Can't be combined with other local player stuff
			 ; for will somehow make jumping bit more laggy??)
			
			
			; basically below just computes gravity for local player. Actual positions will be updated across other player next loop. 
            ;[if done outside this loop(so at update local player) then jumping is more jurkey??]
			
			p\velocityY = p\velocityY - 0.03 ; increase fake gravity (wherever we are)by substracting every time when passing by in this loop.
			falling=True ;, gravity is always on.
			
			
			If EntityY(p\mesh) - p\currentY &gt;= 0 Then; but if player is not falling(or not anymore) for entity's Ypos-currentY do not differ.. 
			;	maxReachedVelocityY=p\velocityY ; we store maximumreached falling speed.
				
				If p\velocityY &lt; -0.03 Then p\velocityY = -0.03 ; we limit the gravity to normal values.
				falling=False
				
			;	If maxReachedVelocityY#&lt; -0.03 ; so when falling speed was higher then normal gravity.. 
			;		
			;		If maxReachedVelocityY# &lt;= (-0.66) And maxReachedVelocityY# &gt;= (-0.95) Then ;so if velocity between low to medium thresholds reduce life..
			;			p\life=p\life-Int((Abs(maxReachedVelocityY#))) ; reduce health/life with fallingspeed
			;			
			;			If p\life&gt;0 Then ;so when has life to spare..
			;				NewMessage(" Ouch! "+maxReachedVelocityY# +" , " + Int(Abs(maxReachedVelocityY#) )+ " , p\life: " + p\life );debug
			;				SoundVolume hitsnd, .8
			;				hitchannel = PlaySound (hitsnd)
			;				Net_SendMessage(5,p\id) ; notify non local players too, so they can adjust healthdisplay and play sound.
			;				
			;			ElseIf p\life&lt;= 0 ; so if no life to spare.. 
			;				NewMessage(" Aargh! "+maxReachedVelocityY# )
			;				SoundVolume deathsnd, .8
			;				hitchannel = PlaySound (deathsnd)
			;				RandomSpawn(p\id)
			;			EndIf	
			;			
			;			
			;		ElseIf maxReachedVelocityY# &lt;= (-0.96) Then ;die
			;			NewMessage(" Aargh! "+maxReachedVelocityY# )
			;			SoundVolume deathsnd, .8
			;			hitchannel = PlaySound (deathsnd)
			;			;NewMessage(p\name + " killed himself.. " )
			;			NewMessage(p\name + " Jumped of a too high cliff.. MaxvelocityY: "+maxReachedVelocityY# +" , int: " + Int(Abs(maxReachedVelocityY#) )+ " , p\life: " + p\life );debug 
			;			
			;			RandomSpawn(p\id)
			;		EndIf
			;		
			;		maxReachedVelocityY=p\velocityY
			;	EndIf	
				
				
				If highFall= True ; so previously fell from high object..
					; reduce lifestrength
					NewMessage(" Ouch!  Y= "+EntityY(p\mesh) )
					SoundVolume hitsnd, .8
					hitchannel = PlaySound (hitsnd)
					Net_SendMessage(5,p\id) ; notify non local players too, so they can adjust healthdisplay and play sound.
					highFall=False ;reset
				EndIf	
				If tooHighFall= True ; so previously fell from too high object..
					; reduce life to 0(our player didn't make it :-( 
					SoundVolume deathsnd, .8
					hitchannel = PlaySound (deathsnd)
					NewMessage(" Aargh dead!  Y= "+EntityY(p\mesh) )
					NewMessage(p\name + " Jumped of a too high cliff..  p\life: " + p\life );debug 
					tooHighFall=False ;reset
					RandomSpawn(p\id)
				EndIf	
			EndIf
			
			p\currentY = EntityY(p\mesh)
			TranslateEntity p\mesh,0,p\velocityY,0
			
			If falling = True
			;	NewMessage(" Fallling!  Y= "+EntityY(p\mesh) )
			;	If EntityY(p\mesh)&gt;15 And EntityY(p\mesh)&lt;26  Then highFall=True ; reduce life
			;	If EntityY(p\mesh)&gt;20 Then tooHighFall=True ; fatal
			EndIf
			
		EndIf
	Next
	
End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function CreatePlayer(id,name$)
	
	For p.player = Each player
		If p\id = id Then Return ; player already connected
	Next
	
	p.player = New player
	p\id = id
	p\name = name
	
	
	;build player entity
	p\mesh = CreateSphere()
	
	NameEntity p\mesh,Handle(p)
	
	nose = CreateSphere(8,p\mesh):EntityColor nose,255,0,0
	PositionEntity nose,0,0,1
	ScaleEntity nose,0.3,0.3,0.3
	
	eyeLeft = CreateSphere(8,p\mesh):EntityColor eyeLeft,255,255,255
	PositionEntity eyeLeft ,.29,.4,.7;1
	ScaleEntity eyeLeft ,0.2,0.2,0.2
	
	pupilLeft = CreateSphere(8,p\mesh):EntityColor pupilLeft ,0,0,0
	PositionEntity pupilLeft ,.3,.4,.9;1
	ScaleEntity pupilLeft ,0.05,0.05,0.02
	
	eyeRight = CreateSphere(8,p\mesh):EntityColor eyeRight ,255,255,255
	PositionEntity eyeRight ,-.29,.4,.7;1
	ScaleEntity eyeRight ,0.2,0.2,0.2
	
	pupilRight = CreateSphere(8,p\mesh):EntityColor pupilRight ,0,0,0
	PositionEntity pupilRight ,-.3,.4,.9;1
	ScaleEntity pupilRight ,0.05,0.05,0.02
	
	unaBrow = CreateCone(8,1,p\mesh):EntityColor unaBrow ,0,0,0
	PositionEntity unaBrow ,0,.45,.7
	RotateEntity unaBrow ,-180,0,0
	ScaleEntity unaBrow ,.7,.2,.3
	
	
	
	;Give a random color to our player.
	p\r = Rand(255)
	p\g = Rand(255)
	p\b = Rand(255)
	EntityColor p\mesh,p\r,p\g,p\b
	
	r=p\r
	g=p\g
	b=p\b
	;create arms &amp; hands.,
	upperArmLeft = CreateSphere(8,p\mesh):EntityColor upperArmLeft,150,150,150 ; ,r,g,b
	PositionEntity upperArmLeft ,0.9,0.2,.2
	RotateEntity upperArmLeft ,0,0,20
	ScaleEntity upperArmLeft ,0.2,0.4,0.2
	
	lowerArmLeft = CreateSphere(8,p\mesh):EntityColor lowerArmLeft,150,150,150 ; ,r,g,b
	PositionEntity lowerArmLeft ,0.9,-.1,.45
	RotateEntity lowerArmLeft ,0,15,20
	ScaleEntity lowerArmLeft ,0.2,0.2,0.4
	
	handLeft = CreateSphere(8,p\mesh):EntityColor handLeft,255,255,255
	PositionEntity handLeft ,.7,-.1,.7
	RotateEntity handLeft ,0,15,20
	ScaleEntity handLeft ,0.22,0.22,0.22



	upperArmRight = CreateSphere(8,p\mesh):EntityColor upperArmRight ,150,150,150
	PositionEntity upperArmRight ,-0.9,0.2,.2
	RotateEntity upperArmRight ,0,0,-20
	ScaleEntity upperArmRight ,0.2,0.4,0.2
	
	lowerArmRight = CreateSphere(8,p\mesh):EntityColor lowerArmRight ,150,150,150
	PositionEntity lowerArmRight ,-0.9,-.1,.45
	RotateEntity lowerArmRight ,0,-15,-20
	ScaleEntity lowerArmRight ,0.2,0.2,0.4
	
	handRight = CreateSphere(8,p\mesh):EntityColor handRight ,255,255,255
	PositionEntity handRight ,-.7,-.1,.7
	RotateEntity handRight ,0,15,-20
	ScaleEntity handRight ,0.22,0.22,0.22

	
	
	; create a simple gun..
	gunHandle = CreateCube(p\mesh):EntityColor gunHandle ,70,70,70
	PositionEntity gunHandle ,.6,-.2,1
	ScaleEntity gunHandle ,0.07,0.3,0.1
	RotateEntity gunHandle ,0,20,20
	
	gun = CreateCube(p\mesh):EntityColor gun,70,70,70
	PositionEntity gun,.5,.2,1
	ScaleEntity gun ,0.07,.12,0.7
	RotateEntity gun ,0,20,20
	
	
	
	EntityType p\mesh,2
	;EntityRadius p\mesh,1.2,1.0
	EntityRadius p\mesh,1.0

	
	;start at one of our random spawn positions.
	RandomSpawn(p\id)	
	
	
	Return p\mesh
	
End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function SpawnPlayer(id,spawnId)
	
	p.player = Object.player(GetPlayer(id))
	
	For s.spawn = Each spawn
		If s\spawnId = spawnId Then Exit
	Next
	
	p\life = 80 ;start off slightly unhealthy..
	
	p\nextX = s\x
	p\nextY = s\y
	p\nextZ = s\z
	p\nextYaw = s\yaw
	
	p\previousX = p\nextX
	p\previousY = p\nextY
	p\previousZ = p\nextZ
	p\previousYaw = p\nextYaw
	
	PositionEntity p\mesh,p\nextX,p\nextY,p\nextZ
	RotateEntity p\mesh,0,p\nextYaw,0
	ResetEntity p\mesh
	
	p\currentY = p\nextY
	
	p\previousTime = MilliSecs()
	p\nextTime = MilliSecs()+1
	;is this heard on local and networked playerside?
	SoundVolume appearsnd, .5
	PlaySound (appearsnd)
	
End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function RandomSpawn(id)
	
	p.player = Object.player(GetPlayer(id))
	
	; if we are the server, spawn player at random location
	If localMode = 2
		randSpawn = Rand(1,spawns)
		SpawnPlayer(p\id,randSpawn)
		Net_SendMessage(9,randSpawn,p\id)
		Net_SendMessage(9,randSpawn,p\id,p\id)
	Else ; else default spawn 
		SpawnPlayer(p\id,1)

	EndIf
	
End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function CreateSpawn(x#,y#,z#,yaw#)
	
	spawns = spawns + 1
	
	s.spawn = New spawn
	s\spawnId = spawns
	s\x = x
	s\y = y
	s\z = z
	s\yaw = yaw
	
End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function GetPlayer(id)
	; return the handle of the player stored in the field item\id
	
	For p.player = Each player
		If p\id = id
			Return Handle(p)					
		EndIf
	Next
	
End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function DrawPlayersNames()
	
	For p.player = Each player
		If EntityVisible (p\mesh,camera)
			
			Color 255,255,255
			CameraProject(camera,EntityX(p\mesh),EntityY(p\mesh),EntityZ(p\mesh)) 	
			
			
			If p\id &lt;&gt; localID Then Text ProjectedX(),ProjectedY()-60,p\name,1,1 ; only draw players name when not the localplayer
            ; the more health, the brighter the txt color..
			Color 255,(255./100.)*p\life,(255./100.)*p\life ;
			Text ProjectedX(),ProjectedY()-40,p\life,1,1
		EndIf
	Next
	
End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function DrawHealthItemStrengths()
	
	For h.health = Each health
		If EntityVisible (h\mesh,camera)
			Color 255,0,0
			CameraProject(camera,EntityX(h\mesh),EntityY(h\mesh),EntityZ(h\mesh)) 
			
			Color 255,(255./100.)*h\power,(255./100.)*h\power
			If MilliSecs() - h\pickupTime &gt; h\respawnDelay Then ;ShowEntity h\mesh only when it's spawn time has passed..
				Text ProjectedX(),ProjectedY()-35,h\power,1,1
			EndIf
		EndIf
	Next
	
End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function CreateBullet(id)
	; this will create a bullet
	
	p.player = Object.player(GetPlayer(id)) ; tie the shooter's id to the bullit..
	b.bullet = New bullet
	b\id = p\id
	
	b\mesh = CreateSphere(2)
	ScaleEntity b\mesh,0.2,0.2,0.2
	EntityColor b\mesh,255,255,0
	
	PositionEntity b\mesh,EntityX(p\mesh),EntityY(p\mesh),EntityZ(p\mesh)
	RotateEntity b\mesh,0,EntityYaw(p\mesh),0
	
	MoveEntity b\mesh,0,0,2 ; so can't hit own player or little less easy..(no sure fix)
	EntityType b\mesh,3
	EntityRadius b\mesh,0.2
	
	SoundVolume shoot, .5
	shootchannel = PlaySound (shoot) ;shooting sound is started.
	
	b\time = MilliSecs()
	
End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function UpdateBullets() 
	
	For b.bullet = Each bullet
		
		MoveEntity b\mesh,0,0,1.5 ; increase speed so player can't outrun bullets and hit himself easily(unless someth weird happens..)
		
		If CountCollisions(b\mesh)
			
			If localMode = 2 ; so when is server. only the server compute bullets collision with player
				
				If GetEntityType(CollisionEntity(b\mesh,1)) = 2 
					
					touchedPlayer.player = Object.player(EntityName(CollisionEntity(b\mesh,1)))
					
					;selfhit detection..
					killerPlayer.player = Object.player(GetPlayer(b\id)) ; whodunnit? get id of player tied to bullit..
					If touchedPlayer.player &lt;&gt; killerPlayer.player
						touchedPlayer\life = touchedPlayer\life - 10 ; reduce health when hit.
					;Else
						;NewMessage( "Debugmsg: Player only hit himself, no loss though. ;-)" ) ; 
					EndIf
				
				
					If touchedPlayer\life &gt; 0 ; touched and still has health to spare..
						Net_SendMessage(5,touchedPlayer\life,touchedPlayer\id) ; notify about life reduction
						Net_SendMessage(5,touchedPlayer\life,touchedPlayer\id,touchedPlayer\id)
						SoundVolume hitsnd, .8
						hitchannel = PlaySound (hitsnd)
											
					Else ; killed (all out of health)
						;boomchannel = PlaySound (boom) ;boom sound is started.
						SoundVolume deathsnd,.8
						PlaySound (deathsnd) ;die sound is started(local)
						Delay 100
						;killerPlayer.player = Object.player(GetPlayer(b\id)) ; redundant now..
						
						killerPlayer\kills = killerPlayer\kills + 1
						touchedPlayer\deaths = touchedPlayer\deaths + 1						
						
												
						Net_SendMessage(6,touchedPlayer\id,killerPlayer\id)  ;notify others that a player killed another one.
						Net_SendMessage(6,touchedPlayer\id,killerPlayer\id,killerPlayer\id)
						
						;send score update for a player
						Net_SendMessage(7,killerPlayer\kills+"/"+killerPlayer\deaths,killerPlayer\id) 
						Net_SendMessage(7,killerPlayer\kills+"/"+killerPlayer\deaths,killerPlayer\id,killerPlayer\Id)
						
						Net_SendMessage(7,touchedPlayer\kills+"/"+touchedPlayer\deaths,touchedPlayer\id)
						Net_SendMessage(7,touchedPlayer\kills+"/"+touchedPlayer\deaths,touchedPlayer\id,touchedPlayer\id)
						
						NewMessage(killerPlayer\name + " killed " + touchedPlayer\name)
						RandomSpawn(touchedPlayer\id)
											
 					
						;ResetPlayer(touchedPlayer\id) ;&lt;&lt;
					EndIf
						
					
				EndIf
				
			EndIf
			
			FreeEntity b\mesh
			Delete b
			
		ElseIf MilliSecs()-b\time &gt; 2000
			
			FreeEntity b\mesh
			Delete b
			
		EndIf
		
	Next
	
End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function CreateHealthItem(x#,y#,z#,power#,respawnDelay#)
	
	h.health = New health
	
	h\mesh = CreateMesh()
	
	h\power = power ; set item strength
	
	;h\respawnDelay = 10000
	h\respawnDelay = respawnDelay ; set according to valuableness(strength actually)..
	
	; create the object..
	mesh1 = CreateCube()
	mesh2 = CreateCube()
	
	ScaleMesh mesh1,.20,.5,.20
	ScaleMesh mesh2,.20,.5,.20:RotateMesh mesh2,90,0,0
	
	AddMesh(mesh1,h\mesh)
	AddMesh(mesh2,h\mesh)
	
	EntityColor h\mesh,255,0,0
	
	; if we are the host..
	If localMode = 2 Then EntityType h\mesh,4
	EntityRadius h\mesh,0.5
	
	PositionEntity h\mesh,x,y,z
	
	NameEntity h\mesh,Handle(h)

End Function




;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function UpdateHealthItems()
	
	For h.health = Each health
		
		TurnEntity h\mesh,0,-2,0
		
		If localMode = 2 And GetEntityType(h\mesh) &lt;&gt; 4
			EntityType h\mesh,4
			EntityRadius h\mesh,0.5
		EndIf
		
		If CountCollisions(h\mesh)
			
			If localMode = 2 ; only the server computes collision with player
				If GetEntityType(CollisionEntity(h\mesh,1)) = 2 ; a player collided
					
					touchedPlayer.player = Object.player(EntityName(CollisionEntity(h\mesh,1)))
					
					h\pickupTime = MilliSecs()
					HideEntity h\mesh
					h\visible = False
					ResetEntity h\mesh
					
					Net_SendMessage(8,Handle(h))  ; update health item?
					
					If touchedPlayer\life &lt; 100 ; touched healthpowerup and not fully charged..
						touchedPlayer\life = touchedPlayer\life + h\power ;add healthpowerup strenght of the healthitem to touched players life.
						Net_SendMessage(81,touchedPlayer\id) ; notify non local players too, so they can adjust healthdisplay and play sound.
						
						If touchedPlayer\life &gt;100 Or touchedPlayer\life=100
							touchedPlayer\life = 100;  so can't exceed 100%
							;
							NewMessage(touchedPlayer\name + " fully restored health! " ); &lt;&lt; on server only(so local)
							SoundVolume fullhealth,.2
							PlaySound (fullhealth)
							
							Net_SendMessage(82,touchedPlayer\id) ; notify non local players too, so they can adjust healthdisplay and play sound.
							
							
						EndIf
						
						Net_SendMessage(5,touchedPlayer\life,touchedPlayer\id)
						Net_SendMessage(5,touchedPlayer\life,touchedPlayer\id,touchedPlayer\id)
						pwrchannel = PlaySound (pwr) ; pwrup sound is started locally when collected. 
						
						;
					Else	
						pickupchannel = PlaySound (pickupnogo) ; pickup sound is started when collected and already full.
						; notify other players here so can play sound too?. - not interesting
						Net_SendMessage(83,touchedPlayer\id) ; notify non local players too, so they can adjust healthdisplay and play sound.
						
					EndIf
					
				EndIf
				
				; sound for non-localmode(so clients) here..
				
			EndIf
			
		EndIf
		
		If MilliSecs() - h\pickupTime &gt; h\respawnDelay And h\visible = False
			ShowEntity h\mesh ; show entity when spawn time passed,,
			If firsttimehealth=False
				pwrchannel = PlaySound (pwrappear) ; appear sound is started when h\mesh appears
			EndIf
			h\visible= True
		EndIf
	Next
	
End Function


;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;


;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function NewMessage(msg$)
	
	; this routine checks and updates the message buffer.
	messageOffset = messageOffset + 1
	
	If messageOffset &gt; messageDisplayNumber
		
		messageOffset = messageOffset - 1
		
		For i = 2 To messageDisplayNumber
			message(i-1) = message(i)		
		Next
		
		message(messageDisplayNumber) = msg
		
	Else
		
		message(messageOffset) = msg
		
	EndIf
	
End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function DrawMessages()
	
	; this routine does the actual on screen drawing of the chat..
	
	Color 255,255,255
	
	For i = 1 To messageOffset
		
		;Text 0,(i-1)*15,message(i)	
		
		; &lt;&lt;&lt; colored txt mod by Raster Ron
		loc = Instr (message(i), "",1)
		If loc &gt; 1 Then 
			colorMessage$ = Mid$(message(i), 1, Len(message(i)) - 7 ) 
			Hex$ = Right$(message(i),6)		 
			Set_Color_Hex(Hex$) 
			Text 0,(i-1)*15,colorMessage$ 
		Else  
			Color 255,255,255 
			Text 0,(i-1)*15,message(i) 
		End If	
		; &lt;&lt;&lt; End colored txt mod by Raster Ron
		
	Next
	
End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function UpdateChat()
	
	; this routine does the input check..
	key = GetKey()
	If key
		
		PlaySound(typesnd)
		If key = 13 ;carriage return, so entered, msgline finished.
			PlaySound(newlinesnd)
			; &lt;todo:  Also let other players here the ping snd to attract their attention.
			
			If chatMessage &lt;&gt; localName + "&gt; " ; so msg is larger than the prompt.
				
				If Len(chatMessage) &gt; maxlinelength-(Len(localName)+2)  ; so exceeds max line length
					chatMessage = Left$(chatMessage,maxlinelength) ; so ignoring all surpassing max chars.
				EndIf	
				
				
				For i = Len(localName + "&gt; ") To Len(chatMessage) ;check all characters from afte name+promtsign to end of msg..
					If Mid(chatMessage,i,1) &lt;&gt; " " ; trap all spaces input, so no empty jibberish..
						
						
						; '/' commands..
						
						
						If Mid(chatMessage,i,1) = "/"  ; check for the command trigger '/' if so, go into command mode..
							
							;check 2nd part(command) &lt;&lt; later to be done from data statements holding all commands..
							If Mid(chatMessage,i+1,5) = "kick " ; if at $location name+promptsign+/+5 chars= "kick "
								playerToBeKickedName$ = Mid(chatMessage,i+6, Len(chatMessage) )    ;
						
								For p.player = Each player ; check each player
									If p\name = playerToBeKickedName$  ;so only if playername exists..
									
										If localMode = 2 ; only the host/server can kick/ban players..(ban not requires keeping a dbase).
											If playerToBeKickedName$ &lt;&gt; localName$ ; so host is not kicking himself.
												
												chatMessage=playerToBeKickedName$ + " has been kicked by host! "
												;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
												; &lt;&lt;&lt; colored txt mod by Raster Ron
												chatColor$ = RGB_To_TriHex(cR,cG,cB)
												chatMessage = chatMessage + "" + chatColor$
												;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
																					
												
												Net_SendMessage(1,chatMessage) ; send msg to all.
												Net_KickPlayer(playerToBeKickedName$) 
									
											Else 
												NewMessage( "-Selfkicking not allowed.. ") ; display msg.
											EndIf
											
										;ElseIf localMode = 3 ; moderator &lt;&lt; to be introduced into code stil..	
											;moderator commands go here.
												
										Else ; so  localMode &lt;&gt; 2 or 3 ;so no server/host or moderator..
											;Net_SendMessage(1,"") ; send msg to all.
											NewMessage( "-Kicking not allowed for non-admins.. ") ; display msg.
										EndIf
										;Exit
									EndIf
								Next
								
							; other commands..	list, changetype(only allowed by host, can create moderator), wizz(unlimited ammo/health etc).	
							ElseIf Mid(chatMessage,i+1,5) = "list" ; if at $location name+promptsign+/+5 chars= "list"
								
								NewMessage( "Players:" ) ; display msg.
								NewMessage( "--------" ) ; display msg.
								For p.player = Each player ; check each player
									lst=lst+1
									playerList$=lst + ". Name: " + p\name + " | ID: " +  p\id + " | Ping: " + p\ping 
									NewMessage( playerList$ ) ; display msg.
									
									;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
									; &lt;&lt;&lt; colored txt mod by Raster Ron
									;chatColor$ = RGB_To_TriHex(cR,cG,cB)
									;chatMessage = chatMessage + "" + chatColor$
									;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
									
								Next
								Lst=0
								; count players
								For n.net_client = Each net_client
									Lst = Lst + 1	
									CID = n\ID
									CName = n\name
									CIP=DottedIP$(n\IP)
									CPort= n\port			
									clientList$=Lst + ". Name: " + CName + " | ID: " +  CID+ " | Port: " + CPort + " | IP:   " + CIP  
									
									NewMessage( clientList$ ) ; display msg.
								Next
								
								
							ElseIf Mid(chatMessage,i+1,10) = "rapidfire" ; 
								enableRapidFire=1-enableRapidFire
								If enableRapidFire=True
									statusMsg$="Rapid Fire Enabled!" 
								Else
									statusMsg$="Rapid Fire Disabled!" 
								EndIf
								NewMessage( statusMsg$ ) ; display msg.
							EndIf
							
							
							
							
						Else ; so if not in command mode.
							;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
							; &lt;&lt;&lt; colored txt mod by Raster Ron
							chatColor$ = RGB_To_TriHex(cR,cG,cB)
							chatMessage = chatMessage + "" + chatColor$
							;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
					
							Net_SendMessage(1,chatMessage) ; send msg to all.
							NewMessage(chatMessage)        ; put in the msg buffer for display on screen.
											
						EndIf	; 
						
						Exit	
							
					EndIf ; trap all spaces input, so no empty jibberish..
				Next ;check all characters from afte name+promtsign to end of msg..
			EndIf ;chatMessage &lt;&gt; localName + "&gt; " 
			
			chatMessage = localName + "&gt; "
			chatMode = 0
			
			
		ElseIf key = 8 And Len(chatMessage) &gt; Len ( localName + "&gt; " ) ; backspace and msg length longer then..
			chatMessage = Left(chatMessage,Len(chatMessage)-1) ; reduce lenght of msg with 1.
			
		ElseIf key &gt; 31 And key &lt; 127 ; if msg is valid range between 'US'(unit separator) and 'DEL' , so from 'SPACE' to '~'
			chatMessage = chatMessage + Chr(key)
			
		EndIf ;key = 
	EndIf ;key
	
	Color 255,255,255
	Rect 0,GraphicsHeight()-20,GraphicsWidth(),20,1
	Color 0,0,0
	Rect 0,GraphicsHeight()-20,GraphicsWidth(),20,0
	
	
	If MilliSecs()-chatMillisecs &gt; 500
		chatCursor = Not chatCursor
		chatMillisecs = MilliSecs()
	EndIf
	
	If chatCursor
		Text 5,GraphicsHeight()-17,chatMessage + "|"
	Else
		Text 5,GraphicsHeight()-17,chatMessage
	EndIf
	FlushKeys ; prevent space etc to be tranfered to the game, makingh player jump etc.
End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function DrawScoreTable()
	
	For p.player = Each player
		count = count + 1
	Next
	
	baseX = (GraphicsWidth()-350)/2
	baseY = (GraphicsHeight()-(35+20*count))/2
	
	Color 0,0,0
	Rect baseX,baseY,350,35+20*count,1
	
	Color 255,192,0
	Rect baseX,baseY,350,35+20*count,0
	
	Text baseX+10,baseY+10,"Player          Kills     Deaths     Ping"
	Line baseX,baseY+25,baseX+349,baseY+25
	
	For p.player = Each player
		
		Color 255,255,255
		If p\id = localID Then Color 255,100,100
		
		i = i + 1
		Text baseX+10,baseY+10+20*i,p\name
		Text baseX+157,baseY+10+20*i,p\kills,1,0
		Text baseX+240,baseY+10+20*i,p\deaths,1,0
		Text baseX+322,baseY+10+20*i,p\ping,1,0
	Next
	
End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function UpdateChaseCam(camera,player) ; thanks to jfk EO-11110 on bb forums for this function !
	PositionEntity camera,EntityX(player,1),EntityY(player,1),EntityZ(player,1)
	ResetEntity camera
	x#=EntityX(player)+Sin(-EntityYaw(player)+180)*x_dis#
	y#=EntityY(player)+y_dis#
	z#=EntityZ(player)+Cos(-EntityYaw(player)+180)*z_dis#
	obstacle=LinePick(EntityX(player),EntityY(player),EntityZ(player),(x-EntityX(player)),y_dis#,(z-EntityZ(player)),0.1)
	If obstacle=0
		new_x#=x
		new_y#=y
		new_z#=z
	Else
		new_x#=PickedX()
		new_y#=PickedY()
		new_z#=PickedZ()
	EndIf
	If bounce_cam=0
		PositionEntity camera,new_x,new_y,new_z
	Else
		x=old_x+((New_x-old_x)/bounce_div#)
		y=old_y+((New_y-old_y)/bounce_div#)
		z=old_z+((New_z-old_z)/bounce_div#)
		PositionEntity camera,x,y,z
	EndIf
	PointEntity camera,player
	TurnEntity camera,-20,0,0     ; if you want the player mesh more on the bottom of the screen
	old_x#=EntityX(camera)
	old_y#=EntityY(camera)
	old_z#=EntityZ(camera)
End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function CreateScene()
	
	texture = TextureCreate(128)
	
	ground = CreatePlane()
	EntityColor ground,150,150,150
	EntityTexture ground,texture
	
	
	;cube with ramp and rounded top.
	cube = CreateCube():EntityColor cube,150,200,150
	ScaleEntity cube,5,5,5:PositionEntity cube,0,5,0
	EntityTexture cube,texture
	
	sphere = CreateSphere(16):EntityColor sphere,200,150,150
	ScaleEntity sphere,3,1,3:PositionEntity sphere,0,9.7,0
	
	platform = CreateCube():EntityColor platform,150,150,200
	ScaleEntity platform,3,1,10:PositionEntity platform,0,4.13,-13.15
	TurnEntity platform,-30,0,0
	EntityTexture platform,texture
	
	
	
	;cube2 with ramp and rounded top.
	cube2 = CreateCube():EntityColor cube2,150,150,200
	ScaleEntity cube2,5,8,5:PositionEntity cube2,0,8,17
	EntityTexture cube2,texture
	
	sphere2 = CreateSphere(16):EntityColor sphere2,150,200,200
	ScaleEntity sphere2,3,1,3:PositionEntity sphere2,0,15.5,17
	
	platform2 = CreateCube():EntityColor platform2,150,200,150
	ScaleEntity platform2,3,1,16:PositionEntity platform2,0,7.15,-19.55+54.9
	TurnEntity platform2,-30,180,0
	EntityTexture platform2,texture
	
	
	
	; spawn locations
	spawner1 = CreateSphere() :EntityColor spawner1 ,150,150,150;  &lt;&lt;&lt;&lt;
	ScaleEntity spawner1 ,2,3,2:PositionEntity spawner1 ,-20,.1,-20 ;&lt;&lt;&lt;&lt;
	EntityTexture spawner1 ,texture
	
	column= CreateCylinder()
	ScaleEntity column,2,3,2:PositionEntity column,20,.1,20 ;&lt;&lt;&lt;&lt;
	EntityTexture column,texture
	
	FreeTexture texture
	
	
	; some test walls. ;
	; PLEASE NOTE: extreme low poly objects like big cubes don't work well with
	; directX point lights: the light simply doesn't get enough vertices to obtain a good "grip" on the
	; normals. To illustrate this you may use the CreateCube command instead (see a few lines below).
	;Global n_c=10
	;Dim cubes(n_c)
	;polys=10
	;For i=0 To n_c
	;	cubes(i)=CreateSphere(polys)
	;	PositionEntity cubes(i), Rnd(-100,100),0,Rnd(-100,200)
	;	ScaleEntity cubes(i),1,10,Rand(4,10)
	;	RotateEntity cubes(i),0,Rand(360),0
	;	EntityColor cubes(i),Rand(255),Rand(255),Rand(255)
	;	EntityPickMode cubes(i),2
	;	UpdateNormals cubes(i)
	;	EntityType cubes(i),type_world
	;Next
	
	
	;polys=10
    ;length = 50;
    ;angle = 0.0;
    ;angle_stepsize = 360/n_c;
	;For i= 0 To n_c/2 
	;	
	;    x = length * Cos (angle);
    ;    z = length * Sin (angle);
	;	cubes(i)=CreateSphere(polys)
	;	PositionEntity cubes(i), x+Rnd(-100,100),0,z+Rnd(-100,100)
	;	
	;   ScaleEntity cubes(i),1,10,Rand(4,10)
	;	RotateEntity cubes(i),0,Rand(360),0
	;	EntityColor cubes(i),Rand(255),Rand(255),Rand(255)
	;	EntityPickMode cubes(i),2
	;	UpdateNormals cubes(i)
	;	EntityType cubes(i),1
	;
	;angle = angle+ angle_stepsize;
	;Next
	
	
		
	
	; Collision types &amp; pick mode definitions..
	EntityType ground,1:EntityPickMode ground,2
	EntityType cube,1:EntityPickMode cube,2
	EntityType sphere,1:EntityPickMode sphere,2
	EntityType platform,1:EntityPickMode platform,2
	
	EntityType cube2,1:EntityPickMode cube2,2
	EntityType sphere2,1:EntityPickMode sphere2,2
	EntityType platform2,1:EntityPickMode platform2,2
	
	
	EntityType spawner1,1:EntityPickMode spawner1,2
	EntityType column,1:EntityPickMode column,2
	
	
	
	; setup light..
	light = CreateLight()
	TurnEntity light,30,70,0
	
	; create health upgrade items.
	
	CreateHealthItem(0     ,1  ,-10  ,10 , 10000) ; undenneath the ramp
	CreateHealthItem(0     ,3  ,-20  ,30 , 30000) ; on the ramp
   ;CreateHealthItem(0     ,12 ,0    ,100, 50000) ; the one on top
	CreateHealthItem(0.07  ,17 ,17   ,100, 50000) ; top of cube2
	firsttimehealth=True
	
	;; COLLISIONS
	Collisions 2,1,2,3 ; player to scene
	Collisions 2,2,1,3 ; player to player
	
	Collisions 3,1,2,1 ; bullet to scene
	Collisions 3,2,1,1 ; bullet to player
	
	Collisions 2,4,1,2 ; player to health
	
End Function

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function TextureCreate(size)
	texture = CreateTexture(size,size,9)
	SetBuffer TextureBuffer(texture)
	Color 255,255,255
	Rect 0,0,size,size,1
	Color 0,0,0
	Rect 0,0,size,size,0
	Line 0,0,size,size
	Line 0,size,size,0
	SetBuffer BackBuffer()
	Return texture
End Function


;======================================================================================
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Function LoadSFX()
	
	
	
	; movements
	;------------------------------
	;run = LoadSound ("sounds\gravel.wav")
	;wade = LoadSound ("sounds\water.wav")
	;SoundVolume run, 0
	;SoundVolume wade, 0
	;LoopSound run
	;LoopSound wade
	;runchannel = PlaySound (run)
	;wadechannel = PlaySound (wade)
	
	;divesnd=LoadSound( "sounds\Asthma_Sound.wav_10720.wav" ) ; diving (uh) sound
	;SoundVolume uh, .9
	
	
	jumpsound=LoadSound( "sounds\boing.wav" ) ; jumping (oink)sound
	SoundVolume jumpsound, .9	
	
	
	; health
	;------------------------------	
	hitsnd=LoadSound( "sounds\bump1.wav" )     ; hit (ugh) sound
	SoundVolume hitsnd, .8
	
	;deathsnd=LoadSound("sounds\CUICA1.WAV" )   ; die (woehh) sound
	deathsnd=LoadSound("sounds\deathmod.wav" )  ; die sound
	
	appearsnd=LoadSound("sounds\XCMAKERS.WAV") ; player(haoooh) reappears sound
	
	
	; items
	;------------------------------	
	
	pickupnogo=LoadSound( "sounds\click1.wav" ) ; pick up nogo health(doorclank) sound
	SoundVolume pickupnogo, .9  
	
	
	; health
	;------------------------------	
	pwrappear =  LoadSound( "sounds\mtruc.wav" ) ; healing item appear(ploc) sound
	SoundVolume pwrappear , .8  
	
	pwr=LoadSound( "sounds\belltree.wav" )       ; healing (triiing) sound
	SoundVolume pwr, .8  
	
	fullhealth=LoadSound ( "sounds\happy.wav" )  ; fullhealthrestored sound
	SoundVolume pwr, .8 
	
	
	
	
	; weaponary
	;------------------------------
	
	shoot=LoadSound( "sounds\shoot.wav" ) ; shooting(laser) sound
	SoundVolume shoot, .5
	
	boom=LoadSound( "sounds\boom.wav" ) ; explosion sound
	SoundVolume boom, .8
	
	; enemies 
	;------------------------------	
	;bark = LoadSound("sounds\bark.wav")
	;SoundVolume bark, .5
	;barkChannel = PlaySound (bark) ;barking sound is started.
	
	
	typesnd= LoadSound("sounds\gui_type.wav")
	SoundVolume typesnd, .8 
	newlinesnd=LoadSound("sounds\typewriterbell.wav")
	SoundVolume newlinesnd, .8 
	
End Function

Function LoadMusic(files$)
	
;	bgmusic = LoadSound (files$)
;	SoundVolume bgmusic,.5 
;	LoopSound bgmusic
;	bgmusicChannel= PlaySound (bgmusic)
	
;	dangermusic = LoadSound ("Shadow Of The Beast - Aarbronsrevenge.mp3")
;   SoundVolume dangermusic,0
;   LoopSound dangermusic
;	dangermusicChannel= PlaySound(dangermusic)
	
End Function

Function DisplayKeyHelpTxt()
	xcor=30	
	Text GraphicsWidth/2+xcor*2, 10+ycor,"                *** Multiplayer Example Help ***               "
	Text GraphicsWidth/2+xcor*2, 20+ycor," ------------------------------------------------------------- " 
	Text GraphicsWidth/2+xcor*2, 35+ycor," Game Controls                          | In Chat mode         " 	
	Text GraphicsWidth/2+xcor*2, 50+ycor," ------------------------------------------------------------- " 	
	Text GraphicsWidth/2+xcor*2, 65+ycor," Move            : Cursor / WASD        | Command prefix :'/'  " 
	Text GraphicsWidth/2+xcor*2, 80+ycor," Jump            : Space  / Right mouse | e.g:                 "
	Text GraphicsWidth/2+xcor*2, 95+ycor," Shoot           : Ctrl   / Left  mouse | /kick &lt;playername&gt;   "  
	Text GraphicsWidth/2+xcor*2,110+ycor," ---------------------------------------| /list                "  
	Text GraphicsWidth/2+xcor*2,125+ycor," Score           : Tab                  |                      "
    Text GraphicsWidth/2+xcor*2,140+ycor," Focus (toggle)  : F                    | (Also to be used for "
	Text GraphicsWidth/2+xcor*2,155+ycor," Chat            : Enter                | cheats such as       "
	Text GraphicsWidth/2+xcor*2,170+ycor," Help(this text) : F1                   | 'rapidfire')         " 
	Text GraphicsWidth/2+xcor*2,185+ycor," Player color    : F2                   |                      " 
	Text GraphicsWidth/2+xcor*2,200+ycor," Player x,y,z    : F3                   |                      " 	
	Text GraphicsWidth/2+xcor*2,215+ycor," Exit            : Esc                  |                      " 
	Text GraphicsWidth/2+xcor*2,230+ycor," ------------------------------------------------------------- " 
	
End Function
</textarea><br>Code &amp; sounds(changed) <a href="http://www.mediafire.com/download/8a9vcx439eqaedw/V1.12_-_Share_12-05-2016.rar" target="_blank"><b>&gt;Here&lt;</b></a> <br><br></td></tr></table><br>
<a name="1306100"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >RustyKristi</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#201">[#201]</a></td></tr></table></td></tr><tr ><td class="posttext"> hey Rick Nasher, I was wondering how would you make the EntityRadius bigger so that it won't pass through the ground and fall endlessly. Currently it is set to 1 and would like to resize it. thanks.<br><br>Really great job you guys have done here! <br><br></td></tr></table><br>
<a name="1306148"></a>

<a name="1306152"></a>

<a name="1306159"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rick Nasher</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#202">[#202]</a></td></tr></table></td></tr><tr ><td class="posttext"> @RustiKristi<br>Moved here: <a href="http://www.blitzbasic.com/Community/posts.php?topic=104840#1306157" target="_blank">http://www.blitzbasic.com/Community/posts.php?topic=104840#1306157</a><br>For this is actually Flanker's thread. <br><br></td></tr></table><br>
<a name="1306228"></a>

<a name="1306469"></a>

<a name="1306470"></a>

<a name="1306517"></a>

<a name="1308745"></a>

<a name="1308746"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rick Nasher</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#203">[#203]</a></td></tr></table></td></tr><tr ><td class="posttext"> EDIT:<br>Jumping of a too high cliff will now get you killed if not landing on something else higher up and falling reduces life(health actually).<br>Player can push each other, player color changes when died and revive delay installed as well as teleporting.<br>Update <a href="/post.php?topic=104840&amp;post=1308742" target="_blank"><b>here</b></a> <br><br></td></tr></table><br>
<a name="bottom"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td align="right"><a href="http://monkeycoder.co.nz" target="_blank"><img src="/img/monkey2.svg" ></a> <a href="https://github.com/blitz-research" target="_blank"><img src="/img/github.svg" ></a> <a href="https://discord.gg/qJccbSp" target="_blank"><img src="/img/discord.svg" ></a></td></tr></table><br></div><br><table width="100%"><tr><td></body></html lang="en">
