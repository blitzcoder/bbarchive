<!DOCTYPE html><html lang="en" ><head ><title >LuGI - Lua Glue Generator &amp; Interface for BlitzMax</title><meta name='viewport' content='width=device-width, initial-scale=0.66'><meta name='description' content='language:basic, target:desktop, category:game development'><link rel="styleSheet" href="../skins/granite/style.css" type="text/css"><style type="text/css">div.bbcode {padding: 8px;background: #E5E5E5;color: #000000;border: 1px dashed #B4B4BE;}</style></head><body ><table width=100% cellspacing=0 cellpadding=0><tr ><td class="menubarleft"></td><td class="menubar"><table cellspacing="0" cellpadding="0"><tr ><td >&nbsp;</td><td class="menuitemleft"></td><td class="menuitem"><a href="/" class="menuitem">News</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/forums.php" class="menuitem">Forums</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/codearcs.php" class="menuitem">Code</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/logs.php" class="menuitem">Logs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/gallery.php" class="menuitem">Gallery</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/sdkspecs.php" class="menuitem">Specs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/search.php" class="menuitem">Search</a></td><td class="menuitemright"></td></tr></table></td><td class="menubarright"></td></tr></table><div class="main"><h1 >LuGI - Lua Glue Generator &amp; Interface for BlitzMax</h1><a href="forums.php" >Community Forums</a>/<a href="topics.php?forum=61" >Showcase</a>/<a href="#bottom" >LuGI - Lua Glue Generator &amp; Interface for BlitzMax</a><br><br>
<a name="972578"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >N</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#1">[#1]</a></td></tr></table></td></tr><tr ><td class="posttext"> <b><i><a href="http://github.com/nilium/lugi.mod" target="_blank">Get the LuGI Source Code</a></i></b><br><i>(For those of you without Git, just click the 'Download' button next to its name and you can grab either .tar.gz or .zip archives)</i><br><br><div class="quote"> <b>LuGI</b> - pronounced <i>loogie</i> - is a framework for building Lua glue code for BlitzMax, and provides much of the ground-work needed to get BlitzMax object support working quickly and painlessly in BlitzMax. The way LuGI does this is by firstly generating glue code for your project, and secondly by using its core API to expose that glue code in a manner that best mimics the way one would use the wrapped code in BlitzMax, thereby providing an almost seamless combination of BlitzMax and Lua.<br><br>The code is composed of a module for generating the required glue code to make use of LuGI and a very small core API: two functions to push objects and arrays, two functions to get objects and arrays, and an initialization function. The remainder of the API is hidden away by monks who cannot speak, for they have cut out their tongues. Incidentally, the API is also inside of a header file (lgcore.h) - however, the rest of the LuGI core code is strictly for those interested in writing their own code generators. <br></div><br>Alright, that roughly explains what LuGI is for and what it does.  LuGI is free and open-source under the MIT license.  You can use, modify, sell, etc. this code, and essentially do whatever you like with it, provided you follow the very simple terms of the license.<br><br>If you're not already familiar with <a href="http://www.lua.org/" target="_blank">Lua</a>, I'll quote their <a href="http://www.lua.org/about.html" target="_blank">about</a> page for you, which should explain it fairly simply:<br><div class="quote"> <i>Lua is a powerful, fast, lightweight, embeddable scripting language.</i><br><br>Lua combines simple procedural syntax with powerful data description constructs based on associative arrays and extensible semantics. Lua is dynamically typed, runs by interpreting bytecode for a register-based virtual machine, and has automatic memory management with incremental garbage collection, making it ideal for configuration, scripting, and rapid prototyping.  <br></div><i>(Emphasis mine)</i><br><br>There is already some <a href="http://wiki.github.com/nilium/lugi.mod" target="_blank">documentation in the wiki</a>, and I'll be working on improving that as I go along based on questions anyone might have about how to do something, how LuGI works, or what general rules there are for writing your own code generator.  The goal here is that by releasing it, I'll be able to get some feedback on what areas need improving, try to locate bugs, and all that general stuff you get when people use your code.<br><br>The entirety of the core is written in platform-independent (or it is as far as I can see) C++.  None of the 'complex' aspects of C++ are used, such as templates, metaprogramming, operator overloading, etc. just to keep things simple on the inside.  If you know C++ and something about Lua, chances are you can tweak it to your liking.  I may have also profusely commented the source, but I don't know how much that would help you.  The generator doesn't rely on knowing how the core works internally, so you can change almost anything you want in either the core or the generator and it should not affect how the other module works.  There are exceptions to this (e.g., the initialization routine), but pretty much anything in the core C++ is modifiable without hurting anything.<br><br>If you have any questions or comments, feel free to post them here.  Should you encounter any bugs, I would encourage you to post an issue on the GitHub page (just click the 'Issues' tab at the top and click 'Create Issue') so that I'm notified about it more easily, but you can post about any issues you encounter here as well.  Finally, if you have any questions that you cannot ask here or need to remain private, you're always free to e-mail me.<br><br><i>I apologize that this has no screenshots, but this doesn't do anything visual on its own, so you'll have to forgive me.</i> <br><br></td></tr></table><br>
<a name="972579"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >plash</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#2">[#2]</a></td></tr></table></td></tr><tr ><td class="posttext"> Awesome. I'll be playing with this :) <br><br></td></tr></table><br>
<a name="972695"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >rs22</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#3">[#3]</a></td></tr></table></td></tr><tr ><td class="posttext"> This sounds awesome. Looking forward to checking it out. Thanks! <br><br></td></tr></table><br>
<a name="972829"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >xlsior</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#4">[#4]</a></td></tr></table></td></tr><tr ><td class="posttext"> Where should these files be installed to?<br><br>blitzmax\mod\lugi.mod ? <br><br></td></tr></table><br>
<a name="972830"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >plash</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#5">[#5]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> Where should these files be installed to? <br></div>Correct.<br><br>From `core.mod/core.bmx`:<br><pre class=code>Module LuGI.Core</pre> <br><br></td></tr></table><br>
<a name="972831"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >xlsior</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#6">[#6]</a></td></tr></table></td></tr><tr ><td class="posttext"> Hm... compiles OK in normal mode, but not threaded mode for me:<br><br><div class="quote"> <br>Archiving:core.debug.mt.win32.x86.a<br>ar: creating C:/Code/BlitzMax/mod/lugi.mod/core.mod/core.debug.mt.win32.x86.a<br>Compiling:generator.bmx<br>Compile Error: Identifier 'TMutex' not found<br>[C:/Code/BlitzMax/mod/lugi.mod/generator.mod/utility.bmx;214;2]<br> <br></div> <br><br></td></tr></table><br>
<a name="972836"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >N</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#7">[#7]</a></td></tr></table></td></tr><tr ><td class="posttext"> Forgot to import brl.Threads in the module, it seems.  Should be fixed now. <br><br></td></tr></table><br>
<a name="972859"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >xlsior</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#8">[#8]</a></td></tr></table></td></tr><tr ><td class="posttext"> That did the trick -- thanks! <br><br></td></tr></table><br>
<a name="972866"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Wiebo</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#9">[#9]</a></td></tr></table></td></tr><tr ><td class="posttext"> I'm interested in this. But how would one integrate LUA for, say, AI for enemies and how would the advantage be from coding the AI in Blitz? <br><br></td></tr></table><br>
<a name="972868"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >N</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#10">[#10]</a></td></tr></table></td></tr><tr ><td class="posttext"> That's really down to the type of game you have and the way you code.  The way I'd do it is similar to the way you'd handle entities back in the A5 (3D GameStudio) engine, where you'd attach a script function to an entity and then each entity would be updated using that function.  How you do that part of the coding is really up to you, since there's not really any route that's defined as the best, as far as I know. <br><br></td></tr></table><br>
<a name="972875"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >therevills</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#11">[#11]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote">  where you'd attach a script function to an entity and then each entity would be updated using that function <br></div><br><br>Hi Nilium, could you please post an example of this? Thanks! <br><br></td></tr></table><br>
<a name="972876"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Naughty Alien</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#12">[#12]</a></td></tr></table></td></tr><tr ><td class="posttext"> ..this is very nice Noel..thanks.. <br><br></td></tr></table><br>
<a name="972884"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >N</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#13">[#13]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> Hi Nilium, could you please post an example of this? Thanks!  <br></div>I could post an example of a type that would handle it, but a full application would require me to essentially write a whole sample game- something I'd really rather avoid, especially considering there are a lot of different ways you could handle that.  Anyhow, once I get some changes in on the core and generator, I'll see about putting up an example, since it would depend on an addition I'm making to the generator. <br><br></td></tr></table><br>
<a name="972900"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Wiebo</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#14">[#14]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> The way I'd do it is similar to the way you'd handle entities back in the A5 (3D GameStudio) engine, where you'd attach a script function to an entity and then each entity would be updated using that function. <br></div><br>I don't know 3D Gamestudio, but wouldn't that be the same as using a method containing the same functionality in a base type, and calling that from a derived type? I still fail to see the advantages of LUA in this. What can I do with LUA what I cannot do in 'normal' blitzmax? What is the big PLUS?<br><br>I can see one big benefit: modding the game. Using scripts from 'outside' the main code which can be altered without recompiling. <br><br></td></tr></table><br>
<a name="972907"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >N</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#15">[#15]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> I don't know 3D Gamestudio, but wouldn't that be the same as using a method containing the same functionality in a base type, and calling that from a derived type? <br></div><br>Not exactly.  The function could be changed at any time, generated at runtime, removed entirely, etc.  It's more like if you were to add a callback field to an object and called that whenever you updated the entity.  Even then, however, your update routines will all be hard-coded, so you'll be required to rebuild and update your binary whenever you need to fix something.  With script, you could just leave the program running and reload the script at runtime, if you took the time to do that.<br><br><div class="quote"> What can I do with LUA what I cannot do in 'normal' blitzmax? <br></div>Quite a lot of things.  You could add and remove methods from objects (not BlitzMax objects- there are safeguards in place that will raise errors if you try to modify something that isn't defined for an object (unless you set BMX_TABLE_SUPPORT to 1, which I wouldn't recommend just because that code isn't tested right now), just generally speaking) at runtime, you can have operator overloading, anonymous functions, modify the environment that objects exist in, etc.  Furthermore, due to it being open source, anyone savvy enough could easily customize the language to add their own features to it.<br><br>For an interesting, albeit odd at first, example of something you could do, you could chain a bunch of functions together to get a desired result:<br><pre class=code>function chainfunc(...)
	local chain={...}
	return function(...)
		local first = true
		local a,b,c,d,e,f
		for i,v in ipairs(chain) do
			if first then
				result = {v(...)}
				first = false
			else
				result = {v(unpack(result))}
			end
		end
		return unpack(result)
	end
end

math.randomseed(os.time()); math.random()

print(
	chainfunc(
		-- Add 'ern' suffix if the name is a compass direction
		function(v)
			local vl = string.lower(v)
			if vl == "west" or vl == "east" or vl == "south" or vl == "north" then
				v = v.."ern"
			end
			return v, y
		end,
		
		-- Add a random street number
		function(x)
			local streetnum = math.random(80)
			local lastchar = string.char( string.byte(streetnum, #tostring(streetnum)) )
			if lastchar == "1" and (streetnum == 1 or streetnum &gt; 11) then
				streetnum = streetnum.."st"
			elseif lastchar == "2" and (streetnum == 2 or streetnum &gt; 12) then
				streetnum = streetnum.."nd"
			elseif lastchar == "3"  and (streetnum == 3 or streetnum &gt; 13) then
				streetnum = streetnum.."rd"
			else
				streetnum = streetnum.."th"
			end
			return x.." "..streetnum, y
		end,
		
		-- Add a random street suffix
		function(y)
			local names = {" Street", " Boulevard", " Road", " Crossing", ""}
			return(y..names[math.random(#names)]), x
		end
	)("East Hastings")
)
</pre><br><br><div class="quote"> What is the big PLUS? <br></div>I can't answer this for you, since you seem to be more inclined to prove that Lua is not of use to you.  It's up to you and you alone to decide what its use is, I'm just providing a tool to make the use of Lua easier (preferably significantly easier).<br><br>edit: Improved the above Lua example so that it better supports varargs functions. <br><br></td></tr></table><br>
<a name="972928"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Wiebo</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#16">[#16]</a></td></tr></table></td></tr><tr ><td class="posttext"> I start to see the use of this. Thanks! <br><br></td></tr></table><br>
<a name="973204"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >slenkar</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#17">[#17]</a></td></tr></table></td></tr><tr ><td class="posttext"> HEY thanks Noel, this seems quite useful <br><br></td></tr></table><br>
<a name="973251"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >JoshK</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#18">[#18]</a></td></tr></table></td></tr><tr ><td class="posttext"> Once I started heavily using the lua reflection code, I found the speed to be very slow due to all the dynamic construction of objects.  This code is a revision that uses a more optimal technique.  I think this module has a lot of potential.<br><br>Reproduceable error:<br><br>luabug.bmx:<br><textarea class=codebox name="code" wrap=OFF readonly="true" rows="15" cols="80">Framework pub.lua
Import LuGI.Core
Import LuGI.Generator
Import brl.standardio

Include "lua-gluefunctions.bmx"
'GenerateGlueCode("lua-gluefunctions.bmx")
'End

Type TVec3 {expose}
	Field x#,y#,z#
EndType

Type TEntity {expose}
	Field position:TVec3=New TVec3

	Method GetPosition:TVec3()
		Local t:TVec3=New TVec3
		Return t
	EndMethod
	
EndType

Type LuaCommands {expose static noclass}

	Method CreateEntity:TEntity()
		Return New TEntity
	EndMethod
	
EndType


Local L:Byte Ptr
L=luaL_newstate()
InitLugi(L)
luaL_openlibs(L)

Local source:String
source=LoadString("test.lua")
Print "Source:~n"+source
Print ""
luaL_dostring(L,source)
Print lua_tostring(L,-1)

End</textarea><br><br>lua-gluefunctions.bmx:<br><textarea class=codebox name="code" wrap=OFF readonly="true" rows="15" cols="80">Private

'---- TEntity

Function lugi_glue_TEntity_GetPosition_bd1txO:Int( lua_vm:Byte Ptr )
	Local obj:TEntity = TEntity(lua_tobmaxobject(lua_vm, 1))

	lua_pushbmaxobject( lua_vm, obj.GetPosition() )

	Return 1
End Function

'---- LuaCommands
Global lugi_lugi_glob_LuaCommands_aG2EIr:LuaCommands = New LuaCommands

Function lugi_glue_LuaCommands_CreateEntity_DVEL6z:Int( lua_vm:Byte Ptr )
	Local obj:LuaCommands = lugi_lugi_glob_LuaCommands_aG2EIr

	lua_pushbmaxobject( lua_vm, obj.CreateEntity() )

	Return 1
End Function

Function lugi_p_lugi_initpre_K8Fqqtctijxayb70(lua_vm:Byte Ptr, register_field(off%, typ%, name$, class@ Ptr), register_method(luafn:Int(state:Byte Ptr), name$, class@ Ptr))
	register_field( 8, LUGI_FLOATFIELD, "x", Byte Ptr(TTypeId.ForName("TVec3")._class) )
	register_field( 12, LUGI_FLOATFIELD, "y", Byte Ptr(TTypeId.ForName("TVec3")._class) )
	register_field( 16, LUGI_FLOATFIELD, "z", Byte Ptr(TTypeId.ForName("TVec3")._class) )

	' Register instance method TEntity#GetPosition
	register_method( lugi_glue_TEntity_GetPosition_bd1txO, "GetPosition", Byte Ptr(TTypeId.ForName("TEntity")._class) )
	register_field( 8, LUGI_OBJECTFIELD, "position", Byte Ptr(TTypeId.ForName("TEntity")._class) )

	' Register global method LuaCommands#CreateEntity
	register_method( lugi_glue_LuaCommands_CreateEntity_DVEL6z, "CreateEntity", Null )

End Function
New LuGIInitFunction.PreInit(lugi_p_lugi_initpre_K8Fqqtctijxayb70)


Function lugi_p_lugi_initpost_R4aqXBVv5jUbfPZo(lua_vm:Byte Ptr, constructor:Int(state:Byte Ptr))
	' Register constructor for TVec3
	lua_pushlightuserdata( lua_vm, Byte Ptr(TTypeId.ForName("TVec3")._class) )
	lua_pushcclosure( lua_vm, constructor, 1 )
	lua_setfield( lua_vm, LUA_GLOBALSINDEX, "NewTVec3" )
	' Register constructor for TEntity
	lua_pushlightuserdata( lua_vm, Byte Ptr(TTypeId.ForName("TEntity")._class) )
	lua_pushcclosure( lua_vm, constructor, 1 )
	lua_setfield( lua_vm, LUA_GLOBALSINDEX, "NewTEntity" )
End Function
New LuGIInitFunction.PostInit(lugi_p_lugi_initpost_R4aqXBVv5jUbfPZo)



Public</textarea><br><br>test.lua:<br><textarea class=codebox name="code" wrap=OFF readonly="true" rows="15" cols="80">entity=CreateEntity()
n=0
for i=1,100000 do
	entity:GetPosition()
	print(tostring(n))
	n=n+1
end</textarea> <br><br></td></tr></table><br>
<a name="973252"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Azathoth</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#19">[#19]</a></td></tr></table></td></tr><tr ><td class="posttext"> Argh. IE8 won't let me download it. <br><br></td></tr></table><br>
<a name="973329"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >N</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#20">[#20]</a></td></tr></table></td></tr><tr ><td class="posttext"> I'm pretty sure I fixed the above bug Josh found- seems to be due to a missing return statement in the lugi_gc_object metamethod.  I'm not sure what the return value of a function in C is when it doesn't have a return statement, but it was destroying the application under Windows (and possibly Linux, but Mac OS is unaffected for whatever reason), so I'm guessing it's a garbage value.<br><br>Anyhow, should be fixed.<br><br>Additionally, I haven't done any testing under Linux.  I don't have a VM for it right now (not much excuse for that other than that I don't want to spend the time downloading an ISO) and I'm definitely not going to install it into its own partition since I've got limited space.  If anyone has Linux installed, is actively using it, and is interested in this code, I'd appreciate any feedback on it from you.  As it stands<br><br><div class="quote"> Argh. IE8 won't let me download it. <br></div>That's just bizarre.<br><br><br>Edit: For those who used LRef/lua-reflection, and there were very few people I know of who used it, you might remember there was a bit of a hack in the way it handled methods and such that you could pass around methods and they'd just work without you ever needing to actually have the object on hand.  While that's not possible out of the box with LuGI, I figure I'll offer up a solution to that.  This script function will let you pass around the method with its object intact, and you can call it however you like:<br><br><pre class=code>
function DelegateMethod(object, method)
	local _method
	if type(method) == "string" then
		_method = object[method]
	else
		_method = method
	end
	local _object = object
	local fn = function(...)
		return _method(_object, ...)
	end
	return fn
end
</pre> <br><br></td></tr></table><br>
<a name="973808"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >N</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#21">[#21]</a></td></tr></table></td></tr><tr ><td class="posttext"> I've just added a new "category" metadata tag you can use to sort of filter out what you want to generate glue code for in LuGI.  Categories are just names that you can use to identify sections of code that should have glue code generated for them.  There's a brief explanation of it in the wiki's <a href="http://wiki.github.com/nilium/lugi.mod/metadata" target="_blank">Metadata</a> section.  The category stuff is completely optional to use and it won't affect anyone already using LuGI.<br><br>Also added a lua_isbmaxobject function, since otherwise you may have trouble determining if an object is an object or just another userdata type.  The type of userdata currently differs between regular and threaded builds as well, so this is the most reliable way to determine if an object on the stack is a BMax object or not.  It works by checking the metatable of the value on the stack (after ensuring it's the right kind of userdata) and seeing if it's the generic metatable used by all BMax objects handled by LuGI.  Not that you need to know how it works, but that should at least be some indication that you won't accidentally get a false positive. <br><br></td></tr></table><br>
<a name="974980"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Duckstab[o]</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#22">[#22]</a></td></tr></table></td></tr><tr ><td class="posttext"> Just installed the mod this looks really cool always wanted to add scriting to my game.<br><br>Now as a total newb I was wondering how to put it into practice<br><pre class=code>
Type Character
        Global List:Tlist = CreateList()
	Global Stats$[]
	Field id:Int
	Field Name$
	Field Stat:Int[]
	Field Effect:Int[]
End Type
</pre><br><br>What i would like to do is <br><br>1. Via a Script add a array of stats to the Type so i could have HP,MP and at a later date add AP ect..<br>Stat and Effect are Dynamic arrays so they reflect the Size of the Stats$ array.<br><br><br>2. Create instances from a Lua script with Name and Stat Values<br><br>3. Use a Script to change the Value of effect on any given instance <br><br>any help welcome :)<br><br>btw thanks for the Mod o/ <br><br></td></tr></table><br>
<a name="975108"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >N</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#23">[#23]</a></td></tr></table></td></tr><tr ><td class="posttext"> I think you'd be better server by not having that type in BMax/the host application.  If you need it in the host, I suggest you write getter/setting methods for the arrays, because LuGI has somewhat limited array access (it has to push arrays as tables and convert tables to arrays- this behavior isn't likely to change).<br><br>At any rate, I'd just do it like this in Lua:<br><pre class=code>-- character.lua

Characters = {}
setmetatable(Characters, {__mode="v"})

function NewCharacter(name)
	local char = {
		Name = name,
		ID = 0, -- some number don't know what
		Stats = {
			Strength=5,
			Dexterity=5,
			Agility=5,
			Intelligence=5,
			Charisma=5,
			Luck=5,
			Health=30,
			Magic=10
		},
		Effect = {
			Poisoned={State=false, Timeout=0},
			Mute={State="gordon freeman", Timeout=-1}
		},
	}
	table.insert(Characters, char)
	return char
end

local char = NewCharacter("Gordon Freeman")
char.Stats.Aptitude = 5	-- set new stat
</pre><br><br>That way, 1 &amp; 2 are non-issues because it is in the script.  It also means characters could be more easily redefined for gameplay purposes, like if a player came along and wanted to introduce some new stat by default, they could (assuming you don't store all scripts as bytecode). <br><br></td></tr></table><br>
<a name="976492"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >JoshK</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#24">[#24]</a></td></tr></table></td></tr><tr ><td class="posttext"> This code will parse a source code and generate a type with methods for functions that aren't part of a type.  Add 'hidden on the end of functions and includes/imports that you want ignored:<br><textarea class=codebox name="code" wrap=OFF readonly="true" rows="15" cols="80">SuperStrict
Global countfuncs:Int

Const BlitzPath:String="C:\Program Files\BlitzMax"

Local out:TStream

out=WriteFile("luacommands.bmx")
out.WriteLine("Type TLuaMethods {expose static noclass}")
out.WriteLine("")

DoFile("myfile.bmx",out)

out.WriteLine("EndType")
out.close()

Print countfuncs+" functions"
End




Function DoFile:Int(file:String,out:TStream)
	Global funcmap:TMap=New TMap
	
	
	Local in:TStream
	Local s:String
	Local sa:String[]
	Local commentstarted:Int
	Local typestarted:Int
	Local includefile:String
	Local tag:String
	Local args:String
	Local funcname:String
	Local n:Int
	Local arg:String
	Local commentstring:String
	Local privatestarted:Int
	Local started:Int=0
	
	file=RealPath(file)
	Print "Doing file ~q"+file+"~q..."
	
	in:TStream=ReadFile(file)
	If Not in
		Print "Failed to do file!"
		Return 0
	EndIf
	
	While Not in.Eof()
		
		commentstring=""
		
		s=in.ReadLine().Trim()
		
		s=s.Replace("#",":Float")
		s=s.Replace("$",":String")
		s=s.Replace("%",":Int")
		
		sa=s.split("'")
		If sa.length&gt;1
			s=sa[0]
			commentstring=sa[1].Trim().tolower()
		EndIf
		sa=s.split("")
		tag=s
		If sa.length&gt;1 tag=sa[0]
		tag=tag.tolower()
		Select tag
		Case "private"
			If Not commentstarted privatestarted=True
		Case "public"
			If Not commentstarted privatestarted=False
		Case "rem"
			commentstarted=True
		Case "endrem"
			commentstarted=False
		Case "type"
			If Not commentstarted typestarted=True
		Case "endtype"
			If Not commentstarted typestarted=False
		Case "import","include"
			If commentstarted+privatestarted=0
				If commentstring&lt;&gt;"hidden"
					includefile=s[tag.length..].Trim()
					If includefile.contains("~q")
						includefile=includefile.Replace("~q","")
						If ExtractExt(includefile).tolower()="bmx"
							includefile=includefile.Replace("~q","")
							If includefile.contains(":")=0
								includefile=ExtractDir(file)+"\"+includefile
							EndIf
							DoFile(includefile,out)
						EndIf
					Else
						sa=includefile.split(".")
						Local scope:String=sa[0].Trim()
						Local modname:String=sa[1].Trim()
						DoFile(BlitzPath+"\mod\"+scope+".mod\"+modname+".mod\"+modname+".bmx",out)
					EndIf
				EndIf
			EndIf
		Case "function"
			If commentstring&lt;&gt;"hidden"
				If commentstarted+typestarted+privatestarted=0
					Local rs:String="Return "
					Local fullfuncname:String
					Local illegal:Int=0
					
					If sa.length&gt;1
						args$=s[tag.length..].Trim()
						
						sa=args.split("(")
						funcname=sa[0].Trim()
						args=sa[1].Replace(")","")
						sa=args.split(",")
						fullfuncname=funcname					
						
						Local fa:String[]
						fa=funcname.split(":")
						funcname=fa[0].Trim()
						If fa.length&gt;1
							Select fa[1].Trim().tolower()
							Case "byte ptr","float ptr","int ptr","long var","int var","float var","byte var"
								illegal=1
							EndSelect
						EndIf
						
						If Not funcmap.valueforkey(funcname)
							
							If fa.length&gt;1
								If fa[1].Trim()=""
									rs=""
								EndIf
							Else
								rs=""
							EndIf
							
		
							Local myargs:String
							For n=0 To sa.length-1
								arg=sa[n]
								Local aa$[]
								arg=arg.split("=")[0]
								aa=arg.split(":")
								arg=aa[0]
								If aa.length&gt;1
									'Print aa[1].Trim().tolower()
									Select aa[1].Trim().tolower()
									Case "byte ptr","float ptr","int ptr","long var","int var","float var","byte var"
										illegal=1
										Exit
									EndSelect
								EndIf
								
								If n&gt;0 myargs:+","
								myargs:+arg
							Next
		
							If Not illegal
							
								If started=0
									started=1
									out.WriteLine "	'"+file
								EndIf
							
								out.WriteLine("	Method _"+fullfuncname+"("+args+") {rename=~q"+funcname+"~q}")
								out.WriteLine("		"+rs+funcname+"("+myargs+")")	
								out.WriteLine("	EndMethod")
								out.WriteLine("")
								
								funcmap.insert(funcname,funcname)
								countfuncs:+1
								
							EndIf
							
							
						EndIf
					Else
						
					EndIf
				EndIf
			EndIf
		EndSelect
	Wend
	in.close()
EndFunction</textarea> <br><br></td></tr></table><br>
<a name="998481"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >JoshK</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#25">[#25]</a></td></tr></table></td></tr><tr ><td class="posttext"> How would you suggest handling multiple layers of commands?  For example, my engine has its own command set in the module.  Then I have an interpreter built on top of this, which enables some additional functionality in Lua.  However, the interpreter generator redefines all the existing engine functions, as well as the new functions, so all the engine commands are listed twice.  I'd also like to be able to override commands in the module, but it looks like the old command is used.  Any suggestions? <br><br></td></tr></table><br>
<a name="998758"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >N</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#26">[#26]</a></td></tr></table></td></tr><tr ><td class="posttext"> I haven't got a clue what you mean. <br><br></td></tr></table><br>
<a name="998816"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >JoshK</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#27">[#27]</a></td></tr></table></td></tr><tr ><td class="posttext"> It's hard to explain.  I think I am just moving the lugi generator code to the top level of whatever application is using it.  It becomes the end user's responsibility to generate the lugi code, but that way there are no repeated commands. <br><br></td></tr></table><br>
<a name="999225"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >N</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#28">[#28]</a></td></tr></table></td></tr><tr ><td class="posttext"> I went ahead and updated LuGI with some code for working with arrays.  Previously, arrays would be pushed onto the Lua stack as tables every time.  This isn't particularly nice, because it means that if you access an array field of an object and modify the value you get from it, you won't do anything.  So, that's been fixed.  Arrays of arrays are a little bit iffy right now, and there are issues with auto-arrays due to a bug in BlitzMax where the created array does not have an actual type, but otherwise it seems to be working fine. <br><br></td></tr></table><br>
<a name="999233"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >_Skully</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#29">[#29]</a></td></tr></table></td></tr><tr ><td class="posttext"> Thanks Nilium<br><br>Yoink! <br><br></td></tr></table><br>
<a name="1145259"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Armitage 1982</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#30">[#30]</a></td></tr></table></td></tr><tr ><td class="posttext"> This module is extremely handy when it comes to Lua!<br>And it's even working with the recent LuaJIT 2.0 b10 from Zeke (you simply need to change the import version of Lua in the core module :).<br><br>I will probably rewrite my engine this year, and try to include a bit of Lua, at least for AI and Game object :)<br><br>I read there is a few problems while generating the glue file. Hope it doesn't make things too complicated.<br><br>Anyway, Thanks a lot for this module Nilium! <br><br></td></tr></table><br>
<a name="bottom"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td align="right"><a href="http://monkeycoder.co.nz" target="_blank"><img src="/img/monkey2.svg" ></a> <a href="https://github.com/blitz-research" target="_blank"><img src="/img/github.svg" ></a> <a href="https://discord.gg/qJccbSp" target="_blank"><img src="/img/discord.svg" ></a></td></tr></table><br></div><br><table width="100%"><tr><td></body></html lang="en">
