<!DOCTYPE html><html lang="en" ><head ><title >Water simulation using SPH</title><meta name='viewport' content='width=device-width, initial-scale=0.66'><meta name='description' content='language:basic, target:desktop, category:game development'><link rel="styleSheet" href="../skins/granite/style.css" type="text/css"><style type="text/css">div.bbcode {padding: 8px;background: #E5E5E5;color: #000000;border: 1px dashed #B4B4BE;}</style></head><body ><table width=100% cellspacing=0 cellpadding=0><tr ><td class="menubarleft"></td><td class="menubar"><table cellspacing="0" cellpadding="0"><tr ><td >&nbsp;</td><td class="menuitemleft"></td><td class="menuitem"><a href="/" class="menuitem">News</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/forums.php" class="menuitem">Forums</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/codearcs.php" class="menuitem">Code</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/logs.php" class="menuitem">Logs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/gallery.php" class="menuitem">Gallery</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/sdkspecs.php" class="menuitem">Specs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/search.php" class="menuitem">Search</a></td><td class="menuitemright"></td></tr></table></td><td class="menubarright"></td></tr></table><div class="main"><h1 >Water simulation using SPH</h1><a href="forums.php" >Community Forums</a>/<a href="topics.php?forum=61" >Showcase</a>/<a href="#bottom" >Water simulation using SPH</a><br><br>
<a name="991673"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Noobody</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#1">[#1]</a></td></tr></table></td></tr><tr ><td class="posttext"> In the last two weeks I've been working on a water simulation using <a href="http://en.wikipedia.org/wiki/Smoothed_Particle_Hydrodynamics" target="_blank">Smoothed Particle Hydrodynamics</a>.<br><br>Implementing this method was quite troublesome, since the derivation of the formulas is a huge chunk of math which was, at least for me, really hard to understand. This is mostly due to most of the maths used not being taught until college. I also had to do a complete rewrite once because I relied too much on a paper on blood simulation using SPH. Said paper used a different set of formulas that are inappropiate for incompressible fluids like water. I then reimplemented the whole algorithm using the approach proposed by Monaghan, which looks quite nice (even though it's more expensive compuationally).<br><br>The fluid calculations are more or less optimized and run conveniently fast (the 60 FPS limit is at approximately 7000 particles on my laptop). However, the rendering algorithm is awfully slow. I've already tried to implement it in a shader, but that was even slower. Maybe I'll give it another shot with prerendered metaballs, but I still have to think about that.<br><br>Long story short, screenshot:<br><img src="http://www.noobody.org/Projects/XSPH_Rendering4.png"><br><br><b>Edit:</b> Since this thread is getting quite a few hits, I thought I'd post a quick summary of newer and better versions that I posted below this post:<br><a href="/posts.php?topic=87491#995620" target="_blank">Improved first version</a><br><a href="/posts.php?topic=87491#1013733" target="_blank">SPH with Soft body coupling</a><br><a href="/posts.php?topic=87491#1028327" target="_blank">3D version</a><br><b>Videos:</b><br><a href="http://www.youtube.com/watch?v=u_xVeux5aog" target="_blank">Video 1</a><br><a href="http://www.youtube.com/watch?v=6DUTqEXA504" target="_blank">Video 2</a><br><a href="http://www.youtube.com/watch?v=Ds6TL5JbNsM" target="_blank">Video 3</a><br><br>If you still insist on downloading the very first version, here it is:<br><b>Download (Win exe + BMax code):</b> <a href="http://www.noobody.org/Projects/XSPH_EN.zip" target="_blank">Link</a><br><b>/Edit</b><br><br>Fluid particles are added with the left mouse button, boundary particles (=walls) with the right mouse button. Because the rendering algorithm is really slow, the particles are drawn as simple squares by default. You can change the rendering mode with the space bar.<br><br>I still have to work on certain discontinuities that express themselves in something that an article calls 'cancer'. For some unknown reason, certain particles suffer from a sudden decrease in density, which induces a huge pressure force that quickly spreads and blows up the whole simulation. I've implemented a hack that finds such particles, constrains them from spreading and tries to convert them back to a regular particle, but it doesn't look right sometimes.<br><br><a href="http://www.hst.aau.dk/~hempel/projects/pdf/sph1.pdf" target="_blank">This</a>, <a href="http://www.plunk.org/~trina/thesis/html/thesis_toc.html" target="_blank">this</a>, <a href="http://www.cs.umu.se/kurser/TDBD24/VT06/lectures/sphsurvivalkit.pdf" target="_blank">this</a> and <a href="http://cg.informatik.uni-freiburg.de/publications/bloodSimulationTHC2003.pdf" target="_blank">this</a> paper were a great help during the implementation. All formulas I used are derived in those articles. <br><br></td></tr></table><br>
<a name="991674"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >GW</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#2">[#2]</a></td></tr></table></td></tr><tr ><td class="posttext"> Pretty darn impressive! <br><br></td></tr></table><br>
<a name="991681"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Jeppe Nielsen</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#3">[#3]</a></td></tr></table></td></tr><tr ><td class="posttext"> Nice work, <br><br></td></tr></table><br>
<a name="991682"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >plash</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#4">[#4]</a></td></tr></table></td></tr><tr ><td class="posttext"> Nice implementation. <br><br></td></tr></table><br>
<a name="991693"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Shagwana</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#5">[#5]</a></td></tr></table></td></tr><tr ><td class="posttext"> Very nice, even handles pressure! (U bend style pressure) <br><br></td></tr></table><br>
<a name="991694"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >BlitzSupport</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#6">[#6]</a></td></tr></table></td></tr><tr ><td class="posttext"> Yeah, good stuff. <br><br></td></tr></table><br>
<a name="991714"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Nate the Great</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#7">[#7]</a></td></tr></table></td></tr><tr ><td class="posttext"> cool!  I personally couldnt find any articles on xsph I dont know how you did but this will help my research considerably.  Thanks <br><br></td></tr></table><br>
<a name="991731"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >markcw</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#8">[#8]</a></td></tr></table></td></tr><tr ><td class="posttext"> I like.<br><br>Could you not optimize it by not calculating particles in the middle of a mass? Or do you do that already?<br><br>What's it for? <br><br></td></tr></table><br>
<a name="991734"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >_Skully</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#9">[#9]</a></td></tr></table></td></tr><tr ><td class="posttext"> Wow this is fast! I only have dots though... not solid blue like your post <br><br></td></tr></table><br>
<a name="991738"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Noobody</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#10">[#10]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> Could you not optimize it by not calculating particles in the middle of a mass? Or do you do that already? <br></div><br>Do you mean in the rendering part? I thought about that, but it's hard to determine whether a point is inside or outside the fluid without iterating over all particles and sampling the density at certain points (which the rendering method does - that's what makes it so slow).<br><br><div class="quote"> What's it for? <br></div><br>Nothing in particular :)<br>It just fascinated me how realistic the water looked in a few videos on youtube, so I wanted to try if I could make something like this myself.<br><br><div class="quote"> I only have dots though... not solid blue like your post <br></div><br>See the first post:<br><div class="quote"> Because the rendering algorithm is really slow, the particles are drawn as simple squares by default. You can change the rendering mode with the space bar. <br></div> <br><br></td></tr></table><br>
<a name="991743"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >grindalf</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#11">[#11]</a></td></tr></table></td></tr><tr ><td class="posttext"> Wow thats very impressive <br><br></td></tr></table><br>
<a name="991766"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >ZJP</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#12">[#12]</a></td></tr></table></td></tr><tr ><td class="posttext"> Ho yesss. Very nice.<br>Looking for a blitz3D version now ;) Pleaaaase...<br><br>JP <br><br></td></tr></table><br>
<a name="991779"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >ImaginaryHuman</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#13">[#13]</a></td></tr></table></td></tr><tr ><td class="posttext"> See my post in the tutorials forum about drawing fast metaballs. <br><br></td></tr></table><br>
<a name="991786"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Noobody</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#14">[#14]</a></td></tr></table></td></tr><tr ><td class="posttext"> I already tried using prerendered metaball textures, but the problem is that those give washed-out borders instead of the sharp boundary I'm looking for. In the second part of the tutorial, you were explaining how to bring out certain treshold values, but those are still a bit washed-out (and also inverted), which doesn't look as good as I want it to be :)<br><br>I was thinking about rendering all metaballs in a separate FBO and then drawing that FBO with a glAlphaFunc( GL_GREATER, Treshold ). The problem is that FBOs aren't supported everywhere, so the compability would suffer.<br><br>I wonder how programs like <a href="http://www.youtube.com/watch?v=VFBlaoqRr-w" target="_blank">OECake</a> work - the water looks extremely good and is also rendered in realtime. <br><br></td></tr></table><br>
<a name="991796"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >D4NM4N</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#15">[#15]</a></td></tr></table></td></tr><tr ><td class="posttext"> This is cool! :) <br><br></td></tr></table><br>
<a name="991811"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >markcw</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#16">[#16]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> Do you mean in the rendering part? I thought about that, but it's hard to determine whether a point is inside or outside the fluid without iterating over all particles and sampling the density at certain points (which the rendering method does - that's what makes it so slow). <br></div><br>Yes, in the renderer. Maybe there are iterations that can be done less often? <br><br>How about this: determine the largest mass on the screen once every X seconds, then disable particles which aren't moving down any more and are a certain distance from the surface of the largest mass?<br><br>Just a thought. If it's not for anything you don't need to optimize anyway. <br><br></td></tr></table><br>
<a name="991823"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >dawlane</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#17">[#17]</a></td></tr></table></td></tr><tr ><td class="posttext"> Very nice indeed. <br><br></td></tr></table><br>
<a name="991854"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >ImaginaryHuman</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#18">[#18]</a></td></tr></table></td></tr><tr ><td class="posttext"> &gt;&gt;I already tried using prerendered metaball textures, but the problem is that those give washed-out borders instead of the sharp boundary I'm looking for.&lt;&lt;<br><br>If you draw rectangles over the whole screen in LIGHTBLEND or SHADBLEND, with a value color of, say, 127,127,127, it will force the outside half of the blob field to be clamped to a threshold. Then do the opposite full-screen rectangle (ie do a lightblend if you did shadeblend, etc), to restore the colors to their original range.<br><br>Or something similar.. you could use the stencil buffer to record when you draw your metaballs, then do the above full-screen rects only where the stencil is set, to preserve the background.<br><br>You could also clamp the bottom end and the top end of the range so that it leaves all one color value for pixels inside the threshold. <br><br></td></tr></table><br>
<a name="991873"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Nate the Great</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#19">[#19]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> I wonder how programs like OECake work - the water looks extremely good and is also rendered in realtime. <br> <br></div><br><br>I believe they use shaders and other things that make them widely incompatible with older machines unfortunately. <br><br></td></tr></table><br>
<a name="994747"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >DavidDC</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#20">[#20]</a></td></tr></table></td></tr><tr ><td class="posttext"> Nice, but I get an array bounds crash here<br><pre class=code>
Local Successor:TParticle = FluidGrid[ GridX, GridY ]
</pre><br>when I click near the left window border. <br><br><pre class=code>
Local GridX:Int = Max(0,Floor( P.PositionX*TSPH.INV_SMOOTHING_LENGTH ))
Local GridY:Int = Max(0,Floor( P.PositionY*TSPH.INV_SMOOTHING_LENGTH ))
</pre><br>seems to fix that. <br><br></td></tr></table><br>
<a name="995620"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Noobody</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#21">[#21]</a></td></tr></table></td></tr><tr ><td class="posttext"> Thanks for the advice, DavidDC. I fixed this along with a few other minor bugs.<br><br>Also, I was able to find a new rendering method that is reasonably fast and still produces neat results:<br><img src="http://www.noobody.org/BBP/SPH_Rendering11.png"><br><b>Download (BMax source &amp; Exe):</b> <a href="http://www.noobody.org/BBP/XSPH_9_EN.zip" target="_blank">Link</a><br><br>I used a method similar to the one described in Imaginary Human's article - still a prerendered Metaball texture, but a slightly different combination of blend functions.<br><br><br>In the past three weeks I also wrote on a raytracer in C++ (I began in BMax, but C++ is so much more comfortable due to operator overloading - vector/matrix calculations look much neater in C++ :) ).<br><br>The core of the raytracer is a fast triangle rendering method aimed at grid-based systems (127'000 trigs in about 7.2 seconds with a 800x600 resolution and 4x antialiasing). I then expanded the SPH code to work in three dimensions and wrote a small C interface for the BMax code to control the raytracer. The raytracer converts the SPH particles to a polygon using metaballs and the marching cubes algorithm. This gives very nice results, even though it's not realtime anymore.<br><br>I uploaded two videos on Youtube showing the SPH raytracer, <a href="http://www.youtube.com/watch?v=V-HLkymL_cg" target="_blank">here</a> and <a href="http://www.youtube.com/watch?v=sJbuRbBETcI" target="_blank">here</a>. I'm still working on this and am most probably going to upload a few more videos in the next weeks (with obstacles, more water etc.). <br><br></td></tr></table><br>
<a name="995663"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >ImaginaryHuman</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#22">[#22]</a></td></tr></table></td></tr><tr ><td class="posttext"> I like that it doesn't have any gaps in the larger areas of the fluid - and it is probably twice as fast as your other version. I peeked at the code, it looks pretty advanced and I couldn't understand it. :-) <br><br></td></tr></table><br>
<a name="997724"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Beaker</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#23">[#23]</a></td></tr></table></td></tr><tr ><td class="posttext"> I have a problem running the code that comes with this (tho the exe runs fine). I get an error on this line:<br>ParticleTex   = GLTexFromPixmap( LoadPixmapPNG( "Metaball.png" ) )<br>(actually the error is in this line:<br>If width=1 And height=1 RuntimeError "Unable to calculate tex size"<br>in GLAdjustTexSize which is called by GLTexFromPixmap)<br><br><br>The error is:<br>Unhandled Exception:Unable to calculate tex size<br><br>I can't really see why. Any ideas? Might be one for Mark to look at.<br><br>Hope this helps. <br><br></td></tr></table><br>
<a name="1009763"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >ker2x</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#24">[#24]</a></td></tr></table></td></tr><tr ><td class="posttext"> You can speed up the Nice rendering by changing :<br>Const SAMPLE_RATE:Float From 3.0 to 5.0<br><br>(or more, but it's too ugly)<br><br>I'm trying to find a good candidate methode to do GPGPU using OpenCL.<br><br>While profiling the application to speed up the simulation part and rendering part, i found that a lot of time is not spent in Math but in memory transfert.<br><br>The slowest simulation Method is RedistributeGrid() which doesn't do much math, but a lot of memory transfert.<br><br>Before moving the math to OpenCL, the app need a major rewriting. <br><br></td></tr></table><br>
<a name="1009768"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Hotshot2005</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#25">[#25]</a></td></tr></table></td></tr><tr ><td class="posttext"> Impressive Stuffs :) <br><br></td></tr></table><br>
<a name="1009775"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Taron</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#26">[#26]</a></td></tr></table></td></tr><tr ><td class="posttext"> AH YES, I almost forgot about this, that was nice...<br>I took a look at it right now and replaced your metaball.png with a grayscale version from all the way white to black in the corners, then replaced your rendering loop with this:<br><pre class=code>			glBegin( GL_QUADS )
				Local S:Float = 8.0
				
				For Local P:TParticle = EachIn Particles
					Local col:Float = (0.5+0.1*P.Pressure)*P.Density
					glColor4f(col^3,col^1.5,col,1.0)
					glTexCoord2f( 0.0, 0.0 ); glVertex2f( P.ScreenX - S, P.ScreenY - S )
					glTexCoord2f( 1.0, 0.0 ); glVertex2f( P.ScreenX + S, P.ScreenY - S )
					glTexCoord2f( 1.0, 1.0 ); glVertex2f( P.ScreenX + S, P.ScreenY + S )
					glTexCoord2f( 0.0, 1.0 ); glVertex2f( P.ScreenX - S, P.ScreenY + S )
				Next
			glEnd()
</pre><br><br>That's kinda neat and no slowdown really. <br><br></td></tr></table><br>
<a name="1009831"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >ker2x</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#27">[#27]</a></td></tr></table></td></tr><tr ><td class="posttext"> Change commited to <a href="http://github.com/ker2x/BM_Fluid" target="_blank">http://github.com/ker2x/BM_Fluid</a><br>The standalone .exe can be found here : <a href="http://ker.endofinternet.net/img/XSPH.exe" target="_blank">http://ker.endofinternet.net/img/XSPH.exe</a><br><br>Btw, you can find some of my old project in purebasic at <a href="http://ker.endofinternet.net/img/" target="_blank">http://ker.endofinternet.net/img/</a> :)<br><br>I'm planning to add GPGPU support to the simulation, using bah.opencl module : <a href="http://www.blitzbasic.com/Community/posts.php?topic=87452" target="_blank">http://www.blitzbasic.com/Community/posts.php?topic=87452</a><br><br>I'm still waiting for a mail reply from the original coder to add the license in the code. For now, i assume it is released into some kind of opensource license. <br><br></td></tr></table><br>
<a name="1009832"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >ker2x</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#28">[#28]</a></td></tr></table></td></tr><tr ><td class="posttext"> Mmm, i tought that the original coder was Tachyon, but it's noobody ?<br>Oops ... sending a new mail :) <br><br></td></tr></table><br>
<a name="1010003"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >smilertoo</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#29">[#29]</a></td></tr></table></td></tr><tr ><td class="posttext"> Very nice effect, would be great if it could use gpu. <br><br></td></tr></table><br>
<a name="1010020"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Taron</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#30">[#30]</a></td></tr></table></td></tr><tr ><td class="posttext"> If I think about the troubles with openGL, I don't even wonna know what openCL is going to do...haha. But, yeah, wished it was straight forward and reliably compatible. <br><br></td></tr></table><br>
<a name="1010021"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >nawi</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#31">[#31]</a></td></tr></table></td></tr><tr ><td class="posttext"> Beaker, try to change the texture to 2^n size. <br><br></td></tr></table><br>
<a name="1010026"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >ker2x</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#32">[#32]</a></td></tr></table></td></tr><tr ><td class="posttext"> i find OpenCL easier than GLSL.<br>And you can do OpenCL without OpenGL.<br><br>You don't even need a graphic context to do OpenCL.<br>Or, better, you can do OpenCL without GPU :) <br><br></td></tr></table><br>
<a name="1013461"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >ker2x</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#33">[#33]</a></td></tr></table></td></tr><tr ><td class="posttext"> I improved the rendering based on Metaballs.<br>Note the 556 FPS when the simulation is paused.<br>it run at 120FPS when unpaused.<br><br><img src="http://ker.endofinternet.net/img/XSPH.jpg"><br><br>The full source code can be found here : <a href="http://github.com/ker2x/BM_Fluid" target="_blank">http://github.com/ker2x/BM_Fluid</a><br><br>I'm still rewriting the full app (and trying understand all the code). <br>I can't yet find a way to improve speed with OpenCL. <br><br></td></tr></table><br>
<a name="1013555"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Nate the Great</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#34">[#34]</a></td></tr></table></td></tr><tr ><td class="posttext"> I am quite jealous of your xsph skillz... more so of your rendering skills though.  I am trying a marching squares algorithm and it is not going too well lol.  I dont think the average gamer's computer is ready for something with as much action/particles as pixel junk shooter or even what I tried to do with flood but the frame rate got too choppy... sigh :/ <br><br></td></tr></table><br>
<a name="1013576"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >ker2x</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#35">[#35]</a></td></tr></table></td></tr><tr ><td class="posttext"> I'm not sure if you're replying to noobody or me. but... just in case :<br><br>Noobody is the original coder, i'm just (heavily) hacking it.<br>I still consider myself as very new to BlitzMax, never completed a full project with it. I'm not even a coder, i'm a sysadmin. :)<br><br>i don't understand (yet) most of the math behind it, noobody probably does but it's not even mandatory.<br><br>All you need is some passion and time, time, time, time (and github :p ) ... The more you're skilled, the less time you need. But nobody care/ask about how many hours/days/days/weeks/years were spent in this project. If you need 3 years of your spare time to write your marching squares algorithm ... well ... just do it. :) <br><br></td></tr></table><br>
<a name="1013659"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Nate the Great</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#36">[#36]</a></td></tr></table></td></tr><tr ><td class="posttext"> I was referring to noobody but thanks for the advice anyway.  I replied like that because I wrote <a href="http://naillproductions.synthasite.com/flood.php" target="_blank">flood (link here)</a> and that was my main problem.. rendering and graphics.  I am redoing it now, hopefully much 'cleaner' this time. <br><br></td></tr></table><br>
<a name="1013681"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >ImaginaryHuman</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#37">[#37]</a></td></tr></table></td></tr><tr ><td class="posttext"> I would think that probably the effort involved in marching cubes, or rather, marching squares for 2d, which btw is patented, is more than needed to simple draw some metaball images, especially if the metaball images are one or a few small images on a single texture, and especially if you are drawing using either vertex arrays or even point sprites. Vertex arrays at least should speed it up a lot. With metaball images you are just reliant mostly on fill rate. You should be able to do plenty of particles in realtime. <br><br></td></tr></table><br>
<a name="1013688"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Nate the Great</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#38">[#38]</a></td></tr></table></td></tr><tr ><td class="posttext"> @IH<br><br>yeah I have discovered that the hard way. and I read its patent expired in 2005. :) its not that its usefull for me now anyway...<br><br>and I honestly dont know how I am going to render metaballs... I would like to do it the same way Noobody has done it but I dont know what he would think and I honestly dont understand the rendering code.<br><br>edit: noobody, I raised the gravity to 2 and took off the 'speed limit' thing and the simulation explodes... with the speed limit on and high gravity it acts very odd still... just wondering if you know why this is?<br><br>edit2: still explodes with gravity 1 and speed limit on :/ <br><br></td></tr></table><br>
<a name="1013705"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >ImaginaryHuman</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#39">[#39]</a></td></tr></table></td></tr><tr ><td class="posttext"> See my tutorial in the tutorials forum about rendering metaballs using images. Once you've generated an `energy field` image you just draw it in LIGHTBLEND to add it to the scene. My guess is that there is some lightblending going on in the above image which causes the high-density/overlapping blobs to produce a whiter/lighter coloration. <br><br></td></tr></table><br>
<a name="1013706"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Nate the Great</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#40">[#40]</a></td></tr></table></td></tr><tr ><td class="posttext"> hey IH I saw your tutorial on it and that is how I did the graphics for my game flood.  I just wish there was another faster less fuzzy looking way... but I am no good with gl ... <br><br></td></tr></table><br>
<a name="1013722"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >ker2x</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#41">[#41]</a></td></tr></table></td></tr><tr ><td class="posttext"> I couldn't make it explode with the anti-cancer-spreading routine enabled.<br><br>If i comment the anti-cancer-cure it is, indeed, exploding at gravity 1.0 <br><br></td></tr></table><br>
<a name="1013733"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Noobody</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#42">[#42]</a></td></tr></table></td></tr><tr ><td class="posttext"> If both the cancer cures are on (the density limiter and the speed constraint), it's impossible for cancer to spread. It is possible however, that the fluid behaves extremely unrealistic in an environment where normally cancer would blow up the fluid. This is due to the density limiter, which resets the density of cancer particles to a fixed value. This violates the conservation of mass. It's not that big of a problem if only one or two particles are affected, but if it's half of the fluid, the simulation looks really bad.<br><br>I really have no idea how I could fix this. All articles I read about this subject either prefer the gas pressure approach, which results in a compressible (read: unrealistic) fluid or use the approach proposed by Monaghan (which I am using) and implement some hacky routines to increase the stability.<br><br>The only idea I have right now is to run the simulation, remember particles that later become cancer and rerun the simulation, tracking those particles frame by frame to see what's going wrong.<br><br><br><br>Since I haven't posted in this thread for a while, I might as well talk about the progress that was made on the simulation. I'm working on a fluid module for BMax with support for multiple water tanks, different fluids with different properties, surface tension, soft bodies and rigid bodies. <br><br>I'm having a few problems with the rigid bodies, mainly because energy conversation is pretty difficult in a particle based approach :) But other than that, it comes along nicely. I made a small demo to demonstrate:<br><br>Screenshot:<br><img src="http://www.noobody.org/BBP/XSPH_Unified1.png"><br><b>Download (BMax code &amp; exe):</b> <a href="http://www.noobody.org/BBP/XSPH_Unified_EN.zip" target="_blank">Link</a><br><br>Keys 1, 2 and 3 switch between the different examples. #3 is very, very WiP, since rigid bodies don't really work yet. In example 1 and 2, space triggers the fluid emitters. #1 uses the right and left mouse button for fluid/soft body placement and #3 only the left button for the rigid body creation.<br><br><br><br>I'm also working on my raytracer used to render the 3D version of the module. Currently I'm implementing photon mapping to allow the rendering of nice water caustics.<br><br>Color bleeding and caustics already work, but there are still a few issues, like the dark corners.<br><img src="http://www.noobody.org/BBP/PhotonMapping_5.png"><br><a href="http://www.youtube.com/watch?v=Ds6TL5JbNsM" target="_blank">Here's</a> an older video of the raytracer + 3D fluid in action.<br><br>So yeah, that's about it. I don't know if I have enough ambition to complete both the module and the raytracer, but I'll see where this is leading.<br><br><br><br>@NateTheGreat:<br><div class="quote"> I am trying a marching squares algorithm and it is not going too well lol. <br></div><br>Marching squares on a screen-sized grid is, even for the GPU, an enormous overkill. My method is much simpler - it's basically the one in Imaginary Human's tutorial with a different blend mode: <textarea class=codebox name="code" wrap=OFF readonly="true" rows="15" cols="80">glEnable( GL_TEXTURE_2D )
glBindTexture( GL_TEXTURE_2D, ParticleTex )

glEnable( GL_BLEND )
glBlendFunc( GL_ONE, GL_ONE )

glColor3f( 0.0, 0.0, 1.0 )

For Local P:TParticle = EachIn Particles
	glTexCoord2f( 0.0, 0.0 ); glVertex2f( P.ScreenX - Size, P.ScreenY - Size )
	glTexCoord2f( 1.0, 0.0 ); glVertex2f( P.ScreenX + Size, P.ScreenY - Size )
	glTexCoord2f( 1.0, 1.0 ); glVertex2f( P.ScreenX + Size, P.ScreenY + Size )
	glTexCoord2f( 0.0, 1.0 ); glVertex2f( P.ScreenX - Size, P.ScreenY + Size )
Next

glDisable( GL_TEXTURE_2D )

glBlendFunc( GL_ZERO, GL_DST_COLOR )
glColor3f( 1.0, 1.0, 1.0 )

glBegin( GL_QUADS )
	For Local I:Int = 0 To 1
		glVertex2f( 0.0, 0.0 )
		glVertex2f( GWidth, 0.0 )
		glVertex2f( GWidth, GHeight )
		glVertex2f( 0.0, GHeight )
	Next
glEnd()</textarea><br>You can increase the number of iterations in the loop at the end to reduce the fuzziness, but 2 iterations work pretty good. Full-screen blended quads take their toll on the performance, but that's the fastest method I could find. Another drawback is that only full colors can be used (R, G and B have to be either 255 or 0). This limits the amount of colors available to 8, which is... not good. I have no idea how to overcome that, so if anyone has suggestions - please tell me :) <br><br></td></tr></table><br>
<a name="1013734"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >ker2x</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#43">[#43]</a></td></tr></table></td></tr><tr ><td class="posttext"> A good idea, i think, could be to transform overdense/overspeed/overheated water particle into vapor.<br><br>Nice raytracing... in BMax ? :) <br><br></td></tr></table><br>
<a name="1013781"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >ImaginaryHuman</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#44">[#44]</a></td></tr></table></td></tr><tr ><td class="posttext"> You should at least implement vertex arrays, you'll probably see a 200% speedup.<br><br>Also maybe there are faster ways to calculate fluid, there seems to be a lot of work being done to make it happen. At least multithread it for a speedup? Also maybe switching to arrays instead of separate `TParticles` may be faster. <br><br></td></tr></table><br>
<a name="1013828"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Nate the Great</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#45">[#45]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> <br>If both the cancer cures are on (the density limiter and the speed constraint), it's impossible for cancer to spread. It is possible however, that the fluid behaves extremely unrealistic in an environment where normally cancer would blow up the fluid. This is due to the density limiter, which resets the density of cancer particles to a fixed value. This violates the conservation of mass. It's not that big of a problem if only one or two particles are affected, but if it's half of the fluid, the simulation looks really bad.<br><br>I really have no idea how I could fix this. All articles I read about this subject either prefer the gas pressure approach, which results in a compressible (read: unrealistic) fluid or use the approach proposed by Monaghan (which I am using) and implement some hacky routines to increase the stability.<br> <br></div><br><br>I was nit picking lol ;)  just tryin to see how much I could change and still keep it stable...<br><br><div class="quote"> Marching squares on a screen-sized grid is, even for the GPU, an enormous overkill. My method is much simpler - it's basically the one in Imaginary Human's tutorial with a different blend mode: <br></div><br><br>yeah... just thought I would try it anyway.. and I am having a lot of trouble understanding opengl but thanks for the code<br><br>IH... I fail to see how implementing vertex arrays would be so much faster... seems like you would need so many of them it might be slower... ;) I dont know what im taking about<br><br><br>nice demo btw... Seems a bit buggy as far as water particles frequently getting stuck in the red stuff... but as you said, it is a wip. :) <br><br></td></tr></table><br>
<a name="1013876"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >ImaginaryHuman</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#46">[#46]</a></td></tr></table></td></tr><tr ><td class="posttext"> Um... well in my tests using vertex arrays rather than immediate mode OpenGL primitives is usually about 2 times faster to render. There's significantly less function-call overhead. Also the use of arrays is faster than a linked list particle system.<br><br>Btw possibly a different curvature of your blobby image could allow the blob image to actually be smaller and give the same result? Ie a more intense curve might dropoff faster so that the image doesn't need to be so big - you could save on a lot of overdraw.<br><br>Another thought that came to mind is that if you're drawing fullscreen quads in order to `do math` on the rgb data, you might gain some speed if you break your screen into a grid of `dirty rects` and only draw small quads over the rectangles that actually have particles in them. <br><br></td></tr></table><br>
<a name="1013938"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Noobody</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#47">[#47]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> A good idea, i think, could be to transform overdense/overspeed/overheated water particle into vapor.<br><br>Nice raytracing... in BMax ? :) <br></div><br>I once tried removing such particles (which is about the same as transforming them into vapor), but it actually makes things worse.<br><br>The raytracer is written in C++, because matrix/vector operations are so much more comfortable with operator overloading. Aside from that, the garbage collector in BMax would have taken a huge toll on the performance due to the amounts of (vector) objects used. I once wrote a test implementation of a raytracer in BMax but dropped it real quick in favor of C++ because the speed was just inacceptable. I still use BMax to calculate the fluid and to control the raytracer, though.<br><br><div class="quote"> You should at least implement vertex arrays, you'll probably see a 200% speedup.<br><br>Also maybe there are faster ways to calculate fluid, there seems to be a lot of work being done to make it happen. At least multithread it for a speedup? Also maybe switching to arrays instead of separate `TParticles` may be faster. <br></div><br>Vertex buffers would be a good idea, the rendering method needs a makeover anyway :)<br><br>The fluid calculation is pretty much optimized. Values are precalculated where possible, a grid/linked list combination is used to cull unimportant particles and divisions are avoided as much as possible. Multithreading is somewhat planned, but arrays instead of types are not an option. It may be faster, but the code would look a lot uglier and more confusing. <br><br></td></tr></table><br>
<a name="1013941"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >ker2x</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#48">[#48]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> Multithreading is somewhat planned, but arrays instead of types are not an option. It may be faster, but the code would look a lot uglier and more confusing.  <br></div><br><br>I will have to do that if i want to write the openCL implementation of XSPH. But it's not planned for the next few days. <br><br></td></tr></table><br>
<a name="1016094"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >ZJP</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#49">[#49]</a></td></tr></table></td></tr><tr ><td class="posttext"> Hi,<br><br>W.I.P for Blitz3D and Unity  <a href="http://www.zinfo972.net/avatar/FluidDEMOV4.zip" target="_blank">http://www.zinfo972.net/avatar/FluidDEMOV4.zip</a><br><br><img src="http://www.zinfo972.net/avatar/sph.jpg">]<br><br><br>JP <br><br></td></tr></table><br>
<a name="1026877"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Noobody</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#50">[#50]</a></td></tr></table></td></tr><tr ><td class="posttext"> 3D update!<br><br><a href="http://www.youtube.com/watch?v=u_xVeux5aog" target="_blank"><img src="http://www.noobody.org/BBP/SPH_PM.png"></a> <br><br></td></tr></table><br>
<a name="1026944"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >ImaginaryHuman</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#51">[#51]</a></td></tr></table></td></tr><tr ><td class="posttext"> Hey very nice, man. It doesn't quite look like water to me, maybe it's the particle size, looks a bit more like a gloopy thicker solution, but very nice rendering. <br><br></td></tr></table><br>
<a name="1026948"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Noobody</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#52">[#52]</a></td></tr></table></td></tr><tr ><td class="posttext"> Thanks!<br><br>Yeah, I'm still trying to figure out why it looks that way. I suspect it's because it moves too slow and therefore looks as if it had a high viscosity.<br><br>I'm going to try skipping every second or third frame to make the video faster. <br><br></td></tr></table><br>
<a name="1026949"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Hotshot2005</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#53">[#53]</a></td></tr></table></td></tr><tr ><td class="posttext"> it is amazing on what you have done! :) <br><br></td></tr></table><br>
<a name="1026961"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >*</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#54">[#54]</a></td></tr></table></td></tr><tr ><td class="posttext"> another thing is the stuff coming out the pipe looks like glue there is no activity on the water coming from it where normal water does something. <br><br></td></tr></table><br>
<a name="1026968"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Noobody</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#55">[#55]</a></td></tr></table></td></tr><tr ><td class="posttext"> Yeah, that's because the particles in the emitter are created in a regular grid, which is why the water-jet always keeps the same shape. Adding a random offset to the particles when created at the emitter should fix that. <br><br></td></tr></table><br>
<a name="1026973"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Kryzon</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#56">[#56]</a></td></tr></table></td></tr><tr ><td class="posttext"> Very nice refractive material!<br><br>but the fluidness needs some work, and I don't think that's related to the video speed (even slow motion water should look watery). <br><br>I'm thinking decreasing the "weight" of each particle should improve it. Also, if there is any friction between each particle, you should reeaally decrease it: takes too much for the bounced wave to get back to the flow of water. You can see from 00:05 up to 00:16 that the water takes too much time to cover itself, and this sort of "depression" appears (even if the impact of the water-jet has some influence on that, it still doesn't feel natural). <br><br></td></tr></table><br>
<a name="1027010"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rck</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#57">[#57]</a></td></tr></table></td></tr><tr ><td class="posttext"> great to see the fluid and raytracer working well together, makes me want to add photon mapping to my own. <br><br></td></tr></table><br>
<a name="1028327"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Noobody</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#58">[#58]</a></td></tr></table></td></tr><tr ><td class="posttext"> Today I experimented with multithreading to speed up the SPH algorithm. Unfortunately, the changed GC behaviour in threaded build is much slower, which results in more speed lost than could be gained through multiple threads (when using many objects, that is).<br><br>For comparison, I ported the code to C++ and implemented multithreading directly using the WinAPI. Not only did the program (without threading) gain 20% compared to the BMax version, but multiple threads actually increased the speed.<br><br>This means that the best way probably is to do most of the work in C++ and only do rendering and initialisation in BMax. Getting threading to work in C++ on all three platforms requires additional platform specific code and a lot of testing, but the speed is worth it, I guess :)<br><br>I compiled a small realtime 3D demo of the C++ SPH project to showcase the new multithreading option:<br><img src="http://www.noobody.org/BBP/SPH3D_MT.png"><br><b>Download: </b> <a href="http://www.noobody.org/BBP/SPH3D_MT.rar" target="_blank">Link</a><br><br>The cube can be turned using the arrow keys. Since the gravity always pulls downwards, it's a good way to play around with the fluid. On startup, the program asks how many threads it should use - just input the number of cores in your CPU for optimal performance, but not more than 4. With 4 threads, the performance peaks. The FPS gained trough more than 4 threads are lost due to bigger overhead.<br><br>Next I'll be 'multithread-ising' the raytracing code to decrease the rendering time so I don't have to wait hours for a video to finish :)<br>After that I'll probably work on a SPH module implementing the 2D multithreading version in C++.<br><br><br><div class="quote"> but the fluidness needs some work, and I don't think that's related to the video speed (even slow motion water should look watery).  <br></div><br>I *think* it's because of the viscosity constants that were set to high. I fixed it in the demo above and I think it's better now. I'll try to render a new video to see whether it helped. Thanks for the advice!<br><br><div class="quote"> great to see the fluid and raytracer working well together, makes me want to add photon mapping to my own.  <br></div><br>For implementing photon mapping I can recommend Jensen's book "Realistic Image Synthesis Using Photon Mapping". It explains the algorithm in great detail and provides a demo implementation in C++. The math he uses is mind-bending, but when it comes down to code, it's pretty straightforward. For diffuse interreflection, photon mapping is too noisy in my opinion, but it yields great results for caustics. <br><br></td></tr></table><br>
<a name="1028329"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >slenkar</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#59">[#59]</a></td></tr></table></td></tr><tr ><td class="posttext"> i wonder how much faster it would be in plain C?<br>:) <br><br></td></tr></table><br>
<a name="1028415"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Robert Cummings</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#60">[#60]</a></td></tr></table></td></tr><tr ><td class="posttext"> Slower would be my guess? :P <br><br></td></tr></table><br>
<a name="1028581"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Noobody</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#61">[#61]</a></td></tr></table></td></tr><tr ><td class="posttext"> New video!<br><br><a href="http://www.youtube.com/watch?v=6DUTqEXA504" target="_blank"><img src="http://www.noobody.org/BBP/SPH_PM_2.png"></a><br><br>More photons, more particles, more threads, more everything! Except render time, of course.<br><br>Next stop: obstacles. <br><br></td></tr></table><br>
<a name="1248132"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Clyde</td><td align="right"><font class=tiny>(Posted 2014)</font>&nbsp;<a href="#62">[#62]</a></td></tr></table></td></tr><tr ><td class="posttext"> Well Done!! :)<br><br>Very very cool indeed!! <br><br></td></tr></table><br>
<a name="bottom"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td align="right"><a href="http://monkeycoder.co.nz" target="_blank"><img src="/img/monkey2.svg" ></a> <a href="https://github.com/blitz-research" target="_blank"><img src="/img/github.svg" ></a> <a href="https://discord.gg/qJccbSp" target="_blank"><img src="/img/discord.svg" ></a></td></tr></table><br></div><br><table width="100%"><tr><td></body></html lang="en">
