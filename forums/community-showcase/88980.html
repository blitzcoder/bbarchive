<!DOCTYPE html><html lang="en" ><head ><title >BMax module: ChaosClone</title><meta name='viewport' content='width=device-width, initial-scale=0.66'><meta name='description' content='language:basic, target:desktop, category:game development'><link rel="styleSheet" href="../skins/granite/style.css" type="text/css"><style type="text/css">div.bbcode {padding: 8px;background: #E5E5E5;color: #000000;border: 1px dashed #B4B4BE;}</style></head><body ><table width=100% cellspacing=0 cellpadding=0><tr ><td class="menubarleft"></td><td class="menubar"><table cellspacing="0" cellpadding="0"><tr ><td >&nbsp;</td><td class="menuitemleft"></td><td class="menuitem"><a href="/" class="menuitem">News</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/forums.php" class="menuitem">Forums</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/codearcs.php" class="menuitem">Code</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/logs.php" class="menuitem">Logs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/gallery.php" class="menuitem">Gallery</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/sdkspecs.php" class="menuitem">Specs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/search.php" class="menuitem">Search</a></td><td class="menuitemright"></td></tr></table></td><td class="menubarright"></td></tr></table><div class="main"><h1 >BMax module: ChaosClone</h1><a href="forums.php" >Community Forums</a>/<a href="topics.php?forum=61" >Showcase</a>/<a href="#bottom" >BMax module: ChaosClone</a><br><br>
<a name="1010259"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >BladeRunner</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#1">[#1]</a></td></tr></table></td></tr><tr ><td class="posttext"> Hi there,<br>just wanted to present you my latest project:<br><br><b>ChaosClone</b><br><br>It's a module that allows for nearly universal saving, loading, cloning and combining of user defined objects.<br>It is capable of automatic handling for arrays (also multidimensional and arrays in arrays), TBank, TList, TMap, TImage &amp; TPixmap.<br>All operations are managed by different metatags you add to your objects.<br>You can combine objects and arrays and decide which fields from the objects are taken from source or target.<br>Also, cloning of objects and their subobjects is an easy task.<br>Repeating references are recognized and replaced to keep files small.<br>Last not least Chaosclone offers the ability to call user defined methods for loading / saving / initializing if a data cannot be aquired with 'onboard tools' (which would be the case for pointers and arrays of arrays as reflection does not handle with them).<br><br>The module is precompiled for Win, Mac and Linux and documented fairly well.<br>If there are questions regarding how to use the module or if you detect errors feel free to contact me.<br><br>ChaosClone is closed source donationware - if you like it and use it I would ask you to donate a little. Also i ask you to add credits in your app if you use it.<br><br>Where to get it?<br><a href="http://www.chaos-interactive.de" target="_blank">http://www.chaos-interactive.de</a> in the modules section.<br>OR<br><a href="https://svn.blitzforum.de/chaos.mod" target="_blank">https://svn.blitzforum.de/chaos.mod</a><br><br>...and if you like it:<br><a href="https://www.paypal.com/cgi-bin/webscr?cmd=_s-xclick&amp;hosted_button_id=LX2X9TLEHGPKU" target="_blank"><img src="https://www.paypal.com/en_US/i/btn/btn_donateCC_LG.gif"></a><br><br>Thank you. <br><br></td></tr></table><br>
<a name="1010355"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Htbaa</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#2">[#2]</a></td></tr></table></td></tr><tr ><td class="posttext"> Except for the cloning part, in what way would this differ from the serialization module from Brucey (assuming his module doesn't do cloning)?<br><br>Since reflection is being used, how good is it performance wise? If targeting applications it's OK if cloning a lot of objects takes some time (I'd say) but for a fast paced shooter or something it should be very fast.<br><br>For the module being closed source (which is fine), do remember you're going to spend a lot of time compiling it for every BlitzMax release and keeping it up to date with BlitzMax. BlitzMax is being updated quite frequently for the last year. <br><br></td></tr></table><br>
<a name="1010365"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >BladeRunner</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#3">[#3]</a></td></tr></table></td></tr><tr ><td class="posttext"> As far as i can say it's quite some difference to Bruceys module as he uses xml to store the data where my approach does save the data directly (bytewise).<br>I didn't for shure reinvent the wheel. I can't tell you how it will perform with real lots of objects - but I invite you to test it if it fits your needs. I must admit I didn't think about performance upon creation, but I think it should be no problem to do some 'pre-level-creation' of objects.<br>My main target was to make it as universal as possible while trying to keep small files. The cloning and combining where sideeffects I achieved as I wrote the savin' stuff.<br><br>If there should be any problems with the module because of newer Bmax-Releases I will update it for shure, in fact I'm still working at the module and trying to optimize it. If you have any problems with the Module I will try to help. As this is a complex theme I can't gurantee its free of all bugs, but the testings on all three OS were promising.<br><br>I hope I could answer your questions and understood you well, because my english is not very good I'm afraid.<br><br>After all, I don't want to sell broken stuff, this is why i made it donationware - if you are happy with it it would please me if you show it. If you are not happy I would be glad to know why so i can make things better. <br><br></td></tr></table><br>
<a name="1010379"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >BladeRunner</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#4">[#4]</a></td></tr></table></td></tr><tr ><td class="posttext"> Sorry for the double post. I took a look at the serialization module and what i found at the forums about it (I never used it). Ine one thread from about a year ago brucey said his module only handles one-dimensional arrays. My module handels multidimensional arrays[,,..] and arrays in arrays[[]]. Only arrays of arrays [][] are out.<br>Also, I build in the ability to add external load and save methods if chaosclone fails on a task, so you can just extend it to fit your needs. I was not able to find a working download for bah.persistence, so i can only guess if bruceys module has this functionality too.<br>Also, the used tags can be altered to perform multiple different tasks on the same object.<br><br>Just give it a try and see if it satisfies your needs.<br><br><br>EDIT: I read that brucey added multidim support, too. <br><br></td></tr></table><br>
<a name="1010418"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >plash</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#5">[#5]</a></td></tr></table></td></tr><tr ><td class="posttext"> I'm pretty sure you can use Brucey's persistence module to write/read data in any form you see fit. <br><br></td></tr></table><br>
<a name="1010448"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >BladeRunner</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#6">[#6]</a></td></tr></table></td></tr><tr ><td class="posttext"> As I said before, I dind't use his module before, but what I read says it uses XML. I don't want to discredit his work, I can't even judge it as i -like mentioned above- wasn't able to find a download (it is described at code.google.com, but no links). <br>Use what you think will do it best for you, it's as easy as that. I never said my module was revolutionary better than others. I said it is there. <br><br></td></tr></table><br>
<a name="1012234"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Volker</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#7">[#7]</a></td></tr></table></td></tr><tr ><td class="posttext"> Hello BladeRunner,<br><br>I did some speed test to compare bah.persistence mod<br>and yours one.<br>But it looks like your mod fails saving to stream.<br>All fields marked with {clone} are empty after loading.<br><br><textarea class=codebox name="code" wrap=OFF readonly="true" rows="15" cols="80">


Import chaos.clone

Local test:TTestobject = New TTestobject
'
' fill the array
For Local fill:Int = 0 To 9 ' fails too
	test.intarr[fill] = fill
Next
' set the string
test.text = "Hello World"

' save object
Local stream4:TStream = OpenFile("chaos2.txt")
If stream4 = Null Then Throw("no stream")
SaveUDObject(stream4, test)
CloseStream(stream4)

' load object
Local stream5:TStream = OpenFile("chaos2.txt")
Local test2:TTestobject = New TTestobject
LoadUDObject(stream5, test2)

' print the array, after loading all empty
For Local i:Int = EachIn test2.intarr
	Print i
Next
' print the string
Print test2.text ' empty after loading

Type TTestobject
	Field text:String {clone}
	Field intarr:Int[10] {clone}
	'Field list:TList {clone} ' Field list:TList = New TList {clone} fails in "	Local cobject:Object = cloneobject(testo)"
	

End Type


</textarea> <br><br></td></tr></table><br>
<a name="1013965"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >BladeRunner</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#8">[#8]</a></td></tr></table></td></tr><tr ><td class="posttext"> Sorry for my late answer, I must have overseen that there was a reply. I will look at your code and answer again later on. <br><br></td></tr></table><br>
<a name="1013968"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >BladeRunner</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#9">[#9]</a></td></tr></table></td></tr><tr ><td class="posttext"> Ok, there have been two different issues:<br>First, there were usage-errors:<br>- You declared the fields with clone only - this clones them, but it does not save them.<br>- You did not assign the result of LoadUDObject to a type instance.<br><br>After changing this, all data gets saved correctly to the stream (which i proofed with an HEX-Editor).<br><br>Second, there was a bug I must have overseen as I rewrote the array-saving which caused primitive arrays no longer got loaded, whereas object ones did fine.<br>I found the bug and fixed it and soon will upload the new version for testing. Your example jusgt did fine for me after that.<br><br>Please take my apologizes that it did take so long to answer, and thanks for your bug report.<br><br><br>I just add the 'corrected' example here:<br><textarea class=codebox name="code" wrap=OFF readonly="true" rows="15" cols="80">Import chaos.clone

Local test:TTestobject = New TTestobject
'
' fill the array
For Local fill:Int = 0 To 9 ' fails too
	test.intarr[fill] = fill
	Print fill
Next
' set the string
test.text = "Hello World"

' save object
Local stream4:TStream = WriteFile("chaos2.txt")
If stream4 = Null Then Throw("no stream")
SaveUDObject(stream4, test)
CloseStream(stream4)

' load object
Local stream5:TStream = OpenFile("chaos2.txt")
Local test2:TTestobject = New TTestobject
test2 = TTestObject(LoadUDObject(stream5, test2)) 'assign the value (in the upcoming version, test2 can be null and is optional in the call.)
' print the array, after loading all empty
For Local i:Int = EachIn test2.intarr
	Print i
Next
' print the string
Print test2.text ' empty after loading

Type TTestobject
	Field text:String {clone save}'marked for cloning and saving
	Field intarr:Int[10] {clone save}
	'Field list:TList {clone} ' Field list:TList = New TList {clone} fails in "	Local cobject:Object = cloneobject(testo)"
	

End Type</textarea><br><br>PS: The object-arg in LoadUDObject will be obsolete (optional) in the coming version of ChaosClone. It is only there for the purpose of combining of two objects. Please see the command reference on chaos-interactive.de for further info on combining.<br><br>I will now get to my mates for compiling of the mac and linux- modules and then will update the downloadlink.<br>Thanks again for testing.<br><br>EDIT: Win32 and Mac Versions are up - see on www.chaos-interactive.de<br>Linux will follow asap. <br><br></td></tr></table><br>
<a name="1013986"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >slenkar</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#10">[#10]</a></td></tr></table></td></tr><tr ><td class="posttext"> this could be what I need, <br>if there is an array of 1000 elements and most of them are empty it doesnt save the empty elements?<br>also if there is an object of 1000 fields and most of them are null it doesnt save the null fields?<br><br>I tried it out...<br><br>what am I doing wrong?<br><pre class=code>
Import chaos.clone


Type Ttest {wholesave}
    Field path:String
    Field obj:Object
	Field strin:String

    Method save(url:Object)
        Local s:TStream = WriteFile(url)
        'do save stuff
        s.close()
    End Method


    Method Load(url:Object)
        Local s:TStream = ReadFile(url)
        'do load stuff
        s.close()
    EndMethod
End Type

Local o:Ttest=New Ttest
o.strin="greetings"
SaveUDObject("hello",o) 


Local obj:Ttest=Ttest(LoadUDObject("hello"))
Print obj.strin </pre><br><br>it should print 'greetings' but it doesnt <br><br></td></tr></table><br>
<a name="1014005"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >BladeRunner</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#11">[#11]</a></td></tr></table></td></tr><tr ><td class="posttext"> ok, The linux version is up now.<br><br>@slenkar:<br><textarea class=codebox name="code" wrap=OFF readonly="true" rows="15" cols="80">
Import chaos.clone


Type Ttest	'Wholesave isnt implemented on typelevel. It's on field level. 
    Field obj:Object {wholesave}	'do this if the stored object should be saved complete.
	Field strin:String {save}		'the string gets saved
End Type

Local o:Ttest=New Ttest
o.strin="greetings"
SaveUDObject("hello",o) 


Local obj:Ttest=Ttest(LoadUDObject("hello"))
Print obj.strin 
</textarea><br>Wholesave is by now fieldwise, not typewise. This means the content of the field marked with wholesave gets stored completely, no matter what tags are in it's metadata.<br>I will however consider to implement it typewise for simplicity.<br>Also the load() and save() methods are only needed if you have stuff that cannot be stored by the module itself (pointers, globals...).<br><br>Regarding your Questions:<br>Primitive (int, byte, float ...) Arrays are always stored as whole. Objects which are NULL get stored on a 1-byte-base, no matter if they are a field of an object or in an array. (This is necessary as the loading routine can't know if a field will be null, so it searches for a status byte.)<br><br>By now the savefiles are streight forward. I am working on a compression for the save files, which also would offer some sort of encryption to the files. This may take some time as my work on this is in the beginning by now. <br><br></td></tr></table><br>
<a name="1014027"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >slenkar</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#12">[#12]</a></td></tr></table></td></tr><tr ><td class="posttext"> thanks for the help.<br><br>is there a chance of getting an option to save all fields except those with a {nosave} tag?<br><br>Thats what I used before with bruceys mod and that was very convienient <br><br>my main problem is that I have some large arrays (to speed up the game) and deserialization is slow because every element of the array is deserialized even if it is zero.<br><br>compression wouldnt speed up deserialization, (as you probably know)<br><br>if an array element is zero, does the code put a zero in the array or does it just leave it alone?<br><br>also when I change my program i dont want to make my previous saved games incompatible, so does chaos clone check for the existence of a field before trying to deserialize?<br><br>When I remove an objects field the save game doesnt work unless I manually add in a bit of code to check the existence of the field in bruceys mod.<br><br>thanks for your efforts <br><br></td></tr></table><br>
<a name="1014094"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >BladeRunner</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#13">[#13]</a></td></tr></table></td></tr><tr ><td class="posttext"> Hi,<br>it should be possible to add sth. like a 'save them unmarked'- flag, will add it on my ToDO-list.<br>As with the arrays, it depends greatly on what they consist of. Primitive arrays will be stored and loaded as whole, no matter what the contents are. This is due to the fact that the loader can't know what a field would contain in front of loading it. Also, checking a field if it is '0' before writing it would be slower than just write it.<br>If, however, the array consists of a user defined type / object like tmap, tlist etc. then the loader will check for a null-identifier. If this is found then the loader returns null, without further cycling through the objects internals. I can't think of a way to speed this up more as the loader works recursive and steps through all elements it would expect from the original object.<br><br><div class="quote"> also when I change my program i dont want to make my previous saved games incompatible, so does chaos clone check for the existence of a field before trying to deserialize? <br></div><br>As CC works with reflection, it assumes the Typestructure in the source that uses it. So- if you change type fields in your source, you will change what CC is looking for.<br>BUT: You can define as many load/save-Tags as you like (if there aren't any restrictions in brl.reflection I am not aware of) and therfore alter the load/save-behaviour the way you like. You could store a version number in front of the rest of your data and use an init method to set the appropriate metadata for this version. A bit tricky but it should work without problems.<br><br><textarea class=codebox name="code" wrap=OFF readonly="true" rows="15" cols="80">
SuperStrict
Import chaos.clone

Type TVersion {init}
	Field _VersionNumber:Short
	
	Method Init() 
		Select _VersionNumber
			Case 1
				TChaosClone.SetSaveTags("s1","ns1","ws1")
			Case 2
				TChaosClone.SetSaveTags("s2","ns2","ws2")
		End Select
		DebugLog "GAME VERSION: "+_VersionNumber
	End Method
	
	Method SetActual() 
		'do this before each saving to ensure the actual game state gets saved. 
		_VersionNumber = 2
                Init()
	End Method
End Type
Global version:TVersion = New TVersion
version.SetActual() 
'...

Type TSaveMe
	Field blub:Object {s1 s2}
	Field bla:String {s1 ns2}	'will only be stored in Version 1.
End Type

'...

Local stream:TStream = WriteFile("save.dat") 
	version.SetActual()
	SaveUDObject(stream , version) 
	SaveUDObject(stream , tsavemeinstance) 
	'...
stream.close()	
</textarea><br>This code is untested but should do the job.<br><br>EDIT: One thing is to be payd attention to: The order of fields within the type DOES matter. If you change the order while reaaranging your code you will screw loading of old savestates up. This is because of the way reflection works.<br>If you keep this single point in mind there shouldn't be problems. <br><br></td></tr></table><br>
<a name="1014114"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >slenkar</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#14">[#14]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> This is due to the fact that the loader can't know what a field would contain in front of loading it <br></div><br><br>when you create an array its elements are all zero or null <br><br></td></tr></table><br>
<a name="1014321"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >BladeRunner</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#15">[#15]</a></td></tr></table></td></tr><tr ><td class="posttext"> yes, they are. But the loader still can't know what would be in the single slots. If you want the array to be saved as totally empty, set it to NULL, it will be saved as a null-reference then.<br>In every other case, even if only one element of the array is set to an other value, you will have to store it as whole.<br>All solutions that will search for 'subarrays' of null would be very complex and resourceconsuming i think.<br>If i store a 'is not null' in front of every array element, I would double the place it needs in the worst case, and ther would be no increase in speed.<br>Using some sort of RLE would be possible but a pain in the ass to achieve, as it would need further recursive action in them. Also, in lot of cases it would not reduce the ammount of data. Also it would be time-consuming to to store and load this way.<br><br>I suggest you try if my module can handle arrays of your needed size fast enough. I'm afraid I can't offer you a solution much faster than this. <br><br></td></tr></table><br>
<a name="1014354"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >slenkar</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#16">[#16]</a></td></tr></table></td></tr><tr ><td class="posttext"> ok ill try it out, thanks <br><br></td></tr></table><br>
<a name="1039677"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >BladeRunner</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#17">[#17]</a></td></tr></table></td></tr><tr ><td class="posttext"> 1.80 online, Win32 only by now.<br>Fixed a bug which sometimes caused CClone to crash if TMaps were saved.<br>Also added threaded builds.<br>I will upload Linux and Mac builds asap. <br><br></td></tr></table><br>
<a name="bottom"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td align="right"><a href="http://monkeycoder.co.nz" target="_blank"><img src="/img/monkey2.svg" ></a> <a href="https://github.com/blitz-research" target="_blank"><img src="/img/github.svg" ></a> <a href="https://discord.gg/qJccbSp" target="_blank"><img src="/img/discord.svg" ></a></td></tr></table><br></div><br><table width="100%"><tr><td></body></html lang="en">
