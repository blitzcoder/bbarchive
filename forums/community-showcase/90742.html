<!DOCTYPE html><html lang="en" ><head ><title >neighbor search for smooth particle hydrodynamics</title><meta name='viewport' content='width=device-width, initial-scale=0.66'><meta name='description' content='language:basic, target:desktop, category:game development'><link rel="styleSheet" href="../skins/granite/style.css" type="text/css"><style type="text/css">div.bbcode {padding: 8px;background: #E5E5E5;color: #000000;border: 1px dashed #B4B4BE;}</style></head><body ><table width=100% cellspacing=0 cellpadding=0><tr ><td class="menubarleft"></td><td class="menubar"><table cellspacing="0" cellpadding="0"><tr ><td >&nbsp;</td><td class="menuitemleft"></td><td class="menuitem"><a href="/" class="menuitem">News</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/forums.php" class="menuitem">Forums</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/codearcs.php" class="menuitem">Code</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/logs.php" class="menuitem">Logs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/gallery.php" class="menuitem">Gallery</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/sdkspecs.php" class="menuitem">Specs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/search.php" class="menuitem">Search</a></td><td class="menuitemright"></td></tr></table></td><td class="menubarright"></td></tr></table><div class="main"><h1 >neighbor search for smooth particle hydrodynamics</h1><a href="forums.php" >Community Forums</a>/<a href="topics.php?forum=61" >Showcase</a>/<a href="#bottom" >neighbor search for smooth particle hydrodynamics</a><br><br>
<a name="1032386"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Nate the Great</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#1">[#1]</a></td></tr></table></td></tr><tr ><td class="posttext"> well I worked on this a while.  It will hopefully be the base of the physics in my future fluid based games.  This has much more realistic fluid physics than before but the most important thing is the neighbor search algorithm.  It is optimized very well and can handle 10,000 particles for me on a single core 2.4 ghz at 20-30 fps.  I compiled it so it shows the console because that is where the statistics are output on number of particles and efficiency of the search algorithm.  It guesses a neighbor correctly 93 to 94 percent of the time which is very good compared to the .024 % guess rate of a brute force algorithm with 3000 particles and the previously 34% guess rate of the grid algorithm.  Also it is not multithreaded but I plan to tinker with that so maybe I can make it even faster for you multicore users.  As for its use in games, it will run at a decent speed with well over 10,000 particles in a game environment where there are multiple bodies of fluid and not just one because it speeds up the search significantly.  It is a big unstable with too much compression and some random particles go flying but I am working on fixing that at the moment.<br><br>Download it here:<br><br><a href="http://naillproductions.synthasite.com/resources/SPH%20neighbor%20search.zip" target="_blank">http://naillproductions.synthasite.com/resources/SPH%20neighbor%20search.zip</a><br><br>a adds particles<br>space displays statistics<br>left/right click manipulate the fluid <br><br></td></tr></table><br>
<a name="1032390"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Danny</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#2">[#2]</a></td></tr></table></td></tr><tr ><td class="posttext"> Wow, impressive stuff! <br><br></td></tr></table><br>
<a name="1032394"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Serpent</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#3">[#3]</a></td></tr></table></td></tr><tr ><td class="posttext"> very nicely done. <br><br></td></tr></table><br>
<a name="1032396"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Noobody</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#4">[#4]</a></td></tr></table></td></tr><tr ><td class="posttext"> What exactly do you mean with 'guess a neighbour correctly'? Do you mean neighbours that contribute to the particle forces?<br><br>This does sound interesting, since the 34% of the grid method are correct - it's the area of a circle with radius smoothing length divided by the area of a 3*smoothing length square. But on the other hand, the grid method is very efficient considering it's administration cost (filling the grid is very fast, iterating it even faster). How exactly does your method work? I'd like to test it in the SPH code of mine to see how it behaves. 95% sounds promising :)<br><br>As for your fluid, it behaves a bit wierd. It tends to build blobs that grow out of the surface and seems to have no damping, considering the tall splashes at the walls. What SPH approach did you use? <br><br></td></tr></table><br>
<a name="1032435"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >ImaginaryHuman</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#5">[#5]</a></td></tr></table></td></tr><tr ><td class="posttext"> It's pretty sweet, nice and quick, good fluid simulation :-D<br><br>Are you using vertex arrays for your rendering yet? <br><br></td></tr></table><br>
<a name="1032453"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Stevie G</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#6">[#6]</a></td></tr></table></td></tr><tr ><td class="posttext"> Excellent. <br><br></td></tr></table><br>
<a name="1032461"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Nate the Great</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#7">[#7]</a></td></tr></table></td></tr><tr ><td class="posttext"> thanks everybody &amp; noobody haha..<br><br><div class="quote"> Are you using vertex arrays for your rendering yet?  <br></div><br><br>no, I am using gl points but they are all rendered in the same glbegin and glend so I assume they are one 'texture'? someone on the gl forum said that is the fastest way to render 10,000 or more points...<br><br><div class="quote"> What exactly do you mean with 'guess a neighbour correctly'? Do you mean neighbours that contribute to the particle forces? <br></div><br><br>yep, it gives a 'best guess' to the nieghbors that contribute to particle forces<br><br><div class="quote"> This does sound interesting, since the 34% of the grid method are correct - it's the area of a circle with radius smoothing length divided by the area of a 3*smoothing length square. But on the other hand, the grid method is very efficient considering it's administration cost (filling the grid is very fast, iterating it even faster). How exactly does your method work? I'd like to test it in the SPH code of mine to see how it behaves. 95% sounds promising :) <br></div><br><br>yeah its kinda confusing, its basicly a modified grid and its not very oo looking at the moment,  It is interesting how you can easily trade the accuracy for more speed but if you trade too much it explodes.  I am working on making it a simple variable called accuracy that you can change but for now its 3 seperate variables<br><br><div class="quote"> <br>As for your fluid, it behaves a bit wierd. It tends to build blobs that grow out of the surface and seems to have no damping, considering the tall splashes at the walls. What SPH approach did you use?  <br></div><br><br>it is normal sph, unfortunately the neighbor search misses some particles right now, I can easily change the variables so it is 100% accurate at finding all neighbors and misses 34% of the time but that means its not as fast (its still fast enough to use in a game though).  About half way between the accuracy of what I put up for download and the accuracy of a standard grid the difference is almost impossible to tell and the grid is much harder to see.<br><br>It is going to be great for games but since it misses some neighbors (depending on how accurate it is) it is not good to create simulations for careful analysis from sph experts ;)  I might be able to clean it up and post the code in a week or so but I am on vacation right now so pardon my lazyness. :)<br><br>edit oops percents are calculated wrong thats ironic... <br><br>x = missed guesses per particle<br>y = neighbors per particle<br><br>it shows (1-x/y)*100<br><br>it should be (1-x/(y+x))*100<br><br>so that means it misses 94 percent of the time, not 93 haha.. it makes a big difference for lower percentages though. <br><br></td></tr></table><br>
<a name="1032493"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Nate the Great</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#8">[#8]</a></td></tr></table></td></tr><tr ><td class="posttext"> ok here is how it works, it was too hard to explain clearly so I drew some pictures in ms paint :)<br><br>key-<br>black lines = grid cell<br>red dot = particle<br>blue radius = radius of support<br>green radius = 2* blue radius<br>blue dot = cell that is considered neighboring<br><br>here is how a normal grid works:<br>each particle in each grid cell is tested for collisions with particles in its grid cell and particles in neighboring grid cells like this<br><img src="http://nathansfiles.synthasite.com/resources/grid1.png"><br><br>I decided it would be better to divide the grid up more and save some calculations by only calculating the grids in a rough circle around the center grid cell, this is slightly inaccurate because as you can see there are places where particles can be missed but there are also places where particles can be considered that are not really options...<br><img src="http://nathansfiles.synthasite.com/resources/grid2.png"><br><br>Then I decided to sacrifice another level of accuracy for fewer 'misses' but more particles not considered, this leads to worse grid artifacts and is what is in the download above.  So a few particles are missed for speed but I am not sure if I want to use this method which can easily be scaled to be more or less accurate or the above method which takes a little more cpu time or the normal grid method which is the slowest.<br><img src="http://nathansfiles.synthasite.com/resources/grid3.png"><br><br>Its nothing ground breaking or special but its fun to see that many particles not to mention I need that many for my game ideas and when your playing a game it is much harder to notice grid artifacts and odd clumping when the fluids are in constant motion so I believe this method is great for games, not so much for other things. in order here are how many particles I can get with each method,<br><br>normal grid - 3000<br>smaller accurate grid - 6000<br>smaller less accurate grid - 9000 <br><br></td></tr></table><br>
<a name="1032510"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >_Skully</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#9">[#9]</a></td></tr></table></td></tr><tr ><td class="posttext"> Hi Nathan,<br><br>This confuses me as to why its faster to use this "approximation".. perhaps its in the algorithm<br><br>If you are using the cells to determine proximity influences and therefore have a list of the "particles" in each cell, then I would assume you are using a distance formula to filter out particles over a certain distance when parsing the list.<br><br>Does calculating the distance formula save that much time... how complex are the fluid calculations? <br><br></td></tr></table><br>
<a name="1032519"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Nate the Great</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#10">[#10]</a></td></tr></table></td></tr><tr ><td class="posttext"> hey skully<br><br>it is faster because it doesnt test as many particles that actually arent neighbors at all as apposed to normal grids, I hope that makes sense but I dont exactly understand what you are asking. <br><br></td></tr></table><br>
<a name="1032544"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >ImaginaryHuman</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#11">[#11]</a></td></tr></table></td></tr><tr ><td class="posttext"> You should try using vertex arrays, it could double the speed. glBegin/End is not usually as fast because there is lots of function call overhead.<br><br>Also things all being on one texture has nothing to do with your glBegin/End except that everything within the glBegin/End MUST use the current texture since you can't swap textures while defining geometry. So, yah. <br><br></td></tr></table><br>
<a name="1032547"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Nate the Great</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#12">[#12]</a></td></tr></table></td></tr><tr ><td class="posttext"> thanks IH, that shows how little I know about gl ;) <br><br></td></tr></table><br>
<a name="1032552"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >WERDNA</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#13">[#13]</a></td></tr></table></td></tr><tr ><td class="posttext"> Downloading now, this looks awesome :) <br><br></td></tr></table><br>
<a name="1032633"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >ImaginaryHuman</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#14">[#14]</a></td></tr></table></td></tr><tr ><td class="posttext"> Especially since you have a large number of particles, I think the vertex array will help a lot and it's supported in standard OpenGL 1.1 <br><br></td></tr></table><br>
<a name="1032651"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Noobody</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#15">[#15]</a></td></tr></table></td></tr><tr ><td class="posttext"> Oh, then it's a lot simpler than I imagined :)<br><br>The particle misses do contribute to the overall instability, so it's not really an option for me at the moment. Dividing the grid cells into further sub cells is also not a good idea, since I'm already having memory problems with a regular grid (3D, that is). Splitting each cell into more sub cells would burst my RAM.<br><br>Also, I think a big problem is that particles don't have to be centered in a grid cell like in your drawings. If they're near borders, much more neighbours will be left out, leading to discrepancies between particles in the same grid cell, depending on their location inside that cell. An overall calculation error that is the same everywhere in the grid wouldn't be that bad, but errors sensitive to particle disorder are very bad for the overall behaviour of the fluid. I therefore recommend using this new method with care, because the gain in performance is probably not worth the loss in 'realistic-ness'. <br><br></td></tr></table><br>
<a name="1032656"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Nate the Great</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#16">[#16]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> Oh, then it's a lot simpler than I imagined :)<br> <br></div><br><br>but the process of getting to it took a week of messing around with my grid haha then I was like hey this is a lot simpler than I was making it out to be.<br><br><div class="quote"> <br>The particle misses do contribute to the overall instability, so it's not really an option for me at the moment. Dividing the grid cells into further sub cells is also not a good idea, since I'm already having memory problems with a regular grid (3D, that is). Splitting each cell into more sub cells would burst my RAM.<br> <br></div><br><br>ah, I am leaning toward using smaller cells and checking more of them (the middle picture above) but that is because it is for a game and has a limited 2d playing field.  The real advantage of this is that I can adjust the grid size to trade stability for speed which is really what I need for this, if my game doesnt look realistic or starts exploding I crank up the number of cells checked or adjust the grid size.<br><br><div class="quote"> <br>Also, I think a big problem is that particles don't have to be centered in a grid cell like in your drawings. If they're near borders, much more neighbours will be left out, leading to discrepancies between particles in the same grid cell, depending on their location inside that cell. An overall calculation error that is the same everywhere in the grid wouldn't be that bad, but errors sensitive to particle disorder are very bad for the overall behaviour of the fluid. I therefore recommend using this new method with care, because the gain in performance is probably not worth the loss in 'realistic-ness'. <br> <br></div><br><br>yeah I realize that, that is why it is a balancing act, trading speed for stability but I actually cant tell a difference in the realisticness with the method described in the picture in the middle so I am leaning toward that where I can get 6000 unthreaded, I hope blitz max's threading capabilities have improved enough to make it threaded without significant loss of time on the gc...  I also have a previous neighbor list stored in each particle that works quite well and catches some missed particles, unfortunately I havent experimented with that much so its not as fast as I would like it to be to use in the game, overall I am happy with how it is now, I get 6000 particles very easily at a playable framerate, now I have to get viscosity to work, I hit a bump with those equations and it never really got fixed, just left out...<br><br>@ IH<br><br>thanks for the suggestion, I really want to learn how vertex arrays work even though with 10000 particles my render time is 1 ms, ill post in the open gl section sometime this week if I make enough progress to worry about rendering. <br><br></td></tr></table><br>
<a name="1032657"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >slenkar</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#17">[#17]</a></td></tr></table></td></tr><tr ><td class="posttext"> cool demo man <br><br></td></tr></table><br>
<a name="1033592"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Nate the Great</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#18">[#18]</a></td></tr></table></td></tr><tr ><td class="posttext"> Ive been messing around with viscosity and how my goo is going to react with the environment.  I definitely need to make it more gooey but for now its pretty good.  It also takes over anything it touches very quickly which will be an important part of gameplay in flood.<br><br>Vid here <a href="http://www.youtube.com/watch?v=6cBDLcW1ZJI" target="_blank">http://www.youtube.com/watch?v=6cBDLcW1ZJI</a> <br><br></td></tr></table><br>
<a name="1033609"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >ImaginaryHuman</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#19">[#19]</a></td></tr></table></td></tr><tr ><td class="posttext"> Neat, Nate. <br><br></td></tr></table><br>
<a name="1033627"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >slenkar</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#20">[#20]</a></td></tr></table></td></tr><tr ><td class="posttext"> it behaves very much like water now,<br><br>isntead of viral goo, you could do a game based on mixtures, keeping certain elements at certain concentrations. <br><br></td></tr></table><br>
<a name="bottom"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td align="right"><a href="http://monkeycoder.co.nz" target="_blank"><img src="/img/monkey2.svg" ></a> <a href="https://github.com/blitz-research" target="_blank"><img src="/img/github.svg" ></a> <a href="https://discord.gg/qJccbSp" target="_blank"><img src="/img/discord.svg" ></a></td></tr></table><br></div><br><table width="100%"><tr><td></body></html lang="en">
