<!DOCTYPE html><html lang="en" ><head ><title >FreeImage questions</title><meta name='viewport' content='width=device-width, initial-scale=0.66'><meta name='description' content='language:basic, target:desktop, category:game development'><link rel="styleSheet" href="../skins/granite/style.css" type="text/css"><style type="text/css">div.bbcode {padding: 8px;background: #E5E5E5;color: #000000;border: 1px dashed #B4B4BE;}</style></head><body ><table width=100% cellspacing=0 cellpadding=0><tr ><td class="menubarleft"></td><td class="menubar"><table cellspacing="0" cellpadding="0"><tr ><td >&nbsp;</td><td class="menuitemleft"></td><td class="menuitem"><a href="/" class="menuitem">News</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/forums.php" class="menuitem">Forums</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/codearcs.php" class="menuitem">Code</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/logs.php" class="menuitem">Logs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/gallery.php" class="menuitem">Gallery</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/sdkspecs.php" class="menuitem">Specs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/search.php" class="menuitem">Search</a></td><td class="menuitemright"></td></tr></table></td><td class="menubarright"></td></tr></table><div class="main"><h1 >FreeImage questions</h1><a href="forums.php" >BlitzMax Forums</a>/<a href="topics.php?forum=124" >Brucey's Modules</a>/<a href="#bottom" >FreeImage questions</a><br><br>
<a name="971066"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >sswift</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#1">[#1]</a></td></tr></table></td></tr><tr ><td class="posttext"> Hey Brucey, thanks for making that freeimage mod for BlitzMax.  It's gonna be a huge help as I rewrite Seamless Texture Generator in BlitzMax.  (Oops, did I say that out loud?)<br><br><br>I'm trying to find the most optimal way to load images with it, and convert them to a pixmap in PF_RGBA8888 format.  But in the process of trying to figure that out, a few questions about your code have popped up.<br><br>I notice that your LoadPixmap wrapper first loads a FreeTImage, and then copies the pixmap with CopyPixmap.  CopyPixmap however does a memcopy to copy the pixmap.  Is there any reason you don't simply return freeImage.pixmap instead?  I would assume that, even if the freeImage type gets garbage collected, that if you've saved the pointer to the pixmap, the pixmap will remain valid.<br><br><br>Also, I was looking at the freeimage type working out how it loads the image, and I notice you flip the pixmap on the Y axis before returning it.  Is there some reason you do that?  Does freeimage store images internally in a BMP like format?  That seems like an odd choice for them to make!<br><br>I do know that when I used freeimage in BlitzPlus, I didn't need to flip the image.  I notice you're using a number of different conversion functions.  I don't know if those behave differently from the one I used, but this is what I did:<br><br><pre class=code>
; Copy the FI_Image to the Blitz image.
   
        LockBuffer DestImageBuffer
           
            DestImageBank      = LockedPixels(DestImageBuffer)
            DestImagePitch     = LockedPitch(DestImageBuffer)
            DestImageFormat    = LockedFormat(DestImageBuffer)
           
            DestImageDepth     = FIB_BitDepth[DestImageFormat]
            DestimageRedMask   = FIB_RedMask[DestImageFormat]
            DestimageGreenMask = FIB_GreenMask[DestImageFormat]
            DestimageBlueMask  = FIB_BlueMask[DestImageFormat]
           
            FIToBank(DestImageBank, FI_Bitmap, DestImagePitch, DestImageDepth, DestimageRedMask, DestimageGreenMask, DestimageBlueMask, 0)                

        UnlockBuffer DestImageBuffer

Where FIToBank is really defined as:
FIToBank( Bank*,FIBITMAP%,Pitch%,Depth%,Red_Mask%,Green_Mask%,Blue_Mask%,TopDown% ) : "_FreeImage_ConvertToRawBits@32"
</pre><br><br><br>But this is BlitPlus we're talking about, and I suppose it may have been storing the images bottom up since it's written for Win32 only.  That would make sense since I appear to have set the last parameter there to false.  However, I see no reason you could not set that last parameter to true so as to avoid the need to flip the image at the end of your Init() function.<br><br><br>Anyway, I think the most ideal setup would be to always have the images loaded be in top down PF_STDFORMAT (which is PF_RGBA8888, and the format BlitzMax prefers internally, converting back and forth from it to convert other formats) regardless of OS, so that you don't have to do the additonal step of converting it to that format yourself, or putting a bunch of conditional compiles in your code to handle the diferent formats on different OS's.<br><br><br>What are your thoughts on this? <br><br></td></tr></table><br>
<a name="971581"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >sswift</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#2">[#2]</a></td></tr></table></td></tr><tr ><td class="posttext"> Have you taken a look at this Brucey? <br><br></td></tr></table><br>
<a name="971891"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Brucey</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#3">[#3]</a></td></tr></table></td></tr><tr ><td class="posttext"> The "pixmap" is just a visual reference for your BlitzMax application. Otherwise the image data itself is always retained internally as a FreeImage bitmap.<br><br>For LoadPixmap, the reason freeImage.pixmap isn't returned directly, is because the pixmap object belongs to TFreeImage instance, which will be GC'd at some point (spooky, I just looked at the code, and the comment states this almost exactly to the word...shiver)<br>Since LoadPixmap is a simple wrapper (for those who don't care for the underlying image model, the TFreeImage instance is only temporary. The pixmap itself is "static", referencing a specific block of allocated memory. When the TFreeImage instance is GC'd, this "static" memory is also freed - goodbye pixmap data. Therefore we copy it.<br>The reason for using "static" data to create the pixmap, is to forgo an extra copy when the data is already available in the correct format.<br><br>For more advanced use, you access the TFreeImage API directly.<br><br>As you've realised, we need to Y Flip the visual image because it is stored with 0,0 at the bottom left (which I believe is fairly typical), while BlitzMax has 0,0 at the top left.<br>Of course, the FreeImage bitmap data is never modified during any of these conversions.<br><br>Originally, I had the FreeImage bitmap Y-flip, but this obviously wasn't such a great idea, as one should leave base data alone if one can help it.<br><br>Also, you should use getPixmap() to access the pixmap data, since this will refresh if required.<br><br>If you need access to the raw data, GetScanline() will return you a Byte Ptr to the first pixel of a scan line, which you could use to read/write. <br><br></td></tr></table><br>
<a name="971960"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >sswift</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#4">[#4]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> The pixmap itself is "static", referencing a specific block of allocated memory. When the TFreeImage instance is GC'd, this "static" memory is also freed - goodbye pixmap data. Therefore we copy it. <br></div><br><br>Okay, I think I understand what's going on now.  I didn't know it was a static pixmap referencing memory that was freed.  Your comment didn't mention that. <br><br></td></tr></table><br>
<a name="971969"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Brucey</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#5">[#5]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> Your comment didn't mention that.  <br></div><br>It didn't really need to. The comment is only there to remind me, in my old age, why the copy is there at all. :-) <br><br></td></tr></table><br>
<a name="bottom"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td align="right"><a href="http://monkeycoder.co.nz" target="_blank"><img src="/img/monkey2.svg" ></a> <a href="https://github.com/blitz-research" target="_blank"><img src="/img/github.svg" ></a> <a href="https://discord.gg/qJccbSp" target="_blank"><img src="/img/discord.svg" ></a></td></tr></table><br></div><br><table width="100%"><tr><td></body></html lang="en">
