<!DOCTYPE html><html lang="en" ><head ><title >Optimized Collision Grid</title><meta name='viewport' content='width=device-width, initial-scale=0.66'><meta name='description' content='language:basic, target:desktop, category:game development'><link rel="styleSheet" href="../skins/granite/style.css" type="text/css"><style type="text/css">div.bbcode {padding: 8px;background: #E5E5E5;color: #000000;border: 1px dashed #B4B4BE;}</style></head><body ><table width=100% cellspacing=0 cellpadding=0><tr ><td class="menubarleft"></td><td class="menubar"><table cellspacing="0" cellpadding="0"><tr ><td >&nbsp;</td><td class="menuitemleft"></td><td class="menuitem"><a href="/" class="menuitem">News</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/forums.php" class="menuitem">Forums</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/codearcs.php" class="menuitem">Code</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/logs.php" class="menuitem">Logs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/gallery.php" class="menuitem">Gallery</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/sdkspecs.php" class="menuitem">Specs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/search.php" class="menuitem">Search</a></td><td class="menuitemright"></td></tr></table></td><td class="menubarright"></td></tr></table><div class="main"><h1 >Optimized Collision Grid</h1><a href="forums.php" >Monkey Forums</a>/<a href="topics.php?forum=507" >Monkey Programming</a>/<a href="#bottom" >Optimized Collision Grid</a><br><br>
<a name="2035448"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Tibit</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#1">[#1]</a></td></tr></table></td></tr><tr ><td class="posttext"> Anyone know an optimized collision check for thousands of objects on screen? Like a Grid based system?<br><br>If not, anyone who can give some guidelines, tips or wisdom on how to "best" build one? Or links? <br><br></td></tr></table><br>
<a name="2035449"></a>

<a name="2035450"></a>

<a name="2035451"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Nobuyuki</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#2">[#2]</a></td></tr></table></td></tr><tr ><td class="posttext"> how are you checking it now?  Best thing I know is to do an initial sweep to exclude objects from more complex collision detection by first doing an axis-aligned bounding box overlap test, then doing a second collision loop with your "actual" detection, if that second form of detection is more expensive.  Put objects to sleep if they're outside of the game's camera range by a certain margin, too, and don't check those objects.<br><br>Objects which compare collisions against each other can avoid testing for the same collision twice by referencing each object by a number, then having a nested loop whereby the second object to be compared is always a greater number than the first, if I remember correctly.<br><br><br>edit:  beyond that, you can speed up the AABB collision detection by removing conditionals from your loop where possible, as well as making assumptions based off axis distances from box to box.  Logical operators can be your friend here.<br><br>[monkeycode]<br>'Warning:  Uses integers for speed<br>Function DoBoxesIntersect:Bool(ax%, ay%, awidth%, aheight%, bx%, by%, bwidth%, bheight%) <br>   Return (Abs(ax - bx) * 2 &lt; (awidth + bwidth)) And<br>         (Abs(ay - by) * 2 &lt; (aheight + bheight))<br>End Function<br>[/monkeycode] <br><br></td></tr></table><br>
<a name="2035452"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Nobuyuki</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#3">[#3]</a></td></tr></table></td></tr><tr ><td class="posttext"> Now, for grid-based collision, having some sorta bitmask or 2d array may or may not be faster depending on how many objects need to test against this.  Depending on the game, updating the mask could be a larger cost than just doing AABB tests on everything.  However, for collisions with objects against a tilemap, a bitmask or array would be useful.<br><br>A priori collision detection is probably better for your health than an a posteriori one, although it's not always feasible to implement this in your engine in all cases.  Before doing your movement calculations, what you would do is you'd check your object's position in the next frame against the bitmask/array's collision value in there, and if the next position is occupied by a collision tile, either stop the movement, or do a more sophisticated collision check, or process the change in movement from there.<br><br>Each object to check against the mask/array has to have their coordinates converted to the format which exist in it.  For a 2d tile array, that usually just involves floored division.  For a 1d bitmask, it involves that, modulus, and to push/pop stuff in and out,  bitwise operators.  <br><br><b>Long story short:</b>  If you have thousands of sprites (bullet hell shooter?), it's still going to be slow to do all these calculations, but if you have a bunch of non-sprite objects you need to test collisions against, having a tilemap of simple collision metadata's going to make it a lot easier to check against, since you won't be checking 50 zillion tiles individually.  I don't have enough experience on limited hardware to know whether or not actively updating a bitmask with thousands of sprites on it would actually boost efficiency over a properly-looped series of AABB tests or not. <br><br></td></tr></table><br>
<a name="2035453"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Nobuyuki</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#4">[#4]</a></td></tr></table></td></tr><tr ><td class="posttext"> one more thing, since this is outside my field of expertise, but you can reduce the number of checks hypothetically by implementing your data in a quadtree structure.  The wiki article knows more than I do, but I haven't taken the time to read/understand it in a comprehensive way.<br><br><a href="http://en.wikipedia.org/wiki/Quadtree" target="_blank">http://en.wikipedia.org/wiki/Quadtree</a><br><br>If it is true that you have thousands of sprites, all of which need to be checked for collision against one another, and are mostly the same size or can be broken down into equally sized chunks at a large enough scale in a sparse map, then you can reduce the number of checks needed by implementing this.  The performance gain may not be as large as you'd hope for, though, compared to other, easier-to-implement optimizations I mentioned earlier such as not performing collisions on objects that are outside your camera range, even if they're still being checked to see if they're in camera range.<br><br>There is also a technique I've heard of when looking this up for you called spatial hashing, which may be something to look into:<br><br><a href="http://www.gamedev.net/page/resources/_/technical/game-programming/spatial-hashing-r2697" target="_blank">http://www.gamedev.net/page/resources/_/technical/game-programming/spatial-hashing-r2697</a> <br><br></td></tr></table><br>
<a name="2035456"></a>

<a name="2035457"></a>

<a name="2035458"></a>

<a name="2035459"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Tibit</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#5">[#5]</a></td></tr></table></td></tr><tr ><td class="posttext"> Thanks guys!<br><br>Ok let me give more information.<br><br>Right now I do a distance check, pytagoras. I could optimize this by removing the Sqr() and check for radius*radius, however the problem in performance comes from scale I think.<br><br>Is an AABB so much faster than Circle? I tought a grid was a must to optimize this?<br>[monkeycode]<br>'Untested, but something like this is what I do, but using the vector class:<br>Function DoCirclesIntersect:Bool(ax%, ay#, ar#, bx#, by#, br%)<br>   Local dx# = (ax - bx) <br>   Local dy# = (ay - by) <br>   Return (dx*dx + dy*dy) &lt; (ar*ar + br*br)<br>End Function[/monkeycode]<br><br><b>Problem</b><br>So even with 25-150 something monsters and lots of bullets the games starts to get slow.<br><br>I want 1000 to 3000 enemies (or as high as possible anyway)<br><br>I should probably create a measurable performance test (I'll do that and get back with exact numbers). We did find out that html5 and flash can easily draw 3000 jumping teddy bears with high fps, 6000 with slight lag - so the rendering should not be the case I guess?<br><br>Assume 100 monsters and 100 bullets, that means for each bullet I loop the monster list 100 times and check collision. Total collision check 10k?<br><br>I did just realize EachIn creates an enumerator object. I'll go back and test with arrays instead. That might be the right place to look now that I think about it?<br><br>Anyhow, more information on Grid based optimization is appreciated! :D <br><br></td></tr></table><br>
<a name="2035463"></a>

<a name="2035464"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Tibit</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#6">[#6]</a></td></tr></table></td></tr><tr ><td class="posttext"> @Nobuyuki - great link about spatial hasing. That might be what I'm looking for.<br><br>I also found this XNA Article on the subject: <a href="http://conkerjo.wordpress.com/2009/06/13/spatial-hashing-implementation-for-fast-2d-collisions/" target="_blank">http://conkerjo.wordpress.com/2009/06/13/spatial-hashing-implementation-for-fast-2d-collisions/</a> <br><br>I'll test to implement something like that. <br><br></td></tr></table><br>
<a name="2035469"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Gerry Quinn</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#7">[#7]</a></td></tr></table></td></tr><tr ><td class="posttext"> Another method along the same lines might be to divide the screen into small squares, and have objects in each cell check for collisions with objects in 1 - 4 squares total, depending on where the object is in its square.  If it's in the middle, it only cares about objects in the same square, if it's near a corner it has to check its own square and the three that touch it at that corner. <br><br></td></tr></table><br>
<a name="2035481"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Tibit</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#8">[#8]</a></td></tr></table></td></tr><tr ><td class="posttext"> Gerry do you know any links to resources on that? Or what the technique is called?<br><br>I was thinking along those lines myself, however I feel like the grid size in comparison to the entities is probably of great importance. The grid should probably be many times bigger than the sprite. I guess only dividing the screen into 4-16 sections could be enough even for quite large maps, with even spread of units it should reduce the hit checks a lot.<br><br>In theory. If 100 monsters are checked against 100 monsters (crowd collision)  then we have 10k checks. Plus we have bullets and terrain, let us say 50 more objects resulting in 5k more checks.<br><br>With even spread over 9 gridcells. In avg that is 11 units/square. That means in each cell we check 11 units against 11 = 121 checks. That x9 = 1089 checks.<br><br>So with only 9 cells 15k checks is reduced to 1k checks. Plus some extra for borders. But this must work. <br><br></td></tr></table><br>
<a name="2035491"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >OvineByDesign</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#9">[#9]</a></td></tr></table></td></tr><tr ><td class="posttext"> Another good technique which we use is spacial hashing :-<br><br><a href="http://conkerjo.wordpress.com/2009/06/13/spatial-hashing-implementation-for-fast-2d-collisions/" target="_blank">http://conkerjo.wordpress.com/2009/06/13/spatial-hashing-implementation-for-fast-2d-collisions/</a> <br><br></td></tr></table><br>
<a name="2035492"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >NoOdle</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#10">[#10]</a></td></tr></table></td></tr><tr ><td class="posttext"> quad trees can be also be used for used for speeding up collision checking on lots of objects. Heres an article that might help explain how they work, I believe the source is also included if you wanted to have a peek before implementing your own. <a href="http://www.kyleschouviller.com/wsuxna/quadtree-source-included/" target="_blank">http://www.kyleschouviller.com/wsuxna/quadtree-source-included/</a> <br><br></td></tr></table><br>
<a name="2035498"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Gerry Quinn</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#11">[#11]</a></td></tr></table></td></tr><tr ><td class="posttext"> Hi Tibit,<br><br>I don't know what the technique is called.  I haven't used it myself but I thought up the algorithm in connection with an open-world RPG concept. <br><br>I agree that the grid size is important, but I think it should probably be small compared to the screen, otherwise there is not much benefit.  It must be at least twice the size of the sprite on each dimension (assuming the sprites are all the same size).  That way a sprite can only be colliding with sprites whose centres are in the same square or the four nearest ones.  <br><br>[A sprite in a nearby square can jut into this square by its own radius, and the sprite we are testing can be another radius away, so a sprite in a square is safe from collisions with any square whose nearest border is more than a sprite size away.]<br><br>So I would make the squares only about three or four times the diameter of the largest sprite.  And if there are some very large sprites I would treat them as special cases rather than make the squares very large.<br><br>You can always make it a variable and see what gives the best performance.<br><br>Also, if you are checking all collisions every frame, you should only check each pair of sprites once.  The easiest way to do this is to only test each sprite against sprites that come after it (in whatever sequence you happen to have them ordered).  So 100 monsters is only 99 + 98 + 97 +... = 4950 collisions.  The squares algorithm doesn't make any difference to this. <br><br></td></tr></table><br>
<a name="2035554"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >matty</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#12">[#12]</a></td></tr></table></td></tr><tr ><td class="posttext"> Yes...use a grid, only check for collisions when something moves, only check an entity's own grid square and the surrounding grid squares, make the grid squares comparable size to your entities, also only update the grid square when something moves in/out of it...should be able to have lots of entities running around at once..I use this technique all the time. <br><br></td></tr></table><br>
<a name="2035556"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >wiebow</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#13">[#13]</a></td></tr></table></td></tr><tr ><td class="posttext"> Here is a quadtree I have made for blitzmax. You can convert it to Monkey pretty easily I guess, or I might have a go myself. :)<br><br><a href="http://code.google.com/p/noisycode/source/browse/#hg%2Fwdw.mod%2Fquadtree.mod" target="_blank">http://code.google.com/p/noisycode/source/browse/#hg%2Fwdw.mod%2Fquadtree.mod</a> <br><br></td></tr></table><br>
<a name="2035565"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Ferdi</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#14">[#14]</a></td></tr></table></td></tr><tr ><td class="posttext"> FYI, if I am not wrong, Flixel Monkey uses quadtree to check for collision, last time I read the code.<br><br>Oh yep, it is in flxg.monkey, and look for the function "Function Overlap:Bool".<br><br>There are some neat stuff in there.  devolonter did a great job on it. <br><br></td></tr></table><br>
<a name="2035570"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Gerry Quinn</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#15">[#15]</a></td></tr></table></td></tr><tr ><td class="posttext"> It might even be most efficient to make the squares only slightly larger than a sprite and always check nine squares.  Easier to code too. <br><br></td></tr></table><br>
<a name="2035596"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >NoOdle</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#16">[#16]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> It might even be most efficient to make the squares only slightly larger than a sprite and always check nine squares. Easier to code too. <br></div><br>wouldn't this fail if one of the sprites was much larger than the grid square? It could reside outside of the grid but extend far enough to intersect with the sprite in question. <br><br></td></tr></table><br>
<a name="2035601"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Gerry Quinn</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#17">[#17]</a></td></tr></table></td></tr><tr ><td class="posttext"> Yes.  The grid squares must be as large as the largest sprite.  It will work best if all sprites are similar in size, which should often be the case.<br><br>If there are some large sprites, I would treat them as special cases.  You could place them first in your sprite list (so smaller sprites will never have to worry about them) and test collisions against sprites in an appropriate number of squares (e.g. they might need testing against ordinary sprites in 25 squares and big sprites in 49 squares).<br><br>The grid algorithm is really designed for the case where you have hundreds of little sprites swarming around. <br><br></td></tr></table><br>
<a name="2035617"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Tibit</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#18">[#18]</a></td></tr></table></td></tr><tr ><td class="posttext"> The code to the spatial hasing example in XNA does not seem to work :(<br><br>Would have been great to convert that otherwise.<br><br>Yes, I'll look into making a simple fixed size grid I think. But how do I do with the arrays, if I have one array per cell - I guess that I can size the array according to the size of the cell in relation to how many units can occupy it at once.<br><br>And always check all border cells. Seems sensible :)<br><br>Tough in this game my enemies are different in size, and that is pretty cool.  But I assume the biggest ones can still match the cells. <br><br></td></tr></table><br>
<a name="2035637"></a>

<a name="2035638"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Dima</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#19">[#19]</a></td></tr></table></td></tr><tr ><td class="posttext"> simple quad tree could be the game world divided into a grid of huge cells like 6x6, then each huge cell contains another set of smaller 6x6 cells, etc... until you reach desired granularity.  You could potentially represent huge worlds with complex interactions but have to watch garbage collectors. <br><br></td></tr></table><br>
<a name="2035684"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Gerry Quinn</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#20">[#20]</a></td></tr></table></td></tr><tr ><td class="posttext"> If you wanted to be fancy, you could make a decent sized array for each cell, plus an overflow list for when the array is full.  If your lists get used often, make the arrays bigger.<br><br>I think sprite size ordering is the way to go if you have a big range of sizes.  Perhaps sprites of a certain size use a pseudo-grid that is bigger than the standard grid, i.e. each big grid cell contains a square block of ordinary cells lumped together.  Easy enough to code without actually using large cells. <br><br></td></tr></table><br>
<a name="2035714"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Tibit</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#21">[#21]</a></td></tr></table></td></tr><tr ><td class="posttext"> Dima that sound like a great way for really large worlds. Atm my world is quite small (slightly larger than screen).<br><br>Still haven't found a perfect solution here. I'll report back if I do. <br><br>And Thanks everyone for the input so far. <br><br></td></tr></table><br>
<a name="bottom"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td align="right"><a href="http://monkeycoder.co.nz" target="_blank"><img src="/img/monkey2.svg" ></a> <a href="https://github.com/blitz-research" target="_blank"><img src="/img/github.svg" ></a> <a href="https://discord.gg/qJccbSp" target="_blank"><img src="/img/discord.svg" ></a></td></tr></table><br></div><br><table width="100%"><tr><td></body></html lang="en">
