<!DOCTYPE html><html lang="en" ><head ><title >Async image loading</title><meta name='viewport' content='width=device-width, initial-scale=0.66'><meta name='description' content='language:basic, target:desktop, category:game development'><link rel="styleSheet" href="../skins/granite/style.css" type="text/css"><style type="text/css">div.bbcode {padding: 8px;background: #E5E5E5;color: #000000;border: 1px dashed #B4B4BE;}</style></head><body ><table width=100% cellspacing=0 cellpadding=0><tr ><td class="menubarleft"></td><td class="menubar"><table cellspacing="0" cellpadding="0"><tr ><td >&nbsp;</td><td class="menuitemleft"></td><td class="menuitem"><a href="/" class="menuitem">News</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/forums.php" class="menuitem">Forums</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/codearcs.php" class="menuitem">Code</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/logs.php" class="menuitem">Logs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/gallery.php" class="menuitem">Gallery</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/sdkspecs.php" class="menuitem">Specs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/search.php" class="menuitem">Search</a></td><td class="menuitemright"></td></tr></table></td><td class="menubarright"></td></tr></table><div class="main"><h1 >Async image loading</h1><a href="forums.php" >Monkey Forums</a>/<a href="topics.php?forum=507" >Monkey Programming</a>/<a href="#bottom" >Async image loading</a><br><br>
<a name="2039917"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Anatol</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#1">[#1]</a></td></tr></table></td></tr><tr ><td class="posttext"> Hi all,<br><br>I'm just trying to find a way to replace normal image loading with async loading. It works fine with Mark's sample on <a href="http://marksibly.blogspot.co.nz/2012/09/ok-this-got-bit-longwinded-so-its_14.html" target="_blank">http://marksibly.blogspot.co.nz/2012/09/ok-this-got-bit-longwinded-so-its_14.html</a> , but the problem there is that an image field also needs to be in the OnLoadImageComplete method. That's a bit inconvenient. So I'm trying to replace the usual LoadImage with some async workaround.<br><br>I tried the following:<br>[monkeycode]<br>Strict<br><br>Import mojo<br><br>Function Main:Int()<br>	New AsyncTestApp<br>	Return 0<br>End<br><br>Class AsyncTestApp Extends App Implements IOnLoadImageComplete<br>	<br>	Field testImage:Image<br>	Field asyncImages:StringMap&lt;Image&gt;<br>	<br>	Method OnCreate:Int()<br>		SetUpdateRate(60)<br>		asyncImages = New StringMap&lt;Image&gt;<br>		<br>		testImage = LoadImage("myimage.png")<br>		Return 0<br>	End<br>	<br>	Method LoadImage:Image(path$, frames%=1, flags%=Image.DefaultFlags)<br>		Local image:Image = null<br>		asyncImages.Add(path, image)<br>		LoadImageAsync(path, frames, flags, Self)<br>		Return image<br>	End<br>	<br>	Method OnLoadImageComplete:Void(image:Image, path$, source:IAsyncEventSource)<br>		If image Then asyncImages.Set(path, image) ' works but doesn't change testImage <br>		'If image Then asyncImages.Get(path) = image ' error message: cannot convert from image to string<br>	End<br>	<br>	Method OnUpdate:Int()<br>		UpdateAsyncEvents()<br>		Return 0<br>	End<br>	<br>	Method OnRender:Int()<br>		Cls()<br>		' works<br>		If asyncImages.Get("myimage.png") Then DrawImage(asyncImages.Get("myimage.png"), 0, 0)<br>		<br>		' doesn't work<br>		If testImage Then DrawImage(testImage, 100, 0)<br>		Return 0<br>	End<br>	<br>End<br>[/monkeycode]<br><br>So basically I store async images in a StringMap and I don't need to worry about including individual images into OnLoadImageComplete.<br><br>I would, however, much prefer to be able to use the testImage Field, e.g.<br>[monkeycode]<br>DrawImage(testImage, 0, 0)<br>[/monkeycode]<br>than<br>[monkeycode]<br>DrawImage(asyncImages.Get("myimage.png")) ' this works<br>[/monkeycode]<br><br>So I think something in my OnLoadImageComplete method should be different to achieve this, but I just don't find a solution. I'm not very surprised that my code doesn't update testImage when the image is loaded, but any other method I tried failed completely.<br><br>I would appreciate any help. Maybe I'm completely on the wrong track.<br><br>Thanks!<br>Anatol <br><br></td></tr></table><br>
<a name="2039194"></a>

<a name="2039195"></a>

<a name="2039918"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Anatol</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#2">[#2]</a></td></tr></table></td></tr><tr ><td class="posttext"> OK, this is not really what I was looking for, but I'm loading async resources like this for now, unless I find a better way.<br><br>[monkeycode]<br>Strict<br><br>Import mojo<br><br>Function Main:Int()<br>	New AsyncTestApp<br>	Return 0<br>End<br><br>Class AsyncTestApp Extends App Implements IOnLoadImageComplete, IOnLoadSoundComplete<br>	<br>	Field asyncImages:StringMap&lt;Image&gt;<br>	Field asyncSounds:StringMap&lt;Sound&gt;<br>	<br>	Method OnCreate:Int()<br>		SetUpdateRate(60)<br>		asyncImages = New StringMap&lt;Image&gt;<br>		asyncSounds = New StringMap&lt;Sound&gt;<br>		<br>		LoadImageAsync("myimage.png")<br>		LoadSoundAsync("mysound.ogg")<br>		Return 0<br>	End<br>	<br>	Method AllAsyncImagesLoaded:Bool()<br>		For Local image:= Eachin asyncImages.Values()<br>			If Not image Then Return False<br>		Next<br>		Return True<br>	End<br>	<br>	Method AllAsyncSoundsLoaded:Bool()<br>		For Local sound:= Eachin asyncSounds.Values()<br>			If Not sound Then Return False<br>		Next<br>		Return True<br>	End<br>	<br>	Method AllAsyncResourcesLoaded:Bool()<br>		Return AllAsyncImagesLoaded() And AllAsyncSoundsLoaded()<br>	End<br>	<br>	Method LoadImageAsync:Void(path$, frames%=1, flags%=Image.DefaultFlags)<br>		If asyncImages.Contains(path) Then Return ' the image is already in the LoadImageAsync map<br>		asyncImages.Add(path, null)<br>		asyncloaders.LoadImageAsync(path, frames, flags, Self)<br>	End<br>	<br>	Method LoadSoundAsync:Void(path$)<br>		If asyncSounds.Contains(path) Then Return ' the sound is already in the LoadSoundAsync map<br>		asyncSounds.Add(path, Null)<br>		asyncloaders.LoadSoundAsync(path, Self)<br>	End<br>	<br>	Method OnLoadImageComplete:Void(image:Image, path$, source:IAsyncEventSource)<br>		If image Then asyncImages.Set(path, image) <br>	End<br>	<br>	Method OnLoadSoundComplete:Void(sound:Sound, path$, source:IAsyncEventSource)<br>		If sound Then asyncSounds.Set(path, sound) <br>	End<br>	<br>	Method DrawAsyncImage:Void(path$, x#, y#)<br>		If asyncImages.Get(path) Then DrawImage(asyncImages.Get(path), x, y)<br>	End<br>	<br>	Method PlayAsyncSound:Void(path$, channel%=0, flags%=0)<br>		If asyncSounds.Get(path) Then PlaySound(asyncSounds.Get(path), channel, flags)<br>	End<br>	<br>	Method OnUpdate:Int()<br>		UpdateAsyncEvents()<br>		If AllAsyncResourcesLoaded()<br>			If TouchDown() Then PlayAsyncSound("mysound.ogg")<br>		EndIf<br>		Return 0<br>	End<br>	<br>	Method OnRender:Int()<br>		Cls()<br>		DrawAsyncImage("myimage.png", 0, 0)<br>		Return 0<br>	End<br>	<br>End<br>[/monkeycode]<br><br>Ideally I wanted to get some code that's somewhat "backwards compatible" to the usual DrawImage with an image field so that I don't need to go through all my code and change it.<br><br>But this also works well and saves me to declare Fields for every image and sound as these get simply added to the StringMaps asyncImages and asyncSounds. A positive side effect is that any image/sound that's already in these maps won't get loaded twice.<br><br>This is just some quick code (but it works) and may well need some refinement, e.g. a method that returns True at the moment that all resources have completed loading - that would be helpful to start playing any background music or to start rendering a scene only when all resources are available.<br><br>If anyone comes up with a way to use Fields as with non-async images please do post it. <br><br></td></tr></table><br>
<a name="2039341"></a>

<a name="2039340"></a>

<a name="2039919"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Anatol</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#3">[#3]</a></td></tr></table></td></tr><tr ><td class="posttext"> And another post on this subject. The code below is also not perfect but seems to work well without the need for a StringMap. It has the OnLoadImageComplete() method in an AsyncImage Class.<br><br>The sample code below loads a "normal" image and one image that's loaded asynchronously with LoadImage(), DrawImage() and LoadAsyncImage(), DrawAsyncImage() respectively.<br><br>[monkeycode]<br>Strict<br><br>Import mojo<br><br>Function Main:Int()<br>	New AsyncTestApp<br>	Return 0<br>End<br><br>Class AsyncTestApp Extends App<br>	<br>	Field normalImage:Image<br>	Field asyncImage:AsyncImage<br>	<br>	Method OnCreate:Int()<br>		SetUpdateRate(60)<br>		normalImage = LoadImage("myimage.png")<br>		asyncImage = LoadAsyncImage("myasyncimage.png")<br>		Return 0<br>	End<br>	<br>	Method OnUpdate:Int()<br>		UpdateAsyncEvents()<br>		Return 0<br>	End<br>	<br>	Method OnRender:Int()<br>		Cls()<br>		DrawImage(normalImage, 0, 0)<br>		DrawAsyncImage(asyncImage, 100, 0)<br>		'asyncImage.Draw(100, 0) ' alternative to the line above<br>		Return 0<br>	End<br>	<br>End<br><br>Class AsyncImage Implements IOnLoadImageComplete<br>	<br>	Private<br>	<br>	Field image:Image<br>	<br>	<br>	Public<br>	<br>	Method Initialize:AsyncImage(path$, nframes%, iflags%)<br>		LoadImageAsync(path, nframes, iflags, Self)<br>		Return Self<br>	End<br>	<br>	Method OnLoadImageComplete:Void(_image:Image, path$, source:IAsyncEventSource)<br>		 image = _image<br>	End<br>	<br>	Method Draw:Void(x#, y#, frame%=0)<br>		If image And image.Loaded() Then graphics.DrawImage(image, x, y, frame)<br>	End<br>	<br>	Method Draw:Void(x#, y#, rotation#, scaleX#, scaleY#, frame%=0)<br>		If image And image.Loaded() Then graphics.DrawImage(image, x, y, rotation, scaleX, scaleY, frame)<br>	End<br>	<br>	' duplicating methods from Image class below (this needs to be updated if the Image class changes in a future release)<br>	<br>	Method Width:Int()<br>		Return image.Width()<br>	End<br><br>	Method Height:Int()<br>		Return image.Height()<br>	End<br>	<br>	Method Loaded:Int()<br>		Return image.Loaded()<br>	End<br>	<br>	Method Frames:Int()<br>		Return image.Frames()<br>	End<br>	<br>	Method Flags:Int()<br>		Return image.Flags()<br>	End<br><br>	Method HandleX:Float()<br>		Return image.HandleX()<br>	End<br>	<br>	Method HandleY:Float()<br>		Return image.HandleY()<br>	End<br>	<br>	Method GrabImage:Image(x%, y%, width%, height%, frames%=1, flags%=DefaultFlags)<br>		Return image.GrabImage(x, y, width, height, frames, flags)<br>	End<br>	<br>	Method SetHandle:Int(tx#, ty#)<br>		image.SetHandle(tx, ty)<br>		Return 0<br>	End<br>	<br>	Method Discard:Void()<br>		image.Discard()<br>	End<br>	<br>	Method WritePixels:Void(pixels%[], x#, y#, width#, height#, offset#=0, pitch#=0)<br>		image.WritePixels(pixels, x, y, width, height, offset, pitch)<br>	End<br>	<br>End<br><br>Function LoadAsyncImage:AsyncImage(path$, frameCount%=1, flags%=Image.DefaultFlags)<br>	If path = "" Then Return null<br>	Return (New AsyncImage).Initialize(path, frameCount, flags)<br>End<br><br>Function DrawAsyncImage:Void(asyncImage:AsyncImage, x#, y#, frame%=0)<br>	If asyncImage Then asyncImage.Draw(x, y, frame)<br>End<br><br>Function DrawAsyncImage:Void(asyncImage:AsyncImage, x#, y#, rotation#, scaleX#, scaleY#, frame%=0)<br>	If asyncImage Then asyncImage.Draw(x, y, rotation, scaleX, scaleY, frame)<br>End<br>[/monkeycode]<br><br>I would much prefer to have the AsyncImage class extend Image, <br><br>[monkeycode]<br>Class AsyncImage Extends Image Implements IOnLoadImageComplete<br>[/monkeycode]<br><br>which would probably allow to use the regular DrawImage() function with AsyncImage. However, I didn't find a way to do that because there are too many private Fields in Image class that I would need in AsyncImage.OnLoadImageComplete(), and I can't just do something like<br><br>[monkeycode]<br>Method OnLoadImageComplete:Void(_image:Image, path$, source:IAsyncEventSource)<br>	Self = (AsyncImage)_image ' bad idea<br>End<br>[/monkeycode]<br><br>Anyway, any other input here would be great! Maybe I'm completely overlooking another and much easier solution. <br><br></td></tr></table><br>
<a name="2039587"></a>

<a name="2039584"></a>

<a name="2039585"></a>

<a name="2039583"></a>

<a name="2039582"></a>

<a name="2039903"></a>

<a name="2039904"></a>

<a name="2039905"></a>

<a name="2039906"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >AdamRedwoods</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#4">[#4]</a></td></tr></table></td></tr><tr ><td class="posttext"> there are several ways to go about this.<br><br>this is the easiest way:<br>[monkeycode]<br>Class AsyncImage Implements IOnLoadImageComplete<br>   <br>   Field image:Image<br>   Field loaded:Bool = false<br>   <br>   Method OnLoadImageComplete(_image:Image, path$, source:IAsyncEventSource)<br>      image = _image<br>      loaded = true<br>   End<br>End<br><br>'' ...etc...<br>Field puppy:AsyncImage = New AsyncImage<br><br>Method OnRender()<br>    '' you can check each image, or use a global ALL_IMAGES_LOADED<br>    If Not puppy.loaded Then Return<br><br>    DrawImage puppy.image,x,y<br>End<br>[/monkeycode]<br><br>I know what you're going after, but ideally you'd Extend Image and assign surface to the new surface-- but since it's private we can't do that.<br><br>Optimally, I'd create a resource manager and keep the Image Fields in that (ie. DrawImage MyImages.puppy) so when the file is loaded, it is assigned. Similar to what you have above. <br><br></td></tr></table><br>
<a name="2039912"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Anatol</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#5">[#5]</a></td></tr></table></td></tr><tr ><td class="posttext"> Thanks for the reply, Adam. Yes, the private surface Field is the main problem to extend the Image class.<br><br>Another "convenience option" with the AsyncImage class as above is to add a few DrawImage methods to the App class, that would then be called instead of the DrawImage function:<br>[monkeycode]<br>Class MyApp Extends App<br>	'Method OnCreate:Int(), etc.<br>	<br>	Method DrawImage:Void(image:Image, x#, y#, frame%=0)<br>		graphics.DrawImage(image, x, y, frame)<br>	End<br>	<br>	Method DrawImage:Void(image:Image, x#, y#, rotation#, scaleX#, scaleY#, frame%=0)<br>		graphics.DrawImage(image, x, y, rotation, scaleX, scaleY, frame)<br>	End<br>	<br>	Method DrawImage:Void(asyncImage:AsyncImage, x#, y#, frame%=0)<br>		If asyncImage.image And asyncImage.image.Loaded() Then graphics.DrawImage(asyncImage.image, x, y, frame)<br>	End<br>	<br>	Method DrawImage:Void(asyncImage:AsyncImage, x#, y#, rotation#, scaleX#, scaleY#, frame%=0)<br>		If asyncImage.image And asyncImage.image.Loaded() Then graphics.DrawImage(asyncImage.image, x, y, rotation, scaleX, scaleY, frame)<br>	End<br>End<br>[/monkeycode]<br><br>But again, these are just workarounds for a "proper" extension of the Image class.<br><br>I'm using a resources manager which is quite important for my project, I'm just trying to keep the forum posts focused on the problem.<br>Cheers!<br><br>(Ah! I just discovered the forum tag "monkeycode" in square brackets!) <br><br></td></tr></table><br>
<a name="2039908"></a>

<a name="2039909"></a>

<a name="2039910"></a>

<a name="2039911"></a>

<a name="bottom"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td align="right"><a href="http://monkeycoder.co.nz" target="_blank"><img src="/img/monkey2.svg" ></a> <a href="https://github.com/blitz-research" target="_blank"><img src="/img/github.svg" ></a> <a href="https://discord.gg/qJccbSp" target="_blank"><img src="/img/discord.svg" ></a></td></tr></table><br></div><br><table width="100%"><tr><td></body></html lang="en">
