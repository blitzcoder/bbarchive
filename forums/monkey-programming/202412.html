<!DOCTYPE html><html lang="en" ><head ><title >Need good reference for matrix commands (order)</title><meta name='viewport' content='width=device-width, initial-scale=0.66'><meta name='description' content='language:basic, target:desktop, category:game development'><link rel="styleSheet" href="../skins/granite/style.css" type="text/css"><style type="text/css">div.bbcode {padding: 8px;background: #E5E5E5;color: #000000;border: 1px dashed #B4B4BE;}</style></head><body ><table width=100% cellspacing=0 cellpadding=0><tr ><td class="menubarleft"></td><td class="menubar"><table cellspacing="0" cellpadding="0"><tr ><td >&nbsp;</td><td class="menuitemleft"></td><td class="menuitem"><a href="/" class="menuitem">News</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/forums.php" class="menuitem">Forums</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/codearcs.php" class="menuitem">Code</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/logs.php" class="menuitem">Logs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/gallery.php" class="menuitem">Gallery</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/sdkspecs.php" class="menuitem">Specs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/search.php" class="menuitem">Search</a></td><td class="menuitemright"></td></tr></table></td><td class="menubarright"></td></tr></table><div class="main"><h1 >Need good reference for matrix commands (order)</h1><a href="forums.php" >Monkey Forums</a>/<a href="topics.php?forum=507" >Monkey Programming</a>/<a href="#bottom" >Need good reference for matrix commands (order)</a><br><br>
<a name="2023906"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >AaronK</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#1">[#1]</a></td></tr></table></td></tr><tr ><td class="posttext"> Hi guys. I'm trying to do a simple 2D scene graph implementation and am in some confusion over the matrix commands in Monkey (Scale, Translate, Rotate mainly). What order are these things applied in because it seems that they are applied in reverse order of execution?  For instance I expect:<br><br>Rotate angle<br>Translate x,y<br><br>To rotate my object around it's origin, then move it somewhere into world space. However it seems I have to do the opposite. The opposite to me seems like it would move the object into world space, then rotate the entire object around the origin.<br><br>I'm starting to think that I can use this to easily add the final projection into the screen, but how I was initially thinking of it it was going to require an extra step of that final projection (Multiplying by the final projection matrix). How do you guys handle the screen projection? NOTE: I'm only concerned about 2d here.<br><br>Anyway, are there any good references on this anywhere? <br><br></td></tr></table><br>
<a name="2023908"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >JIM</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#2">[#2]</a></td></tr></table></td></tr><tr ><td class="posttext"> Imagine all you commands are relative to the screen coordinate system.<br>Now imagine your image on the screen.<br><br>If you rotate, your image will rotate (relative to the screen).<br>If you translate, the image will move (after being rotated)<br>If you then scale, it will scale everything.<br><br>If you want to rotate your image on a circle, translate it first.<br>Then, when rotating (relative to the screen) the translation will be included in the transformation.<br><br>If you have a good understanding of transformation matrices you'll understand this better:<br><br>You work in world space.<br>If you start with the identity matrix, rotating will include the translation (which is 0). Translating will not alter the rotation, so your object, already rotated, gets translated. <br><br></td></tr></table><br>
<a name="2023923"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >AdamRedwoods</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#3">[#3]</a></td></tr></table></td></tr><tr ><td class="posttext"> Apple has pretty good info:<br><a href="https://developer.apple.com/library/mac/#documentation/GraphicsImaging/Conceptual/drawingwithquartz2d/dq_affine/dq_affine.html#//apple_ref/doc/uid/TP30001066-CH204-SW1" target="_blank">https://developer.apple.com/library/mac/#documentation/GraphicsImaging/Conceptual/drawingwithquartz2d/dq_affine/dq_affine.html#//apple_ref/doc/uid/TP30001066-CH204-SW1</a><br><br><br><b>Mojo rotation does not effect translation, but translation effects rotation and scale.</b><br>This is so images can use HandleX(), HandleY() to rotate around a different origin point. In my opinion, it doesn't HAVE to be this way, but it is correct methodology when using a Transform() command for affine transformations.<br><br>Perhaps a Position(x,y) command would be more useful (faster?) than a Translate(x,y) command. You can make this yourself and get around Transform() by setting the X,Y directly into the matrix without multiplying:<br><pre class=code>
Local mat:Float[] = GetMatrix()
SetMatrix (mat[0],mat[1],mat[2],mat[3],mat[4],x,y)
</pre><br><br>I believe the terminology behind these two methods, methods being Position or Translation, (in 3D at least) is multiplying the matrix by a vector or by a point.<br><br><br>Also for reference, I wrote up Transform() docs here (and maybe I should write up in the monkey wiki):<br><a href="http://monkeycoder.co.nz/Community/posts.php?topic=1098&amp;" target="_blank">http://monkeycoder.co.nz/Community/posts.php?topic=1098&amp;</a> <br><br></td></tr></table><br>
<a name="2023916"></a>

<a name="2023915"></a>

<a name="2023914"></a>

<a name="2023913"></a>

<a name="2023911"></a>

<a name="2023912"></a>

<a name="2023920"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >AaronK</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#4">[#4]</a></td></tr></table></td></tr><tr ><td class="posttext"> Hi guys, thanks for the input. That Apple link does clear things up a bit. I noticed on that page their example of Rotate, Scale, Translate actually had the scale affecting the translate. When they translated 1/4 the screen across the previous scale means the translation was actually much smaller in physical space. <br><br>I also see there's an Affine Transformation which is something different to the CTM. I assume now that Scale, Rotate, Translate work on the CTM and Transform creates an Affine Transformation and applies it to the CTM?<br><br>Adam, in your explanation of Transform (see below) you have the * scale in brackets. Is there a reason? Do I need to ignore that when pluggin in values? I can't see why a scale factor would affect rotation?<br><br>iy = rotation -sin(a) (* scale)<br>jx = rotation sin(a) (* scale)<br><br><br>And finally, I think I'm misreading this from your reply<br>"Mojo rotation does not effect translation, but translation effects rotation"<br><br>Because as I mentioned in my original post I'm finding that when I Translate, then Rotate I actually get rotation around the object origin (Not around the translated origin) which seems to me like Translation is not affecting rotation, which is at odd with your quote.<br><br>Thanks <br><br></td></tr></table><br>
<a name="2023928"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >AdamRedwoods</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#5">[#5]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> I also see there's an Affine Transformation which is something different to the CTM. I assume now that Scale, Rotate, Translate work on the CTM and Transform creates an Affine Transformation and applies it to the CTM? <br></div><br>Correct. Apple's terminology is that affine transform is another matrix that you create to apply to the CTM.<br><br><div class="quote"> Adam, in your explanation of Transform (see below) you have the * scale in brackets. Is there a reason?  <br></div>EDIT: I did that assuming that if scale = 1.0 and you have no rotation, then it's 0. I need to re-write that doc since I should use "position" vs. "translation".<br><br><div class="quote"> I can't see why a scale factor would affect rotation? <br></div>because in the transformation matrix, scale and rotation are kept together. I don't know enough of the math to explain this, it's based on Cartesian systems. Play with the numbers and you'll see how scale and rotation are inter-related.<br><br><div class="quote"> which is at odd with your quote. <br></div><br>I see what you're saying, yeah, that's mind-bending with the order of matrix operations and how the CTM defines what your output is going to be, but yet we see it visually as layered top to bottom.<br><br>Key point is that matrix transforms are specific in order of application, and I'm speaking in terms of how the mojo affine commands transform the Current Transform Matrix...... <br><b>anything you add afterwards, could effect the previous state.</b> <br>- an early Rotate, is going to be effected by a later Translate.<br>- an early Scale, is going to be effected by a later Translate.<br><br>but....<br><div class="quote"> Mojo rotation does not effect translation, but translation effects rotation and scale. <br></div><br>- an early Translate, is NOT going to be effected by a later Rotate.<br>- an early Translate, is NOT going to be effected by a later Scale.<br><br>Also note, Translation effects Scale. Scale does not effect rotation or translation.<br><br>Another note:<br>This confusion is why I think a Position() command would work better than a Translate() command. <br><br></td></tr></table><br>
<a name="2023927"></a>

<a name="2023926"></a>

<a name="2023925"></a>

<a name="2023924"></a>

<a name="2023922"></a>

<a name="2023933"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >AdamRedwoods</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#6">[#6]</a></td></tr></table></td></tr><tr ><td class="posttext"> And to add one last thing to make everything confusing:<br><div class="quote"> I noticed on that page their example of Rotate, Scale, Translate actually had the scale affecting the translate. When they translated 1/4 the screen across the previous scale means the translation was actually much smaller in physical space.  <br></div><br><br>I use the term TRANSLATE effects ROTATE and SCALE, but perhaps "effects" isn't the right term, but rather "gets multiplied by". So in essence, rotation and scale do effect translate-- BUT only when translate is taken into consideration into the solving equation-- thus why I restate my original quote that Translate effects Rotation and Scale, but not the other way around, because of the solving equations used.<br><br>If I said Rotate and Scale effect Translate, then you would think that adding the scale command after the translate would then scale the translation, but it doesn't.<br><br>Is anyone confused yet? <br><br></td></tr></table><br>
<a name="2023930"></a>

<a name="2023931"></a>

<a name="2023932"></a>

<a name="2023929"></a>

<a name="2023935"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >AaronK</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#7">[#7]</a></td></tr></table></td></tr><tr ><td class="posttext"> Phew! Thanks for that. I was going to ask you about your use of X "effects" Y but you went and reexplained it which helped.<br><br>I think this is a crucial question :)<br>"BUT only when translate is taken into consideration into the solving equation"<br><br>The system seems to have a mind of its own when deciding when to solve the equation and apply things and in what order.<br><br>I'll do some more experimenting at home and see where I get.<br><br>Many thanks. <br><br></td></tr></table><br>
<a name="2023936"></a>

<a name="2023937"></a>

<a name="2023938"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >AdamRedwoods</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#8">[#8]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> <br>BUT only when translate is taken into consideration into the solving equation <br></div><br>....which is why I use the statement (and keep adding to it):<br>Mojo rotation and scale do not effect translation, but translation effects rotation and scale, in respect to order of operations. <br><br>Said in another way:<br>The translation equation USES rotation and scale to figure its output CTM.<br>Rotation and scale equations do NOT MODIFY translation to figure its output CTM. <br><br></td></tr></table><br>
<a name="2023939"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >marksibly</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#9">[#9]</a></td></tr></table></td></tr><tr ><td class="posttext"> Hi,<br><br>Yep, the matrix ops work 'backwards'.<br><br>I like to think of the matrix as a stack of ops, eg:<br><br>translate x,y<br>rotate r<br>scale h,v<br><br>...means 'scale by h,v' THEN 'rotate by r' THEN 'translate by x,y'.<br><br>Note that the order of ops is VERY important - swapping 2 ops will have a major effect! You can visualize what effect the order of ops will have by applying them, in order, to a sample point, say (+1,+1).<br><br>The trans/rot/scale order above is actually kind of an important one - it's generally the order you want to use to achieve 'useful' transforms. Try visualizing a sprite that is first scaled, then rotated, then translated. This is generally what you want to do, but imagine swapping the  rotate/scale steps and you end up with a 'warped' sprite!<br><br>It's also not correct correct to say 'translate doesn't affect scale' or anything - it all just depends on what ops happen to be on the stack.<br><br>Why is it backwards like this? Basically, because it's far more useful this way - it allows you to place 'more global' ops earlier in your code than 'more local' ops.<br><br>And this is generally where you want them - rendering code generally executes spatially 'top down', esp. in the case of scene graphs etc.<br><br>So it allows you to write functions like DrawTree or something that may do a bunch of matrix ops to rotate branches into place or whatever and doesn't have to care about what other ops may already be on the stack. These other ops will ultimately transform the tree as a single entity into place on the screen, but DrawTree doesn't have to know about that while it executes.<br><br>Similarly, DrawTree might call DrawLeaf with the matrix set so the leaf is transformed into the right place on the tree. And DrawLeaf can in turn use transforms without having to know about this or it's place on the tree/world/screen. <br><br></td></tr></table><br>
<a name="2023945"></a>

<a name="2023946"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >AaronK</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#10">[#10]</a></td></tr></table></td></tr><tr ><td class="posttext"> Hi Mark, thanks, that all sounds good.<br><br>Because I want to support windowed rendering (Where things are rendered into a non-fullscreen sized area on the screen) I can have that final "screen projection" translation and scaling as my first operation correct?<br><br>e.g. If I wanted to draw my scene in the middle of the screen but only 1/2 as high and 1/2 as wide I should be able to go<br><br>Translate DeviceWidth() / 2, DeviceHeight() / 2<br>Scale 0.5, 0.5<br><br>Then go merrily about my way traversing the tree and they can all do their own Translate, Rotate, Scale's and draws in their parent's coordinate space and everything should work out?<br><br>Is there any benefit to handling all the rotate/scale/translate myself and actually call DrawImage with 0's for everything, or should I use DrawImage with handles, positions, scale and rotation parameters? <br><br><br>Cheers<br><br>BTW: I found this google books link that helped. It explains the CTM more like building a matrix to transform a coordinate space as opposed to transforming an object. When you look at it this way, if you apply a scale first of say 0.5, then you're making all future translations halved as well.<br><br><br>http://books.google.co.nz/books?id=ivCbtqq6jVcC&amp;pg=PA87&amp;lpg=PA87&amp;dq=quartz+ctm+order&amp;source=bl&amp;ots=JHKpA6InQK&amp;sig=6_mITKPzmXNWQZo-qhOTyjTTSO4&amp;hl=en&amp;sa=X&amp;ei=q_5PT-mOKoOziQeJlaXvDg&amp;ved=0CDkQ6AEwAw#v=onepage&amp;q=quartz%20ctm%20order&amp;f=false <br><br></td></tr></table><br>
<a name="2023944"></a>

<a name="2023943"></a>

<a name="2023942"></a>

<a name="2023940"></a>

<a name="2023941"></a>

<a name="2023949"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >marksibly</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#11">[#11]</a></td></tr></table></td></tr><tr ><td class="posttext"> Hi,<br><br>&gt; Translate DeviceWidth() / 2, DeviceHeight() / 2<br>&gt; Scale 0.5, 0.5<br><br>That's the general idea, though you probably want to use /4 to center.<br><br>Also, you might want to include a 'virtual resolution' when scaling, eg:<br><br>Translate DeviceWidth/4,DeviceHeight/4<br>Scale .5,.5<br>Scale Float(DeviceWidth)/WIDTH,Float(DeviceHeight)/HEIGHT<br><br>...or just...<br><br>Translate DeviceWidth/4,DeviceHeight/4<br>Scale Float(DeviceWidth)/WIDTH/2,Float(DeviceHeight)/HEIGHT/2<br><br>This allows you to draw to a 'virtual' WIDTH x HEIGHT canvas that ends up in the center of the display regardless of actual device resolution.<br><br>You can do other cool global effects too, like spinning the entire window (read backwards!):<br><br>rot+=1		<br>Translate DeviceWidth/4,DeviceHeight/4				'translate to center<br>Scale Float(DeviceWidth)/2,Float(DeviceHeight)/2	'scale to half device size<br>Translate .5,.5				'back to 0..1<br>Rotate rot					'spin!<br>Translate -.5,-.5			'translate to -.5..+5<br>Scale 1.0/WIDTH,1.0/HEIGHT	'scale to 0..1<br><br>With some (careful) translations thrown in, you can do letterboxing too.<br><br>&gt; Is there any benefit to handling all the rotate/scale/translate myself and actually call DrawImage with 0's for everything, or should I use DrawImage with handles, positions, scale and rotation parameters? <br><br>Probably the only benefit is flexibility - you can do more than just scale/rotate/translate with custom transforms. Apart from 'shearing' though...can't think of anything too useful.<br><br>Also, image handles add another wrinkle. The 'correct' order of transforms for a rotated/scaled image with a non-0 handle is:<br><br>translate draw_x,draw_y<br>rotate draw_rot<br>scale draw_scalex,draw_scaley<br>translate -handle_x,-handle_y<br>...can drawimage 0,0 now...<br><br>ie: the handle adds another translation that needs to occur *before* the drawing transforms.<br><br>The DrawImage commands that include rot, scale take this into account to produce expected results (this is largely why they're there), but if you're doing manual transforms it's something you need to keep in mind. <br><br></td></tr></table><br>
<a name="2023948"></a>

<a name="2023947"></a>

<a name="2023950"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >slenkar</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#12">[#12]</a></td></tr></table></td></tr><tr ><td class="posttext"> I use the Rotate and Translate commands to parent one image to another<br><br><a href="http://monkeycoder.co.nz/Community/posts.php?topic=501" target="_blank">http://monkeycoder.co.nz/Community/posts.php?topic=501</a> <br><br></td></tr></table><br>
<a name="2023953"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >AaronK</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#13">[#13]</a></td></tr></table></td></tr><tr ><td class="posttext"> Thanks again Mark, just one more thing...<br><br>"you probably want to use /4 to center"????<br><br>Did you get this because the 0,0 of the drawing is at the top,left? If so, that is OK as in my example I was assuming I would do a translation elsewhere (first) to translate everything around the centre of a "camera" and then translate that into the middle of the screen. However your way might do it in less operations if I build the camera straight into it.<br><br>Cheers <br><br></td></tr></table><br>
<a name="2023954"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >marksibly</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#14">[#14]</a></td></tr></table></td></tr><tr ><td class="posttext"> Hi,<br><br>&gt; Did you get this because the 0,0 of the drawing is at the top,left?<br><br>Yep, if 0,0 is your center then your way is right. I think. Pretty sure you have the general idea anyway! <br><br></td></tr></table><br>
<a name="bottom"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td align="right"><a href="http://monkeycoder.co.nz" target="_blank"><img src="/img/monkey2.svg" ></a> <a href="https://github.com/blitz-research" target="_blank"><img src="/img/github.svg" ></a> <a href="https://discord.gg/qJccbSp" target="_blank"><img src="/img/discord.svg" ></a></td></tr></table><br></div><br><table width="100%"><tr><td></body></html lang="en">
