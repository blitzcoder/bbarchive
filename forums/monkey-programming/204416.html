<!DOCTYPE html><html lang="en" ><head ><title >4 questions regarding images handling (Mark?)</title><meta name='viewport' content='width=device-width, initial-scale=0.66'><meta name='description' content='language:basic, target:desktop, category:game development'><link rel="styleSheet" href="../skins/granite/style.css" type="text/css"><style type="text/css">div.bbcode {padding: 8px;background: #E5E5E5;color: #000000;border: 1px dashed #B4B4BE;}</style></head><body ><table width=100% cellspacing=0 cellpadding=0><tr ><td class="menubarleft"></td><td class="menubar"><table cellspacing="0" cellpadding="0"><tr ><td >&nbsp;</td><td class="menuitemleft"></td><td class="menuitem"><a href="/" class="menuitem">News</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/forums.php" class="menuitem">Forums</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/codearcs.php" class="menuitem">Code</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/logs.php" class="menuitem">Logs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/gallery.php" class="menuitem">Gallery</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/sdkspecs.php" class="menuitem">Specs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/search.php" class="menuitem">Search</a></td><td class="menuitemright"></td></tr></table></td><td class="menubarright"></td></tr></table><div class="main"><h1 >4 questions regarding images handling (Mark?)</h1><a href="forums.php" >Monkey Forums</a>/<a href="topics.php?forum=507" >Monkey Programming</a>/<a href="#bottom" >4 questions regarding images handling (Mark?)</a><br><br>
<a name="2047210"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >ziggy</td><td align="right"><font class=tiny>(Posted 2013)</font>&nbsp;<a href="#1">[#1]</a></td></tr></table></td></tr><tr ><td class="posttext"> I have some quick questions regarding Images handling on Monkey and I haven't found any answer anywhere here. I think they are sort of important. <br><br>Maybe I've missed some bits in the documentation or here in the forums, but anyway... Let me explain what I think should be a pretty common situation:<br><br>In my current game, I need to be sure that level specific graphics are discarded when a level is finished, so I have enought VRam for the next level, so my questions are:<br><br>1.- What happens when I Discard an image? Is it removed from the VRAM?<br><br>2.- How does this affect grabbed images? Do they get invalid, or the underlying texture is removed from the VRAM <b>only</b> when there are not any more Images of it "alive" in a sort of ref-counting system?<br><br>3.- If I don't call the Discard method of an Image instance, and the garbage collector collectes the Image object, assuming there are no more alive Image objects pointing to the same underlying texture, can I assume that this texture will be properly removed from VRAM in all targets, <b>including Java</b>? <br><br>It worries me that, given that Java does not provide a destructor in its GC, this images could be kept on the VRAM forever without the coder ever knowing it until the game starts showing rendering glitches. Should I worry about this?<br><br>Also:<br><br>4.- In case the GC can discard unused textures from collected image objects, can I assume that the GC is fast enough? It worries me if it is too slow to be properly removing textures from the VRAM between level "unload/load next" operations. In other words, if I don't bother to discard Images explicitly and I leave all the work for the GC, what can I expect to happen?<br><br>EDIT: Also, why drawing a Discard image produces a runtime error in some targets (HTML5) and just draws nothing in other targets (GLFW). Shouldn't this be a bit more consistent (if possible)?<br><br>EDIT2: The Discard method of images that are created as GrabImage from other "parent" images seems to do nothing, you can Discard them, and draw them inmediatly. Is this expected behavior? <br><br></td></tr></table><br>
<a name="2047197"></a>

<a name="2047209"></a>

<a name="2047208"></a>

<a name="2047207"></a>

<a name="2047206"></a>

<a name="2047196"></a>

<a name="2047195"></a>

<a name="2047202"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Skn3</td><td align="right"><font class=tiny>(Posted 2013)</font>&nbsp;<a href="#2">[#2]</a></td></tr></table></td></tr><tr ><td class="posttext"> Well this relates to a question I recently sent to Mark about an issue with switching windowed/fullscreen modes at runtime.<br><br>In GLFW if you destroy the window (and in turn GL context) without previously discarding all your images then the images at some level could remain intact. If you later try and render the image albeit in another GL context, this causes images to render improperly. Images will render as white blocks or as corrupted artefacts.<br><br>If you just NULL images you can't guarantee that the garbage collector will collect the images in time. With a lot of reading I did, it stated that it can even be upto the graphics card driver to decide if the texture gets freed.<br><br>I can't answer for all targets, but from my testing in GLFW if you Discard() images this will invalidate the texture. If you NULL the image handle then Discard() never seems to get called. I don't know if it is doing it internally somewhere, but the destructor and then Discard() never gets called. <br><br></td></tr></table><br>
<a name="2047201"></a>

<a name="2047200"></a>

<a name="2047220"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rushino</td><td align="right"><font class=tiny>(Posted 2013)</font>&nbsp;<a href="#3">[#3]</a></td></tr></table></td></tr><tr ><td class="posttext"> Mark seem (once again) to do lots of coding right now hehe. He didn't visited the forum for like 3 weeks. <br><br></td></tr></table><br>
<a name="2047230"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >MikeHart</td><td align="right"><font class=tiny>(Posted 2013)</font>&nbsp;<a href="#4">[#4]</a></td></tr></table></td></tr><tr ><td class="posttext"> WRONG. Mark visited the forum at least 1 week ago. Hi constantly looks at the bug reports I think. I wouldn't expect to get a response in normal forum posts. <br><br></td></tr></table><br>
<a name="2047231"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Belimoth</td><td align="right"><font class=tiny>(Posted 2013)</font>&nbsp;<a href="#5">[#5]</a></td></tr></table></td></tr><tr ><td class="posttext"> This is relevant to my interests as well. <br><br></td></tr></table><br>
<a name="2047474"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >ziggy</td><td align="right"><font class=tiny>(Posted 2013)</font>&nbsp;<a href="#6">[#6]</a></td></tr></table></td></tr><tr ><td class="posttext"> bump! <br><br></td></tr></table><br>
<a name="2047492"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >marksibly</td><td align="right"><font class=tiny>(Posted 2013)</font>&nbsp;<a href="#7">[#7]</a></td></tr></table></td></tr><tr ><td class="posttext"> Hi,<br><br>&gt; 1.- What happens when I Discard an image? Is it removed from the VRAM?<br><br>When you discard an image, the underlying OS 'handle' is closed (GL texture, dx surface etc) which will result in any vram used by the resource being (eventually) released. Any backing store (a version of the image stored in system memory by Mojo in case of 'lost graphics') is also released.<br><br>&gt; 2.- How does this affect grabbed images? Do they get invalid, or the underlying texture is removed from the VRAM only when there are not any more Images of it "alive" in a sort of ref-counting system?<br><br>Grabbed images maintain a reference to the image they were grabbed from, effectively keeping the source image 'alive'.<br><br>&gt; 3.- If I don't call the Discard method of an Image instance, and the garbage collector collectes the Image object, assuming there are no more alive Image objects pointing to the same underlying texture, can I assume that this texture will be properly removed from VRAM in all targets, including Java? <br><br>Probably.<br><br>Android mojo uses Java 'finalizers' (a kind of destructor) to call Discard, which is what actually releases textures/video mem.<br><br>However, finalizers aren't guaranteed to run when garbage is collected - in fact, they're not guaranteed to run at all.<br><br>In practice, image textures/memory do appear to get discarded in a timely manner, but I think it may be a good idea to start encouraging people to manually discard images/audio/resources, the same way they should close files. <br><br></td></tr></table><br>
<a name="bottom"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td align="right"><a href="http://monkeycoder.co.nz" target="_blank"><img src="/img/monkey2.svg" ></a> <a href="https://github.com/blitz-research" target="_blank"><img src="/img/github.svg" ></a> <a href="https://discord.gg/qJccbSp" target="_blank"><img src="/img/discord.svg" ></a></td></tr></table><br></div><br><table width="100%"><tr><td></body></html lang="en">
