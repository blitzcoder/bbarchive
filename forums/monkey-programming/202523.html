<!DOCTYPE html><html lang="en" ><head ><title >crash when reloading images after Discard()</title><meta name='viewport' content='width=device-width, initial-scale=0.66'><meta name='description' content='language:basic, target:desktop, category:game development'><link rel="styleSheet" href="../skins/granite/style.css" type="text/css"><style type="text/css">div.bbcode {padding: 8px;background: #E5E5E5;color: #000000;border: 1px dashed #B4B4BE;}</style></head><body ><table width=100% cellspacing=0 cellpadding=0><tr ><td class="menubarleft"></td><td class="menubar"><table cellspacing="0" cellpadding="0"><tr ><td >&nbsp;</td><td class="menuitemleft"></td><td class="menuitem"><a href="/" class="menuitem">News</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/forums.php" class="menuitem">Forums</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/codearcs.php" class="menuitem">Code</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/logs.php" class="menuitem">Logs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/gallery.php" class="menuitem">Gallery</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/sdkspecs.php" class="menuitem">Specs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/search.php" class="menuitem">Search</a></td><td class="menuitemright"></td></tr></table></td><td class="menubarright"></td></tr></table><div class="main"><h1 >crash when reloading images after Discard()</h1><a href="forums.php" >Monkey Forums</a>/<a href="topics.php?forum=507" >Monkey Programming</a>/<a href="#bottom" >crash when reloading images after Discard()</a><br><br>
<a name="2024928"></a>

<a name="2024929"></a>

<a name="2024930"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Anatol</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#1">[#1]</a></td></tr></table></td></tr><tr ><td class="posttext"> Hi,<br><br>I spent quite some time trying to track down a bug, but no luck so far. Maybe someone has a hint...<br><br>In brief: my app is very likely to crash across all targets when I discard an image from a global object and then reassign it again. The app then crashes when I try to call DrawImage().<br><br>Error messages in HTML5 are "Monkey runtime error: TypeError: Unable to get value of the property 'image': object is null or undefined", iOS crashes with a segmentation violation, other targets with similar messages.<br><br>So quite clearly the image object seems to be null.<br><br>In length: I'm working on an interactive book project that on a page turn preloads resources of previous and next pages in advance and discards resources of other pages.<br><br>It all works fine, but some pages use a global Particles array that contains a fixed number of particle system objects. I used a global array so that I only need a smaller number of particle system instances and not one or more for each page, so basically I recycle these particle systems.<br><br>A page populates a free particle system, so the page uses a simple<br><pre class=code>
particleImage = LoadImage(path)

' and later populates the Global Particles system like this:
Particles[id].AddParticle(particleImage, position, velocity, size, etc)
</pre><br>The particle system does its particle calculations and renders each particle in Particles[id].Render(); this method simply loops through all active particles and then calls DrawImage(). If I come back to a page that had its resources discarded earlier this is where the app crashes. I even added a special precaution to check if the image is Null:<br><pre class=code>
If image[index] &lt;&gt; Null
	DrawImage(image[index], position[index].X, position[index].Y, rotation[index], size[index], size[index], frame[index])
EndIf
</pre><br>but this doesn't seem to help. In 4 out of 5 cases it crashes.<br><br>I can draw the particleImage on the page directly without any errors, but there seems to be an issue when I try to pass the image again to the particle system object when I populate it (see code above: AddParticle()).<br><br>On a page turn I clean up the particle system that was used. I set the particle image to null.<br><pre class=code>
image[index] = Null
</pre><br>I hope the code I post here is not too vague, but the entire code is too huge to post and still a bit messy in some places.<br><br>I would appreciate any hints and insights. <br><br></td></tr></table><br>
<a name="2024931"></a>

<a name="2024933"></a>

<a name="2024934"></a>

<a name="2024936"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >muddy_shoes</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#2">[#2]</a></td></tr></table></td></tr><tr ><td class="posttext"> The error message is incorrect. It's not the image reference that's null, it's the internal surface reference.<br><br> You need to reload the image if you want to use it after you've called Discard.<br><br>Edit: Also, it might be an idea if the Loaded check was changed to handle the possibility that surface is Null and allow it to be called to check for this condition, i.e.:<br><br><textarea class=codebox name="code" wrap=OFF readonly="true" rows="15" cols="80">
	Method Loaded()
		Return surface And surface.Loaded()
	End
</textarea> <br><br></td></tr></table><br>
<a name="2024932"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Anatol</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#3">[#3]</a></td></tr></table></td></tr><tr ><td class="posttext"> Thanks muddy_shoes. Yes, you're right, it actually crashes in the graphics module on the line<br><pre class=code>
context.device.DrawSurface image.surface,0,0
</pre><br>I do reload the image though. In my page module I call<br><pre class=code>
particleImage = LoadImage(path)
</pre><br>before I pass it again to the global particle system object. I'm sure that the image is loaded because I can draw it in the page object, but not in the particle system object that the same image was passed to.<br><br>Or maybe I misunderstand you? <br><br></td></tr></table><br>
<a name="2024935"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >muddy_shoes</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#4">[#4]</a></td></tr></table></td></tr><tr ><td class="posttext"> Without seeing your code I can't verify if your reloading is correct. The error suggests that the reference in your draw call has been discarded and not reloaded so I think you should look again. <br><br></td></tr></table><br>
<a name="2024937"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Anatol</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#5">[#5]</a></td></tr></table></td></tr><tr ><td class="posttext"> &gt; I think you should look again.<br>Hm, yes. I think so, too, I should look again. It seems that under certain circumstances the program adds the particle (and particle image) to the particle system before the image was reloaded. It's still a mystery to me where and why this happens, but I'm quite confident that I'll find it. Thank you! <br><br></td></tr></table><br>
<a name="2024940"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >muddy_shoes</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#6">[#6]</a></td></tr></table></td></tr><tr ><td class="posttext"> I'd be happy to look at the code if you're willing to share. Today seems to be a bug hunting day for me anyway. <br><br></td></tr></table><br>
<a name="2025033"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Anatol</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#7">[#7]</a></td></tr></table></td></tr><tr ><td class="posttext"> Hi muddy_shoes. Thanks for all your help and for offering to go on a bug hunt! That's really appreciated. I read this a bit late so I figured it out in the meanwhile.<br><br>As expected the issue was my program code and the order in which things were loaded and populated.<br><br>Sometimes the app was setting up the particle system of a page before it had loaded the resources, hence the image was null. When I figured that out I still got the same error but less frequently. This time it was because under certain circumstances the program didn't set a flag to reinitialise a page, so resources were loaded but the particle system was not set up properly which made the whole thing crash again, because the particle system had a null object as the particle image, but this time for other reasons.<br><br>Thanks, muddy_shoes! I've learnt something new again.<br>&gt; The error message is incorrect. It's not the image reference that's null, it's the internal surface reference.<br><br>Before that I was looking for the wrong cause of the issue.<br><br>Most parts of my project are reasonably clean I think, but not the page turn code which is quite confusing. It would be best for me to rewrite this from scratch at some point... <br><br></td></tr></table><br>
<a name="bottom"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td align="right"><a href="http://monkeycoder.co.nz" target="_blank"><img src="/img/monkey2.svg" ></a> <a href="https://github.com/blitz-research" target="_blank"><img src="/img/github.svg" ></a> <a href="https://discord.gg/qJccbSp" target="_blank"><img src="/img/discord.svg" ></a></td></tr></table><br></div><br><table width="100%"><tr><td></body></html lang="en">
