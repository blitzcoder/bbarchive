<!DOCTYPE html><html lang="en" ><head ><title >Garbage Collection.  Any good reference sources?</title><meta name='viewport' content='width=device-width, initial-scale=0.66'><meta name='description' content='language:basic, target:desktop, category:game development'><link rel="styleSheet" href="../skins/granite/style.css" type="text/css"><style type="text/css">div.bbcode {padding: 8px;background: #E5E5E5;color: #000000;border: 1px dashed #B4B4BE;}</style></head><body ><table width=100% cellspacing=0 cellpadding=0><tr ><td class="menubarleft"></td><td class="menubar"><table cellspacing="0" cellpadding="0"><tr ><td >&nbsp;</td><td class="menuitemleft"></td><td class="menuitem"><a href="/" class="menuitem">News</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/forums.php" class="menuitem">Forums</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/codearcs.php" class="menuitem">Code</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/logs.php" class="menuitem">Logs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/gallery.php" class="menuitem">Gallery</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/sdkspecs.php" class="menuitem">Specs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/search.php" class="menuitem">Search</a></td><td class="menuitemright"></td></tr></table></td><td class="menubarright"></td></tr></table><div class="main"><h1 >Garbage Collection.  Any good reference sources?</h1><a href="forums.php" >Monkey Forums</a>/<a href="topics.php?forum=507" >Monkey Programming</a>/<a href="#bottom" >Garbage Collection.  Any good reference sources?</a><br><br>
<a name="2082489"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >jondecker76</td><td align="right"><font class=tiny>(Posted 2014)</font>&nbsp;<a href="#1">[#1]</a></td></tr></table></td></tr><tr ><td class="posttext"> I'm evaluating porting some existing code over to Monkey (specifically the cpptool target)<br><br>I can't seem to find any definitive reference to the garbage collection system.<br><br>- Can the GC be called manually?  I don't see any documented functions, but I've seen mention of gc_mark and gc_sweep in some posts on here.<br><br>- I see that the cpptool target does have some directives for different GC modes, including turning the garbage collector off.  If the GC is turned off, how can I free memory manually?  Is there any good reference for these directives?<br><br>- Is there any way of adding desctuctors to objects?<br><br>Thanks <br><br></td></tr></table><br>
<a name="2082490"></a>

<a name="2082491"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >ziggy</td><td align="right"><font class=tiny>(Posted 2014)</font>&nbsp;<a href="#2">[#2]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> Can the GC be called manually? I don't see any documented functions, but I've seen mention of gc_mark and gc_sweep in some posts on here. <br></div><br>As far as I know, you can't, but I don't see why you would ever need this<br><br><div class="quote"> I see that the cpptool target does have some directives for different GC modes, including turning the garbage collector off. If the GC is turned off, how can I free memory manually? Is there any good reference for these directives? <br></div><br>If it's turned off, memory can't be collected, it'll be free when program ends. That's an option for quick tools that do not allocate lots of memory, so they can perform a bit quicker, but on real world apps, it makes no sense to turn it off.<br><br><div class="quote"> Is there any way of adding desctuctors to objects? <br></div><br>No, destructors are not supported on Monkey. <br><br></td></tr></table><br>
<a name="2082495"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >jondecker76</td><td align="right"><font class=tiny>(Posted 2014)</font>&nbsp;<a href="#3">[#3]</a></td></tr></table></td></tr><tr ><td class="posttext"> Found the CPP_GC_MODE and CPP_GC_TRIGGER documentation here: <a href="http://www.monkey-x.com/docs/html/Programming_App%20config%20settings.html" target="_blank">http://www.monkey-x.com/docs/html/Programming_App%20config%20settings.html</a><br><br>Still, some questiosn remain.<br>- What exactly is mode 1?  Documentation states that it's called every "OnWhatever".  What does this mean exactly?  Doe this mean it's called after "OnCreate", "OnUpdate" and "OnRender"?  If so, wouldn't this mean that it only works in conjunction with the App (or derrived App) class?<br>- Same question for mode 2.  What exactly does "incremental collect every GC allocation" mean?  What constitutes a GC allocation?<br>- CPP_GC_TRIGGER..  Does this affect both mode 1 and mode 2?  Essentially, is this saying that resources aren't freed until 8MB of no-longer-needed memory is pooled up? <br><br></td></tr></table><br>
<a name="2082493"></a>

<a name="2082494"></a>

<a name="2082496"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >ziggy</td><td align="right"><font class=tiny>(Posted 2014)</font>&nbsp;<a href="#4">[#4]</a></td></tr></table></td></tr><tr ><td class="posttext"> Ah yes, unless you're using Mojo, I would recommend you to set it to incremental every GC allocation. (mode 2) so you can be sure memory is collected properly. <br><br></td></tr></table><br>
<a name="2082499"></a>

<a name="2082500"></a>

<a name="2082505"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >jondecker76</td><td align="right"><font class=tiny>(Posted 2014)</font>&nbsp;<a href="#5">[#5]</a></td></tr></table></td></tr><tr ><td class="posttext"> Thanks for chiming in ziggy<br><br>I guess now all I need to figure out is if CPP_GC_TRIGGER is even valid in mode 2, and figure out what constitutes a GC allocation (I would assume any time an object is created, though I would like to know for sure).  It would also be interesting to know how mode 2 affects the undocumented bl.thread module. I may have to dig through the source to find out.<br><br>Here is another interesting link that shows manual garbage collection by extending the stdcpp target:<br><a href="http://monkeycoder.co.nz/Community/posts.php?topic=5286" target="_blank">http://monkeycoder.co.nz/Community/posts.php?topic=5286</a><br><br>EDIT:<br>Updating this with my findings peeking around the source real quick for my own notes (though others may find it helpful as well).<br>-In lang.cpp, line 251, gc_obj_alloc is called.  It clearly shows that in mode 2, that the CPP_GC_TRIGGER is what triggers gc_collect_all() to be called.  It also answers some of my original questions.   Mainly, that each time an object is created a gc_object is allocated.  During this process, if memory allocation &gt; CPP_GC_TRIGGER then the GC kicks in and frees up memory.  Memory won't be freed again until TRIGGER is exceeded again. <br>- Also in lang.cpp, if you look, the CPP_GC_MAX_LOCALS, it's just a simple stack/reference counter and basically if you have more than 8192 locals allocated, anything beyond this isn't managed by the garbage collector (from what I'm seeing anyways).  So therefore, CPP_GC_MAX_LOCALS on it's own doesn't do anything to trigger garbage collection<br>- It would seem to me that brl.thread may actually be safe to use while in mode 2.  Interesting... <br><br></td></tr></table><br>
<a name="2082503"></a>

<a name="2082504"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >ziggy</td><td align="right"><font class=tiny>(Posted 2014)</font>&nbsp;<a href="#6">[#6]</a></td></tr></table></td></tr><tr ><td class="posttext"> Yes, a GC allocation happens when a new object is created. It's very easy to test, just create a sample application that generates large amounts of garbage, and see if it gets collected:<br><pre class=code>'#CPP_GC_MODE=2  
Const ITERATIONS:= 10000
Function Main()
	For Local i:Int = 0 To ITERATIONS
		Local list:= New List&lt;String&gt;
		For Local j:Int = 0 To ITERATIONS
			list.AddLast(String.FromChars([
			Int(Rnd(0, 65535)),
			Int(Rnd(0, 65535)),
			Int(Rnd(0, 65535))]))
		Next
	Next
End</pre> <br><br></td></tr></table><br>
<a name="bottom"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td align="right"><a href="http://monkeycoder.co.nz" target="_blank"><img src="/img/monkey2.svg" ></a> <a href="https://github.com/blitz-research" target="_blank"><img src="/img/github.svg" ></a> <a href="https://discord.gg/qJccbSp" target="_blank"><img src="/img/discord.svg" ></a></td></tr></table><br></div><br><table width="100%"><tr><td></body></html lang="en">
