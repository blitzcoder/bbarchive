<!DOCTYPE html><html lang="en" ><head ><title >building custom targets</title><meta name='viewport' content='width=device-width, initial-scale=0.66'><meta name='description' content='language:basic, target:desktop, category:game development'><link rel="styleSheet" href="../skins/granite/style.css" type="text/css"><style type="text/css">div.bbcode {padding: 8px;background: #E5E5E5;color: #000000;border: 1px dashed #B4B4BE;}</style></head><body ><table width=100% cellspacing=0 cellpadding=0><tr ><td class="menubarleft"></td><td class="menubar"><table cellspacing="0" cellpadding="0"><tr ><td >&nbsp;</td><td class="menuitemleft"></td><td class="menuitem"><a href="/" class="menuitem">News</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/forums.php" class="menuitem">Forums</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/codearcs.php" class="menuitem">Code</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/logs.php" class="menuitem">Logs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/gallery.php" class="menuitem">Gallery</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/sdkspecs.php" class="menuitem">Specs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/search.php" class="menuitem">Search</a></td><td class="menuitemright"></td></tr></table></td><td class="menubarright"></td></tr></table><div class="main"><h1 >building custom targets</h1><a href="forums.php" >Monkey Forums</a>/<a href="topics.php?forum=507" >Monkey Programming</a>/<a href="#bottom" >building custom targets</a><br><br>
<a name="2116846"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Sicilica</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#1">[#1]</a></td></tr></table></td></tr><tr ><td class="posttext"> I'm sure this information is somewhere obvious and I'm just blind, but I couldn't find anything documented. What's the standard process for creating targets? I want to play a bit with doing a 3DS target, and obviously I could just load in custom modules that wrap devkitpro, tell trans to build a cpptool, and  compile the main.c myself, but I'm sure that's not the "right" way to do it. Can you add targets without hacking into trans? <br><br></td></tr></table><br>
<a name="2116858"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >ImmutableOctet(SKNG)</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#2">[#2]</a></td></tr></table></td></tr><tr ><td class="posttext"> <b>Oh boy, I've done it again. Have fun reading this mess of a response</b>... I'll be sure to edit it to death after I've recovered from passing out. <i>Maybe I should write a book or something about this garbage</i>...<br><br>*Grumble* *Grumble* Anyway, yeah, you <u>can</u> make a new target without modifying 'transcc', <b>but</b> you can't make a new translator or builder without <u><b>rebuilding it</b></u> (Which is the simple part). You'll probably need to get your hands dirty with the source, though. That doesn't mean you'll have to actually modify 'trans', but you probably need to modify the "driver".<br><br>This idea is similar to my approach with <a href="https://github.com/Regal-Internet-Brothers/webcc-monkey#webcc-monkey" target="_blank">my WebCC project</a>, where the builders were the only major things changed (In Monkey) from stock 'transcc'. In that case I needed to write a bootstrapping system based on 'iframes' and JS output. Don't get me started on the whole "port 'os' to web browsers" thing. In your case, you just need to modify the "C++ Tool" target slightly.<br><br>I'll get into the other details, specifically a glossary of how Monkey's compiler works, in a minute. First, let's take a step back for a moment.<br><br>Monkey's core language features are portable and implemented in several native languages for each target. The key part here is that we can leverage the "C++ Tool" target and related systems, including the support for GCC. You aren't going to be making a plain C target from scratch, that's ridiculous.<br><br>You can already write in C++ and build using devkitARM. Interoperability is near perfect, and works out of the box. In the case of Monkey's source, there's a few hiccups with the occasional bit of STL (Unless that's also working now?), but it's nothing you can't rewrite as standard C. To be exact, several portions of the C standard library just plain work, even '<u>stdout</u>' going straight to the screen.<br><br>But of course I'm talking about the core language running under 3DS homebrew. Handling graphics is a huge beast that I doubt has been solved well since the last time I looked at ctrulib. I know there was some initial work on executing shaders and handling GPU memory, but most graphics seemed to be done in software. Honestly, I didn't look well enough into it.<br><br>When <a href="https://www.github.com/ImmutableOctet/3ds-controller" target="_blank">I tried out 3DS homebrew</a> 6 months back, I wrote using mostly portable C++. More accurately, glorified C. With that in mind, even the POSIX/BSD socket API works (Well, most of it). Of course, this means 'brl.socket' could <i>technically</i> work, but there's other reasons why it wouldn't. I don't know how far the C rabbit hole goes, though. I do know about 'stdio' and at least part of 'stdlib' working.<br><br>With the right supporting commands, sockets and other services should work, too. When I was messing with it, I didn't do much else, because there really wasn't a lot that could be done. The most of the rest of it seemed to be poorly documented (At the time, at least).<br><br>I can say right now that making a "C++ Tool" port is theoretically doable. Graphics I'm not too sure about, but if <i>shaders</i> are available, or you have some kind of software renderer, then Mojo <i>could</i> work. Likewise, if someone gets at least fixed-function OpenGL working, the job's much simpler.<br><br>As for wrapping ctrulib, you've basically hit a road block. Monkey 1 doesn't explicitly work with pointers or structures. This means you'll be writing some rather heavy wrappers.<br><br>If you can manage to get OpenGL or Mojo working (Even in software), then it's definitely target material, even for hobby projects. Considering the requirements, you're dealing with a tall order, but it'd definitely be a cool project.<br><br>----------------------------------------------------------------------<br><br><br>Okay, so as promised, I'll get the basics out of the way with Monkey's target system. Oh, you're in for a treat this time:<br><br><b>DISCLAIMER</b>: This covers the basics of editing the 'transcc' frontend, and about as cleanly as you can. You'll need a supported version of GCC/MinGW to build this. Check out <a href="http://www.monkey-x.com/docs/html/Target%20SDKs_The%20Stdcpp%20target.html" target="_blank">this page from the docs</a> (Actually, your local version under your IDE's help may be better). You won't actually have to use GCC or MinGW directly, but Monkey needs it to build the translated output. Obviously, this is not the same compiler as devkitARM provides.<br><br>----------------------------------------------------------------------<br><br>Basically, you've got 'transcc', the "driver", which loads from the platform's configuration file. This is used for your installed SDKs and the like. After this, it enumerates a 'StringMap' of builders, the strings representing their names, of course. Each builder is implemented in Monkey and compiled into 'transcc', so you need to rebuild it to add another one.<br><br>So, what is a "builder"? Essentially, they're small classes that inherit a common class which does the heavy lifting. That class uses a translator you supply in your own builder using a field of the parent class. This, along with setting the language-extension, and any other prerequisites, is done in '<a href="https://github.com/blitz-research/monkey/blob/b83551d8fa0c0976983fecae9183c037bdd9d2be/src/transcc/builders/stdcpp.monkey#L28" target="_blank">Begin</a>'. I'll be honest, it's kind of thrown together. Anyway, the point here is that the builders are the core of the tool. They start each phase; parsing, which breaks down your syntax, "semanting", which figures out what things do, and makes sure your code actually works, and finally translating.<br><br>The translator basically gets all of the loaded symbols/objects/context from the first two phases, including native files via '<i>externs</i>'. The source is translated, the native source is pushed in with it, and the final result is a single file holding your translated source code. Yeah, this is where the build process is the least desirable. It's not multi-file, which is annoying, but hey, that's what Monkey 2 is for.<br><br>In your case, you can use C++, so you're golden on the translator front. Semantics and parsing are handled in Monkey (Implemented in the 'trans' module), and you're already using GCC. So, from a target perspective, you've got little to do. Even then, we've got some really nice global variables and other goodies that make this process more dynamic. For example, the host OS info we get from 'os', and the 'ENV_CONFIG' variable that tells us what kind of build it is. That's really the cool thing about this, you're not hacking anything, you're just extending it. This is where you realize that Mark Sibly made a pretty sweet compiler, but also that he's been doing to for years, even if the end of the factory is a bit lacking. Again, Monkey 2's around the corner soon enough, so maybe someone will give the build system a needed makeover for Monkey 1 as well.<br><br>Honestly, if your make-file is <a href="https://github.com/ImmutableOctet/3ds-controller/blob/master/3ds_controller/Makefile" target="_blank">anything like mine</a>, then you can just add any extra flags you want and use 'make' like the examples do. It's the usual shtick, something like "make -f filename", or just "make" if you're clever. You'll be passing a string with this kind of command at the end of the '<a href="https://github.com/blitz-research/monkey/blob/b83551d8fa0c0976983fecae9183c037bdd9d2be/src/transcc/builders/stdcpp.monkey#L80" target="_blank">MakeTarget</a>' method. Just remember to keep that check against 'opt_run', it's kind of important.<br><br>Okay, so we're probably going to make a custom builder that's basically just the "C++ Tool" one, how do we add it to the source?<br><br>Before I continue, I should probably mention that you should already be copying in this case. Keep your custom files in a different directory and mimic the file structure. This way you can use git or whatever you prefer to manage the source. That's a better option than having to clean this up when you want to update.<br><br>Okay, back to the fun stuff. First, you'll want to give your file a name and place it in "src/transcc/builders", name the module whatever you please. From here, open the "<a href="https://github.com/blitz-research/monkey/blob/15b46c20ea4509a1da78dfb3af7210a142ab2996/src/transcc/builders/builders.monkey" target="_blank">builders.monkey</a>" and add an import to your new module at the top of the file.<br><br>Next, go down to the 'Builders' function and add your own line, like so (<u>Formatted for consistency, not clarity</u>; you've been warned):<br><textarea class=codebox name="code" wrap=OFF readonly="true" rows="15" cols="80">
builders.Set "3ds",New 3DSHomebrewBuilder( tcc )
</textarea><br><br>Something to that effect, anyway. The class you're instantiating is the one in your module from earlier, so it's your call.<br><br>Alright, so what have we got next, then? In 'transcc'? Not much, actually. Assuming all you were looking to do was tweak the builder, that's about all you need to do. Now we need to hit build and wait for the <strike>cold embrace of death</strike> compile to finish.<br><br>...<br><br>Finished? Great, now you need to "<u>install</u>" it. Move the executable you made (Found in the build folder for 'transcc') into your "bin" Monkey installation's folder. After it's been moved, rename your old "transcc_blah" binary to something else, or just move it, it doesn't really matter. (Tip: When I say "blah", I'm really just being lazy. This is your platform's name, and it'll match your new executable; winnt, macos, linux, etc.) When you're done with that, rename your new binary from "main_blah" to "transcc_blah", and you're good. Not exactly rocket science, but you'd be surprised how many people can't do this.<br><br>Next, we need to take a stop at the "targets" folder, located in the root of your Monkey directory. Copy the target folder you want to base yours off of. In this case, I imagine you'll be using "cpptool". With your new folder, rename it to whatever you want. (Tip: It might be a good idea to copy this later, like you probably did for your builder's source code)<br><br>Before we get down to brass tacks, OPEN UP "TARGET.MONKEY" in your favorite text editor (Ted <i>for example</i>) and take a look at those variables.<br><br>The first one ('TARGET_NAME') should be pretty obvious, it's what we've been calling the damn thing for this novella of a post. That's both what'll pop up in your IDE, and what you can input on the command-line. Since we're <strike>lazy</strike> civilized people, obviously we'd see it in our IDEs. This can be whatever you want it to be, so have at it.<br><br>The second ('TARGET_SYSTEM') is a bit of a mystery until you start thinking about it. This is what you'll refer to the target as from within the actual language. You know that thing we've barely used this whole post? That's my fault, isn't it... Anyway, name this whatever you want, but it's preferred to keep it one "word" easy to write, and ideally no spaces. Underscores could work, I guess.<br><br>The third ('TARGET_BUILDER') is very familiar by now. Remember that 'StringMap' from earlier? This is how you access it. In my previous example, I used "3ds", but it just needs to be the same name. This principle applies to any target, just like the other info.<br><br>So, are we done yet? Nope, now we've got the <u>actual</u> files to deal with. In your new target's folder, you'll find a folder called "modules", unless you're getting build errors, don't bother messing with this. That folder holds a file called "monkeytarget.monkey", and it's related to setting up an entry-point. This can also be used to add to programs built with the target. This is usually used for default imports and the like. Less ideally, you could use this for preprocessor definitions, but we'll get to those. Basically, it's free-range for any (Monkey or native) source code you want to bundle with builds; just import and go. This actually applies to files in the data folder, now that I think about it.<br><br>But wait, there's more, let's go to our "template" folder. Here you'll be in familiar territory. You've first got your "CONFIG.MONKEY" file. If you've ever configured a target, you know what this is. Add any preprocessor variables you want, and they'll be defined in the built Monkey code.<br><br>Finally, we've made it to the end. What you'll find here are a couple of default functions, one being 'main', which is the program entry point. There's also some weird comments, these are used back our builder to "<i>inject</i>" the translator output (And native files). Finally, you've also got an 'include' to "Main.h", which is in the same folder. Keep in mind the contents of this file, because it dictates the default imports of any builds made with this target. This also means you'll need to strip down <strike>some</strike> a lot of these if you intend to target 3DS homebrew.<br><br><br>If you've followed that mess, you've officially created your own target, start up your IDE, and your new 3DS target should appear. (Note: You don't have to rebuild when you want to make a target based on an existing builder)<br><br>There's plenty I wasn't able to cover, but this should at least cover the initial setup. Now if you'll excuse me, I'm going to go pass out.<br><br><b>Oh yeah, I forgot: Make sure to look into those STL dependencies. There aren't many, but I can think of at least one use of std::vector for string conversion.</b> <br><br></td></tr></table><br>
<a name="2116857"></a>

<a name="2116856"></a>

<a name="2116854"></a>

<a name="2116853"></a>

<a name="2116852"></a>

<a name="2116851"></a>

<a name="2116850"></a>

<a name="2116849"></a>

<a name="2116848"></a>

<a name="2116860"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Sicilica</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#3">[#3]</a></td></tr></table></td></tr><tr ><td class="posttext"> Wow, you're the best person ever. You deserve a purple heart for that. I like how over the course of the post your sarcasm becomes less and less veiled, it makes it pretty easy to see the progression of your emotional state. Also, thanks for all the modules you make, I've used several of them for random projects (although tbh the interdependent regal system is a massive pain, dunno what else you'd do though).<br><br>Shoot, I had forgotten that trans is written in Monkey, that makes it a tad more annoying. In any case, thankfully I'm not foolish (or masochistic) enough to attempt to make a complete target for every builtin module (read: this will probably never be publicly released), so the hard ones like 'os' can die for all I care. I'm just going to wrap ctrulib's graphics stuff, probably under a mojo1 interface since mojo2 exposes a lot of the underlying OpenGL implementation and so would obviously be a nightmare to get working. Even then, though, you have two screens with different res and mouse/touch coordinates only on 1, so obviously it isn't a good choice for mojo and I may just write a completely different module depending on how I feel.<br><br>Luckily, the editing trans parts should be pretty easy. I'm always a bit unclear on what is and isn't open source - IIRC, all of trans is open but mojo/brl for some targets isn't? Anyway, from what you describe, I can create another builder without touching the translation process and mostly just use it to load different dependencies, add different make/etc files to the output, and run a different compile command at the end. Sweet. It's fortunate that it's designed to be so modular.<br><br>Welp, in that case I guess I'll start trying to break stuff. Since you expressed some interest I will say that it's worth looking at the 3ds scene again, it's advanced a TON in the past several months. I know people are working on opengl, sfml, and other libraries but not a lot of them seem to be stable yet. Still, I'm only getting in to it now because it finally feels like you can at least get a FOOTHOLD into stuff recently. I think ctrulib has been improved a fair bit too, but I'm pretty new to it all so not 100% sure. The api feels like a terrible cross of opengl and directx paradigms, but that's why you wrap it before you actually work on anything ;) <br><br></td></tr></table><br>
<a name="2116859"></a>

<a name="2116861"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Paul - Taiphoz</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#4">[#4]</a></td></tr></table></td></tr><tr ><td class="posttext"> Immute, I shit you not when ever I see your name in the heading of a reply to a question my first thought is always, "Right time to grab a coffe" because I know its gona be a read :)<br><br>That's not a bad thing either, being Dyslexic your wall's of text take me time to get through hence the drink, may I ask that you try formatting a little more ? I know the forum sucks for it and you don't have a lot of formatting options but it does help people like me. <br><br></td></tr></table><br>
<a name="2116862"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >dawlane</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#5">[#5]</a></td></tr></table></td></tr><tr ><td class="posttext"> @ImmutableOctet(SKNG): I gave up after <b>Oh boy</b>. :-)<br>To make it more comfortable to read and save your fingers the next time. I would suggest putting it all into a pdf file with Chapters and an index. And placing the the link in the tutorials, as there is bound to be somebody that will ask this question next time. ;-) <br><br></td></tr></table><br>
<a name="2116863"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Sicilica</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#6">[#6]</a></td></tr></table></td></tr><tr ><td class="posttext"> i thought it was a pretty logical flow to follow, personally. this should definitely be linked somewhere though <br><br></td></tr></table><br>
<a name="2116864"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >ratking</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#7">[#7]</a></td></tr></table></td></tr><tr ><td class="posttext"> So much info, and no one gave him a star <br><br></td></tr></table><br>
<a name="2116867"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Paul - Taiphoz</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#8">[#8]</a></td></tr></table></td></tr><tr ><td class="posttext"> I keep forgetting about the star's its so subtle I think most people don't really notice it at all which is a shame, and I rectified his lack of well overdue star. <br><br></td></tr></table><br>
<a name="2116868"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Paul - Taiphoz</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#9">[#9]</a></td></tr></table></td></tr><tr ><td class="posttext"> Just reading up a little I second the motion to move the information Immute has thrown in this topic to some where like the tutorial section I already have a few of his posts bookmarked for later reading so having them in a good place would make them easier to find in the future, we all know how lame this forum's search functions are. <br><br></td></tr></table><br>
<a name="2116938"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Neuro</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#10">[#10]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> Immute, I shit you not when ever I see your name in the heading of a reply to a question my first thought is always, "Right time to grab a coffe" because I know its gona be a read :) <br></div><br>Pretty much...this :). <br><br></td></tr></table><br>
<a name="2116973"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >ImmutableOctet(SKNG)</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#11">[#11]</a></td></tr></table></td></tr><tr ><td class="posttext"> I really appreciate the comments, guys. Although, I didn't realize I was coffee worthy. I don't know if I'll end up reworking this into a tutorial, though. If someone else wants to, go ahead.<br><br>@Sicilica: That wasn't <i>just</i> my emotional state; I was up for nearly 30 hours at the time. Needless to say, I was running on fumes.<br><br>Anyway, I just want to clarify how the license works. Everything the light touches is <strike><i>our kingdom</strike></i> open source.<br><br>Basically, it's like this:<br>* Mojo 2 isn't open source at all.<br>* The HTML5 and GLFW backends for Mojo 1 are open source, as well as the Monkey portions of it.<br>* Everything else is open source unless otherwise stated. This includes the actual targets.<br><br>I wrote about this in <a href="http://regal-internet-brothers.github.io/wccexplain/#setting-up-our-environment" target="_blank">this post</a> (Module disclaimer), if you're interested. It's basically the same summary, though. TL;DR: If it's <a href="https://github.com/blitz-research/monkey" target="_blank">in here</a>, it's open source.<br><br><a href="https://github.com/blitz-research/monkey/blob/develop/README.TXT" target="_blank">The license is here</a>. It basically says to not misrepresent your modifications as the original source code. So, a modified version of Monkey can't be misrepresented as the original version. You are also <u>not obligated</u> to credit Mark or Blitz Research in a product based on Monkey, although it is appreciated. Just keep in mind that <b>any product using modified software from Monkey must be marked as such</b>.<br><br>Considering it's the zlib/libpng license, you're basically free to do what you want. Although, a custom target that's dominantly based on a default target should probably have the license redistributed with it. For example, my '<a href="https://github.com/Regal-Internet-Brothers/jstool-target-monkey" target="_blank">jstool</a>' target has the license with it.<br><br>In general, you aren't going to have any issues if you just distribute the license with it. That goes for a lot of licenses, but I'm no lawyer.<br><br>Just don't mess with Mojo, and you should be good. <br><br></td></tr></table><br>
<a name="2116972"></a>

<a name="2116971"></a>

<a name="2116970"></a>

<a name="2116969"></a>

<a name="bottom"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td align="right"><a href="http://monkeycoder.co.nz" target="_blank"><img src="/img/monkey2.svg" ></a> <a href="https://github.com/blitz-research" target="_blank"><img src="/img/github.svg" ></a> <a href="https://discord.gg/qJccbSp" target="_blank"><img src="/img/discord.svg" ></a></td></tr></table><br></div><br><table width="100%"><tr><td></body></html lang="en">
