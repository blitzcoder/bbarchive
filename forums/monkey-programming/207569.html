<!DOCTYPE html><html lang="en" ><head ><title >Someone do a idiots guide to Android IAP please?</title><meta name='viewport' content='width=device-width, initial-scale=0.66'><meta name='description' content='language:basic, target:desktop, category:game development'><link rel="styleSheet" href="../skins/granite/style.css" type="text/css"><style type="text/css">div.bbcode {padding: 8px;background: #E5E5E5;color: #000000;border: 1px dashed #B4B4BE;}</style></head><body ><table width=100% cellspacing=0 cellpadding=0><tr ><td class="menubarleft"></td><td class="menubar"><table cellspacing="0" cellpadding="0"><tr ><td >&nbsp;</td><td class="menuitemleft"></td><td class="menuitem"><a href="/" class="menuitem">News</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/forums.php" class="menuitem">Forums</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/codearcs.php" class="menuitem">Code</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/logs.php" class="menuitem">Logs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/gallery.php" class="menuitem">Gallery</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/sdkspecs.php" class="menuitem">Specs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/search.php" class="menuitem">Search</a></td><td class="menuitemright"></td></tr></table></td><td class="menubarright"></td></tr></table><div class="main"><h1 >Someone do a idiots guide to Android IAP please?</h1><a href="forums.php" >Monkey Forums</a>/<a href="topics.php?forum=507" >Monkey Programming</a>/<a href="#bottom" >Someone do a idiots guide to Android IAP please?</a><br><br>
<a name="2073094"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >caffeinekid</td><td align="right"><font class=tiny>(Posted 2013)</font>&nbsp;<a href="#1">[#1]</a></td></tr></table></td></tr><tr ><td class="posttext"> Much appreciated if you do! I did kind of ask in this thread: <a href="http://www.monkeycoder.co.nz/Community/posts.php?topic=7537" target="_blank">http://www.monkeycoder.co.nz/Community/posts.php?topic=7537</a><br><br>..but there were not really many replies so I'm hoping if I post in here more people will see it, and someone can help make this more understandable.<br><br>A step by step of getting an IAP to work on something on Google Play would probably help a lot of people I think.<br><br>I don't know why it refuses to work for me - I'm using practically the same code as the OUYA set up, and that works fine.<br><br>I just get thrown a 500 error no matter what I try when it attempts to initialise the store.<br><br>So yes, a step by step idiots guide please, if someone has this working and can help us less fortunate ones. :)<br><br>Many thanks! <br><br></td></tr></table><br>
<a name="2073223"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >silentshark</td><td align="right"><font class=tiny>(Posted 2013)</font>&nbsp;<a href="#2">[#2]</a></td></tr></table></td></tr><tr ><td class="posttext"> Seconded.. any kind soul out there feel like producing a noob's guide to this, as an early xmas present to us beginners? <br><br></td></tr></table><br>
<a name="2073225"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Paul - Taiphoz</td><td align="right"><font class=tiny>(Posted 2013)</font>&nbsp;<a href="#3">[#3]</a></td></tr></table></td></tr><tr ><td class="posttext"> Yeah I thankfully have not needed to try it myself yet, but I do have plans to at some stage and having a really straight forward step by step would be amazing. <br><br></td></tr></table><br>
<a name="2073226"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Xaron</td><td align="right"><font class=tiny>(Posted 2013)</font>&nbsp;<a href="#4">[#4]</a></td></tr></table></td></tr><tr ><td class="posttext"> Will do it, still a bit limited in my time  atm ... <br><br></td></tr></table><br>
<a name="2073467"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >caffeinekid</td><td align="right"><font class=tiny>(Posted 2013)</font>&nbsp;<a href="#5">[#5]</a></td></tr></table></td></tr><tr ><td class="posttext"> Seems that a few people need this not just me so I hope one does appear at some point. <br><br>Thanks Xaron, but if anyone else knows and has a bit of free time to put this together please do. :) <br><br></td></tr></table><br>
<a name="2073469"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Xaron</td><td align="right"><font class=tiny>(Posted 2013)</font>&nbsp;<a href="#6">[#6]</a></td></tr></table></td></tr><tr ><td class="posttext"> Yes yes yes, need this soon as well! ;) Hang on, looking into this now... <br><br></td></tr></table><br>
<a name="2073476"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Xaron</td><td align="right"><font class=tiny>(Posted 2013)</font>&nbsp;<a href="#7">[#7]</a></td></tr></table></td></tr><tr ><td class="posttext"> Ok, the tutorial comes along nicely. Atm I just stumble a bit across that my products are not listed... Will post more tomorrow! <br><br></td></tr></table><br>
<a name="2073523"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Xaron</td><td align="right"><font class=tiny>(Posted 2013)</font>&nbsp;<a href="#8">[#8]</a></td></tr></table></td></tr><tr ><td class="posttext"> Alright, here we go!<br><br>First of all, this is ONLY for Android. Here's the code I use, it's mainly the same as Mark's example:<br><br><textarea class=codebox name="code" wrap=OFF readonly="true" rows="15" cols="80">
Strict

Import mojo
Import brl.json
Import brl.filestream
Import brl.monkeystore

Global CONSUMABLES:String[] = [ "bulletboost", "speedboost" ]
Global NON_CONSUMABLES:String[] = [ "shipupgrade" ]

Function Main:Int()
  New IAPTest()
  Return 0
End Function

Class IAPTest Extends App Implements IOnOpenStoreComplete, IOnBuyProductComplete, IOnGetOwnedProductsComplete
  Field _store:MonkeyStore
  Field _purchases:JsonObject
  Field _mousex:Float
  Field _mousey:Float
  
  Method OnCreate:Int()
    _purchases = New JsonObject()
    LoadPurchases()
    _store = New MonkeyStore()
    _store.AddProducts( CONSUMABLES, 1 )
    _store.AddProducts( NON_CONSUMABLES, 2 )
    
    _store.OpenStoreAsync( Self )
    
    SetUpdateRate(30)
    Return 0
  End Method

  Method OnUpdate:Int()
    UpdateAsyncEvents() 'IMPORTANT!!!
    _mousex = MouseX()
    _mousey = MouseY()
    Local hit:Int = MouseHit( 0 )

    If( _store.IsOpen() And Not _store.IsBusy() And hit )
      Local my:Float = _mousey * ( 480.0 / DeviceHeight() )
    
      If( my &gt;= 440-6 And my &lt; 440+6 )
        _store.GetOwnedProductsAsync( Self )
      Else
        Local y:Int = 40
        For Local p:Product = Eachin _store.GetProducts()
          If( my &gt;= y-6 And my &lt; y+6 )
            _store.BuyProductAsync( p, Self )
            Exit
          End If
          y += 24
        Next
      End If
    End If
    Return 0
  End Method

  Method OnRender:Int()
    Cls()
    PushMatrix()
      Scale( DeviceWidth() / 320.0, DeviceHeight() / 480.0 )
      DrawText( Millisecs(), 0, 0 )
    
      If( _store.IsOpen() )
        SetColor( 255, 255, 255 )
        If( _store.IsBusy() ) SetColor( 128, 128, 128 )
    
        DrawText( "Restore Owned Products", 160, 440, 0.5, 0.5 )
    
        Local y:Int = 40
        For Local p:Product = Eachin _store.GetProducts()
          Local t:String = "Buy " + p.Title
          Select p.Type
            Case 1
              t += " (" + _purchases.GetInt( p.Identifier ) + ")"
            Case 2
              If( _purchases.GetBool( p.Identifier ) ) t += " (owned)"
          End Select
          DrawText( t, 160, y, 0.5, 0.5 )
          y += 24
        Next
      Else
        DrawText( "Opening store...", 160, 40, 0.5, 0.5 )
      End If
    PopMatrix()
    
    SetColor( 255, 255, 255 )
    DrawCircle( _mousex-8, _mousey-8, 16 )
    Return 0
  End Method

  '*** Derived methods ***
  '*************************************************************************************  
  Method OnOpenStoreComplete:Void( result:Int )
    Print ( "OpenStoreComplete, result = " + result )
    If( result &lt;&gt; 0 ) Error "Store unavailable"
  End Method
  
  Method OnBuyProductComplete:Void( result:Int, product:Product )
    Print( "BuyProductComplete, result = " + result )
    If( result &lt;&gt; 0 ) Return
    Select product.Type
      Case 1
        _purchases.SetInt( product.Identifier, _purchases.GetInt( product.Identifier ) + 1 )
      Case 2
        _purchases.SetBool( product.Identifier, True )
    End
    SavePurchases()
  End Method
  
  Method OnGetOwnedProductsComplete:Void( result:Int, products:Product[] )
    Print( "GetOwnedProductsComplete, result = " + result )
    If( result &lt;&gt; 0 Or Not products ) Return
    For Local p:Product = Eachin products
      _purchases.SetBool( p.Identifier, True )
    Next
    SavePurchases()
  End Method

Private
  '*** Helper methods ***
  '*************************************************************************************  
  Method LoadPurchases:Void()
    Local f:FileStream = FileStream.Open( "monkey://internal/.purchases", "r" )
    If( Not f ) Return
    Local json:String = f.ReadString()
    Print( "LoadPurchases: Json = " + json )
    _purchases = New JsonObject( json )
    f.Close()
  End Method
  
  Method SavePurchases:Void()
    Local f:FileStream = FileStream.Open( "monkey://internal/.purchases", "w" )
    If( Not f ) Error "Unable to save purchases"
    Local json:String = _purchases.ToJson()
    Print( "SavePurchases: Json = " + json )
    f.WriteString( json )
    f.Close()
  End Method

End Class
</textarea><br><br>So far so good, that was the easy part. Compile it to Android and sign it with your release key as you have to upload it to the store. YES, there is no other way to test it with real product ids, but don't worry, you won't have to publish it!<br><br>Ok, so go to your developer console and go to "InApp Products"<br><img src="http://www.leidel.net/dl/monkey/iap/iap01.jpg"><br><br>Ahhh you see, we have to upload the apk first! I select beta testing for that purpose.<br><img src="http://www.leidel.net/dl/monkey/iap/iap02.jpg"><br><br>Done!<br><img src="http://www.leidel.net/dl/monkey/iap/iap03.jpg"><br><br>Now go to InApp Products again:<br><img src="http://www.leidel.net/dl/monkey/iap/iap04.jpg"><br><br>Let's add our product IDs as managed products. As far as I understand starting with API V3 everything is managed which means that you can only buy consumables ONCE and you must consume it before you can buy the next consumable of the same type. Luckily Mark already handles this for us!<br>The product IDs MUST be the same as in your app defined. In our example:<br><pre class=code>
Global CONSUMABLES:String[] = [ "bulletboost", "speedboost" ]
Global NON_CONSUMABLES:String[] = [ "shipupgrade" ]
</pre><br><img src="http://www.leidel.net/dl/monkey/iap/iap05.jpg"><br><br>Add title, description, price and set it to ACTIVE:<br><img src="http://www.leidel.net/dl/monkey/iap/iap06.jpg"><br><br>Alright, now your list should look like this:<br><img src="http://www.leidel.net/dl/monkey/iap/iap07.jpg"><br><br>Finally, to enable TESTING of your purchases you have to add beta testers to your account details. All Google accounts listed there will be able to purchase your items WITHOUT being charged for it. So the buy process will look exactly like the real one with the exception that your credit card isn't debited.<br><img src="http://www.leidel.net/dl/monkey/iap/iap08.jpg"><br><br>That's it! Actually you have to wait an hour or two till the product list is really available. <br><br></td></tr></table><br>
<a name="2073525"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Snader</td><td align="right"><font class=tiny>(Posted 2013)</font>&nbsp;<a href="#9">[#9]</a></td></tr></table></td></tr><tr ><td class="posttext"> Thank you Xaron, very nice! <br><br></td></tr></table><br>
<a name="2073529"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >bruZard</td><td align="right"><font class=tiny>(Posted 2013)</font>&nbsp;<a href="#10">[#10]</a></td></tr></table></td></tr><tr ><td class="posttext"> very usefull. Thx! <br><br></td></tr></table><br>
<a name="2073530"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Supertino</td><td align="right"><font class=tiny>(Posted 2013)</font>&nbsp;<a href="#11">[#11]</a></td></tr></table></td></tr><tr ><td class="posttext"> Saved in my fav's for later thanks Xaron I have put in a good word for you with Santa. <br><br></td></tr></table><br>
<a name="2073545"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Paul - Taiphoz</td><td align="right"><font class=tiny>(Posted 2013)</font>&nbsp;<a href="#12">[#12]</a></td></tr></table></td></tr><tr ><td class="posttext"> bookmarked for when I need it. thanks mate. <br><br></td></tr></table><br>
<a name="2073549"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Paul - Taiphoz</td><td align="right"><font class=tiny>(Posted 2013)</font>&nbsp;<a href="#13">[#13]</a></td></tr></table></td></tr><tr ><td class="posttext"> Wondering about saving the purchase some one has, say for example I buy a bullet booster, but don't consume it in game, at some point I then delete the game or drop my phone down the toilet and need a new one.<br><br>What would be the process for that user to get that boost back, as I think that's one of the IAP requirements is it not ? that players should always be able to get their purchases back ?<br><br>or is this not really an issue. <br><br></td></tr></table><br>
<a name="2073559"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >smilertoo</td><td align="right"><font class=tiny>(Posted 2013)</font>&nbsp;<a href="#14">[#14]</a></td></tr></table></td></tr><tr ><td class="posttext"> Aren't most IAP consumables to avoid that issue? <br><br></td></tr></table><br>
<a name="2073562"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Xaron</td><td align="right"><font class=tiny>(Posted 2013)</font>&nbsp;<a href="#15">[#15]</a></td></tr></table></td></tr><tr ><td class="posttext"> The way Mark handles it is that any purchase is consumed instantly so you can buy another one right away (this has changed with V3 API). In that case you have to check it on your client side for recovery. Of course as soon as you deinstall the game all is gone.<br><br>I see no way how one could request already purchased stuff from the Google store <b>that has been consumed already</b>. So you have to set up your own server. Other games use Facebook or Google+ to store your game state permanently.<br><br>Google says about that:<br><i><br>* All purchases are “managed” (that is, Google Play keeps track of the user's ownership of in-app products). The user cannot own multiple copies of an in-app item; only one copy can be owned at any point in time<br><br>* Purchased items can be consumed. When consumed, the item reverts to the "unowned" state and can be purchased again from Google Play</i> <br><br></td></tr></table><br>
<a name="2073636"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Snader</td><td align="right"><font class=tiny>(Posted 2013)</font>&nbsp;<a href="#16">[#16]</a></td></tr></table></td></tr><tr ><td class="posttext"> Somehow the example won't compile. Any idea?<br><br><pre class=code>-pre-compile:

-compile:
    [javac] Compiling 4 source files to D:\Programming\Projects\IAPtest\IAPtest.build\android\bin\classes
    [javac] D:\Programming\Projects\IAPtest\IAPtest.build\android\src\com\monkeycoder\monkeygame\MonkeyGame.java:5130: error: cannot find symbol
    [javac] 			m_data=(String[])bb_std_lang.resizeStringArray(m_data,m_length*2+10);
    [javac] 			                            ^
    [javac]   symbol:   method resizeStringArray(String[],int)
    [javac]   location: class bb_std_lang
    [javac] D:\Programming\Projects\IAPtest\IAPtest.build\android\src\com\monkeycoder\monkeygame\MonkeyGame.java:6571: error: cannot find symbol
    [javac] 			m_data=(c_Product[])bb_std_lang.resizeArray(m_data,m_length*2+10);
    [javac] 			                               ^
    [javac]   symbol:   method resizeArray(c_Product[],int)
    [javac]   location: class bb_std_lang
    [javac] D:\Programming\Projects\IAPtest\IAPtest.build\android\src\com\monkeycoder\monkeygame\MonkeyGame.java:6608: error: cannot find symbol
    [javac] 				m_data=(c_Product[])bb_std_lang.resizeArray(m_data,bb_math.g_Max(m_length*2+10,t_newlength));
    [javac] 				                               ^
    [javac]   symbol:   method resizeArray(c_Product[],int)
    [javac]   location: class bb_std_lang
    [javac] D:\Programming\Projects\IAPtest\IAPtest.build\android\src\com\monkeycoder\monkeygame\MonkeyGame.java:5367: error: cannot find symbol
    [javac] 			m_data=(c_JsonValue[])bb_std_lang.resizeArray(m_data,m_length*2+10);
    [javac] 			                                 ^
    [javac]   symbol:   method resizeArray(c_JsonValue[],int)
    [javac]   location: class bb_std_lang
    [javac] D:\Programming\Projects\IAPtest\IAPtest.build\android\src\com\monkeycoder\monkeygame\MonkeyGame.java:6132: error: cannot find symbol
    [javac] 			m_data=(c_DataBuffer[])bb_std_lang.resizeArray(m_data,m_length*2+10);
    [javac] 			                                  ^
    [javac]   symbol:   method resizeArray(c_DataBuffer[],int)
    [javac]   location: class bb_std_lang
    [javac] D:\Programming\Projects\IAPtest\IAPtest.build\android\src\com\monkeycoder\monkeygame\MonkeyGame.java:6176: error: cannot find symbol
    [javac] 				m_data=(c_DataBuffer[])bb_std_lang.resizeArray(m_data,bb_math.g_Max(m_length*2+10,t_newlength));
    [javac] 				                                  ^
    [javac]   symbol:   method resizeArray(c_DataBuffer[],int)
    [javac]   location: class bb_std_lang
    [javac] D:\Programming\Projects\IAPtest\IAPtest.build\android\src\com\monkeycoder\monkeygame\MonkeyGame.java:6692: error: cannot find symbol
    [javac] 			m_data=(c_IAsyncEventSource[])bb_std_lang.resizeArray(m_data,m_length*2+10);
    [javac] 			                                         ^
    [javac]   symbol:   method resizeArray(c_IAsyncEventSource[],int)
    [javac]   location: class bb_std_lang
    [javac] D:\Programming\Projects\IAPtest\IAPtest.build\android\src\com\monkeycoder\monkeygame\MonkeyGame.java:6729: error: cannot find symbol
    [javac] 				m_data=(c_IAsyncEventSource[])bb_std_lang.resizeArray(m_data,bb_math.g_Max(m_length*2+10,t_newlength));
    [javac] 				                                         ^
    [javac]   symbol:   method resizeArray(c_IAsyncEventSource[],int)
    [javac]   location: class bb_std_lang
    [javac] Note: D:\Programming\Projects\IAPtest\IAPtest.build\android\src\com\monkeycoder\monkeygame\MonkeyGame.java uses unchecked or unsafe operations.
    [javac] Note: Recompile with -Xlint:unchecked for details.
    [javac] 8 errors

BUILD FAILED
d:\android-sdk\tools\ant\build.xml:720: The following error occurred while executing this line:
d:\android-sdk\tools\ant\build.xml:734: Compile failed; see the compiler error output for details.

Total time: 18 secondsTRANS FAILED: Android build failed.

Abnormal program termination. Exit code: -1</pre> <br><br></td></tr></table><br>
<a name="2073637"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Snader</td><td align="right"><font class=tiny>(Posted 2013)</font>&nbsp;<a href="#17">[#17]</a></td></tr></table></td></tr><tr ><td class="posttext"> I reverted back to Monkey 75d and it is working now. <br><br></td></tr></table><br>
<a name="2073649"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Paul - Taiphoz</td><td align="right"><font class=tiny>(Posted 2013)</font>&nbsp;<a href="#18">[#18]</a></td></tr></table></td></tr><tr ><td class="posttext"> Xaron, I think you need to take your post and pump it over into the tutorials section of the forum, that way people in the future will find it a lot quicker. <br><br></td></tr></table><br>
<a name="2073663"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Snader</td><td align="right"><font class=tiny>(Posted 2013)</font>&nbsp;<a href="#19">[#19]</a></td></tr></table></td></tr><tr ><td class="posttext"> Got it all working, but the shop keeps being 'busy', so no buying yet. No idea why this is happening... <br><br></td></tr></table><br>
<a name="bottom"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td align="right"><a href="http://monkeycoder.co.nz" target="_blank"><img src="/img/monkey2.svg" ></a> <a href="https://github.com/blitz-research" target="_blank"><img src="/img/github.svg" ></a> <a href="https://discord.gg/qJccbSp" target="_blank"><img src="/img/discord.svg" ></a></td></tr></table><br></div><br><table width="100%"><tr><td></body></html lang="en">
