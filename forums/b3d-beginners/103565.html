<!DOCTYPE html><html lang="en" ><head ><title >Any way to speed up SaveBuffer?</title><meta name='viewport' content='width=device-width, initial-scale=0.66'><meta name='description' content='language:basic, target:desktop, category:game development'><link rel="styleSheet" href="../skins/granite/style.css" type="text/css"><style type="text/css">div.bbcode {padding: 8px;background: #E5E5E5;color: #000000;border: 1px dashed #B4B4BE;}</style></head><body ><table width=100% cellspacing=0 cellpadding=0><tr ><td class="menubarleft"></td><td class="menubar"><table cellspacing="0" cellpadding="0"><tr ><td >&nbsp;</td><td class="menuitemleft"></td><td class="menuitem"><a href="/" class="menuitem">News</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/forums.php" class="menuitem">Forums</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/codearcs.php" class="menuitem">Code</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/logs.php" class="menuitem">Logs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/gallery.php" class="menuitem">Gallery</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/sdkspecs.php" class="menuitem">Specs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/search.php" class="menuitem">Search</a></td><td class="menuitemright"></td></tr></table></td><td class="menubarright"></td></tr></table><div class="main"><h1 >Any way to speed up SaveBuffer?</h1><a href="forums.php" >Blitz3D Forums</a>/<a href="topics.php?forum=5" >Blitz3D Beginners Area</a>/<a href="#bottom" >Any way to speed up SaveBuffer?</a><br><br>
<a name="1248041"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >codermax</td><td align="right"><font class=tiny>(Posted 2014)</font>&nbsp;<a href="#1">[#1]</a></td></tr></table></td></tr><tr ><td class="posttext"> So here's the thing. I wanted to include a realtime video capturing feature for my games, to help anyone who wants to record their runs without the hassle of using various video capturing software that may impose limits or get on people's nerves or just won't work on their system(many of those). Studio X64's BlitzAVI is very good for this! <br><br>The bottleneck lies in SaveBuffer though - it's slow when used every frame. Or more specifically, ANY common Blitz-code method for saving graphics content to an image on the HDD is pretty expensive. I've sped things up some, but there's always that "hiccup" due to the expensive process.<br><br>I've wondered, is there a faster way to save graphics content to the HDD? I don't want super-fast realtime capture, just wanna record at a CONSTANT framerate of at least 30-40 FPS. My current method keeps the game running, but the resulting video has to be frameskipped to heck for this to happen and the hiccup is still very noticeable. <br><br></td></tr></table><br>
<a name="1248045"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Yasha</td><td align="right"><font class=tiny>(Posted 2014)</font>&nbsp;<a href="#2">[#2]</a></td></tr></table></td></tr><tr ><td class="posttext"> As a general guideline across all languages and engines: file operations are not realtime. Do not attempt to save things in your main loop and expect it not to affect performance. (File ops <i>can</i> be made fast, but most of them are designed with the expectation of not being used for realtime in the first place.)<br><br>My best guess would be, instead of trying to save one frame every frame, copy the image data to an expandable buffer and have a second thread (i.e. process - don't mess around trying to make threads work in B3D, they don't) save frames and drop them from the buffer in its own time.<br><br><br>Possible implementations:<br><br>- block copy image to a bank with a system function like memmove/RtlMoveMemory, use WriteBytes to write to a stream, have the second process read blocks from the stream into another bank, and save from that (you can probably do this in fewer steps with more system functions)<br><br>- investigate process shared memory<br><br>I have no idea if these would actually be faster, but they seem like they should be. <br><br></td></tr></table><br>
<a name="1248341"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >codermax</td><td align="right"><font class=tiny>(Posted 2014)</font>&nbsp;<a href="#3">[#3]</a></td></tr></table></td></tr><tr ><td class="posttext"> Hey Yasha, glad you're still around! :)<br><br>Right, I probably need to manipulate a memory block during gameplay instead.<br><br>So let me get this straight...<br>First, I need to place the contents of the backbuffer into another buffer like an image/texture. I heard reading directly from the backbuffer is much slower than copying the screen to an image, so I'll do that.<br><br>For reference, "RFrame" refers to the image in memory that I'll copy the screen contents to. Of course its size is the window's resolution.<br><br><pre class=code>

;copy the backbuffer's current contents into an image/texture.
CopyRect 0,0,GraphicsWidth(),GraphicsHeight(),0,0,BackBuffer(),ImageBuffer(RFrame)

</pre><br><br>Just to confirm the image got the backbuffer's contents, I used SaveImage. It doesn't affect my game's framerate at all when it's being run at every frame either!<br><br>So now I have a copy of the screen in an image. I need to transfer the contents to a bank. Here's my attempt at doing so:<br><br><pre class=code>

	;---------------------------------------------------------------
	; Getting image buffer in a bank
	;---------------------------------------------------------------
	;set the size we'll need the buffer to be.
	bsize=GraphicsWidth()*GraphicsHeight()*4
	;get the buffer.
	buf = ImageBuffer(RFrame)
	;lock the buffer so we can manipulate it.
	LockBuffer buf
	;create a bank the same size for transfering.
	LocBnk = CreateBank(bsize)
	;move the block of memory from one location to the other.
	MoveMemoryObjInt(LocBnk,buf,bsize)
	;unlock the buffer.
	UnlockBuffer buf

</pre><br><br>I have the required decls/dll, but unfortunately I get a MAV. The cause of the error was "MoveMemoryObjInt".<br>I have freeimage installed, and I tried using the equivalent FreeImage function as well and that gives me a MAV too. <br><br>I'm kind of stuck now. Is there anything else I can try? <br><br></td></tr></table><br>
<a name="1248361"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Yasha</td><td align="right"><font class=tiny>(Posted 2014)</font>&nbsp;<a href="#4">[#4]</a></td></tr></table></td></tr><tr ><td class="posttext"> The image buffer handle that you get isn't the raw data to copy - Blitz is still hiding that under one more layer of indirection (I think "buffers" might actually be DirectDrawSurfaces? been a long time). According to <a href="/posts.php?topic=48062#534266" target="_blank">this old thread</a>, you should use buffer+72 as the data pointer. And of course be careful that you're using the right combination of * vs. % on your decls (needs to be * for the bank and % for the buffer, I think). <br><br></td></tr></table><br>
<a name="1248402"></a>

<a name="1248412"></a>

<a name="1248413"></a>

<a name="1248414"></a>

<a name="1248415"></a>

<a name="1248450"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >RemiD</td><td align="right"><font class=tiny>(Posted 2014)</font>&nbsp;<a href="#5">[#5]</a></td></tr></table></td></tr><tr ><td class="posttext"> Maybe you could simply have a dim array to store all the images of all the renders (with copyrect) and at the end use these images to either create a replay of the screen capture (you draw the images one after the other at a certain speed) or to export a video ?<br>But if you do that you will need to define a maximum allowed fps and a maximum allowed time for the screen capture depending on the remaining free memory.<br><br>If the screen capture is only for your game, another approach is to capture the state of each component at each frame and then for the replay turn/move/animate each component depending on its state at each frame. <br><br></td></tr></table><br>
<a name="1248443"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >GfK</td><td align="right"><font class=tiny>(Posted 2014)</font>&nbsp;<a href="#6">[#6]</a></td></tr></table></td></tr><tr ><td class="posttext"> If you're trying to record video/frames at your game's logic framerate, it's going to look bloody awful when you attempt to play it back later at the standard 24 or 30FPS.<br><br>Seriously, you're trying to solve a problem that has already been solved by way of external video capture software.  There are plenty of them about, although I can't really suggest what to do about the ones that just "get on your nerves". <br><br></td></tr></table><br>
<a name="1249073"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >_PJ_</td><td align="right"><font class=tiny>(Posted 2014)</font>&nbsp;<a href="#7">[#7]</a></td></tr></table></td></tr><tr ><td class="posttext"> It may be "better" in many respects to approach the recording differently. Depending on the requirement for video recordings and their use beyond the game itself (i.e. if the intention is for players to post videos to youtube etc.)<br><br>Rather than record the entire display buffer and save frames to disk, it may be more advantageous to "simply" store the player input and/or object information (position/orientation etc. whatever is relevant) and then perhaps even write this to disk at game-over.<br>Provided the right information is recorded in this way, then it should follow that to replay the 'recording' would involve pseudo 'running the game' but instead of taking actual input, just apply the recordeed inputs at the right times and any non-random *(use and store RndSeed values where applicable) can be repeated as in the actual play through.<br><br>Although this limits the actual potentials of re-playing and sharing of the video data to those with a copy of the game, it should be much more economic.<br><br>This is a similar technique to that used by Valve for their HLTV demo recordings. <br><br></td></tr></table><br>
<a name="bottom"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td align="right"><a href="http://monkeycoder.co.nz" target="_blank"><img src="/img/monkey2.svg" ></a> <a href="https://github.com/blitz-research" target="_blank"><img src="/img/github.svg" ></a> <a href="https://discord.gg/qJccbSp" target="_blank"><img src="/img/discord.svg" ></a></td></tr></table><br></div><br><table width="100%"><tr><td></body></html lang="en">
