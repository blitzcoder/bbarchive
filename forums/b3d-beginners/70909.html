<!DOCTYPE html><html lang="en" ><head ><title >Memory access violation after third iteration</title><meta name='viewport' content='width=device-width, initial-scale=0.66'><meta name='description' content='language:basic, target:desktop, category:game development'><link rel="styleSheet" href="../skins/granite/style.css" type="text/css"><style type="text/css">div.bbcode {padding: 8px;background: #E5E5E5;color: #000000;border: 1px dashed #B4B4BE;}</style></head><body ><table width=100% cellspacing=0 cellpadding=0><tr ><td class="menubarleft"></td><td class="menubar"><table cellspacing="0" cellpadding="0"><tr ><td >&nbsp;</td><td class="menuitemleft"></td><td class="menuitem"><a href="/" class="menuitem">News</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/forums.php" class="menuitem">Forums</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/codearcs.php" class="menuitem">Code</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/logs.php" class="menuitem">Logs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/gallery.php" class="menuitem">Gallery</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/sdkspecs.php" class="menuitem">Specs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/search.php" class="menuitem">Search</a></td><td class="menuitemright"></td></tr></table></td><td class="menubarright"></td></tr></table><div class="main"><h1 >Memory access violation after third iteration</h1><a href="forums.php" >Blitz3D Forums</a>/<a href="topics.php?forum=5" >Blitz3D Beginners Area</a>/<a href="#bottom" >Memory access violation after third iteration</a><br><br>
<a name="792681"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >eos</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#1">[#1]</a></td></tr></table></td></tr><tr ><td class="posttext"> Hello,<br><br>We are starting to develop a 3D software to simulate the anatomic interior of a human being. The anatomical structures may vary their position, aspect and size from one 3D scenario ('person') to another.<br><br>We are trying to load that information into custom Blitz types reading it from a a database. Here is an example of our type 'Structure':<br><br>Type Estructura  <br>    Field estCod% ;code of the structure<br>    Field estNom$ ;name of the structure<br>    Field entEstX% ;x position<br>    Field entEstY% ;y position<br>    Field entEstZ% ;z position<br>    Field entEstEsc% ;a custom scaling<br>    Field m3dCod% ;the code of the respective 3d mesh<br>    Field texCod% ;the code of the respective texture<br>    Field modelo3d.Modelo3D ;the custom type holding the 3d mesh info<br>    Field textura.Textura ;the custom type holding the texture info	<br>End Type<br><br>For that purpose, we created an unmanaged dll written in C# to allow the communication between the blitz application and the database.<br><br>In the dll we have defined structs equivalent to the Blitz types. Here is the equivalent struct in C#:<br><br>public struct Estructura <br>{         <br>    public int estCod;      <br>    public string estNom;      <br>    public int entEstX;       <br>    public int entEstY;      <br>    public int entEstZ;     <br>    public int entEstEsc;       <br>    public int m3dCod;       <br>    public int texCod;       <br>    public Modelo3D modelo3d;       <br>    public Textura textura;<br>}<br><br><br>To fill the fields of the Blitz type, we instantiate one, set its code field (primary key at the DB) and then pass the type to a dll method (fillEstructura) that receives it by reference and sets every other field with the values obtained by querying the DB using the structure code.<br><br>Code in Blitz:<br><br>Global estructuras.Estructura[10]<br><br>Function traerEstructuras()<br>	   <br>    For i = 1 To 10<br>	;10 is the number of structures to load (the codes in the DB are correlative, ranging from 1 to 10) <br>	<br>        est.Estructura = new Estructura ;************<br>	est\estCod = i<br>        obtenerEstructura(est)<br>	estructuras[i] = es <br>    Next <br><br>End Function<br><br>Function obtenerEstructura(e.Estructura)<br><br>    fillEstructura(e) ;here we call the method at the dll<br>    <br>    e\estNom = getEstNom(e\estCod) <br>    ;sadly, in .NET, strings are not passed well within a referenced struct in an unmanaged environment (?) <br>    ;so we set it by calling a dll different function <br>    <br>    e\modelo3D = New Modelo3D<br>    e\modelo3d\m3dCod = e\m3dCod<br>    obtenerModelo3D(e\modelo3d) ;similar to the present method for filling the 3D model custom type<br><br>    e\textura = New Textura<br>    e\textura\texCod = e\texCod<br>    obtenerTextura(e\textura) ;similar to the present method for filling the texture custom type<br><br>End Function<br><br><br>Code in C# dll:<br><br>[ExportDllAttribute.ExportDll("fillEstructura", System.Runtime.InteropServices.CallingConvention.Cdecl)]<br>public static void fillEstructura(ref Estructura est)<br>{<br>    string sql = "select * from Estructuras where EstCod=" + est.estCod;<br>            <br>    //custom class and function to obtain get a Dataset containing the result of the sql query<br>    DataSet ds = ManejadorBD.getInstance().executeQuery(sql); <br>            <br>    if (ds.Tables[0].Rows.Count &gt; 0)<br>    {	<br>        DataRow fila = ds.Tables[0].Rows[0];<br><br>        //fills the attributes of the struct with the proper values<br>        est.entEstX = (int)fila["EntEstX"];<br>        est.entEstY = (int)fila["EntEstY"];<br>        est.entEstZ = (int)fila["EntEstZ"];<br>        est.entEstEsc = (int)fila["EntEstEsc"];              <br>        est.texCod = (int)fila["TexCod"];<br>        est.m3dCod = (int)fila["M3DCod"];<br>    }            <br>}<br><br>       <br>[ExportDllAttribute.ExportDll("getEstNom", System.Runtime.InteropServices.CallingConvention.Cdecl)]<br>public static string getEstNom(ref Estructura est)<br>{<br>    string retorno = "";<br>    string sql = "select EstNom from Estructuras where EstCod=" + est.estCod;<br>            <br>    DataSet ds = ManejadorBD.getInstance().ejecutarQuery(sql);<br><br>    if (ds.Tables[0].Rows.Count &gt; 0)<br>    {<br>        DataRow fila = ds.Tables[0].Rows[0];<br>        retorno = (string)fila["EstNom"];<br>    }<br><br>    return retorno;<br>}<br><br><br>Here are the respective entries at the .decls file:<br><br>.lib "Com.dll"<br>fillEstructura(est*): "fillEstructura"<br>getEstNom$(est*): "getEstNom"<br><br><br>Everything works fine on the individual tests, I mean when filling one structure at a time. However, when trying to batch process a lot of structures within a for or a while (like in the above blitz code example) the trouble begins: After every third loop of the for, the line marked with the ************ at the code (est.Estructura = new Estructura) generates a Memory Access Violation exception. <br><br>Why always after the third one? Why the first two always work fine no matter if you change the step of the for iteration to -1 to exclude an instance related issue? Why after every third time the line is executed and not before????<br><br>Please shed some light on this issue!<br><br>Thanks in advance for your help. <br><br></td></tr></table><br>
<a name="792793"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >b32</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#2">[#2]</a></td></tr></table></td></tr><tr ><td class="posttext"> The Blitz part of the code seems to run fine, so the error is prob. caused in the .dll.<br>The code itself doesn't look like something is wrong. I didn't knew you could directly fill a type from a .dll.<br>It is certainly a strange error, if it occurs only after 3 times. Maybe you are writing to a protected memory section somehow?<br>I would try to read/fill only the EStructura type, without the Modelo3D and Textura (sub)fields?<br>If you can't get it to work properly, you could maybe merge all the fields into a string and pass that along, or write a separate function for each field, like GetName, GetX, GetY, GetZ etc. <br><br></td></tr></table><br>
<a name="792796"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >eos</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#3">[#3]</a></td></tr></table></td></tr><tr ><td class="posttext"> Thanks a lot b32 for your post.<br><br>As a matter of fact, your solution (the dll method returning a string with all the values separated by a # character and then parsing the string and filling the type fields at the Blitz side) is what we are using right now as a temporary solution. Nevertheless, we hoped that someone could have experienced the same strange thing and maybe knew how to resolve it. It looks like we will be adopting the string solution as a permanent solution, though. :-)<br><br>BTW, we also tried without the type fields and the exception still occurs.<br><br>I agree with you about the problem being at the C# side. I am pretty sure if the dll was written in C++ this wouldn't be hapening. The .NET way to manage (or unmanage) some things like pointers and references, really creeps my nerves! <br><br>Thanks again for your post. <br><br></td></tr></table><br>
<a name="bottom"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td align="right"><a href="http://monkeycoder.co.nz" target="_blank"><img src="/img/monkey2.svg" ></a> <a href="https://github.com/blitz-research" target="_blank"><img src="/img/github.svg" ></a> <a href="https://discord.gg/qJccbSp" target="_blank"><img src="/img/discord.svg" ></a></td></tr></table><br></div><br><table width="100%"><tr><td></body></html lang="en">
