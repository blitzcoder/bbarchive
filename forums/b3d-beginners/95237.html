<!DOCTYPE html><html lang="en" ><head ><title >How to turn a QTS terrain into a mesh?</title><meta name='viewport' content='width=device-width, initial-scale=0.66'><meta name='description' content='language:basic, target:desktop, category:game development'><link rel="styleSheet" href="../skins/granite/style.css" type="text/css"><style type="text/css">div.bbcode {padding: 8px;background: #E5E5E5;color: #000000;border: 1px dashed #B4B4BE;}</style></head><body ><table width=100% cellspacing=0 cellpadding=0><tr ><td class="menubarleft"></td><td class="menubar"><table cellspacing="0" cellpadding="0"><tr ><td >&nbsp;</td><td class="menuitemleft"></td><td class="menuitem"><a href="/" class="menuitem">News</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/forums.php" class="menuitem">Forums</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/codearcs.php" class="menuitem">Code</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/logs.php" class="menuitem">Logs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/gallery.php" class="menuitem">Gallery</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/sdkspecs.php" class="menuitem">Specs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/search.php" class="menuitem">Search</a></td><td class="menuitemright"></td></tr></table></td><td class="menubarright"></td></tr></table><div class="main"><h1 >How to turn a QTS terrain into a mesh?</h1><a href="forums.php" >Blitz3D Forums</a>/<a href="topics.php?forum=5" >Blitz3D Beginners Area</a>/<a href="#bottom" >How to turn a QTS terrain into a mesh?</a><br><br>
<a name="1095740"></a>

<a name="1095741"></a>

<a name="1095743"></a>

<a name="1095744"></a>

<a name="1095750"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Guy Fawkes</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#1">[#1]</a></td></tr></table></td></tr><tr ><td class="posttext"> How do you turn a QTS terrain into a mesh with nodes, hierarchy, textures, mats, and the like?<br><br>I tried to save my QTS (Terragen TER file) terrain in Blitz3D, but it's not finding any nodes, etc..<br><br>I used WriteBB3D.<br><br>Here's the functions, globals, and dims.<br><br>b3dfile.bb: <br><br><textarea class=codebox name="code" wrap=OFF readonly="true" rows="15" cols="80">
;
;b3d file utils to be included
;

Dim b3d_stack(100)
Global b3d_file,b3d_tos

Function b3dSetFile( file )
	b3d_tos=0
	b3d_file=file
End Function

;***** functions for reading from B3D files *****

Function b3dReadByte()
	Return ReadByte( b3d_file )
End Function

Function b3dReadInt()
	Return ReadInt( b3d_file )
End Function

Function b3dReadFloat()
	Return ReadFloat( b3d_file )
End Function

Function b3dReadString$()
	Repeat
		ch=b3dReadByte()
		If ch=0 Return t$
		t$=t$+Chr$(ch)
	Forever
End Function

Function b3dReadChunk$()
	For k=1 To 4
		tag$=tag$+Chr$(b3dReadByte())
	Next
	sz=ReadInt( b3d_file )
	b3d_tos=b3d_tos+1
	b3d_stack(b3d_tos)=FilePos( b3d_file )+sz
	Return tag$
End Function

Function b3dExitChunk()
	SeekFile b3d_file,b3d_stack(b3d_tos)
	b3d_tos=b3d_tos-1
End Function

Function b3dChunkSize()
	Return b3d_stack(b3d_tos)-FilePos( b3d_file )
End Function

;***** Functions for writing to B3D files *****

Function b3dWriteByte( n )
	WriteByte( b3d_file,n )
End Function

Function b3dWriteInt( n )
	WriteInt( b3d_file,n )
End Function

Function b3dWriteFloat( n# )
	WriteFloat( b3d_file,n )
End Function

Function b3dWriteString( t$ )
	For k=1 To Len( t$ )
		ch=Asc(Mid$(t$,k,1))
		b3dWriteByte(ch)
		If ch=0 Return
	Next
	b3dWriteByte( 0 )
End Function

Function b3dBeginChunk( tag$ )
	b3d_tos=b3d_tos+1
	For k=1 To 4
		b3dWriteByte(Asc(Mid$( tag$,k,1 )))
	Next
	b3dWriteInt( 0 )
	b3d_stack(b3d_tos)=FilePos( b3d_file )
End Function

Function b3dEndChunk()
	n=FilePos( b3d_file )
	SeekFile b3d_file,b3d_stack(b3d_tos)-4
	b3dWriteInt( n-b3d_stack(b3d_tos) )
	SeekFile b3d_file,n
	b3d_tos=b3d_tos-1
End Function</textarea><br><br>inc/qts.bb: <br><br><textarea class=codebox name="code" wrap=OFF readonly="true" rows="15" cols="80">; -------------------------------------------------------------------------------------------------
; Project Title	: QTS : Quadtree Terrain System
; -------------------------------------------------------------------------------------------------
;
; Author		: Poursin Nicolas
; Email			: Nicolas.poursin(at)3dgametool.com
;
; Version		: 1.1.1          
; Date			: 23.05.2009
;
; -------------------------------------------------------------------------------------------------
;
; Updated by Krischan on 23.05.2009 for use with "BlitzTiles"
;
; - cleaned out unnecessary functions
; - fixed some errors
; - added Terragen loader
; - added tilebased UV-Coordinates, Vertexcolors and Vertexnormals calculation
; 
; -------------------------------------------------------------------------------------------------


; -------------------------------------------------------------------------------------------------
; Terms of Use License
; -------------------------------------------------------------------------------------------------
;
; This is a legal agreement ("License Agreement") between you And Poursin Nicolas.
;
;	You are permitted To:
;   - Create For free or commercial games 
;   - Free Tool
;	 
;	You are Not permitted To: 
;	1) Sell, resell it
;	2) Use it, in commercial tool 
;	3) Modify the products And sell it                   
;
; -------------------------------------------------------------------------------------------------


; -------------------------------------------------------------------------------------------------
; Types
; -------------------------------------------------------------------------------------------------
Type QTS_TPatch
	
	Field mesh%
	Field surf%
	Field x#
	Field y#
	Field z#
	Field xtab%
	Field ztab%
	
End Type


; -------------------------------------------------------------------------------------------------
; Globals
; -------------------------------------------------------------------------------------------------
Global QTS_Terrain%,QTS_QuadTree%,QTS_HeightMap%,QTS_Vertex%,QTS_Tile%,QTS_BlockSize%
Global QTS_Size%,QTS_XPTS%,QTS_XSCALE#,QTS_YSCALE#,QTS_HSCALE#,QTS_HBASE#
Global QTS_MinHeight#,QTS_MaxHeight#,QTS_HeightMapSize%


; -------------------------------------------------------------------------------------------------
; Initial Function
; -------------------------------------------------------------------------------------------------
Function QTS_CreateTerrain(filename$,tiles%,edgeerror#,calcnormals%,normalsfactor#,switchnormals%,usevertexcolors%,vertexintensity#,colormap%)
	
	QTS_LoadHeightMap(filename)
	QTS_BlockSize=(QTS_HeightMapSize-1)/16/tiles
	QTS_Terrain=CreateMesh()
	QTS_Tile=CreateBank(64*64*4)
	QTS_Roughness(edgeerror)
	QTS_CreatePatch(QTS_BlockSize)
	QTS_Texture(tiles,calcnormals,normalsfactor,switchnormals,usevertexcolors,vertexintensity,colormap)
	
	FreeBank QTS_QuadTree
	FreeBank QTS_HeightMap
	FreeBank QTS_Vertex
	
End Function


; -------------------------------------------------------------------------------------------------
; Terrain Roughness
; -------------------------------------------------------------------------------------------------
Function QTS_Roughness(error#=1.0)
	
	Local edgelength%=3,morph#
	Local x%,z%,node%,kill%
	Local edgeoffset%,childoffset%
	
	While edgelength&lt;=17
		
		edgeoffset=(edgelength-1)/2
		childoffset=(edgelength-1)/4
		
		z=edgeoffset
		
		While z&lt;QTS_HeightMapSize 
			
			;If edgelength=3 Then BT_UpdateBar("Calculating Quadtree",z,QTS_HeightMapSize,10,40)
			
			x= edgeoffset
			While x&lt;QTS_HeightMapSize 
				
				node = 0
				kill=0
				
				If edgelength&gt;3 Then
					node=QTS_GetMV(x-childoffset,z-childoffset)
					node=QTS_Max(node,QTS_GetMV(x+childoffset,z-childoffset))
					node=QTS_Max(node,QTS_GetMV(x+childoffset,z+childoffset))
					node=QTS_Max(node,QTS_GetMV(x-childoffset,z+childoffset))
				EndIf
				
				If edgelength=3 Or node=0 Then
					
					QTS_SetMV(x-edgeoffset,z-edgeoffset,1)
					QTS_SetMV(x+edgeoffset,z-edgeoffset,1)
					QTS_SetMV(x+edgeoffset,z+edgeoffset,1)
					QTS_SetMV(x-edgeoffset,z+edgeoffset,1)
					
					morph=Abs(QTS_GetHeight(x,z-edgeoffset)-((QTS_GetHeight(x-edgeoffset,z-edgeoffset)+QTS_GetHeight(x+edgeoffset,z-edgeoffset))/2))
					
					If morph&gt;error Then
						QTS_SetMV(x,z-edgeoffset,1)
					Else
						If edgelength&gt;3 Then QTS_SetMV(x,z-edgeoffset,0)
						kill=kill +1
					EndIf
					
					morph=Abs(QTS_GetHeight(x+edgeoffset,z)-((QTS_GetHeight(x+edgeoffset,z-edgeoffset)+QTS_GetHeight(x+edgeoffset,z+edgeoffset))/2))
					
					If morph&gt;error Then
						QTS_SetMV(x+edgeoffset,z,1)
					Else
						If edgelength&gt;3 Then QTS_SetMV(x+edgeoffset,z,0)
						kill=kill +1
					EndIf
					
					morph=Abs(QTS_GetHeight(x,z+edgeoffset)-((QTS_GetHeight(x+edgeoffset,z+edgeoffset)+QTS_GetHeight(x-edgeoffset,z+edgeoffset))/2))
					
					If morph&gt;error Then
						QTS_SetMV(x,z+edgeoffset,1)
					Else
						If edgelength&gt;3 Then QTS_SetMV(x,z+edgeoffset,0)
						kill=kill+1
					EndIf					
					
					morph=Abs(QTS_GetHeight(x-edgeoffset,z)-((QTS_GetHeight(x-edgeoffset,z+edgeoffset)+QTS_GetHeight(x-edgeoffset,z-edgeoffset))/2))
					
					If morph&gt;error Then
						QTS_SetMV(x-edgeoffset,z,1)
					Else
						If edgelength&gt;3 Then QTS_SetMV(x-edgeoffset,z,0)
						kill = kill +1
					EndIf
					
					QTS_SetMV(x,z,1)
					
					If kill=4 Then	
						morph=Abs(QTS_GetHeight(x,z)-((QTS_GetHeight(x-edgeoffset,z-edgeoffset)+QTS_GetHeight(x+edgeoffset,z+edgeoffset))/2))
						If morph&lt;=error Then
							morph=Abs(QTS_GetHeight(x,z)-((QTS_GetHeight(x+edgeoffset,z-edgeoffset)+QTS_GetHeight(x-edgeoffset,z+edgeoffset))/2))
							If morph&lt;=error Then QTS_SetMV(x,z,0)
						EndIf
					EndIf
					
				Else If edgelength&gt;3
					
					QTS_SetMV(x,z-edgeoffset,1)
					QTS_SetMV(x+edgeoffset,z,1)
					QTS_SetMV(x,z+edgeoffset,1)
					QTS_SetMV(x-edgeoffset,z,1)	
					
				EndIf
				
				x=x+edgelength-1
				
			Wend
			
			z=z+edgelength-1
			
		Wend
		
		edgelength=(edgelength Shl 1 )-1
		
	Wend
	
	For z=16 To QTS_HeightMapSize-1 Step 32
		For x=16 To QTS_HeightMapSize-1 Step 32
			QTS_ProcessNode(x,z,33,False,False)
		Next
	Next
	
End Function


; -------------------------------------------------------------------------------------------------
; Renders a node
; -------------------------------------------------------------------------------------------------
Function QTS_RenderNode(x%,z%,edgelength%,edgeoffset%,surf%,brender%)
	
	Local VC%,V1%,V2%,VE%
	Local xx%,xstart%,xend%
	Local zz%,zstart%,zend%
	
	If brender Then
		VC = QTS_AddVertex( x,z,surf)
		V1 = QTS_AddVertex( x-edgeoffset , z-edgeoffset ,surf)
		VE = QTS_AddVertex( x+edgeoffset , z-edgeoffset , surf)
	Else
		QTS_SetMV( x-edgeoffset , z-edgeoffset)
		QTS_SetMV( x+edgeoffset , z-edgeoffset )
	EndIf
	
	zz=z-edgeoffset
	xstart=x-edgeoffset+1
	xend=x-edgeoffset+edgelength-2
	
	For xx=xstart To xend
		
		If QTS_GetMV(xx,zz)&gt;0 Then
			
			If brender Then
				V2=QTS_AddVertex(xx,zz,surf)
				AddTriangle surf,V1,V2,VC
			Else
				QTS_SetMV(xx,zz)
			EndIf
			
			V1=V2
			
		EndIf
		
	Next
	
	If brender Then
		AddTriangle surf,V1,VE,VC
		VC=QTS_AddVertex(x,z,surf)
		V1=QTS_AddVertex(x-edgeoffset,z+edgeoffset,surf)
		VE=QTS_AddVertex(x+edgeoffset,z+edgeoffset,surf)
	Else
		QTS_SetMV(x-edgeoffset,z+edgeoffset)
		QTS_SetMV(x+edgeoffset,z+edgeoffset)
	EndIf
	
	zz=z+edgeoffset
	xstart=x-edgeoffset+1
	xend=x-edgeoffset+edgelength-2
	
	For xx=xstart To xend
		
		If QTS_GetMV(xx,zz)&gt;0 Then
			
			If brender Then
				V2=QTS_AddVertex(xx,zz,surf)
				AddTriangle surf,V2,V1,VC
			Else
				QTS_SetMV(xx,zz)
			EndIf
			
			V1=V2
			
		EndIf
		
	Next
	
	If brender Then
		AddTriangle surf,VE,V1,VC
		VC=QTS_AddVertex(x,z,surf)
		V1=QTS_AddVertex(x+edgeoffset,z-edgeoffset,surf)
		VE=QTS_AddVertex(x+edgeoffset,z+edgeoffset,surf)
	Else
		QTS_SetMV(x+edgeoffset,z-edgeoffset)
		QTS_SetMV(x+edgeoffset,z+edgeoffset)
	EndIf
	
	xx=x+edgeoffset
	zstart=z-edgeoffset+1
	zend=z-edgeoffset+edgelength-2
	
	For zz=zstart To zend
		
		If QTS_GetMV(xx,zz)&gt;0 Then
			
			If brender Then
				V2=QTS_AddVertex(xx,zz,surf)
				AddTriangle surf,V1,V2,VC
			Else
				QTS_SetMV(xx,zz)
			EndIf
			
			V1=V2
			
		EndIf
		
	Next
	
	If brender Then
		AddTriangle surf,V1,VE,VC
		VC=QTS_AddVertex(x,z,surf)
		V1=QTS_AddVertex(x-edgeoffset,z-edgeoffset,surf)
		VE=QTS_AddVertex(x-edgeoffset,z+edgeoffset,surf)
	Else
		QTS_SetMV(x-edgeoffset,z-edgeoffset)
		QTS_SetMV(x-edgeoffset,z+edgeoffset)
	EndIf
	
	xx=x-edgeoffset
	zstart=z-edgeoffset+1
	zend=z-edgeoffset+edgelength-2
	
	For zz=zstart To zend
		
		If QTS_GetMV(xx,zz)&gt;0 Then
			
			If brender Then
				V2=QTS_AddVertex(xx,zz,surf)
				AddTriangle surf,V2,V1,VC
			Else
				QTS_SetMV(xx,zz)
			EndIf
			
			V1=V2
			
		EndIf
		
	Next
	
	If brender Then AddTriangle surf,VE,V1,VC
	
End Function


; -------------------------------------------------------------------------------------------------
; Creates a Tile patch
; -------------------------------------------------------------------------------------------------
Function QTS_CreatePatch(blocksize%)
	
	Local x%,z%
	Local xtab%,ztab%
	Local xx#,zz#
	Local mesh%,surf%
	Local bx%,bz%,cx%,cz%
	
	While z&lt;=QTS_HeightMapSize
		
		;BT_UpdateBar("Creating Terrain Patches",z,QTS_HeightMapSize,40,50)
		
		x=0
		xtab=0
		
		While x&lt;=QTS_HeightMapSize
			
			xx=x+(blocksize*16/2)
			zz=z+(blocksize*16/2)
			
			mesh=CreateMesh()
			surf=CreateSurface(mesh)
			
			; make tile pickable
			EntityPickMode mesh,2
			
			QTS_Vertex=CreateBank((QTS_HeightMapSize)*(QTS_HeightMapSize)*4)
			
			For bz=8 To blocksize*16 Step 16
				
				For bx=8 To blocksize*16 Step 16
					
					cx=x+bx
					cz=z+bz
					If cx&lt;QTS_HeightMapSize And cz&lt;QTS_HeightMapSize Then QTS_ProcessNode(cx,cz,17,surf,True)
					
				Next
				
			Next
			
			FreeBank QTS_Vertex
			
			EntityParent mesh,QTS_Terrain
			
			t.QTS_TPatch = New QTS_TPatch
			t\mesh=mesh
			t\surf=surf
			t\x=xtab*(blocksize*16/2)*2
			t\y=MeshHeight(mesh)/2
			t\z=-ztab*(blocksize*16/2)*2 
 			t\xtab=xtab
			t\ztab=ztab
			
			PokeInt QTS_Tile,((ztab*64+xtab)*4),Handle(t)
			
			x=x+(blocksize*16)
			
			xtab=xtab+1
			
		Wend
		
		z=z+(blocksize*16)
		ztab=ztab+1
		
	Wend
	
End Function


; -------------------------------------------------------------------------------------------------
; Processes a Node
; -------------------------------------------------------------------------------------------------
Function QTS_ProcessNode(x,z,edgelength%,surf%,brender%)
	
	Local edgeoffset%=(edgelength-1)/2
	Local childoffset=(edgelength-1)/4
	Local node%=QTS_GetMV(x,z)
	
	If node=1 Then
		
		If  edgelength=3 Then
			
			QTS_RenderNode(x,z,edgelength,edgeoffset,surf,brender)
			
		Else
			
			If QTS_GetMV(x-childoffset,z-childoffset)&gt;0 Then
				
				QTS_ProcessNode(x-childoffset,z-childoffset,edgelength-(edgelength/2),surf,brender)
				
			Else
				
				QTS_RenderNode(x-childoffset,z-childoffset,edgelength-(edgelength/2),edgeoffset-(edgeoffset/2),surf,brender)
				
			EndIf
			
			If QTS_GetMV(x+childoffset,z-childoffset)&gt;0 Then
				
				QTS_ProcessNode(x+childoffset,z-childoffset,edgelength-(edgelength/2),surf,brender)
				
			Else
				
				QTS_RenderNode(x+childoffset,z-childoffset,edgelength-(edgelength/2),edgeoffset-(edgeoffset/2),surf,brender)
				
			EndIf
			
			If QTS_GetMV(x-childoffset,z+childoffset)&gt;0 Then
				
				QTS_ProcessNode(x-childoffset,z+childoffset,edgelength-(edgelength/2),surf,brender)
				
			Else
				
				QTS_RenderNode(x-childoffset,z+childoffset,edgelength-(edgelength/2),edgeoffset-(edgeoffset/2),surf,brender)
				
			EndIf
			
			If QTS_GetMV(x+childoffset,z+childoffset)&gt;0 Then
				
				QTS_ProcessNode(x+childoffset,z+childoffset,edgelength-(edgelength/2),surf,brender)
				
			Else
				
				QTS_RenderNode(x+childoffset,z+childoffset,edgelength-(edgelength/2),edgeoffset-(edgeoffset/2),surf,brender)
				
			EndIf
			
		EndIf
		
	Else
		
		QTS_RenderNode(x,z,edgelength,edgeoffset,surf,brender)
		
	EndIf
	
End Function


; -------------------------------------------------------------------------------------------------
; Central Addvertex function
; -------------------------------------------------------------------------------------------------
Function QTS_AddVertex(x%,z%,surf%)
	
	Local y#,v%
	
	If PeekInt(QTS_Vertex,QTS_MatrixIndex(x,z)*4)=0 Then
		
		y=QTS_GetHeight(x,z)
		v=AddVertex(surf,(-QTS_HeightMapSize/2.0)+x,y,(QTS_HeightMapSize/2.0)-z,0,0)
		PokeInt QTS_Vertex, QTS_MatrixIndex(x,z)*4,v+1
		
	Else
		
		v=PeekInt(QTS_Vertex,QTS_MatrixIndex(x,z)*4)-1
		
	EndIf
	
	Return v
	
End Function


; -------------------------------------------------------------------------------------------------
; Loads a Terragen File and its according RAW Colormap / Normalmap
; -------------------------------------------------------------------------------------------------
Function QTS_LoadHeightMap(filename$)
	
	Local xpt%,ypt%,h#
	Local file%=ReadFile(filename)
	
	; read Terragen data
	SeekFile(file,20) : QTS_Size=ReadInt(file)
	SeekFile(file,28) : QTS_XPTS=ReadInt(file)
	SeekFile(file,44) : QTS_XSCALE=ReadFloat(file) : QTS_YSCALE=ReadFloat(file)
	SeekFile(file,60) : QTS_HSCALE=ReadShort(file) : QTS_HBASE=ReadShort(file)
	
	; get the size of the map and create heightmap and quadtree banks
	QTS_HeightMapSize=QTS_XPTS
	QTS_HeightMap=CreateBank(QTS_XPTS*QTS_XPTS*2)
	QTS_QuadTree=CreateBank((QTS_HeightMapSize)*(QTS_HeightMapSize))
	
	; write data to bank
	For ypt=QTS_XPTS To 1 Step -1
		
		;If ypt Mod 32=0 Then BT_UpdateBar("Loading Terragen Data",(QTS_XPTS-ypt+1),QTS_XPTS,0,10)
		
		For xpt=1 To QTS_XPTS Step 1
			PokeShort QTS_HeightMap,((xpt-1)+(ypt-1)*QTS_XPTS)*2,ReadShort(file)-32768
			h=QTS_GetHeight(xpt-1,ypt-1)
			If h&lt;QTS_MinHeight Then QTS_MinHeight=h
			If h&gt;QTS_MaxHeight Then QTS_MaxHeight=h
		Next
	Next
	
	CloseFile(file)
	
End Function


; -------------------------------------------------------------------------------------------------
; Prepares UV-Coordinates, Vertexcolors and Vertexnormals of a tile
; -------------------------------------------------------------------------------------------------
Function QTS_Texture(tiles%,calcnormals%,normalsfactor#,switchnormals%,usevertexcolors%,vertexintensity#,colormap%)
	
	Local x%,z%,obj%,vx#,vz#
	Local surf%,vertices%,v%,rgb%,r%,g%,b%
	Local cbuf%=ImageBuffer(colormap)
	Local cfactor#=ImageWidth(colormap)*1.0/QTS_HeightMapSize
	
	LockBuffer cbuf
	
	For z=0 To tiles-1
		
		;If z Mod 2=0 Then BT_UpdateBar("Calculating Vertex Normals",z,tiles-1,50,70)
		
		For x=0 To tiles-1
			
			obj=PeekInt(QTS_Tile,(z*64+x)*4)
			
			If obj&gt;0 Then
				
				t.QTS_TPatch=Object.QTS_TPatch(obj)
				
				If t\mesh&lt;&gt;-1 Then
					
					surf = GetSurface(t\mesh,1)
					vertices = CountVertices(surf)
					
					For v=0 To vertices-1
						
						; calculate map position from vertex position
						vx=VertexX(surf,v)+(QTS_HeightMapSize/2.0)
						vz=-VertexZ(surf,v)+(QTS_HeightMapSize/2.0)
						
						; Calculate Vertexcolors
						If usevertexcolors Then
							rgb=ReadPixelFast(Int(Floor(vx*cfactor)),Int(Floor(vz*cfactor)),cbuf)
							r=Int(Floor(((rgb And $ff0000)/$10000)*vertexintensity))
							g=Int(Floor(((rgb And $ff00)/$100)*vertexintensity))
							b=Int(Floor(((rgb And $ff))*vertexintensity))
						Else
							r=255*vertexintensity
							g=255*vertexintensity
							b=255*vertexintensity
						EndIf
						r=Int(Floor(r)) : If r&lt;0 Then r=0 Else If r&gt;255 Then r=255
						g=Int(Floor(g)) : If g&lt;0 Then g=0 Else If g&gt;255 Then g=255
						b=Int(Floor(b)) : If b&lt;0 Then b=0 Else If b&gt;255 Then b=255
						
						; Color the vertex
						VertexColor surf,v,r,g,b,1
						
						; calculate Normals by height and vertex
						If calcnormals Then QTS_CalcNormal(surf,v,vx,vz,normalsfactor,switchnormals)
						
						; Calculate UV-Coordinates
						vx#=(vx/((QTS_HeightMapSize-1*1.0)/tiles))-t\xtab
						vz#=(vz/((QTS_HeightMapSize-1*1.0)/tiles))-t\ztab
						VertexTexCoords surf,v,vx,vz
						
					Next
					
				EndIf
				
			EndIf
			
		Next
		
	Next
	
	UnlockBuffer cbuf
	
End Function


; -----------------------------------------------------------------------------
; Calculates the Vertex Normal at a given position
; -----------------------------------------------------------------------------
Function QTS_CalcNormal(surf%,v%,x%,y%,normalsfactor#,switchnormals%)
	
	Local xm1%,xp1%,ym1%,yp1%
	Local tl%,tm%,tr%,ml%,mm%,mr%,bl%,bm%,br%
	Local vx#,vy#,vz#
	Local isq2#,sum#
	Local al#,ar#,at#,ab#
	Local m#
	
	; limit heightmap
	If x&gt;0 Then xm1=x-1 Else xm1=0
	If x&lt;QTS_HeightMapSize-1 Then xp1=x+1 Else xp1=QTS_HeightMapSize-1
	If y&gt;0 Then ym1=y-1 Else ym1=0
	If y&lt;QTS_HeightMapSize-1 Then yp1=y+1 Else yp1=QTS_HeightMapSize-1
	
	; get the middle and the surrounding heights
	tl=QTS_Normalize(QTS_GetHeight(xm1,ym1),QTS_MinHeight,QTS_MaxHeight,0,65535)
	tm=QTS_Normalize(QTS_GetHeight(x  ,ym1),QTS_MinHeight,QTS_MaxHeight,0,65535)
	tr=QTS_Normalize(QTS_GetHeight(xp1,ym1),QTS_MinHeight,QTS_MaxHeight,0,65535)
	ml=QTS_Normalize(QTS_GetHeight(xm1,y  ),QTS_MinHeight,QTS_MaxHeight,0,65535)
	mm=QTS_Normalize(QTS_GetHeight(x  ,y  ),QTS_MinHeight,QTS_MaxHeight,0,65535)
	mr=QTS_Normalize(QTS_GetHeight(xp1,y  ),QTS_MinHeight,QTS_MaxHeight,0,65535)
	bl=QTS_Normalize(QTS_GetHeight(xm1,yp1),QTS_MinHeight,QTS_MaxHeight,0,65535)
	bm=QTS_Normalize(QTS_GetHeight(x  ,yp1),QTS_MinHeight,QTS_MaxHeight,0,65535)
	br=QTS_Normalize(QTS_GetHeight(xp1,yp1),QTS_MinHeight,QTS_MaxHeight,0,65535)
	
	vx=0.0
	vy=0.0
	vz=1.0
	
	isq2=1.0/Sqr(2.0)
	sum=1.0+isq2+isq2
	
	al=(tl*isq2+ml+bl*isq2)/sum
	ar=(tr*isq2+mr+br*isq2)/sum
	at=(tl*isq2+tm+tr*isq2)/sum
	ab=(bl*isq2+bm+br*isq2)/sum
	
	vx=(al-ar)/(65535.0)
	vy=(at-ab)/(65535.0)
	
	m=QTS_Max(0,vx*vx+vy*vy)
	m=QTS_Min(m,1.0)
	
	vz=Sqr(1.0-m) 
	
	If normalsfactor&lt;&gt;0.0
		vz=vz/normalsfactor
		m#=Sqr(vx*vx+vy*vy+vz*vz)
		vx=vx/m
		vy=vy/m
		vz=vz/m
	EndIf
	
	If switchnormals Then VertexNormal surf,v,vx,vz,vy Else VertexNormal surf,v,vx,vy,vz
	
End Function


; -----------------------------------------------------------------------------
; Normalize a value
; -----------------------------------------------------------------------------
Function QTS_Normalize#(value#=128.0,value_min#=0.0,value_max#=255.0,norm_min#=0.0,norm_max#=1.0)
	
	Return ((value#-value_min#)/(value_max#-value_min#))*(norm_max#-norm_min#)+norm_min#
	
End Function


; -------------------------------------------------------------------------------------------------
; Gets a Matrix Value
; -------------------------------------------------------------------------------------------------
Function QTS_GetMV(x%,z%)
	
	Return PeekByte(QTS_QuadTree,QTS_MatrixIndex(x,z))
	
End Function


; -------------------------------------------------------------------------------------------------
; Sets a Matrix Value
; -------------------------------------------------------------------------------------------------
Function QTS_SetMV(x%,z%,value%=1)
	
	PokeByte QTS_QuadTree,QTS_MatrixIndex(x,z),value
	
End Function


; -------------------------------------------------------------------------------------------------
; Gets a Matrix Index
; -------------------------------------------------------------------------------------------------
Function QTS_MatrixIndex(x%,z%)
	
	Return ((z*QTS_HeightMapSize)+x)
	
End Function


; -------------------------------------------------------------------------------------------------
; Returns the minimum value of two values
; -------------------------------------------------------------------------------------------------
Function QTS_Min#(v1#,v2#)
	
	If v1&lt;v2 Then Return v1 Else Return v2
	
End Function


; -------------------------------------------------------------------------------------------------
; Returns the maximum value of two values
; -------------------------------------------------------------------------------------------------
Function QTS_Max#(v1#,v2#)
	
	If v1&gt;v2 Then Return v1 Else Return v2
	
End Function


; -------------------------------------------------------------------------------------------------
; Calculates the exact height at a given position
; -------------------------------------------------------------------------------------------------
Function QTS_GetHeight#(x#,z#)
	
	Local short%=PeekShort(QTS_HeightMap,((Int(Floor(z*QTS_HeightMapSize)))+Int(Floor(x)))*2)-32768
	Return QTS_HBASE+short*QTS_HSCALE/65536.0*QTS_YSCALE
	
End Function</textarea><br><br>QTS_TerrainWriter.bb: <br><br><textarea class=codebox name="code" wrap=OFF readonly="true" rows="15" cols="80">Include "b3dfile.bb"
Include "inc/qts.bb"

Global c_surfs

BT_InitTerrain()

Dim c_surf(c_surfs)
Dim c_brush(c_surfs)
Dim c_tex(c_surfs)
Dim c_tex_name$(c_surfs)

Function WriteBB3D( f_name$,mesh )

	file=WriteFile( f_name$ )

	b3dSetFile( file )
	
	b3dBeginChunk( "BB3D" )
		b3dWriteInt( 1 )	;version

		b3dBeginChunk( "TEXS" ) ; list all textures used by the mesh
		For i=1 To c_surfs
			b3dWriteString( c_tex_name$(i) ) 	;texture file
			b3dWriteInt( 1 )					;flags
			b3dWriteInt( 2 )					;blend
			b3dWriteFloat( 0 )					;x in tex 0 (hu?)
			b3dWriteFloat( 0 )					;y in tex 0
			b3dWriteFloat( 1 )					;x scale 1
			b3dWriteFloat( 1 )					;y scale 1
			b3dWriteFloat( 0 )					;rotation 0
			
		Next
		b3dEndChunk()	;end of TEXS chunk

		
		For i=1 To c_surfs
			b3dBeginChunk( "BRUSH" ) ; describe all brushes used by the mesh
		
			b3dWriteInt( 1 )					;number of textures per brush ; (eg 2 with lightmap)
			b3dWriteString( "brush"+(i-1) )		;brushname
			b3dWriteFloat( 1 )					;red
			b3dWriteFloat( 1 )					;green
			b3dWriteFloat( 1 )					;blue
			b3dWriteFloat( 1 )					;alpha
			b3dWriteFloat( 0 )					;shininess
			b3dWriteInt( 1 )					;blendmode
			b3dWriteInt( 0 )					;FX
			b3dWriteInt( i-1 )					;used texture index 
;			b3dWriteInt( ? )					;additional texture index (eg lightmap), but here we only use 1 (see above)

			b3dEndChunk()	;end of BRUS chunk
		Next
		
		b3dBeginChunk( "NODE" )
			b3dWriteString( "entity_name_here!" )
			b3dWriteFloat( 0 )	;x_pos
			b3dWriteFloat( 0 )	;y_pos
			b3dWriteFloat( 0 )	;z_pos
			b3dWriteFloat( 1 )	;x_scale
			b3dWriteFloat( 1 )	;y_scale
			b3dWriteFloat( 1 )	;z_scale
			b3dWriteFloat( 1 )	;rot_w
			b3dWriteFloat( 0 )	;rot_x
			b3dWriteFloat( 0 )	;rot_y
			b3dWriteFloat( 0 )	;rot_z
			WriteMESH( mesh )
		b3dEndChunk()	;end of NODE chunk
		
	b3dEndChunk()	;end of BB3D chunk
	
	CloseFile file
End Function

; -----------------------------------------------------------------------------------------------
; Creates and scales the Quadtree Terrain Tiles
; -----------------------------------------------------------------------------------------------
Function BT_InitTerrain()
	
	Local path$=BT_MapsPath$+BT_Scene+"\"+BT_HeightmapFile
	
	; Creating the terrain
	QTS_CreateTerrain(path,BT_Tiles,BT_TerrainQuality,BT_CalcNormals,BT_NormalsFactor,BT_SwitchNormals,BT_UseVertexColors,BT_VertexIntensity,BT_ColorMap)
	ScaleEntity QTS_Terrain,QTS_XSCALE,1,QTS_XSCALE

	BT_Scale=QTS_XSCALE*QTS_XPTS
	BT_HalfScale#=BT_Scale/2.0

	c_surfs=CountSurfaces(QTS_Terrain)
	
	; track down used textures (thanks Mark!)
	For i=1 To c_surfs
	 c_surf(i)= GetSurface(mesh,i)
	 c_brush(i)=GetSurfaceBrush( c_surf(i) )
	 c_tex(i)=GetBrushTexture( c_brush(i) )
	 c_tex_name$(i)=Lower$(TextureName$( c_tex(i))) ; Full (!) Texture Path
	 curdir$=Lower$(CurrentDir$()) 
	 c_tex_name$(i)= Replace$(c_tex_name$(i),curdir$,"") ;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;
	 Print c_tex_name$(i)
	 If c_tex_name$(i)="" Then Print "Error: Surface No."+i+" has no Texture"
	 If FileType(c_tex_name$(i))&lt;&gt;1 Then Print "Warning: Surface No."+i+" uses nonexistant Texture ("+c_tex_name$(i)+")."
	Next
	
	WriteBB3D("AzureLake.b3d", QTS_Terrain)
	
End Function</textarea><br><br>Yes, it uses BlitzTiles by KrisChan. (Credit: KrisChan) :)<br><br>Thanks!<br><br>EDIT: If you need an example, download BlitzTiles, then add the WriteBB3D function, the Dims, and the Globals in the correct places in BlitzTiles.bb, then call the c_surfs = and the for loop UNDER c_surfs inside of BT_InitTerrain() when it is loaded so it auto saves.<br><br><font class="tiny">Last edited 2011</font> <br><br></td></tr></table><br>
<a name="1095878"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >stayne</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#2">[#2]</a></td></tr></table></td></tr><tr ><td class="posttext"> QTS_TPatch\mesh is what you are looking for.  They are created during load time. <br><br></td></tr></table><br>
<a name="1095885"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Guy Fawkes</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#3">[#3]</a></td></tr></table></td></tr><tr ><td class="posttext"> thanks @stayne <br><br></td></tr></table><br>
<a name="1095886"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Guy Fawkes</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#4">[#4]</a></td></tr></table></td></tr><tr ><td class="posttext"> that didnt work, @stayne <br><br></td></tr></table><br>
<a name="1095935"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Guy Fawkes</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#5">[#5]</a></td></tr></table></td></tr><tr ><td class="posttext"> it didn't even find \mesh as a type, mate :/ <br><br></td></tr></table><br>
<a name="1095945"></a>

<a name="1095998"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Gabriel</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#6">[#6]</a></td></tr></table></td></tr><tr ><td class="posttext"> Then I suggest you reread what Stayne told you and then reread what you've done instead, because the include file above clearly shows that mesh is a member of QTS_TPatch.<br><br>EDIT: And the variable after the slash is the field, not the type.<br><br><font class="tiny">Last edited 2011</font> <br><br></td></tr></table><br>
<a name="1095971"></a>

<a name="1095972"></a>

<a name="1095973"></a>

<a name="1095975"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Krischan</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#7">[#7]</a></td></tr></table></td></tr><tr ><td class="posttext"> You're lucky - I added a save mesh function for test purposes to my BlitzTiles code a few weeks ago - it's not cleaned up but seems to be working (I remember there was still a problem, guess it was the normal seams problem between the tile seams but I'm not sure).<br><br>Just add/overwrite a BlitzTiles installation with the following files in its root folder. Run the blitztiles.bb and when the scene comes up there should be a new subfolder "B3D/" containing the mesh and the according texture tiles. You can test this saved mesh with the "test.bb" using BlitzSky:<br><br><a href="http://www.christianhart.de/bb/blitztiles_savemesh/blitztiles.bb" target="_blank">blitztiles.bb</a><br><a href="http://www.christianhart.de/bb/blitztiles_savemesh/blitzsky.bb" target="_blank">blitzsky.bb</a><br><a href="http://www.christianhart.de/bb/blitztiles_savemesh/b3dfile.bb" target="_blank">b3dfile.bb</a><br><a href="http://www.christianhart.de/bb/blitztiles_savemesh/test.bb" target="_blank">test.bb</a><br><br>Oh, and you need to create the B3D subfolder yourself or you will get a MAV. And it is only working with 8x8 Tiles now, must be rewritten for other tile numbers (or you'll get weird mesh-&gt;texture alignments).<br><br>I added the call <b>WriteBB3D("B3D/terrain.b3d",BT_Tiles)</b> to the BT_TextureTiles() Function which saves the mesh - the textures are saved in the function BT_CutColorMap(). And you need the updated BlitzSky.bb for the test.bb. I only tested it with the Monkey Island scene - if I missed a file please update this thread, can't test it right now.<br><br>Another way is - if you own the full version of L3DT - the newest beta contains a save tiled mesh function, so you could create the mesh without Blitztiles in L3DT only.<br><br><font class="tiny">Last edited 2011</font> <br><br></td></tr></table><br>
<a name="1096001"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Guy Fawkes</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#8">[#8]</a></td></tr></table></td></tr><tr ><td class="posttext"> thanks, krischan! :)<br><br>much appreciated :) <br><br></td></tr></table><br>
<a name="1096002"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Guy Fawkes</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#9">[#9]</a></td></tr></table></td></tr><tr ><td class="posttext"> @krischan, how would you fix the seams, and the texture?<br><br>Or does L3DT do this for you? <br><br></td></tr></table><br>
<a name="1096009"></a>

<a name="1096010"></a>

<a name="1096014"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Guy Fawkes</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#10">[#10]</a></td></tr></table></td></tr><tr ><td class="posttext"> @Krischan: Ok, I have written some decrypt functions for you to be able to read the Blitz3D terrain file that it writes. It now ALSO writes a decrypted .txt version of the ENTIRE mesh, and not only that, ALSO explains which value belongs to what, such as VertexXCoordinate(#1)=1.0.<br><br>Etc.<br><br><font class="tiny">Last edited 2011</font> <br><br></td></tr></table><br>
<a name="1096011"></a>

<a name="1096013"></a>

<a name="1096015"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Guy Fawkes</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#11">[#11]</a></td></tr></table></td></tr><tr ><td class="posttext"> blitztiles.bb: <br><a href="http://www.mediafire.com/?60kxkosmr708n8j" target="_blank">http://www.mediafire.com/?60kxkosmr708n8j</a><br><br>b3dfile.bb: <br><a href="http://www.mediafire.com/?ur8lj0y1odsojeh" target="_blank">http://www.mediafire.com/?ur8lj0y1odsojeh</a><br><br>EDIT: Sorry for the double post. I didn't realize the files were too big to put in a codebox &gt;&lt;<br><br><font class="tiny">Last edited 2011</font> <br><br></td></tr></table><br>
<a name="1096036"></a>

<a name="1096037"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Krischan</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#12">[#12]</a></td></tr></table></td></tr><tr ><td class="posttext"> For the seams - I stopped working at this point - but I think it could be done by aligning the opposite tile seams / normals (if they match or it's getting complex) - not sure if I really want to code that as L3DT can do it as I mentioned before (and L3DT imports Terragen, too :-) I must look in my messy code archive, I think I coded such a seam fix before in another situation but dunno where it is...<br><br><font class="tiny">Last edited 2011</font> <br><br></td></tr></table><br>
<a name="1096047"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Guy Fawkes</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#13">[#13]</a></td></tr></table></td></tr><tr ><td class="posttext"> @KrisChan, I'm at work now, so I can't test it, but when I get home, if you want me to test the seams fix, I can! :)<br><br>Thanks again! :)<br><br>P.S. I hope u liked the decryption code! :) <br><br></td></tr></table><br>
<a name="1096076"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Guy Fawkes</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#14">[#14]</a></td></tr></table></td></tr><tr ><td class="posttext"> @Krischan, no sweat. I did the work of searching for the seam fix for you :)<br><br>It's in post #52 at THIS link: <br><br><a href="http://blitzbasic.com/Community/posts.php?topic=84809#973131" target="_blank">http://blitzbasic.com/Community/posts.php?topic=84809#973131</a><br>Hope that helps! :)<br><br>~Rez <br><br></td></tr></table><br>
<a name="1096089"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Gabriel</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#15">[#15]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> I did the work of searching for the seam fix for you :) <br></div><br>My hero. <br><br></td></tr></table><br>
<a name="1096090"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Guy Fawkes</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#16">[#16]</a></td></tr></table></td></tr><tr ><td class="posttext"> Lmao! <br><br></td></tr></table><br>
<a name="1096092"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Who was John Galt?</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#17">[#17]</a></td></tr></table></td></tr><tr ><td class="posttext"> @Rez... looks like you are actually putting some work in this time. This is a positive step forward, and I'm not just saying that because I got a slap on the wrist from the mods. Keep it up and you will see results. <br><br></td></tr></table><br>
<a name="1096093"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Guy Fawkes</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#18">[#18]</a></td></tr></table></td></tr><tr ><td class="posttext"> Thanks, John. Now see? Why can't it ALWAYS be that way? :) <br><br></td></tr></table><br>
<a name="1096127"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Guy Fawkes</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#19">[#19]</a></td></tr></table></td></tr><tr ><td class="posttext"> Here's the code, @Krischan. :)<br><br><textarea class=codebox name="code" wrap=OFF readonly="true" rows="15" cols="80">		; align texture seams
	For y=0 To BT_Tiles-1
		
		;BT_UpdateBar("Align Texture Seams",y,BT_Tiles-1,80,90)
		
		For x=0 To BT_Tiles-1
			
			LockBuffer TextureBuffer(BT_TileTexture(x,y))
			
			If x&lt;BT_Tiles-1 Then LockBuffer TextureBuffer(BT_TileTexture(x+1,y))
			If y&lt;BT_Tiles-1 Then LockBuffer TextureBuffer(BT_TileTexture(x,y+1))
			
			For z=0 To BT_TextureSize-1
				
				; horizontal
				If x&lt;BT_Tiles-1 Then
					rgb=ReadPixelFast(0,z,TextureBuffer(BT_TileTexture(x+1,y)))
					WritePixelFast BT_TextureSize-1,z,rgb,TextureBuffer(BT_TileTexture(x,y))
				EndIf
				
				; vertical
				If y&lt;BT_Tiles-1 Then
					rgb=ReadPixelFast(z,0,TextureBuffer(BT_TileTexture(x,y+1)))
					WritePixelFast z,BT_TextureSize-1,rgb,TextureBuffer(BT_TileTexture(x,y))
				EndIf
				
			Next
			
			UnlockBuffer TextureBuffer(BT_TileTexture(x,y))
									
			If x&lt;BT_Tiles-1 Then UnlockBuffer TextureBuffer(BT_TileTexture(x+1,y))
			If y&lt;BT_Tiles-1 Then UnlockBuffer TextureBuffer(BT_TileTexture(x,y+1))
			
		Next
	Next</textarea><br><br>Now all's you gotta do is implement it into the WriteBB3D function :) <br><br></td></tr></table><br>
<a name="1096132"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Hotshot2005</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#20">[#20]</a></td></tr></table></td></tr><tr ><td class="posttext"> Well done for putting your mind into it :) <br><br></td></tr></table><br>
<a name="1096135"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Guy Fawkes</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#21">[#21]</a></td></tr></table></td></tr><tr ><td class="posttext"> Thanks, @Hotshot :) <br><br></td></tr></table><br>
<a name="1096170"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Krischan</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#22">[#22]</a></td></tr></table></td></tr><tr ><td class="posttext"> The problem are not the texture seams, it's the vertex normals. I think I can add a Fixchunks Functions to align the normals, must find some time for this, but I'm too busy right now. <br><br></td></tr></table><br>
<a name="1096171"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Guy Fawkes</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#23">[#23]</a></td></tr></table></td></tr><tr ><td class="posttext"> ok cool :) While we're at it, can we fix the texture problem too when you get some time? :) <br><br></td></tr></table><br>
<a name="1096214"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Krischan</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#24">[#24]</a></td></tr></table></td></tr><tr ><td class="posttext"> Oh damn damn damn what a *$%43q3l bug. After searching two hours for a solution I can't believe it that didn't see that before. The solution is THAT simple:<br><br>just uncommented the UpdateNormals call in the WriteMesh function and everything is fine. The Normals are already calculated correct and the damn Updatenormals destroyed them. phew...<br><br>I uploaded the corrected blitztiles.bb to the same location, so just overwrite it again and everything should be fine.<br><br>Except one bug I found searching for this bug. I'm no expert at the B3D format but my B3D write function writes a strange B3D file. It opens without any problem in Ultimate Unwrap 3D and even in Blitz3D, but my saved mesh has only one surface (Countsurfaces) and when I save the same mesh in Ultimate Unwrap 3D it has 64 surfaces. But I dunno why. Any suggestions? <br><br></td></tr></table><br>
<a name="1096215"></a>

<a name="1096217"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Guy Fawkes</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#25">[#25]</a></td></tr></table></td></tr><tr ><td class="posttext"> I HATE that! x) LOL!<br><br>Um, try to use the decrypt function I gave you in an earlier post above these comments. :)<br><br>It writes out the ENTIRE B3D mesh AS WELL as writing the ENTIRE mesh in a human readable form, and inserts it into a text file! :)<br><br>Simply call DecryptBB3D under WriteBB3D and it will work JUST fine :)<br><br>the parameters of DecryptBB3D are the same as WriteBB3D :)<br><br><font class="tiny">Last edited 2011</font> <br><br></td></tr></table><br>
<a name="1096218"></a>

<a name="1096219"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Guy Fawkes</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#26">[#26]</a></td></tr></table></td></tr><tr ><td class="posttext"> Just download these new b3dfile.bb, blitztile.bb, and test.bb files.<br><br>I updated them to work correctly, and uncommented UpdateNormals mesh, but that STILL didn't work...<br><br>b3dfile.bb: <br><br><a href="http://www.mediafire.com/?f8rmd4epnp271ys" target="_blank">http://www.mediafire.com/?f8rmd4epnp271ys</a><br>blitztiles.bb: <br><br><a href="http://www.mediafire.com/?hzkgjh82u788wwy" target="_blank">http://www.mediafire.com/?hzkgjh82u788wwy</a><br><br>test.bb: <br><br><a href="http://www.mediafire.com/?hvwsvu4vbb6bwyh" target="_blank">http://www.mediafire.com/?hvwsvu4vbb6bwyh</a><br><br>EDIT: <br><br>ALSO, here's what it's doing to both my terrain AND my textures on the terrain: <br><br><img src="http://img163.imageshack.us/img163/2641/seamsglitchagain.png"><br><br>If you could fix this texture problem and seam problem, that would be GREAT! :)<br><br>Hope this helps! :)<br><br>~Rez<br><br><font class="tiny">Last edited 2011</font> <br><br></td></tr></table><br>
<a name="1096222"></a>

<a name="1096223"></a>

<a name="1096224"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Guy Fawkes</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#27">[#27]</a></td></tr></table></td></tr><tr ><td class="posttext"> Here's an image from Blitztile of my level Azurelake: <br><br><img src="http://img12.imageshack.us/img12/5937/seamglitchinblitztiles.png"><br><br>Why is it doing this? T_T<br><br>The size of my ter file is 1025<br><br>The size of my heightmap is 1025<br><br>The size of my texturemap is 1024<br><br>The size of my colormap is 1024<br><br>Here's what's in azurelake.ini: <br><br><textarea class=codebox name="code" wrap=OFF readonly="true" rows="15" cols="80">[Scene]
Heightmap=azurelake.ter
Colormap=azurelake_colormap.bmp
Texture=azurelake_texture.png
Preview=azurelake_preview.jpg
Tiles=8
Quality=32.0
IsIsland=1
WaterSpeed=8.0
ShoreSpeed=4.0
WaterAlpha=0.5
WaterLevel=450.0
ShoreMove=1
ShowGround=1
ShowOcean=1
ShowSeams=0
ShowMeshtiles=1
ShowPlaces=0

[Light]
NormalsFactor=100.0
SwitchNormals=1
SunLightIntensity=75
MoonLightIntensity=75
UseVertexColors=1
UseTexture=1
UseDetailmaps=1
VertexcolorsIntensity=2.0
ShowLights=1
SunLightType=2
MoonLightType=1

[Textures]
DetailMap1=detail2.dds
DetailMap2=detail2.dds
DetailScale1=16
DetailScale2=1024

[Sky]
Stars=1000
SunInclination=60.0
MoonPhase=0.0
MoonInclination=60.0
CloudSpeed=8.0
CloudScale=8.0
SunAngle=225
MoonAngle=225
HazeHeight=0.5
ShowHaze=1
ShowSky=1
ShowStarTwinkle=1
ShowBrightness=1

[Camera]
CameraMode=1
CameraMinRange=1.0
CameraMaxRangeMulti=0.75
FogMinRange=0.0
FogMaxRangeMulti=0.6
CameraCollisionRadius=0.5
CameraPlayerDistanceY=100
CameraPlayerDistanceZ=100
CameraFOV=90.0
ShowWireframe=0
ShowFog=1

[Player]
PlayerHeight=0.6
PlayerSpeed=0.2
Gravity=0.5
AlignPlayer=0
StartpositionX=193.45
StartpositionZ=-1511.35
Rotation=-90

[Minimap]
MinimapPlayerR=255
MinimapPlayerG=0
MinimapPlayerB=0
MinimapFrustumR=0
MinimapFrustumG=255
MinimapFrustumB=0
MinimapFrustumA=0.75</textarea><br><br>Is it something I did?<br><br>If so, what is it? and why?<br><br><font class="tiny">Last edited 2011</font> <br><br></td></tr></table><br>
<a name="1096257"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Krischan</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#28">[#28]</a></td></tr></table></td></tr><tr ><td class="posttext"> To find a solution, I need the whole azurelake map with all files in a ZIP file (ter, colormap, texture, ini) <br><br></td></tr></table><br>
<a name="1096269"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Guy Fawkes</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#29">[#29]</a></td></tr></table></td></tr><tr ><td class="posttext"> Ok. here it is: <br><br><a href="http://www.mediafire.com/?yxv2ocoivwyv9dn" target="_blank">http://www.mediafire.com/?yxv2ocoivwyv9dn</a> <br><br></td></tr></table><br>
<a name="1096309"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Guy Fawkes</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#30">[#30]</a></td></tr></table></td></tr><tr ><td class="posttext"> Is that enough? Or do you need more? <br><br></td></tr></table><br>
<a name="1096319"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Krischan</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#31">[#31]</a></td></tr></table></td></tr><tr ><td class="posttext"> Sorry Rez but I can't find any flaw, see yourself:<br><br><img src="http://img713.imageshack.us/img713/5186/azurelake.jpg"><br><br>Did you modify the BlitzTiles.bb? By the way - the colormap must match the terragen size - it should be 1025x1025 instead of 1024x1024 - it represents the vertex colors. And the texture has a flaw - you can clearly see some horizontal / vertical lines there. <br><br></td></tr></table><br>
<a name="1096320"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Guy Fawkes</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#32">[#32]</a></td></tr></table></td></tr><tr ><td class="posttext"> i see. well if u go into flight mode and go high into the sky for a while, then look back down, u'll CLEARLY see the seams glitch :) <br><br></td></tr></table><br>
<a name="1096323"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Guy Fawkes</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#33">[#33]</a></td></tr></table></td></tr><tr ><td class="posttext"> Here's what it looks like with the seams glitch<br><br><img src="http://img26.imageshack.us/img26/4363/seamsglitchathirdtime.png"> <br><br></td></tr></table><br>
<a name="1096330"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Kryzon</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#34">[#34]</a></td></tr></table></td></tr><tr ><td class="posttext"> Try calling UpdateNormals() on this mesh, after finishing building it up. This seam is caused by lighting. <br><br></td></tr></table><br>
<a name="1096333"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Guy Fawkes</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#35">[#35]</a></td></tr></table></td></tr><tr ><td class="posttext"> Nope. still didn't work.<br><br><textarea class=codebox name="code" wrap=OFF readonly="true" rows="15" cols="80">	WriteBB3D("B3D/terrain.b3d",BT_Tiles)
	DecryptBB3D("B3D/terrain.b3d",BT_Tiles)
	UpdateNormals(mesh)</textarea> <br><br></td></tr></table><br>
<a name="1096349"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Kryzon</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#36">[#36]</a></td></tr></table></td></tr><tr ><td class="posttext"> Is 'mesh' composed of several smaller meshes\tiles? if so you'll have to iterate through each one of them and call UpdateNormals(). <br><br></td></tr></table><br>
<a name="1096356"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Guy Fawkes</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#37">[#37]</a></td></tr></table></td></tr><tr ><td class="posttext"> Not sure. I can't seem to find where it BUILDS the actual mesh. <br><br></td></tr></table><br>
<a name="1096433"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Krischan</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#38">[#38]</a></td></tr></table></td></tr><tr ><td class="posttext"> If you compare our both screenshots, your minimap seems to be messed up but I can't explain why (looks distorted).<br><br>Anyway, try this file, it includes all source and data with your map and I don't see any seams there. I changed only one setting: from 8 tiles to 2 tiles - your texture / terragen file wasn't THAT large to use 8x8 tiles here.<br><br>If this is not working it must be an error with your system/configuration.<br><br><a href="http://www.mediafire.com/?baohszil48xxvcc" target="_blank">http://www.mediafire.com/?baohszil48xxvcc</a> <br><br></td></tr></table><br>
<a name="1096455"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Guy Fawkes</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#39">[#39]</a></td></tr></table></td></tr><tr ><td class="posttext"> its still doing it &gt;&lt; both with test.bb AND blitztiles.bb &gt;&lt;<br><br><img src="http://img856.imageshack.us/img856/9617/seamsglitchyetagain.png"> <br><br></td></tr></table><br>
<a name="1096533"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Guy Fawkes</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#40">[#40]</a></td></tr></table></td></tr><tr ><td class="posttext"> do u need the files again? <br><br></td></tr></table><br>
<a name="1096654"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Guy Fawkes</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#41">[#41]</a></td></tr></table></td></tr><tr ><td class="posttext"> Any luck with the terrain code fix? <br><br></td></tr></table><br>
<a name="1097091"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >JustLuke</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#42">[#42]</a></td></tr></table></td></tr><tr ><td class="posttext"> Sorry to hijack this thread, but your attitude <i>sucks</i>, Rez.<br><br>I've been browsing these forums over the last few weeks and not only have you had several obnoxious temper tantrums, you've also thrown around homophobic and racist comments. Despicable.<br><br>A few of your recent gems from two separate discussion topics:<br><br><div class="quote"> U still dont learn do u? u MUST be mexican ;)  <br></div><br><div class="quote"> Don't let the door hit ya where the good lord split ya, "Gay fried chicken" ;)  <br></div><br>What the heck is wrong with you?<br><br>People have been banned for far less and I really don't know why you or your comments are allowed to remain here. You need help, Rez, but the problems that you should look at fixing lay within yourself rather than within your code. <br><br></td></tr></table><br>
<a name="1097130"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Graythe</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#43">[#43]</a></td></tr></table></td></tr><tr ><td class="posttext"> A personal theory is that we have a Chupacabre in our midst. Everyone has tried to help but it's like trying to fill a quantum singularity by pouring angel delight into it. <br><br></td></tr></table><br>
<a name="1097182"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >stayne</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#44">[#44]</a></td></tr></table></td></tr><tr ><td class="posttext"> It's amazing how one person can come into a tightly-knit community and wreak havoc.  It's really discouraging that he can get away with it for so long.  Makes me want to drink... <br><br></td></tr></table><br>
<a name="1097245"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Who was John Galt?</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#45">[#45]</a></td></tr></table></td></tr><tr ><td class="posttext"> +1 to JustLuke.<br><br>I can't help but laugh when some of those who reprimanded me for calling him on his antics are now on the receiving end. He definitely seems to enjoy some kind of special grace here, for reasons which escape me. <br><br></td></tr></table><br>
<a name="1097266"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Graythe</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#46">[#46]</a></td></tr></table></td></tr><tr ><td class="posttext"> It does though go to show the enormous lengths that people here will go to in order to help people complete projects. It's all the more amazing because, as far as I'm aware, no-one gets paid a bean to do that.<br><br>At first I did think that you (@John) were taking a hard line towards someone with a few learning difficulties but after reading up on the history it's all too easy to comprehend your stance. At no time did you become abusive or resort to improper language and always tried to give the guy sound advice as did others. The greatest shame is that the chap completely failed to take any advice to heart because if the tremendous energies evidenced by the repeated attempts to obtain free code were channelled into programming then the guy would probably, eventually,  make something of worth. I think you deserve some kind of medal. <br><br></td></tr></table><br>
<a name="1097300"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Who was John Galt?</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#47">[#47]</a></td></tr></table></td></tr><tr ><td class="posttext"> Haha.... medal? Well thankyou Graythe, but I don't delude myself that I'm any angel, and others here are far more patient and helpful than me. <br><br>I do have my moments, though. I can understand how my actions could be misperceived by those like yourself without a handle on the history. The strange thing is that some of his most ardent supporters are all too aware of that history. <br><br></td></tr></table><br>
<a name="1097336"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Graythe</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#48">[#48]</a></td></tr></table></td></tr><tr ><td class="posttext"> Well, something may have been learned otherwise we would have had another tantrum. Well done. <br><br></td></tr></table><br>
<a name="1097337"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >stayne</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#49">[#49]</a></td></tr></table></td></tr><tr ><td class="posttext"> Learned...or modded. <br><br></td></tr></table><br>
<a name="bottom"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td align="right"><a href="http://monkeycoder.co.nz" target="_blank"><img src="/img/monkey2.svg" ></a> <a href="https://github.com/blitz-research" target="_blank"><img src="/img/github.svg" ></a> <a href="https://discord.gg/qJccbSp" target="_blank"><img src="/img/discord.svg" ></a></td></tr></table><br></div><br><table width="100%"><tr><td></body></html lang="en">
