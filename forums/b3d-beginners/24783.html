<!DOCTYPE html><html lang="en" ><head ><title >Fast writing to a screen buffer</title><meta name='viewport' content='width=device-width, initial-scale=0.66'><meta name='description' content='language:basic, target:desktop, category:game development'><link rel="styleSheet" href="../skins/granite/style.css" type="text/css"><style type="text/css">div.bbcode {padding: 8px;background: #E5E5E5;color: #000000;border: 1px dashed #B4B4BE;}</style></head><body ><table width=100% cellspacing=0 cellpadding=0><tr ><td class="menubarleft"></td><td class="menubar"><table cellspacing="0" cellpadding="0"><tr ><td >&nbsp;</td><td class="menuitemleft"></td><td class="menuitem"><a href="/" class="menuitem">News</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/forums.php" class="menuitem">Forums</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/codearcs.php" class="menuitem">Code</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/logs.php" class="menuitem">Logs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/gallery.php" class="menuitem">Gallery</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/sdkspecs.php" class="menuitem">Specs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/search.php" class="menuitem">Search</a></td><td class="menuitemright"></td></tr></table></td><td class="menubarright"></td></tr></table><div class="main"><h1 >Fast writing to a screen buffer</h1><a href="forums.php" >Blitz3D Forums</a>/<a href="topics.php?forum=5" >Blitz3D Beginners Area</a>/<a href="#bottom" >Fast writing to a screen buffer</a><br><br>
<a name="257178"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >JBR</td><td align="right"><font class=tiny>(Posted 2003)</font>&nbsp;<a href="#1">[#1]</a></td></tr></table></td></tr><tr ><td class="posttext"> Hi, basically trying to write a 'list' of 'pixels' to the screen buffer.<br><br>After doing a LockBuffer, is using WritePixelFast the fastest possible way. ( what exactly does LockBuffer do? )<br>Is there a way to find the address of the buffer and write directly?<br><br>I'm assuming that WritePixel is slower but why have both?<br><br>Also after initialising the screen to 1024,768,16 do I need to do a LockedFormat() to find out the r,g,b format of the pixels. Mine says 5,6,5 but must I check in case other peoples computer says otherwise?<br><br>Am I right in thinking alpha ( what ever it is ) is not used in 16bit screens?<br><br>I'm using B+<br>Thanks in advance<br>Marg <br><br></td></tr></table><br>
<a name="257194"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >SSS</td><td align="right"><font class=tiny>(Posted 2003)</font>&nbsp;<a href="#2">[#2]</a></td></tr></table></td></tr><tr ><td class="posttext"> if your using WritePixelFast, you dont need to use LockedFormat() WritePixelFast is not fast enough for real time effects by anymeans, the only really fast way is using B+. <br><br></td></tr></table><br>
<a name="257197"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >skidracer</td><td align="right"><font class=tiny>(Posted 2003)</font>&nbsp;<a href="#3">[#3]</a></td></tr></table></td></tr><tr ><td class="posttext"> The fastest way to write to a buffer would probably be using LockedPixels and a CopyBank loop to transfer a line at a time from a native blitz array [].<br><br>LockedFormat is for use with LockedPixels not LockBuffer, for you situation I would test if mode is not 5,6,5 and do a tidy exit, I would guess only one form of legacy matrox user is going to suffer.<br><br>Optional 640x480 support will give you most dramatic speedup of course. <br><br></td></tr></table><br>
<a name="257220"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >jondecker76</td><td align="right"><font class=tiny>(Posted 2003)</font>&nbsp;<a href="#4">[#4]</a></td></tr></table></td></tr><tr ><td class="posttext"> I am having the same problem. Even using a locked buffer, and readpixelfast on a 320x240 image buffer, my frame rate creeps below 2-3 fps. Here is what i'm doing:<br>1) Make a simple project with a light, camera, and a cube at 320x240 resolution<br>2) put the following code in the main loop Just a single loop using readpixelfast<br><pre class=code>
lockbuffer backbuffer()
For x = 0 to GraphicsWidth()
  For Y = 0 to GraphicsHeight()
    thisPixel = ReadPixelFast(x,y,backbuffer())
  next
next
unlockbuffer backbuffer()
</pre><br><br>Why is it that a single pass through all pixels at such a low resolution would completely kill my framerate when I've seen so many cool demos with copper effects, other effects which were likely done by modifying a buffer, etc. which run just fine. I mean for any type of effect like that you will have to at least loop through all pixels once with read and/or writepixel. The effect I want to do will need at least 3 such loops per render. Is there anyghing I can do to speed it up? <br><br></td></tr></table><br>
<a name="257224"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Beaker</td><td align="right"><font class=tiny>(Posted 2003)</font>&nbsp;<a href="#5">[#5]</a></td></tr></table></td></tr><tr ><td class="posttext"> You are reading outside the screen i think.  You should change that to:<br><pre class=code>
lockbuffer backbuffer()
For x = 0 to GraphicsWidth()-1
  For Y = 0 to GraphicsHeight()-1
    thisPixel = ReadPixelFast(x,y,backbuffer()) And $FFFFFF
  next
next
unlockbuffer backbuffer()
</pre><br><br>Having said that, this isn't the fastest way.  skidracer explains a faster solution above. <br><br></td></tr></table><br>
<a name="257235"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >jondecker76</td><td align="right"><font class=tiny>(Posted 2003)</font>&nbsp;<a href="#6">[#6]</a></td></tr></table></td></tr><tr ><td class="posttext"> can anybody explain to me what locked pixels are and why they are faster? I've heard of locking a buffer, but not locking pixels... Also, you can't always use banks, arrays, etc, bucause for some things you have to grab the backbuffer pixels to modify them.  I must be missing something, what is it? <br><br></td></tr></table><br>
<a name="257250"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >WolRon</td><td align="right"><font class=tiny>(Posted 2003)</font>&nbsp;<a href="#7">[#7]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> lockbuffer backbuffer()<br>For x = 0 to GraphicsWidth()<br>  For Y = 0 to GraphicsHeight()<br>    thisPixel = ReadPixelFast(x,y,backbuffer())<br>  next<br>next<br>unlockbuffer backbuffer() <br></div><br><br>For one thing, you are calling the GraphicsHeight() function every loop of your x loop (which would be 320 times).  What a waste of processiing time.  You only need to find out the width of the screen once.  It certainly would be a lot faster to just call it one time before your loop and save it to a variable.  Your code would look something like:<br><pre class=code>
lockbuffer backbuffer()
height = GraphicsHeight() - 1
For x = 0 to GraphicsWidth() - 1
  For Y = 0 to height
    thisPixel = ReadPixelFast(x,y,backbuffer())
  next
next
unlockbuffer backbuffer()
</pre><br><br>And that's about as fast as ReadPixelFast is going to get.  Reads from the graphic card are pathetically slow, but writes are extremely fast.  So, if you can store the image in a bank or array (or even another imagebuffer as long as you aren't doing any Read-ing) and then copy it to the backbuffer() with your changes, you will see a huge performance increase. <br><br></td></tr></table><br>
<a name="257258"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Beaker</td><td align="right"><font class=tiny>(Posted 2003)</font>&nbsp;<a href="#8">[#8]</a></td></tr></table></td></tr><tr ><td class="posttext"> LockedPixels are faster because Blitz gives you direct access to the block of memory used for the buffer (in the form of a bank).  The downside to this is that you have to work out what pixel format is used in that memory block and adjust it to whatever you want to do with it.  Complicated but not that complicated.<br><br>Read/WritePixelfast on the other hand do all that work for you.  That is also why it is slower. <br><br></td></tr></table><br>
<a name="257265"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >jondecker76</td><td align="right"><font class=tiny>(Posted 2003)</font>&nbsp;<a href="#9">[#9]</a></td></tr></table></td></tr><tr ><td class="posttext"> would it be any faster to create a texture with the 256 flag and then use readpixel with it? <br><br></td></tr></table><br>
<a name="257279"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >WolRon</td><td align="right"><font class=tiny>(Posted 2003)</font>&nbsp;<a href="#10">[#10]</a></td></tr></table></td></tr><tr ><td class="posttext"> Are LockedFormat and LockedPixels undocumented commands/functions?  I can't find them in the online docs.<br><br>(And if they are undocumented, where can I find a document?) <br><br></td></tr></table><br>
<a name="257283"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >jondecker76</td><td align="right"><font class=tiny>(Posted 2003)</font>&nbsp;<a href="#11">[#11]</a></td></tr></table></td></tr><tr ><td class="posttext"> Wolron - <br>Just looked in the online docs - LockedFormat and LockedPixels are in BlitzPlus only. Thats too bad! I really needed the extra speed for my project - and it has to be in 3d!<br><br>Now that I'm dealing with this issue, it would be nice if we had commands for:<br>RenderWorld to any buffer (not just backbuffer)<br>RenderWorld to a bank (this would be sweet and make things like what i'm trying to do soooo fast!)<br>along with the LockedFormat/LockedPixels commands that are already in BlitzPlus!<br><br>FYI:<br>I've written an anaglyph rendering engine (the 3D that can be seen through red/blue 3d glasses). So far, it does work real time, but only at about 10 FPS, with some really wicked optimizations in there. I'm being killed by the readpixelfast section, whith such code removed, framerate increases 10+ fold. The engine is complete, but a bit too slow for any serious projects. Hopefully we will see some of the above requests in the future and I can get this thing to run 30 FPS or so fullscreen. Anyways, below is a screenshot of the anaglyph enging running. Of course, seeing it in real time (through red/blue glasses) is a much better experience than a still image. <br><img src="http://www.ashtabula.tv/~jon_d/mr_roboto.jpg"> <br><br></td></tr></table><br>
<a name="257323"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >skidracer</td><td align="right"><font class=tiny>(Posted 2003)</font>&nbsp;<a href="#12">[#12]</a></td></tr></table></td></tr><tr ><td class="posttext"> I would suggest rendering with blackbackground into 256x256 viewports (left adjacent to right), then use 2 CopyRects after each RenderWorld to place renders into 2 textures created with flags=256, then compose the final back buffer using scene with 2 renders set to additive blend mode, with each slide set to relevant filter color. <br><br></td></tr></table><br>
<a name="257379"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >jondecker76</td><td align="right"><font class=tiny>(Posted 2003)</font>&nbsp;<a href="#13">[#13]</a></td></tr></table></td></tr><tr ><td class="posttext"> thanks, i'll give that a try. I'm pretty new to this per-pixel stuff, but its getting to be pretty entertaining <br><br></td></tr></table><br>
<a name="257458"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >JBR</td><td align="right"><font class=tiny>(Posted 2003)</font>&nbsp;<a href="#14">[#14]</a></td></tr></table></td></tr><tr ><td class="posttext"> For skidracer,<br><br>Lets say I'm doing a starfield with stars all over the screen. Would it be best to do LockedPixels to return the bank address. Is this just like the start of an array, the array being the hidden screen?<br><br>Then use PokeShort( bank, offset ) for each star. (16bits).<br><br>Not sure about CopyBank. For general sprites would the normal sprite plotting commands be fastest?<br><br>Thanks<br>Marg <br><br></td></tr></table><br>
<a name="257528"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >skidracer</td><td align="right"><font class=tiny>(Posted 2003)</font>&nbsp;<a href="#15">[#15]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> the array being the hidden screen? <br></div><br><br>Yes, but the concepts of the memory being locked and at the other end of an AGP bus with caches that prefer sequential to random write accesses (and a multiple worse for reads) seems a bit much to get into. A few bold claims that pbly would stand up to testing:<br><br>* The LockedPixels / LockBuffer command itself will be the biggest cripple as they block the processor while waiting for graphics card to finish (for example the most recent flip or cls command issued)<br><br>* Once you get enough stars on the screen running the entire star field in ram from a CreateBank and copying sequentially in place of your cls will probably become superior performer. <br><br></td></tr></table><br>
<a name="bottom"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td align="right"><a href="http://monkeycoder.co.nz" target="_blank"><img src="/img/monkey2.svg" ></a> <a href="https://github.com/blitz-research" target="_blank"><img src="/img/github.svg" ></a> <a href="https://discord.gg/qJccbSp" target="_blank"><img src="/img/discord.svg" ></a></td></tr></table><br></div><br><table width="100%"><tr><td></body></html lang="en">
