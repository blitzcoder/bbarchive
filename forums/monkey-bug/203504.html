<!DOCTYPE html><html lang="en" ><head ><title >Android: texture flushing error when restarting</title><meta name='viewport' content='width=device-width, initial-scale=0.66'><meta name='description' content='language:basic, target:desktop, category:game development'><link rel="styleSheet" href="../skins/granite/style.css" type="text/css"><style type="text/css">div.bbcode {padding: 8px;background: #E5E5E5;color: #000000;border: 1px dashed #B4B4BE;}</style></head><body ><table width=100% cellspacing=0 cellpadding=0><tr ><td class="menubarleft"></td><td class="menubar"><table cellspacing="0" cellpadding="0"><tr ><td >&nbsp;</td><td class="menuitemleft"></td><td class="menuitem"><a href="/" class="menuitem">News</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/forums.php" class="menuitem">Forums</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/codearcs.php" class="menuitem">Code</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/logs.php" class="menuitem">Logs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/gallery.php" class="menuitem">Gallery</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/sdkspecs.php" class="menuitem">Specs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/search.php" class="menuitem">Search</a></td><td class="menuitemright"></td></tr></table></td><td class="menubarright"></td></tr></table><div class="main"><h1 >Android: texture flushing error when restarting</h1><a href="forums.php" >Monkey Forums</a>/<a href="topics.php?forum=501" >Monkey Bug Reports</a>/<a href="#bottom" >Android: texture flushing error when restarting</a><br><br>
<a name="2036984"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >secondgear</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#1">[#1]</a></td></tr></table></td></tr><tr ><td class="posttext"> <b>UPDATE 2:</b> Mark solved this problem in v61, please move on, nothing to see here :)<br><b>UPDATE 1:</b> scroll down to the proposed solution for v60<br><br><b>The app</b><br>The app has a "cover" scene, followed by a "menu" scene. Cover scene loads one image only, animates it, and then loads the "menu" scene, which in turn loads whole bunch of additional images.<br><br><b>The symptoms</b><br>Case 1:<br> (Step 1) Launch the app, let it load images, exit the app with <b>finish()</b><br> (Step 2) Re-launch the app -&gt; one of the textures is assigned to a wrong Image in the second ("menu") scene.<br>Case 2:<br> (Step 1) Launch the app, let it load images, exit with <b>System.exit(0)</b><br> (Step 2) Re-launch the app -&gt; everything is fine <br><br></td></tr></table><br>
<a name="2036974"></a>

<a name="2036959"></a>

<a name="2036973"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >secondgear</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#2">[#2]</a></td></tr></table></td></tr><tr ><td class="posttext"> Here is my solution (applied to v60):<br><br>(1) Add static int to MonkeyGame:<br>[monkeycode]<br>static int sessionId;<br>[/monkeycode]<br><br>(2) Increment sessionId in onCreate:<br>[monkeycode]<br>sessionId++;<br>[/monkeycode]<br><br>(3) Add a session id stamp to each gxtkSurface instance:<br>[monkeycode]<br>class gxtkSurface{<br><br>	Bitmap bitmap;<br>	int sessionId; //' &lt;--- here<br>	<br>	int width,height;<br>	<br>	boolean hasAlpha;<br>	<br>	int texId,seq;<br>	float uscale,vscale;<br><br>	static Vector discarded=new Vector();<br>	<br>	gxtkSurface( Bitmap bitmap, String srcFile ){<br>		this.bitmap=bitmap;<br>		this.sessionId = MonkeyGame.sessionId; //'&lt;--- and here<br>		width=bitmap.getWidth();<br>		height=bitmap.getHeight();<br>		hasAlpha=bitmap.hasAlpha();<br>	}<br>}<br>[/monkeycode]<br><br>(4) And discard texture ONLY IF surface's sessionId equals current sessionId:<br>[monkeycode]<br>int Discard(){<br>	if( bitmap!=null ){<br>		bitmap=null;<br>	}<br>	if( texId!=0 &amp;&amp; sessionId==MonkeyGame.sessionId){ //'&lt;&lt;--- here<br>		discarded.add( Integer.valueOf( texId ) );<br>		texId=0;<br>	}<br>	return 0;<br>}<br>[/monkeycode] <br><br></td></tr></table><br>
<a name="2036972"></a>

<a name="2036981"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >marksibly</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#3">[#3]</a></td></tr></table></td></tr><tr ><td class="posttext"> Hi,<br><br>This is what the 'seq' field is supposed to do - it syncs the texId to a global 'valid context' seq counter. Note that the global seq can change even without the app finishing, eg: if the app is suspended/resumed all the graphics get lost, DX style (grr....). There's a callback for handling this  - graphicsCreated or something - and that's where I bump the global seq.<br><br>I do vaguely remember fixing something like thisin v61 though, although I was unable to reproduce it to test it - it just 'looked' wrong! Can you give the latest version of Monkey a try? <br><br></td></tr></table><br>
<a name="2036983"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >secondgear</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#4">[#4]</a></td></tr></table></td></tr><tr ><td class="posttext"> I noticed app.seq, but wasn't sure if it can be used for this purpose. Indeed, when running my app with v63b, there is no problem with textures. Your new Invalidate() code did the trick:<br><br>[monkeycode]<br>void Invalidate(){<br>	if( texId!=0 ){<br>		if( seq==MonkeyGame.app.seq ) discarded.add( Integer.valueOf( texId ) );<br>		texId=0;<br>	}<br>}<br>[/monkeycode]<br><br>Please ignore this thread, I should upgrade more often :) <br><br></td></tr></table><br>
<a name="2036985"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >marksibly</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#5">[#5]</a></td></tr></table></td></tr><tr ><td class="posttext"> Hi,<br><br>Thanks for pointing it out anyway - kind of a coincidence we both stumbled across it at about the same time! <br><br></td></tr></table><br>
<a name="bottom"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td align="right"><a href="http://monkeycoder.co.nz" target="_blank"><img src="/img/monkey2.svg" ></a> <a href="https://github.com/blitz-research" target="_blank"><img src="/img/github.svg" ></a> <a href="https://discord.gg/qJccbSp" target="_blank"><img src="/img/discord.svg" ></a></td></tr></table><br></div><br><table width="100%"><tr><td></body></html lang="en">
