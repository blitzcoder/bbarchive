<!DOCTYPE html><html lang="en" ><head ><title >ReadPixels - HTML5 Values Don't Match</title><meta name='viewport' content='width=device-width, initial-scale=0.66'><meta name='description' content='language:basic, target:desktop, category:game development'><link rel="styleSheet" href="../skins/granite/style.css" type="text/css"><style type="text/css">div.bbcode {padding: 8px;background: #E5E5E5;color: #000000;border: 1px dashed #B4B4BE;}</style></head><body ><table width=100% cellspacing=0 cellpadding=0><tr ><td class="menubarleft"></td><td class="menubar"><table cellspacing="0" cellpadding="0"><tr ><td >&nbsp;</td><td class="menuitemleft"></td><td class="menuitem"><a href="/" class="menuitem">News</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/forums.php" class="menuitem">Forums</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/codearcs.php" class="menuitem">Code</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/logs.php" class="menuitem">Logs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/gallery.php" class="menuitem">Gallery</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/sdkspecs.php" class="menuitem">Specs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/search.php" class="menuitem">Search</a></td><td class="menuitemright"></td></tr></table></td><td class="menubarright"></td></tr></table><div class="main"><h1 >ReadPixels - HTML5 Values Don't Match</h1><a href="forums.php" >Monkey Forums</a>/<a href="topics.php?forum=501" >Monkey Bug Reports</a>/<a href="#bottom" >ReadPixels - HTML5 Values Don't Match</a><br><br>
<a name="2036693"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >NoOdle</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#1">[#1]</a></td></tr></table></td></tr><tr ><td class="posttext"> The pixels read from the current render buffer do not match the ARGB of the pixels that were drawn. I am running Safari 5.1.7 on Mac OS X Lion 10.7.4 <br><br></td></tr></table><br>
<a name="2036694"></a>

<a name="2036695"></a>

<a name="2036697"></a>

<a name="2036699"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >marksibly</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#2">[#2]</a></td></tr></table></td></tr><tr ><td class="posttext"> Hi,<br><br>Runnable sample code please?<br><br>But note that in general you may not be able to read back exactly what you've written. Monkey has no control over the pixel format of the back buffer (eg: it may only be 16 bit) or any filtering or scaling used by the renderer. <br><br></td></tr></table><br>
<a name="2036708"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >NoOdle</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#3">[#3]</a></td></tr></table></td></tr><tr ><td class="posttext"> the image file I used is one I found from a google search: <img src="http://i46.tinypic.com/2ppaqoo.png"><br><br>The error does not happen on the Flash, IOS or GLFW target.<br><br>[monkeycode]<br>Strict<br>Import mojo<br><br><br><br>Class MyApp Extends App<br><br>	Global background_r : Int = 255<br>	Global background_g : Int = 0<br>	Global background_b : Int = 128<br>	<br>	Field sonic1 : Image<br>	Field sonic2 : Image<br>	Field saved : Bool = False<br>	<br><br>	Method OnCreate : int()<br>	<br>		SetUpdateRate( 60 )<br>		<br>		sonic1 = LoadImage( "sonic.png" )<br>		<br>		Return 0<br>		<br>	End Method<br>	<br><br><br>	Method OnUpdate : int()<br>		Return 0<br>	End Method<br>	<br><br><br>	Method OnRender : int()<br>		Cls background_r, background_g, background_b<br><br>		DrawImage sonic1, 0, 0<br>		<br>		Local w : Int = sonic1.Width()<br>		Local h : Int = sonic1.Height()<br>		<br>		<br>		Local pixels : Int[ w * h ]<br>		ReadPixels( pixels, 0, 0, w, h )<br>		<br>		PixelArrayMask( pixels, background_r, background_g, background_b )<br>		<br>		If saved = False<br>			saved = True<br>			<br>			Local pList : List&lt; String &gt; = PixelArrayListColors( pixels )<br>			For Local this : String = Eachin pList<br>				Print this<br>			Next<br>			<br>			PixelArrayReplaceColour( pixels, 32, 32, 160, 32, 160, 32 )<br>			PixelArrayReplaceColour( pixels, 32, 64, 192, 64, 192, 32 )<br>			PixelArrayReplaceColour( pixels, 64, 64, 224, 64, 224, 64 )<br>			PixelArrayReplaceColour( pixels, 96, 96, 224, 96, 224, 96 )<br><br>			sonic2 = CreateImage( w, h )<br>			sonic2.WritePixels( pixels, 0, 0, w, h )<br>		Endif<br>		<br>		SetColor 0, 0, 0<br>		DrawRect 0, 0, w * 2, h<br>		<br>		If sonic2<br>			SetColor 255, 255, 255<br>			DrawImage sonic2, w, 0<br>		Endif<br>		<br>		Return 0<br>		<br>	End Method<br>	<br><br>End Class<br><br><br><br>Function Main : Int()<br>	New MyApp()<br>	Return 0<br>End Function<br><br><br><br><br><br>Function PixelArrayListColors : List&lt; String &gt;( pixels : Int[])<br>	Local colors : List&lt; String &gt; = New List&lt; String &gt;<br>	Local this : String = ""<br>	For Local i : Int = 0 Until pixels.Length<br>		Local argb : Int = pixels[ i ]<br>		Local a : Int = ( argb Shr 24 ) &amp; $ff<br>		Local r : Int = ( argb Shr 16 ) &amp; $ff<br>		Local g : Int = ( argb Shr 8 ) &amp; $ff<br>		Local b : Int = argb &amp; $ff<br>		this = r + ", " + g + ", " + b<br>		Local found : Bool = False<br>		For Local c : String = Eachin colors<br>			If this = c<br>				found = True<br>				Exit<br>			Endif<br>		Next<br>		If found = False Then colors.AddLast( this )<br>	Next<br>	Return colors<br>End Function<br><br><br><br><br>'// Converts Mask Pixel Color to Transparent Pixel<br>Function PixelArrayMask : void( pixels : Int[], mask_r : Int = 0, mask_g : Int = 0, mask_b : Int = 0 )<br>	For Local i : Int = 0 Until pixels.Length<br>		Local argb : Int = pixels[ i ]<br>		Local a : Int = ( argb Shr 24 ) &amp; $ff<br>		Local r : Int = ( argb Shr 16 ) &amp; $ff<br>		Local g : Int = ( argb Shr 8 ) &amp; $ff<br>		Local b : Int = argb &amp; $ff<br>		If a = 255 And r = mask_r And g = mask_g And b = mask_b<br>			a = 0<br>			argb = ( a Shl 24 ) | ( r Shl 16 ) | ( g Shl 8 ) | b<br>			pixels[ i ] = argb<br>		Endif<br>	Next<br>End Function<br><br><br>'// Replaces a Pixel Colour<br>Function PixelArrayReplaceColour : void( pixels : Int[], old_r : Int, old_g : Int, old_b : Int, new_r : Int, new_g : Int, new_b : Int )<br>	For Local i : Int = 0 Until pixels.Length<br>		Local argb : Int = pixels[ i ]<br>		Local a : Int = ( argb Shr 24 ) &amp; $ff<br>		Local r : Int = ( argb Shr 16 ) &amp; $ff<br>		Local g : Int = ( argb Shr 8 ) &amp; $ff<br>		Local b : Int = argb &amp; $ff<br>		If r = old_r And g = old_g And b = old_b<br>			r = new_r<br>			g = new_g<br>			b = new_b<br>			argb = ( a Shl 24 ) | ( r Shl 16 ) | ( g Shl 8 ) | b<br>			pixels[ i ] = argb<br>		Endif<br>	Next<br>End Function<br><br><br>'// Replaces a Pixel Colour<br>Function PixelArrayReplaceColour : void( pixels : Int[], old_a : Int, old_r : Int, old_g : Int, old_b : Int, new_a : Int, new_r : Int, new_g : Int, new_b : Int )<br>	For Local i : Int = 0 Until pixels.Length<br>		Local argb : Int = pixels[ i ]<br>		Local a : Int = ( argb Shr 24 ) &amp; $ff<br>		Local r : Int = ( argb Shr 16 ) &amp; $ff<br>		Local g : Int = ( argb Shr 8 ) &amp; $ff<br>		Local b : Int = argb &amp; $ff<br>		If a = old_a And r = old_r And g = old_g And b = old_b<br>			a = new_a<br>			r = new_r<br>			g = new_g<br>			b = new_b<br>			argb = ( a Shl 24 ) | ( r Shl 16 ) | ( g Shl 8 ) | b<br>			pixels[ i ] = argb<br>		Endif<br>	Next<br>End Function<br>[/monkeycode] <br><br></td></tr></table><br>
<a name="2036706"></a>

<a name="2036705"></a>

<a name="2036703"></a>

<a name="2036702"></a>

<a name="2036701"></a>

<a name="2036696"></a>

<a name="2036698"></a>

<a name="2036700"></a>

<a name="2036704"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >marksibly</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#4">[#4]</a></td></tr></table></td></tr><tr ><td class="posttext"> Hi,<br><br>What's it meant to do/what is it doing? <br><br></td></tr></table><br>
<a name="2036710"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >NoOdle</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#5">[#5]</a></td></tr></table></td></tr><tr ><td class="posttext"> Its supposed to swap the colours of sonics body from blue, to green. Works fine on FLASH, IOS and GLFW but on HTML5 the colour values returned are not the same as on the other targets so sonic stays blue.<br><br>I was seeing how feasible it was to implement colour palettes for game sprites and noticed this. <br><br></td></tr></table><br>
<a name="2036709"></a>

<a name="2036716"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >marksibly</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#6">[#6]</a></td></tr></table></td></tr><tr ><td class="posttext"> Hi,<br><br>Actually, it's working here on both Chrome/Safari on MacOS 10.8 - ie: sonic is converted from blue to green.<br><br>Not sure what's up - can you try Chrome?<br><br>[edit]Just tried Snow Leopard and it's not working, even in Chrome. I would put this down to html5 just being html5! It's gonna be a while until this stuff works reliably everywhere.[/edit] Also works on Win7.<br><br>Also note that alpha will probably always read back as 255 using ReadPixels, as back buffers probably don't have an alpha channel. <br><br></td></tr></table><br>
<a name="2036714"></a>

<a name="2036713"></a>

<a name="2036712"></a>

<a name="2036717"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >therevills</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#7">[#7]</a></td></tr></table></td></tr><tr ><td class="posttext"> Works fine here on Windows with FF and Chrome. <br><br></td></tr></table><br>
<a name="2036719"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >NoOdle</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#8">[#8]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> I would put this down to html5 just being html5! <br></div><br>Ok thanks, I was wondering if that was the case!<br><br>[edit] Oh btw, therevills, I nicked the mask code from you and modified it a bit, hope you don't mind :) <br><br></td></tr></table><br>
<a name="2036718"></a>

<a name="bottom"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td align="right"><a href="http://monkeycoder.co.nz" target="_blank"><img src="/img/monkey2.svg" ></a> <a href="https://github.com/blitz-research" target="_blank"><img src="/img/github.svg" ></a> <a href="https://discord.gg/qJccbSp" target="_blank"><img src="/img/discord.svg" ></a></td></tr></table><br></div><br><table width="100%"><tr><td></body></html lang="en">
