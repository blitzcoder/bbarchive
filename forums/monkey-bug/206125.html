<!DOCTYPE html><html lang="en" ><head ><title >Image.Discard() not working - iOS</title><meta name='viewport' content='width=device-width, initial-scale=0.66'><meta name='description' content='language:basic, target:desktop, category:game development'><link rel="styleSheet" href="../skins/granite/style.css" type="text/css"><style type="text/css">div.bbcode {padding: 8px;background: #E5E5E5;color: #000000;border: 1px dashed #B4B4BE;}</style></head><body ><table width=100% cellspacing=0 cellpadding=0><tr ><td class="menubarleft"></td><td class="menubar"><table cellspacing="0" cellpadding="0"><tr ><td >&nbsp;</td><td class="menuitemleft"></td><td class="menuitem"><a href="/" class="menuitem">News</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/forums.php" class="menuitem">Forums</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/codearcs.php" class="menuitem">Code</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/logs.php" class="menuitem">Logs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/gallery.php" class="menuitem">Gallery</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/sdkspecs.php" class="menuitem">Specs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/search.php" class="menuitem">Search</a></td><td class="menuitemright"></td></tr></table></td><td class="menubarright"></td></tr></table><div class="main"><h1 >Image.Discard() not working - iOS</h1><a href="forums.php" >Monkey Forums</a>/<a href="topics.php?forum=501" >Monkey Bug Reports</a>/<a href="#bottom" >Image.Discard() not working - iOS</a><br><br>
<a name="2070285"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >rIKmAN</td><td align="right"><font class=tiny>(Posted 2013)</font>&nbsp;<a href="#1">[#1]</a></td></tr></table></td></tr><tr ><td class="posttext"> Image.Discard() is not working on images with multiple frames.<br><br>Nobody seems to have moved it, so I have re-posted in the bugs forum as per request from <a href="http://www.monkeycoder.co.nz/Community/posts.php?topic=5960" target="_blank">this thread</a> <br><br></td></tr></table><br>
<a name="2070291"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >marksibly</td><td align="right"><font class=tiny>(Posted 2013)</font>&nbsp;<a href="#2">[#2]</a></td></tr></table></td></tr><tr ><td class="posttext"> Will fix.<br><br>Note: The image will eventually get discarded, only when GC gets around to it as opposed to when you call Discard. But that's not ideal... <br><br></td></tr></table><br>
<a name="2078913"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Grey Alien</td><td align="right"><font class=tiny>(Posted 2014)</font>&nbsp;<a href="#3">[#3]</a></td></tr></table></td></tr><tr ><td class="posttext"> I'm guessing this wasn't fixed yet as the thread hasn't been moved out from the bugs forum?<br><br>I'm using v76d, OSX 10.8, XCode 4.6.3<br><br>I was just testing my app which loads in images for a world, then deletes them (using discard images) and then loads in a new set of images.  I'm not using images with multiple frames.  Also objects are created and destroyed for each world too.<br><br>Anyway, when I monitor the app with instruments (memory activity monitor) what seems to happen on my iPhone 4S is the memory use keeps going up every time I load a new world. The game starts at just 50Mb memory usage but repeated loading of worlds (with approx 5 seconds between loads due to manual testing) pushes it to over 300Mb (I've checked that discard is being called on the images by making sure the code gets there).<br><br>However, sometimes the memory drops down a bit and if I leave the app and do nothing it slowly drops right back down to about 80Mb.  So is this just how iOS/GC works? The app is allowed to keep allocating memory and the old memory (or just images?) isn't cleaned up until iOS decides to do it?  I thought the GC ran every OnUpdate() (so 60 times a second in my game), and that should result in a much flatter memory use right?<br><br>In fact, if I rapidly keep loading worlds the game eventually bombs right out as I guess iOS takes it down because the GC doesn't get a chance to work. So yeah I suppose images should really discard a bit quicker or at least discard when the app receives a memory warning from iOS. <br><br></td></tr></table><br>
<a name="2078905"></a>

<a name="2078907"></a>

<a name="2078900"></a>

<a name="2078901"></a>

<a name="2078904"></a>

<a name="2078908"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >marksibly</td><td align="right"><font class=tiny>(Posted 2014)</font>&nbsp;<a href="#4">[#4]</a></td></tr></table></td></tr><tr ><td class="posttext"> &gt; I'm guessing this wasn't fixed yet as the thread hasn't been moved out from the bugs forum?<br><br>This issue was fixed in v76b. Is your app actually running out of memory?<br><br>GC is incremental now - you can tune the collection rate with: CPP_GC_TRIGGER=blah, where blah is how many bytes to allocate before a GC occurs. This defaults to 8 Meg, but you can set it to 1 to cause a full gc every update/render. However, the lower this value, the slower the GC. <br><br></td></tr></table><br>
<a name="2078914"></a>

<a name="2078915"></a>

<a name="2078916"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Grey Alien</td><td align="right"><font class=tiny>(Posted 2014)</font>&nbsp;<a href="#5">[#5]</a></td></tr></table></td></tr><tr ><td class="posttext"> &gt;This issue was fixed in v76b. Is your app actually running out of memory?<br><br>Yes, further testing reveals that iOS will take down the app when it runs out of memory if I rapidly load worlds (as per notes above).  I checked the version notes for v76b and I see you are discarding multi-frame images immediately (so I assume you are doing the same for single frame images). Perhaps it's not the images using up the memory but objects for each world? All are deleted when new worlds are created though, and I can see this is true because if I leave the app alone the memory drops back down to normal levels eventually. (I even noticed this happens if I run the GLFW version on my Macbook Air and monitor using instruments, so this isn't just an iOS issue, although it's a worse problem on iOS due to it killing the app)<br><br>I'll try changing the collection rate to see if it makes a difference but I'm finding it weird how rapidly filling the memory up (way more than 8Mb) doesn't seem to GC. Or if Monkey is GCing that iOS doesn't recognise it. <br><br></td></tr></table><br>
<a name="2078922"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Grey Alien</td><td align="right"><font class=tiny>(Posted 2014)</font>&nbsp;<a href="#6">[#6]</a></td></tr></table></td></tr><tr ><td class="posttext"> OK I can confirm that adding #CPP_GC_TRIGGER=1 stops the memory going out of control on both iOS and my Mac (it stays at around 80Mb), although I believe that performance is decreased on iOS (just doing some more testing to find out).  Maybe there will be some happy medium between 1 and 8Mb (default)<br><br>Q. Is #CPP_GC_TRIGGER=   in bytes? So when you say 8Mb is he default you mean 8388608 right? If so, maybe I could try out 1048576 (1Mb) or something?<br><br>How come the default doesn't actually appear to work then? In theory the game should only go up to 88Mb then keep dropping down to 80Mb and not going sky high.  Something weird going on. <br><br></td></tr></table><br>
<a name="2078924"></a>

<a name="2078925"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >marksibly</td><td align="right"><font class=tiny>(Posted 2014)</font>&nbsp;<a href="#7">[#7]</a></td></tr></table></td></tr><tr ><td class="posttext"> &gt; I'm using v76d, OSX 10.8, XCode 4.6.3<br><br>Can you try a more recent version of Monkey? v77a includes a tweak that may cause GC to happen sooner when large chunks of 'non-object' memory are allocated, eg: native image data. <br><br></td></tr></table><br>
<a name="2078927"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Grey Alien</td><td align="right"><font class=tiny>(Posted 2014)</font>&nbsp;<a href="#8">[#8]</a></td></tr></table></td></tr><tr ><td class="posttext"> OK will do and will report back.  Thx. <br><br></td></tr></table><br>
<a name="2079150"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Grey Alien</td><td align="right"><font class=tiny>(Posted 2014)</font>&nbsp;<a href="#9">[#9]</a></td></tr></table></td></tr><tr ><td class="posttext"> Good news Mark! That totally fixed it.  I'm using v77f and now it's very hard for me to make the app go over 100MB use even in unrealistic scenarios of use.  The app seems to sit around 80Mb now no matter how many worlds I load and unload.<br><br>So yeah looks like the non-object memory (images) wasn't being freed quickly enough before but it now is.<br><br>Good work and thanks! <br><br></td></tr></table><br>
<a name="bottom"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td align="right"><a href="http://monkeycoder.co.nz" target="_blank"><img src="/img/monkey2.svg" ></a> <a href="https://github.com/blitz-research" target="_blank"><img src="/img/github.svg" ></a> <a href="https://discord.gg/qJccbSp" target="_blank"><img src="/img/discord.svg" ></a></td></tr></table><br></div><br><table width="100%"><tr><td></body></html lang="en">
