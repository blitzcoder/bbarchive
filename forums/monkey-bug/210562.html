<!DOCTYPE html><html lang="en" ><head ><title >Memory leak with String[]? (reposted)</title><meta name='viewport' content='width=device-width, initial-scale=0.66'><meta name='description' content='language:basic, target:desktop, category:game development'><link rel="styleSheet" href="../skins/granite/style.css" type="text/css"><style type="text/css">div.bbcode {padding: 8px;background: #E5E5E5;color: #000000;border: 1px dashed #B4B4BE;}</style></head><body ><table width=100% cellspacing=0 cellpadding=0><tr ><td class="menubarleft"></td><td class="menubar"><table cellspacing="0" cellpadding="0"><tr ><td >&nbsp;</td><td class="menuitemleft"></td><td class="menuitem"><a href="/" class="menuitem">News</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/forums.php" class="menuitem">Forums</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/codearcs.php" class="menuitem">Code</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/logs.php" class="menuitem">Logs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/gallery.php" class="menuitem">Gallery</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/sdkspecs.php" class="menuitem">Specs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/search.php" class="menuitem">Search</a></td><td class="menuitemright"></td></tr></table></td><td class="menubarright"></td></tr></table><div class="main"><h1 >Memory leak with String[]? (reposted)</h1><a href="forums.php" >Monkey Forums</a>/<a href="topics.php?forum=501" >Monkey Bug Reports</a>/<a href="#bottom" >Memory leak with String[]? (reposted)</a><br><br>
<a name="2119825"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Peeling</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#1">[#1]</a></td></tr></table></td></tr><tr ><td class="posttext"> Got some legacy code along these lines:<br><br>Local file:String[] = app.LoadString(filename).Split("~n")<br>file = file[1..] 'Skip header<br>For Local dataline:String = EachIn file<br>If dataline.Contains("//") Then Exit<br><br>Local objstr:String[] = dataline.Split("~t")<br><br>If objstr[0] = objid <br>Return CreateMyObject(objstr)<br>End<br>Next<br><br>Not especially pretty, but I've found that every time it's called, allocated memory increases by around 2mb and never goes back down. I'm aware that GC only kicks in every 8mb, but if I set the code to manually trigger by tapping the screen, I can tick up allocated memory indefinitely until the device crashes. I've checked in the profiler and all the memory is being allocated by Split/Slice.<br><br>Anyone else encountered this?<br><br>NB: the contents of objstr are NOT being retained by the CreateMyObject function, which is in any case only invoked once per call and could only ever retain a reference to a handful of bytes.<br><br>Update: I changed the loop to only split the line that matched the id - no change in behaviour. I removed the 'eachin' and replaced it with a simple numerical counter - no change in behaviour.<br><br><strike>Update: Checked on PC and no memory leak. Something different on iOS (at least)</strike> <b>Also happens on PC.</b> <br><br></td></tr></table><br>
<a name="2119819"></a>

<a name="2119821"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >marksibly</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#2">[#2]</a></td></tr></table></td></tr><tr ><td class="posttext"> Can you post some runnable/testable code? <br><br></td></tr></table><br>
<a name="2119824"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Peeling</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#3">[#3]</a></td></tr></table></td></tr><tr ><td class="posttext"> Ok, think I'm getting a handle on what's going on here. The short version is: string rep allocation bypasses the GC.<br><br>The long version:<br><br>Loading the string and Split()ing it allocates ~3mb of string rep data handled by a single string array.<br><br>The memory for the string reps is directly malloc'd, NOT obtained through the GC, so the GC does not realise memory is being consumed.<br><br>gc_new_bytes does not get increased (apart from the allocation of the array object), so if all you're doing is allocating string arrays, it can be a LONG time before GC is triggered. Meanwhile, hundreds of megs of memory can get tied up in string reps, and the game can crash.<br><br>If you're very lucky, other allocations will trigger GC (putting the arrays on the free list) AND request enough memory afterwards for gc_flush_free to work its way through and free up the arrays. <br><br>In practice, that rarely happens. Instead, other things from the free list get deleted to make room for another  3MB string array the GC thinks is only a few bytes in size.<br><br>Technically, it's not a memory leak, because everything is accounted for. It's just that the GC's idea of the memory situation can get very out of step with the actual situation. <br><br></td></tr></table><br>
<a name="2119823"></a>

<a name="2119822"></a>

<a name="2119830"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Peeling</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#4">[#4]</a></td></tr></table></td></tr><tr ><td class="posttext"> To see this happening, create a blank mojo game with a large text file in the data folder, and add this line:<br><br><pre class=code>
	Method OnUpdate()
	
		Local file:String[] = app.LoadString("bigfile.txt").Split("~n")
		
	End
</pre><br><br>Run this and watch TaskManager. Memory consumed will tick up until the GC starts freeing off array objects, then it stabilises.<br><br><strike> In a real-world application, the fact other things are being allocated and freed can either mask the effect or make it much, much worse (I got our game from 230mb up to 800mb by repeatedly triggering a split of a large file)<br><br>Edit: On reflection, I'm not sure why things are worse in a real application than that test example. The worst case OUGHT to be a solid 8mb of string array objects, as in the example above, where they all get GC'd to the 'free' list and then the top one gets recycled every update. However, it's definitely possible to exceed the memory bloat of that test app in a real game, and I don't see how...</strike><br><br>Duh. I forgot that when I clicked on the task manager, updates would stop and memory wouldn't go up any further.  I thought it stabilised at 130mb but it actually caps out at 570-ish, which matches our experience in-game loading and splitting the exact same file. <br><br></td></tr></table><br>
<a name="2119829"></a>

<a name="2119828"></a>

<a name="2119827"></a>

<a name="2119826"></a>

<a name="2119858"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >marksibly</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#5">[#5]</a></td></tr></table></td></tr><tr ><td class="posttext"> Ok, there's an experimental fix for this now up at github...<br><br><a href="https://github.com/blitz-research/monkey/blob/develop/modules/monkey/native/lang.cpp" target="_blank">https://github.com/blitz-research/monkey/blob/develop/modules/monkey/native/lang.cpp</a><br><br>Seems to work here - can you verify? <br><br></td></tr></table><br>
<a name="2119939"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Peeling</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#6">[#6]</a></td></tr></table></td></tr><tr ><td class="posttext"> I'll pull that version in as soon as I can. On lockdown at the moment for submission. <br><br></td></tr></table><br>
<a name="bottom"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td align="right"><a href="http://monkeycoder.co.nz" target="_blank"><img src="/img/monkey2.svg" ></a> <a href="https://github.com/blitz-research" target="_blank"><img src="/img/github.svg" ></a> <a href="https://discord.gg/qJccbSp" target="_blank"><img src="/img/discord.svg" ></a></td></tr></table><br></div><br><table width="100%"><tr><td></body></html lang="en">
