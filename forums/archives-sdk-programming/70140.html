<!DOCTYPE html><html lang="en" ><head ><title >B3DSDK with sources</title><meta name='viewport' content='width=device-width, initial-scale=0.66'><meta name='description' content='language:basic, target:desktop, category:game development'><link rel="styleSheet" href="../skins/granite/style.css" type="text/css"><style type="text/css">div.bbcode {padding: 8px;background: #E5E5E5;color: #000000;border: 1px dashed #B4B4BE;}</style></head><body ><table width=100% cellspacing=0 cellpadding=0><tr ><td class="menubarleft"></td><td class="menubar"><table cellspacing="0" cellpadding="0"><tr ><td >&nbsp;</td><td class="menuitemleft"></td><td class="menuitem"><a href="/" class="menuitem">News</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/forums.php" class="menuitem">Forums</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/codearcs.php" class="menuitem">Code</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/logs.php" class="menuitem">Logs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/gallery.php" class="menuitem">Gallery</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/sdkspecs.php" class="menuitem">Specs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/search.php" class="menuitem">Search</a></td><td class="menuitemright"></td></tr></table></td><td class="menubarright"></td></tr></table><div class="main"><h1 >B3DSDK with sources</h1><a href="forums.php" >Archives Forums</a>/<a href="topics.php?forum=120" >Blitz3D SDK Programming</a>/<a href="#bottom" >B3DSDK with sources</a><br><br>
<a name="784745"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >@rtur</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#1">[#1]</a></td></tr></table></td></tr><tr ><td class="posttext"> Will be source version of SDK?<br>I need to fix few bugs with Blitz3D(crashes after device lost- locking computer and logon, logon after screensaver, changing desktop resolution while game is running etc) but it is impossible to 100% fix this bugs without sources. <br><br>Currently I've completed casual game. I've worked on it during 14 months. And publisher does not releases it only because this bugs(requirements to quality of casual games  has been increased after Vista release). <br>I'm ready to pay $500-$1000 to have sources of B3D, so I can fix this and other future bugs by myself. I need it only for my projects, not for creating any ñompetitive engine. <br><br></td></tr></table><br>
<a name="784872"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >_33</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#2">[#2]</a></td></tr></table></td></tr><tr ><td class="posttext"> Are those reported in the bug report for Blitz3D? <br><br></td></tr></table><br>
<a name="784873"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >popcade</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#3">[#3]</a></td></tr></table></td></tr><tr ><td class="posttext"> You can get Torque source for around $150, consider Blitz3D has age,$500 is too tacky for just "fixing a few bugs"... <br><br></td></tr></table><br>
<a name="784880"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >@rtur</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#4">[#4]</a></td></tr></table></td></tr><tr ><td class="posttext"> &gt;Are those reported in the bug report for Blitz3D? <br>I've reported few months ago in bug reports forum and write email to Mark. But still no reply/bugfix :(<br><br>David Guy had made Dll to catch logoff etc but it does not solve problem at 100%. Games still crashes.<br><br>And the reason why I don't go to another framework(like Torque,Playground,PopCap,HGE etc) that I've got already completed game and I need to release it right now. And I've build good framework(~1Mb of blitz code), content pipeline etc. <br><br></td></tr></table><br>
<a name="784988"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >_33</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#5">[#5]</a></td></tr></table></td></tr><tr ><td class="posttext"> @rtur, I suggest you send an update to blitz support regarding your issues.  I think blitz3d is due for an update :P <br><br></td></tr></table><br>
<a name="785089"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >DGuy</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#6">[#6]</a></td></tr></table></td></tr><tr ><td class="posttext"> &gt;David Guy had made Dll to catch logoff etc but it does not solve problem at 100%. Games still crashes.<br><br>@rtur, if you can tell me under what conditions B3D is causing a MAV after a focus loss, I'll update the DLL I wrote to handle them:<br><br>* after device lost-locking computer<br>* logon<br>* logon after screensaver<br>* changing desktop resolution while game is running<br>* any others ?<br><br>While most/all of the conditions above should be handled, (I'm pretty sure I tested them all) I'll re-check to make sure. :)<br><br>David <br><br></td></tr></table><br>
<a name="785169"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Pinete</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#7">[#7]</a></td></tr></table></td></tr><tr ><td class="posttext"> I'm working too in a casual game.<br>Could you please tell a little more about this kind of problems?<br>What kind of issue are you refering to when talking about logon or logon after screensaver???<br><br>Thanks in advance! <br><br></td></tr></table><br>
<a name="785860"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >DGuy</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#8">[#8]</a></td></tr></table></td></tr><tr ><td class="posttext"> Well, after re-testing my DLL I realized I was handling Ctrl+Alt+Del but NOT handling Alt+Ctrl+Del. Both have the same results but generate a different sequence of windows messages.<br><br>@Pinete<br>View these threads for some background:<br><a href="http://www.blitzbasic.com/Community/posts.php?topic=67837" target="_blank">http://www.blitzbasic.com/Community/posts.php?topic=67837</a><br><a href="http://www.blitzbasic.com/Community/posts.php?topic=67841" target="_blank">http://www.blitzbasic.com/Community/posts.php?topic=67841</a><br><br>Using my DLL, under both WinXP and Vista, I am unable to find any combination of Logout/login/user-switch/screensaver, etc. or focus loss event that causes a MAV.<br><br>BUT, as stated in the above threads there is a rare occurrence that will definitely cause a MAV: A focus loss event, while RenderWorld is executing, that results in loss of DirectDraw surfaces.<br><br>This can not be handled externally, even by detecting the focus lose while RenderWorld is executing, and attempting a RestoreAllSurfaces call. The only way to remedy this 100%, it seems, would be to re-write RenderWorld so it checks for/handles surface-loss.<br><br>So, to this ends, I would have to second @rtur request to either fix this rare but reproducible bug or for some sort of source-code license so users can fix it. <br><br></td></tr></table><br>
<a name="785888"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Pinete</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#9">[#9]</a></td></tr></table></td></tr><tr ><td class="posttext"> Thanks a lot DGuy!<br>Could you please explain me a little more how to use this in my Blitz program?<br><br>Thanks in advance!<br><br>All the best. <br><br></td></tr></table><br>
<a name="785899"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >@rtur</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#10">[#10]</a></td></tr></table></td></tr><tr ><td class="posttext"> On small test example MAV occurs very rarely. But on big project I have MAV during about 20%-30% of logoffs on WinXP. <br><br></td></tr></table><br>
<a name="785911"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >marksibly</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#11">[#11]</a></td></tr></table></td></tr><tr ><td class="posttext"> Hi,<br><br>I'll be looking into this very soon. I've contacted DGuy and hopefully he'll be able to help too.<br><br>I've been reluctant to pursue a 'reload all the graphics' solution, as it's a really icky thing to lump on the programmer, esp. in a supposedly user-friendly language like Blitz.<br><br>But realistically, I don't think there's much alternative any more. <br><br>Pooh! <br><br></td></tr></table><br>
<a name="785922"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Pinete</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#12">[#12]</a></td></tr></table></td></tr><tr ><td class="posttext"> Hi!<br><br>so, what's your recomendation, Mark? to use DGuy dll?<br><br>Could be hope a Blitz3D native future solution regarding the problems with windowed/full screen/'reload all graphics solution'/logout-login....??<br><br>Really that's a very important stuff because if you want to be published is possible publishers ask you for avoid that kind of problems...<br><br>Regards,<br><br>All the best. <br><br></td></tr></table><br>
<a name="786124"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >marksibly</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#13">[#13]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> <br>so, what's your recomendation, Mark? to use DGuy dll?<br> <br></div><br>Yes, and I'll work on building this stuff into b3d and b3dsdk. <br><br></td></tr></table><br>
<a name="786141"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >DStastny</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#14">[#14]</a></td></tr></table></td></tr><tr ><td class="posttext"> Mark if you see this..  <br><br>IDirectDraw7::TestCooperativeLevel should handle the issues of detecting the lost of the primary surface without checking windows messages for keystroks or testing for surface lost on primary.  If you can raise this back to API then we can respond by reloading graphics and such.  <br><br>Doug <br><br></td></tr></table><br>
<a name="786247"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >@rtur</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#15">[#15]</a></td></tr></table></td></tr><tr ><td class="posttext"> Hi Mark,<br>I've created surface restoration hack, that restores textures after logout without reloading graphics manualy.<br>But it need to be implemented into Blitz3D because there is still some textures that are not restored(that loaded into video memory with 256 flag). <br><br>Problem of blitz programs - that they stops execution of code if window lost focus. Game need set internal timers to pause, set all sounds to silent and so on...<br>So, I suggest to make few functions that will be called by blitz:<br>PauseGame() - will be called when window loses focus<br>ResumeGame() - will be called when window recieves focus<br>EndGame() - will be called when window closes, so user can unload all his stuff. And of course user can call this functions by himself if needed.<br><br>In my DLL that we have made with Platon this functions are finded in memory by DLL function and that called from DLL( written in PureBasic) when window lost/recieve focus and closes. <br>It works fine for handling usual focus lost, like Alt+Tab, Ctrl+Shift+Esc etc. But when user LogOut and than LogingIn ResumeGame function calls during RenderWorld command execution. And something crashes in it. <br>On small example it crashes <b>VERY</b> rarely. You can logout/login hundred times before it will crash. But on huge game it crases very often. It can crash at first time, or second. Sometimes from 5-th. I don't know why. Maybe in my game RenderWold rendering very big amounts of different textures complex meshes etc while in example there is only few cubes with texture...<br><br>Here is dlls and test code: <a href="http://www.arthurostapenko.com/other/blitzbugfixes/BSys2.rar" target="_blank">http://www.arthurostapenko.com/other/blitzbugfixes/BSys2.rar</a><br><b>2 All</b> Please test this on you games. <br>I've commented code, so I think it will be easy to integrate into any game. <br><br>Test for Win+L, Ctrl+Alt+Del, Ctrl+Alt+Esc, Alt+Tab. Launch game and change desktop resolution(there is still manual restoration here:( ), Launch programm and wait for screensaver(usual blitz game crashes after launching directX screensaver)- screensaver must not be launched while game window is active, but it launches if game is minimized :(<br><br>There is also small bug in blitz games- When game starts in fullscreen and than changed to windowed HWND_TOPMOST(I think) flag not cleared, so game in windowed mode is alway on top of other applications. <br>(When game launched in window mode than it is not "always on top".)<br><br>Also all other casual frameworks has fast fullscreen&lt;-&gt;windowed mode change, without reloading all graphics. <br>It need to be integrated into Blitz3D also. <br><br></td></tr></table><br>
<a name="786283"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Pinete</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#16">[#16]</a></td></tr></table></td></tr><tr ><td class="posttext"> Hi @rtur!,<br><br>thanks for the DLL.<br><br>I've been testing the test.bb and if I set full screen and press alt+tab, when return to the app this is freeze. If I continue pressing alt+tab app doesn't respond anymore...<br><br>How can be done alt+tab when app is Full screen to have not problems?<br><br><br>Thanks in advance! <br><br></td></tr></table><br>
<a name="786296"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >@rtur</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#17">[#17]</a></td></tr></table></td></tr><tr ><td class="posttext"> 2 Pinete<br>Strange problem. On my system it works fine with both fullscreen and windowed mode. <br><br>What is your system(OS, hardware, DX version, video drivers version)?<br>Do you have any other programms runing? <br><br></td></tr></table><br>
<a name="786298"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >@rtur</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#18">[#18]</a></td></tr></table></td></tr><tr ><td class="posttext"> Or maybe you are running this sample form IDE. <br>Do not do this. Compile to EXE and then run test.exe file. <br><br></td></tr></table><br>
<a name="786348"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Pinete</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#19">[#19]</a></td></tr></table></td></tr><tr ><td class="posttext"> ok, I will try again at home.. I guess I was running from IDE...<br>My system is WinXP SP2, Directx9.0c, 6600GT and don't know video drivers version, so I will tell you in my nest post in one hour or so..<br><br>Thank you very much @rtur <br><br></td></tr></table><br>
<a name="786352"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >@rtur</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#20">[#20]</a></td></tr></table></td></tr><tr ><td class="posttext"> Try with disabled debugger, it must work. <br><br></td></tr></table><br>
<a name="786358"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Pinete</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#21">[#21]</a></td></tr></table></td></tr><tr ><td class="posttext"> Yes, it works :) you're right...<br>But I've some questions...<br>After examining the test.bb a little more I've take into account that really it is based on the idea of unload/reload all the graphics... isn't it?<br><br>So what should be the way to avoid load and unload graphics?<br><br>From Blitzmax you can press alt+tab or ctrl+alt+del without problems, or at least, I've not have problems at all...<br><br>Summarizing, the question is: How to avoid to unload / reload all the graphics??<br><br>Thanks in advance @rtur!!!<br><br><br>All the best! <br><br></td></tr></table><br>
<a name="786361"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >@rtur</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#22">[#22]</a></td></tr></table></td></tr><tr ><td class="posttext"> Unload/reload all the graphics needed only if device lost. It happens when you change desktop resolution while game is running. <br>When you press alt+tab or ctrl+alt+del or Win+L - there is no device lost happens. Only surface deleted from videomemory(when Win+L pressed). <br>This function restore surface(if it is not vidmem texture):<br><br>Function RestoreSurfaces(Entity)<br><br>        For i=1 To CountSurfaces(Entity)<br>                Surface=GetSurface(Entity,i)<br>                vdPokeInt(Surface+64,0) ;; Set 64 offset of surface to zero, forwarding surface restoration<br>        Next<br><br>End Function<br><br>Look at ResumeGame() function, there are all entities restores it's surfaces automaticaly.<br><br>&gt;From Blitzmax you can press alt+tab or ctrl+alt+del without problems, or at least, I've not have problems at all...<br>Yes BlitzMax handles Win+L and others events well, I hope Mark or Skidracer will fix this bugs in Blitz3D too.<br>Because I'm still having crash at RenderWorld in my game, when press Win+L. <br>(test sample does not crash, I don't know why..maybe because I have a lot of textures and other stuff to render) <br><br></td></tr></table><br>
<a name="786363"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >@rtur</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#23">[#23]</a></td></tr></table></td></tr><tr ><td class="posttext"> &gt;Summarizing, the question is: How to avoid to unload / reload all the graphics??<br><br>It is impossible to make 100% working protection from device/surface and other losts without Blitz3D sources. So I can't fix it completely. That's why I've suggested to make source code license for Blitz3D. For $500 price, for example. <br>So it is does not needed for usual hobby Blitz3D programmer(who will not pay such money), but needed for serious casual/shareware games developers(who can pay such price and fix all future bugs by ourselves). <br><br></td></tr></table><br>
<a name="786386"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Pinete</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#24">[#24]</a></td></tr></table></td></tr><tr ><td class="posttext"> understand..<br>yes, absolutely agree with you...<br>Right now Blitz3D has some specific lacks that make it unusable to make things like you say, i.e. professional casual games development...<br>if you could find a solution for this I'll pay the $500 of the license and other $500 for the solution...<br><br>best regards! <br><br></td></tr></table><br>
<a name="786387"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >@rtur</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#25">[#25]</a></td></tr></table></td></tr><tr ><td class="posttext"> Mark already has two customers for source license of B3D/SDK ;) <br><br></td></tr></table><br>
<a name="786406"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >DStastny</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#26">[#26]</a></td></tr></table></td></tr><tr ><td class="posttext"> I  wrote a DLL function that handles the detection of the lost device. Guaranteed works in all cases.   <br><br>As for automatically reloading the surfaces as you found out you cant restore surfaces if they are in vid memory.  You also cant restore surfaces if you need to recreate the  worth the problem.  Its not that hard to structure code to device. Situations such as change resolution or another application going fullscreen.<br><br>BMAX works because all graphics a buffered, and the textures are recreated if the device needs to be recreated.  I suspect Mark doesnt want to do that due to major underlying changes.  I dont want him pausing my application logic due to drawing being suspended.<br><br>I am just waiting on SystemProperty to be exposed in SDK and Ill be fine.<br><br>Its really simple solution, no hooking messages or testing surfaces.<br><br>Read my above post and the documentation for the method.  Implement DLL to call that function and process the return.<br><br>Doug <br><br></td></tr></table><br>
<a name="786423"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >DGuy</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#27">[#27]</a></td></tr></table></td></tr><tr ><td class="posttext"> Thanks to Budman suggestion about 'TestCooperativeLevel()' I <i>was</i> able to simplfy the logic used to detect/handle loss of surfaces. The new logic basically looks like this:<br><br><pre class=code>
case WM_ACTIVATEAPP:
  {
  _has_focus = (wParam == UINT(TRUE)); 

  if( _has_focus )
    {
    if( _b3d_pddsPrim-&gt;IsLost() == DDERR_SURFACELOST )
      {
      while( _b3d_pdd-&gt;TestCooperativeLevelsimplify() != DD_OK ) Sleep( 100 );
      _b3d_pdd-&gt;RestoreAllSurfaces();
      }
    }
  }
  break;
</pre>This restores all surfaces (albeit, without their pre-lost contents), and allows b3D to keep running without MAV. I was able to remove the explicit calls in BB code to check for surface-lost or possible-log outs and was able to discard all the key-press-checks. The only thing I would add is a flag that the user can check to see if they need to reload their graphics.<br><br>Now, while the above solution works in all cases my more complex solution did, it also, unfortunetly, fails in the same situation: A loss of focus, while RenderWorld is executing, that results in surface loss.<br><br>This leads me to believe that RenderWorld is locking/getting pointers to surfaces and attempting to use those same pointer after surface loss/restore.<br><br>Even though a dump of surface info before and after the call to RestoreAllSurfaces show all surfaces as lost, then all surfaces as restored, if this all occurs <b><i>while RenderWorld is executing</i></b>, a MAV will result 100% of the time.<br><br>@Budman<br>If you could post the relevent parts of your solution, that would be appreciated. I am very convinced, though, that an external solution is not possible (please, prove me wrong ;) )<br><br>David <br><br></td></tr></table><br>
<a name="786426"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >DGuy</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#28">[#28]</a></td></tr></table></td></tr><tr ><td class="posttext"> @@rthr:<br><div class="quote"> There is also small bug in blitz games- When game starts in fullscreen and than changed to windowed HWND_TOPMOST(I think) flag not cleared, so game in windowed mode is alway on top of other applications. <br>(When game launched in window mode than it is not "always on top".) <br></div><br>I ran into that issue also. The way I got around it was after I set windowed mode I call this:<br><pre class=code>
win32_SetWindowPos(SystemProperty("AppHWND"), (-2),0,0,0,0,$03) ;removes ALWAYS-TOP-MOST property when comming from fullscreen mode</pre>decls:<pre class=code>.lib "User32.dll"
win32_SetWindowPos%(hwnd%,hwndInsertAfter%,x%,y%,cx%,cy%,uflags%):"SetWindowPos"</pre>David <br><br></td></tr></table><br>
<a name="786433"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >DStastny</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#29">[#29]</a></td></tr></table></td></tr><tr ><td class="posttext"> @DGuy<br><br>Here is the code for DLL,  I used Delphi since well its quick easy DLL and I had it handy since I am using Delphi with the SDK.     <br><br>Easy port to C++ though.  Note I translated the complex HRESULTS to simple constants to pass back to Blitz.<br><br><textarea class=codebox name="code" wrap=OFF readonly="true" rows="15" cols="80">
{$I DirectX.Inc}

library b3dfix;


uses
  DirectDraw,
  Direct3d,
  SysUtils,
  Classes;

{$R *.RES}
const
  INVALIDOBJECT = -1;
  EXCLUSIVEMODEALREADYSET = -2;
  NOEXCLUSIVEMODE = -3;
  WRONGMODE = -4;

function TestCooperativeLevel(directdraw7:IDirectDraw7) : Integer; stdcall;
begin
  Result := $FF;
  if directdraw7&lt;&gt;nil then
  begin
    case directdraw7.TestCooperativeLevel of
     0: Result := 0;
     DDERR_INVALIDOBJECT : Result := INVALIDOBJECT;
     DDERR_EXCLUSIVEMODEALREADYSET:Result := EXCLUSIVEMODEALREADYSET;
     DDERR_NOEXCLUSIVEMODE:Result := NOEXCLUSIVEMODE;
     DDERR_WRONGMODE:Result := WRONGMODE;
    end
  end;
end;

exports
  TestCooperativeLevel;

begin
end.

</textarea><br><br>Now here is sample in Blitz3d since I am waiting for SystemProperty added to SDK.<br><br><textarea class=codebox name="code" wrap=OFF readonly="true" rows="15" cols="80">
Const INVALIDOBJECT = -1
Const EXCLUSIVEMODEALREADYSET = -2
Const NOEXCLUSIVEMODE = -3
Const WRONGMODE = -4
Global Camera
Global light
Global cone
Global DD7
Global pitch#,yaw#,roll#



Function CreateGraphics()
  EndGraphics
  Graphics3D 800,600,0,2
  dd7=SystemProperty("DirectDraw7") 
  DebugLog "CreateGraphics"
End Function


Function CreateScene()
  camera=CreateCamera()
  light=CreateLight()
  cone=CreateCone( 32 )
  PositionEntity cone,0,0,5
End Function

Function SaveScene()
End Function

Function RestoreScene()
  CreateScene()
  RotateEntity cone,pitch#,yaw#,roll#
End Function

Function UpdateScene()
   If KeyDown( 208 )=True Then pitch#=pitch#-1
   If KeyDown( 200 )=True Then pitch#=pitch#+1
   If KeyDown( 203 )=True Then yaw#=yaw#-1
   If KeyDown( 205 )=True Then yaw#=yaw#+1
   If KeyDown( 45 )=True Then roll#=roll#-1
   If KeyDown( 44 )=True Then roll#=roll#+1
   RotateEntity cone,pitch#,yaw#,roll#
End Function

Function RenderScene()
  hr=TestCooperativeLevel(dd7)
  If hr=0
   RenderWorld()
   Text 0,0,"Use cursor/Z/X keys to change cone rotation"             
   Text 0,20,"Pitch: "+pitch# 
   Text 0,40,"Yaw : "+yaw# 
   Text 0,60,"Roll : "+roll# 	
   Flip
  Else
    Select hr
    Case INVALIDOBJECT
     RuntimeError "Bad pointer to DirectD7"
    Case EXCLUSIVEMODEALREADYSET,NOEXCLUSIVEMODE
     DebugLog "Excluse Set"
     Repeat
      UpdateScene()
      Delay 1
     Until TestCooperativeLevel(dd7)=0 
     SaveScene()
     CreateGraphics()
     RestoreScene() 
    Case WRONGMODE
     DebugLog "Wrong Mode"
     SaveScene()
     CreateGraphics()
     RestoreScene() 
     DebugLog "Recreate Mode"
    Default
     DebugLog "HUH="+hr
   End Select
  End If
End Function

;======= MAIN

CreateGraphics()
CreateScene()
While Not KeyHit(1) 
  UpdateScene()
  RenderScene()
Wend
End
</textarea><br><br>You'll notice I am not messing with Restoring Surfaces as you pointed out there is not much you can do to guarantee you get it all setback up correctly.<br><br>You'll also note I don't lock the main loop. You still want to be able to get application to process a slight delay to yield CPU is all you need.  You need to do this if you have network game running and don't want to starve the network code while Testcooperative Level is failing.<br><br>This is pretty basic code, come straight from the SDK and I have used it since Dx7 was published with no problems.  For some reason BRL never codes this correctly.  Took forever to get the driver correct in BMAX.<br><br>This should work correctly for all cases Full Screen focus lost, window blitz app losing focus to other full screen dx application, etc.  The SDK is real clear this function is the key to making DX7 work friendly with the OS and other applications.  Blitz Handles surface lost internally although I doubt textures loaded into video memory are correctly restored.  No solution to that other than no real reason to choose that option.  Modern Video Cards have more than enough texture memory for us to worry about loading unloading textures.<br><br>You want to call this before your check for surface lost.  As failure of this function means pretty much your screwed and need to rebuild the display device and reload everything its just needs to be called correctly until it gives you an OK.<br><br>Nice catch on the TopMost flag never noticed that.<br><br>Doug <br><br></td></tr></table><br>
<a name="786449"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Pinete</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#30">[#30]</a></td></tr></table></td></tr><tr ><td class="posttext"> I guess we should put this in code archives or the Blitz3D other forum too.<br>This way this important piece of codes will be accesible by more people..<br>:)<br><br>All the best! <br><br></td></tr></table><br>
<a name="786508"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >@rtur</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#31">[#31]</a></td></tr></table></td></tr><tr ><td class="posttext"> Thanks DGuy, SetWindowPos works fine. <br><br></td></tr></table><br>
<a name="786730"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >DGuy</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#32">[#32]</a></td></tr></table></td></tr><tr ><td class="posttext"> @Budman<br><br>I appreciate you taking the time to post the code sample, and again, your mention of TestCooperativeLevel() allowed me to simplify my surface lose logic, Thanks. :)<br><br>Unfortunately, even using your logic and after an hour+ more of debugging, using slight logic tweaks and command orderings, I am still able to get RenderWorld to MAV.<br><br>The issue is this: Even though a check is being performed <i>JUST</i> before RenderWorld is called, it is still possible from the time the check ends, until the time that RenderWorld completes, for B3D to lose focus, and during focus loss, lose surface memory, and thus cause RenderWorld to go boom.<br><br>I've tested this not only with my in-progress app, which consists of a few thousand lines of code, but also with sample apps that come with B3D. As @rthr mentioned, with smaller apps the MAV does not happen as often (probably because B3D is spending less time inside RenderWorld), but it still occurs.<br><br>RenderWorld has to be made sensitive to the fact that it can lose the Texture/Surface memory it is working with and respond accordingly. The only way to do that is to have internal access to RenderWorld. Thankfully, Mark seems keen to get this issue solved ...<br><br>David <br><br></td></tr></table><br>
<a name="786738"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >DStastny</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#33">[#33]</a></td></tr></table></td></tr><tr ><td class="posttext"> @DGUY<br><br>I cant imagine what RenderWorld is doing to lose the surface.   The way directX works is by with OS to actually yield the surfaces it happens durning processing of the message loop. Basically any time PeekMessage is called the surface is lost.  I suspect RenderWorld is calling Peekmessage in which case it would explain the random timing issue as after testing cooperative level you need to do drawing and check returns.  If surface lost comes back stop drawing.  Dx7 driver implementations are notoriously bad at cheating and not safely dealing with failing gracefully with  surface lost conditions.  Are you using Video Textures,  flag 256 or ImageBuffers? mixing 2d and 3d drawing?<br><br>Doug <br><br></td></tr></table><br>
<a name="786741"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >DStastny</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#34">[#34]</a></td></tr></table></td></tr><tr ><td class="posttext"> @DGUY<br><br>With my test code before RenderWorld are you attempting to restore the surfaces if TestCoop fails?  If so the cause of your MAVs might be something else, like you say without the source cant tell.  But if the Rendering in Renderworld uses Vertex and Index Buffers they need to be handled as well if the TestCoopertive Fails, RestoreAllSurfaces does not fix them.  They need to be destroyed and recreated.  Maybe the cause of your problem is tied to the failure to ensure they are in valid state. <br><br>In which case if test fails endgraphics reload might fix.<br><br><br>Have you tried minimal case app like my demo which destroys and recreates display and still cause it to crash?<br><br>I think your probably right we are going to be stuck until Renderworld is crash safe and possible returns a result as to what we need to do.  ie RenderWorld returns false we know we need to recreate our resources.<br><br>Reason I am even looking at Dx7 for myself is I need minimal 3d support and to support lower end hardware.  Which has me back at Dx7.  Blitz3d nice as it is is not powerful enough for what I need in a language, an BMax doesn't support threads so the SDK seems like a happy medium.  I would really hate to have to write my own Dx7 engine from scratch as this is part time fun.  I already have a full time job.<br><br>I didnt have half the trouble writing the Max2d Dx9 driver as I have dealing with Dx7 clunkiness and bad drivers.<br><br>I couldnt get my test app to crash under XP but I will move it to my old Win2k laptop with a really crappy video card and try it there.<br><br>Doug <br><br></td></tr></table><br>
<a name="787669"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >@rtur</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#35">[#35]</a></td></tr></table></td></tr><tr ><td class="posttext"> Mark, any news with Win+L fix?<br><br>Can you answer to my emails, please. <br><br></td></tr></table><br>
<a name="bottom"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td align="right"><a href="http://monkeycoder.co.nz" target="_blank"><img src="/img/monkey2.svg" ></a> <a href="https://github.com/blitz-research" target="_blank"><img src="/img/github.svg" ></a> <a href="https://discord.gg/qJccbSp" target="_blank"><img src="/img/discord.svg" ></a></td></tr></table><br></div><br><table width="100%"><tr><td></body></html lang="en">
