<!DOCTYPE html><html lang="en" ><head ><title >More B3D models problems...</title><meta name='viewport' content='width=device-width, initial-scale=0.66'><meta name='description' content='language:basic, target:desktop, category:game development'><link rel="styleSheet" href="../skins/granite/style.css" type="text/css"><style type="text/css">div.bbcode {padding: 8px;background: #E5E5E5;color: #000000;border: 1px dashed #B4B4BE;}</style></head><body ><table width=100% cellspacing=0 cellpadding=0><tr ><td class="menubarleft"></td><td class="menubar"><table cellspacing="0" cellpadding="0"><tr ><td >&nbsp;</td><td class="menuitemleft"></td><td class="menuitem"><a href="/" class="menuitem">News</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/forums.php" class="menuitem">Forums</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/codearcs.php" class="menuitem">Code</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/logs.php" class="menuitem">Logs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/gallery.php" class="menuitem">Gallery</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/sdkspecs.php" class="menuitem">Specs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/search.php" class="menuitem">Search</a></td><td class="menuitemright"></td></tr></table></td><td class="menubarright"></td></tr></table><div class="main"><h1 >More B3D models problems...</h1><a href="forums.php" >BlitzMax Forums</a>/<a href="topics.php?forum=119" >MiniB3D Module</a>/<a href="#bottom" >More B3D models problems...</a><br><br>
<a name="1050940"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >SLotman</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#1">[#1]</a></td></tr></table></td></tr><tr ><td class="posttext"> <img src="http://img.photobucket.com/albums/v431/SLotman/minib3d-newbug.jpg"><br><br>On the image above: to the left, the model if I load it with Blitz3D, or on miniB3D with LoadMesh.<br><br>If I change LoadMesh to LoadAnimMesh - the model as soon as it is moved, rotated or whatever, even using a Pivot as a parent, gets like on the right.<br><br>This is the testing code:<br><textarea class=codebox name="code" wrap=OFF readonly="true" rows="15" cols="80">
Import sidesign.miniB3D

Graphics3D 800,600,0

Global camera:TCamera = CreateCamera()
Global kid1Mesh:TMesh = LoadAnimMesh("data/models/kid1.b3d")

Global light:TLight=CreateLight()

AmbientLight 128,128,128
CameraRange camera, 1, 1000

PositionEntity camera, 0, 5, -10
PositionEntity kid1Mesh, -4, 0, 0
PositionEntity light, 0,-500,-500

While Not KeyHit(KEY_ESCAPE)
	Cls
	
	TurnEntity kid1Mesh,0,1,0
	
	RenderWorld
	UpdateWorld
	
	Flip
Wend

EndGraphics
</textarea><br><br>Since LoadMesh uses LoadAnimMesh internally... what is going on??? <br><br></td></tr></table><br>
<a name="1050942"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >SLotman</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#2">[#2]</a></td></tr></table></td></tr><tr ><td class="posttext"> Apparently it has something to do with the meshes pivot (on Max) rotation... reseting scale/transforms on them improved a lot the situation. <br><br>It looks like Blitz3D 'fixes' any rotation during loading... <br><br></td></tr></table><br>
<a name="1050943"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >GNS</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#3">[#3]</a></td></tr></table></td></tr><tr ><td class="posttext"> Oh boy, this will be a fun one to track down I'm sure.<br><br>Few questions for you:<br><br>1). How's the model made? It looks like each body part is a separate (segmented) object. Is this the case? If so, what're the names of the individual body parts?<br><br>2). What program did you use to model the mesh? <br><br>3). Does the mesh have any bones/joints? How many?<br><br>4). What kind of video card are you running? <br><br></td></tr></table><br>
<a name="1050954"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >SLotman</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#4">[#4]</a></td></tr></table></td></tr><tr ><td class="posttext"> As I said, the problems was with the pivots. Reseting their scales/transforms solved the issue.<br><br>The model was indeed made of individual parts. It was done on Max9. <br><br></td></tr></table><br>
<a name="1050960"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >GNS</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#5">[#5]</a></td></tr></table></td></tr><tr ><td class="posttext"> Glad you got it sorted. <br><br></td></tr></table><br>
<a name="1053269"></a>

<a name="1053270"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >SLotman</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#6">[#6]</a></td></tr></table></td></tr><tr ><td class="posttext"> Another issue came up. I have this model (to the left, rendered on Blitz3D, to the right, rendered on BlitzMax):<br><br><img src="http://img.photobucket.com/albums/v431/SLotman/minib3d-model.jpg"><br><br>The head (where the texture is wrong), is actually 2 meshes, one slightly bigger than another. The bigger one has the eyes + mouth with alpha channel, and the small one is the colored part.<br><br>If I set the eye texture on 3DMax, its exported and rendered correctly on miniB3D. But if I replace that texture with an animated one (with code), then the problem appears. Note that both models were rendered with the same code, both on miniB3D and on Blitz3D changing the texture at code level with this:<br><br><pre class=code>
faceTexture = LoadAnimTexture("data/models/faces.png",2,64,64,0,16)
EntityTexture FindChild(kid1Mesh, "head01"), faceTexture,0,0
</pre><br><br>Is there a problem on MiniB3D and animated textures? If I replace LoadAnimTexture with plain LoadTexture, and use a texture with a "single frame", it works! The "animated" texture is a 256x256 texture, divided into 64x64 frames - so I don't think the size is the problem...<br><br>Also, why the model on miniB3D reflect so much light, while on Blitz3D it doesn't? I tried even setting EntityShininess to 0, to no avail :(<br><br>Any help deeply appreciated!<br><br><font class="tiny">Last edited 2010</font> <br><br></td></tr></table><br>
<a name="1053277"></a>

<a name="1053278"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >SLotman</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#7">[#7]</a></td></tr></table></td></tr><tr ><td class="posttext"> Found it!<br><br>On LoadAnimTexture, on <a href="/posts.php?topic=87020" target="_blank">this thread</a> someone suggested a change from:<br><br><pre class=code>
glPixelStorei GL_UNPACK_ROW_LENGTH,(pixmap.pitch/BytesPerPixel[pixmap.format])-width  
</pre><br><br>To<br><br><pre class=code>
glPixelStorei GL_UNPACK_ROW_LENGTH,pixmap.pitch/BytesPerPixel[pixmap.format]
</pre><br><br>But this was the cause of my problems!<br>So does anyone knows what would be the best approach? What should be actually used, so it would work everywhere?<br><br><font class="tiny">Last edited 2010</font> <br><br></td></tr></table><br>
<a name="1053279"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >SLotman</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#8">[#8]</a></td></tr></table></td></tr><tr ><td class="posttext"> Anyway - the other problem, that I mentioned: the model illumination on miniB3D... again, the same model rendered on blitzmax (on the left) and on blitz3d (on the right)<br><br><img src="http://img.photobucket.com/albums/v431/SLotman/b3d-shine.jpg"><br><br>Look at the "hair" (the black thing) right side: the white reflection is much smoother on Blitz3D than on miniB3D. The same thing can be seen on a smaller scale on the arm, or in the body itself.<br><br>This white effect is made with a spheremap texture, and then calling afterwards updatenormals().<br><br>Again, any help deeply appreciated! <br><br></td></tr></table><br>
<a name="1053283"></a>

<a name="1053284"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >SLotman</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#9">[#9]</a></td></tr></table></td></tr><tr ><td class="posttext"> I'm trying to remember some stuff here... I think the cause of that is the updateNormals functions - which is correct to an extent: it does calculate the normals for each triangle, but I'm remembering something else: a second step, which isn't implemented on miniB3D.<br><br>This second step, would attenuate the normals from on triangle to another - something like a 'normal average' of triangles next to each other.<br><br><font class="tiny">Last edited 2010</font> <br><br></td></tr></table><br>
<a name="1053298"></a>

<a name="1053299"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >SLotman</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#10">[#10]</a></td></tr></table></td></tr><tr ><td class="posttext"> This new updatenormals() improves it a little bit, but still it isn't quite right (like B3D) - it's based on an old dx9 engine I was writing - but never got to finish:<br><br><textarea class=codebox name="code" wrap=OFF readonly="true" rows="15" cols="80">
void C_UpdateNormals(int no_tris,int no_verts,short *tris,float *vert_coords,float *vert_norm)
{

	int t;
	int c,v;
	float ax, ay, az, bx,by,bz, nx,ny,nz;
	float vx,vy,vz;
	map&lt;Vector,Vector&gt; norm_map;

	for( t=0;t&lt;no_tris;++t )
	{

		int tri_no=(t+1)*3;
		
		int v0=tris[tri_no-3]*3;
		int v1=tris[tri_no-2]*3;
		int v2=tris[tri_no-1]*3;

		// ------------------------
		// 	va=v2-v1; vb=v3-v1;
		// ------------------------
		ax=vert_coords[v1  ]-vert_coords[v0];
		ay=vert_coords[v1+1]-vert_coords[v0+1];
		az=vert_coords[v1+2]-vert_coords[v0+2];

		bx=vert_coords[v2  ]-vert_coords[v0];
		by=vert_coords[v2+1]-vert_coords[v0+1];
		bz=vert_coords[v2+2]-vert_coords[v0+2];

		Vector n((ay*bz)-(az*by), (az*bx)-(ax*bz), (ax*by)-(ay*bx));
		n.normalize();
		
		v=TriangleVertex(t,0,tris)*3;
		Vector vex(vert_coords[v], vert_coords[v+1], vz=vert_coords[v+2]);
		norm_map[vex] = n;

		// ------------------------
		// va=v3-v2; vb=v1-v2;
		// ------------------------
		ax=vert_coords[v2  ]-vert_coords[v1];
		ay=vert_coords[v2+1]-vert_coords[v1+1];
		az=vert_coords[v2+2]-vert_coords[v1+2];

		bx=vert_coords[v0  ]-vert_coords[v1];
		by=vert_coords[v0+1]-vert_coords[v1+1];
		bz=vert_coords[v0+2]-vert_coords[v1+2];

		Vector n2((ay*bz)-(az*by), (az*bx)-(ax*bz), (ax*by)-(ay*bx));
		n2.normalize();

		v=TriangleVertex(t,1,tris)*3;
		Vector vex2(vert_coords[v], vert_coords[v+1], vz=vert_coords[v+2]);
		norm_map[vex2] = n2;

		// ------------------------
		// va=v1-v3; vb=v2-v3;
		// ------------------------
		ax=vert_coords[v0  ]-vert_coords[v2];
		ay=vert_coords[v0+1]-vert_coords[v2+1];
		az=vert_coords[v0+2]-vert_coords[v2+2];

		bx=vert_coords[v1  ]-vert_coords[v2];
		by=vert_coords[v1+1]-vert_coords[v2+1];
		bz=vert_coords[v1+2]-vert_coords[v2+2];

		Vector n3((ay*bz)-(az*by), (az*bx)-(ax*bz), (ax*by)-(ay*bx));
		n3.normalize();

		v=TriangleVertex(t,2,tris)*3;
		Vector vex3(vert_coords[v], vert_coords[v+1], vz=vert_coords[v+2]);
		norm_map[vex3] = n3;
				
	}


	int v3;
	for( v=0;v&lt;no_verts;++v ){
	
		v3 = v*3;
		vx=vert_coords[v3]; // surf.VertexX(v)
		vy=vert_coords[(v3)+1]; // surf.VertexY(v)
		vz=vert_coords[(v3)+2]; // surf.VertexZ(v)
		
		Vector vert(vx,vy,vz);
		Vector norm=norm_map[vert];	
		norm.normalize();
		vert_norm[v3+0]=norm.x; // surf.VertexNormal(v,norm.x,norm.y,norm.z)
		vert_norm[v3+1]=norm.y; // surf.VertexNormal(v,norm.x,norm.y,norm.z)
		vert_norm[v3+2]=norm.z; // surf.VertexNormal(v,norm.x,norm.y,norm.z)
	
	}
	
}
</textarea><br><br>Here's the result:<br><img src="http://img.photobucket.com/albums/v431/SLotman/shine2.jpg"><br><br>Maybe someone can improve it so it looks right?<br><br><font class="tiny">Last edited 2010</font> <br><br></td></tr></table><br>
<a name="1053306"></a>

<a name="1053308"></a>

<a name="1053309"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >SLotman</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#11">[#11]</a></td></tr></table></td></tr><tr ><td class="posttext"> And even more problems :(<br><br>I load my model with LoadAnimMesh - then I use copyEntity to copy that model... but if I try to animate that model, miniB3D crashes on this line:<br><br><pre class=code>
bone=ent.bones[anim_surf.vert_bone1_no[vid]-1]
</pre><br><br>This is on TAnimation.bmx, function Vertex Deform. The error is "Attempt to index array beoynd array length" - apparently when using copy entity the animations aren't copied with it? On Blitz3D animations are copied...<br><br>Edit: apparently bones *are* copied, but somehow no_bones=0. vid=0 when the crash occurs. <br><br>Edit2: anim_surf.vert_bone1_no[0] exists, so it's looking for a bone that doesn't exist on ent.bones. I used biped on 3dmax to animate the model (with skin, so the animation works) - probably it isnt copying child bones? on ent.bones I could only see the "bip01-pelvis" bone.<br><br>I have no idea what to do on this one :(<br><br><font class="tiny">Last edited 2010</font><br><br><font class="tiny">Last edited 2010</font> <br><br></td></tr></table><br>
<a name="1053461"></a>

<a name="1053471"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >SLotman</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#12">[#12]</a></td></tr></table></td></tr><tr ><td class="posttext"> I don't get it. I just wront a small function to dump the mesh structure, and it look ok. Here's the code:<br><br><textarea class=codebox name="code" wrap=OFF readonly="true" rows="15" cols="80">
Global pstr$="..............................."

Function dumpchildren(en:TEntity, level%)
	For Local e%=0 To CountChildren(en)-1
	   Local ent:TEntity=GetChild(en,e)
	   If (ent) Then 
	      If level&gt;0 Then
	         DebugLog Left$(pstr$, level * 2) + "class:" + EntityClass(ent) + " name:" + EntityName(ent)
	      Else
	         DebugLog "class:" + EntityClass(ent) + " name:" + EntityName(ent)
	      End If
	      If CountChildren(ent)&gt;0 Then
	         dumpchildren(ent, level+1)
	      End If
	   End If
	Next
End Function

Graphics3D 800,600,32, 2

Global camera:TCamera = CreateCamera()
Global kid1Mesh:TMesh = LoadAnimMesh("data/models/piece1.b3d")

DebugLog "----------------------------------------------"
DebugLog "Original entity:"
DebugLog "----------------------------------------------"
dumpchildren(kid1Mesh, 0)

DebugLog "----------------------------------------------"
DebugLog "Entity copied:"
DebugLog "----------------------------------------------"
Local kidb:TMesh=kid1Mesh.CopyEntity()
dumpchildren(kidb, 0)

End

</textarea><br><br>The results are the same for both meshes:<br><textarea class=codebox name="code" wrap=OFF readonly="true" rows="15" cols="80">
DebugLog:class:Mesh name:head
DebugLog:..class:Bone name:Bip01 Head
DebugLog:class:Mesh name:pants
DebugLog:..class:Bone name:Bip01 Pelvis
DebugLog:class:Mesh name:shirt
DebugLog:..class:Bone name:Bip01 Pelvis
DebugLog:class:Mesh name:rarm
DebugLog:..class:Bone name:Bip01 R Clavicle
DebugLog:class:Mesh name:larm
DebugLog:..class:Bone name:Bip01 L Clavicle
DebugLog:class:Mesh name:rhand
DebugLog:..class:Bone name:Bip01 R Forearm
DebugLog:class:Mesh name:lhand
DebugLog:..class:Bone name:Bip01 L Forearm
DebugLog:class:Mesh name:head01
DebugLog:..class:Bone name:Bip01 Head
</textarea><br><br>The only difference I see from Blitz3D is that on Blitz3D every bone is created as a Pivot, not a "Bone"; but that shouldn't be the problem.<br><br>So why is it crashing? What is wrong in miniB3D CopyEntity???<br><br>Edit: hmmm... I just saw this is an old bug: <a href="http://www.blitzbasic.com/Community/posts.php?topic=74579#833500" target="_blank">http://www.blitzbasic.com/Community/posts.php?topic=74579#833500</a><br><br>I could really, really use a fix for that...!<br><br><font class="tiny">Last edited 2010</font> <br><br></td></tr></table><br>
<a name="1053484"></a>

<a name="1053485"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >SLotman</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#13">[#13]</a></td></tr></table></td></tr><tr ><td class="posttext"> hmmm... I think I managed to reproduce it.<br><br>The problem seems to have two meshes attached to the same bone.<br><br>Here is a small package, with the code and the model (in .max 9 format, .3ds, .b3d and .fbx) that reproduces the error:<br><br><a href="http://www.icongames.com.br/temp/minib3d-bug.zip" target="_blank">http://www.icongames.com.br/temp/minib3d-bug.zip</a><br><br>The model is just two boxes, and a biped. Both boxes I applied the "skin" modifier, and added the biped head as a bone.<br><br>With just one box skinned to the head, everything worked. Once I added a second box, and also skinned it to the head, then miniB3D crashed.<br><br><font class="tiny">Last edited 2010</font> <br><br></td></tr></table><br>
<a name="1053511"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >SLotman</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#14">[#14]</a></td></tr></table></td></tr><tr ><td class="posttext"> No one? It would be pretty bad if I have to load my meshes over and over again, instead of just doing a copyentity... =( <br><br></td></tr></table><br>
<a name="1053533"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Warner</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#15">[#15]</a></td></tr></table></td></tr><tr ><td class="posttext"> When you use copyentity, the objects bones are copied as well. It seems that there is a problem with that. I think it is caused by 'CopyBonesList' in TMesh.bmx<br>If you compare the boneslist of the original and the copy, you see they are different:<br><textarea class=codebox name="code" wrap=OFF readonly="true" rows="15" cols="80">
Import sidesign.minib3d

Graphics3D 640,480,0,2

CreateLight()

Local camera:TCamera=CreateCamera()
MoveEntity camera,0,50,-150

Local model:TMesh = LoadAnimMesh("model.b3d")

PointEntity camera, model

'Animate FindChild(model,"Box01"), 1, 0.7
'Animate FindChild(model,"Box02"), 1, 0.7

'Animate FindChild(model2,"Box01"), 1, 0.7
'Animate FindChild(model2,"Box02"), 1, 0.7

printbonescount(model)

Print "----"

Local model2:TMesh = TMesh(CopyEntity(model))

printbonescount(model2)

While Not KeyHit(KEY_ESCAPE)
	RenderWorld
	UpdateWorld
	Flip
Wend

End


Function printbonescount(e:TEntity)

	Local m:TMesh = TMesh(e)
	
	If m Then Print m.bones.length
	
	For i = 1 To CountChildren(e)
		Local g:Tentity = GetChild(e, i)		
		Print printbonescount(g)
	Next
	
End Function
</textarea> <br><br></td></tr></table><br>
<a name="1053597"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >SLotman</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#16">[#16]</a></td></tr></table></td></tr><tr ><td class="posttext"> I see... strangest thing is that, if I do something like model2.bones=model.bones[..] or a MemCopy(model2.bones, model.bones, sizeof(model.bones)) - the error still persists. <br><br></td></tr></table><br>
<a name="1053603"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Leon Drake</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#17">[#17]</a></td></tr></table></td></tr><tr ><td class="posttext"> I've had the same weird issue with my models as well using max 7 <br><br></td></tr></table><br>
<a name="1053606"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >SLotman</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#18">[#18]</a></td></tr></table></td></tr><tr ><td class="posttext"> YES!!!!!!! I did it!<br><br>This is how CopyBonesList should be:<br><textarea class=codebox name="code" wrap=OFF readonly="true" rows="15" cols="80">
	Function CopyBonesList(ent:TEntity, bones:TBone[] Var,no_bones% Var)

		For Local ent:TEntity=EachIn ent.child_list	
			If TBone(ent)&lt;&gt;Null
				no_bones=no_bones+1
				bones=bones[..no_bones]
				bones[no_bones-1]=TBone(ent)
				CopyBonesList(ent, bones, no_bones)
			Else
			    CopyBonesList(ent, tmesh(ent).bones, no_bones)
			EndIf			
		Next
		
	End Function
</textarea><br><br>Now it works!<br><br>Only thing left to fix now is the UpdateNormals function, so it gets smooth results like Blitz3D :)<br><br>Thank you so much Warner, I wouldn't be able to fix this without your help! <br><br></td></tr></table><br>
<a name="1053628"></a>

<a name="1053629"></a>

<a name="1053659"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Warner</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#19">[#19]</a></td></tr></table></td></tr><tr ><td class="posttext"> No problem and good work! <br>About this UpdateNormals problem: In Blitz3d, I created a cube, and used UpdateNormals. Then I exported it to minib3d as data.<br>In minib3d, I used UpdateNormals on the same cube, and I used this program to compare the results:<br><textarea class=codebox name="code" wrap=OFF readonly="true" rows="15" cols="80">
Import sidesign.minib3d

Graphics3D 800, 600, 0, 2

'clone blitz3d cube
cube = CreateMesh()
cube2 = CreateMesh()

surf = CreateSurface(cube)
surf2 = CreateSurface(cube2)

For i = 0 To 23
	ReadData x#,y#,z#
	AddVertex surf, x, y, z
	AddVertex surf2, x, y, z
Next
For i = 0 To 23
	ReadData nx#,ny#,nz#
	VertexNormal surf, i, nx, ny, nz
	VertexNormal surf2, i, nx, ny, nz
Next
For i = 0 To 11
	ReadData a, b, c
	AddTriangle surf, a, b, c
	AddTriangle surf2, a, b, c
Next

UpdateNormals cube2

For i = 0 To CountVertices(surf)-1
	DebugLog "[B3D]  " + i + ": " + VertexNX(surf, i) + "," + VertexNY(surf, i) + "," + VertexNZ(surf, i)
	DebugLog "[MB3D] " + i + ": " + VertexNX(surf2, i) + "," + VertexNY(surf2, i) + "," + VertexNZ(surf2, i)
	DebugLog " "
Next
		
DefData -1.0,1.0,-1.0
DefData 1.0,1.0,-1.0
DefData 1.0,-1.0,-1.0
DefData -1.0,-1.0,-1.0
DefData 1.0,1.0,-1.0
DefData 1.0,1.0,1.0
DefData 1.0,-1.0,1.0
DefData 1.0,-1.0,-1.0
DefData 1.0,1.0,1.0
DefData -1.0,1.0,1.0
DefData -1.0,-1.0,1.0
DefData 1.0,-1.0,1.0
DefData -1.0,1.0,1.0
DefData -1.0,1.0,-1.0
DefData -1.0,-1.0,-1.0
DefData -1.0,-1.0,1.0
DefData -1.0,1.0,1.0
DefData 1.0,1.0,1.0
DefData 1.0,1.0,-1.0
DefData -1.0,1.0,-1.0
DefData -1.0,-1.0,-1.0
DefData 1.0,-1.0,-1.0
DefData 1.0,-1.0,1.0
DefData -1.0,-1.0,1.0

DefData -0.408248,0.408248,-0.816497
DefData 0.666667,0.666667,-0.333333
DefData 0.408248,-0.408248,-0.816497
DefData -0.666667,-0.666667,-0.333333
DefData 0.666667,0.666667,-0.333333
DefData 0.408248,0.408248,0.816497
DefData 0.666667,-0.666667,0.333333
DefData 0.408248,-0.408248,-0.816497
DefData 0.408248,0.408248,0.816497
DefData -0.666667,0.666667,0.333333
DefData -0.408248,-0.408248,0.816497
DefData 0.666667,-0.666667,0.333333
DefData -0.666667,0.666667,0.333333
DefData -0.408248,0.408248,-0.816497
DefData -0.666667,-0.666667,-0.333333
DefData -0.408248,-0.408248,0.816497
DefData -0.666667,0.666667,0.333333
DefData 0.408248,0.408248,0.816497
DefData 0.666667,0.666667,-0.333333
DefData -0.408248,0.408248,-0.816497
DefData -0.666667,-0.666667,-0.333333
DefData 0.408248,-0.408248,-0.816497
DefData 0.666667,-0.666667,0.333333
DefData -0.408248,-0.408248,0.816497

DefData 0,1,2
DefData 0,2,3
DefData 4,5,6
DefData 4,6,7
DefData 8,9,10
DefData 8,10,11
DefData 12,13,14
DefData 12,14,15
DefData 16,17,18
DefData 16,18,19
DefData 20,21,22
DefData 20,22,23</textarea><br>There doesn't seem to be too much difference between the two. I'm thinking that maybe the minib3d updatenormals is allready pretty close the the blitz3d one. Maybe there are differences between welded/unwelded meshes? That could be something to look into. Else, it might be a difference in rendering settings instead.<br><br><font class="tiny">Last edited 2010</font> <br><br></td></tr></table><br>
<a name="1053708"></a>

<a name="1053709"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >SLotman</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#20">[#20]</a></td></tr></table></td></tr><tr ><td class="posttext"> Yeah, you're right - the problem is somewhere else besides the normals... maybe the spheremap, I'll have to dig further to find out :/<br><br><font class="tiny">Last edited 2010</font> <br><br></td></tr></table><br>
<a name="1053816"></a>

<a name="1053822"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >SLotman</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#21">[#21]</a></td></tr></table></td></tr><tr ><td class="posttext"> Oh man...<br><br>Just noticed another problem. After 'fixing' the copyentity problem - I found another one. If I animate the original model, the second one animates too.<br><br>If I change the animation on the second, the first one also changes. That doesn't happen on Blitz3D - you can animate each copied model independently... so, still a bug on copying the bones, or a animation bug?<br><br>Edit: Arg! It has something to do with my fix... using copyentity on the zombie model crashes, while on 'regular' minib3d it works. Back to the drawing board, I guess =(<br><br><font class="tiny">Last edited 2010</font> <br><br></td></tr></table><br>
<a name="1053818"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Leon Drake</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#22">[#22]</a></td></tr></table></td></tr><tr ><td class="posttext"> sounds like its instancing the bones and not actually making new bones. <br><br></td></tr></table><br>
<a name="1053826"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >SLotman</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#23">[#23]</a></td></tr></table></td></tr><tr ><td class="posttext"> Now it works with both the zombie model (from the samples folder) *and* my own, with correct animations =)<br><br><textarea class=codebox name="code" wrap=OFF readonly="true" rows="15" cols="80">
	Function CopyBonesList(ent:TEntity, bones:TBone[] Var,no_bones% Var)

		For Local ent:TEntity=EachIn ent.child_list	
			If TBone(ent)&lt;&gt;Null
				no_bones=no_bones+1
				bones=bones[..no_bones]
				bones[no_bones-1]=TBone(ent)
			End If
			
			If tmesh(ent) Then 
			   CopyBonesList(ent, tmesh(ent).bones, no_bones)
			Else
			   CopyBonesList(ent, bones, no_bones)
			End If
		Next
		
	End Function
</textarea> <br><br></td></tr></table><br>
<a name="1053859"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Leon Drake</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#24">[#24]</a></td></tr></table></td></tr><tr ><td class="posttext"> Awesome, i was always having issues with loading my b3d models in minib3d among another thing i can't replicate in minib3d that i can do in blitz3d <br><br></td></tr></table><br>
<a name="1064855"></a>

<a name="1064856"></a>

<a name="1064857"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >RemiD</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#25">[#25]</a></td></tr></table></td></tr><tr ><td class="posttext"> Hello,<br><br>I don't understand all your code but i agree with this :<br><div class="quote"> <br>Maybe there are differences between welded/unwelded meshes? <br> <br></div><br><br>When you unwrap/unweld a mesh, the unwrap program duplicates some vertices and changes their normals. Then lights affect them differently.<br><br>You can see this if you create a cube with only 8 vertices and 12 tris or a cube with 24 vertices and 12 tris.<br><br><font class="tiny">Last edited 2010</font><br><br><font class="tiny">Last edited 2010</font> <br><br></td></tr></table><br>
<a name="1250136"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Silver_Knee</td><td align="right"><font class=tiny>(Posted 2014)</font>&nbsp;<a href="#26">[#26]</a></td></tr></table></td></tr><tr ><td class="posttext"> Hey,<br><br>sorry to dig this up, but I have a similiar problem like SLotman in the first Post.<br><br>I tried to fix my model with the following:<br><pre class=code>
Function FixModel(ent:TEntity)
	ent.RotateEntity 0 , 0 , 0
	ent.ScaleEntity 1 , 1 , 1
	For Local child:TEntity = EachIn ent.child_list
		FixModel(child)
	Next
End Function 
</pre><br><br>but this doesn't help. I don't know what<br><div class="quote"> Apparently it has something to do with the meshes pivot (on Max) rotation... reseting scale/transforms on them improved a lot the situation.  <br></div><br><br>could mean other than resetting the scale and the rotation. If I reset the position, every part of the model is in the center. <br><br>Does anyone know a solution to this?<br><br>Greez<br>Silver_Knee <br><br></td></tr></table><br>
<a name="1250611"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >markcw</td><td align="right"><font class=tiny>(Posted 2014)</font>&nbsp;<a href="#27">[#27]</a></td></tr></table></td></tr><tr ><td class="posttext"> Would really need a sample b3d to help here. <br><br></td></tr></table><br>
<a name="1250687"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Silver_Knee</td><td align="right"><font class=tiny>(Posted 2014)</font>&nbsp;<a href="#28">[#28]</a></td></tr></table></td></tr><tr ><td class="posttext"> This was the model I worked with. There is no animation saved but i wanted the childs to work with them.<br><br><a href="http://www.fs-com.com/station.B3D" target="_blank">http://www.fs-com.com/station.B3D</a> <br><br></td></tr></table><br>
<a name="1250731"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >markcw</td><td align="right"><font class=tiny>(Posted 2014)</font>&nbsp;<a href="#29">[#29]</a></td></tr></table></td></tr><tr ><td class="posttext"> Sorry but that's far too complicated a model to debug with. <br><br></td></tr></table><br>
<a name="1250737"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Silver_Knee</td><td align="right"><font class=tiny>(Posted 2014)</font>&nbsp;<a href="#30">[#30]</a></td></tr></table></td></tr><tr ><td class="posttext"> Okay. But did you see the wrongly positioned elements? I'll ask my gfx guy to build a more simple model. <br><br></td></tr></table><br>
<a name="1250743"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >markcw</td><td align="right"><font class=tiny>(Posted 2014)</font>&nbsp;<a href="#31">[#31]</a></td></tr></table></td></tr><tr ><td class="posttext"> I wasn't able to make out what it was really. <br><br></td></tr></table><br>
<a name="1250751"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Silver_Knee</td><td align="right"><font class=tiny>(Posted 2014)</font>&nbsp;<a href="#32">[#32]</a></td></tr></table></td></tr><tr ><td class="posttext"> Load it with LoadMesh then it is positioned correctly. It's a space station (without textures). <br><br></td></tr></table><br>
<a name="1250783"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >angros47</td><td align="right"><font class=tiny>(Posted 2014)</font>&nbsp;<a href="#33">[#33]</a></td></tr></table></td></tr><tr ><td class="posttext"> The mesh is too big, you need to scale it down by at least 0,001.<br><br>An animated mesh cannot be scaled by ScaleMesh or FitMesh, you need to use ScaleEntity. Maybe you used FitMesh...<br><br>Try loading it with LoadAnimMesh and scaling it with ScaleEntity mesh,.001,.001,.001 <br><br></td></tr></table><br>
<a name="1250797"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Silver_Knee</td><td align="right"><font class=tiny>(Posted 2014)</font>&nbsp;<a href="#34">[#34]</a></td></tr></table></td></tr><tr ><td class="posttext"> Huh? How can it be too big? And how can it be only too big if it's loaded with LoadAnimMesh? I'll try scaling it though as I am at home. <br><br></td></tr></table><br>
<a name="1250800"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >angros47</td><td align="right"><font class=tiny>(Posted 2014)</font>&nbsp;<a href="#35">[#35]</a></td></tr></table></td></tr><tr ><td class="posttext"> By default, CameraRange is 1000: if the mesh is wider, it's too big. <br><br>If you load it with LoadMesh, it will be a single mesh, and you can scale it with ScaleMesh (or with FitMesh, that works automatically); these commands don't work well if you load it with LoadAnimMesh, because it is loaded as an entity with many children, not a single mesh: ScaleMesh and FitMesh don't affect children. <br><br></td></tr></table><br>
<a name="1250818"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Silver_Knee</td><td align="right"><font class=tiny>(Posted 2014)</font>&nbsp;<a href="#36">[#36]</a></td></tr></table></td></tr><tr ><td class="posttext"> I have a test code for you.<br>Press 1 to switch between loadmesh and loadanimmesh 2 to turn and 3 to scale down.<br><pre class=code>SuperStrict
Framework sidesign.minib3d

Const FILENAME:String="station.b3d"

Graphics3D 800 , 600 , 32 , 2

Local camera:TCamera=CreateCamera()

CreateLight()

Local a:TMEsh = LoadMesh(FILENAME)
Local b:TEntity = LoadAnimMesh(FILENAME)

PositionEntity camera,0,0,-1000

HideEntity b

Local show:Byte=0
DebugLog "go"
Repeat
	If KeyHit(KEY_1)
		If show
			ShowEntity a
			HideEntity b
			show = 0
			DebugLog "a"
		Else
			HideEntity a
			ShowEntity b
			show = 1
			DebugLog "b"
		EndIf
	EndIf
	
	If KeyDown(KEY_2)
		TurnEntity a,0,1,0
		TurnEntity b,0,1,0
	EndIf 
	
	If KeyHit(KEY_3)
		ScaleEntity a,0.001,0.001,0.001
		ScaleEntity b,0.001,0.001,0.001
		PositionEntity camera,0,0,-2
	EndIf
	RenderWorld
	Flip
Until KeyHit(KEY_ESCAPE) Or AppTerminate()
End </pre><br><br>As you see the entity, that was loaded by loadanimmesh, is scrambled after TurnEntity is used on it the first time. Maybe this has something to do with the Matrix of the sub entities that aren't set up correctly.<br><br>@angros47 I've never used a Mesh-Command such as FitMesh/ScaleMesh/RotateMesh I always used Entity-Commands. I also don't have a problem seeing it; it's scambled just like the figure in OP. <br><br></td></tr></table><br>
<a name="1250819"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >angros47</td><td align="right"><font class=tiny>(Posted 2014)</font>&nbsp;<a href="#37">[#37]</a></td></tr></table></td></tr><tr ><td class="posttext"> I made my tests under OpenB3D; I'm not sure about what happens in minib3d. <br><br></td></tr></table><br>
<a name="1250820"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Silver_Knee</td><td align="right"><font class=tiny>(Posted 2014)</font>&nbsp;<a href="#38">[#38]</a></td></tr></table></td></tr><tr ><td class="posttext"> Here is another, more simple model, that gets the same error:<br><br><a href="http://evolver.bplaced.net/pyra.rar" target="_blank">http://evolver.bplaced.net/pyra.rar</a> <br><br></td></tr></table><br>
<a name="1254399"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Leon Drake</td><td align="right"><font class=tiny>(Posted 2015)</font>&nbsp;<a href="#39">[#39]</a></td></tr></table></td></tr><tr ><td class="posttext"> yea i just bought Ultimate unwrap cause i didn't want to deal with this anymore, same thing happens on minib3d for monkey <br><br></td></tr></table><br>
<a name="1254432"></a>

<a name="1254433"></a>

<a name="1254434"></a>

<a name="1254435"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Kryzon</td><td align="right"><font class=tiny>(Posted 2015)</font>&nbsp;<a href="#40">[#40]</a></td></tr></table></td></tr><tr ><td class="posttext"> Almost every engine that is used on published games have some form of a standard asset pipeline.<br>If you have to go in circles just to import your assets then that shows that there's something really wrong. <br>A game SDK is supposed to let you work smarter, not harder. <br><br></td></tr></table><br>
<a name="1254497"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Leon Drake</td><td align="right"><font class=tiny>(Posted 2015)</font>&nbsp;<a href="#41">[#41]</a></td></tr></table></td></tr><tr ><td class="posttext"> blitz3d has some terribad pipeline, i made a working Cal3d library for minib3d. just need to polish it off but i do love being able to use the physique modifier and make use of spring systems for loose clothing and hair.<br><br>but i still need to optimize it a bit because i have to generate the vertices changes and push them into the VBO of a b3d mesh object every frame. <br><br></td></tr></table><br>
<a name="bottom"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td align="right"><a href="http://monkeycoder.co.nz" target="_blank"><img src="/img/monkey2.svg" ></a> <a href="https://github.com/blitz-research" target="_blank"><img src="/img/github.svg" ></a> <a href="https://discord.gg/qJccbSp" target="_blank"><img src="/img/discord.svg" ></a></td></tr></table><br></div><br><table width="100%"><tr><td></body></html lang="en">
