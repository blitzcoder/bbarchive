<!DOCTYPE html><html lang="en" ><head ><title >iminiB3D, EXC_BAD_ACCESS, and data alignments</title><meta name='viewport' content='width=device-width, initial-scale=0.66'><meta name='description' content='language:basic, target:desktop, category:game development'><link rel="styleSheet" href="../skins/granite/style.css" type="text/css"><style type="text/css">div.bbcode {padding: 8px;background: #E5E5E5;color: #000000;border: 1px dashed #B4B4BE;}</style></head><body ><table width=100% cellspacing=0 cellpadding=0><tr ><td class="menubarleft"></td><td class="menubar"><table cellspacing="0" cellpadding="0"><tr ><td >&nbsp;</td><td class="menuitemleft"></td><td class="menuitem"><a href="/" class="menuitem">News</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/forums.php" class="menuitem">Forums</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/codearcs.php" class="menuitem">Code</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/logs.php" class="menuitem">Logs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/gallery.php" class="menuitem">Gallery</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/sdkspecs.php" class="menuitem">Specs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/search.php" class="menuitem">Search</a></td><td class="menuitemright"></td></tr></table></td><td class="menubarright"></td></tr></table><div class="main"><h1 >iminiB3D, EXC_BAD_ACCESS, and data alignments</h1><a href="forums.php" >BlitzMax Forums</a>/<a href="topics.php?forum=119" >MiniB3D Module</a>/<a href="#bottom" >iminiB3D, EXC_BAD_ACCESS, and data alignments</a><br><br>
<a name="1118975"></a>

<a name="1118976"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Yasha</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#1">[#1]</a></td></tr></table></td></tr><tr ><td class="posttext"> Hey all,<br><br>So, I'm using iminiB3D for one of my current projects, and I've discovered something that struck me as rather odd. Attempting to load .b3d files results in an EXC_BAD_ACCESS in the first PeekFloat called by LoadAnimB3D, but only if running on the device itself, not in the simulator. Turns out this wasn't just my own code playing up: the exact same error happens when trying to run the <i>unmodified</i> Zombie demo, included with iminiB3D.<br><br>After some experimentation and poking around, I have discovered that apparently ARM processors really don't like being asked to read floats from memory offsets not aligned to the four-byte mark, which is something that doesn;t bother x86 at all (and therefore doesn't affect the simulator):<br><br><a href="http://stackoverflow.com/questions/7788216/exc-bad-access-and-char-pointer-to-float-pointer-cast" target="_blank">http://stackoverflow.com/questions/7788216/exc-bad-access-and-char-pointer-to-float-pointer-cast</a><br><a href="http://stackoverflow.com/questions/3243146/why-does-this-exc-bad-access-happen-with-long-long-and-not-with-int" target="_blank">http://stackoverflow.com/questions/3243146/why-does-this-exc-bad-access-happen-with-long-long-and-not-with-int</a><br><a href="http://www.aleph1.co.uk/chapter-10-arm-structured-alignment-faq" target="_blank">http://www.aleph1.co.uk/chapter-10-arm-structured-alignment-faq</a><br><br>...which seems like a bit of a showstopper for the Bank code included in iminiB3D, which doesn't appear to make any provision for alignment at all.<br><br>I got it to work correctly with a simple modification to PeekFloat:<br><pre class=code>float Bank::PeekFloat(int offset){
    if(offset&gt;=0 &amp;&amp; offset&lt;size-3){
        float f; char * fb = (char *)&amp;f;
        fb[0] = buffer[offset];
        fb[1] = buffer[offset + 1];
        fb[2] = buffer[offset + 2];
        fb[3] = buffer[offset + 3];
        return f;
        //return *(reinterpret_cast&lt;float*&gt;(&amp;buffer[offset]));
    }
    return 0;
}</pre><br><br>...i.e. manually grab the four bytes of the float and <i>put</i> them in a slot we know to be aligned, before trying to access the data as a float. (Untidy, I know, but works for the moment.)<br><br>Surely this can't be the right way to address this problem? Am I really the only person to have tried to load a .b3d file on this combination of platforms? Does this issue affect the iPhone? Or, more likely, am I missing something incredibly obvious (bear in mind that I am, after all, a bit of an idiot)?<br><br>(Setup: iPad 2, iOS 5, Snow Leopard, old-model Mac mini.)<br><br><font class="tiny">Last edited 2011</font> <br><br></td></tr></table><br>
<a name="1119012"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >ima747</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#2">[#2]</a></td></tr></table></td></tr><tr ><td class="posttext"> I've been using snow leopard and started on a mini a while ago for its Dev. My devices are all running iOS 5 now including the iPad 2. I have not noticed this problem however I don't tend to use a lot of meshes (been doing a lot of procedural stuff). Is it just certain meshes that cause this, or any mesh? ( if I dig up the zombie test and fire it off should I notice this or is it just a mesh you exported from something, if so what was it exported from/through?). How is your project built? Straight from the base project file or did you make your own project (possibly linker flags or something else affecting it on a different level...) <br><br></td></tr></table><br>
<a name="1119015"></a>

<a name="1119016"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >AdamRedwoods</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#3">[#3]</a></td></tr></table></td></tr><tr ><td class="posttext"> <strike>Try Zip Align<br>http://developer.android.com/guide/developing/tools/zipalign.html</strike><br>DUH-- sorry i see you're on iOS<br><br><font class="tiny">Last edited 2011</font> <br><br></td></tr></table><br>
<a name="1119019"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Yasha</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#4">[#4]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> if I dig up the zombie test and fire it off should I notice this <br></div><br><br>Yes. I first worked out what it was in my own project, but it affects the out-of-the-box iminiB3D demo as well. I assume it affects any files that have float data aligned to something other than a four-byte boundary.<br><br>My own models, and as far as I know, the zombie, were made with PaceMaker. <br><br></td></tr></table><br>
<a name="1119230"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >simonh</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#5">[#5]</a></td></tr></table></td></tr><tr ><td class="posttext"> Yes, this is an issue that has recently cropped up, I think since LLVM has replaced GCC.<br><br>I've only noticed it myself in the past few days, when attempting to recompile  my own game.<br><br>I'll attempt to fix it, but in the meantime, you might want to try using the LoadAnimB3DFile function instead of LoadAnimB3D (the former uses direct file access rather than loading the file into a bank first).<br><br>This seems to work fine on all my devices, although I've heard it may not work on an iPad 2 - would you be able to test for me please Yasha? <br><br></td></tr></table><br>
<a name="1119282"></a>

<a name="1119283"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Yasha</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#6">[#6]</a></td></tr></table></td></tr><tr ><td class="posttext"> In a very quick test, LoadAnimB3DFile worked fine in my own project (I managed to completely miss that that command existed until you mentioned it!), but interestingly didn't load the zombie when I tried swapping the line out in the bundled example. The app didn't fail: there just wasn't any zombie on screen. This was the case for both the simulator and the real device.<br><br>I will try again later, and see if I can work out why the mesh wasn't displayed in the zombie demo.<br><br><font class="tiny">Last edited 2011</font> <br><br></td></tr></table><br>
<a name="bottom"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td align="right"><a href="http://monkeycoder.co.nz" target="_blank"><img src="/img/monkey2.svg" ></a> <a href="https://github.com/blitz-research" target="_blank"><img src="/img/github.svg" ></a> <a href="https://discord.gg/qJccbSp" target="_blank"><img src="/img/discord.svg" ></a></td></tr></table><br></div><br><table width="100%"><tr><td></body></html lang="en">
