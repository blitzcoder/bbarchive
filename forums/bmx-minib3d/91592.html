<!DOCTYPE html><html lang="en" ><head ><title >FreeEntity crash on AnimMesh?</title><meta name='viewport' content='width=device-width, initial-scale=0.66'><meta name='description' content='language:basic, target:desktop, category:game development'><link rel="styleSheet" href="../skins/granite/style.css" type="text/css"><style type="text/css">div.bbcode {padding: 8px;background: #E5E5E5;color: #000000;border: 1px dashed #B4B4BE;}</style></head><body ><table width=100% cellspacing=0 cellpadding=0><tr ><td class="menubarleft"></td><td class="menubar"><table cellspacing="0" cellpadding="0"><tr ><td >&nbsp;</td><td class="menuitemleft"></td><td class="menuitem"><a href="/" class="menuitem">News</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/forums.php" class="menuitem">Forums</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/codearcs.php" class="menuitem">Code</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/logs.php" class="menuitem">Logs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/gallery.php" class="menuitem">Gallery</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/sdkspecs.php" class="menuitem">Specs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/search.php" class="menuitem">Search</a></td><td class="menuitemright"></td></tr></table></td><td class="menubarright"></td></tr></table><div class="main"><h1 >FreeEntity crash on AnimMesh?</h1><a href="forums.php" >BlitzMax Forums</a>/<a href="topics.php?forum=119" >MiniB3D Module</a>/<a href="#bottom" >FreeEntity crash on AnimMesh?</a><br><br>
<a name="1042254"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >jhocking</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#1">[#1]</a></td></tr></table></td></tr><tr ><td class="posttext"> I've just encountered a really frustrating bug that I'm trying to nail down. Basically, when I call FreeEntity on this one specific mesh the program crashes. I've used FreeEntity on a bunch of other objects in the scene with no problem, and the most obvious difference between this object causing the crash and everything so far is that this is the first time I'm calling FreeEntity on an AnimMesh (everything else has been sprites or static meshes.)<br><br>It's too early for me to say much for sure and I need to do some troubleshooting to try to isolate the situation, but for now I just wanted to check if anyone had a thought off the top of their head.<br><br>ADDITION: oops I forgot to specify I'm using iminib3d <br><br></td></tr></table><br>
<a name="1042273"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >GNS</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#2">[#2]</a></td></tr></table></td></tr><tr ><td class="posttext"> Just mocked up a quick test to try freeing a bunch of animated meshes. The mesh I used was just a simple Blender default cube that spins around via a single bone. Animate() was called right after the meshes were loaded. I tried freeing them one by one after a certain key was pressed, in large batches or all at once and never had an issue.<br><br>Are you doing anything special with the mesh? Referencing it anywhere after it's been freed? Loading animation sequences via LoadAnimSeq()? <br><br>Just shooting in the dark here atm. <br><br></td></tr></table><br>
<a name="1042292"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >jhocking</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#3">[#3]</a></td></tr></table></td></tr><tr ><td class="posttext"> oops I forgot to specify I'm using iminib3d<br><br>Thanks for checking. Personally I suspect that the issue is I forgot a reference to the object after freeing it, I'm just wondering if there's anything fundamental that's different about freeing animated meshes and static meshes.<br><br><br><br>ADDITION: Well I just narrowed down the code to the following snippet-<br><pre class=code>
printf("destroy before");
visual-&gt;FreeEntity();
printf("destroy after");
</pre><br><br>It crashed, and the console output was only "destroy before" so clearly the issue isn't to do with trying to use the object after freeing it. I just realized this is literally the first time I've tried to use FreeEntity on an animated mesh in iminib3d, so I think I'll whip up a minimal example to see if that crashes too.<br><br>Can anyone confirm that they have used FreeEntity on animated models in iminib3d, so this isn't simply a bug in iminib3d? <br><br></td></tr></table><br>
<a name="1042391"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >jhocking</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#4">[#4]</a></td></tr></table></td></tr><tr ><td class="posttext"> okay this definitely looks like a bug in iminib3d, I just tried this code and it crashed:<br><br><pre class=code>
Mesh* test = Mesh::LoadAnimMesh("dwarf.b3d");
test-&gt;FreeEntity();
</pre> <br><br></td></tr></table><br>
<a name="1042400"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >JoeRetro</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#5">[#5]</a></td></tr></table></td></tr><tr ><td class="posttext"> Yup, I get the same results using FreeEntity on animated meshes.  FreeEntity works fine on static meshes as you stated Joe.<br><br>If you put a break point(s) in the FreeEntity func you'll noticed that it tries to free the children meshes which seems to be the culprit. <br><br></td></tr></table><br>
<a name="1042552"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >jhocking</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#6">[#6]</a></td></tr></table></td></tr><tr ><td class="posttext"> Off the top of my head, I'm guessing the problem has to do with bones being considered child meshes but, well, they aren't meshes.<br><br>I guess I'll just hide the models as a temporary workaround to move forward on other things and hope that simon fixes this bug. <br><br></td></tr></table><br>
<a name="1046671"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >jhocking</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#7">[#7]</a></td></tr></table></td></tr><tr ><td class="posttext"> alright I've been ignoring/working around this problem long enough, I need to actually get this fixed. As the standard first step I turned on the debugger to see where it crashes. It crashes in operator++() of stl_list.h, which is pretty much a one line function for<br><pre class=code>_M_node = _M_node-&gt;_M_next;</pre><br><br>That probably means there is somewhere in the iminib3d code that loops through all the linked bones but accidentally attempts to loop beyond the end bones. That's where I'll start looking. <br><br></td></tr></table><br>
<a name="1046674"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >ima747</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#8">[#8]</a></td></tr></table></td></tr><tr ><td class="posttext"> I think there may be a problem with the lists themselves in iMiniB3D. I get occasional crashes when testing on my phone (as in totally un-repeatable but happens maybe 1/40 compiles... re-run and it's not there...) related to updating entity parents when it loops through an entity's children etc. I was thinking of diving into the list structure and maybe rebuilding it in Objective C just for kicks to see what would happen...<br><br>Can you post your mesh somewhere? I'd like to see it crash and poke the relationship if I have time... <br><br></td></tr></table><br>
<a name="1046675"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >jhocking</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#9">[#9]</a></td></tr></table></td></tr><tr ><td class="posttext"> Sure I can post the mesh, just a minute.<br><br>In the meantime, I dug a bit further and went to the part of FreeEntity in entity.mm where it iterates through the child list. I commented out these lines and now it doesn't crash:<br><br>//ent-&gt;FreeEntity();			<br>//it=child_list.begin();<br>//it--;<br><br>Of course now it isn't freeing the child entities so it's probably generating memory leaks, but hopefully this points someone in the right direction.<br><br>EDIT: Here's an animated mesh to load and try to free<br><a href="http://www.tofrutti.com/dev/gnome.b3d" target="_blank">http://www.tofrutti.com/dev/gnome.b3d</a> <br><br></td></tr></table><br>
<a name="1048667"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >jhocking</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#10">[#10]</a></td></tr></table></td></tr><tr ><td class="posttext"> Just a further note about the lines I indicated above...<br><br>Commenting out those lines caused a bunch of weird bugs all over my game, which in retrospect I should have expected. I just restored those restored those lines; I need to wait for or eventually figure out a fix for this anyway.<br><br>Incidentally, perhaps GNS should post his test mesh as well? If his did work but mine don't, I'm curious what the difference is. <br><br></td></tr></table><br>
<a name="1048909"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >simonh</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#11">[#11]</a></td></tr></table></td></tr><tr ><td class="posttext"> Looking into this now. A quick fix seems to be to parent the anim mesh to a pivot, and then free the pivot to free the anim mesh without a crash. This is what I do in my game, which is why I haven't encountered the crash before. <br><br></td></tr></table><br>
<a name="1048929"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >simonh</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#12">[#12]</a></td></tr></table></td></tr><tr ><td class="posttext"> OK, to fix this, you need to comment out the line in Mesh::FreeEntity that deletes the bone (your suspicions about bones being the problem were right Joe).<br><br>Also, a related issue is that in entity.h, you need to make the FreeEntity function virtual, like the CopyEntity function. This is the reason that a child anim mesh wasn't crashing when the parent was freed - because only the base class (Entity) FreeEntity was being called for each entity, and not the derived classes (including Mesh) FreeEntity, leading to other potential issues.<br><br>There's also an issue with freeing lights. To fix this, you'll need to add:<br><br>light_list.remove(this);<br><br>After:<br><br>Entity::FreeEntity();<br><br>In Light::FreeEntity.<br><br>However, in order for that to work, you'll need to change light_list from a vector to a list - you just need to replace the 'vector' word with 'list' whenever it appears alongside 'light_list' - and this needs to be done in light.h, at the top of light.mm, and in camera.mm's Camera::Render.<br><br>Thanks for your patience while I finally got around to fixing this. I'll release a new version with these fixes soon. <br><br></td></tr></table><br>
<a name="1049090"></a>

<a name="1049093"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >jhocking</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#13">[#13]</a></td></tr></table></td></tr><tr ><td class="posttext"> Thanks so much! I'll test out your solution tonight to make sure it works.<br><br>Incidentally...<br><br><div class="quote"> you need to comment out the line in Mesh::FreeEntity that deletes the bone <br></div><br><br>Any chance you can point out which line exactly that is? I'm not looking at the code right now so maybe it's obvious or maybe I'll need a little more direction.<br><br><i>Last edited Tuesday 5th of October 2010 06:31:56 PM GMT</i> <br><br></td></tr></table><br>
<a name="1049107"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >simonh</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#14">[#14]</a></td></tr></table></td></tr><tr ><td class="posttext"> Yeah it should be obvious. There's a list that goes through all the bones one by one, just need to delete the line that deletes the bone. <br><br></td></tr></table><br>
<a name="1049756"></a>

<a name="1049757"></a>

<a name="1049758"></a>

<a name="1049762"></a>

<a name="1051124"></a>

<a name="1051126"></a>

<a name="1051128"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >jhocking</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#15">[#15]</a></td></tr></table></td></tr><tr ><td class="posttext"> Thanks again for those fixes, it worked great for several meshes. Some of my animated meshes still cause a crash after using FreeEntity however. The specific line the debugger stopped on is this one in Global::UpdateEntityAnim<br><br>if(mesh.anim &amp;&amp; mesh.anim_update==true){<br><br>I haven't yet dug into the problem to see what's different about these meshes from the ones that freed fine, but the crash on that line makes me suspect iminib3d is still trying to animate the meshes even after they've been freed. I'm thinking that means the FreeEntity method needs to remove them from Entity::animate_list<br><br>With that issue though I don't understand why my other meshes which had animations playing didn't crash. I'm guessing there's something really nitpicky happening with the order in which I free meshes and call UpdateWorld.<br><br><br><br>Any thoughts on what could be causing that crash in Global::UpdateEntityAnim?<br><br><font class="tiny">Last edited 2010</font> <br><br></td></tr></table><br>
<a name="1051129"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >jhocking</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#16">[#16]</a></td></tr></table></td></tr><tr ><td class="posttext"> The crash in UpdateEntityAnim pretty much tells you this already, but I isolated the crash to the first time UpdateWorld is called after freeing the meshes. I have this code shortly after freeing the animated meshes:<br><br><pre class=code>
NSLog(@"before");
Global::UpdateWorld();
NSLog(@"after");
</pre><br><br>and the console output has "before" but not "after." <br><br></td></tr></table><br>
<a name="bottom"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td align="right"><a href="http://monkeycoder.co.nz" target="_blank"><img src="/img/monkey2.svg" ></a> <a href="https://github.com/blitz-research" target="_blank"><img src="/img/github.svg" ></a> <a href="https://discord.gg/qJccbSp" target="_blank"><img src="/img/discord.svg" ></a></td></tr></table><br></div><br><table width="100%"><tr><td></body></html lang="en">
