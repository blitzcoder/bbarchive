<!DOCTYPE html><html lang="en" ><head ><title >Shifted Grid collision</title><meta name='viewport' content='width=device-width, initial-scale=0.66'><meta name='description' content='language:basic, target:desktop, category:game development'><link rel="styleSheet" href="../skins/granite/style.css" type="text/css"><style type="text/css">div.bbcode {padding: 8px;background: #E5E5E5;color: #000000;border: 1px dashed #B4B4BE;}</style></head><body ><table width=100% cellspacing=0 cellpadding=0><tr ><td class="menubarleft"></td><td class="menubar"><table cellspacing="0" cellpadding="0"><tr ><td >&nbsp;</td><td class="menuitemleft"></td><td class="menuitem"><a href="/" class="menuitem">News</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/forums.php" class="menuitem">Forums</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/codearcs.php" class="menuitem">Code</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/logs.php" class="menuitem">Logs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/gallery.php" class="menuitem">Gallery</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/sdkspecs.php" class="menuitem">Specs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/search.php" class="menuitem">Search</a></td><td class="menuitemright"></td></tr></table></td><td class="menubarright"></td></tr></table><div class="main"><h1 >Shifted Grid collision</h1><a href="forums.php" >BlitzMax Forums</a>/<a href="topics.php?forum=101" >BlitzMax Beginners Area</a>/<a href="#bottom" >Shifted Grid collision</a><br><br>
<a name="827689"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Drakim</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#1">[#1]</a></td></tr></table></td></tr><tr ><td class="posttext"> <a href="http://www.blitzbasic.com/codearcs/codearcs.php?code=1065" target="_blank">http://www.blitzbasic.com/codearcs/codearcs.php?code=1065</a><br><br>Now, I think I understand most of it, but I have some questions.<br><br>Just to make sure I don't have the entirely wrong idea about the system here, it works by:<br><br>dividing the area into a grid, and having a TList per square, the TLists saved inside an array. When I am to check objects for collisions, I only check the objects within a grind against each other, and not against those of an outside grind. Thus, objects that are really far apart won't check collisions against each other.<br>---<br><br><pre class=code>
Function update_sectors(shift_x_off%, shift_y_off%)

	; Reset sector linked list heads.
	For sx% = 0 To NUM_X_SECTORS
		For sy% = 0 To NUM_Y_SECTORS
			sector_head(sx,sy) = Null
		Next
	Next

	; Put each sprite into it's sector's linked list.
	For spr.spriteT = Each spriteT
		sx = Int(spr\x + shift_x_off) Shr find_sector
		sy = Int(spr\y + shift_y_off) Shr find_sector
		spr\sector_link = sector_head(sx,sy)
		sector_head(sx,sy) = spr
	Next
	
End Function
</pre><br><br>So, as I've understood this, this is a bit-shift operation in order to quickly and effectively sort the sprites into the right  sectors. But, I really don't understand exactly how it works. What does the Shr command do? the documentation didn't help me at all. &gt;_&gt;<br><br>Can anybody explain just how this works step by step?<br><br>---<br><br>Next, I have a bit different setup than the example game inside the code (it's just some basic sprites moving around). You see, my game doesn't a limit to the world size in any way. <br><br>I do it in a simple way. There is an X and Y for the screen, and all objects are modified according to this X and Y.<br><br>So, if the screen is at 100,100, and an object is at 150,150, then the object will be drawn at 50,50. Thus, by just adding and subtracting to the screen X and Y, we move around on an unlimited map (well, until the integer can't hold such a large number anymore ^^).<br><br>Any units outside a certain distance is deleted, preventing the massive load that would come after a while. And of course, objects are randomly created as you travel ahead, to simulate that you travel and stumble upon random stuff.<br><br>I don't see a problem, but is it possible that this can crash with the way the sectors are divided across the world? All I see that I need to do is have the sectors move as the screen does, but I don't exactly understand how the shift things works, so I might be missing out on something big here.<br><br>---<br><br>Another question. The reason why 4 sectors needs to be checked all at once is because objects may overlap some sectors, right? If so, then I understand that part, I think.<br><br><br><br>So, anyway, I had a hard time explaining some of the things here in short terms, so just give a friendly pointer if I didn't give enough information about something in order for you to answer my question, or if you need to look at my code, and not just my explanation of my code, to understand something.<br><br>Thanks in advance. <br><br></td></tr></table><br>
<a name="827705"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Derron</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#2">[#2]</a></td></tr></table></td></tr><tr ><td class="posttext"> You need to check:<br>1 grid... when no overlapping<br><br>4 grids... when overlapping occours and dimension of object  are smaller than height or width of grid-cell<br><br>up to 9 grids.. when the dimension of this object is bigger in height or width.<br><br>This may happen if there are really rare but big objects in the scene... instead of making the grid-cells bigger you may compute these objects in a special way. Otherwise the many small objects will produce bigger lists to compare against.<br><br>As I also don't really know things about bit-shifting:<br>---<br>SHR (from a basic dialect, dunno if its nearly the same - 5 bits - in BMax)<br><br><br>Reallocates bit-by-bit to the right. The least significant bits are lost. The zeros are incorporated subsequently in the most significant bits. Only the 5 least significant bits from &lt;number&gt; are always considered with the values of &lt;number&gt;  being located between 0 and 31.<br>SHR relays an unsigned integer division with powers of two ("X SHR Y" corresponds to "X\(2^Y)").<br>---<br><br>Short example:<br><br>81 SHR 3  = 81 / 2^3 = 81 / 8 = 10 (like a ceil(result) used)<br>87 SHR 3 = 87 / 8 = 10<br>88 SHR 3 = 88 / 8 = 11<br><br><br>So I assume that the shift does:<br><br>The find_sector is a global based on a calculation with the gridcell-size (eg. 32) - in this case the variable is 5.0000 .<br><br>If object.X is 103 and your gridcell-size is 32 then: Objext.x SHR find_sector<br><br>This is the same as: 103 SHR 5  ( ceil(103 / 2^5) = ceil(103 / 32))<br><br>Result will be 3 ... the coordinate x=103 lies in grid[3,y]<br>Remember that grid[0,0] exists (zero based start).<br><br><br>Assuming this, you can say that bitshifting is a shortcut to ceil a variable ... It's a useful thing like MOD.<br><br>So it may be also possible to calculate the correct grid by:<br>GridX = ceil(Object.X / gridsizeX)<br><br>But when the SHR-command is used, we can nearly be sure that it's done for the thought of speed improvement.<br><br><br>Hope I'm not totally wrong... if it's correct, I learnt something ;D.<br><br>bye<br>MB <br><br></td></tr></table><br>
<a name="827811"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Drakim</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#3">[#3]</a></td></tr></table></td></tr><tr ><td class="posttext"> Ah, I see, so the SHR command is used to quickly identify which list the object is going into without dividing and all that slow crap that I would do. Genius!<br><br>Hmm, yes, then I think I know enough to start making these grinds. However, is somebody knows the answer to my other questions, then please answer! <br><br></td></tr></table><br>
<a name="827867"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >big10p</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#4">[#4]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> Any units outside a certain distance is deleted, preventing the massive load that would come after a while. And of course, objects are randomly created as you travel ahead, to simulate that you travel and stumble upon random stuff. <br></div>Create a collision grid the size of the rectangle defined by the distance you're using to delete sprites that are 'out of range'. You MUST ensure that no sprite can exist outside of this range!<br><br>Have grid_x and grid_y variables that specify where the grid is in world coordinates. You can then alter these to scroll around your world.<br><br>Have screen_dx and screen_dy constants that specify where the screen is, relative to the top-left of the collision grid.<br><br><img src="http://big10p.mysite.wanadoo-members.co.uk/shift_grid.png"><br><br>When sorting the sprites into sectors, subract grid_x and grid_y from the sprites x/y world coords. This'll give the sprites position within the grid.<br><br>To find the screen coords of the sprites (i.e. where to draw them), subract screen_dx and screen_dy from the sprites grid coords.<br><br><div class="quote"> Another question. The reason why 4 sectors needs to be checked all at once is because objects may overlap some sectors, right? <br></div>Right. <br><br></td></tr></table><br>
<a name="828054"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Drakim</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#5">[#5]</a></td></tr></table></td></tr><tr ><td class="posttext"> thanks big10p, that will be very useful.<br><br>One last question though.<br><br>I have a pretty big universe, often with very small objects, that often have massive collision parties in small areas (due to magnets pulling them into a small area).<br><br>This would obviously fit well with small grinds.<br><br>However, I have the odd occational big object, like a really big rock or a mothership.<br><br>How should I deal with this the most effectivly?<br><br>1. Make the grinds bigger.<br>2. Check more than 4 sectors at once?<br>3. Have really big objects ignore the grind system and check collisions against everything like the old system (since big objects are rare).<br><br>Which would you recommend? Or if you can think of a better method than listed here, then spit out. :D <br><br></td></tr></table><br>
<a name="828058"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >LarsG</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#6">[#6]</a></td></tr></table></td></tr><tr ><td class="posttext"> Are you using a collision layer with the tiles?<br>If that's the case, then you can also add the "big" sprites to the same (or a separate, if you wish) layer, just as you do with the tiles. <br><br></td></tr></table><br>
<a name="828073"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >big10p</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#7">[#7]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> I have a pretty big universe, often with very small objects, that often have massive collision parties in small areas (due to magnets pulling them into a small area).<br><br>This would obviously fit well with small grinds.<br><br>However, I have the odd occational big object, like a really big rock or a mothership. <br></div>Hmm. It sounds like your game isn't particularly well suited to shifted grid. It works best in games where sprites are <i>usually</i> quite well spaced apart. However, shifted grid may still be useful to you...<br><br><div class="quote"> How should I deal with this the most effectivly?<br><br>1. Make the grinds bigger.<br>2. Check more than 4 sectors at once?<br>3. Have really big objects ignore the grind system and check collisions against everything like the old system (since big objects are rare). <br></div>Well, if the magnetism causes loads of sprites to group together regularly, I'd definately avoid making the grids bigger.<br><br>Option 3 may be worth trying. Remeber that the grid sector size has to be twice the size of the largest sprite, so this could really kill performance considering you also have lots of smaller sprites grouped together, due to magnetism.<br><br>Another option is to break your big sprites up into smaller sprite tiles. In this case, make the sprite tiles as big as possible - i.e. just small enough to fit the collision grid limitations. <br><br></td></tr></table><br>
<a name="828075"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >tonyg</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#8">[#8]</a></td></tr></table></td></tr><tr ><td class="posttext"> If the sprites cluster together somewhat can't you have a large grid system which keeps track of how many sprites in each sector. Once that sector reaches a threshold it uses a smaller grid. Never done it and no idea if it works. In addition would <a href="/en/Community/posts.php?topic=71789#802537" target="_blank"> Leadwerk's Scene Graph </a> help at all? <br><br></td></tr></table><br>
<a name="bottom"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td align="right"><a href="http://monkeycoder.co.nz" target="_blank"><img src="/img/monkey2.svg" ></a> <a href="https://github.com/blitz-research" target="_blank"><img src="/img/github.svg" ></a> <a href="https://discord.gg/qJccbSp" target="_blank"><img src="/img/discord.svg" ></a></td></tr></table><br></div><br><table width="100%"><tr><td></body></html lang="en">
