<!DOCTYPE html><html lang="en" ><head ><title >if enemy can see player</title><meta name='viewport' content='width=device-width, initial-scale=0.66'><meta name='description' content='language:basic, target:desktop, category:game development'><link rel="styleSheet" href="../skins/granite/style.css" type="text/css"><style type="text/css">div.bbcode {padding: 8px;background: #E5E5E5;color: #000000;border: 1px dashed #B4B4BE;}</style></head><body ><table width=100% cellspacing=0 cellpadding=0><tr ><td class="menubarleft"></td><td class="menubar"><table cellspacing="0" cellpadding="0"><tr ><td >&nbsp;</td><td class="menuitemleft"></td><td class="menuitem"><a href="/" class="menuitem">News</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/forums.php" class="menuitem">Forums</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/codearcs.php" class="menuitem">Code</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/logs.php" class="menuitem">Logs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/gallery.php" class="menuitem">Gallery</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/sdkspecs.php" class="menuitem">Specs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/search.php" class="menuitem">Search</a></td><td class="menuitemright"></td></tr></table></td><td class="menubarright"></td></tr></table><div class="main"><h1 >if enemy can see player</h1><a href="forums.php" >BlitzMax Forums</a>/<a href="topics.php?forum=101" >BlitzMax Beginners Area</a>/<a href="#bottom" >if enemy can see player</a><br><br>
<a name="1156766"></a>

<a name="1156767"></a>

<a name="1156768"></a>

<a name="1156769"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >redmoth</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#1">[#1]</a></td></tr></table></td></tr><tr ><td class="posttext"> Hi.<br>I've started a simple overhead shooter.  But I want the enemies to shoot at the player depending if their angle is facing him.<br>What would be the best way and least resource intensive way to do this?<br><img src="http://3.bp.blogspot.com/-Jmh662QM1C4/UDtRIEqm3lI/AAAAAAAAAM0/CPwn-ftyU7s/s1600/topdown03b.png"><br><br>thanks<br><br><font class="tiny">Last edited 2012</font> <br><br></td></tr></table><br>
<a name="1156777"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >GfK</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#2">[#2]</a></td></tr></table></td></tr><tr ><td class="posttext"> I have some <a href="/codearcs.php?code=2597" target="_blank">line intersection</a> code that would probably do the job.  It's fast, too. <br><br></td></tr></table><br>
<a name="1156778"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Hotshot2005</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#3">[#3]</a></td></tr></table></td></tr><tr ><td class="posttext"> Look like METAL GEAR SOILD on NES :) <br><br></td></tr></table><br>
<a name="1156787"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >GaryV</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#4">[#4]</a></td></tr></table></td></tr><tr ><td class="posttext"> Nice looking GFX! <br><br></td></tr></table><br>
<a name="1156792"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >redmoth</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#5">[#5]</a></td></tr></table></td></tr><tr ><td class="posttext"> @GfK<br>I'm not great at reading code, but thanks I'll try and see if I can implement that code.<br><br>@Hotshot2005<br>Thanks, it doesn't play like it though, haha<br><br>@GaryV<br>Thanks, I'm not an artist but it's the best I can do. <br><br></td></tr></table><br>
<a name="1156828"></a>

<a name="1156829"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >redmoth</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#6">[#6]</a></td></tr></table></td></tr><tr ><td class="posttext"> I'm having trouble with this, this is what I have, but I can see it's wrong, but Im not sure how to fix it:  Basically, a basic cone of sight:<br><textarea class=codebox name="code" wrap=OFF readonly="true" rows="15" cols="80">


For Local i:Int = 0 To 255
  If player1.x &gt;= i*Cos(angle)+enemyX*tileSize  And  i*Cos(angle)+enemyX*tileSize+32
	If player1.y &gt;= i*Sin(angle)+enemyY*tileSize And i*Sin(angle)+enemyY*tileSize+32
		Print "You've been seen"
	End If

	End If
Next


</textarea><br><br><font class="tiny">Last edited 2012</font> <br><br></td></tr></table><br>
<a name="1156836"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >matibee</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#7">[#7]</a></td></tr></table></td></tr><tr ><td class="posttext"> Here's a cone of sight demo that should be fairly robust and easy to implement in your game..<br><br><textarea class=codebox name="code" wrap=OFF readonly="true" rows="15" cols="80">
SuperStrict 
Graphics 800, 600

' enemy view cone parameters
Local px:Int = 400			' position
Local py:Int = 300

Local pdir:Int = 90			' angular direction
Local viewAngle:Float = 10.0 	' viewing angle


While Not AppTerminate()
	
	cls
	
	SetColor ( 0, 0, 255 )
	DrawLine ( px, py, px + (Cos(pdir + viewAngle / 2) * 400), py + (Sin(pdir + viewAngle / 2) * 400) )
	DrawLine ( px, py, px + (Cos(pdir - viewAngle / 2) * 400), py + (Sin(pdir - viewAngle / 2) * 400) )
	DrawOval ( px - 3, py - 3, 6, 6 )
	
	If ( PointInViewAngle( MouseX(), MouseY(), px, py, pdir, viewAngle ) )
		SetColor( 255, 0, 0 )
	Else 
		SetColor( 255,255,255 )
	End If 
	
	DrawOval ( MouseX() - 4, MouseY() - 4, 8, 8 )
	
	SetColor(255,255,255)
	DrawText( "view angle     : " + viewAngle + " degrees", 0, 0 )
	DrawText( "view direction : " + pdir + " degrees", 0, 16 )
	
	Flip 
	
	If ( KeyDown( key_left ) ) pdir :+ 2
	If ( KeyDown( key_right ) ) pdir :- 2
	
	If ( KeyDown( key_Up ) ) viewAngle = Min( viewAngle + 2, 120 )
	If ( KeyDown( Key_Down ) ) viewangle = Max( 5, viewAngle - 2 )
	
	If ( KeyDown( key_a ) ) px :- 2
	If ( KeyDown( key_d ) ) pX :+ 2
	If ( KeyDown( key_w ) ) py :- 2
	If ( KeyDown( key_s ) ) py :+ 2
	
Wend 
'
'	PointInViewAngle
'
'	Returns True if point (x, y) lies inside (or on the edges of) a 2d cone at position ( coneX, coneY )
'	at an angle of coneDir, with a view angle of coneAngle 
'	
Function PointInViewAngle:Int ( x:Float, y:Float, coneX:Float, coneY:Float, coneDir:Float, coneAngle:Float )

	Local minAngle:Float = clampAngle( coneDir - coneAngle / 2 )
	Local maxAngle:Float = clampAngle( coneDir + coneAngle / 2 )
	
	Local angle:Float = clampAngle( ATan2( y - coney, x - conex ) )
	
	If ( minAngle &gt; maxAngle )
		If (( angle &gt;=0 And angle &lt;= maxAngle ) Or ( angle &gt;= minAngle And angle &lt;= 360 )) Return True 
	End If 
	
	Return ((angle &gt;= minAngle) And (angle &lt;= maxAngle))
	
End Function 
'
'	ClampAngle
'
'	Limits a floating point angle to the range 360 &gt; a &gt; 0
'
Function clampAngle:Float( a:Float )
	While a &lt; 0
		a :+ 360
	Wend 
	While a &gt; 360
		a :- 360
	Wend 
	Return a
End Function 
</textarea> <br><br></td></tr></table><br>
<a name="1156841"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >matibee</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#8">[#8]</a></td></tr></table></td></tr><tr ><td class="posttext"> Actually I've just realised there's some redundant code in the PointInViewAngle function.  Since 'angle' is clamped to 0 to 360<br><br><pre class=code>
If ( minAngle &gt; maxAngle )
    If (( angle &gt;=0 And angle &lt;= maxAngle ) Or ( angle &gt;= minAngle And angle &lt;= 360 )) Return True 
End If 
</pre><br><br>can just be..<br><pre class=code>
If ( minAngle &gt; maxAngle )
    If ( angle &lt;= maxAngle Or angle &gt;= minAngle ) Return True 
End If 
</pre> <br><br></td></tr></table><br>
<a name="1156875"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >redmoth</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#9">[#9]</a></td></tr></table></td></tr><tr ><td class="posttext"> @matibee<br><br>Thanks, that's exactly what I was looking for and I've implemented a version of it in my code.  You have saved me life. <br><br></td></tr></table><br>
<a name="1156910"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >matibee</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#10">[#10]</a></td></tr></table></td></tr><tr ><td class="posttext"> You're welcome :) <br><br></td></tr></table><br>
<a name="1157685"></a>

<a name="1157686"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >redmoth</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#11">[#11]</a></td></tr></table></td></tr><tr ><td class="posttext"> I'm wondering if I can get any more help with my mathematics.<br><br>I've got square roots coming out of my ears.<br><br>Now, that I can detect a player, I want to check against my 2d array map, to see if there is a solid block in the way between the player and the enemy which would prevent him seeing the player.<br><br>the tileMap array stores the an int which is the type of tile, anything greater than 27 is a solid.( tileMap[x,y])<br><br>I've had many ideas here is one in pseudocode that didn't work.<br><br><br><pre class=code>
'The distance between the enemy to the player
distance = sqr(player1.x-enemy.x)*(player1.x-enemy.x) + (player1.y-enemy.y)*(player1.y-enemy.y) 

For(i = 0 to distance)
   if(tileMap[enemy.x+i,enemy.y+i] &gt; 27
      print "view of player blocked"
      exit loop

   end if

next
</pre><br><br>UPDATE: I've realised that this code is rubbish and doesn't take into account the direction/angle the enemy is facing in<br><br><font class="tiny">Last edited 2012</font> <br><br></td></tr></table><br>
<a name="1157698"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >matibee</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#12">[#12]</a></td></tr></table></td></tr><tr ><td class="posttext"> It would be useful to see the rest of your code.  Can I assume your player and enemy positions are floating point values, where their integer positions match the tile array...<br><br>ie Enemy( x1.444, y3.222) maps to tileMap[ 1, 3 ]<br><br>??<br><br>If that's the case you can probably use the direction vector ( vx = cos(angle), vy = sin(angle ) )  and incrementally add it to the enemy position<br><br><pre class=code>
Function VisibilityTest( enemy, distance-to-player )
checklength = 1
  vx = cos( enemy.angle )
  vy = sin( enemy.angle )
  while checklength &lt; distance-to-player
   if ( tilemap[ enemy.x + (checklength * vx), enemy.y + (checklength * vy) ] &gt; 27 )
       return blocked
   end if 
   checklength :+ 1
  wend
  return not-blocked
end function 
</pre><br><br>Something like that anyway.  If you can post code I can write and test in it would really help. <br><br></td></tr></table><br>
<a name="1157699"></a>

<a name="1157700"></a>

<a name="1157701"></a>

<a name="1157703"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >redmoth</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#13">[#13]</a></td></tr></table></td></tr><tr ><td class="posttext"> my other similar idea that just came but didn't work was<br><br>(by the way, both of these are in the excellent PointInViewAngle function)<br><br><pre class=code>
       for(float i= 0 to distance) {
           if(tileMap[(x+(i*cos(angle)),y+(i*sin(angle))) &gt; 27]
             print "view of player blocked"
             exit loop
           end if
       next
           
           
         
</pre><br><br>UPDATE: this only really works if the enemy is facing to the right, <br><br><font class="tiny">Last edited 2012</font><br><br><font class="tiny">Last edited 2012</font><br><br><font class="tiny">Last edited 2012</font> <br><br></td></tr></table><br>
<a name="1157752"></a>

<a name="1157753"></a>

<a name="1157756"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >matibee</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#14">[#14]</a></td></tr></table></td></tr><tr ><td class="posttext"> Here's an update version of my code above, with an added line of sight test..<br><br><br><textarea class=codebox name="code" wrap=OFF readonly="true" rows="15" cols="80">
SuperStrict 
Graphics 800, 600

' enemy view cone parameters
Local px:Int = 400			' position
Local py:Int = 300

Local pdir:Int = 90			' angular direction
Local viewAngle:Float = 10.0 	' viewing angle

Global map:Int[40,30]

For Local t:Int = 10 To 20
	map[t, 12] = 1
	map[t, 22] = 1
Next 

'
'	LOS  (Line of sight)
'
'  Checks if the centre of one tile can 'see' the centre of another tile
'
'
Function LOS:Int ( targetX:Float, targetY:Float, px:Float, py:Float )
	
	Local x0:Int = (targetX +0.5) / 20.0
	Local y0:Int = (targetY +0.5) / 20.0
	
	Local x1:Int = (px +0.5) / 20.0
	Local y1:Int = (py +0.5) / 20.0
	
	Local sx:Int, sy:Int   

	Local dx:Int = Abs(x1-x0)
  	Local dy:Int = Abs(y1-y0) 
   
	If x0 &lt; x1 Then 
		sx = 1 
	Else 
		sx = -1
	End If 
	
   	If y0 &lt; y1 Then 
		sy = 1 
	Else 
		sy = -1
	End If 
   
	Local err:Int = dx-dy
 
   	Repeat 
		If map[ x0, y0 ]
			Return False 
		End If 

     	If x0 = x1 And y0 = y1 
			Return True 
		End If 
		
     	Local e2:int = 2*err
     	If e2 &gt; -dy Then 
       		err :- dy
       		x0 :+ sx
     	End If
     	If e2 &lt; dx Then 
       		err :+ dx
       		y0 :+ sy 
     	End If
   Forever 
	
End Function 

Function DrawLOS ( targetX:Float, targetY:Float, px:Float, py:Float )
	
	Local x0:Int = (targetX +0.5) / 20.0
	Local y0:Int = (targetY +0.5) / 20.0
	
	Local x1:Int = (px +0.5) / 20.0
	Local y1:Int = (py +0.5) / 20.0
	
	Local sx:Int, sy:Int   

	Local dx:Int = Abs(x1-x0)
  	Local dy:Int = Abs(y1-y0) 
   
	If x0 &lt; x1 Then 
		sx = 1 
	Else 
		sx = -1
	End If 
	
   	If y0 &lt; y1 Then 
		sy = 1 
	Else 
		sy = -1
	End If 
   
	Local err:Int = dx-dy
 
   	Repeat 
		DrawRect( X0 * 20, y0 * 20, 20, 20 )

     	If x0 = x1 And y0 = y1 
			DrawRect( X0 * 20, y0 * 20, 20, 20 )
			Return
		End If 
		
     	Local e2:Int = 2*err
     	If e2 &gt; -dy Then 
       		err :- dy
       		x0 :+ sx
     	End If
     	If e2 &lt; dx Then 
       		err :+ dx
       		y0 :+ sy 
     	End If
   Forever 
	
End Function 


While Not AppTerminate()
	
	Cls
	
	SetColor ( 0,64,0 )
	For Local xm:Int = 0 To 39
		For Local ym:Int = 0 To 29
			If ( map[xm, ym] )
				DrawRect( xm * 20, ym * 20, 20, 20 )
			End If 
		Next 
	Next 
	
	SetColor( 64,64,64 )
	DrawLOS( px, py, MouseX(), MouseY() )
	
	SetColor( 0,128,0 )
	For Local i:Int = 0 To 800 Step 20
		DrawLine( i, 0, i, 800 )
		DrawLine( 0, i, 800, i )
	Next 
	

	
	SetColor ( 0, 0, 255 )
	DrawLine ( px, py, px + (Cos(pdir + viewAngle / 2) * 400), py + (Sin(pdir + viewAngle / 2) * 400) )
	DrawLine ( px, py, px + (Cos(pdir - viewAngle / 2) * 400), py + (Sin(pdir - viewAngle / 2) * 400) )
	DrawOval ( px - 3, py - 3, 6, 6 )
	
	If ( PointInViewAngle( MouseX(), MouseY(), px, py, pdir, viewAngle ) And LOS( MouseX(), MouseY(), px, py )  )
		SetColor( 255, 0, 0 )
	Else 
		SetColor( 255,255,255 )
	End If 
	
	DrawOval ( MouseX() - 4, MouseY() - 4, 8, 8 )
	
	SetColor(255,255,255)
	DrawText( "view angle     : " + viewAngle + " degrees", 0, 0 )
	DrawText( "view direction : " + pdir + " degrees", 0, 16 )
	
	Flip 
	
	If ( KeyDown( key_left ) ) pdir :+ 2
	If ( KeyDown( key_right ) ) pdir :- 2
	
	If ( KeyDown( key_Up ) ) viewAngle = Min( viewAngle + 2, 120 )
	If ( KeyDown( Key_Down ) ) viewangle = Max( 5, viewAngle - 2 )
	
	If ( KeyDown( key_a ) ) px :- 2
	If ( KeyDown( key_d ) ) pX :+ 2
	If ( KeyDown( key_w ) ) py :- 2
	If ( KeyDown( key_s ) ) py :+ 2
	
Wend 
'
'	PointInViewAngle
'
'	Returns True if point (x, y) lies inside (or on the edges of) a 2d cone at position ( coneX, coneY )
'	at an angle of coneDir, with a view angle of coneAngle 
'	
Function PointInViewAngle:Int ( x:Float, y:Float, coneX:Float, coneY:Float, coneDir:Float, coneAngle:Float )

	Local minAngle:Float = clampAngle( coneDir - coneAngle / 2 )
	Local maxAngle:Float = clampAngle( coneDir + coneAngle / 2 )
	
	Local angle:Float = clampAngle( ATan2( y - coney, x - conex ) )
	
	If ( minAngle &gt; maxAngle )
		If ( angle &lt;= maxAngle Or angle &gt;= minAngle ) Return True 
	End If 
	
	Return ((angle &gt;= minAngle) And (angle &lt;= maxAngle))
	
End Function 
'
'	ClampAngle
'
'	Limits a floating point angle to the range 360 &gt; a &gt; 0
'
Function clampAngle:Float( a:Float )
	While a &lt; 0
		a :+ 360
	Wend 
	While a &gt; 360
		a :- 360
	Wend 
	Return a
End Function 
</textarea><br><br>This only takes the centre of the enemy and player tiles into account though, but it should be close enough.<br><br>It uses an implementation of Bresenhams line drawing algorithm from here: <br><a href="http://en.wikipedia.org/wiki/Bresenham%27s_line_algorithm" target="_blank">http://en.wikipedia.org/wiki/Bresenham%27s_line_algorithm</a><br><br>You'll still have issues where it can 'see through' corners..<br><br><pre class=code>
[*][.][.][.]
[.][\][X][X]
[.][X][\][.]
[.][X][.][*]
</pre><br><br>[*] can 'see' [*] even though there are walls [X] forming a corner between them.<br><br>I'm afraid I'm too busy to help much more atm. :)<br><br>Edit -- added line of sight drawing code...<br><br><font class="tiny">Last edited 2012</font><br><br><font class="tiny">Last edited 2012</font> <br><br></td></tr></table><br>
<a name="bottom"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td align="right"><a href="http://monkeycoder.co.nz" target="_blank"><img src="/img/monkey2.svg" ></a> <a href="https://github.com/blitz-research" target="_blank"><img src="/img/github.svg" ></a> <a href="https://discord.gg/qJccbSp" target="_blank"><img src="/img/discord.svg" ></a></td></tr></table><br></div><br><table width="100%"><tr><td></body></html lang="en">
