<!DOCTYPE html><html lang="en" ><head ><title >Is this a mem leak?</title><meta name='viewport' content='width=device-width, initial-scale=0.66'><meta name='description' content='language:basic, target:desktop, category:game development'><link rel="styleSheet" href="../skins/granite/style.css" type="text/css"><style type="text/css">div.bbcode {padding: 8px;background: #E5E5E5;color: #000000;border: 1px dashed #B4B4BE;}</style></head><body ><table width=100% cellspacing=0 cellpadding=0><tr ><td class="menubarleft"></td><td class="menubar"><table cellspacing="0" cellpadding="0"><tr ><td >&nbsp;</td><td class="menuitemleft"></td><td class="menuitem"><a href="/" class="menuitem">News</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/forums.php" class="menuitem">Forums</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/codearcs.php" class="menuitem">Code</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/logs.php" class="menuitem">Logs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/gallery.php" class="menuitem">Gallery</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/sdkspecs.php" class="menuitem">Specs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/search.php" class="menuitem">Search</a></td><td class="menuitemright"></td></tr></table></td><td class="menubarright"></td></tr></table><div class="main"><h1 >Is this a mem leak?</h1><a href="forums.php" >BlitzMax Forums</a>/<a href="topics.php?forum=101" >BlitzMax Beginners Area</a>/<a href="#bottom" >Is this a mem leak?</a><br><br>
<a name="720805"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >SculptureOfSoul</td><td align="right"><font class=tiny>(Posted 2006)</font>&nbsp;<a href="#1">[#1]</a></td></tr></table></td></tr><tr ><td class="posttext"> Okay, is the following a mem leak?<br><br><pre class=code>
Socket.Send( SomeString.ToCString, SomeString.length )
</pre><br><br>a temporary byte pointer is being created and passed to the function. <br><br>I'm assuming the pointer is cleaned up after the function call exits since it falls out of scope. <br><br></td></tr></table><br>
<a name="720825"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Azathoth</td><td align="right"><font class=tiny>(Posted 2006)</font>&nbsp;<a href="#2">[#2]</a></td></tr></table></td></tr><tr ><td class="posttext"> ToCString is a method and the returned pointer needs to be freed using MemFree <br><br></td></tr></table><br>
<a name="720833"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >SculptureOfSoul</td><td align="right"><font class=tiny>(Posted 2006)</font>&nbsp;<a href="#3">[#3]</a></td></tr></table></td></tr><tr ><td class="posttext"> So doing something like this, that creates a temporary pointer that is passed to a function that is outside of my control is definitely a mem-leak then?<br><br>Bummer. Oh well, it's an easy enough work around. <br><br></td></tr></table><br>
<a name="720835"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >SculptureOfSoul</td><td align="right"><font class=tiny>(Posted 2006)</font>&nbsp;<a href="#4">[#4]</a></td></tr></table></td></tr><tr ><td class="posttext"> ... <br><br></td></tr></table><br>
<a name="720836"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >FlameDuck</td><td align="right"><font class=tiny>(Posted 2006)</font>&nbsp;<a href="#5">[#5]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> So doing something like this, that creates a temporary pointer that is passed to a function that is outside of my control is definitely a mem-leak then? <br></div>Itdepends on what the pointer is pointing to. <br><br></td></tr></table><br>
<a name="720837"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >SculptureOfSoul</td><td align="right"><font class=tiny>(Posted 2006)</font>&nbsp;<a href="#6">[#6]</a></td></tr></table></td></tr><tr ><td class="posttext"> .ToCString() doesn't simply pass a pointer to the first byte of the string though does it?<br><br>I thought it created a new byte array initialized with the data from the string + a null character, and then returned the pointer to that. If this is the case, how would I ever be able to free this new temporary byte array? <br><br></td></tr></table><br>
<a name="720859"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Azathoth</td><td align="right"><font class=tiny>(Posted 2006)</font>&nbsp;<a href="#7">[#7]</a></td></tr></table></td></tr><tr ><td class="posttext"> Once its sent why not just free it?<br><br>Something like:<br><pre class=code>
local SomeCString:byte ptr=SomeString.ToCString()
Socket.Send( SomeCString, SomeString.length )
MemFree(SomeCString)
</pre> <br><br></td></tr></table><br>
<a name="720870"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >SculptureOfSoul</td><td align="right"><font class=tiny>(Posted 2006)</font>&nbsp;<a href="#8">[#8]</a></td></tr></table></td></tr><tr ><td class="posttext"> Azathoth: Yeah. That's basically the "workaround" I planned on using if it turned out that it was indeed a leak. <br><br>And it turned out it was - and the method you mention Az does work. I realized a bigger issue though that eluded me before - ToCString() essentially makes a copy of the string - and in this case I'd much rather just have an actual pointer to the string itself (although I can understand why BMax doesn't do it this way). <br>Copying large amounts of text to send is going to get expensive.<br><br>I guess I'll have to look at the source for TString and see if I can extend it and make it return a byte ptr to the internal char array. <br><br></td></tr></table><br>
<a name="720886"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Azathoth</td><td align="right"><font class=tiny>(Posted 2006)</font>&nbsp;<a href="#9">[#9]</a></td></tr></table></td></tr><tr ><td class="posttext"> BMax uses 16 bit unicode strings though, so ToCString not only makes a copy but converts it to 8 bit. <br><br></td></tr></table><br>
<a name="720909"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >SculptureOfSoul</td><td align="right"><font class=tiny>(Posted 2006)</font>&nbsp;<a href="#10">[#10]</a></td></tr></table></td></tr><tr ><td class="posttext"> Hmm, looks like I might have to whip up my own string class using arrays and slicing.  Might as well implement ring buffers while I'm at it ::grumble:: <br><br></td></tr></table><br>
<a name="720962"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >FlameDuck</td><td align="right"><font class=tiny>(Posted 2006)</font>&nbsp;<a href="#11">[#11]</a></td></tr></table></td></tr><tr ><td class="posttext"> No. "CStrings" are garbage collected. It says so in Marks worklog somewhere. <br><br></td></tr></table><br>
<a name="720970"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Azathoth</td><td align="right"><font class=tiny>(Posted 2006)</font>&nbsp;<a href="#12">[#12]</a></td></tr></table></td></tr><tr ><td class="posttext"> I thought that was only if you used the $z thing?<br><br>The Description for ToCString() says<br><div class="quote"> Converts a string to a null terminated sequence of 8 bit bytes. The returned memory must be freed with a call to MemFree. <br></div> <br><br></td></tr></table><br>
<a name="721149"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >SculptureOfSoul</td><td align="right"><font class=tiny>(Posted 2006)</font>&nbsp;<a href="#13">[#13]</a></td></tr></table></td></tr><tr ><td class="posttext"> Well, in Bmax 1.18 (I think that's the version I'm running at work - gotta update ), they aren't being garbage collected. Without MemFree() the memory was disappearing in all of my tests. <br><br></td></tr></table><br>
<a name="721216"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Yan</td><td align="right"><font class=tiny>(Posted 2006)</font>&nbsp;<a href="#14">[#14]</a></td></tr></table></td></tr><tr ><td class="posttext"> CStrings used to be collected before the automatic collection went in (V1.12?), now they live outside of the GC's control and have to be managed manually. <br><br></td></tr></table><br>
<a name="721235"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Brucey</td><td align="right"><font class=tiny>(Posted 2006)</font>&nbsp;<a href="#15">[#15]</a></td></tr></table></td></tr><tr ><td class="posttext"> Yep. I remember adding MemFree()'s to all my mods because ToCString() wasn't freeing up its memory.<br>So you end up with 3 lines of code per ToCString - as per the example code snippet by Azathoth above. :-) <br><br></td></tr></table><br>
<a name="721363"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Dreamora</td><td align="right"><font class=tiny>(Posted 2006)</font>&nbsp;<a href="#16">[#16]</a></td></tr></table></td></tr><tr ><td class="posttext"> If you want to have managed CStrings (to yan and the rest), there is $z and $w which does manage it through the GC.<br><br>Depending on situation this one is enough. But if you need to send the cstring often, it isn't a usefully solution as the cstring is created on every call again which takes its time (mem alloc, setting data, cleanup) <br><br></td></tr></table><br>
<a name="721367"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >rdodson41</td><td align="right"><font class=tiny>(Posted 2006)</font>&nbsp;<a href="#17">[#17]</a></td></tr></table></td></tr><tr ><td class="posttext"> Local stream:SocketStream = CreateSocketStream(socket)<br>stream.WriteString(some_string) <br><br></td></tr></table><br>
<a name="721428"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Yan</td><td align="right"><font class=tiny>(Posted 2006)</font>&nbsp;<a href="#18">[#18]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> If you want to have managed CStrings (to yan and the rest) <br></div>What's the weather like in Dreamoraland at the moment? <br><br></td></tr></table><br>
<a name="721530"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >SculptureOfSoul</td><td align="right"><font class=tiny>(Posted 2006)</font>&nbsp;<a href="#19">[#19]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> Local stream:SocketStream = CreateSocketStream(socket)<br>stream.WriteString(some_string)  <br></div><br><br>surely this will create a Cstring and send it as well? The underlying socket representation requires a pointer - and I can't imagine the string type giving out a pointer to it's internals which could allow the string to be corrupted.<br><br>Maybe someone can answer this and save me from looking through the source (of which the C++ stuff usually goes over my head ;) <br><br></td></tr></table><br>
<a name="721535"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >SculptureOfSoul</td><td align="right"><font class=tiny>(Posted 2006)</font>&nbsp;<a href="#20">[#20]</a></td></tr></table></td></tr><tr ><td class="posttext"> Well, just looked up TStream.WriteString.<br><br>It simply creates a new variable, calls String.ToCString, and then memfree's the temporary byte pointer. <br><br></td></tr></table><br>
<a name="722019"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >rdodson41</td><td align="right"><font class=tiny>(Posted 2006)</font>&nbsp;<a href="#21">[#21]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> <br>It simply creates a new variable, calls String.ToCString, and then memfree's the temporary byte pointer. <br> <br></div><br>Thats why you use a stream and WriteString, it handles memory management for you. <br><br></td></tr></table><br>
<a name="bottom"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td align="right"><a href="http://monkeycoder.co.nz" target="_blank"><img src="/img/monkey2.svg" ></a> <a href="https://github.com/blitz-research" target="_blank"><img src="/img/github.svg" ></a> <a href="https://discord.gg/qJccbSp" target="_blank"><img src="/img/discord.svg" ></a></td></tr></table><br></div><br><table width="100%"><tr><td></body></html lang="en">
