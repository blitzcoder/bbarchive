<!DOCTYPE html><html lang="en" ><head ><title >Fast grabimage</title><meta name='viewport' content='width=device-width, initial-scale=0.66'><meta name='description' content='language:basic, target:desktop, category:game development'><link rel="styleSheet" href="../skins/granite/style.css" type="text/css"><style type="text/css">div.bbcode {padding: 8px;background: #E5E5E5;color: #000000;border: 1px dashed #B4B4BE;}</style></head><body ><table width=100% cellspacing=0 cellpadding=0><tr ><td class="menubarleft"></td><td class="menubar"><table cellspacing="0" cellpadding="0"><tr ><td >&nbsp;</td><td class="menuitemleft"></td><td class="menuitem"><a href="/" class="menuitem">News</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/forums.php" class="menuitem">Forums</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/codearcs.php" class="menuitem">Code</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/logs.php" class="menuitem">Logs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/gallery.php" class="menuitem">Gallery</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/sdkspecs.php" class="menuitem">Specs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/search.php" class="menuitem">Search</a></td><td class="menuitemright"></td></tr></table></td><td class="menubarright"></td></tr></table><div class="main"><h1 >Fast grabimage</h1><a href="forums.php" >BlitzMax Forums</a>/<a href="topics.php?forum=101" >BlitzMax Beginners Area</a>/<a href="#bottom" >Fast grabimage</a><br><br>
<a name="1316647"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Juiceter</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#1">[#1]</a></td></tr></table></td></tr><tr ><td class="posttext"> Hey,<br><br>has anyone written a standalone function that replaces the very slow native grabimage function? Blitzmax would be all the much better for it if this command was optimised. <br><br>I've seen a few snippets of code around that state they speed this command up by a lot but it's never explained how to run it.<br><br>Thanks for any pointers anyone may be able to provide. <br><br></td></tr></table><br>
<a name="1316899"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Juiceter</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#2">[#2]</a></td></tr></table></td></tr><tr ><td class="posttext"> I've found Grabimage to be very useful for picking up bits of screen that don't change between frames.<br><br>OK, it isn't as fast as redrawing everything, but it IS convenient in terms of code (what you gain doing something one way you loose in another way!). It's a pity that the default command is so slow (100's of ms rather than 10s.) <br><br></td></tr></table><br>
<a name="1316946"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Kryzon</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#3">[#3]</a></td></tr></table></td></tr><tr ><td class="posttext"> Hi. If you follow the source on what happens when you call GrabImage you get to two different implementations, one for OpenGL and another for D3D 9, and you can see what it's being used to grab the screen pixels:<br><br>- <a href="https://github.com/blitz-research/blitzmax/blob/master/mod/brl.mod/glmax2d.mod/glmax2d.bmx#L507" target="_blank">https://github.com/blitz-research/blitzmax/blob/master/mod/brl.mod/glmax2d.mod/glmax2d.bmx#L507</a><br><br>- <a href="https://github.com/blitz-research/blitzmax/blob/master/mod/brl.mod/d3d9max2d.mod/d3d9max2d.bmx#L592" target="_blank">https://github.com/blitz-research/blitzmax/blob/master/mod/brl.mod/d3d9max2d.mod/d3d9max2d.bmx#L592</a><br><br>It's slow because the screen content resides in video memory, so transferring data from there to system memory (RAM) takes a while.<br>One of the ways to help with this is to make it asynchronous: you 'issue' a screen read, and while it happens you do other things. Then when you are going to use that data it's already been transferred, so there's no delay.<br><br>But having to read from the screen is usually an extreme method, there must be a simpler way to do what you want. Why do you need to read the screen at all? <br><br></td></tr></table><br>
<a name="1317030"></a>

<a name="1317033"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Juiceter</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#4">[#4]</a></td></tr></table></td></tr><tr ><td class="posttext"> Thanks for your comment!<br><br>I just find it useful sometimes. I'm writing a strategy game where, when scrolling, a lot of the screen stays the same, so instead of rendering all the tiles again, it is easier to grab the proportion of the screen map  that doesn't change and move it over 16 pixels using grabimage, then render the 12-or so new tiles that come into view.<br><br>I have heard that someone wrote a grabimage routine which is up to 16 times faster. It's detailed in the forum somewhere but I'm not sure how to use it.<br><br>If it were this good I'm not sure why Mr Sibly didn't include it in his source instead of the slow grabimage implementation we've got. I find it can be immensely useful sometimes. <br><br></td></tr></table><br>
<a name="1317031"></a>

<a name="1317032"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Juiceter</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#5">[#5]</a></td></tr></table></td></tr><tr ><td class="posttext"> It's a turn based strategy game btw, not real-time. Still, if someone has made a faster implementation then why not use it? Speed is always a good thing if you can get it!<br><br>I'm assuming that the faster version is less "safe". <br><br></td></tr></table><br>
<a name="1317048"></a>

<a name="1317049"></a>

<a name="1317050"></a>

<a name="1317051"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Kryzon</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#6">[#6]</a></td></tr></table></td></tr><tr ><td class="posttext"> Yeah, a faster version requires a certain feature to be available in the graphics card (in GL it's the <a href="https://www.opengl.org/wiki/Pixel_Buffer_Object" target="_blank">Pixel Buffer Object</a>), and the different way of using it (asynchronous, so usually delayed by one frame).<br>By design Max2D is supposed to be simple to use, so the current way is immediate and more compatible, at the cost of performance.<br><br>- - - - -<br>About the scrolling, I think redrawing the entire screen--or at least just the region that changed--is the simplest way and you should try it first, to see if there's the need for any optimisation. What you're looking for is a comfortable CPU usage at 60 FPS.<br><br>If you do think that recycling parts of the screen are needed since the brute-force screen rendering is too slow, instead of glReadPixels (used in GrabImage), you can try <a href="https://www.opengl.org/sdk/docs/man2/xhtml/glCopyPixels.xml" target="_blank">glCopyPixels</a> (copies from one region of the screen to another at the current raster position set by <a href="https://www.opengl.org/sdk/docs/man2/xhtml/glRasterPos.xml" target="_blank">glRasterPos</a>).<br>For D3D9 I think the <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/bb174471(v=vs.85).aspx" target="_blank">StretchRect</a> function between a render-target surface onto the backbuffer surface is the closest equivalent. There's some example code of D3D9 render targets here: <a href="http://www.blitzbasic.com/Community/posts.php?topic=104977#1275668" target="_blank">http://www.blitzbasic.com/Community/posts.php?topic=104977#1275668</a> <br><br></td></tr></table><br>
<a name="1317106"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Juiceter</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#7">[#7]</a></td></tr></table></td></tr><tr ><td class="posttext"> That's very kind of you Kryzon, usfeul infor there. Thank you, and it's nice to see the blitz community is still so active (it deserves to be, it's a great language)!<br><br>I used to use blitz on the Amiga, then Blitz 2D on the PC (with its backbufferers etc.). Now I'm converting everything to blitzmax.<br><br>I'm assuming, though, that most if not all gfx cards made at least after 2010 would have such a feature due to "standards" (ha - I remember when so-called PC standards wern't ;-)). <br><br></td></tr></table><br>
<a name="bottom"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td align="right"><a href="http://monkeycoder.co.nz" target="_blank"><img src="/img/monkey2.svg" ></a> <a href="https://github.com/blitz-research" target="_blank"><img src="/img/github.svg" ></a> <a href="https://discord.gg/qJccbSp" target="_blank"><img src="/img/discord.svg" ></a></td></tr></table><br></div><br><table width="100%"><tr><td></body></html lang="en">
