<!DOCTYPE html><html lang="en" ><head ><title >Box2d 2.3.0 rev(249) Module - Goes Open Source</title><meta name='viewport' content='width=device-width, initial-scale=0.66'><meta name='description' content='language:basic, target:desktop, category:game development'><link rel="styleSheet" href="../skins/granite/style.css" type="text/css"><style type="text/css">div.bbcode {padding: 8px;background: #E5E5E5;color: #000000;border: 1px dashed #B4B4BE;}</style></head><body ><table width=100% cellspacing=0 cellpadding=0><tr ><td class="menubarleft"></td><td class="menubar"><table cellspacing="0" cellpadding="0"><tr ><td >&nbsp;</td><td class="menuitemleft"></td><td class="menuitem"><a href="/" class="menuitem">News</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/forums.php" class="menuitem">Forums</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/codearcs.php" class="menuitem">Code</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/logs.php" class="menuitem">Logs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/gallery.php" class="menuitem">Gallery</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/sdkspecs.php" class="menuitem">Specs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/search.php" class="menuitem">Search</a></td><td class="menuitemright"></td></tr></table></td><td class="menubarright"></td></tr></table><div class="main"><h1 >Box2d 2.3.0 rev(249) Module - Goes Open Source</h1><a href="forums.php" >BlitzMax Forums</a>/<a href="topics.php?forum=102" >BlitzMax Programming</a>/<a href="#bottom" >Box2d 2.3.0 rev(249) Module - Goes Open Source</a><br><br>
<a name="1138772"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Armitage 1982</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#1">[#1]</a></td></tr></table></td></tr><tr ><td class="posttext"> Everything is explained on the main page here : <a href="http://code.google.com/p/arme-mod/" target="_blank">http://code.google.com/p/arme-mod/</a><br><br>I'm trying to update the Box2D module of Brucey and while I'm currently able to run a few testbed examples I'm stuck when it comes to use BBRETAIN on the C++ side.<br><br>You could also easily say that's I'm a bit lost in the way Fixture and Shape must be Initialized and returned to BlitzMax.<br><br><b>So if any of you have good knowledge in C++ and wrapping libraries in general, I'd love to get some help on this.</b><br><br>There is really advantages to use the last version of Box2d (through I can live without it...) and since the project is Open Source maybe we could sort problems more fast this way.<br><br>Thanks ;) <br><br></td></tr></table><br>
<a name="1148420"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Matt Merkulov</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#2">[#2]</a></td></tr></table></td></tr><tr ><td class="posttext"> rev 249 doesn't compile!<br>compiler said there are errors in glue.cpp<br>:( <br><br></td></tr></table><br>
<a name="1148425"></a>

<a name="1148426"></a>

<a name="1148427"></a>

<a name="1148437"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Matt Merkulov</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#3">[#3]</a></td></tr></table></td></tr><tr ><td class="posttext"> solved<br>installed latest MinGW version and it compiled<br><br><font class="tiny">Last edited 2012</font> <br><br></td></tr></table><br>
<a name="1148607"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Captain Wicker (crazy hillbilly)</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#4">[#4]</a></td></tr></table></td></tr><tr ><td class="posttext"> @arm42:<br>What can it do? <br><br></td></tr></table><br>
<a name="1148726"></a>

<a name="1148727"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Armitage 1982</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#5">[#5]</a></td></tr></table></td></tr><tr ><td class="posttext"> Sorry for not answering before I didn't spot the topic ^^<br><br>Don't expect to use this wrap, it's not complete at all!<br>I was just searching a bit of help to fix a problem I had while trying to port the last version of the C++ Box2D library.<br><br>Since I didn't get any clues on this I just drop the idea for now...<br><br>Just stick to the old BaH.Box2D if you want to use box2d with BlitzMax.<br>Sorry for any inconveniences.<br><br><font class="tiny">Last edited 2012</font> <br><br></td></tr></table><br>
<a name="1157276"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Armitage 1982</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#6">[#6]</a></td></tr></table></td></tr><tr ><td class="posttext"> Again I spent the whole night trying to find my mistake.<br>I did not make it! pfff<br><br>There is really nobody who could give me a hand on this problem? <br><br></td></tr></table><br>
<a name="1157289"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >AdamRedwoods</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#7">[#7]</a></td></tr></table></td></tr><tr ><td class="posttext"> hmm. it seems i cannot even compile it, so i'll have to upgrade mingw first. <br><br></td></tr></table><br>
<a name="1157403"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Armitage 1982</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#8">[#8]</a></td></tr></table></td></tr><tr ><td class="posttext"> That's strange...<br>Maybe it's due to the last Mingw update mark recommend while using one of the few last BlitzMax version. <br><br></td></tr></table><br>
<a name="1157574"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >col</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#9">[#9]</a></td></tr></table></td></tr><tr ><td class="posttext"> Hiya,<br><br>Compiles here ok with<br>BMax 1.48 and MinGW gcc 4.6.2, Win7x64. <br><br></td></tr></table><br>
<a name="1157583"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >AdamRedwoods</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#10">[#10]</a></td></tr></table></td></tr><tr ><td class="posttext"> yup, i'm having utf-8/bom problems. not sure how to strip this stuff out.<br>i'm on gcc 3.4.5, not sure if the later version overcome these issues, but i'll upgrade it anyways and try that. <br><br></td></tr></table><br>
<a name="1157587"></a>

<a name="1157588"></a>

<a name="1157589"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Armitage 1982</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#11">[#11]</a></td></tr></table></td></tr><tr ><td class="posttext"> Ok I removed the UTF-8 &amp; BOM encoding and References (ë in my first name) and put everything in AINSI format. Should be working fine now, whatever your gcc version.<br><br><font class="tiny">Last edited 2012</font> <br><br></td></tr></table><br>
<a name="1157590"></a>

<a name="1157591"></a>

<a name="1157592"></a>

<a name="1157593"></a>

<a name="1157594"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >col</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#12">[#12]</a></td></tr></table></td></tr><tr ><td class="posttext"> Hiya,<br><br>Opening up the discussion for bug hunting...<br><br>I get a crash when testing the VaryingRestitution example. When I click on a 'ball' I get an EAV at line 224 in box2d.bmx.<br><br>So inside box2d.bmx:-<br><br>Does <b>Function b2Fixture._create(b2ObjectPtr:Byte Ptr)</b> get called from inside c++, if so where from? I've looked through and can't find anything obvious, I see its called from BMax.<br><br>A bug is highlighted when <b>bmx_b2fixture_getmaxfixture(b2ObjectPtr)</b> is called. There are a few places that I can see in the c++ that use <b>fixture-&gt;GetUserData</b>, but nowhere that I see that sets that variable by using <b>fixture-&gt;SetUserData</b> anywhere. This is more than likely the cause of an always invalid address returned from <b>bmx_b2fixture_getmaxfixture(b2ObjectPtr)</b> at line 224.<br><br>Do you have any clues as to where/what/how should be setting this variable at all? I may be reading it wrong. Are you also meant set the -&gt;UserData inside the <b>Function _create:b2Fixture(b2ObjectPtr:Byte Ptr)</b> where you also set <b>fixture.b2ObjectPtr = b2ObjectPtr</b> ??<br><br>You do get a valid Fixture returned from the C++, so that's working ok but it's not being tied to the BMax instance. ( Is this what you have the -&gt;*UserData for? ) Then later when the code is using -&gt;GetUserData then becomes a problem.<br><br><font class="tiny">Last edited 2012</font> <br><br></td></tr></table><br>
<a name="1157633"></a>

<a name="1157634"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >AdamRedwoods</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#13">[#13]</a></td></tr></table></td></tr><tr ><td class="posttext"> hi. I'm up and its working.<br><br>So right away, i see:<br>box2d.bmx<br><pre class=code>

Type b2Fixture

	Field b2ObjectPtr:Byte Ptr
	Field userData:Object

	Function _create:b2Fixture(b2ObjectPtr:Byte Ptr)
		If b2ObjectPtr Then
			Local fixture:b2Fixture = b2Fixture(bmx_b2fixture_getmaxfixture(b2ObjectPtr))
			If Not fixture Then
				fixture = New b2Fixture
				fixture.b2ObjectPtr = b2ObjectPtr
			Else
				If Not fixture.b2ObjectPtr Then
					fixture.b2ObjectPtr = b2ObjectPtr
				EndIf
			End If
			Return fixture
		End If
	End Function
</pre><br><br>So the way it works, is you need to pass around the Byte Ptr to the object you create in the glue.cpp-- but you cannot cast it in Bmax.<br><br>So this won't work (* it sometimes will, but sometimes crashes randomly so we cannot guarantee it):<br><pre class=code>
Local fixture:b2Fixture = b2Fixture(bmx_b2fixture_getmaxfixture(b2ObjectPtr))
</pre><br><br>I know you're trying to use BBObject, but then yes, you're going to get into problems with BBRETAIN and other GC problems. To be honest, I don't know enough about BMax's GC to trick it.<br><br>So my strategy would be to keep these class objects on the cpp side-- but this is different how you approached this originally.<br><br>Notice Type "b2BodyDef" in box2d.bmx, it only stores the byteptr to the cpp side and some Object for data on our side.<br>When we create b2BodyDef, it calls the cpp function which returns a pointer ("new" in cpp returns a pointer). BMax will keep this pointer around in it's GC since we are using a byteptr field.<br><br>So now, everytime we want to make a change to the cpp class, we need to pass the pointer to our "glue" cpp code. we can hide this pointer passing in our Bmax Type. Example:<br><pre class=code>
	Rem
	bbdoc: The world position of the body.
	about: Avoid creating bodies at the origin since this can lead to many overlapping shapes.
	End Rem
	Method SetPositionXY(x:Float, y:Float)
		bmx_b2bodydef_setpositionxy(b2ObjectPtr, x, y)
	End Method
</pre><br>You can see how the above works. The glue code manages the class object.<br><br><br>Does that make sense? i could show you how to work with b2Fixture, but i'd need to decipher how box2d works.<br><br><font class="tiny">Last edited 2012</font> <br><br></td></tr></table><br>
<a name="1157669"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Armitage 1982</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#14">[#14]</a></td></tr></table></td></tr><tr ><td class="posttext"> Indeed, I was trying to cast the byte Ptr like any other object and discover that you can't.<br>After that, I was puzzled and nowhere.<br><br>Given that the cpp pointer is linked to a BlitzMax counterpart object.<br>Most of the time I'm passing the pointer to the glue cpp code, but in the specific case of b2Fixture it's kinda complicated.<br>You can create a Fixture and return them from many ways.<br>The one who's crashing currently is returning fixture from picking thanks to a casting ray on shapes and AABB.<br>The thing is it's using a query Callback function that will return cpp Fixtures but obviously, not it's BlitzMax counterpart object.<br><br>That's why I'm using a bmx_b2fixture_getmaxfixture inside cpp to retrieve the BlitzMax object.<br>Basically each Box2d object can store userData and when creating a new Fixture, I store the BlitzMax Fixture Object inside that userData.<br>That way in the cpp glue code I'm able to retrieve the BlitzMax object (thanks to fixture-&gt;GetUserData();) linked to that cpp fixture.<br>On the other hand, to reproduce this functionnality, the UserData in BlitzMax object really store user data and absolutely no cpp object or pointer.<br><br>Unfortunately, cpp can only return BlitzMax object as BBObject (not as b2Fixture).<br>That's why I'm casting the returned BBObject into a BlitzMax object: <br><br>Local fixture:b2Fixture = b2Fixture(bmx_b2fixture_getmaxfixture(b2ObjectPtr))<br><br><br>I guess it's crashing because, for a reason or another, bmx_b2fixture_getmaxfixture() return something that is not NULL nor a BlitzMax b2Fixture (BBObject to be casted).<br>It can return NULL (or &amp;bbNullObject under cpp) because fixture can implicitely be created (from body factories or fixture Definition).<br>When it's the case the BlitzMax version of that fixture was never created and so never set in the cpp userdata.<br>In that specific case, if fixture-&gt;GetUserData() return null, then a BlitzMax fixture is created and its b2ObjectPtr Field is populated with the cpp fixture pointer.<br>That way everything should be linked again and be usable under Max.<br><br>When the BlitzMax object is created inside the glue file it's calling _arm_box2d_b2Body_MaxCreateFixture() from BlitzMax.<br>I tried to remove that step and directly passing an empty BlitzMax Fixture object but it didn't solve the problem.<br><pre class=code>b2Fixture * bmx_b2body_createfixture(b2Body * body, BBObject * fixture, b2FixtureDef * def) {
	b2Fixture * CPPfixture = body-&gt;CreateFixture(def);
	CPPfixture-&gt;SetUserData(fixture);
	return CPPfixture;
}</pre><br>It's like if <b>CPPfixture-&gt;GetUserData()</b> was returning something else !?<br><br><br>And, yeah... It's quite complicated :)<br>Plus the fact that you can't debug cpp code from Max doesn't help. <br><br></td></tr></table><br>
<a name="1157677"></a>

<a name="1157744"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >col</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#15">[#15]</a></td></tr></table></td></tr><tr ><td class="posttext"> Well spotted Adam, I didn't even think you couldn't do that for some reason, but thinking about it, it does make a lot sense, how is BMax supposed to know.<br><br><div class="quote"> Plus the fact that you can't debug cpp code from Max doesn't help. <br></div><br>You can kindof, by casting pointers etc and outputting values to the console. Granted its not as nice as stepping through with the debug controls but it can still be an incredible help, as you can cross reference the c++ to and from the BMax counterparts...<br><br>In the c++...<br><br>#include &lt;iostream&gt;<br>using namespace std; // So we don't have to keep writing std::cout, std::endl etc<br><br>at the top of box2d.cpp, then use <br><br>cout &lt;&lt; variable &lt;&lt; endl;<br><br>you can cast pointers to an int if needed... <br><br>reinterpret_cast&lt;int&gt;(pointer)<br><br>for example using this function in place of the one of the at line 918 in glue.cpp<br><textarea class=codebox name="code" wrap=OFF readonly="true" rows="15" cols="80">
BBObject * bmx_b2fixture_getmaxfixture(b2Fixture * fixture) {
	cout &lt;&lt; "bmx_b2fixture_getmaxfixture(b2Fixture * fixture) - fixture: " &lt;&lt; hex &lt;&lt; reinterpret_cast&lt;int&gt;(fixture) &lt;&lt; endl; //     &lt;-----DEBUG OUTPUT in hex using the 'hex' manipulator
	void * obj = fixture-&gt;GetUserData();
	if (obj) {
		return (BBObject *)obj;
	}
	return &amp;bbNullObject;
}
</textarea><br><br>in BMax for eg...<br><br><pre class=code>
Import BRL.Retro
Local ObjectPtr:Byte Ptr
Local Obj:Object

WriteStdout Hex(Int Byte Ptr Obj)+"~n"
WriteStdout Hex(Int ObjectPtr)+"~n"
</pre><br><br>I'd make a complete debug output library/class/method to spit everything out to the console and compare against the values in BMax to make sure all values tie up.<br><br>On with the real issue...<br><br>I understand how and why you're tieing the BMax instance to the c++ one. One way I got around this exact problem in my uiribbon code was when a BMax object was created and tied to a c++ object, I would store the BMax instance in a TMap with using the c++ pointer address as the key ( converted the Byte Ptr to an Int then to a string to make the address an object for the TMap requirements ). Then when the c++ called back into BMax with just a pointer to an existing c++ object ( meaning I now need tie up with the specific instance of the BMax object thats tied to the c++ object instance ) I use the c++ pointer ( again converted to an Int then to a string ) as the key to search the TMap and retrieve the unique BMax instance. My scenario is in a GUI so speed, although critical, isn't as crucial as yours.<br><br><font class="tiny">Last edited 2012</font> <br><br></td></tr></table><br>
<a name="1157764"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Armitage 1982</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#16">[#16]</a></td></tr></table></td></tr><tr ><td class="posttext"> Clever idea Dave!<br><br>Yeah, maybe all the converting things as well as searching into a TMap isn't the fastest solution with a physics engine because of the frequent callback per collisions.<br><br>I know it's possible to do it that way since it's based on the work of Brucey who came with this idea. I must fall into one of those cases where the solution should be way much simplified. <br><br></td></tr></table><br>
<a name="1157848"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >col</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#17">[#17]</a></td></tr></table></td></tr><tr ><td class="posttext"> hmm,<br><br>I've had a little glance at tracing some other issues, and I can see some problems with using the incorrect parameters in the functions that are called from the c++.<br><br>As a quick example - the b2QueryCallback. In the c++ ( MaxQueryCallback class ) you're calling the BMax function _arm_box2d_b2QueryCallback__ReportFixture, which is ok, and the first parameter is a handle to a BMax object which is ok again, but the fixture parameter is using a c++ instance of a b2fixture, however in the BMax function the second parameter is a BMax object.<br><br>There may be more occurrances of this, I haven't had time to look just yet.<br><br>I did some testing this morning with storing BMax Objects inside a class and passing them about in other  classes etc while using BBRETAIN and BBRELEASE accordingly, passing them back and forth, and destroying them and it works ok, but it can so easily go wrong if you miss one little piece of the party. I'd say it's quite stable to do that as long as you keep track of it properly using a VERY ROBUST create/delete setup.<br><br>The problem I can see at the moment with some of the code is passing around the wrong parameters or wrong instances, using c++ instance instead of BMax instances and visa-versa. <br><br></td></tr></table><br>
<a name="1157961"></a>

<a name="1157963"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >col</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#18">[#18]</a></td></tr></table></td></tr><tr ><td class="posttext"> ...posted too soon... ;-)<br><br><font class="tiny">Last edited 2012</font> <br><br></td></tr></table><br>
<a name="1157964"></a>

<a name="1157965"></a>

<a name="1157966"></a>

<a name="1157968"></a>

<a name="1157978"></a>

<a name="1157982"></a>

<a name="1157983"></a>

<a name="1157984"></a>

<a name="1157985"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >col</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#19">[#19]</a></td></tr></table></td></tr><tr ><td class="posttext"> Am i correct in this thinking...<br><br>Whenever you create a BMax instance of a Fixture you need to store that BMax instance in the c++ b2Fixture-&gt;UserData() because later c++ may call back with just the c++ instance and you need to retrieve the BMax instance from c++ one? Your current code seems to reflect this, but I could be wrong.<br><br>Now when you use body.createfixture(def), c++ creates a new fixture from the definition, which goes through the fixture creation method as above, but then the BMax instance is lost as it drops out of scope as nothing holds a reference to it, but it needs to be retained because the c++ body has a reference to the c++ instance of the fixture. So my thinking is where will you hold this reference to the BMax fixture object using BBRETAIN so that later you can BBRELEASE it? It looks as though you were going to store it the fixture-&gt;UserData() but isnt that where the BMax instance of a Fixture is meant to be?<br><br>Or am I way off altogether ? :-)<br><br>EDIT:- I've managed to get it working by BBRETAIN all of the b2Fixtures in c++, but I'm sure this isn't correct as the GC will be holding references when it shouldn't be, but it hightlights the issue above.<br><br><a href="http://www.datafilehost.com/download-055c9644.html" target="_blank"><b>box2d.zip</b></a><br><br>EDIT2:- I really don't mean to dampen your spirits because this would be really cool and you've come sooo far already, but there are memory leaks when you create a new BMax instance from an existing c++ instance. Imagine the scenario as it is at the moment... Box2D wants to debugdraw the spheres so it passes some b2Vec2's into the BMax debugdraw function. You are correct in the BMax b2Vec2._create to assign the b2Vec2 instance to the BMax one except when you create a new BMax instance you are also automatically creating another new c++ b2Vec2 instance too ( in the New() method ). This isn't as bad as it sounds but if you are going to re-assign the c++ instance inside the BMax instance then the 'New'ly created instance will need to deleted in c++ to prevent a memory leak or use a completely different approach.<br><br><textarea class=codebox name="code" wrap=OFF readonly="true" rows="15" cols="80">
Function _create:b2Vec2(b2ObjectPtr:Byte Ptr)
	If b2ObjectPtr Then
		Local this:b2Vec2 = New b2Vec2

		bmx_b2vec2_delete(this.b2ObjectPtr)      &lt;-- Prevent memory leak

		this.b2ObjectPtr = b2ObjectPtr
		Return this

	End If
End Function
</textarea><br><br>This will apply to ALL types that create instances in that way.<br><br><font class="tiny">Last edited 2012</font> <br><br></td></tr></table><br>
<a name="1158115"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >AdamRedwoods</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#20">[#20]</a></td></tr></table></td></tr><tr ><td class="posttext"> Re: memory leaks<br><br>For every New() Method you use in bmax, make a Delete() Method, where you are deleting the cpp pointer. Delete is called when the GC collects.<br><br><pre class=code>
Method Delete()
     bmx_b2vec2_delete(this.b2ObjectPtr)
EndMethod
</pre> <br><br></td></tr></table><br>
<a name="1158340"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Armitage 1982</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#21">[#21]</a></td></tr></table></td></tr><tr ><td class="posttext"> Hi Dave,<br>Very interesting talk. I will have a look at the Query Callback to see if I'm correctly using the right pointer.<br><br>About the trouble with the UserData() to sum it all quickly I would say that <b>the C++ object will store a BBRETAINed pointer of the BlitzMax object connected to it, and BlitzMax field b2ObjectPtr will store the C++ object pointer to successfully call C++ methods &amp; others</b>.<br><br>The UserData Field in BlitzMax (Box2d) objects will never store anything related to that module because it is used by the users to store anything he want.<br><br>When I want to create a fixture I think I'm doing such:<br>Calling a Box2d methods to create the fixture and callback a BlitzMax function with the C++ fixture pointer as a parameter.<br>The BlitzMax callback create a BlitzMax Fixture, store the C++ pointer into b2ObjectPtr for later use and return itself to C++.<br>Finally, BBRETAIN is used on the BlitzMax object and stored into the Box2d Fixture UserData.<br><br>@Adam<br>Hum... Delete() Method as well as bmx_XXXXXX_delete() C++ function already exist and are correctly executed.<br><br>I'm not sure any memory leaks is done currently but if it's the case I will correct this when everything will be fixed. <br><br></td></tr></table><br>
<a name="1158394"></a>

<a name="1158408"></a>

<a name="1158417"></a>

<a name="1158418"></a>

<a name="1158419"></a>

<a name="1158420"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >col</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#22">[#22]</a></td></tr></table></td></tr><tr ><td class="posttext"> Hiya,<br><br>Let's use the VaryingRestitution example and hopefully I won't bake your noodle, but offer some insight into why this can't be simply thrown together. Specifically the case of the b2Body groundBody fixture ( Line 27 ), initially what you had was...<br><br><b>Local b2:b2fixture = groundBody._CreateFixture(groundShape, 0.0)</b><br><br>So stepping through this starting from the BMax side...<br>1. b2Body._CreateFixture calls into the c wrapper function 'bmx_b2body__createfixture'<br>2. 'bmx_b2body__createfixture' then calls the Box2D  'body-&gt;CreateFixture' which returns you a valid b2Fixture object in c++, which in turn is returned to BMax.<br>3. Now back in BMax, this c++ pointer is passed as the parameter 'b2ObjectPtr' in 'b2Fixture._create'.<br>4. If the b2ObjectPtr is a NON-NULL value, you then call back into c++ using 'bmx_b2fixture_getmaxfixture' to check if the c++ -&gt;UserData() contains a BMax instance. If it does you return that instance, otherwise you return a valid Null BMax instance.<br>5. If a Null instance is returned you create a New BMax b2Fixture and store the c++ pointer as the b2ObjectPtr.<br>6. You then return the New BMax instance.<br><br>All is great except what's missing here is storing this new BMax instance into the C++ instance -&gt;UserData(), so I wrote a simple c++ 1 liner 'bmx_b2Fixture_setmaxfixture(b2ObjectPtr,fixture)' call in c++ with the c++ instance pointer and the BMax object pointer and set the UserData() accordingly.<br><br>Now the 2 are tied together and the BMax b2Fixture is returned into VaryingRestitution.Create method as a <b>Local b2Fixture</b> object. Take note as this next bit is VERY important as to crashing! What happens when this .Create method exits... all Local variables that are not either stored somewhere else under any means such as a Field, Global or returned as a parameter etc will go out of scope reducing the GC reference count to zero and be inaccessible. I'm not exactly sure how BMax GC handles this internally, whether this object is immediately inaccessible or put up for collecting, but it doesn't matter as now these Local(s) should be thought of as they don't exist anymore anywhere. BUT we have a reference to them in the c++ instance which doesn't know that the BMax instances don't exist anymore. Now when the c++ calls back into BMax and there is a reference in the -&gt;UserData(), you try to cast to a BMax object that doesn't actually exist anymore = Kaboom!! This is where you would use BBRETAIN to hold an extra reference count to the object which in turn keeps the BMax object alive and kicking ( c++ 'bmx_b2Fixture_setmaxfixture' function ). The Box2D manual says that these b2body-&gt;b2fixture(s) can be released via code, or when the b2body is destroyed, so at this stage I'd say it's safe to leave the BBRETAIN in that place. Which brings me to the next issue that NEEDS to be thought long and hard about how to handle it...<br><br>You have the necessary code in place for when the programmer decides to destroy the fixture from the body - Body-&gt;DestroyFixture(b2Fixture), but what will happen when the coder doesn't do that and the b2Body is destroyed... Box2d will internally delete the c++ fixtures tied to the body. But we need a way to BBRELEASE the BMax instances stored in the c++ b2Fixture-&gt;UserData, otherwise another memory leak will be caused because of the BMax GC holding references. A perfect place would be in the c++ b2Fixture destructor. Now... you could write your own c++ class that will inherit from or wrap the original c++ b2Fixture and that will be a partial re-write in itself ( using your own b2Fixture all over your wrapper, which in this case WILL be so much safer as you will have full functionality control during the class instance lifetime including control of any BMax references at any time, this is similar to how some of wxWidgets is wrapped ), or do a nasty, keep your original setup and modify the original Box2D b2Fixure and write your own c++ b2Fixture destructor ... your own morals will decide that one ;-) ,of course you may have a better idea too, but hopefully you can see the possible pitfall. This is only an issue for when c++ objects hold onto references to BMax objects.<br><br>This is an example of what I mean by building a VERY robust Create/Delete system. Imagine if you get to the end, find the code is leaking memory like a sieve and you have to re-write the whole thing from the ground up!! :-(<br>Nipping these things in the bud should be the first course of foundation layed down and makes everything else safely lay down on top without falling over.<br><br>I hope that didn't hurt too much, but only served as food for thought and motivation to carry on.<br><br>Edited for punctuality.<br><br><font class="tiny">Last edited 2012</font> <br><br></td></tr></table><br>
<a name="1159287"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Armitage 1982</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#23">[#23]</a></td></tr></table></td></tr><tr ><td class="posttext"> I effectively had a small pointer error in my _ReportFixture callback Query Method. But this didn't solve anything :(<br><br>So I made a last few changes<br><div class="quote"> -	Method _ReportFixture:Int(QueryCallback:b2QueryCallback, fixture:b2Fixture)<br>+	Method _ReportFixture:Int(QueryCallback:b2QueryCallback, fixture:Byte Ptr) <br></div><br><br>I think it would be much, much more easier to port my engine to LibGDX, a Java 2D Framework actively supported featuring everything I need including the last version of Box2D libs.<br><br>I also read that Unity3D will probably add support for Box2D.<br>A Farseer Asset is already available as well (while a bit too slow unfortunately).<br><br>Too bad having to change a whole system just for an outdated libs :-( <br><br></td></tr></table><br>
<a name="1159313"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >col</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#24">[#24]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> I effectively had a small pointer error in my _ReportFixture callback Query Method. But this didn't solve anything :( <br></div><br><br>Did you take a look at the changed BMax TFixture in <a href="http://www.datafilehost.com/download-055c9644.html" target="_blank">Here</a> ?<br><br>This works without an EAV by setting the c++ fixture-&gt;UserData() to the BMax instance. I also changed the _ReportFixture callback Query Method to a Function as Methods are unsafe as a callback. However it does have the underlying issues explained above. For testing *cough* *cough* I'd personally write a destructor in the Box2D b2Fixture class to call the BBRELEASE for a BMax instance in the c++ -&gt;UserData variable ( at least to get it all stable then work on some 'coder etiquette' later before releasing the port ).<br><br>To be honest you're almost there with the Box2D port, it's just the b2Fixture and 1 ( maybe 2 ) other classes that need this extra work for them to be safe. The others are fine and just need the creases ironed out. <br><br></td></tr></table><br>
<a name="1159322"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Armitage 1982</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#25">[#25]</a></td></tr></table></td></tr><tr ><td class="posttext"> Oups... !<br><br>In fact, I've read your post but focus a lot more on the next one and totally forget to check that link.<br><br>I came to the same conclusion about the C-&gt;Max &amp; Max-&gt;C object linkage and cut the same solution, but where my entire problem was situated was in that <b>(BBObject*)</b><i>fixture-&gt;GetUserData()</i> missing C++ Casting.<br><br>Certainly a lack of practice with C++ again.<br><br><br>Now about the memory leak it's certainly true that we need to rewrite the b2Fixture Destructor to remove the BlitzMax Object linked to it. The idea is to avoid at all cost any changes in the Box2D Code so I would certainly go with the first solution you were talking about.<br><br>But giving the fact that I'm not experimented with C++ and that I can't debug any C++ code in my current environment I feel that the task would be too cumbersome.<br>Yeah, I know it's only a few lines of C++ to add to a few extended Classes but I was thinking about porting the whole engine and not just the most used part of it like the one from Brucey is currently doing. Along the road I've spotted so much new Classes that I don't even know how I could test and wrap them efficiently (and trust me there is a lot more work to get it done).<br><br>But I'm extremely thankful to you for making me understand and find my errors.<br><br>On a side note:<br>3 years ago I would have continue my work on this but today everything indicates that I need to move on to something widely used and supported.<br>Simply because I'm not a developer, I'm just trying to make games ! Too bad BRL and Mark didn't catch this and prefer to re-create Java with Monkey...<br>Hope this time they think about something like JNI wrapper for their Monkey. <br><br></td></tr></table><br>
<a name="1159392"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Armitage 1982</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#26">[#26]</a></td></tr></table></td></tr><tr ><td class="posttext"> Oh by the way Dave, I forgot about it but there is a functionality inside Box2d that allow us to control the implicitly destroyed Fixtures or joints.<br>This class is called <b>b2DestructionListener</b> and is described in <i><b>Chapter 11 Loose Ends</b></i> of the <a href="http://www.box2d.org/manual.html" target="_blank">Box2D Manual</a>.<br><br>I already implemented this Class for the BlitzMax counterpart and normally it's working. So any memory leak "should" be avoided as long as the C++ object storing anything related to BlitzMax feature a b2DestructionListener.<br>This is the case for body, joint and fixture. Definition object are not kept in the simulation and should be destroyed manually (or Garbage Collected). <br><br></td></tr></table><br>
<a name="1159647"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >col</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#27">[#27]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> So any memory leak "should" be avoided as long as the C++ object storing anything related to BlitzMax feature a b2DestructionListener. <br></div><br>Ahh, that's great and certainly takes the sting out of trying to manage the BMax objects from Box2D c++. So using the b2DestructionListener you can simply make a call back in to c++ to release the reference to -&gt;UserData, nice one! <br><br></td></tr></table><br>
<a name="bottom"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td align="right"><a href="http://monkeycoder.co.nz" target="_blank"><img src="/img/monkey2.svg" ></a> <a href="https://github.com/blitz-research" target="_blank"><img src="/img/github.svg" ></a> <a href="https://discord.gg/qJccbSp" target="_blank"><img src="/img/discord.svg" ></a></td></tr></table><br></div><br><table width="100%"><tr><td></body></html lang="en">
