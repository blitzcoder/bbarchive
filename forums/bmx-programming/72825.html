<!DOCTYPE html><html lang="en" ><head ><title >RegisterServiceCtrlHandler reports error</title><meta name='viewport' content='width=device-width, initial-scale=0.66'><meta name='description' content='language:basic, target:desktop, category:game development'><link rel="styleSheet" href="../skins/granite/style.css" type="text/css"><style type="text/css">div.bbcode {padding: 8px;background: #E5E5E5;color: #000000;border: 1px dashed #B4B4BE;}</style></head><body ><table width=100% cellspacing=0 cellpadding=0><tr ><td class="menubarleft"></td><td class="menubar"><table cellspacing="0" cellpadding="0"><tr ><td >&nbsp;</td><td class="menuitemleft"></td><td class="menuitem"><a href="/" class="menuitem">News</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/forums.php" class="menuitem">Forums</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/codearcs.php" class="menuitem">Code</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/logs.php" class="menuitem">Logs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/gallery.php" class="menuitem">Gallery</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/sdkspecs.php" class="menuitem">Specs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/search.php" class="menuitem">Search</a></td><td class="menuitemright"></td></tr></table></td><td class="menubarright"></td></tr></table><div class="main"><h1 >RegisterServiceCtrlHandler reports error</h1><a href="forums.php" >BlitzMax Forums</a>/<a href="topics.php?forum=102" >BlitzMax Programming</a>/<a href="#bottom" >RegisterServiceCtrlHandler reports error</a><br><br>
<a name="813989"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >andre72</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#1">[#1]</a></td></tr></table></td></tr><tr ><td class="posttext"> I don't like to give up about the BM Service ...<br>But I'm not able to register the Ctrl Handler.<br>Maybe somebody have an idea - or is there something wrong pointing to the functions?<br><br>SuperStrict<br><br>Import "-ladvapi32"<br><br>'API Constants<br>Const SERVICES_ACTIVE_DATABASE:String = "ServicesActive"<br>' Service Control<br>Const SERVICE_CONTROL_STOP:Int = $1<br>Const SERVICE_CONTROL_PAUSE:Int = $2<br>' Service State - for CurrentState<br>Const SERVICE_STOPPED:Int = $1<br>Const SERVICE_START_PENDING:Int = $2<br>Const SERVICE_STOP_PENDING:Int = $3<br>Const SERVICE_RUNNING:Int = $4<br>Const SERVICE_CONTINUE_PENDING:Int = $5<br>Const SERVICE_PAUSE_PENDING:Int = $6<br>Const SERVICE_PAUSED:Int = $7<br>Const SERVICE_ACCEPT_STOP:Int = $1<br>Const SERVICE_ACCEPT_PAUSE_CONTINUE:Int = $2<br>Const SERVICE_ACCEPT_SHUTDOWN:Int = $4<br>'Service Control Manager object specific access types<br>Const STANDARD_RIGHTS_REQUIRED:Int = $F0000<br>Const SC_MANAGER_CONNECT:Int = $1<br>Const SC_MANAGER_CREATE_SERVICE:Int = $2<br>Const SC_MANAGER_ENUMERATE_SERVICE:Int = $4<br>Const SC_MANAGER_LOCK:Int = $8<br>Const SC_MANAGER_QUERY_LOCK_STATUS:Int = $10<br>Const SC_MANAGER_MODIFY_BOOT_CONFIG:Int = $20<br>Const SC_MANAGER_ALL_ACCESS:Int = $F003F 'STANDARD_RIGHTS_REQUIRED | SC_MANAGER_CONNECT | SC_MANAGER_CREATE_SERVICE | SC_MANAGER_ENUMERATE_SERVICE | SC_MANAGER_LOCK or SC_MANAGER_QUERY_LOCK_STATUS | SC_MANAGER_MODIFY_BOOT_CONFIG<br>'Service object specific access types<br>Const SERVICE_QUERY_CONFIG:Int = $1<br>Const SERVICE_CHANGE_CONFIG:Int = $2<br>Const SERVICE_QUERY_STATUS:Int = $4<br>Const SERVICE_ENUMERATE_DEPENDENTS:Int = $8<br>Const SERVICE_START:Int = $10<br>Const SERVICE_STOP:Int = $20<br>Const SERVICE_PAUSE_CONTINUE:Int = $40<br>Const SERVICE_INTERROGATE:Int = $80<br>Const SERVICE_USER_DEFINED_CONTROL:Int = $100<br>Const SERVICE_ALL_ACCESS:Int = $1FF 'STANDARD_RIGHTS_REQUIRED | SERVICE_QUERY_CONFIG | SERVICE_CHANGE_CONFIG | SERVICE_QUERY_STATUS | SERVICE_ENUMERATE_DEPENDENTS | SERVICE_START | SERVICE_STOP | SERVICE_PAUSE_CONTINUE | SERVICE_INTERROGATE | SERVICE_USER_DEFINED_CONTROL<br>' Service Install - Types<br>Const SERVICE_WIN32_OWN_PROCESS:Int = $10<br>Const SERVICE_ERROR_NORMAL:Int = $1<br>Const SERVICE_AUTO_START:Int = $2<br>Const SERVICE_DEMAND_START:Int = $3<br>' Service Types<br>Const SERVICE_WIN32_SHARE_PROCESS:Int = $20<br>Const SERVICE_WIN32:Int = $30<br><br>Type SERVICE_STATUS<br>    Field dwServiceType:Int<br>    Field dwCurrentState:Int<br>    Field dwControlsAccepted:Int<br>    Field dwWin32ExitCode:Int<br>    Field dwServiceSpecificExitCode:Int<br>    Field dwCheckPoint:Int<br>    Field dwWaitHint:Int<br>End Type<br><br>Type SERVICE_TABLE_ENTRY<br>	Field lpServiceName:String<br>	Field lpServiceProc:Byte ptr<br>End Type<br><br>Extern "Win32"<br>	Function CloseServiceHandle:Int (hSCObject:Int) = "CloseServiceHandle@4"<br>	Function ControlService:Int (hService:Int, dwControl:Int, lpServiceStatus:Byte ptr) = "ControlService@12"<br>	Function OpenSCManager:Int (lpMachineName:Byte Ptr, lpDatabaseName:Byte Ptr, dwDesiredAccess:Int) = "OpenSCManagerA@12"<br>	Function OpenService:Int (hSCManager:Int, lpServiceName:Byte Ptr, dwDesiredAccess:Int) = "OpenServiceA@12"<br>	Function QueryServiceStatus (hService:Int, lpServiceStatus:Byte ptr) = "QueryServiceStatus@8"<br>	Function StartService:Int (hService:Int, dwNumServiceArgs:Int, lpServiceArgVectors:Int) = "StartServiceA@12"<br>	Function CreateService:Int (hSCManager:Int, lpServiceName:Byte ptr, lpDisplayName:Byte ptr, dwDesiredAccess:Int, dwServiceType:Int, dwStartType:Int, dwErrorControl:Int, lpBinaryPathName:Byte ptr, lpLoadOrderGroup:Byte ptr, lpdwTagID:Int, lpDependencies:Byte ptr, lp:Byte ptr, lpPassword:Byte ptr) = "CreateServiceA@52"<br>	Function StartServiceCtrlDispatcher:Int (lpServiceStartTable:Byte ptr) = "StartServiceCtrlDispatcherA@4"<br>	Function RegisterServiceCtrlHandler:Int(lpServiceName:Byte ptr, lpHandlerProc:Byte ptr) = "RegisterServiceCtrlHandlerA@8"<br>	Function SetServiceStatus:Int(hService:Int, lpHandlerProc:Byte ptr) = "SetServiceStatus@8"<br>	Function GetLastError()<br>End Extern<br><br>Function ServiceCreate:Int(ServiceName:String) <br>	Local hSManager:Int = OpenSCManager(Null, SERVICES_ACTIVE_DATABASE, SC_MANAGER_ALL_ACCESS) <br>	Local res:Int<br>	If hSManager &lt;&gt; 0<br>		Local schService:Int = CreateService(hSManager, ServiceName, ServiceName, SERVICE_ALL_ACCESS, SERVICE_WIN32_OWN_PROCESS, SERVICE_DEMAND_START, SERVICE_ERROR_NORMAL, AppFile, Null, Null, Null, Null, Null) <br>		If schService &lt;&gt; 0<br>			CloseServiceHandle schService<br>		Endif<br>		CloseServiceHandle hSManager<br>	EndIf<br>	Return res<br>End Function<br><br>ServiceCreate "TestService"<br>Local svc:SERVICE_TABLE_ENTRY = New SERVICE_TABLE_ENTRY<br>svc.lpServiceName = "MyProc"<br>svc.lpServiceProc = Byte ptr(SvcMain()) <br>DebugLog("Register Handler") <br>Local success:Int = StartServiceCtrlDispatcher(svc) <br>DebugLog("Success: " + success) <br><br>Function SvcMain (argc:Int = Null, argv:String = "") <br>	Local svchandle:Int = RegisterServiceCtrlHandler("TestService", Byte ptr(svcCtrlHandler())) <br>	DebugLog("svchandle: " + svchandle) <br>	If svchandle = 0 Then<br>		DebugLog("Ctrl Service Handle could not be registered. Error: " + GetLastError()) <br>	End If<br>End Function<br><br>Function svcCtrlHandler(dwOpcode:Int = Null) <br>	DebugLog("svcCtrl") <br>End Function<br><br>Thanks,<br><br>Andre <br><br></td></tr></table><br>
<a name="814669"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >andre72</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#2">[#2]</a></td></tr></table></td></tr><tr ><td class="posttext"> Maybe somebody could find a solution checking the C Source I like to translate to BM.<br>Please have a look:<br><br>/* A skeleton for writing an NT/2K service */<br>/* Author :- Nishant S */<br>/* EMail :- nish@... */<br><br>#include &lt;windows.h&gt;<br>#include &lt;winsvc.h&gt;<br><br>void ServiceMain(DWORD argc, LPTSTR *argv); <br>void ServiceCtrlHandler(DWORD nControlCode);<br>BOOL UpdateServiceStatus(DWORD dwCurrentState, DWORD dwWin32ExitCode,<br>					 DWORD dwServiceSpecificExitCode, DWORD dwCheckPoint,<br>					 DWORD dwWaitHint);<br>BOOL StartServiceThread();<br>DWORD ServiceExecutionThread(LPDWORD param);<br>HANDLE hServiceThread;<br>void KillService();<br><br>char *strServiceName = "NishFirstService";<br>SERVICE_STATUS_HANDLE nServiceStatusHandle; <br>HANDLE killServiceEvent;<br>BOOL nServiceRunning;<br>DWORD nServiceCurrentStatus;<br><br>void main(int argc, char* argv[])<br>{<br>	SERVICE_TABLE_ENTRY servicetable[]=<br>	{<br>		{strServiceName,(LPSERVICE_MAIN_FUNCTION)ServiceMain},<br>		{NULL,NULL}<br>	};<br>	BOOL success;<br>	success=StartServiceCtrlDispatcher(servicetable);<br>	if(!success)<br>	{<br>		//error occured<br>	}<br>}<br><br>void ServiceMain(DWORD argc, LPTSTR *argv)<br>{<br>	BOOL success;<br>	nServiceStatusHandle=RegisterServiceCtrlHandler(strServiceName,<br>		(LPHANDLER_FUNCTION)ServiceCtrlHandler);<br>	if(!nServiceStatusHandle)<br>	{<br>		return;<br>	}<br>	success=UpdateServiceStatus(SERVICE_START_PENDING,NO_ERROR,0,1,3000);<br>	if(!success)<br>	{<br>		return;<br>	}<br>	killServiceEvent=CreateEvent(0,TRUE,FALSE,0);<br>	if(killServiceEvent==NULL)<br>	{<br>		return;<br>	}<br>	success=UpdateServiceStatus(SERVICE_START_PENDING,NO_ERROR,0,2,1000);<br>	if(!success)<br>	{<br>		return;<br>	}<br>	success=StartServiceThread();<br>	if(!success)<br>	{<br>		return;<br>	}<br>	nServiceCurrentStatus=SERVICE_RUNNING;<br>	success=UpdateServiceStatus(SERVICE_RUNNING,NO_ERROR,0,0,0);<br>	if(!success)<br>	{<br>		return;<br>	}<br>	WaitForSingleObject(killServiceEvent,INFINITE);<br>	CloseHandle(killServiceEvent);<br>}<br><br><br><br>BOOL UpdateServiceStatus(DWORD dwCurrentState, DWORD dwWin32ExitCode,<br>					 DWORD dwServiceSpecificExitCode, DWORD dwCheckPoint,<br>					 DWORD dwWaitHint)<br>{<br>	BOOL success;<br>	SERVICE_STATUS nServiceStatus;<br>	nServiceStatus.dwServiceType=SERVICE_WIN32_OWN_PROCESS;<br>	nServiceStatus.dwCurrentState=dwCurrentState;<br>	if(dwCurrentState==SERVICE_START_PENDING)<br>	{<br>		nServiceStatus.dwControlsAccepted=0;<br>	}<br>	else<br>	{<br>		nServiceStatus.dwControlsAccepted=SERVICE_ACCEPT_STOP			<br>			|SERVICE_ACCEPT_SHUTDOWN;<br>	}<br>	if(dwServiceSpecificExitCode==0)<br>	{<br>		nServiceStatus.dwWin32ExitCode=dwWin32ExitCode;<br>	}<br>	else<br>	{<br>		nServiceStatus.dwWin32ExitCode=ERROR_SERVICE_SPECIFIC_ERROR;<br>	}<br>	nServiceStatus.dwServiceSpecificExitCode=dwServiceSpecificExitCode;<br>	nServiceStatus.dwCheckPoint=dwCheckPoint;<br>	nServiceStatus.dwWaitHint=dwWaitHint;<br><br>	success=SetServiceStatus(nServiceStatusHandle,&amp;nServiceStatus);<br><br>	if(!success)<br>	{<br>		KillService();<br>		return success;<br>	}<br>	else<br>		return success;<br>}<br><br>BOOL StartServiceThread()<br>{	<br>	DWORD id;<br>	hServiceThread=CreateThread(0,0,<br>		(LPTHREAD_START_ROUTINE)ServiceExecutionThread,<br>		0,0,&amp;id);<br>	if(hServiceThread==0)<br>	{<br>		return false;<br>	}<br>	else<br>	{<br>		nServiceRunning=true;<br>		return true;<br>	}<br>}<br><br>DWORD ServiceExecutionThread(LPDWORD param)<br>{<br>	while(nServiceRunning)<br>	{		<br>		Beep(450,150);<br>		Sleep(4000);<br>	}<br>	return 0;<br>}<br><br>void KillService()<br>{<br>	nServiceRunning=false;<br>	SetEvent(killServiceEvent);<br>	UpdateServiceStatus(SERVICE_STOPPED,NO_ERROR,0,0,0);<br>}<br><br>void ServiceCtrlHandler(DWORD nControlCode)<br>{<br>	BOOL success;<br>	switch(nControlCode)<br>	{	<br>	case SERVICE_CONTROL_SHUTDOWN:<br>	case SERVICE_CONTROL_STOP:<br>		nServiceCurrentStatus=SERVICE_STOP_PENDING;<br>		success=UpdateServiceStatus(SERVICE_STOP_PENDING,NO_ERROR,0,1,3000);<br>		KillService();		<br>		return;<br>	default:<br>		break;<br>	}<br>	UpdateServiceStatus(nServiceCurrentStatus,NO_ERROR,0,0,0);<br>} <br><br></td></tr></table><br>
<a name="bottom"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td align="right"><a href="http://monkeycoder.co.nz" target="_blank"><img src="/img/monkey2.svg" ></a> <a href="https://github.com/blitz-research" target="_blank"><img src="/img/github.svg" ></a> <a href="https://discord.gg/qJccbSp" target="_blank"><img src="/img/discord.svg" ></a></td></tr></table><br></div><br><table width="100%"><tr><td></body></html lang="en">
