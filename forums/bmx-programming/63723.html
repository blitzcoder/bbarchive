<!DOCTYPE html><html lang="en" ><head ><title >GCCollect() doesn't work in a dll</title><meta name='viewport' content='width=device-width, initial-scale=0.66'><meta name='description' content='language:basic, target:desktop, category:game development'><link rel="styleSheet" href="../skins/granite/style.css" type="text/css"><style type="text/css">div.bbcode {padding: 8px;background: #E5E5E5;color: #000000;border: 1px dashed #B4B4BE;}</style></head><body ><table width=100% cellspacing=0 cellpadding=0><tr ><td class="menubarleft"></td><td class="menubar"><table cellspacing="0" cellpadding="0"><tr ><td >&nbsp;</td><td class="menuitemleft"></td><td class="menuitem"><a href="/" class="menuitem">News</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/forums.php" class="menuitem">Forums</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/codearcs.php" class="menuitem">Code</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/logs.php" class="menuitem">Logs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/gallery.php" class="menuitem">Gallery</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/sdkspecs.php" class="menuitem">Specs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/search.php" class="menuitem">Search</a></td><td class="menuitemright"></td></tr></table></td><td class="menubarright"></td></tr></table><div class="main"><h1 >GCCollect() doesn't work in a dll</h1><a href="forums.php" >BlitzMax Forums</a>/<a href="topics.php?forum=102" >BlitzMax Programming</a>/<a href="#bottom" >GCCollect() doesn't work in a dll</a><br><br>
<a name="711286"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >JoshK</td><td align="right"><font class=tiny>(Posted 2006)</font>&nbsp;<a href="#1">[#1]</a></td></tr></table></td></tr><tr ><td class="posttext"> Garbage collection appears to be completely inactive when a BlitzMax program is compiled into a dll.<br><br>I am running two identical programs.  One is a BlitzMax application that includes the program files.  The other is a BlitzPlus program that calls a BlitzMax dll.<br><br>Whether the GC mode is set to 1 or 2, the memory usage increases quickly and continually.  When GC mode is set to 2, the GCCollect() command always returns 0.  I presume gc mode 1 probably calls GCCollect() every time the Flip() command is called, which my program does not use. <br><br></td></tr></table><br>
<a name="711460"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Who was John Galt?</td><td align="right"><font class=tiny>(Posted 2006)</font>&nbsp;<a href="#2">[#2]</a></td></tr></table></td></tr><tr ><td class="posttext"> Hi leadwerks -<br><br>Haven't tried making a Max dll, and I doubt you'll get any support from BRL as Max dlls are unofficial, but I can confirm a similar issue when writing a callback routine and having a 3rd party dll call it. Repeatedly crashed until I created a version that didn't require garbage collection. This was a while back in an old 'flushmem' version of Max. <br><br></td></tr></table><br>
<a name="711464"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Dreamora</td><td align="right"><font class=tiny>(Posted 2006)</font>&nbsp;<a href="#3">[#3]</a></td></tr></table></td></tr><tr ><td class="posttext"> BM DLL Support is currently in testing.<br>But it makes sense that the GC is disabled on a DLL to prevent interference with external data, which is what you operate on most of the time within the DLL.<br><br>don't think you want to get GC:Setmembit error on DLL, do you? ^^ <br><br></td></tr></table><br>
<a name="711554"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >JoshK</td><td align="right"><font class=tiny>(Posted 2006)</font>&nbsp;<a href="#4">[#4]</a></td></tr></table></td></tr><tr ><td class="posttext"> I don't see why a dll wouldn't be able to clean up its own objects just like an exe does.  My dll just wraps engines commands so that an external program can call them.<br><br>I understand dll support is currently experimental, but I have faith they'll get this cleaned up in the near future.  BlitzMax has really impressed me so far, and I think it was designed right from the ground up. <br><br></td></tr></table><br>
<a name="711557"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Gabriel</td><td align="right"><font class=tiny>(Posted 2006)</font>&nbsp;<a href="#5">[#5]</a></td></tr></table></td></tr><tr ><td class="posttext"> Well off the top of my head, I'm thinking..<br><br><pre class=code>
Type Thing
End Type

A=New Thing
B=A
</pre><br><br>If you write that code in BlitzMax, it knows you just made another reference to the "Thing". But if you do that in another language, how can BlitzMax keep count of the references? <br><br></td></tr></table><br>
<a name="711565"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >JoshK</td><td align="right"><font class=tiny>(Posted 2006)</font>&nbsp;<a href="#6">[#6]</a></td></tr></table></td></tr><tr ><td class="posttext"> I don't expect BlitzMax to keep track of an external program's variables.  I still store the objects in internal lists, just like if it was a regular BlitzMax program.  I don't see a conflict.  I wouldn't expect BlitzMax to be able to create an object, return it to the main program, and still store it without me adding the object to an internal list or variable somewhere.<br><br>When the program calls this function, the object is stored in a list, so BlitzMax won't delete it (and so the dll can handle internal routines and cycle through all the objects):<br><pre class=code>Function CreateThing:Int()
	thing:TThing=new TThing
	thing.handle=HandleFromObject(thing)
	thing.link=TThing.list.addfirst(thing)
	return thing.handle
EndFunction</pre><br><br>If I did this, I would EXPECT BlitzMax to delete the object:<br><pre class=code>Function CreateThing:Int()
	thing:TThing=new TThing
	thing.handle=HandleFromObject(thing)
	return thing.handle
EndFunction</pre><br><br>When the program wants to free the object, it does this:<br><pre class=code>Function FreeThing(HThing)
	thing:TThing=TThing(HandleToObject(HThing))
	If thing
		RemoveLink thing.link
		MemFree thing.handle
	Else
		Notify "Thing does not exist."
	Endif
EndFunction</pre><br><br>I don't see a problem.  It works just like in Blitz3D. <br><br></td></tr></table><br>
<a name="711573"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Gabriel</td><td align="right"><font class=tiny>(Posted 2006)</font>&nbsp;<a href="#7">[#7]</a></td></tr></table></td></tr><tr ><td class="posttext"> Oh I completely agree. I should have been more clear. I'm not suggesting that what you're asking for is difficult, or awkward, I'm just thinking that it might be for fear of people doing what I demonstrated above that they may have disabled automatic gargage collection for now.<br><br>Probably just until DLL's are officially supported. <br><br></td></tr></table><br>
<a name="711610"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >skidracer</td><td align="right"><font class=tiny>(Posted 2006)</font>&nbsp;<a href="#8">[#8]</a></td></tr></table></td></tr><tr ><td class="posttext"> MemFree thing.handle?????<br><br>I'm pretty sure handles are integer hash keys not memory addresses! <br><br></td></tr></table><br>
<a name="711613"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >JoshK</td><td align="right"><font class=tiny>(Posted 2006)</font>&nbsp;<a href="#9">[#9]</a></td></tr></table></td></tr><tr ><td class="posttext"> You have to use MemFree on object handles, correct?:<br><br>handle:Int=HandleFromObject(object)<br>MemFree handle<br><br>Because I am using the handles so often, my root type just automatically gets its own handle and stores it in a field. <br><br></td></tr></table><br>
<a name="711626"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Yan</td><td align="right"><font class=tiny>(Posted 2006)</font>&nbsp;<a href="#10">[#10]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> You have to use MemFree on object handles, correct?: <br></div>No, you <b>Release</b> them (that's it's only purpose in life). <br><br></td></tr></table><br>
<a name="711641"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >JoshK</td><td align="right"><font class=tiny>(Posted 2006)</font>&nbsp;<a href="#11">[#11]</a></td></tr></table></td></tr><tr ><td class="posttext"> Ah, I even had Release in my code.  I just typed it wrong here. <br><br></td></tr></table><br>
<a name="711645"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >skidracer</td><td align="right"><font class=tiny>(Posted 2006)</font>&nbsp;<a href="#12">[#12]</a></td></tr></table></td></tr><tr ><td class="posttext"> And you are using GCEnter with all your public functions? Maybe you could try a GCCollect from a simple public function that doesn't have GCEnter and call that from your main program. Fredborg I think is the man to talk to. <br><br></td></tr></table><br>
<a name="711649"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >JoshK</td><td align="right"><font class=tiny>(Posted 2006)</font>&nbsp;<a href="#13">[#13]</a></td></tr></table></td></tr><tr ><td class="posttext"> The docs for GCEnter just says not to use it(?). <br><br>I call GCCollect() in my UpdateWorld() function, which is getting called...it just returns 0, as memory usage builds and builds.  This only happens as a dll, not an exe.<br><br>I emailed Fredborg. <br><br></td></tr></table><br>
<a name="711838"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >JoshK</td><td align="right"><font class=tiny>(Posted 2006)</font>&nbsp;<a href="#14">[#14]</a></td></tr></table></td></tr><tr ><td class="posttext"> Fredborg replied.  I added GCEnter() to the start of all exposed functions, and it works perfectly now.  Thanks!<br><br>I sent an email to BRL about a dll license, so please just get back to me when you guys have time.<br><br>BlitzMax is really awesome. <br><br></td></tr></table><br>
<a name="bottom"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td align="right"><a href="http://monkeycoder.co.nz" target="_blank"><img src="/img/monkey2.svg" ></a> <a href="https://github.com/blitz-research" target="_blank"><img src="/img/github.svg" ></a> <a href="https://discord.gg/qJccbSp" target="_blank"><img src="/img/discord.svg" ></a></td></tr></table><br></div><br><table width="100%"><tr><td></body></html lang="en">
