<!DOCTYPE html><html lang="en" ><head ><title >Problem: BM1.26 and DX9-Module</title><meta name='viewport' content='width=device-width, initial-scale=0.66'><meta name='description' content='language:basic, target:desktop, category:game development'><link rel="styleSheet" href="../skins/granite/style.css" type="text/css"><style type="text/css">div.bbcode {padding: 8px;background: #E5E5E5;color: #000000;border: 1px dashed #B4B4BE;}</style></head><body ><table width=100% cellspacing=0 cellpadding=0><tr ><td class="menubarleft"></td><td class="menubar"><table cellspacing="0" cellpadding="0"><tr ><td >&nbsp;</td><td class="menuitemleft"></td><td class="menuitem"><a href="/" class="menuitem">News</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/forums.php" class="menuitem">Forums</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/codearcs.php" class="menuitem">Code</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/logs.php" class="menuitem">Logs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/gallery.php" class="menuitem">Gallery</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/sdkspecs.php" class="menuitem">Specs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/search.php" class="menuitem">Search</a></td><td class="menuitemright"></td></tr></table></td><td class="menubarright"></td></tr></table><div class="main"><h1 >Problem: BM1.26 and DX9-Module</h1><a href="forums.php" >BlitzMax Forums</a>/<a href="topics.php?forum=102" >BlitzMax Programming</a>/<a href="#bottom" >Problem: BM1.26 and DX9-Module</a><br><br>
<a name="824333"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Derron</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#1">[#1]</a></td></tr></table></td></tr><tr ><td class="posttext"> Like stated some weeks ago it's not possible to use the DX9-Module with BM1.26.<br><br>Although the source is able to compile it crashes with conflicts within the reflection-stuff of BM.<br><br>Did someone found a way to circumvent it?<br><br>---<br>Function TypeIdForTag:TTypeId( ty$ )<br>....<br>	For Local i=0 Until ar<br>---&gt;here&gt;		id=id.ArrayType()<br>	Next<br>---<br><br>I think the reflection module gets the exception because of an unknown 'type' within the DX9-module.<br><br><br>Hope this time some people (or minimum one ;D) may help me (and surely some others).<br><br><br>bye<br>MB <br><br></td></tr></table><br>
<a name="824504"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >dmaz</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#2">[#2]</a></td></tr></table></td></tr><tr ><td class="posttext"> I'm using Doug Stastny's dx9 includes without problems... <br><br></td></tr></table><br>
<a name="824515"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Derron</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#3">[#3]</a></td></tr></table></td></tr><tr ><td class="posttext"> With BM1.26?<br><br>Getting Reflection-Errors with it...<br><br>like the function quoted above (laying in brl/reflection-module).<br><br><br>Do you use Strict-Mode or "feel free to interpret my variables"-mode?<br><br><br>bye<br>MB <br><br></td></tr></table><br>
<a name="824517"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >dmaz</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#4">[#4]</a></td></tr></table></td></tr><tr ><td class="posttext"> yeah, I might have modified it, I'll check when I get home ( 5hr) <br><br></td></tr></table><br>
<a name="824557"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >DStastny</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#5">[#5]</a></td></tr></table></td></tr><tr ><td class="posttext"> Uncheck quick build and compile, that is probably the cause of your problems. <br><br></td></tr></table><br>
<a name="824587"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >dmaz</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#6">[#6]</a></td></tr></table></td></tr><tr ><td class="posttext"> yeah... it doesn't look like I made any code changes... but I did have an initial problem that you are seeing.  try what budman suggests...  also I know I compiled Dx9Max2dGraphicsDriver.bmx by itself and then I just import it. <br><br></td></tr></table><br>
<a name="824654"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Derron</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#7">[#7]</a></td></tr></table></td></tr><tr ><td class="posttext"> I'm using BMax for some years now ... so please imagine I tried without "quick build" enabled... it compiles fine but after loading my images I get a memory exception within the reflection module.<br><br>--- Ok, tried a bit... disabled reflection-cloning (seems they have trouble with TObjectList (code out of the code archives).<br><br>Now I have to go through the code to make it work with TRender (by indiepath I think) and DrawImageArea (modified by Grey Alien). <br>In the DX9-Module things like 'CreateSurface' are missing and I'll have to checkout what to do to make it working.<br><br><br>bye<br>MB <br><br></td></tr></table><br>
<a name="824701"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Derron</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#8">[#8]</a></td></tr></table></td></tr><tr ><td class="posttext"> Ok ... after disabling some functions to test it (to circumvent the tobjectlist) the next problem was the <br>drawImageArea-function... no big issue to make it work.<br><br>The RenderToTexture-Thingy by indiepath made my brains cook in their own soup.<br>I managed it to create surfaces and so on ... then when no more errors directly occoured the next thing making the debugger throwing something were all DrawText-commands ... and so on ...<br><br>So each problem I thought to have solved was chained to another, new, problem. The conclusion is : my changes to the RTT-code were not the correct/needed ones.<br><br><br>Someone having RTT with DX9 running and willed to share the source?<br><br><br>bye<br>MB <br><br></td></tr></table><br>
<a name="824927"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Derron</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#9">[#9]</a></td></tr></table></td></tr><tr ><td class="posttext"> Hmm ... disabled/converted all TObjectList-Types to normal TList and it still crashes when using DX9.<br><br>It crashes when evaluating my individual types... calling for example:<br><br><pre class=code>
	Method CloneProgramme:TProgramme(_Programme:TProgramme) 
		Local typ:TTypeId = TTypeId.ForObject(TProgramme(_Programme)) 
		Local clone:TProgramme = New TProgramme
		For Local t:TField = EachIn typ.EnumFields() 
			t.Set(clone, t.Get(_Programme)) 
		Next
		TProgramme(clone).clone = 1
		ProgList.AddLast(clone) 
		Return clone
   End Method
</pre><br><br>Makes it crashing on:<br>'local typ:TTypeId = TTypeId.ForObject(_Programme)' <br>(with or without strictly casting it to TProgramme makes no difference).<br><br>Same goes for all "clone functions" i wrote within this application ... Disabling the first, makes it crash on the second and so on.<br><br>Some ideas?<br><br><br>bye<br>MB <br><br></td></tr></table><br>
<a name="824946"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >dmaz</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#10">[#10]</a></td></tr></table></td></tr><tr ><td class="posttext"> I know you don't have to do all of that..<br>try this, it's already compiles so just do <br><pre class=code>
Import "dx9tests\Dx9Max2dDriver\Dx9Max2dGraphicsDriver.bmx"
</pre><br><a href="http://www.ooeyug.com/files/dx9tests.rar" target="_blank">http://www.ooeyug.com/files/dx9tests.rar</a><br><br>is that code different than what you have? <br><br></td></tr></table><br>
<a name="824977"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Derron</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#11">[#11]</a></td></tr></table></td></tr><tr ><td class="posttext"> Did a full recompile (no quick-mode) and still no changes...still crashing with memory exception.<br><br>The code is the same like the one I use.<br><br>bye<br>MB <br><br></td></tr></table><br>
<a name="824982"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >DStastny</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#12">[#12]</a></td></tr></table></td></tr><tr ><td class="posttext"> Michael,<br><br>I dont think the problem is with the Dx9 import(its not a module) as it doesnt do anything fancy in regards to manipulations in Max its pretty straight forward code.  Now there seems to be some references to you to other code such as RTT and TObjectLists. <br><br>So lets examine your problem from that perepsectve.  Does the sample program that I provided in the archive compile and run?  If you are mixing the RTT code by Inidiepath did you actually translate all the dx7 portions of his code to dx9?  I am more than sure you can make it compile unmodified but its not going to work as it has no clue about the dx9 code.  Things like createsurface you re referencing are specific to the dx7 implmentation.<br><br>My Dx9 Driver implments BlitzMax Graphics commands it does not attempt to mimic DirectX7 or the Directx7 implmentation although some areas as far as windows managment etc are simliar due to nature of the Graphics architecture in Max.  <br><br>I will be more than willing to help you debug issues with the Directx9 driver.  I wont however debug other peoples customizations to it.  It is designed to provide a Dx9 Max2d driver for hardware that supports dx9.<br><br>If you can post a simple sample that does not compile that just imports the dx9 driver, post it and I will reload BlitzMax and update it to 1.26 and take a look at it.<br><br>Take a step back with your program.  Just write the simplest thing then start adding what you think might be cause of problem.  I am pretty sure its not the driver,  but there might be something....<br><br>Doug Stastny <br><br></td></tr></table><br>
<a name="824984"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Derron</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#13">[#13]</a></td></tr></table></td></tr><tr ><td class="posttext"> OK... smallest thing crashing reflection using the dx9-'module'.<br><br>1) open the file <b>Dx9Test.bmx</b> (from your hdd or from the attachment of dmaz' posting)<br>2) add to '<b>Type TParticle</b>'<br><pre class=code>
	Method Clone:TParticle() 
		Local typ:TTypeId = TTypeId.ForObject(Self) 
		Local clone:TParticle = TParticle.Create()
		For Local t:TField = EachIn typ.EnumFields() 
			t.Set(clone, t.Get(Self)) 
		Next
		Return clone
   End Method
</pre><br><br>3) in '<b>Function CreateFirework(Image:TImage, posX:Float, posY:Float)</b>' add:<br><pre class=code>
			sp.clone()
</pre><br><br>before the functions end:<br><pre class=code>
	
		Next
	End Function
</pre><br><br><br>When now compiling everything will work - but when clicking the left mouse button it will throw an exception within the reflection module.<br><br>And remember - this only happens when using DX9 - OGL and DX7 work fine - so I can imagine that the calls within the clone-method and something within your (budman) code makes BMax a bit crazy ;D.<br><br><br>bye<br>MB<br><br>ps: I know that it is not the perfect example ... the cloning may crash the app AFTER the particle lifetime expires (image NULLed) ... but it crashes when accessing TTypeID.ForObject() <br><br></td></tr></table><br>
<a name="825020"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >DStastny</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#14">[#14]</a></td></tr></table></td></tr><tr ><td class="posttext"> @MichaelB<br><br>Thanks for example.  Good news is I duplicated and found your problem.<br><br>Bad news is it looks like a bug in the reflection code. For some reason it does not seem to like arrays of Types that are of Iunknown.  The Dx9 driver uses this to minimize state changes and manages this with an array of <br><br>_BlendStateBlocks: IDirect3DStateBlock9[6]<br><br>It is evaluating this that is causing the reflection to choke best I can tell with 5 minute debug.<br><br>Seems like first time you call type of it scans all the types in the program and builds a list.  When processing the dx9drive it chokes on the _BlendStateBlocks in the array handling code.<br><br><br>I am going out with wife and kids tonight, but I'll see if I can find some time to create and example bare minumum with out directx9 to demonstrate bug to mark and hopefully he can fix.<br><br>Doug Stastny <br><br></td></tr></table><br>
<a name="825023"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >DStastny</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#15">[#15]</a></td></tr></table></td></tr><tr ><td class="posttext"> Here ya go here is the bug<br><br><pre class=code>
Strict

Extern "Win32"
Type IDirect3DStateBlock9 Extends IUnknown
	Method GetDevice(ppDevice: IDirect3DDevice9 Var)
    Method Capture()
    Method Apply()

End Type
End Extern


Type TFoo
'	Field _BlendStateBlocks: IDirect3DStateBlock9[6] ' crash
	Field unk : IUnknown[6] ' crash
	'Field _BlendStateBlock: IDirect3DStateBlock9   ' no crash
End Type
  


Local foo:TFoo= New TFoo
Local typ:TTypeId = TTypeId.ForObject(foo)
Print typ.Name()
</pre><br><br>It seems Reflection does not like types derived from IUnknown when they are in an array.<br><br>Doug Stastny <br><br></td></tr></table><br>
<a name="825036"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Dreamora</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#16">[#16]</a></td></tr></table></td></tr><tr ><td class="posttext"> Reflection most likely does not like to operate on non BM data (ie not managed code).<br>This means no pointer and no extern. Especially the later can not be reflected, they are no BM classes at all (you can not extend them as well) <br><br></td></tr></table><br>
<a name="825144"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >DStastny</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#17">[#17]</a></td></tr></table></td></tr><tr ><td class="posttext"> @MichealB<br><br>Mark has posted that its fixed in next update.  Sorry youll have to wait.<br><br>Doug Stastny <br><br></td></tr></table><br>
<a name="825171"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Derron</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#18">[#18]</a></td></tr></table></td></tr><tr ><td class="posttext"> Hmm.. Okay... we will have to see... thanks for your engagement.<br><br>So it seems I spend some useless hours full of sweat and boredom (manual refactoring to convert back to normal lists).<br><br><br>@dreamora: do you know a way to manually enable reflection to 'unknown code' (like added meta-tags)? Or a way (without modifying brl-code) to disable the reflection-scan on certain types ?<br><br><br>bye<br>MB <br><br></td></tr></table><br>
<a name="825485"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Dreamora</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#19">[#19]</a></td></tr></table></td></tr><tr ><td class="posttext"> So far, I don't know a way, sorry Michael.<br>perhaps there is a noReflection tag for classes similar to the noDebug for functions (which you never want to be debug compiled like math heavy functions or loop monsters you are sure they are correct)<br><br>What do you mean with:<br><div class="quote"> <br>do you know a way to manually enable reflection to 'unknown code' (like added meta-tags)? <br></div><br><br>Do you have an example? do not really understand what you mean. <br><br></td></tr></table><br>
<a name="825523"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Derron</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#20">[#20]</a></td></tr></table></td></tr><tr ><td class="posttext"> You know meta-tags and it could have been that there is a way to manually assign "base types" to certain variables to make reflection work.<br><br>--- in German for Dreamora only ---<br>Ich wollte wissen, ob es moeglich ist einem unbekannten Typ eine Basisklasse als Meta-Tag beizufuegen um somit die Reflection-Sache zum Laufen zu bekommen. Schaetze aber mal das geht nicht, denn wenn man wuesste welcher Typ da zu erwarten waere, koennte man ihn auch nutzen.<br>---<br><br>Sorry for the German words, but this way I think Dreamora will understand my post much better (both native German-speakers).<br><br>bye<br>MB <br><br></td></tr></table><br>
<a name="825583"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Dreamora</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#21">[#21]</a></td></tr></table></td></tr><tr ><td class="posttext"> There is actually no unknown type.<br>Anything with reflection is extended from Object and therefor you can reflect it if you want to.<br><br>So basically you can add data (like a name or even meta tag if you want to) to your classes and to do reflection on that, use the TTypeID capabilities from a string (-&gt; your meta data) to reflect it.<br><br>I hope this is what you meant. Missusing reflection for Java like Interfacing ;-) <br><br></td></tr></table><br>
<a name="825675"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Derron</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#22">[#22]</a></td></tr></table></td></tr><tr ><td class="posttext"> I wanted to know that to bring the dx9-thing back to life when using reflection... <br><br>So not another way to get names of variables - only a way to  learn reflection "my" new types/functions.<br><br><br>bye<br>MB <br><br></td></tr></table><br>
<a name="825679"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Dreamora</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#23">[#23]</a></td></tr></table></td></tr><tr ><td class="posttext"> reflection must not learn anything. If the type is there it already knows the type and all of its fields, globals etc. No need to make it aware of anything.<br><br>Only exception is extern and ptr. They can not be used at the moment. This has not much to do with beeing aware or not.<br>Its more due to the fact that they do not extend object (extended Types can not be extended in BM!) nor are they one of the core types (numerics, string or array), at least thats my assumption for the cause of the reflection problem. So they simply never exist within the running applications actually as objects or core class.<br>But Mark mentioned that this is fixed, so with 1.28 it should work.<br><br><br>If this is still not the right thing an example of what you want to achieve and that does not work (ie a simple use case).<br><br>PS: I hope your planning does not involve using reflection on anything speed critical. That actually would cause some serious issues to your project <br><br></td></tr></table><br>
<a name="825720"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Derron</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#24">[#24]</a></td></tr></table></td></tr><tr ><td class="posttext"> No the reflection is mostly needed when saving/loading takes place or when eg. a user clicks the mouse (eg. buying a movie/series in the "movies agency" (may be you know the game MadTV)). No no speed issue at all ... only readability and easy maintenance.<br><br>Hope 1.28 isn't delayed too much.<br><br><br>bye<br>MB <br><br></td></tr></table><br>
<a name="bottom"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td align="right"><a href="http://monkeycoder.co.nz" target="_blank"><img src="/img/monkey2.svg" ></a> <a href="https://github.com/blitz-research" target="_blank"><img src="/img/github.svg" ></a> <a href="https://discord.gg/qJccbSp" target="_blank"><img src="/img/discord.svg" ></a></td></tr></table><br></div><br><table width="100%"><tr><td></body></html lang="en">
