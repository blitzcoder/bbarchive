<!DOCTYPE html><html lang="en" ><head ><title >Problems with windows lock and loadimage</title><meta name='viewport' content='width=device-width, initial-scale=0.66'><meta name='description' content='language:basic, target:desktop, category:game development'><link rel="styleSheet" href="../skins/granite/style.css" type="text/css"><style type="text/css">div.bbcode {padding: 8px;background: #E5E5E5;color: #000000;border: 1px dashed #B4B4BE;}</style></head><body ><table width=100% cellspacing=0 cellpadding=0><tr ><td class="menubarleft"></td><td class="menubar"><table cellspacing="0" cellpadding="0"><tr ><td >&nbsp;</td><td class="menuitemleft"></td><td class="menuitem"><a href="/" class="menuitem">News</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/forums.php" class="menuitem">Forums</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/codearcs.php" class="menuitem">Code</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/logs.php" class="menuitem">Logs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/gallery.php" class="menuitem">Gallery</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/sdkspecs.php" class="menuitem">Specs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/search.php" class="menuitem">Search</a></td><td class="menuitemright"></td></tr></table></td><td class="menubarright"></td></tr></table><div class="main"><h1 >Problems with windows lock and loadimage</h1><a href="forums.php" >BlitzMax Forums</a>/<a href="topics.php?forum=102" >BlitzMax Programming</a>/<a href="#bottom" >Problems with windows lock and loadimage</a><br><br>
<a name="912872"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Josepho</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#1">[#1]</a></td></tr></table></td></tr><tr ><td class="posttext"> My game crashes when i load images while i have my windows locked. I use the directx7 driver, is this a bug? can i fix it? <br><br></td></tr></table><br>
<a name="912890"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >MGE</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#2">[#2]</a></td></tr></table></td></tr><tr ><td class="posttext"> Post some code that does the same thing so we call can have a look and verify the problem. <br><br></td></tr></table><br>
<a name="913043"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Josepho</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#3">[#3]</a></td></tr></table></td></tr><tr ><td class="posttext"> Graphics (800,600,0,0)<br><br>Repeat<br>Until KeyHit(KEY_ESCAPE)<br><br>Global i:Int<br>Global image:timage<br>Repeat<br>	i:+1<br>	Print i<br>	image=LoadImage("image.png")<br>Until i&gt;10000<br><br><br><br>Repeat<br><br>	Cls<br>	DrawImage(image,10,10)<br>	Flip<br>	<br>Until KeyHit(KEY_ESCAPE)<br><br>If you are in windows vista press the windows key and L during the second repeat iand the game will crash. How can i fix this? :( <br><br></td></tr></table><br>
<a name="913517"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Josepho</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#4">[#4]</a></td></tr></table></td></tr><tr ><td class="posttext"> No replies? Anybody knows how can i fix this? Its important! If you want to test it, "image.png" can be any png file that you want <br><br></td></tr></table><br>
<a name="913521"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Zeke</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#5">[#5]</a></td></tr></table></td></tr><tr ><td class="posttext"> works fine here. tested twice and app is running well when windows is locked.<br><br>Vista 32-bit Home Premium<br>Radeon HD 3650 <br><br></td></tr></table><br>
<a name="913530"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >grable</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#6">[#6]</a></td></tr></table></td></tr><tr ><td class="posttext"> Works fine here too, and im running Windows XP. <br><br></td></tr></table><br>
<a name="913613"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Josepho</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#7">[#7]</a></td></tr></table></td></tr><tr ><td class="posttext"> Maybe you need to try to change the 10000 to a higher number, or maybe the kind of png that im using is part of the problem. You can download it here<br><br><img src="http://www.questtracers.com/tests/no.png"> <br><br></td></tr></table><br>
<a name="913707"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Uncle</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#8">[#8]</a></td></tr></table></td></tr><tr ><td class="posttext"> Works fine here as well with the png you supplied.  I find it odd though that you would want to load 10,000 images.  Does your application really need that many? <br><br></td></tr></table><br>
<a name="913719"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Josepho</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#9">[#9]</a></td></tr></table></td></tr><tr ><td class="posttext"> No, this is just an example code that has the same crash of my project, my project loads a lot of diferent images but when i make windows+L during the image load it crashes -_-. I dont know what im making wrong, i know that my application crashes in other pcs too, am i missing something that i have to do in blitzmax? <br><br></td></tr></table><br>
<a name="913974"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Josepho</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#10">[#10]</a></td></tr></table></td></tr><tr ><td class="posttext"> Anybody knows anything about it? Its very urgent <br><br></td></tr></table><br>
<a name="913977"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Perturbatio</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#11">[#11]</a></td></tr></table></td></tr><tr ><td class="posttext"> Are you compiling in debug mode? if so, what error does it give?<br><br>How much RAM is in your computer?<br>what version graphics driver are you using? <br><br></td></tr></table><br>
<a name="913980"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >MGE</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#12">[#12]</a></td></tr></table></td></tr><tr ><td class="posttext"> I dont have vista, but have you tried something like this, but is the app suspended during a lock?<br><br>Repeat<br>If AppSuspended()<br> DoPause()<br>End If<br>Cls<br>DrawImage(image,10,10)<br>Flip(1) ' always use flip 1!<br>Until KeyHit(KEY_ESCAPE)<br>'<br>Function DoPause()<br>While AppSuspended()<br> ' Do something here<br>Wend<br>End Function <br><br></td></tr></table><br>
<a name="913983"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >tonyg</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#13">[#13]</a></td></tr></table></td></tr><tr ><td class="posttext"> What is the memory usage during the image load? Does the crash always occur on the same number or depending on when you lock?<br>When you say 'Crash' what exactly happens?<br>When you say 'Project' do you mean a Bmax project? Which IDE are you using? Does the problem occur with IDE version and .exe?<br>When did the problem start and how did you first notice it? What might have changed since you ran it?<br>How about posting the *real* code or .exe so people can be sure they are replicating the same thing? <br><br></td></tr></table><br>
<a name="914000"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Josepho</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#14">[#14]</a></td></tr></table></td></tr><tr ><td class="posttext"> The bug was reported by a QA team while they were testing my project, it always happens when you block windows while a load script of graphics. When I say crash, i mean that the program terminates with an error. I cant post the exe of the game, but the code that i posted shows the same error when i block windows.<br><br>Perturbatio I dont think that my ram affects to the bug because the bug was reported by other people, i use the dx7 driver of blitzmax, the one who comes with the 1.30 version.<br><br>MGE, yup, when you press windows L the app is suspended, i donno if your code will help, but i know that the program crashes when its loading the images, i made that the program stop loading when it was suspended but if i do that, then shows an unexpected error that i thing that is that he try to draw an image that is loaded badly. I use flip without the 1, can this be the problem?<br><br>Tonyg the memory usage seems to not affect because the bug happens when i run my code with any kind of png. It always happens when i press windows L and im loading images, no matter which number or what kind of images. Im using the official IDE. <br><br></td></tr></table><br>
<a name="914009"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >tonyg</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#15">[#15]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote">  When I say crash, i mean that the program terminates with an error.   <br></div><br><div class="quote">  but the code that i posted shows the same error when i block windows.  <br></div><br>What is the error? <br>How is the loadimage loop involved and what is the significance of changing the loop count? What is the memory used after the loadimage loop? Does the problem occur with 1000 loadimage loop for any type of png used or will it change depending on image size?<br>If the example code is not a true reflection of your project then what processing does your project do?<br>What, exactly, happens when you press windows+L?<br>What are the machine specs and OS type of failing and working machines? <br><br></td></tr></table><br>
<a name="914056"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Josepho</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#16">[#16]</a></td></tr></table></td></tr><tr ><td class="posttext"> This is the error "Create DX7 surface Failed"<br><br>The code of the project is not a loadimage loop, is a lot of loadimages of diferent images<br><br>image=LoadImage("image.png")<br>image2=LoadImage("image2.png")<br>image3=LoadImage("image3.png")<br>image4=LoadImage("image4.png")<br>image5=LoadImage("image5.png")<br>image6=LoadImage("image6.png")<br>image7=LoadImage("image7.png")<br>....<br><br>In the code that i posted it crashes with all the pngs that i have tried. My pc is a win vista, dual core with a geforce 8600 gt, the qa team reported that it happens in all windows, and i dont know what are the specs of the qa team computers. When you press windows+L the windows is bloqued and it seems that the game crashes when he tries to store the graphic in data, if you stop the loading and you try loading the data after the game shows lots of graphic glitches. <br><br></td></tr></table><br>
<a name="914061"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >tonyg</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#17">[#17]</a></td></tr></table></td></tr><tr ><td class="posttext"> I wonder if this is another symptom of the screensaver issue. That problem was fixed in 1.24 but maybe this particular symptom was overlooked. <br><br></td></tr></table><br>
<a name="914064"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Josepho</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#18">[#18]</a></td></tr></table></td></tr><tr ><td class="posttext"> So, wich can be the solution? Waiting for a new bug fix? :S <br><br></td></tr></table><br>
<a name="914070"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >tonyg</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#19">[#19]</a></td></tr></table></td></tr><tr ><td class="posttext"> Probably. You might consider adding some debug statements to TD3D7GraphicsDriver createsurface method in d3d7graphics module to get the DX return code which might help narrow the problem down. Otherwise you should find some pattern in the failing machines, the smaller code which fails and post it as a bug. <br><br></td></tr></table><br>
<a name="914107"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >MGE</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#20">[#20]</a></td></tr></table></td></tr><tr ><td class="posttext"> "MGE, yup, when you press windows L the app is suspended, i donno if your code will help"<br><br>Try my code and see if it fixes your problem. You can't render if your app "loses the primary surface" which is what happens for instance in a full screen game and you minimize or go back to the desktop. You will get an error if you try to render. Internally Blitzmax will reset the surfaces, etc, etc. Never render while the app is in AppSuspend mode. <br><br></td></tr></table><br>
<a name="914160"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Tommo</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#21">[#21]</a></td></tr></table></td></tr><tr ><td class="posttext"> It's because max2ddriver lose its d3d7device when you lock windows, so the max2d is using a null device when drawImage occurs.<br>The solution is use a setgraphics before rendering. Just like:<br><pre class=code>
Local dx7gfx:TGraphics = Graphics (800, 600, 0, 0) 'get the TGraphics

Repeat
Until KeyHit(KEY_ESCAPE)

Global i:Int
Global image:timage

Repeat
i:+1
Print i

image = LoadImage("image.png")
Until i &gt; 100

Repeat
SetGraphics(dx7gfx)  'SetGraphics will reset the device.
Cls
DrawImage(image, 10, 10)
Flip

Until KeyHit(KEY_ESCAPE)
</pre> <br><br></td></tr></table><br>
<a name="914171"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >MGE</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#22">[#22]</a></td></tr></table></td></tr><tr ><td class="posttext"> I still think just checking for an app suspended will work. <br><br></td></tr></table><br>
<a name="914182"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Tommo</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#23">[#23]</a></td></tr></table></td></tr><tr ><td class="posttext"> I tried suspend checking, under my XP, the example still crashed.<br>In Josepho's case, the problem happens when windows get locked while loading image, somehow driver lose its device(maybe the KILL_FOCUS event is not posted or not captured by bmx graphics driver, which is connected to driver's validating). <br><br></td></tr></table><br>
<a name="914186"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >MGE</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#24">[#24]</a></td></tr></table></td></tr><tr ><td class="posttext"> Thanks Tommo, that's very useful info. If Locking reports an app suspended, could you tie that into the image load section as well? Only loading if app is not suspended? <br><br></td></tr></table><br>
<a name="914323"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Josepho</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#25">[#25]</a></td></tr></table></td></tr><tr ><td class="posttext"> I found a solution for the problem<br><br><pre class=code>
Function DIsValid()
	TD3D7Max2DDriver(_max2dDriver).Flip(1)
	If TD3D7Max2DDriver(_max2dDriver).isvalid()
		Return True
	Else
		driverValid=False
		Return False
	EndIf
EndFunction
</pre><br><br>This function updates the driver state and tells me if the device is lost.<br>And this in the load script<br><br><pre class=code>
Repeat

If Not(driverValid) Then TD3D7Max2DDriver(_max2dDriver).ResetD3DDevice(TMax2DGraphics.Current())

driverValid=True

If DIsValid() Then image=LoadImage("image.png")
If DIsValid() Then image=LoadImage("image2.png")
If DIsValid() Then image=LoadImage("image3.png")
If DIsValid() Then image=LoadImage("image4.png")
...

Until driverValid=True

</pre><br><br>The bug makes that the driver lose textures so i detect if the driver has been losed on the loading and i repeat the load if it needs. I reset the driver if the device has been lost too at the beginning of the load script.<br><br>This fix works perfect for me :D. <br><br></td></tr></table><br>
<a name="914380"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >MGE</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#26">[#26]</a></td></tr></table></td></tr><tr ><td class="posttext"> "so i detect if the driver has been losed on the loading and i repeat the load if it needs."<br><br>hmm... I'm not sure this is a stable solution because technically in a full screen game when the user presses the "Windows key" and it goes back to the desktop, the device is lost and Bmax automatically resets the device when switching back to full screen, all textures remain without having to load them again. Blitzmax uses managed textures so D3D pulls them from ram to vram as needed.<br><br>I still think the proper solution is to do "nothing" if the app detects it is suspended. Since locking does apparently return an app suspended flag this should be doable. I really don't think you should have to tap into the device lost flag, because you may actually be loading new surfaces (textures) without them being cleared from sram or vram.<br><br>At the least, if you stick with your current idea, you should remove ALL of the textures (set them to Null and do a GC() and load ALL of them again. <br><br>I would try something like this instead.....<br><pre class=code>
counter = 0
totalimages=100
Repeat
 If AppSuspended()
  While AppSuspended()
    Delay(100)
   Wend
 EndIf
 counter = counter + 1
 image(counter)=LoadImage("image" + counter + ".png")
Until counter=totalimages
</pre> <br><br></td></tr></table><br>
<a name="bottom"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td align="right"><a href="http://monkeycoder.co.nz" target="_blank"><img src="/img/monkey2.svg" ></a> <a href="https://github.com/blitz-research" target="_blank"><img src="/img/github.svg" ></a> <a href="https://discord.gg/qJccbSp" target="_blank"><img src="/img/discord.svg" ></a></td></tr></table><br></div><br><table width="100%"><tr><td></body></html lang="en">
