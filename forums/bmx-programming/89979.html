<!DOCTYPE html><html lang="en" ><head ><title >Communicating between threads</title><meta name='viewport' content='width=device-width, initial-scale=0.66'><meta name='description' content='language:basic, target:desktop, category:game development'><link rel="styleSheet" href="../skins/granite/style.css" type="text/css"><style type="text/css">div.bbcode {padding: 8px;background: #E5E5E5;color: #000000;border: 1px dashed #B4B4BE;}</style></head><body ><table width=100% cellspacing=0 cellpadding=0><tr ><td class="menubarleft"></td><td class="menubar"><table cellspacing="0" cellpadding="0"><tr ><td >&nbsp;</td><td class="menuitemleft"></td><td class="menuitem"><a href="/" class="menuitem">News</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/forums.php" class="menuitem">Forums</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/codearcs.php" class="menuitem">Code</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/logs.php" class="menuitem">Logs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/gallery.php" class="menuitem">Gallery</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/sdkspecs.php" class="menuitem">Specs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/search.php" class="menuitem">Search</a></td><td class="menuitemright"></td></tr></table></td><td class="menubarright"></td></tr></table><div class="main"><h1 >Communicating between threads</h1><a href="forums.php" >BlitzMax Forums</a>/<a href="topics.php?forum=102" >BlitzMax Programming</a>/<a href="#bottom" >Communicating between threads</a><br><br>
<a name="1022522"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Who was John Galt?</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#1">[#1]</a></td></tr></table></td></tr><tr ><td class="posttext"> Can somebody give me an idea how to communicate information between separate threads?<br><br>I have one function that I am using as a callback from another program (fmod, to be precise). I need to communicate variables from my main application to modify the output it produces.<br><br>The problem is that the callback can't see any of my program's global variables. I have tried enabling the threaded build but haven't specifically done anything with the thread.<br><br>In short,<br>1) Is what I'm seeing wrt global variables what you expect?<br>2) How to get around it.<br><br>Thanks <br><br></td></tr></table><br>
<a name="1022531"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >ima747</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#2">[#2]</a></td></tr></table></td></tr><tr ><td class="posttext"> What exactly do you mean by it can't see any of your program's global variables? do they have null values, does it not compile? <br><br></td></tr></table><br>
<a name="1022537"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >_Skully</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#3">[#3]</a></td></tr></table></td></tr><tr ><td class="posttext"> I recall that you have to pass objects only...<br><br>implementation I'm clueless about ;) <br><br></td></tr></table><br>
<a name="1022544"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rozek</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#4">[#4]</a></td></tr></table></td></tr><tr ><td class="posttext"> Hmmm,<br><br>my problem is that I don't exactly know what "fmod" is...but, in principle, threads share the same memory context, thus, you should be able to access global variables from within every thread (btw., that's the reason why you have to "synchronize" accesses to these "shared variables"). Otherwise, I would not understand, why your BlitzMAX function can be invoked, but can't handle it's own variables (and globals) (despite the differences between link space, heap and stack)<br><br>Just as a side note: do not mix up "threads" and "callbacks" - you may use "callbacks" without using threads! (but, of course, "fmod" might spawn threads internally)<br><br>I am using lots of BlitzMAX callbacks from within Lua and accessing all types of data from within them without the slightest problem! <br><br></td></tr></table><br>
<a name="1022546"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Who was John Galt?</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#5">[#5]</a></td></tr></table></td></tr><tr ><td class="posttext"> ima747- Sorry, I hadn't investigated fully. It appears that the callback function effectively takes a copy of any global variables at the time it is first called from the external API. After that, it sticks with those values even if I modify my global.<br><br>Skully... any links? I'm not sure how to apply what you're saying. <br><br></td></tr></table><br>
<a name="1022549"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Brucey</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#6">[#6]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> Just as a side note: do not mix up "threads" and "callbacks" - you may use "callbacks" without using threads! (but, of course, "fmod" might spawn threads internally) <br></div><br>Right, and in a single-threaded app, callbacks and the default GC work perfectly.<br><br>For something like FMOD, to use the callback system, you can't really do so with the default GC.<br><br>However, sharing variable values should "just work". Just be careful about accessing those values from different threads if the value is likely to change from a different thread. <br><br></td></tr></table><br>
<a name="1022557"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Who was John Galt?</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#7">[#7]</a></td></tr></table></td></tr><tr ><td class="posttext"> @Rozek-<br>Only saw your reply after my second post. FMOD is a sound API. I only mentioned that in passing in case it would help anyone who has used it. My working assumption is that fmod is using a separate thread and that's causing the problem. As I said, I have enabled threading in the build. I have not done anything to synchronise accesses to shared variables. What commands should I be looking at?<br><br>@Brucey-<br>Thanks. It's definitely attempts to change the shared variable that cause the problem. <br><br></td></tr></table><br>
<a name="1022590"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rozek</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#8">[#8]</a></td></tr></table></td></tr><tr ><td class="posttext"> John,<br><br>before offering "solutions" based on assumptions, let's check your assumption first!<br><br>Within your callback, add the following (untested!) code: <pre class=code>global ThreadDetected:int = false
if (not ThreadDetected and (currentThread() &lt;&gt; mainThread())) then
  debuglog("**** Callback was called from outside the MainStack! ****")
  ThreadDetected = true
end if</pre>You may also have to<pre class=code>import brl.Threads</pre>at the beginning of your program.<br><br>Now run your code and watch out for any output from your callback - this will show you if FMOD is *really* spawning threads (and invokes your callback from within one of them) <br><br></td></tr></table><br>
<a name="1022676"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Who was John Galt?</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#9">[#9]</a></td></tr></table></td></tr><tr ><td class="posttext"> Thanks Rozek...<br><br>Stranger and stranger... the callback is reporting that is is NOT a separate thread. Now I am seriously stumped. I know for a fact that after the function has been called from the external API, it ignores any changes to global variables made externally.<br><br>I have zero clue what could be causing the problem now. Any more ideas? <br><br></td></tr></table><br>
<a name="1022786"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rozek</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#10">[#10]</a></td></tr></table></td></tr><tr ><td class="posttext"> John,<br><br>try "debuglog" or similar to check the value of your globals before and after trying to set them - and check the values they should be set to!<br><br>Good luck hunting! (I know how difficult that may be!) <br><br></td></tr></table><br>
<a name="1022813"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Who was John Galt?</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#11">[#11]</a></td></tr></table></td></tr><tr ><td class="posttext"> Thanks, Rozek. Please look back occasionally. I'm out of my depth here. <br><br></td></tr></table><br>
<a name="1024129"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Who was John Galt?</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#12">[#12]</a></td></tr></table></td></tr><tr ><td class="posttext"> Well, one step forward, two steps back...<br><br>I was accidentally kicking fmod off in the wrong mode so the buffer was being looped but my callback was only being called once at startup to fill the buffer, hence all the issues about 'not seeing modified variables'. This would have been obvious if debuglog was working from in the callback.<br><br>Once I got past that, the program would keep crashing with SIGSEV or 'membit not set' errors, which smell of a GC issue, despite everything being in one thread and trying all the tricks suggested such as using GC enter and GC leave. The only working solution in the end was to not only write the callback in C, but also compile the application as multi-threaded.<br><br>It works now, but for some reason there is a latency of 2-3 seconds even though I have cut the streaming buffer length down to 0.25s. <br><br></td></tr></table><br>
<a name="bottom"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td align="right"><a href="http://monkeycoder.co.nz" target="_blank"><img src="/img/monkey2.svg" ></a> <a href="https://github.com/blitz-research" target="_blank"><img src="/img/github.svg" ></a> <a href="https://discord.gg/qJccbSp" target="_blank"><img src="/img/discord.svg" ></a></td></tr></table><br></div><br><table width="100%"><tr><td></body></html lang="en">
