<!DOCTYPE html><html lang="en" ><head ><title >Adding Virtual Resolution to Grey Alien Framework</title><meta name='viewport' content='width=device-width, initial-scale=0.66'><meta name='description' content='language:basic, target:desktop, category:game development'><link rel="styleSheet" href="../skins/granite/style.css" type="text/css"><style type="text/css">div.bbcode {padding: 8px;background: #E5E5E5;color: #000000;border: 1px dashed #B4B4BE;}</style></head><body ><table width=100% cellspacing=0 cellpadding=0><tr ><td class="menubarleft"></td><td class="menubar"><table cellspacing="0" cellpadding="0"><tr ><td >&nbsp;</td><td class="menuitemleft"></td><td class="menuitem"><a href="/" class="menuitem">News</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/forums.php" class="menuitem">Forums</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/codearcs.php" class="menuitem">Code</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/logs.php" class="menuitem">Logs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/gallery.php" class="menuitem">Gallery</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/sdkspecs.php" class="menuitem">Specs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/search.php" class="menuitem">Search</a></td><td class="menuitemright"></td></tr></table></td><td class="menubarright"></td></tr></table><div class="main"><h1 >Adding Virtual Resolution to Grey Alien Framework</h1><a href="forums.php" >BlitzMax Forums</a>/<a href="topics.php?forum=102" >BlitzMax Programming</a>/<a href="#bottom" >Adding Virtual Resolution to Grey Alien Framework</a><br><br>
<a name="1115710"></a>

<a name="1115711"></a>

<a name="1115712"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >therevills</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#1">[#1]</a></td></tr></table></td></tr><tr ><td class="posttext"> Hi All,<br><br>Just wondering apart from Jake has anyone added Virtual Resolution support to Grey Alien Framework (v1.11)?<br><br>If so could you please share your code?<br><br>I've started to add support for it based on this post:<br><a href="http://www.blitzbasic.com/Community/posts.php?topic=94408" target="_blank">http://www.blitzbasic.com/Community/posts.php?topic=94408</a><br><br>I've added this to Commoncode.bmx at line 144:<br><pre class=code>
Global WindowWidth:Int = 800
Global WindowHeight:Int = 600
Global VirtualRatioX:Float
Global VirtualRatioY:Float
Global UsingVirtualResolution:Int = 0
</pre><br><br>Then in CommonTypes.bmx:<br><br>TGame.GraphicsCreate after the If FirstTime statement (Line 858):<br><br><textarea class=codebox name="code" wrap=OFF readonly="true" rows="15" cols="80">
		'Detect best Window Size
        DebugInt = 11301
        Const MAX_RESOLUTIONS:Int = 3
        Local ResolutionX:Int[MAX_RESOLUTIONS]
        Local ResolutionY:Int[MAX_RESOLUTIONS]
        ResolutionX[0] = 640
        ResolutionY[0] = 480
        ResolutionX[1] = 800
        ResolutionY[1] = 600
        ResolutionX[2] = 1024
        ResolutionY[2] = 768

        WindowWidth = ScreenWidth
        WindowHeight = ScreenHeight
       
        'Loop back through resolutions until we get one that fits.
        Local resToTest:Int = MAX_RESOLUTIONS - 1
        Local found:Int = 1
        Local comparisonHeight:Int = DesktopHeight
       
        'For Windowed mode we need to take into account the Window title bar, so reduce the comparisonHeight by a big title bar height.
        If FullScreen = 0 Then
            comparisonHeight:-30
        EndIf
       
        While comparisonHeight &lt; WindowHeight
            'Did we fail?
            If resToTest &lt; 0 Then
                found = 0
                Exit
            EndIf

            DebugInt = 11302
            WindowWidth = ResolutionX[resToTest]
            WindowHeight = ResolutionY[resToTest]
            resToTest:-1
        Wend
                   
        DebugInt = 11303
        If found = 0
            DebugInt = 11304
            RuntimeError "Cannot find a suitable resolution. Desktop Resolution= " + DesktopWidth + "x" + DesktopHeight;End
            Depth = -1 'failed
        End If
		
		DebugLog "WindowWidth  = " + WindowWidth
		DebugLog "WindowHeight = " + WindowHeight
</textarea><br><br>Then change all the Graphics commands to use WindowWidth and WindowHeight instead of ScreenWidth and ScreenHeight eg:<br><br><pre class=code>
			If GraphicsModeExists(WindowWidth, WindowHeight, 32) Then
				OK = Graphics(WindowWidth, WindowHeight, 32, Hertz)
				Depth = 32
			EndIf
</pre><br><br>Then right at the bottom of TGame.GraphicsCreate:<br><pre class=code>
DoSetVirtualResolution()
</pre><br><br>and add DoSetVirtualResolution() to TGame:<br><pre class=code>
	Method DoSetVirtualResolution()
		If ScreenWidth &lt;&gt; WindowWidth Then
			SetVirtualResolution(ScreenWidth, ScreenHeight)
			VirtualRatioX = ScreenWidth / Float(WindowWidth)
			VirtualRatioY = ScreenHeight / Float(WindowHeight)
			UsingVirtualResolution = 1
		End If
	End Method
</pre><br><br>So I've done all this and having issue with the mouse stuff...<br><br>I added this to TMousePointer.UpdateCoords:<br><br><pre class=code>
		If pt &lt;&gt; Null Then
			'Use client area position so we can see if the cursor is outside of window.
			Game.SetClientCoords() 'Need this in case window has been dragged as drag code doesn't alway set it soon enough.
			If UsingVirtualResolution Then
				x = (pt.x - Game.ClientX) * VirtualRatioX
				y = (pt.y - Game.ClientY) * VirtualRatioY
			Else
				x = pt.x - Game.ClientX
				y = pt.y - Game.ClientY
			EndIf
		EndIf
</pre><br><br>But this messes up the Menu mouse overlaps...<br><br><font class="tiny">Last edited 2011</font><br><br><font class="tiny">Last edited 2011</font> <br><br></td></tr></table><br>
<a name="1115714"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >therevills</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#2">[#2]</a></td></tr></table></td></tr><tr ><td class="posttext"> Okay...<br><br>Not sure why but GAF sets Mouse.X and Mouse.Y in TMousePointer.UpdateCoords and TGame.DoPeekEvent, so I've added the ratio stuff there too:<br><br><pre class=code>
			Case EVENT_MOUSEMOVE
			
				If UsingVirtualResolution Then
					Mouse.X = EventX() * VirtualRatioX
					Mouse.Y = EventY() * VirtualRatioY
				Else
					Mouse.X = EventX()
					Mouse.Y = EventY()			
				End If
</pre><br><br>Is there anything else I need to be aware of with the Virtual Resolution setting in GAF?<br><br>Thanks! <br><br></td></tr></table><br>
<a name="1115715"></a>

<a name="1115716"></a>

<a name="1115717"></a>

<a name="1115720"></a>

<a name="1115721"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >therevills</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#3">[#3]</a></td></tr></table></td></tr><tr ><td class="posttext"> Hmmm strange...<br><br>I changed my screen resolution to 800x600 and ran this code:<br><br><textarea class=codebox name="code" wrap=OFF readonly="true" rows="15" cols="80">
Global ScreenWidth% = 1024
Global ScreenHeight% = 768

Global WindowWidth% = 640
Global WindowHeight% = 480


Const MAX_RESOLUTIONS:Int = 3
Local ResolutionX:Int[MAX_RESOLUTIONS]
Local ResolutionY:Int[MAX_RESOLUTIONS]
ResolutionX[0] = 640
ResolutionY[0] = 480
ResolutionX[1] = 800
ResolutionY[1] = 600
ResolutionX[2] = 1024
ResolutionY[2] = 768

WindowWidth = ScreenWidth
WindowHeight = ScreenHeight

'Loop back through resolutions until we get one that fits.
Local resToTest:Int = MAX_RESOLUTIONS - 1
Local found:Int = 1
Local comparisonHeight:Int = DesktopHeight()

'For Windowed mode we need to take into account the Window title bar, so reduce the comparisonHeight by a big title bar height.
If FullScreen = 0 Then
	   comparisonHeight:-30
EndIf

While comparisonHeight &lt; WindowHeight
	   'Did we fail?
	   If resToTest &lt; 0 Then
	       found = 0
	       Exit
	   EndIf
	   WindowWidth = ResolutionX[resToTest]
	   WindowHeight = ResolutionY[resToTest]
	   resToTest:-1
Wend

If found = 0
	   RuntimeError "Cannot find a suitable resolution. Desktop Resolution= " + DesktopWidth() + "x" + DesktopHeight();End
End If

DebugLog "WindowWidth  = " + WindowWidth
DebugLog "WindowHeight = " + WindowHeight

Graphics WindowWidth , WindowHeight, 32
SetVirtualResolution(ScreenWidth, ScreenHeight)

Repeat
	Cls
	DrawLine 0, 0, ScreenWidth, ScreenHeight
	SetScale 2,2
	DrawText "m  = "+MouseX() +" , "+MouseY(), 10, 10
	DrawText "vm = "+VirtualMouseX() +" , "+VirtualMouseY(), 10, 30
	DrawText "Screen = "+ScreenWidth+","+ScreenHeight, 10, 60
	DrawText "Window = "+WindowWidth +","+WindowHeight, 10, 90
	SetScale 1,1
	Flip
Until AppTerminate()
</textarea><br><br>For some reason it only displays the line from 0, 0 to 640, 480 not the full screen, there is a slight flicker at the start which looks like it does initially draw the line 0,0,1024,768.<br><br>I noticed that in my GAF game when I was alt-tabbing it also does this effect, <strike>I've added a fix to TGame.CheckWindow to recreate the graphics context but it seems very strange: </strike> (see edit below)<br><br><pre class=code>
If Suspended = True
	'should resume the music/speech? (only if not paused)
	
	If UsingVirtualResolution
		Mouse.ClearButtons()
		GraphicsCreate()
		RestoreMouseCoords()
	End If
</pre><br><br>[edit]<br>Just found that Chroma raised this issue:<br><a href="http://www.blitzbasic.com/Community/posts.php?topic=93081" target="_blank">http://www.blitzbasic.com/Community/posts.php?topic=93081</a><br><br>And his fix is alot cleaner than mine so ignore the above and just add this to DoSetVirtualResolution:<br><br><pre class=code>
	Method DoSetVirtualResolution()
		If ScreenWidth &lt;&gt; WindowWidth Then
			SetVirtualResolution(ScreenWidth, ScreenHeight)
			VirtualRatioX = ScreenWidth / Float(WindowWidth)
			VirtualRatioY = ScreenHeight / Float(WindowHeight)
			SetViewport 0, 0, ScreenWidth, ScreenHeight
			UsingVirtualResolution = 1
		End If
	End Method
</pre><br>[/edit]<br><br><font class="tiny">Last edited 2011</font><br><br><font class="tiny">Last edited 2011</font> <br><br></td></tr></table><br>
<a name="1115722"></a>

<a name="1115723"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >therevills</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#4">[#4]</a></td></tr></table></td></tr><tr ><td class="posttext"> Final post of the night...<br><br>I've found a couple of posts saying that the Virtual Resolution code doesnt work for DirectX7 on certain PCs...<br><br><a href="http://www.blitzbasic.com/Community/posts.php?topic=94446#1083571" target="_blank">http://www.blitzbasic.com/Community/posts.php?topic=94446#1083571</a><br><br>So do I disable the Virtual resolution stuff if the player only has DX7 installed?<br><br>Also I'm a bit worried about this post too:<br><br><a href="http://www.blitzbasic.com/Community/posts.php?topic=94616#1086210" target="_blank">http://www.blitzbasic.com/Community/posts.php?topic=94616#1086210</a><br><br>What was the conclusion?<br><br>Thanks!<br><br><font class="tiny">Last edited 2011</font> <br><br></td></tr></table><br>
<a name="1115804"></a>

<a name="1115805"></a>

<a name="1115806"></a>

<a name="1115807"></a>

<a name="1115808"></a>

<a name="1115810"></a>

<a name="1115811"></a>

<a name="1115812"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Grey Alien</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#5">[#5]</a></td></tr></table></td></tr><tr ><td class="posttext"> You also need to modify TScreen.ImageLoad() so that it uses Flags-1 if UsingVirtualResolution is true so that images are smoothed when scaled.<br><br>It's true that viewport used to have issues, but I've used the viewport in DX9 with Virtual Resolution no problems with no reports of fails (it might still fail, but I bet number of PCs it fails on is low).<br><br>DoSetVirtualResolution() is called after I successfully set fullscreen in Graphics Create:<br><br><pre class=code>
Local OK:TGraphics = Null
If FullScreen Then
   ...
   If FullScreen Then DoSetVirtualResolution()
EndIf
</pre><br><br>and after setting Windowed mode:<br><pre class=code>
If OK = Null Then
   ...
Else
   DoSetVirtualResolution()
EndIf
</pre><br><br>You are indeed correct with adding SetViewport(0, 0, ScreenWidth, ScreenHeight) to DoSetVirtualResolution().  I did that too.<br><br>Yes I'm only using it for DX9.  I'm now using DX9 by default with the framework.  One issue is the input lag on DX9 in full-screen and windowed mode.  This works in full-screen, but not windowed (in windowed I offer users the option of turning off the custom cursor).<br><br><pre class=code>
' -----------------------------------------------------------------------------
' ccFixLagDX9: Fixes DirectX9 rendering lag in BlitzMax
' -----------------------------------------------------------------------------
Function ccFixLagDX9()
	Local Temp:TPixmap
	Temp = GrabPixmap(1, 1, 1, 1)
End Function
</pre><br><br>Call it before ccFlip() in PostDraw().<br><br><pre class=code>
		?Win32
			'This lag fix works for DX9 and OpenGL.
			If (DriverDX9 Or Driver = 1) And FullScreen Then ccFixLagDX9()
		?
</pre><br><br>To fix mouse issues I did this to DoMoveMouse()<br><br><pre class=code>
	Method DoMoveMouse(x:Int, y:Int)
		'This correct scales the coords if a virtual resolution is being used.
		If UsingVirtualResolution = 1
			'This is untested if Full Screen is bigger than windowed e.g. 1024x768 fullscreen and only 800x600 in windowed due to Desktop res of 1024x768.
			MoveMouse x / VirtualRatioX, y / VirtualRatioY						
		Else
			...
		End If
	End Method
</pre><br><br>Also modified the EVENT_MOUSE_MOVE similar to your code but with ccRound on there<br><pre class=code>

			Case EVENT_MOUSEMOVE
				'If the virutal resolution doesn't match the screen size in full screen or windowed mode, we need to scale the coordinates to compensate.				
				If UsingVirtualResolution Then
					Mouse.X = ccRound(EventX() * VirtualRatioX)
					Mouse.Y = ccRound(EventY() * VirtualRatioY)
				Else
					Mouse.X = EventX()
					Mouse.Y = EventY()
				EndIf
</pre><br><br>Also tweaked TMousePointer.UpdateCoords here:<br><br><pre class=code>
If pt &lt;&gt; Null Then
   ...
   x = pt.X-Game.ClientX
   y = pt.Y-Game.ClientY

'If the virtual resolution doesn't match the screen size, we need to scale the coordinates to compensate.
   If Game.UsingVirtualResolution Then
	x = ccRound(x * Game.VirtualRatioX)
	y = ccRound(y * Game.VirtualRatioY)
   EndIf
EndIf
</pre><br><br>Oh one last thing, change ccFixMacWindowY() to use WindowHeight not ScreenHeight.<br><br>All that stuff took a lot of figuring out and testing but it worked well in the end and I shipped Spring Bonus with it.<br><br>Thanks for being careful to only post modifications and not original code, like I've been.  BFG own the original as I'm sure you know, so I can't post that code, but mods should be fine.<br><br><font class="tiny">Last edited 2011</font><br><br><font class="tiny">Last edited 2011</font> <br><br></td></tr></table><br>
<a name="1115814"></a>

<a name="1115824"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >therevills</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#6">[#6]</a></td></tr></table></td></tr><tr ><td class="posttext"> Thanks Jake :)<br><br>I'll test this tonight...<br><br>I notice that the minimum specs for Spring Bonus is still DirectX7, but you have updated your framework to DX9. Does this mean SB doesnt run on a machine with DX7?<br><br>[edit]<br>Jake replied via email to me:<br><br>If it detects no DX9 it will use DX7 but won't use SetVirtualRes.<br><br>So if a PC only has DX7 it will display at your screenwidth/height and will not use the virtual resolution.<br><br>Thanks a lot Jake :)<br><br><font class="tiny">Last edited 2011</font> <br><br></td></tr></table><br>
<a name="1116854"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >therevills</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#7">[#7]</a></td></tr></table></td></tr><tr ><td class="posttext"> I've just changed DoSetVirtualResolution to this:<br><br><pre class=code>	Method DoSetVirtualResolution()
		If DriverDX9 Or Driver = 1
			If ScreenWidth &lt;&gt; WindowWidth Then
				SetVirtualResolution(ScreenWidth, ScreenHeight)
				VirtualRatioX = ScreenWidth / Float(WindowWidth)
				VirtualRatioY = ScreenHeight / Float(WindowHeight)
				SetViewport 0, 0, ScreenWidth, ScreenHeight
				UsingVirtualResolution = 1
			Else
				UsingVirtualResolution = 0
			End If
		Else
			UsingVirtualResolution = 0
		EndIf
	End Method</pre><br><br>So if you give the user the option to switch between graphics drivers it will turn on or off the virtual resolution if needed. <br><br></td></tr></table><br>
<a name="1117000"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Grey Alien</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#8">[#8]</a></td></tr></table></td></tr><tr ><td class="posttext"> Ah I see.  Well I'm making it automatic that it'll drop to DX7 but if they have 9 it'll use that, so no choice :-) <br><br></td></tr></table><br>
<a name="1117051"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >therevills</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#9">[#9]</a></td></tr></table></td></tr><tr ><td class="posttext"> Its more the choice between OpenGL and DirectX ;)<br><br>So if they have DirectX7 installed they can't use the virtual resolution, but if you switch to OpenGL it will use it... and the new code allows the user to then switch back to DirectX7 without issues (as the variable is now set back to 0 so it doesnt mess up with the mouse coordinates etc). <br><br></td></tr></table><br>
<a name="1117069"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Grey Alien</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#10">[#10]</a></td></tr></table></td></tr><tr ><td class="posttext"> Yes it's good.  It's just that I don't allow sriver swapping in my casual games, but I probably would if I shipping an indie style game. <br><br></td></tr></table><br>
<a name="1121203"></a>

<a name="1121226"></a>

<a name="1121227"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >therevills</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#11">[#11]</a></td></tr></table></td></tr><tr ><td class="posttext"> Any idea why switching between window mode and full screen causes a 50% drop in the FPS rate?<br><br>Using DirectX9 and in window mode I get 60FPS, as soon as I go into Fullscreen mode (without the virtual res) it drops to 30FPS!!!<br><br>When using OpenGL it is fine, 60FPS in fullscreen and 60FPS in window mode...<br><br>[edit]<br>Found it... the slow down is caused by ccFixLagDX9... :/<br><br>The PC specs which slowed down in Full screen mode and DX9:<br> CPU: Intel Core 2 Duo E8400 3GHz<br> RAM: 2GB<br> GPU: NVIDIA Quadro NVS 290 (driver 275.36)<br> OS: Windows 7 Enterprise (32bit)<br><br>So the question is: to lag the mouse or to lag the game?!<br><br><font class="tiny">Last edited 2012</font><br><br><font class="tiny">Last edited 2012</font> <br><br></td></tr></table><br>
<a name="1121245"></a>

<a name="1121246"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Grey Alien</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#12">[#12]</a></td></tr></table></td></tr><tr ><td class="posttext"> Wow really, so it's missing a whole frame on that system if it's dropping to 30FPS.  Is that GPU any good?  Sounds like going back to DX7 is the solution sigh. But then no virtual res.<br><br><font class="tiny">Last edited 2012</font> <br><br></td></tr></table><br>
<a name="1121301"></a>

<a name="1121302"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >therevills</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#13">[#13]</a></td></tr></table></td></tr><tr ><td class="posttext"> I'm investigating how to add hardware mouse cursors to Blitzmax, as thru my research I believe this is the "correct" fix to the mouse lag issue in DirectX games.<br><br>No promises though ;)<br><br>No virtual res = no game &gt;800x600...<br><br>For a short term workaround, maybe a simple IF statement to check the performance is &lt; 50(?) FPS then disable the ccLagFix....<br><br><font class="tiny">Last edited 2012</font> <br><br></td></tr></table><br>
<a name="1121311"></a>

<a name="1121312"></a>

<a name="1121313"></a>

<a name="1121314"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >therevills</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#14">[#14]</a></td></tr></table></td></tr><tr ><td class="posttext"> I've found some code on the Unity forum which can load a .cur file and I've added it to Blitzmax... the only issue I've got now is that my image is 64x64 but when I use it, it is resized to 32x32 :/<br><br><a href="http://forum.unity3d.com/threads/70163-Hardware-Cursor-Plugin" target="_blank">http://forum.unity3d.com/threads/70163-Hardware-Cursor-Plugin</a><br><br>Heres the c++ code:<br><br><pre class=code>
extern "C" __declspec( dllexport ) void InitializeCursor(int cursorId, char* standardPath)
{
	wchar_t newPath[1024];
	MultiByteToWideChar(CP_UTF8, 0, standardPath, -1, newPath, 1024);
	HCURSOR cursor = ::LoadCursorFromFileW(newPath);
  //HCURSOR cursor = LoadCursor(NULL, IDC_WAIT); 
	cursors[cursorId] = cursor;
}

extern "C" __declspec( dllexport ) void SetCurrentCursor(int cursorId)
{
	HWND result = GetForegroundWindow();
	SetClassLongA(result, -12, (long)cursors[cursorId]);
	SetCursor(cursors[cursorId]);
	InvalidateRect(result, NULL, TRUE);
}
</pre><br><br>And the BlitzMax:<br><pre class=code>
?win32
Extern
	Function InitializeCursor(cursorId:Int, path$z)
	Function SetCurrentCursor(cursorId:Int)
EndExtern
?

Function ccInitializeCursor(id:Int, path:String)
	?win32
		InitializeCursor(id, path)
	?
End Function

Function ccSetCurrentCursor(id:Int)
	?win32
		SetCurrentCursor(id)
	?
End Function
</pre><br><br>And to use:<br><br><pre class=code>
	ccInitializeCursor(0, "pointer.cur")
	ccSetCurrentCursor(0)
</pre><br><br>Currently I've got my pointer.cur in the same folder as the exe.<br><br>[edit]<br>According to this Microsoft page, the system imposes a standard size of 32x32 and will only use 64x64 if the DPI is too high...<br><br><a href="http://support.microsoft.com/kb/307213" target="_blank">http://support.microsoft.com/kb/307213</a><br>[/edit]<br><br><font class="tiny">Last edited 2012</font> <br><br></td></tr></table><br>
<a name="1121361"></a>

<a name="1121362"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Grey Alien</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#15">[#15]</a></td></tr></table></td></tr><tr ><td class="posttext"> Very interesting.  Don't forget that the lag is a *display lag* so keys also appear to be slow as well, not just the mouse.  Not a problem for casual games, but definitely for arcade games.  In fact I first discovered this lag making a platformer minigame that used keys.<br><br><font class="tiny">Last edited 2012</font> <br><br></td></tr></table><br>
<a name="1121363"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >therevills</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#16">[#16]</a></td></tr></table></td></tr><tr ><td class="posttext"> Ah yes - I did forget about the lag keys/joysticks too...<br><br>Using a hardware mouse cursor does totally get rid of the lag with the mouse though ;) <br><br></td></tr></table><br>
<a name="1121419"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Grey Alien</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#17">[#17]</a></td></tr></table></td></tr><tr ><td class="posttext"> Good to know thanks. <br><br></td></tr></table><br>
<a name="1121508"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Grey Alien</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#18">[#18]</a></td></tr></table></td></tr><tr ><td class="posttext"> Oh and btw, for Spring Bonus what I did was add the lagfix code and had an option to turn off the custom cursor and just display the windows cursor instead as a lot of people on BFG want that option, and that seemed fine.  I didn't get any reports of horrid 30FPS issues, but maybe they didn't notice!<br><br>If you use a custom hardware cursor it just occurred to me that any clicks you make or "drawing"/dragging you did with that cursor would seem to lag behind due to the display lag.  For example if you pick up objects that stick to the cursor and are dropped elsewhere, they would appear to lag behind the cursor. <br><br></td></tr></table><br>
<a name="1121516"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >therevills</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#19">[#19]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> for Spring Bonus what I did was add the lagfix code  <br></div><br><br>Ah cool... I was going to ask if you added the lagfix to Spring Bonus :)<br><br><div class="quote"> you did with that cursor would seem to lag behind due to the display lag <br></div><br><br>Yep that is true... it seems that there really isnt a good solution apart from turning vsync off :( <br><br></td></tr></table><br>
<a name="1121518"></a>

<a name="1121519"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >therevills</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#20">[#20]</a></td></tr></table></td></tr><tr ><td class="posttext"> To bring this back on topic, I've added Widescreen support to GAF - thanks to James' code:<br><br><a href="http://www.blitzbasic.com/codearcs/codearcs.php?code=2879#comments" target="_blank">http://www.blitzbasic.com/codearcs/codearcs.php?code=2879#comments</a><br><br>In CommonTypes.bmx<br><br>Declare the main variable "WideScreen"<br><pre class=code>
Type TGame
...
	'Screen and timing vars
	Field FullScreen:Int = 1
	Field WideScreen:Int = 0
...
</pre><br><br>Add it to the ini file:<br><br><pre class=code>
	'--------------------
	'Ini
	'--------------------
	Method IniFill()
...
		Ini.Add("WideScreen", WideScreen)
	End Method
</pre><br><br>More ini file stuff<br><br><pre class=code>
	Method IniExtract()
		'Extract the Game variables from the Ini object
...
				Case "WIDESCREEN"
					WideScreen = Int(Line.Value)
			End Select
...

</pre><br><br>And the guts of the Virtual resolution stuff with added Widescreen support:<br><br><pre class=code>
	Method DoSetVirtualResolution()
		If DriverDX9 Or Driver = 1
		
			' Reset of display needed when re-calculating virtual graphics stuff/clearing borders...

			SetVirtualResolution GraphicsWidth (), GraphicsHeight ()
			SetViewport 0, 0, GraphicsWidth (), GraphicsHeight ()
			SetOrigin 0, 0
			
			' Got to clear both front AND back buffers or it flickers if new display area is smaller...
			Cls
			Flip
	
			Cls
			Flip
			
			Cls
			Flip
			
			Cls
			Flip
						
			If FullScreen And WideScreen
		
				Local gwidth:Int
				Local gheight:Int
	
				gwidth = DesktopWidth
				gheight = DesktopHeight
				
				Local virtualratio:Float = Float(ScreenWidth) / Float(ScreenHeight)
				Local graphicsratio:Float = Float (gwidth) / Float (gheight)
	
				
				Local gtovratio:Float = graphicsratio / virtualratio
				Local vtogratio:Float = virtualratio / graphicsratio
				
				If graphicsratio &gt;= virtualratio
					Local vscale:Float = Float (gheight) / Float(ScreenHeight)
					Local pixels:Float = Float(ScreenWidth) / (1.0 / vscale)
					Local half_scale:Float = (1.0 / vscale) / 2.0
	
					Local sx:Float = Float(ScreenWidth) * gtovratio
					
					SetVirtualResolution sx, ScreenHeight
					
					vxoff = (gwidth - pixels) * half_scale
					vyoff = 0
	
					SetViewport vxoff, vyoff, ScreenWidth, ScreenHeight
					SetOrigin vxoff, vyoff
					VirtualRatioX = sx / Float(WindowWidth)
					VirtualRatioY = ScreenHeight / Float(WindowHeight)
					UsingVirtualResolution = 1
				Else
					Local vscale:Float = Float (gwidth) / Float(ScreenWidth)
					Local pixels:Float = Float(ScreenHeight) / (1.0 / vscale)
					Local half_scale:Float = (1.0 / vscale) / 2.0
					
					Local sy:Float = Float(ScreenHeight) * vtogratio
					
					SetVirtualResolution ScreenWidth, sy
					vxoff = 0
					vyoff = (gheight - pixels) * half_scale
	
					SetViewport vxoff, vyoff, ScreenWidth, ScreenHeight
					SetOrigin vxoff, vyoff
					VirtualRatioX = ScreenWidth / Float(WindowWidth)
					VirtualRatioY = sy / Float(WindowHeight)
					UsingVirtualResolution = 1
				EndIf
			Else
				If ScreenWidth &lt;&gt; WindowWidth Then
					SetVirtualResolution(ScreenWidth, ScreenHeight)
					VirtualRatioX = ScreenWidth / Float(WindowWidth)
					VirtualRatioY = ScreenHeight / Float(WindowHeight)
					SetViewport 0, 0, ScreenWidth, ScreenHeight
					UsingVirtualResolution = 1
				Else
					If Not WideScreen Then UsingVirtualResolution = 0
				End If
			EndIf
		Else
			UsingVirtualResolution = 0
		EndIf
	End Method
</pre><br><br>And a helper toggle method:<br><br><pre class=code>
	Method ToggleWideScreen()
		If Self.WideScreen
			WideScreen = 0
			vxoff = 0
			vyoff = 0
			UsingVirtualResolution = 0
		Else
			WideScreen = 1
		End If
		Mouse.ClearButtons() 'for safety in case a button was used to togglefullscreen
		If Game.FullScreen Then DoSetVirtualResolution()
		RestoreMouseCoords()
		IniUpdate()
		FixedRateLogic.Init() 'avoids skips due to old variable values
		FixedRateLogic.HistoryClear()
	End Method
</pre><br><br>Done :)<br><br><font class="tiny">Last edited 2012</font> <br><br></td></tr></table><br>
<a name="1121523"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Grey Alien</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#21">[#21]</a></td></tr></table></td></tr><tr ><td class="posttext"> Wow that is coolness! Thanks for sharing.<br><br>So how are you using this yourself?  Are you making a widescreen game (16:9) and using the system to add bars above and below on 4:3 screens (and small ones on 16:10 screens and any other sizes)?  And how are you deciding on the resolution to make the window/fullscreen?  Some people decided to make full screen the same as the desktop but other said it slowed their game down a lot.<br><br>When I looked into making GAF widescreen a while ago there were lots of differing opinions as to how to handle it and I didn't need it myself at the time so didn't add it it.  If anything, for casual games, it's just needed for giving the user an option to add bars to the side for 4:3 games shown on a widescreen monitor so the game is the correct aspect ratio, not stretched (as some monitors do and others don't, and some allow you to toggle). <br><br></td></tr></table><br>
<a name="1121524"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Grey Alien</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#22">[#22]</a></td></tr></table></td></tr><tr ><td class="posttext"> couple of code questions:<br><br>what is this for? If Not WideScreen Then UsingVirtualResolution = 0<br>and how come you only call DoSetVirtualResolution() for FullScreen mode in the toggle function?<br><br>Sorry it's late and I haven't tested myself yet so it's not obvious :-) <br><br></td></tr></table><br>
<a name="1121527"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >therevills</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#23">[#23]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> So how are you using this yourself? <br></div><br><br>I'm coding at 1024x768 so 4:3 and I've added an option to the option screen so the user can switch between the correct ratio of the game (by turning on widescreen) or having the game stretched across the screen.<br><br><div class="quote"> If Not WideScreen Then UsingVirtualResolution = 0 <br></div><br><br>Just to ensure that the UsingVirtualResolution boolean is turned off.<br><br><div class="quote"> how come you only call DoSetVirtualResolution() for FullScreen mode in the toggle function? <br></div><br><br>As I've only coded the Virtual resolution stuff to work in full screen and the user can enable widescreen mode if the game is in window mode. <br><br></td></tr></table><br>
<a name="1121529"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >zeb</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#24">[#24]</a></td></tr></table></td></tr><tr ><td class="posttext"> Hi therevills!<br><br>Thank you for the improvements! I will try it surely.<br>One question please:<br>How do you added the DX9 in the framework? I made an experiment a time ago, with only dx9, seems it works well, but i need to change the blitzmax source code, adding a method in the dx module ( it's only one line... ) but I don't like touch the blitzmax code...<br>Regards <br><br></td></tr></table><br>
<a name="1121548"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >BlitzSupport</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#25">[#25]</a></td></tr></table></td></tr><tr ><td class="posttext"> @therevills: One thing I notice in your code there:<br><br><pre class=code>
Local gwidth:Int
' ...
gwidth = DesktopWidth
</pre><br><br>DesktopWidth () is a valid BMX function, so running just the two lines above will fail (DesktopWidth in this case is a function pointer).<br><br>I therefore assume you've got a global Int called DesktopWidth somewhere that's wiping out the BMX function, as this compiles:<br><br><pre class=code>
Local DesktopWidth:Int = 10
Local gwidth:Int
gwidth = DesktopWidth
</pre><br><br>Thought I ought to point it out anyway. <br><br></td></tr></table><br>
<a name="1121565"></a>

<a name="1121566"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Grey Alien</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#26">[#26]</a></td></tr></table></td></tr><tr ><td class="posttext"> @therevills: Ah yes that makes sense thanks, now I read it in the morning :-)  This code could be used to write a widescreen HOG or something though right?<br><br>@BlitzSupport: Yes DesktopWidth is a global that is set elsewhere in teh framework.<br><br><font class="tiny">Last edited 2012</font> <br><br></td></tr></table><br>
<a name="1121615"></a>

<a name="1121659"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >therevills</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#27">[#27]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> This code could be used to write a widescreen HOG or something though right? <br></div><br><br>Yep! James did a brilliant job with this :)<br><br><div class="quote"> How do you added the DX9 in the framework? <br></div><br><br>Opps.. yeah thats really needed on this post too...<br><br>In CommonTypes.bmx:<br><br><pre class=code>
Type TGame
...
	Field DriverDX9:Int = 0
</pre><br><br><pre class=code>
	Method GraphicsCreate() 
...
		'Set DirectX or BlitzMax OpenGL driver (not pure OpenGL)
		Local DriverOK%=0
		?Win32
		If Driver=0 Then
			'DirectX
			DebugInt = 101
			'Is there a Direct3D 7 Driver installed?
			If D3D9Max2DDriver() Then
				DebugInt=10101
				'The code can reach here even if the driver is not DirectX7 or higher I've discovered.
				If Not ccDirectXVersionIsValid() Then
					'Make sure that ccGraphicalErrors=0 otherwise this error won't show!
					ccRunTimeError("Sorry, you need DirectX V7.0 or higher!")
				Else
					DirectXVersion = ccGetDirectXVersion()
				EndIf
				DebugInt=102
				SetGraphicsDriver D3D9Max2DDriver()
				DriverOK = 1
				DriverDX9 = 1
			ElseIf D3D7Max2DDriver() Then
...
		Else
			'OpenGL
			DebugInt=106
			'Is there an OpenGL Driver installed?
			If GLMax2DDriver() Then			
				DebugInt=107
				SetGraphicsDriver GLMax2DDriver()
				DriverOK = 1
			ElseIf D3D9Max2DDriver() Then
				DebugInt = 10101
				SetGraphicsDriver D3D9Max2DDriver()
				DriverOK = 1
				Driver = 0
				DebugInt = 110
				IniUpdate()
				DriverDX9 = 1
			Else
				'Hmm, OK, OpenGL not present, is DirectX available?
				DebugInt=108
				If D3D7Max2DDriver() Then
...
			?Win32
				'Only call this in DirectX mode
				'This command fails if DirectX is not installed
				If D3D7Max2DDriver() Or D3D9Max2DDriver() Then
					DebugInt=113
					DesktopRefreshRate = GetDeviceCaps(GetDC(0),VREFRESH)
				EndIf
			?
...
		'Get GameRefreshRate, may not be same as DesktopRefreshRate in full-screen mode
		GameRefreshRate = -1 'means value not read
		DebugInt=136
		?Win32
			'This command fails if DirectX is not installed
			If D3D7Max2DDriver() Or D3D9Max2DDriver() Then
				DebugInt=137
				GameRefreshRate = GetDeviceCaps(GetDC(GetActiveWindowSafe()), VREFRESH)
			EndIf
		?
</pre><br><br><pre class=code>
	Method GetActiveWindowSafe%()
...
                    If Driver = 0 Then
			Local my_driver:TD3D7GraphicsDriver = D3D7GraphicsDriver()
			Local my_graphics:TD3D7Graphics = my_driver.Graphics()
			'If the my_graphics is null, use DX 9 driver instead.
			If my_graphics &lt;&gt; Null Then
				Return my_graphics._hwnd
			Else
				Local my_driver:TD3D9GraphicsDriver = D3D9GraphicsDriver()
			
				Local my_graphics:TD3D9Graphics = my_driver.Graphics()
			    Return my_graphics._hwnd
			EndIf
</pre><br><br>I think thats it... Oh and I did have to add this:<br><br><pre class=code>
Method Graphics:TD3D9Graphics()
        Return _graphics
    End Method
</pre><br><br>To dxgraphics.mod\d3d9graphics.bmx.... good luck ;)<br><br><font class="tiny">Last edited 2012</font> <br><br></td></tr></table><br>
<a name="1121656"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Grey Alien</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#28">[#28]</a></td></tr></table></td></tr><tr ><td class="posttext"> Small bug.  This line near the bottom: <br><br><pre class=code>
			If D3D7Max2DDriver() Or D3D7Max2DDriver() Then
</pre><br><br>should be:<br><br><pre class=code>
			If D3D7Max2DDriver() Or D3D9Max2DDriver() Then
</pre> <br><br></td></tr></table><br>
<a name="1121658"></a>

<a name="1121660"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >therevills</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#29">[#29]</a></td></tr></table></td></tr><tr ><td class="posttext"> Opps - Thanks Jake ;)<br><br>I've updated the above code :)<br><br><font class="tiny">Last edited 2012</font> <br><br></td></tr></table><br>
<a name="1121661"></a>

<a name="1121662"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Grey Alien</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#30">[#30]</a></td></tr></table></td></tr><tr ><td class="posttext"> Also instead of this:<br><br><pre class=code>
SetGraphicsDriver D3D9Max2DDriver()
DriverDX9 = 1

</pre><br><br>I call this:<br><br><pre class=code>
	Method SetDXDriver(DX7:Int)
		?Win32
		If DX7 Then
			DriverDX7 = 1
			DriverDX9 = 0
			SetGraphicsDriver D3D7Max2DDriver()
		Else
			DriverDX7 = 0
			DriverDX9 = 1
			SetGraphicsDriver D3D9Max2DDriver()
			'Ideally there would be some code here to check if DX9 wasn't used and DX7 was so the DriverDX7 flag could be set.
			'Oh wait, there is now!
			If Not D3D9Max2DDriver()
				DriverDX7 = 1
				DriverDX9 = 0
  				SetGraphicsDriver(D3D7Max2DDriver())
				'This may mean that DoSetVirtualResolution() fails due to DX7, but the small netbooks it required on are all DX9 anyway.
			EndIf
		EndIf
		?
	End Method
</pre><br><br><font class="tiny">Last edited 2012</font> <br><br></td></tr></table><br>
<a name="1121663"></a>

<a name="1121664"></a>

<a name="1121665"></a>

<a name="1121666"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Grey Alien</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#31">[#31]</a></td></tr></table></td></tr><tr ><td class="posttext"> No, thank you, because I updated my code with some of yours (like I wasn't testing for DX9 driver in a few places.)<br><br><font class="tiny">Last edited 2012</font> <br><br></td></tr></table><br>
<a name="1121667"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Grey Alien</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#32">[#32]</a></td></tr></table></td></tr><tr ><td class="posttext"> You also might want to update DebugPrint a bit, I found this useful for testing:<br><br><pre class=code>
			'Drivers and memory
			If Driver = 0 Then
				Local using:String = " (using DX"
				If DriverDX7 Then using = using + "7)"
				If DriverDX9 Then using = using + "9)"
				C.OutputNL("Gfx Drv " + "DirectX " + DirectXVersion + using)
			Else
				C.OutputNL("Gfx Drv " + "OpenGL")
			EndIf
</pre> <br><br></td></tr></table><br>
<a name="1121668"></a>

<a name="1121669"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >therevills</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#33">[#33]</a></td></tr></table></td></tr><tr ><td class="posttext"> Yep I've got something like that too... but it was getting a bit of a mess posting all that code...<br><br><pre class=code>
			If Driver = 0 Then
				If DriverDX9 Then C.OutputNL("Using DirectX9")
				C.OutputNL("Gfx Drv " + "DirectX " + DirectXVersion)
			Else
				C.OutputNL("Gfx Drv " + "OpenGL")
			EndIf
			If WideScreen = 1 Then
				C.OutputNL("Using Widecreen")
			Else
				C.OutputNL("NO widescreen")
			EndIf
			C.OutputNL("DesktopWidth  " + DesktopWidth)
			C.OutputNL("DesktopHeight " + DesktopHeight)
			C.OutputNL("ScreenWidth   " + ScreenWidth)
			C.OutputNL("ScreenHeight  " + ScreenHeight)
			C.OutputNL("WindowWidth   " + WindowWidth)
			C.OutputNL("WindowHeight  " + WindowHeight)
			If UsingVirtualResolution Then
				 C.OutputNL("UsingVirtualResolution = True")
			Else
				C.OutputNL("UsingVirtualResolution = False")
			End If
...
			C.OutputNL("Mouse Lag Fix " + lagFixOn + " F1 to toggle")
</pre><br><br><font class="tiny">Last edited 2012</font> <br><br></td></tr></table><br>
<a name="1121671"></a>

<a name="1121672"></a>

<a name="1121673"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Grey Alien</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#34">[#34]</a></td></tr></table></td></tr><tr ><td class="posttext"> Nice, I've just added those virtual res related ones.  Still haven't added hardware cursor or widescreen support yet, it's on my to do list (have bookmarked this thread).  Working on another main project at the moment for someone else with a team and need to crunch.<br><br><font class="tiny">Last edited 2012</font> <br><br></td></tr></table><br>
<a name="1121679"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >therevills</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#35">[#35]</a></td></tr></table></td></tr><tr ><td class="posttext"> Cool!<br><br>BTW I've just tested Spring Bonus on this work PC and I can see the slow down with the lagfix in full screen mode, its playable but I can tell its not running at 60FPS. <br><br></td></tr></table><br>
<a name="1121690"></a>

<a name="1121691"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Grey Alien</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#36">[#36]</a></td></tr></table></td></tr><tr ><td class="posttext"> OUCH.  Well worth knowing thanks.  That PC isn't a bad spec right (I didn't know if the video card was good/bad)?  So it's like I could leave off lagfix and maybe there'd be a small lag but at least the game would be 60FPS smooth and still offer the ability to switch off the custom cursor for people who hate the lag.  I wonder how many sales I lost due to lag appearing bad?  It actually converted the best of all my match-3s on BFG and I didn't see any complaints.  <br><br>I have heard a few people on BFG moaning that custom cursors (in other games) are REALLY slow, like awful, and BFG QA confirmed this, so not just a few frames lag, like tons.  Could be a DX9 issue where the buffering is extreme or something.  That's why I added the option in to not use a custom cursor at all.  Could retro fit it to my old games if I could be arsed :-)<br><br><font class="tiny">Last edited 2012</font> <br><br></td></tr></table><br>
<a name="1161587"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Grey Alien</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#37">[#37]</a></td></tr></table></td></tr><tr ><td class="posttext"> Hey therevills, I added Widescreen to Spring Bonus using the code above and it works well thanks.  Couple of weird things I noticed though:<br><br>- The mouse goes off the right hand side of the screen into the black border.  Did you limit the mouse X coord in your framework somehow (I noticed it doesn't go to far right in your latest solitaire game)?<br>- Something weird is going on with the left hand side of the screen.  If I move the mouse cursor over there its tip is able to draw in a 2 pixel column on the black border to the left of the main background and also any dialogs that slide on/off leave a trace in that thin column.<br><br>In your solitaire game your mouse cursor doesn't quite reach the left side (mouse offset?) and so you can't see the same effect, BUT I think there is a thin strip down the left side that is not the right colour when you go from title to options for example.  Check it out. <br><br></td></tr></table><br>
<a name="1161593"></a>

<a name="1161594"></a>

<a name="1161595"></a>

<a name="1166585"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Grey Alien</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#38">[#38]</a></td></tr></table></td></tr><tr ><td class="posttext"> OK found the problem with the left side.  It's a rounding error on vxoff, vyoff because SetViewPort uses ints and SetOrigin uses floats.<br><br>So try this:<br><br><pre class=code>
SetViewport ccRound(vxoff), ccRound(vyoff), ScreenWidth, ScreenHeight
SetOrigin ccRound(vxoff), ccRound(vyoff)
</pre><br>It makes them consistent.<br><br><font class="tiny">Last edited 2012</font><br><br><font class="tiny">Last edited 2012</font> <br><br></td></tr></table><br>
<a name="1161596"></a>

<a name="1161597"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Grey Alien</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#39">[#39]</a></td></tr></table></td></tr><tr ><td class="posttext"> One more thing.  I notice you are resetting vxoff and vyoff to zero in ToggleWidescreen.  Why is that?  If they are not used anywhere else in the code except DoSetVirtualResolution() they might as well be local to DoSetVirtualResolution() which is what I've done (declared as floats)<br><br><font class="tiny">Last edited 2012</font> <br><br></td></tr></table><br>
<a name="1161622"></a>

<a name="1161623"></a>

<a name="1161624"></a>

<a name="1161625"></a>

<a name="1161631"></a>

<a name="1161632"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Grey Alien</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#40">[#40]</a></td></tr></table></td></tr><tr ><td class="posttext"> Ah crap, turns out that fix only worked on the PC that had 1600x900 resolution (for my 1024x768 game). On my 1920x1200 PC the problem still exists on the left border. I expect I could fix it by drawing over it every frame but that seems a bit lame.  Probably the solution is some careful rounding of some of the other variables.  I already tried making them all Double but that didn't work.<br><br>[edit]Hmm, after some more experimentation I'm thinking the solution may be to Floor sx and sy like this as well as keeping the rounding from my previous post, but I'd love a second opinion.<br><br><pre class=code>
SetVirtualResolution Floor(sx), ScreenHeight
</pre><br><br><br>...<br><br><br>Having some more thoughts now, I wonder if sx/sy should always be rounded to an EVEN number such that sx - ccRound(vxoff)*2 = ScreenWidth.<br><br><font class="tiny">Last edited 2012</font> <br><br></td></tr></table><br>
<a name="1161646"></a>

<a name="1161647"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >therevills</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#41">[#41]</a></td></tr></table></td></tr><tr ><td class="posttext"> Its been quite awhile since I looked at this...<br><br><div class="quote"> I notice you are resetting vxoff and vyoff to zero in ToggleWidescreen. Why is that? If they are not used anywhere else in the code except DoSetVirtualResolution()  <br></div><br><br>Looks like I now use them in DoMoveMouse:<br><br><pre class=code>	Method DoMoveMouse(x:Int, y:Int)
		'This correct scales the coords if a virtual resolution is being used.
		If UsingVirtualResolution = 1
			'This is untested if Full Screen is bigger than windowed e.g. 1024x768 fullscreen and only 800x600 in windowed due to Desktop res of 1024x768.
			MoveMouse ((x + vxoff) / VirtualRatioX) , ((y + vyoff) / VirtualRatioY)
		Else
			MoveMouse(x, y)
		End If
	End Method</pre><br><br>And UpdateCoords:<br><br><pre class=code>
	Method UpdateCoords()
		'Uses Windows API call to get exact coords relative to desktop.
		'Doesn't use MouseX() and MouseY() as they rely on PolledInput.
		'Also doesn't use event-based updates because they would only update X/Y
		'if a MouseMove event was received since PollEvent() was last called (unlikely).
		Local pt:TPoint
		?Win32
			pt = ccGetCursorPos() 'This is position relative to the top left of the desktop
		?
		?MacOS
			pt = ccGetCursorPosOSX()
			'On Macs the mouse Y coord is reversed (0 is at the bottom of the screen)
			'So I need to reverse it based on the Desktop Height.
			pt.Y = Game.DesktopHeight-pt.Y
		?
		If pt &lt;&gt; Null Then
			'Use client area position so we can see if the cursor is outside of window.
			Game.SetClientCoords() 'Need this in case window has been dragged as drag code doesn't alway set it soon enough.
			
			x = pt.x - Game.ClientX
			y = pt.y - Game.ClientY
			
			If UsingVirtualResolution Then
				x = ccRound(x * VirtualRatioX) - Game.vxoff
				y = ccRound(y * VirtualRatioY) - Game.vyoff
			EndIf
			
		EndIf
	End Method</pre><br><br>And DoPeekEvent:<br><pre class=code>
			Case EVENT_MOUSEMOVE
			
				If UsingVirtualResolution Then
					Mouse.X = ccRound(EventX() * VirtualRatioX) - vxoff
					Mouse.y = ccRound(EventY() * VirtualRatioY) - vyoff
				Else
					Mouse.X = EventX()
					Mouse.Y = EventY()			
				End If
</pre><br><br>Also just to let you know I had to actually disable the Widescreen support for Mac, on my Mac it worked fine but BFG found on some it didnt display correctly. Looking at the screen shot they sent me, I think the viewport doesnt seem to be "cutting" correctly or something:<br><br><img src="http://www.therevillsgames.com/code/los_mac_ws_error.png"><br><br>And since I couldnt reproduce it I just disabled that option for Mac within the game.<br><br><font class="tiny">Last edited 2012</font> <br><br></td></tr></table><br>
<a name="1161677"></a>

<a name="1161693"></a>

<a name="1161695"></a>

<a name="1161696"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Grey Alien</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#42">[#42]</a></td></tr></table></td></tr><tr ><td class="posttext"> Thanks for the info.  Hmm guess I'd better disable it on Mac too.  I've never heard about viewports failing on Mac before. Wonder if it's videocard specific?<br><br>So are you clamping the mouse on the right hand side of the screen somehow as I notice yours doesn't go into the black border on the right (it does on mine)? EDIT: OK I just added vxoff and vyoff to my other code and now the mouse goes off both the left and the right by equal amounts (instead of only off the right). Weird.<br><br>Also what are your thoughts about avoiding the thin column on the left that seems to get drawn on when it shouldn't?  I've tried a bunch of things and think I have a solution. Will post code later.<br><br><font class="tiny">Last edited 2012</font> <br><br></td></tr></table><br>
<a name="1161684"></a>

<a name="1161685"></a>

<a name="1161686"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Grey Alien</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#43">[#43]</a></td></tr></table></td></tr><tr ><td class="posttext"> OK here's what I did in the end.  I discovered that if sx-vxoff*2 = ScreenWidth, sometimes you can't see the edge pixels on the right hand side.  So I've deliberately shrunk it down a bit more to the nearest even number which seems to work.<br><br><pre class=code>
					Local sx:Float = Float(ScreenWidth) * gtovratio

					'Round sx down to the nearest even number that will look a bit smaller than the ScreenWidth required.
					Local finalsx:Int = Floor(sx-1)
					If finalsx Mod 2 = 1 Then finalsx:-1

					SetVirtualResolution finalsx, ScreenHeight
										
					vxoff = (gwidth - pixels) * half_scale
					vyoff = 0

					Print sx
					Print finalsx
					Print vxoff
					Print finalsx-ccRound(vxoff)*2
	
					SetViewport ccRound(vxoff), vyoff, ScreenWidth, ScreenHeight
					SetOrigin ccRound(vxoff), vyoff
</pre><br><br>Need to do the same for sy and vyoff<br><br><font class="tiny">Last edited 2012</font> <br><br></td></tr></table><br>
<a name="1161691"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Grey Alien</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#44">[#44]</a></td></tr></table></td></tr><tr ><td class="posttext"> btw, I did some testing and I don't think you need vxoff and vyoff in UpdateCoords() because it is only called in windowed mode and of course widescreen is not turned on in windowed mode so vxoff and xyoff =0.  Mind you it doesn't harm to have it in there. <br><br></td></tr></table><br>
<a name="1161702"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Grey Alien</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#45">[#45]</a></td></tr></table></td></tr><tr ><td class="posttext"> Here's what I did in the end to clamp the mouse in DoPeekEvent:<br><br><pre class=code>
...
					Mouse.X = ccRound(EventX() * VirtualRatioX) - vxoff
					Mouse.Y = ccRound(EventY() * VirtualRatioY) - vyoff

					'It's possible for the mouse to go offscreen in widescreen mode, so we need to do some clamping.
					If FullScreen And Widescreen Then
						If Mouse.X&lt;0 Then
							Mouse.X=0
							DoMoveMouse(Mouse.X,Mouse.Y)
						EndIf
						If Mouse.Y&lt;0 Then
							Mouse.Y=0
							DoMoveMouse(Mouse.X,Mouse.Y)
						EndIf
						If Mouse.X&gt;=ScreenWidth Then
							Mouse.X=ScreenWidth-1 'May cause a slight jiggle on the right side.
							DoMoveMouse(Mouse.X,Mouse.Y)
						EndIf
						If Mouse.Y&gt;=ScreenHeight Then
							Mouse.Y=ScreenHeight-1
							DoMoveMouse(Mouse.X,Mouse.Y)
						EndIf
					EndIf	
...				
</pre> <br><br></td></tr></table><br>
<a name="1161752"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >therevills</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#46">[#46]</a></td></tr></table></td></tr><tr ><td class="posttext"> Yep, Ive got similar code in DoPeekEvent to handle the mouse:<br><br><pre class=code>			Case EVENT_MOUSEMOVE
			
				If UsingVirtualResolution Then
					Mouse.X = ccRound(EventX() * VirtualRatioX) - vxoff
					Mouse.y = ccRound(EventY() * VirtualRatioY) - vyoff
				Else
					Mouse.X = EventX()
					Mouse.Y = EventY()			
				End If
				
				' this stops the custom cursor going offscreen when using the virtual res...
				If FullScreen
					If Self.Mouse.useSystemPointer = 0
						If Mouse.x &lt; 0
							Mouse.x = 1 ' 1 instead of 0, because it would hang!?
							DoMoveMouse(1, Mouse.y)
						End If
		
						If Mouse.x &gt; ScreenWidth
							Mouse.x = ScreenWidth - 1
							DoMoveMouse(ScreenWidth - 1, Mouse.y)
						End If
		
						If Mouse.y &lt; 0
							Mouse.y = 1
							DoMoveMouse(Mouse.x, 1)
						End If
		
						If Mouse.y &gt; ScreenHeight
							Mouse.y = ScreenHeight - 1
							DoMoveMouse(Mouse.x, ScreenHeight - 1)
						End If
					EndIf
				EndIf</pre> <br><br></td></tr></table><br>
<a name="1161818"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Grey Alien</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#47">[#47]</a></td></tr></table></td></tr><tr ><td class="posttext"> Ha! almost the same :-) <br><br></td></tr></table><br>
<a name="1164697"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Grey Alien</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#48">[#48]</a></td></tr></table></td></tr><tr ><td class="posttext"> Found a couple of bugs in my implementation that may affect you:<br><br>1) the global vxoff and vyoff must be set to 0 at the start of DoSetVirtualResolution() just in case they were set previously (due to full screen widescreen mode being used) and then you go back to windowed mode in which widescreen isn't being used.  If you don't do that you get some bad mouse sync issues.<br><br>2) In ToggleWideScreen() you should ALWAYS call DoSetVirtualResolution(), not just if the game is in fullscreen.  This is because if you are in windowed mode and it is scaled down on a low resolution laptop, and you toggle widescreen on/off, when it goes off it will turn off UsingVirtualResolution in your code sample and never turns it back on again (via DoSetVirtualResolution) which is bad news because it should be on. This causes the mouse to go out of sync.<br><br>Hope those make sense. <br><br></td></tr></table><br>
<a name="1166583"></a>

<a name="1166584"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Grey Alien</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#49">[#49]</a></td></tr></table></td></tr><tr ><td class="posttext"> @therevills: Figured out what was causing the mouse repositioning to rehang in rare cases when using widescreen.  Here's my code:<br><br><pre class=code>
					'It's possible for the mouse to go offscreen in widescreen mode, so we need to do some clamping.
					'But *only* for the custom cursor as it looks bad with the windows pointer (it springs back into position)
					If FullScreen And Widescreen And CustomMousePointer Then

						Local FloatX:Float = (EventX() * VirtualRatioX) - vxoff
						Local FloatY:Float = (EventY() * VirtualRatioY) - vyoff

						'Calc edge coords using virtual ratio, otherwise the cursor can sometimes get stuck with the following code.
						Local LeftEdge:Int = 0
						Local TopEdge:Int =  0
						Local RightEdge:Int = ScreenWidth-1
						Local BottomEdge:Int =  ScreenHeight-1

						'Need to use Ceil and Floor to stop mouse getting stuck due to infinitely repositioning due to being off by a fraction of a pixel.
						'This may result in the cursor jiggling at some edges in some resolutions.
						If Ceil(FloatX)&lt;LeftEdge Then
							Mouse.X=LeftEdge
							DoMoveMouse(Mouse.X,Mouse.Y)
						EndIf
						If Ceil(FloatY)&lt;TopEdge Then
							Mouse.Y=TopEdge
							DoMoveMouse(Mouse.X,Mouse.Y)
						EndIf
						If Floor(FloatX)&gt;RightEdge Then
							Mouse.X=RightEdge
							DoMoveMouse(Mouse.X,Mouse.Y)
						EndIf
						If Floor(FloatY)&gt;BottomEdge Then
							Mouse.Y=BottomEdge
							DoMoveMouse(Mouse.X,Mouse.Y)
						EndIf
					EndIf					
</pre><br><br>There's probably a better way of solving this (without the possible 1 pixel jiggle) but it's been driving me crazy trying to figure it out, so for now this will do.<br><br><font class="tiny">Last edited 2012</font> <br><br></td></tr></table><br>
<a name="1166598"></a>

<a name="1166600"></a>

<a name="1166601"></a>

<a name="1166606"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Grey Alien</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#50">[#50]</a></td></tr></table></td></tr><tr ><td class="posttext"> Also I was still getting issues with a column of pixels not being cleared on the side so I updated the code to have a slightly smaller viewport and that has sorted it (I hope):<br><br><pre class=code>
				If graphicsratio &gt;= virtualratio

					'Desktop is wider than game screen size OR the same
					Local vscale:Float = Float (gheight) / Float(ScreenHeight) 'How many desktop pixels are used per virtual pixel. e.g. 2.0 for an 800x600 game screen on a 1920x1200 desktop
					Local pixels:Float = Float(ScreenWidth) / (1.0 / vscale) 'Width in desktop pixels based on game screen scaled up so height matches desktop height.
					Local half_scale:Float = (1.0 / vscale) / 2.0 'This is half of how many virtual pixels are represented by desktop pixels. e.g. 0.25 for an 800x600 game screen on a 1920x1200 desktop

					'Work out many pixels wide (at current resolution set by Graphics()) we have to pretend the screen is					
					'so that the middle part that we want to draw to will be squashed to the correct aspect ratio.
					Local sx:Float = Float(ScreenWidth) * gtovratio
										
					'Round sx down to the nearest even number that will look a bit smaller than the ScreenWidth required.
					Local finalsx:Int = Floor(sx-1)
					If finalsx Mod 2 = 1 Then finalsx:-1

					SetVirtualResolution sx, ScreenHeight

					'Calc the leftmost pixel to start drawing at
'					vxoff = (gwidth - pixels) * half_scale
					vxoff = (finalsx-ScreenWidth)/2 'More accurate that method on line above.
					vyoff = 0
	
					'Make the viewport a little bit smaller than the virtual resolution to avoid a column of pixels on the edge which is not cleared.
					SetViewport ccRound(vxoff)+1, vyoff, ScreenWidth-2, ScreenHeight
					SetOrigin ccRound(vxoff), vyoff
										
					VirtualRatioX = sx / Float(WindowWidth)
					VirtualRatioY = ScreenHeight / Float(WindowHeight)
					UsingVirtualResolution = 1
				Else
...
</pre><br><br><font class="tiny">Last edited 2012</font> <br><br></td></tr></table><br>
<a name="bottom"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td align="right"><a href="http://monkeycoder.co.nz" target="_blank"><img src="/img/monkey2.svg" ></a> <a href="https://github.com/blitz-research" target="_blank"><img src="/img/github.svg" ></a> <a href="https://discord.gg/qJccbSp" target="_blank"><img src="/img/discord.svg" ></a></td></tr></table><br></div><br><table width="100%"><tr><td></body></html lang="en">
