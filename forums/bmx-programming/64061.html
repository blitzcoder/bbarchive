<!DOCTYPE html><html lang="en" ><head ><title >Will this free up memory correctly?</title><meta name='viewport' content='width=device-width, initial-scale=0.66'><meta name='description' content='language:basic, target:desktop, category:game development'><link rel="styleSheet" href="../skins/granite/style.css" type="text/css"><style type="text/css">div.bbcode {padding: 8px;background: #E5E5E5;color: #000000;border: 1px dashed #B4B4BE;}</style></head><body ><table width=100% cellspacing=0 cellpadding=0><tr ><td class="menubarleft"></td><td class="menubar"><table cellspacing="0" cellpadding="0"><tr ><td >&nbsp;</td><td class="menuitemleft"></td><td class="menuitem"><a href="/" class="menuitem">News</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/forums.php" class="menuitem">Forums</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/codearcs.php" class="menuitem">Code</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/logs.php" class="menuitem">Logs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/gallery.php" class="menuitem">Gallery</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/sdkspecs.php" class="menuitem">Specs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/search.php" class="menuitem">Search</a></td><td class="menuitemright"></td></tr></table></td><td class="menubarright"></td></tr></table><div class="main"><h1 >Will this free up memory correctly?</h1><a href="forums.php" >BlitzMax Forums</a>/<a href="topics.php?forum=102" >BlitzMax Programming</a>/<a href="#bottom" >Will this free up memory correctly?</a><br><br>
<a name="714928"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Grey Alien</td><td align="right"><font class=tiny>(Posted 2006)</font>&nbsp;<a href="#1">[#1]</a></td></tr></table></td></tr><tr ><td class="posttext"> Hi,<br><br>If I have a TParticle Type that I create an instance of, and I also have an instance of a TTracker type that has a TParticle field which I point to the instance of the TParticle, then I add the instance of the TTracker Type to a list (still with me?) then later on I do List.Remove(t) where t is my TTracker type instance, will the field within it which points to the TParticle type be freed so that the TParticle will now be freed by the garbage collection properly?  I hope so.  Trying to think how I can diagram this in text.  Anyway here's some example code (tested it compiles):<br><br><pre class=code>
Type TParticle
End Type

Type TTracker
  Field p:TParticle
End Type

Type TTrackerList extends TList
  Method AddNew:TTracker(p:TParticle)
    Local t:TTracker = new TTracker
    t.p = p
    AddLast(t)
    return TTracker
  End Method
End Type

Global trackerlist: TTrackerList = new TTrackerList

Add()
Remove()

Function Add()
  local p:TParticle = new TParticle
  trackerlist.addnew(p)
End Function

Function Remove()
  For t:TTracker = eachin trackerlist
    trackerlist.remove(t)
  Next
End Function
</pre><br><br>I know I could code this a different way, but I need it this way for a specific purpose and I just want to check that the memory will be freed up properly.  Any ideas?<br><br>Thanks. <br><br></td></tr></table><br>
<a name="714940"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Dreamora</td><td align="right"><font class=tiny>(Posted 2006)</font>&nbsp;<a href="#2">[#2]</a></td></tr></table></td></tr><tr ><td class="posttext"> There is no reason it should not free properly as there are no cyclic references that could keep anything alive. <br><br></td></tr></table><br>
<a name="714942"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Grey Alien</td><td align="right"><font class=tiny>(Posted 2006)</font>&nbsp;<a href="#3">[#3]</a></td></tr></table></td></tr><tr ><td class="posttext"> that's what I thought, cool + I just tested it in-game and watched the memory counter as I made tons of particles, seems to be OK. <br><br></td></tr></table><br>
<a name="714972"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >DStastny</td><td align="right"><font class=tiny>(Posted 2006)</font>&nbsp;<a href="#4">[#4]</a></td></tr></table></td></tr><tr ><td class="posttext"> Couple things Grey.  Not sure I understand what your Remove is doing but it is freeing the entire list.  So you could just all trackerlist.clear()<br><br>That method removes all the tlinks so all the Particles get marked for collection and its faster than a foreach remove.<br><br>Also when adding to a TList like this use AddFirst as AddLast the entire TList needs to be run before the object will be appended so if you have a 1000 particles the entire list will be scanned before you add the 1001st particle.<br><br>Another suggestion is to not use a TList at all but create your own link structure and create Particle pools.  One pool for active particles and one for for inactive particles.  That way you allocate the max you want up front.  Speed wise it blows away a TList.<br><br>My DX9 Driver demo uses the technique.<br><br>Doug Stastny <br><br></td></tr></table><br>
<a name="715030"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >AlexO</td><td align="right"><font class=tiny>(Posted 2006)</font>&nbsp;<a href="#5">[#5]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> <br>Also when adding to a TList like this use AddFirst as AddLast the entire TList needs to be run before the object will be appended so if you have a 1000 particles the entire list will be scanned before you add the 1001st particle.<br> <br></div><br><br>Is this really the case? I remember looking at TList a while ago and vaguely remember it being a doubly-linked list where the previous of first (head) would point to the last. Hence when addlast() is called it just goes to the previous of the first element. I may be wrong though :o. <br><br></td></tr></table><br>
<a name="715038"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >H&amp;K</td><td align="right"><font class=tiny>(Posted 2006)</font>&nbsp;<a href="#6">[#6]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> Not sure I understand what your Remove is doing but it is freeing the entire list. So you could just all trackerlist.clear() <br></div><br>From experiance of Greys posts he is almost certainly doing somthing else, and has just posted this as a stripped down version. But anyway doesnt list.clear() just loop through the list and remove all the links in the same way as Greys code? <br><br></td></tr></table><br>
<a name="715040"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Dreamora</td><td align="right"><font class=tiny>(Posted 2006)</font>&nbsp;<a href="#7">[#7]</a></td></tr></table></td></tr><tr ><td class="posttext"> Yes, add last adds the element directly to the end. BMs TList is a cyclic double linked list with a "fake" head element that points to first and last. <br><br></td></tr></table><br>
<a name="715064"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >DStastny</td><td align="right"><font class=tiny>(Posted 2006)</font>&nbsp;<a href="#8">[#8]</a></td></tr></table></td></tr><tr ><td class="posttext"> @H&amp;K - clear just cycles the links and releases them until the head is empty.  This is hugely faster than Foreach loop, and then calling remove.<br><br>@Dreamora &amp; @Alex O. - I stand corrected,  I hadnt looked at it in a while but thought I had seen it doing scans to last node.  Might have changed or I might be confused.  Thanks for clarification.  <br><br>Frankly I have given up using TLists for time critical code, due to the way it interacts with Garbage collecion I have found preaollocating and using custom pools completey removes Garbage collection, once I have set everything up.  Not to say I never use them I try to avoid them when they have large numbers of elements to process, like Particles.  This is standard trick for dealing with Garbage Collected languages, .NET, D++,  C++ with a Garbage Collector.  They make everything easy at the expense of random bumps in performance.  But nothing a lttle coding cant work around.<br><br>Doug Stastny <br><br></td></tr></table><br>
<a name="715078"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Grey Alien</td><td align="right"><font class=tiny>(Posted 2006)</font>&nbsp;<a href="#9">[#9]</a></td></tr></table></td></tr><tr ><td class="posttext"> Thanks.  H&amp;K is correct, that was just an example, what happens is there is a manage() method where the list is looped and depending on certain conditions remove() may be called.  Normally I use clear if I want to clear the whole list.<br><br>Budman: Yeah pooling is the way to go for particles but I wanted to write an OOP version using lists first. Pooling is more old-school (sort of like I used to code on the Amiga) but faster of course - I may well do it as an alternative option in my framework.  Also I want several lists at the moment so they can be drawn in a certain order (layers), with one big pooled list I couldn't do this, I'd have to make several pooled arrays which gets messy if they are declared globally as the handling routines can't be generic, or maybe they can...hmm. <br><br></td></tr></table><br>
<a name="715083"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >dmaz</td><td align="right"><font class=tiny>(Posted 2006)</font>&nbsp;<a href="#10">[#10]</a></td></tr></table></td></tr><tr ><td class="posttext"> Re: pooling...<br><a href="http://www.blitzbasic.com/Community/posts.php?topic=62667" target="_blank">http://www.blitzbasic.com/Community/posts.php?topic=62667</a> <br><br></td></tr></table><br>
<a name="715395"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >JoshK</td><td align="right"><font class=tiny>(Posted 2006)</font>&nbsp;<a href="#11">[#11]</a></td></tr></table></td></tr><tr ><td class="posttext"> Always use addfirst.  By definition, temporary objects will get sorted towards the front of the list for faster access, and permanent objects will get sorted to the end. <br><br></td></tr></table><br>
<a name="715448"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Grey Alien</td><td align="right"><font class=tiny>(Posted 2006)</font>&nbsp;<a href="#12">[#12]</a></td></tr></table></td></tr><tr ><td class="posttext"> I see, thanks. Well to be honest all the objects in my list are temporary so it's not an issue. <br><br></td></tr></table><br>
<a name="bottom"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td align="right"><a href="http://monkeycoder.co.nz" target="_blank"><img src="/img/monkey2.svg" ></a> <a href="https://github.com/blitz-research" target="_blank"><img src="/img/github.svg" ></a> <a href="https://discord.gg/qJccbSp" target="_blank"><img src="/img/discord.svg" ></a></td></tr></table><br></div><br><table width="100%"><tr><td></body></html lang="en">
