<!DOCTYPE html><html lang="en" ><head ><title >Possible Crash Bug in LibPNG of FreeImage.mod</title><meta name='viewport' content='width=device-width, initial-scale=0.66'><meta name='description' content='language:basic, target:desktop, category:game development'><link rel="styleSheet" href="../skins/granite/style.css" type="text/css"><style type="text/css">div.bbcode {padding: 8px;background: #E5E5E5;color: #000000;border: 1px dashed #B4B4BE;}</style></head><body ><table width=100% cellspacing=0 cellpadding=0><tr ><td class="menubarleft"></td><td class="menubar"><table cellspacing="0" cellpadding="0"><tr ><td >&nbsp;</td><td class="menuitemleft"></td><td class="menuitem"><a href="/" class="menuitem">News</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/forums.php" class="menuitem">Forums</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/codearcs.php" class="menuitem">Code</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/logs.php" class="menuitem">Logs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/gallery.php" class="menuitem">Gallery</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/sdkspecs.php" class="menuitem">Specs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/search.php" class="menuitem">Search</a></td><td class="menuitemright"></td></tr></table></td><td class="menubarright"></td></tr></table><div class="main"><h1 >Possible Crash Bug in LibPNG of FreeImage.mod</h1><a href="forums.php" >BlitzMax Forums</a>/<a href="topics.php?forum=124" >Brucey's Modules</a>/<a href="#bottom" >Possible Crash Bug in LibPNG of FreeImage.mod</a><br><br>
<a name="1132881"></a>

<a name="1132964"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Armitage 1982</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#1">[#1]</a></td></tr></table></td></tr><tr ><td class="posttext"> If you are using <b>freeimage.mod</b> (for example with CEgui) it comes with it's own version of <b>LibPNG</b> and <b>LibJPG</b>.<br><br>I'm using them instead of the BRL one to avoid conflicts.<br>The problem is Freeimage.mod currently using v1.2.40 of LibPNG while BRL was using an older v1.2.12.<br><br>Since I'm exclusively using Freeimage I get a nice EXCEPTION_ACCESS_VIOLATION ("pure virtual method called") error once every ~50 tilemap loading.<br>If it wasn't enough it only happen in release mode, never in debug mode and it's nearly impossible to reproduce that random crash.<br><br>I isolated the problem : obviously it's coming from a loadAnimImage() in my tilemap engine.<br>It's generally happening with a specific 768x1024 tilemap with 768 tiles of "32x32" pixels.<br><br><br>What I tried today was to manually update the LibPNG library inside Freeimage.mod from v1.2.40 to 1.2.48 (the last of that branch) and rebuild that module.<br><br>From the change log I see no breaking changes and my game is still working correctly.<br>I see no major fix either but I guess only time will tell if it was a good move or not (I'm nearly sure it won't change a thing).<br><br>I may eventually still try to use the same BRL v1.2.12 but I guess I will face low level problems with Freeimage this time.<br>Pretty hard to fix anything there... Too many breaking changes for recent version of LibPNG, I already try that just to see.<br><br>Does somebody using FreeImage.mod from Brucey already report such weird bug ?<br><br><font class="tiny">Last edited 2012</font> <br><br></td></tr></table><br>
<a name="1132898"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >AdamRedwoods</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#2">[#2]</a></td></tr></table></td></tr><tr ><td class="posttext"> you know what, i'm not kidding but i get that error.<br><br>I created an image viewer program and every so often i get that crash.<br>i thought it was because i was loading thumbnails embedded in large jpegs. perhaps i'll look into this. <br><br></td></tr></table><br>
<a name="1132931"></a>

<a name="1132937"></a>

<a name="1132943"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Armitage 1982</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#3">[#3]</a></td></tr></table></td></tr><tr ><td class="posttext"> I think I've spot someone else having a similar bug : <a href="http://blitzmax.com/Community/posts.php?topic=96210" target="_blank">http://blitzmax.com/Community/posts.php?topic=96210</a><br><br>If that crash happen again of if by chance updating (or downgrading) LibPNG fix it, I will report it here.<br><br>For the moment no more trace of it with the v1.2.48 yet.<br>(Home of the LibPNG v1.2 branch if someone else want to try : <a href="http://sourceforge.net/projects/libpng/files/libpng12/" target="_blank">http://sourceforge.net/projects/libpng/files/libpng12/</a> )<br><br><b>EDIT</b><br>40 minutes and counting : EXCEPTION_ACCESS_VIOLATION :D<br>Will try with v1.2.12 later on.<br><br><b>EDIT2</b><br>Everything still building and work fine with v1.2.12 (the same version BlitzMax is using). Hope it's coming from there or else... ?<br><br><font class="tiny">Last edited 2012</font> <br><br></td></tr></table><br>
<a name="1132959"></a>

<a name="1132963"></a>

<a name="1132966"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Armitage 1982</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#4">[#4]</a></td></tr></table></td></tr><tr ><td class="posttext"> LoadAnimImage() failed me once more, whatever the version of LibPNG I'm using...<br><br>It's a library EXCEPTION_ACCESS_VIOLATION ("pure virtual method called") error resulting in a C++ runtime crash, so I will probably have to use OllyDbg and make sure it's related to LibPNG or anything else.<br><br>Damned !<br><br><b>Edit</b><br>Don't know how to use OllyDbg, all I can tell is that there is a random bug somewhere in FreeImage.mod :(<br><br><font class="tiny">Last edited 2012</font> <br><br></td></tr></table><br>
<a name="1133006"></a>

<a name="1133007"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Armitage 1982</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#5">[#5]</a></td></tr></table></td></tr><tr ><td class="posttext"> SO !<br>Finally !<br><br>It's maybe not related with <b>LibPNG</b> not even with <b>Freeimage.mod</b>.<br><br>I discover one way to throw the EXCEPTION_ACCESS_VIOLATION : I simply endlessly reload the same level until it's happening (generally 9 times after).<br><br><br>I discover a few things about that error :<br><br>1) It's happening with LoadAnimImage()<br><br>2) It's happening only in Release mode, never in Debug Mode !<br><br>3) It will happen if I completely load each 768 cell_count of my tilemap<br>   (a PNG of 768x1024, cell_width=32, cell_height=32, first_cell=0)<br>   <b>BUT</b> it won't happen a single time if I'm loading 767 tiles only.<br>   I'm just talking about loading stuff here, I'm not even trying to render an unavailable 768th frames here.<br><br>4) If I call GCCollect() before using LoadAnimImage() (with the right amount of 768 cells) : <b>NO MORE CRASH</b><br><br>5) I'm reusing a Field variable here, If I'm doing a<br><pre class=code>image = Null
image = New TImage</pre><br>   before calling LoadAnimImage, it's like calling GCCollect() : <b>NO MORE CRASH</b><br><br>5') To be sure I'm now nullify, renew my variable type, call GCCollect() then I'm only using LoadAnimImage() : <b>NO CRASH</b> (for the moment).<br><br><br>So obviously there is something bad going on with garbage collection, or maybe I'm doing wrong when reusing Field variable without nullifying them. Dunno<br><br><br>Anyway, it's fixing my exception and it's all I ask !<br><br>Damn, it was tough !<br><br><font class="tiny">Last edited 2012</font> <br><br></td></tr></table><br>
<a name="1133496"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >ziggy</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#6">[#6]</a></td></tr></table></td></tr><tr ><td class="posttext"> Maybe raise a bug report for Mark to take a look to the GC? <br><br></td></tr></table><br>
<a name="1133909"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Armitage 1982</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#7">[#7]</a></td></tr></table></td></tr><tr ><td class="posttext"> It's a combination of third party modules and can only happen if you are using CEgui.mod particularly TCEsystem.renderGUI() in a very short frame (for example while updating a loading progress bar).<br><br>It's messing down the road for Freeimage and was the true responsible of that crash. I simply forget about using CEgui for loading progress and write my own loader. I guess something wrong is happening in OpenGL with CEgui but since I'm only using an old revision version (6.3) and since the official current one will soon be 8.0, there is no need to solve this.<br><br>I'm currently porting Box2D rev 247 to a new module (and it's taking ages since I know very little of C++). If I succeed in doing this I will try to do the same update with CEgui. Until then they (CrazyEddie) will surely release the version 0.8.0 which is already very compliant with OpenGL and way faster. <br><br></td></tr></table><br>
<a name="1219517"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >LT</td><td align="right"><font class=tiny>(Posted 2014)</font>&nbsp;<a href="#8">[#8]</a></td></tr></table></td></tr><tr ><td class="posttext"> Reviving this thread because I've been getting an error with FreeImage also.  But it's inconsistent and very hard to isolate.  I'm not using CEgui, so I know it's not that. <br><br></td></tr></table><br>
<a name="1219519"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >xlsior</td><td align="right"><font class=tiny>(Posted 2014)</font>&nbsp;<a href="#9">[#9]</a></td></tr></table></td></tr><tr ><td class="posttext"> Brucey released updated versions of the 'official' brl.mod and pub.mod modules using the latest versions of the image loader libraries -- perhaps those behave differently? <br><br></td></tr></table><br>
<a name="1219582"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >LT</td><td align="right"><font class=tiny>(Posted 2014)</font>&nbsp;<a href="#10">[#10]</a></td></tr></table></td></tr><tr ><td class="posttext"> Thanks, I did try that and it *seems* to have reduced the frequency that it occurs, but it still happens.  :( <br><br></td></tr></table><br>
<a name="1219597"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Brucey</td><td align="right"><font class=tiny>(Posted 2014)</font>&nbsp;<a href="#11">[#11]</a></td></tr></table></td></tr><tr ><td class="posttext"> Have you got some code that can reproduce the problem? <br><br></td></tr></table><br>
<a name="1219645"></a>

<a name="1219646"></a>

<a name="1219647"></a>

<a name="1220215"></a>

<a name="1220217"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >LT</td><td align="right"><font class=tiny>(Posted 2014)</font>&nbsp;<a href="#12">[#12]</a></td></tr></table></td></tr><tr ><td class="posttext"> Thanks for the reply, but unfortunately, I don't.  It happens "every once in a while" (TM).  I was hoping other people might have had some luck isolating the issue.<br><br>I know that commenting out FreeImage and using the brl loaders instead removes the problem.  Of course, it could be some other conflict with my code, but it started when I began using FreeImage.  The OP's description is exactly what I've experienced.<br><br>I just barely switched to the latest brl and pub mods and it has only happened once since then.  I suppose it's possible that even that one time was a fluke, so I'll keep using it and see if the problem comes back. <br><br></td></tr></table><br>
<a name="1220218"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >LT</td><td align="right"><font class=tiny>(Posted 2014)</font>&nbsp;<a href="#13">[#13]</a></td></tr></table></td></tr><tr ><td class="posttext"> UPDATE: It's not a fluke, but hard to track and I just don't have time right now. Going to use the brl loaders, for now.  :( <br><br></td></tr></table><br>
<a name="bottom"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td align="right"><a href="http://monkeycoder.co.nz" target="_blank"><img src="/img/monkey2.svg" ></a> <a href="https://github.com/blitz-research" target="_blank"><img src="/img/github.svg" ></a> <a href="https://discord.gg/qJccbSp" target="_blank"><img src="/img/discord.svg" ></a></td></tr></table><br></div><br><table width="100%"><tr><td></body></html lang="en">
