<!DOCTYPE html><html lang="en" ><head ><title >Multitasking using events</title><meta name='viewport' content='width=device-width, initial-scale=0.66'><meta name='description' content='language:basic, target:desktop, category:game development'><link rel="styleSheet" href="../skins/granite/style.css" type="text/css"><style type="text/css">div.bbcode {padding: 8px;background: #E5E5E5;color: #000000;border: 1px dashed #B4B4BE;}</style></head><body ><table width=100% cellspacing=0 cellpadding=0><tr ><td class="menubarleft"></td><td class="menubar"><table cellspacing="0" cellpadding="0"><tr ><td >&nbsp;</td><td class="menuitemleft"></td><td class="menuitem"><a href="/" class="menuitem">News</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/forums.php" class="menuitem">Forums</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/codearcs.php" class="menuitem">Code</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/logs.php" class="menuitem">Logs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/gallery.php" class="menuitem">Gallery</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/sdkspecs.php" class="menuitem">Specs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/search.php" class="menuitem">Search</a></td><td class="menuitemright"></td></tr></table></td><td class="menubarright"></td></tr></table><div class="main"><h1 >Multitasking using events</h1><a href="forums.php" >BlitzMax Forums</a>/<a href="topics.php?forum=102" >BlitzMax Programming</a>/<a href="#bottom" >Multitasking using events</a><br><br>
<a name="664084"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >ImaginaryHuman</td><td align="right"><font class=tiny>(Posted 2006)</font>&nbsp;<a href="#1">[#1]</a></td></tr></table></td></tr><tr ><td class="posttext"> I have some questions about how multitasking works with events.<br><br>1. I know that in the o/s, the program that manages the GUI interface, input and manipulation from the user, etc, runs in its own thread/process so that it can be pre-emptively multitasked along with any other programs running on the computer. This is so that the GUI remains responsive and the user can do things such as move or resize windows and click buttons even when other programs are doing stuff. Is that correct and does it apply to all three platforms?<br><br>2. When I add a hook function to trap events from the GUI, ie in MaxGUI, anything that my hook does is being called from within the GUI's thread/process as if part of that thread/process, and is therefore multitasking alongside any `main program loop` I might have in my program and competing with it for time. So my hook function and my main code loop are essentially running as two separate threads that pre-empt each other. Is that a correct description of what is happening?<br><br>3. To avoid one part of your program clashing with another part in this way, ie a main program loop being too CPU-hungry and causing the GUI to slow down because there isn't enough time left for the GUI thread, you should get rid of the main loop as much as possible (have a WaitEvent() only), and put all main loop stuff into some other event hook such as the TIMERTICK or GADGETPAINT, so that the whole program is run from events. Is that a correct description/concept?<br><br>4. Because the hook function is called `as part of` the o/s's GUI process, the o/s doesn't put any more events into OUR event queue until we return from our hook function. In other words, events don't pre-empt other events in our queue, right? So we should be careful not to spend too much time in a given event if we're waiting for another more important event like a TIMERTICK?<br><br>5. Since the hook is called from the GUI thread, and is multitasking separately from the rest of our program, so long as we return from the hook soon enough, we could set up timers for each `virtual thread` that we could use as our own way of switching between tasks and allocating timeslices. Then whenever a TIMERTICK happens we can decide what timer it came from and then choose a function to call based on that, ie task switching. So events let us implement a rudimentary kind of multitasking within our app, right?<br><br>6. Since we would be multitasking parts of the app, we'd have to be careful of what else our app might be doing in a main loop because it would've been pre-empted and we can't be certain that current state will mess up if we touch it in the middle of something. But if we implemented our own `thread management` or semaphores/locks type of thing, we could fairly `safely` do pretty much anything in the hook using any other functions/variables that are part of the program?<br><br>7. Since the hook program uses the same variables and functions as all the rest of our program, all of that stuff including all data, objects, graphics etc, are all shared openly between the hook and the main program right?<br><br>8. In summary, you can use events to trigger custom `threads` of execution based on timed events, so long as you ideally can put a given thread on `hold` by returning from the hook at the end of its allowed timeslice and resume with it the next time around?<br><br>Any other issues or faults with this that you can see? <br><br></td></tr></table><br>
<a name="664088"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >skidracer</td><td align="right"><font class=tiny>(Posted 2006)</font>&nbsp;<a href="#2">[#2]</a></td></tr></table></td></tr><tr ><td class="posttext"> There is no multithreading involved with hooks, they only execute when you call WaitEvent. <br><br></td></tr></table><br>
<a name="664089"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Dreamora</td><td align="right"><font class=tiny>(Posted 2006)</font>&nbsp;<a href="#3">[#3]</a></td></tr></table></td></tr><tr ><td class="posttext"> 1) Yes, unless Linux user played around with their sources :)<br><br>2) No they are all in the same thread and handled linearly (so if the main function takes too long, it might happen that a different hooks event is lined up seveal times in the event queue).<br><br>3) Depending on the action the hook shall do, yes<br><br>4) Correct. And you never should forget to pass an event back to the queue (return data) if there is a different hook that might need it as well (alternative is in the codearchivs -&gt; master event hook)<br><br>5) Yes. But the precision of the timer might come in as a problem there<br><br>6) Lock etc is not needed. As all runs in 1 thread, the situation where 2 different hooks / code parts try to access something can't come up. (the GC is not threadsafe, so using modules that add threading is a worse idea as well)<br><br>7) No. A hook is a function so its knowledge is restricted to its own variables and globals as with any other function<br><br>8) the only thing you can do with hooks is a simpler and especially "background controlled" timed programming like automatic updates of the physic calculates, drawing etc.<br>But you can't do anything like pause a thread or the like as you can't jump back to a specific position within a function.<br><br><br>So most likely you understood some parts of it, but everything refering to threads is wrong and thus I fear the summary as well ...<br><br>The only thing you can do through event hooks is let functions execute on their own without beeing part of a specific place in your mainloop.<br>But still: if a hook is running, the rest of the app is on halt. <br><br></td></tr></table><br>
<a name="664102"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >ImaginaryHuman</td><td align="right"><font class=tiny>(Posted 2006)</font>&nbsp;<a href="#4">[#4]</a></td></tr></table></td></tr><tr ><td class="posttext"> Hmm, ok. Thanks for the feedback guys.<br><br>Here are some follow-up questions, then.<br><br>1. Do hooks get called when you use PollEvent() as well?<br><br>2. In my main loop if I use PeekEvent() to look at the queue and if there is no event I do some processing, but when there is an event I do PollEvent(), do the hooks then get called and executed when the PollEvent() occurs? Does PeekEvent trigger the hooks? Do the hooks trigger when the event arrives in the queue regardless of whether we look at it?<br><br>3. Do you HAVE to have a place in your program where you call WaitEvent(), WaitSystem() or PollEvent(), in order for any hooks to ever be run at all? Otherwise the hooks are never run because control isn't handed over to the system?<br><br>4. Dreamora's comment on point 5 - So even if the timer is pretty accurate at generating events, the execution of the TIMERTICK hook is only as accurate as how often I call WaitEvent() to trigger the check?<br><br>5. Dreamora's comment on point 7 - But a hook can call any other function anywhere in the program, plus access global variables, so only locally-made variables are limited to the scope of the hook function, right?<br><br>6. Dreamora's comment on point 8 - That's presuming that you can't `suspend` whatever is being executed in order to return and resume later. With a regular BlitzMax program you can't, but with scripts or some other interpretation engine you can.<br><br>7. Okay so as I understand it, the hook function is not given to the o/s as something it should jump to, rather when you call WaitSystem()/WaitEvent()/PollEvent() BlitzMax goes through each event in the queue and calls the hook function for each one?<br><br>8. I understand that the hook would not be pre-empted by anything in the main program loop. But if your main program is using PeekEvent() so that it only runs the hooks when there are some, that's sort of a way of `cooperatively multitasking` at least, even though it's not pre-emptive?<br><br>Thanks for your time. <br><br></td></tr></table><br>
<a name="664130"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Dreamora</td><td align="right"><font class=tiny>(Posted 2006)</font>&nbsp;<a href="#5">[#5]</a></td></tr></table></td></tr><tr ><td class="posttext"> @Skid: I don't think hooks need a waitevent to be executed. Otherwise none of my modules would work at all ... (i know, you are the programmer behind it - but BM itself does some event handling behind the scene even in polled mode which seems to keep them active and up to date)<br><br><br>1) Yes. I've a particle module that updates hook based while the game itself is fully with "keyhit etc" without any event based function call. (using a timer that activates it)<br><br>2) No, event hooks get activated automatically when a event comes in<br><br>3) Nope :-) They come themself.<br><br>4) No, but its accuracy is restricted to 1000 ticks per second which means 1 per ms, nothing in between. Thats what I meant. Using a timer with frequency of 1000 on the other side is no usefull solution.<br><br>5) If I understand you: right. A hook is the same as a function and underlies the same restriction<br><br>6) With a virtual machine that uses threading, you could perhaps. But I don't know enough about it, ask koriolis, he is the BVM man :-)<br><br>7) most likely yes. But waitevent has the pro, that it halts the app until an event comes in (saves cpu time and accu on notebooks!)<br><br>8) Don't understand the question I fear. Hooks are not bound to peekevent / waitevent ... the only thing those 2 give you is the events that happened - which is independent of the hooks that you can't control beside removing them. <br><br></td></tr></table><br>
<a name="664164"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Beaker</td><td align="right"><font class=tiny>(Posted 2006)</font>&nbsp;<a href="#6">[#6]</a></td></tr></table></td></tr><tr ><td class="posttext"> You don't seem to need a WaitEvent for hooks.  This might be of interest to you:<br><a href="http://www.blitzbasic.com/codearcs/codearcs.php?code=1690" target="_blank">http://www.blitzbasic.com/codearcs/codearcs.php?code=1690</a> <br><br></td></tr></table><br>
<a name="664165"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >ImaginaryHuman</td><td align="right"><font class=tiny>(Posted 2006)</font>&nbsp;<a href="#7">[#7]</a></td></tr></table></td></tr><tr ><td class="posttext"> Dreamora, so what you are saying is that as soon as the o/s generates an event and puts it in our queue, the hook is called, regardless of where you are in the main program loop or what else you are doing. So all events pre-empt anything outside of the hook, is what you're saying?<br><br>Then, to be friendly, you should do WaitEvent() to give the o/s some CPU time, which is sort of cooperatively letting the events happen. So if you DON'T do that, then your main program is competing with the o/s GUI code, right?<br><br>I thought this is how it worked, too, because the whole point of doing a hook is that you need it where the o/s is locked into a modal scenario and normally your app would be shut out from doing any processing while the user is in that modal situation. So the o/s has to be immediately triggering the hook code as and when the event happens, so that you can update things, right?<br><br>For example when you resize the window by dragging the corner, your app freezes and nothing happens until you stop moving the mouse, at which point an event is sent, and only that event gets executed, it returns, and then again your app is locked out until the user releases the mouse button.<br><br>The odd thing is that if you move the window with the title bar, while you are not moving the mouse it actually does allow TIMERTICK events to trickle through, even though after you've moved the mouse and you stop it also sends WINDOWMOVE events.<br><br>So it's kind of confusing.<br><br>I need to know exactly when the hook is called and how, and whether it pre-empts/immediately suspends the rest of your app while it's doing so. I'm getting conflicting answers from Skid, from Dreamora and from apparent behavior of actual programs.<br><br>(As to your point #6 Dreamora, yes the virtual machine would need to manage how it deals with multiple programs and time allocation and state preservation etc, but it is possible. I have my own system working. I'm just trying to see how it can be incorporated into event-driven stuff). <br><br></td></tr></table><br>
<a name="664167"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >ImaginaryHuman</td><td align="right"><font class=tiny>(Posted 2006)</font>&nbsp;<a href="#8">[#8]</a></td></tr></table></td></tr><tr ><td class="posttext"> Thanks Beaker, useful to know things can be done with a separate timer. What I'm confused about is whether the o/s is deciding when the hook is called, or BlitzMax based on some request from our program. <br><br></td></tr></table><br>
<a name="664201"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >skidracer</td><td align="right"><font class=tiny>(Posted 2006)</font>&nbsp;<a href="#9">[#9]</a></td></tr></table></td></tr><tr ><td class="posttext"> Hmm yes sorry other than WaitEvent, functions that call PollSystem and hence allow system events to be processed causing hooks to happen and events to be queued include:<br><br>PeekEvent<br>PollEvent<br>AppSuspended<br>AppTerminate<br>KeyHit<br>KeyDown<br>GetChar<br>FlushKeys<br>MouseX,Y,Z<br>FlushMouse<br>MouseHit<br>MouseDown<br>WaitKey<br>WaitChar<br>WaitMouse <br><br></td></tr></table><br>
<a name="664215"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Dreamora</td><td align="right"><font class=tiny>(Posted 2006)</font>&nbsp;<a href="#10">[#10]</a></td></tr></table></td></tr><tr ><td class="posttext"> so about anything that is more than a screensaver ;-) <br><br></td></tr></table><br>
<a name="664231"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >ImaginaryHuman</td><td align="right"><font class=tiny>(Posted 2006)</font>&nbsp;<a href="#11">[#11]</a></td></tr></table></td></tr><tr ><td class="posttext"> Interesting. Thanks Mr Racer.<br><br>So even peeking at the queue will cause the hooks to be processed. .. .and the hooks are ONLY processed when one of the above commands is called? <br><br></td></tr></table><br>
<a name="664306"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Dreamora</td><td align="right"><font class=tiny>(Posted 2006)</font>&nbsp;<a href="#12">[#12]</a></td></tr></table></td></tr><tr ><td class="posttext"> No, using graphics will do it as well as this uses hooks behind the scene on its own. (polled input) <br><br></td></tr></table><br>
<a name="664436"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >ImaginaryHuman</td><td align="right"><font class=tiny>(Posted 2006)</font>&nbsp;<a href="#13">[#13]</a></td></tr></table></td></tr><tr ><td class="posttext"> Does polled input just run some kind of timer and poll for an event when the timer is triggered, so it can get the mouse/keyboard input stuff? <br><br></td></tr></table><br>
<a name="bottom"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td align="right"><a href="http://monkeycoder.co.nz" target="_blank"><img src="/img/monkey2.svg" ></a> <a href="https://github.com/blitz-research" target="_blank"><img src="/img/github.svg" ></a> <a href="https://discord.gg/qJccbSp" target="_blank"><img src="/img/discord.svg" ></a></td></tr></table><br></div><br><table width="100%"><tr><td></body></html lang="en">
