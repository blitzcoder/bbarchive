<!DOCTYPE html><html lang="en" ><head ><title >brainpop- Cast to and from a pointer</title><meta name='viewport' content='width=device-width, initial-scale=0.66'><meta name='description' content='language:basic, target:desktop, category:game development'><link rel="styleSheet" href="../skins/granite/style.css" type="text/css"><style type="text/css">div.bbcode {padding: 8px;background: #E5E5E5;color: #000000;border: 1px dashed #B4B4BE;}</style></head><body ><table width=100% cellspacing=0 cellpadding=0><tr ><td class="menubarleft"></td><td class="menubar"><table cellspacing="0" cellpadding="0"><tr ><td >&nbsp;</td><td class="menuitemleft"></td><td class="menuitem"><a href="/" class="menuitem">News</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/forums.php" class="menuitem">Forums</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/codearcs.php" class="menuitem">Code</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/logs.php" class="menuitem">Logs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/gallery.php" class="menuitem">Gallery</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/sdkspecs.php" class="menuitem">Specs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/search.php" class="menuitem">Search</a></td><td class="menuitemright"></td></tr></table></td><td class="menubarright"></td></tr></table><div class="main"><h1 >brainpop- Cast to and from a pointer</h1><a href="forums.php" >BlitzMax Forums</a>/<a href="topics.php?forum=102" >BlitzMax Programming</a>/<a href="#bottom" >brainpop- Cast to and from a pointer</a><br><br>
<a name="852287"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Damien Sturdy</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#1">[#1]</a></td></tr></table></td></tr><tr ><td class="posttext"> Hi All,<br><br>Bit of a brainfart here. some C++ side code we are using requires we pass it a Byte PTR, and at a later point it returns this same Byte PTR.<br><br>THing is, in blitzmax it is an Object. It is cast to a pointer, sent, then retrieved later.<br><br>How can I cast the returned Byte PTR back to an object? <br><br></td></tr></table><br>
<a name="852290"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >ziggy</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#2">[#2]</a></td></tr></table></td></tr><tr ><td class="posttext"> Not sure how to do it properly, but keep in mind to store a pointer to the object instance alive on BlitzMax code, if you don't want your object to be deleted by the GC while it is being processed by the C++ code. <br><br></td></tr></table><br>
<a name="852308"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >grable</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#3">[#3]</a></td></tr></table></td></tr><tr ><td class="posttext"> You could try something like this:<br><pre class=code>
Local obj:Object = New TList
Local res:Object
Local p:Int Ptr = Int Ptr Varptr res
p[0] = Int yourfunc( obj)
Print "res  : " + (Int Byte Ptr res)
Print "obj  : " + (Int Byte Ptr obj)
Print "equal: "+(res = obj)

Function yourfunc:Byte Ptr( p:Byte Ptr)
	Return p - 8 ' this is important, object -&gt; ptr skips 8 bytes apparantly
EndFunction
</pre><br>But it might mess with the ref count or cause some other GC releated issue. <br><br></td></tr></table><br>
<a name="852327"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Brucey</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#4">[#4]</a></td></tr></table></td></tr><tr ><td class="posttext"> p - 8 ??<br><br>If you are using C++, why not just let C++ worry about it? No point jumping through hoops you don't have to.<br><br><pre class=code>
' some BlitzMax code
Extern
    Function GoodbyeObject(obj:Object)
    Function HelloObject:Object()
End Extern

// some C++ glue...
extern "C" {

  void GoodbyeObject(void * obj);
  void * HelloObject();

}
</pre><br><br>As ziggy points out, you'll need to keep the object reference alive somehow (either in BlitzMax or with C++). <br><br></td></tr></table><br>
<a name="852339"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Dreamora</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#5">[#5]</a></td></tr></table></td></tr><tr ><td class="posttext"> you can not cast byte ptr to an object anymore. so if you return byte ptr it will remain a memory block <br><br></td></tr></table><br>
<a name="852364"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Damien Sturdy</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#6">[#6]</a></td></tr></table></td></tr><tr ><td class="posttext"> Ok, the object is safe in blitzmax and is alive for as long as the callback is in use, so GC is not an issue.<br><br><div class="quote"> <br>you can not cast byte ptr to an object anymore. so if you return byte ptr it will remain a memory block <br> <br></div><br><br>That puts one HELL of a bummer on something. Why the hell cant you cast the byte ptr to an object anymore!?<br><br>everyone else: Thanks. We cannot change the C++ side code. In fact what I am doing is storing a pointer to a Max object with a C++ object (a newton body in fact.) the newton callback (which is in blitzmax and working fine) is then supposed to retrieve this pointer and cast it back to an object, which contains forces etc that we want applied.<br><br>Ugh. <br><br></td></tr></table><br>
<a name="852371"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Brucey</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#7">[#7]</a></td></tr></table></td></tr><tr ><td class="posttext"> Oh well... my example is the easiest to implement, and it known to work well - see many of my modules as examples.<br><br>Good luck with it :-) <br><br></td></tr></table><br>
<a name="852372"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Damien Sturdy</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#8">[#8]</a></td></tr></table></td></tr><tr ><td class="posttext"> Yeah, its how I was doing it, but it didn't work, and the object that was returned was invalid. :-( Thanks though :-)<br><br>in fact, its how we're doing it with another type, but i guess there are some internal differences with the other type and this one (they use different functions C++ side too.) <br><br></td></tr></table><br>
<a name="852432"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Dreamora</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#9">[#9]</a></td></tr></table></td></tr><tr ><td class="posttext"> [quote]That puts one HELL of a bummer on something. Why the hell cant you cast the byte ptr to an object anymore!?¨[/code]<br><br><br>because BM is type safe and typesafeness can not be ensured if you can cast "nothing" to a type.<br>but you can implement a method "fromBytePtr" and read out all the data into an existing type instance. <br><br></td></tr></table><br>
<a name="852438"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Damien Sturdy</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#10">[#10]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> <br>but you can implement a method "fromBytePtr" and read out all the data into an existing type instance. <br> <br></div><br><br>Ew. my lord. The reason is to keep Bmax Typesafe? seems like an anti-idiot technique to me. *sigh*<br><br>Sorry for being grumpy, I'm feeling a little let down by this to be honest. <br><br></td></tr></table><br>
<a name="852442"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Brucey</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#11">[#11]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> the object that was returned was invalid. <br></div><br>maybe you did something wrong?<br><br>If the library takes userdata as a void* then it won't be doing anything to it, only passing it back to you later.<br><br>So, passing it in as Object (no ptr conversion nonsense required), it will be returned as Object too - ie. same memory location. You just have to be absolutely sure you are holding onto the reference yourself. <br><br></td></tr></table><br>
<a name="852449"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Dreamora</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#12">[#12]</a></td></tr></table></td></tr><tr ><td class="posttext"> Typesafeness is one of the most important OO concepts.<br>Even C++ has basics of that concept (not fully fledged as other languages, but at least it got better in the last few years)<br><br>Why do you think has the String class a fromCString and fromWString function?<br><br>Typesafeness is one of the most important mechanisms to create correctly working modules that idiots from outside can not break by stupidly casting incompatible stuff around.<br><br>It is important that it is like that, otherwise you could by accedint get some byte ptr data in that is incorrect and that would just crash the GC. <b>That</b> would be stupid!<br><br>If you don't want to do that, use extern types and generate the objects within C++ and only use them within BM.<br>Thats the simple alternative if you need shared objects.<br>That as well will take care that you don't get any GC conflicts <br><br></td></tr></table><br>
<a name="852490"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Damien Sturdy</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#13">[#13]</a></td></tr></table></td></tr><tr ><td class="posttext"> I honestly think Bruceys solution, IE the solution we were already attempting to use, should work. Saying that, I believe that if a user wants to cast from a pointer to an object, then they should be able to.<br><br><div class="quote"> <br>If you don't want to do that, use extern types and generate the objects within C++ and only use them within BM.<br>Thats the simple alternative if you need shared objects.<br> <br></div><br><br>It can't work like that, being an Ogre wrapper for blitzmax hehe. As I say though, I think something else might be up. Appologies for being a grump, and thanks for yourhelp guys. <br><br></td></tr></table><br>
<a name="852494"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Dreamora</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#14">[#14]</a></td></tr></table></td></tr><tr ><td class="posttext"> Pointing a memory block to object can not work for a simple reason: it would not work with the GC driven background.<br>No managed language allows you to do that, you always have to write "wrapper code" that takes the byte data and returns you the object.<br>The common way is the "fromXY" function that returns the object. Lazy people have a method that overwrites the content of an already existing object with the data from the byte block. Reason is that it allows you to use a single object as temporary container for multiple data, if you are enumerating / iterating for example. <br><br></td></tr></table><br>
<a name="852517"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Brucey</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#15">[#15]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> Lazy people have a method that overwrites the content of an already existing object with the data from the byte block. <br></div><br>Well, no-one in their right mind would do that - although it happens to be done in the BRL FreeTypeFont module, from what I remember :-) <br><br></td></tr></table><br>
<a name="852536"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Dreamora</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#16">[#16]</a></td></tr></table></td></tr><tr ><td class="posttext"> Well as mentioned, its for lazy people.<br>I only use it on classes where I know that I only need them temporally inbetween and where I don't want to flood the GC (vectors banks for example), so the performance raises drastically. <br><br></td></tr></table><br>
<a name="bottom"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td align="right"><a href="http://monkeycoder.co.nz" target="_blank"><img src="/img/monkey2.svg" ></a> <a href="https://github.com/blitz-research" target="_blank"><img src="/img/github.svg" ></a> <a href="https://discord.gg/qJccbSp" target="_blank"><img src="/img/discord.svg" ></a></td></tr></table><br></div><br><table width="100%"><tr><td></body></html lang="en">
