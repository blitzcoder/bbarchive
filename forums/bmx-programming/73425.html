<!DOCTYPE html><html lang="en" ><head ><title >TBanks and Memory</title><meta name='viewport' content='width=device-width, initial-scale=0.66'><meta name='description' content='language:basic, target:desktop, category:game development'><link rel="styleSheet" href="../skins/granite/style.css" type="text/css"><style type="text/css">div.bbcode {padding: 8px;background: #E5E5E5;color: #000000;border: 1px dashed #B4B4BE;}</style></head><body ><table width=100% cellspacing=0 cellpadding=0><tr ><td class="menubarleft"></td><td class="menubar"><table cellspacing="0" cellpadding="0"><tr ><td >&nbsp;</td><td class="menuitemleft"></td><td class="menuitem"><a href="/" class="menuitem">News</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/forums.php" class="menuitem">Forums</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/codearcs.php" class="menuitem">Code</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/logs.php" class="menuitem">Logs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/gallery.php" class="menuitem">Gallery</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/sdkspecs.php" class="menuitem">Specs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/search.php" class="menuitem">Search</a></td><td class="menuitemright"></td></tr></table></td><td class="menubarright"></td></tr></table><div class="main"><h1 >TBanks and Memory</h1><a href="forums.php" >BlitzMax Forums</a>/<a href="topics.php?forum=102" >BlitzMax Programming</a>/<a href="#bottom" >TBanks and Memory</a><br><br>
<a name="820352"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Fry Crayola</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#1">[#1]</a></td></tr></table></td></tr><tr ><td class="posttext"> I currently use TBanks to store a great deal of information in a memory efficient way - for example, if I have to store data in the range 0-15, I can store it in 4 bits rather than using up a full byte. I have written a module that sets up a bank for each table of data and provides the functions to access and change it.<br><br>A single record within a table is split up into what I call "groups", for example a competition's list of entrants would be one group containing a number of fields (in this case, the team record number and a seeding value). A group can have many entries. It's obviously not a well normalised database, but memory usage was a concern.<br><br>Recently though I've been concerned about performance - if a single record needs to be expanded to store more data, such as a competition's list of participating teams, I need to shift all the data following that. I try to avoid this where possible, knowing where memory is likely to be needed and allocating it in advance, but it's far from perfect.<br><br>Of course, this is old code, and I think it's time to optimise it for performance. I was thinking today that it might be better if every entry of every group of every record had its own bank. Adding an entry to a group would have no effect on any other information - no shifting of data is required, and thus it is faster.<br><br>I decided to see what memory overheads were involved with regards to creating many banks, so I wrote the following piece of code:<br><br><pre class=code>
SuperStrict

Print GCMemAlloced()

Local x:TBank[575000]

For Local count:Int = 0 To 574999
	x[count] = CreateBank(60)
	PokeByte(x[count], 59, 255)
Next

Print GCMemAlloced()</pre><br><br>This created a bank large enough for 575,000 records, each with a size of 60 bytes. It output:<br><br>11966<br>16111990<br><br>Roughly 16MB allocated. MemAlloced doesn't seem to return the size of the banks, which would be just over 34MB.<br><br>Allocating the memory in one single bank, as my current implementation uses, looks like this:<br><br><pre class=code>
SuperStrict

Print GCMemAlloced()

Local x:TBank = CreateBank(34500000)
PokeByte(x, 0, 255)
PokeByte(x, 34499999, 255)

Print GCMemAlloced()</pre><br><br>And results in:<br><br>11966<br>12012<br><br>Which certainly seems to indicate that the bank memory isn't considered at all.<br><br>Which means that a 16MB overhead seems amazingly wasteful just to allocate 34MB in 60 byte chunks, compared to the few bytes used to allocate the whole pile.<br><br>So, questions:<br><br>What's the reason for GCMemAlloced() not informing you of the memory used by banks?<br><br>And secondly, anyone got any good ideas for what I'm wanting to do? If I knew of any database modules out there that would allow me to store values in the minimum amount of space possible, I'd surely give them a try, but I'm not aware of any. Of course, I could just be ignorant of them all. :) <br><br></td></tr></table><br>
<a name="820397"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Fry Crayola</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#2">[#2]</a></td></tr></table></td></tr><tr ><td class="posttext"> Actually, we can scratch most of this. I'd still be interested to know why the bank memory isn't returned in GCMemAlloced(), but the rest is no longer an issue.<br><br>I spent the evening working out how much more memory I'd need to store everything in whole bytes, as per normal. It came out at 55.5MB. The vast majority (51.5MB) of that comes from a single table, which holds details of all the people in the game and was the reason I was using such a system in the first place - their attributes are over deliberately small ranges to fit more in memory. I'd assumed that it would be a good idea to extend the theory over the entire database, but it doesn't make sense to do so any more. <br><br>I can still store the person attributes in an encoded form within a standard database, so I'll be doing that. <br><br></td></tr></table><br>
<a name="820401"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Dreamora</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#3">[#3]</a></td></tr></table></td></tr><tr ><td class="posttext"> There is nothing to be collected.<br>All references are fully valid at the point of gc collect.<br><br>Even if not: There is no guarantee global scope variables get cleaned up when you null-ify them straight away, even less if they are globals <br><br></td></tr></table><br>
<a name="bottom"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td align="right"><a href="http://monkeycoder.co.nz" target="_blank"><img src="/img/monkey2.svg" ></a> <a href="https://github.com/blitz-research" target="_blank"><img src="/img/github.svg" ></a> <a href="https://discord.gg/qJccbSp" target="_blank"><img src="/img/discord.svg" ></a></td></tr></table><br></div><br><table width="100%"><tr><td></body></html lang="en">
