<!DOCTYPE html><html lang="en" ><head ><title >Sending keystrokes to other applications</title><meta name='viewport' content='width=device-width, initial-scale=0.66'><meta name='description' content='language:basic, target:desktop, category:game development'><link rel="styleSheet" href="../skins/granite/style.css" type="text/css"><style type="text/css">div.bbcode {padding: 8px;background: #E5E5E5;color: #000000;border: 1px dashed #B4B4BE;}</style></head><body ><table width=100% cellspacing=0 cellpadding=0><tr ><td class="menubarleft"></td><td class="menubar"><table cellspacing="0" cellpadding="0"><tr ><td >&nbsp;</td><td class="menuitemleft"></td><td class="menuitem"><a href="/" class="menuitem">News</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/forums.php" class="menuitem">Forums</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/codearcs.php" class="menuitem">Code</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/logs.php" class="menuitem">Logs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/gallery.php" class="menuitem">Gallery</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/sdkspecs.php" class="menuitem">Specs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/search.php" class="menuitem">Search</a></td><td class="menuitemright"></td></tr></table></td><td class="menubarright"></td></tr></table><div class="main"><h1 >Sending keystrokes to other applications</h1><a href="forums.php" >BlitzMax Forums</a>/<a href="topics.php?forum=102" >BlitzMax Programming</a>/<a href="#bottom" >Sending keystrokes to other applications</a><br><br>
<a name="1184049"></a>

<a name="1184050"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Arabia</td><td align="right"><font class=tiny>(Posted 2013)</font>&nbsp;<a href="#1">[#1]</a></td></tr></table></td></tr><tr ><td class="posttext"> I want to control another program (MAME for those who know it), I searched and found this thread:<br><br><a href="http://www.blitzmax.com/Community/posts.php?topic=48863" target="_blank">http://www.blitzmax.com/Community/posts.php?topic=48863</a><br><br>which shows how to send info to Notepad<br><br>Couple of things I'm not sure of from the example:<br><br><pre class=code>
Const WM_SETTEXT = $00C

Extern "Win32"

	Function FindWindow( lpClassName$z, lpWindowName$z ) = "FindWindowA@8"
	Function FindWindowEx( hwnd1:Int, hwnd2:Int, lpsz1$z, lpsz2$z ) = "FindWindowExA@16"
	Function SendMessage( hwnd, msg, wparam:Byte Ptr, lparam:Byte Ptr ) = "SendMessageA@16"
	Function GetLastError()

End Extern

'win=FindWindow( "SciCalc", "Calculator" )

win=FindWindow( "NotePad", "Untitled - Notepad" )
edit=FindWindowEx( win, Null, "Edit", Null )

SendMessage( edit, WM_SETTEXT, Null, "hi" )
</pre><br><br>So in the line win=FindWindow ("NotePad", "Untitled - Notepad" ) <br>I'd obviously need to change this to the application I'm trying to control, so in my case the program name is "Mame" and the title bar will look something like: "MAME: Donkey Kong (US set 1) [dkong]"<br><br>So if I change this to now read:<br><br>win=FindWindow( "Mame", "MAME: Donkey Kong (US set 1) [dkong]" )<br><br>I don't understand the purpose of the next line however:<br><br><pre class=code>
edit=FindWindowEx( win, Null, "Edit", Null )
</pre><br><br>So I leave it as is.  Run my program, and nothing happens. I've changed the SendMessage line to send a "5" to the application which should add a credit to the game, but nothing<br><br>If I put a line in error = getlasterror() and then print this result, I get 1400 which if looked up on MSDN is:<br><br>ERROR_INVALID_WINDOW_HANDLE<br>1400 (0x578)<br>Invalid window handle<br><br>Any ideas what could be going wrong?  or is there an easier way to do this?  What I've found on the forums so far is 8+ years old, not sure if there is any easier way to control other apps from within BM<br><br>Thanks <br><br></td></tr></table><br>
<a name="1184055"></a>

<a name="1184056"></a>

<a name="1184057"></a>

<a name="1184059"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >col</td><td align="right"><font class=tiny>(Posted 2013)</font>&nbsp;<a href="#2">[#2]</a></td></tr></table></td></tr><tr ><td class="posttext"> The line<br><br>edit = FindWindowEx(win,Null,"Edit",Null)<br><br>will search through all the child windows of 'win' for a window control that has a class of 'Edit'.<br><br>The 'Edit' class is the class name of the text area 'gadget' which is a child 'gadget' of the main notepad application/window.<br><br>If you have Visual Studio installed then you may already have a tool called Spy++ as part of the installation. I'm not sure if comes with the express version however. If not, then you can <a href="http://mdb-blog.blogspot.co.uk/2010/11/microsoft-spy-or-spyxx-for-download.html" target="_blank">download Spy ++ from here</a><br><br>Its a great tool and can give you much more information that you need.<br><br>Hope it helps. <br><br></td></tr></table><br>
<a name="1184133"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Arabia</td><td align="right"><font class=tiny>(Posted 2013)</font>&nbsp;<a href="#3">[#3]</a></td></tr></table></td></tr><tr ><td class="posttext"> Thanks, I downloaded Spy but can't get it working (yet).  I'll keep playing around and see if I can work out what I'm doing wrong. <br><br></td></tr></table><br>
<a name="1184214"></a>

<a name="1184215"></a>

<a name="1184216"></a>

<a name="1184218"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >col</td><td align="right"><font class=tiny>(Posted 2013)</font>&nbsp;<a href="#4">[#4]</a></td></tr></table></td></tr><tr ><td class="posttext"> In Spy++...<br><br>In the Search menu choose Find Window... a dialog window appears, or click the binocular icon in the toolbar.<br>In the middle there an icon called 'Finder Tool', the icon looks like it has a target in the centre. You click and hold the mouse down over the target icon so the cursor turns to a target cursor.<br>Keeping the mouse button pressed, drag the cursor over any window and the information in the Finder Window will tell you some brief information which ever window/gadget the mouse is hovering over, such as the window/gadget name and class name.<br>Once the information is in the Finder Window, release the mouse button then press OK in the Finder window...<br>The tree view will highlight an entry for that window. You can 'right-click' over that entry and select 'Properties' to get some detailed information about it. <br><br></td></tr></table><br>
<a name="1184267"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Arabia</td><td align="right"><font class=tiny>(Posted 2013)</font>&nbsp;<a href="#5">[#5]</a></td></tr></table></td></tr><tr ><td class="posttext"> Ah okay, I still haven't got Spy++ working (or my program) but I'll keep playing.<br><br>I've made a few changes and have<br><br><pre class=code>
error = getlasterror()
Print error

win=FindWindow( "Mame", "MAME: Donkey Kong (US set 1) [dkong]" )
'edit=FindWindowEx( win, Null, "Edit", Null )
Print win

SendMessage( win, WM_SETTEXT, Null, "5" )
error = getlasterror()
Print error
Print win
</pre><br><br>The resulting output is:<br>122<br>590924<br>122<br>590924<br><br>The 122 error code is a buffer undersize error, but I'm getting this before I do anything at all which is a bit weird as well as getting the error after I make the SendMessage call.<br><br>The 590924 (correct me If I'm wrong) is just a unique identifier (handle) to the Window - so it's obviously finding it.<br><br>When the program executes, the following line is working:<br><br><pre class=code>
SendMessage( win, WM_SETTEXT, Null, "5" )
</pre><br><br>but not in the way I expected, it's changing the title bar for the application.  So I'm guessing I'm using the wrong "WM_" constant to do what I want.<br><br>All the application (MAME) is doing as far as I'm aware is polling for keyboard input constantly, so I'll have to look more into the SendMessage syntax and the WM_ constants that you can supply it.   Sorry if this looks like stupid comments/questions - I have zero experience with stuffing around with Windows APIs.<br><br>Will keep playing. <br><br></td></tr></table><br>
<a name="1184302"></a>

<a name="1184303"></a>

<a name="1184304"></a>

<a name="1184305"></a>

<a name="1184306"></a>

<a name="1184307"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >col</td><td align="right"><font class=tiny>(Posted 2013)</font>&nbsp;<a href="#6">[#6]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> <br>Sorry if this looks like stupid comments/questions - I have zero experience with stuffing around with Windows APIs.<br> <br></div><br><br>Of course not! Thats what the forums are for - to get some help and advice. I'm only glad to help if I can.<br><br>The GetLastError() is used by the whole thread that your code is running on. There's actually quite a lot of BlitzMax code that gets run well before the first line in your source gets run, so the GetLastError() value could be a left over result from code of one of the modules. Just for the record I get the same value if I print GetLastError() from the first line. I wouldn't worry about checking the result at the top of your code though, only after functions that you call that you know will leave a result that be can retrieved by GetLastError() - not all functions leave a result that way. SendMessage will only leave a result for GetLastError() if it fails due to a UIPI block ( incorrect privilege level ), and any result is also returned from the SendMessage function itself.<br><br><div class="quote"> <br>it's changing the title bar for the application<br> <br></div><br>Thats the behavior I would expect to happen.<br><br>Using<br><pre class=code>
win=FindWindow( "Mame", "MAME: Donkey Kong (US set 1) [dkong]" )
</pre><br>will give you a 'handle' ( the value of 'win' is the handle value ) to the top level main window and the behavior of sending a WM_SETTEXT message to the main window is to change its title bar text. Other type of  class control, ie the 'Edit' control class will respond to a WM_SETTEXT message differently by inserting the text into the text field of that control.<br><br>I would have thought you should send WM_KEYDOWN followed by a WM_KEYUP? There's also a SendInput function that sends simulated key-presses to the system. A possible down-side to SendInput is that thefunction sends to the top most window that has the focus. That may not be what you want.<br><br>I'm not so familiar with how to send data to Mame. I would have thought that the Mame docs would tell you? so the above methods may not work if Mame isnt set up to respond to those types of window events being sent to it. I thought the windows version of Mame used DirectInput or has it been changed nowadays? <br><br></td></tr></table><br>
<a name="1184375"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Arabia</td><td align="right"><font class=tiny>(Posted 2013)</font>&nbsp;<a href="#7">[#7]</a></td></tr></table></td></tr><tr ><td class="posttext"> I used GetError before and after just see if the values were changing.  In my original code it was, and it was because I wasn't getting the handle to the window, so I wasn't overly worried when it came back with two exact same values before and after my code ran, but thanks for the input - that makes a lot of sense.<br><br>I'll try with  the WM_KEYDOWN, WM_KEYUP as you suggested and report back.<br><br>MAME is an odd one, I've not downloaded their code (not that I can really understand C++ anyway) but I do believe they switched to DirectDraw &amp; DirectInput some time ago, though I'm not positive.<br><br>This all came about from another forum where we were talking about teaching a computer to play a classic arcade game, yes it can be done, but I'd like to give it a go myself and my first thought was to give it a go with BM, without thinking the problem through I thought it would be relatively simple to send keystokes to any Windows application - but that may not be the case given what you've told me.<br><br>Anyway, I'll try and have a bit more of a play/research this weekend.  Thanks for all your help Col.<br><br>Will definitely post back here if I get something working. <br><br></td></tr></table><br>
<a name="1184556"></a>

<a name="1184557"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >skidracer</td><td align="right"><font class=tiny>(Posted 2013)</font>&nbsp;<a href="#8">[#8]</a></td></tr></table></td></tr><tr ><td class="posttext"> Here is a more low level approach that uses the Win32 SendInput command.<br><br><pre class=code>
Extern "win32" 

Function SendInput(inputcount,inputdata:Byte Ptr,size)

End Extern

Type KeyInput
	Field inputtype
	Field vkeycode:Short
	Field scancode:Short
	Field flags
	Field time
	Field extra
	Field pad1
	Field pad2
EndType

Function PostKeyDown%(keycode)
	Global akey:KeyInput=New KeyInput
	akey.inputtype=1
	akey.scancode=keycode
	akey.flags=4
	Local res=SendInput( 1,akey,28 )
	Return res
EndFunction

For i=1 To 100
	PostKeyDown 100
	Delay 100
Next
</pre> <br><br></td></tr></table><br>
<a name="1184687"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Arabia</td><td align="right"><font class=tiny>(Posted 2013)</font>&nbsp;<a href="#9">[#9]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> <br>I would have thought you should send WM_KEYDOWN followed by a WM_KEYUP? There's also a SendInput function that sends simulated key-presses to the system. A possible down-side to SendInput is that the function sends to the top most window that has the focus. That may not be what you want.<br> <br></div><br><br>The WM_KEYDOWN / WM_KEYUP doesn't work, neither does the SendInput that SkidRacer posted (thanks for that btw).  I'll have to have a look at the Mame Dev docs and see if there is any info there on how to accomplish what I'm trying to do - guessing it's not relying on DirectInput or key presses via SendInput <br><br></td></tr></table><br>
<a name="1184698"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >skidracer</td><td align="right"><font class=tiny>(Posted 2013)</font>&nbsp;<a href="#10">[#10]</a></td></tr></table></td></tr><tr ><td class="posttext"> I always wanted to build mame as a BlitzMax module... <br><br></td></tr></table><br>
<a name="1184878"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Russell</td><td align="right"><font class=tiny>(Posted 2013)</font>&nbsp;<a href="#11">[#11]</a></td></tr></table></td></tr><tr ><td class="posttext"> Well, MAME is completely open-source, after all, so maybe looking in there would help? (It's quite scary in there if you are not versed in C!)<br><br>Arabia, what are you trying to accomplish?<br><br>Russell <br><br></td></tr></table><br>
<a name="1184881"></a>

<a name="1184882"></a>

<a name="1184883"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Hezkore</td><td align="right"><font class=tiny>(Posted 2013)</font>&nbsp;<a href="#12">[#12]</a></td></tr></table></td></tr><tr ><td class="posttext"> I have also been trying to send keystrokes to MAME for a long time.<br>I was making an Arcade Frontend for arcade machines and wanted one of the buttons on the machine to act as Quick Save and another one as Quick Load.<br>But no matter how much I tried, I could never have MAME answer to emulated keystrokes while every other emulator I tried did.<br><br>I think you can compile MAME to use its old input system instead of the "new" DirectInput, and the old one apparently allows for emulated keystrokes.<br>That solution does however not work for me as not all users using my Arcade Frontend will use the specially compiled MAME version.<br><br>So I too would like a solution for this. <br><br></td></tr></table><br>
<a name="1184943"></a>

<a name="1184945"></a>

<a name="1184946"></a>

<a name="1184948"></a>

<a name="1184949"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >col</td><td align="right"><font class=tiny>(Posted 2013)</font>&nbsp;<a href="#13">[#13]</a></td></tr></table></td></tr><tr ><td class="posttext"> I've been reading through the docs and some source of MAME. MAME reads input via the <a href="http://msdn.microsoft.com/en-gb/library/windows/desktop/ms645590(v=vs.85).aspx" target="_blank">WM_INPUT</a> windows message.<br>I thought if I create a WM_INPUT message and sent it into MAME that it would work. MAME does read it but it doesnt respond. It turns out that I was sending in a pointer to a <a href="http://msdn.microsoft.com/en-gb/library/windows/desktop/ms645562(v=vs.85).aspx" target="_blank">RAWINPUT</a> structure, but you need to send in a HANDLE to the RAWINPUT structure ( See Remarks on WM_INPUT linked page ).<br><br>Now the fun part really begins :-) How do you create a windows handle to our structure. I tried using various Windows API memory allocation functions GlobalAlloc/VirtualAlloc plus others that are related and it still doesn't work. I then read up on how/what creates the WM_INPUT message in the system - it turns out that device drivers create this message before pushing it into the system.<br><br>So what next? create a custom virtual driver to fake input? custom MAME build?<br><br><textarea class=codebox name="code" wrap=OFF readonly="true" rows="15" cols="80">
Strict

Extern"Win32"
	Function BringWindowToTop(hWnd)
	Function FindWindow(CName$z,WName$z) = "FindWindowA@8"
	Function GetKeyboardLayout(Thread)
	Function GetLastError()
	Function GetRawInputData(hRawInput,uiCommand,pData:Byte Ptr,pcbSize Var,cbSizeHeader)
	Function MapVirtualKeyEx(Code,MapType,Hkl) = "MapVirtualKeyExA@12"
	Function VkKeyScanEx(ch,Hkl) = "VkKeyScanExA@8"
EndExtern

Const RIM_TYPEMOUSE = 0
Const RIM_TYPEKEYBOARD = 1
Const RIM_TYPEHID = 2

Const WM_INPUT = $FF

Type RAWINPUT_KEYBOARD
	' Header
	Field dwType:Int = RIM_TYPEKEYBOARD
	Field dwSize:Int = SizeOf(Self)
	Field hDevice:Int = 0 ' ????
	Field wParam:Int = 0

	' Data
	Field MakeCode:Short = Short(MapVirtualKeyEx(Asc("5"),0,GetKeyboardLayout(0)))
	Field Flags:Short = 0
	Field Reserved:Short = 0
	Field VKey:Short = VkKeyScanEx(Asc("5"),GetKeyboardLayout(0))
	Field Message:Int = WM_KEYDOWN
	Field ExtraInformatiom:Int = 0
	
	' Padding
	Field Pad0:Int
	Field Pad1:Int
EndType

Local Kb:RAWINPUT_KEYBOARD = New RAWINPUT_KEYBOARD
Local Mame = FindWindow("MAME","MAME: Donkey Kong (US set 1) [dkong]") ' Change to suit!

' Create a handle to our structure...
Local Raw = GlobalAlloc($42,SizeOf(Kb))
Local RawPtr:Byte Ptr = GlobalLock(Raw)
MemCopy(RawPtr,Kb,SizeOf(Kb))
GlobalUnlock(Raw)

' Post to MAME...
PostMessageW(Mame,WM_INPUT,0,Raw)


' A little test to see if the HANDLE is a valid handle - turns out its not...
Local size = 0
If GetRawInputData(Int RawPtr,$10000005,Null,size,16) = -1
	Local ErrorMsg$
	Local Error = GetLastError()
	If Error = 6 ErrorMsg$ = "invalid handle"
	Print "GetRawInputData failed with code: " + Error + " (" + ErrorMsg + ")"
Else
	Print "Handle to RAWINPUT structure is valid"
EndIf
' Free the memory HANDLE
GlobalFree(Raw)
</textarea> <br><br></td></tr></table><br>
<a name="1184950"></a>

<a name="1184951"></a>

<a name="1184953"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >col</td><td align="right"><font class=tiny>(Posted 2013)</font>&nbsp;<a href="#14">[#14]</a></td></tr></table></td></tr><tr ><td class="posttext"> - double post <br><br></td></tr></table><br>
<a name="1185139"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Arabia</td><td align="right"><font class=tiny>(Posted 2013)</font>&nbsp;<a href="#15">[#15]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> <br>Arabia, what are you trying to accomplish?<br> <br></div><br><br>This all came about from another forum where people were discussing a program that a guy wrote to "learn" via AI how to play Super Mario Bros (NES version I believe), so talk went to whether or not a computer could play Donkey Kong.<br><br>@col - what you just posted.... *whoosh* the sound of what you wrote going way over my head lol. <br><br></td></tr></table><br>
<a name="1185155"></a>

<a name="1185156"></a>

<a name="1185157"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >col</td><td align="right"><font class=tiny>(Posted 2013)</font>&nbsp;<a href="#16">[#16]</a></td></tr></table></td></tr><tr ><td class="posttext"> @Arabia<br>Sorry about that.<br><br>When working with the WindowsAPI you will need some good websites:-<br><a href="http://msdn.microsoft.com/en-US/" target="_blank">MSDN</a> is the best place but its so massive it's sometimes difficult to find what you're looking for, <a href="http://stackoverflow.com/" target="_blank">stackoverflow.com</a> and <a href="http://www.codeproject.com/" target="_blank">codeproject.com</a> are great places to search for answers to a problem. I've usually found other programmers have either already found a solution to a similar problem or, if not, you'll always get an answer of some description.<br><br>Anyway on-topic...<br><br>On Windows... Mame will process keyboard input by handling the WM_INPUT messages that come to it. WM_KEYDOWN, WM_KEYUP, WM_KEYCHAR are not processed. This is known as 'the raw input' method of handling input because the data coming in via WM_INPUT is well... raw data from devices. It allows for multiples devices of the same type to be recognised and interpreted correctly. However, this means only devices drivers ( keyboard driver, joystick driver, mouse driver ) can generate the raw data.<br><br>In my little test cases over the passed few days...<br>I was using PostMessage to post the WM_INPUT message to Mame. The function parameters are described <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/ms644944(v=vs.85).aspx" target="_blank">here</a>. When posting/sending the WM_INPUT message the lparam parameter is a handle to a RAWINPUT structure. The RAWINPUT structure contains data that describes the raw data coming in and the device from where it came so that an app can interpret the data correctly. A handle in this case is a windows system handle. Handles are different from, and are NOT pointers. A handle is simply an integer value thats a reference value and only the 'handle system' would know what the handle value actually refers to. Its a little bit like having an integer value being used to reference a variable instead of using a variable name. As I said in the above paragraph, the device driver will create the RAWINPUT structure with its data and more importantly will create a handle to that structure and then post it into the windows system, there is no way to create a handle from our side of the system.<br><br>So that only really leaves a couple of options that I can think of...<br>Try to create a virtual keyboard device, similar to the on-screen keyboard thats available in windows, then post fake keypresses from it via the RAWINPUT structure of a WM_INPUT message. Or, as Mame is open source, you could create/build your own custom version of Mame to handle the other WM_* messages. But I feel that may open a can of worms and possibly create more problems than you can solve.<br><br>Anyone else have any easier ideas? <br><br></td></tr></table><br>
<a name="1185182"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Arabia</td><td align="right"><font class=tiny>(Posted 2013)</font>&nbsp;<a href="#17">[#17]</a></td></tr></table></td></tr><tr ><td class="posttext"> It's funny that you mentioned the on screen keyboard, because I was wondering if you could control Mame via this and it turns out that you can.  So is there a possibility of sending input to the on screen keyboard to accomplish what I'm trying to do?   Not the perfect way, but if it works it would be fine.<br><br>I don't really want to mess around with the Mame source, what I want to do is provide a program that plays a game and doesn't rely on someone having to install a "custom built" version of Mame.  Besides, I don't know enough C to even had the faintest idea how to do it. <br><br></td></tr></table><br>
<a name="1185196"></a>

<a name="1185197"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >col</td><td align="right"><font class=tiny>(Posted 2013)</font>&nbsp;<a href="#18">[#18]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> <br>It's funny that you mentioned the on screen keyboard, because I was wondering if you could control Mame via this and it turns out that you can.<br> <br></div><br><br>I've just tried on Win7 and Win8 using Mame 0148 run from the command line using the -w switch for windowed mode and using the standard windows onscreen keyboard but nothing is happening in Mame. I'm making sure that Mame is the focus window but its not responding. Strangely enough it does send the WM_INPUT message :/<br><br>Am I doing anything different? <br><br></td></tr></table><br>
<a name="1185213"></a>

<a name="1185216"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Arabia</td><td align="right"><font class=tiny>(Posted 2013)</font>&nbsp;<a href="#19">[#19]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> I've just tried on Win7 and Win8 using Mame 0148 run from the command line using the -w switch for windowed mode and using the standard windows onscreen keyboard but nothing is happening in Mame. I'm making sure that Mame is the focus window but its not responding. Strangely enough it does send the WM_INPUT message :/<br><br>Am I doing anything different?<br> <br></div><br><br>Odd.  I just tried with .148 and got the same result (or lack of) as you.  It does however work in .106 (which is a build used for setting records with Twin Galaxies).  Obviously something was changed with the input between these versions.  Only way to find out what would be to either compare the respective versions code or go through the update logs - not keen on either of these lol. <br><br></td></tr></table><br>
<a name="1185438"></a>

<a name="1185440"></a>

<a name="1185441"></a>

<a name="1185442"></a>

<a name="1185443"></a>

<a name="1185444"></a>

<a name="1185445"></a>

<a name="1185446"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >col</td><td align="right"><font class=tiny>(Posted 2013)</font>&nbsp;<a href="#20">[#20]</a></td></tr></table></td></tr><tr ><td class="posttext"> SendInput works ok with .106 :<br><br><pre class=code>
Strict

Extern"Win32"
	Function GetLastError()
	Function SendInput(Count,pInput:Byte Ptr,Size)
	Function FindWindow(ClassName$z,WindowName$z) = "FindWindowA@8"
	Function GetKeyboardLayout(Thread)
	Function MapVirtualKeyEx(Code,MapType,Hkl) = "MapVirtualKeyExA@12"
	Function GetWindowThreadProcessId(hWnd,ProcessId)
	Function GetGUIThreadInfo(ThreadId,lpGUI:Byte Ptr)
EndExtern

' WindowAPI INPUT structure for the keyboard
Type INPUT_KEYBOARD
	Field _Type:Int
	
	' KEYBDINPUT
	Field _VK:Short
	Field _Scan:Short
	Field _Flags
	Field _Time
	Field _Extra
	Field _pad0
	Field _pad1
EndType

' WindowAPI
Type GUITHREADINFO
	Field _Size = SizeOf(GUITHREADINFO)
	Field _Flags
	Field _hwndActive
	Field _hwndFocus
	Field _hwndCapture
	Field _hwndMenuOwner
	Field _hwndMoveSize
	Field _hwndCaret
	' RECT
	Field _Caret_Left
	Field _Caret_Top
	Field _Caret_Right
	Field _Caret_Bottom
EndType

' MainCode
Local MAMEClass$,MAMEWindowTitle$,hWndMAME
Local ThreadId,KeyPressed

' Choose MAMEWindowTitle : Game Title
MAMEClass = "MAME"
MAMEWindowTitle = "MAME: Ms. Pac-man [mspacman]"

' Get MAME
' Can use FindWindow(MameClass,Null) if you don't know the windows title
hWndMame = FindWindow(MameClass,MameWindowTitle)
If hWndMame = 0
	Notify "Cannot find MAME Window: " + MameWindowTitle + "~nhWnd:  (" + hWndMAME + ")"
	End
EndIf

' A key to simulate
KeyPressed = Asc("5") ' MAME - Insert Coin

' Create an instance of the INPUT structure
Local IK:INPUT_KEYBOARD = New INPUT_KEYBOARD
IK._Type = 1
IK._VK = KeyPressed
IK._Scan = MapVirtualKeyEx(KeyPressed,0,GetKeyboardLayout(0))
IK._Flags = 8

' Push MAME to the front to give focus otherwise SendInput doesn't work
ShowWindow(hWndMAME,9)
SetForegroundWindow(hWndMAME)

' Make sure MAME has focus before sending the key press
Local TI:GUITHREADINFO = New GUITHREADINFO
Local TimeOut = 500 ' Timeout after approx 1/2 sec or 500 tries

ThreadId = GetWindowThreadProcessId(hWndMAME,0)

While TimeOut &gt; 0 
	GetGUIThreadInfo(ThreadId,TI)

	If TI._hWndActive = hWndMAME And TI._hWndFocus = hWndMAME Exit

	TimeOut :- 1
	Delay 1
Wend

' Send a paint message and wait for it to return,
' then we know the MAME message is ready for input
SendMessageW(hWndMAME,WM_PAINT,0,0)

' Press the 'KeyPressed' key
SendInput(1,IK,SizeOf(IK))
</pre> <br><br></td></tr></table><br>
<a name="1185473"></a>

<a name="1185474"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Hezkore</td><td align="right"><font class=tiny>(Posted 2013)</font>&nbsp;<a href="#21">[#21]</a></td></tr></table></td></tr><tr ><td class="posttext"> Well as I mentioned above, MAMEchanged a lot of stuff in one version.<br>You can however compile MAME and use the old input method.<br><br>So basically, Yes, they did change how input is handled. <br><br></td></tr></table><br>
<a name="1185533"></a>

<a name="1185534"></a>

<a name="1185536"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Arabia</td><td align="right"><font class=tiny>(Posted 2013)</font>&nbsp;<a href="#22">[#22]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> <br>SendInput works ok with .106 :<br> <br></div><br><br>I couldn't get it to work - but you obviously know a bit more about this stuff than I do.  <br><br>I'll give you code a go over the weekend, thanks very much Col, you're a champ!<br><br>EDIT:  Just gave you code a quick go.   It works, but with weird behavior.  y<br>I don't have time at the moment, hopefully I can nut out what is going on.<br><br>Where did you get your version of Mame 0.106 from?  I should have mentioned that I'm using a version called WolfMame 0.106.   Not that this should make any difference, the Wolf version is just a modified 0.106 which allows settings and stuff to be recorded for score verification - none of the core code should have been changed.<br><br>Anyway, again, nice work getting this going for me. <br><br></td></tr></table><br>
<a name="1185550"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >col</td><td align="right"><font class=tiny>(Posted 2013)</font>&nbsp;<a href="#23">[#23]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> <br>So basically, Yes, they did change how input is handled.<br> <br></div><br>Yes, it certainly looks that way. I was trying with .148 as it's the latest version, and it requires input via WM_INPUT messages on windows. It turns out that Arabia is using an earlier version that doesn't rely on that method.<br><br><div class="quote"> <br>Where did you get your version of Mame 0.106 from?<br> <br></div><br>I downloaded the first version I could find and  it's from [a http://www.fileplanet.com/163620/download/MAME-32-Pro-Special!-0.106]http://www.fileplanet.com/163620/download/MAME-32-Pro-Special!-0.106[/a]<br><br><div class="quote"> <br>EDIT: Just gave you code a quick go. It works, but with weird behavior. y<br>I don't have time at the moment, hopefully I can nut out what is going on.<br> <br></div><br>If you get stuck, let us know...<br><br>I'm still curious what the behavior is though :) <br><br></td></tr></table><br>
<a name="1185551"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Arabia</td><td align="right"><font class=tiny>(Posted 2013)</font>&nbsp;<a href="#24">[#24]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> <br>If you get stuck, let us know...<br><br>I'm still curious what the behavior is though :) <br> <br></div><br><br>If I run your code "as is" I get nothing.  If I double up the last line as in:<br><br><pre class=code>
SendInput(1,IK,SizeOf(IK))
SendInput(1,IK,SizeOf(IK))
</pre><br><br>It inserts a coin (adds a credit).   If I don't use SendInput twice, I need to run the code twice to get a credit to appear.  Not sure why this is, but if it works, then it's fine with me.   Next step is to press the key "1" to start the game (1 Player start), so I changed the code to this:<br><br><pre class=code>
SendInput(1,IK,SizeOf(IK))
SendInput(1,IK,SizeOf(IK))
IK._VK = Asc("1")
SendMessageW(hWndMAME,WM_PAINT,0,0)
SendInput(1,IK,SizeOf(IK))
SendInput(1,IK,SizeOf(IK))
</pre><br><br>I wasn't sure if the 2nd SendMessageW was required, but it doesn't make a difference either way, it doesn't start the game.  So that is where I'm stuck at the moment.  Mind you, I haven't actually had a lot of time to look at it yet, just 5 mins while on a break at work today. <br><br></td></tr></table><br>
<a name="1185589"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >col</td><td align="right"><font class=tiny>(Posted 2013)</font>&nbsp;<a href="#25">[#25]</a></td></tr></table></td></tr><tr ><td class="posttext"> I'll look into why that happens over the weekend.<br><br>Some thoughts...<br><br>Once the MAME window has focus then SendInput should be received the first time its called. There may be issues if your app takes focus again meaning that you need your code to give focus back to MAME. This is the problem with SendInput.<br><br>The checks I put in there are to make sure the MAME window is the foremost one and make sure the MAME message pump is ready. The SendMessage( ...WM_PAINT... ) is there to cause your code to wait for the result of the SendMessage from MAME. This ensures that the message pump is awake and ready to process more messages. If you SendInput while the window is in a transitional state then it wont be processed ( say from transitioning from no focus to getting focus, or while resizing from being minimized ). Because Windows OS is multi-threaded this is very likely to happen.<br>I also think maybe WM_PAINT is the wrong message here as the wm_paint is called when the app is minimized.<br><br>You mentioned earlier about 'teaching the computer to play an arcade game', so this means you're going to need some pretty responsive game-play and the way things are at the moment I'm sure it will be buggy. <br><br></td></tr></table><br>
<a name="1185590"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >col</td><td align="right"><font class=tiny>(Posted 2013)</font>&nbsp;<a href="#26">[#26]</a></td></tr></table></td></tr><tr ><td class="posttext"> Also...<br><br>For the keys that you want simulated you can also use the BlitzMax keywords KEY_*. For eg instead of <b>'IK._VK = Asc("1")'</b>, you can use <b>'IK._VK = KEY_1'</b>. The values are the same. <br><br></td></tr></table><br>
<a name="1185593"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Arabia</td><td align="right"><font class=tiny>(Posted 2013)</font>&nbsp;<a href="#27">[#27]</a></td></tr></table></td></tr><tr ><td class="posttext"> Thanks col.<br><br>Don't stress over it too much, I just wanted to see if it could be done with BlitzMax and turns out that it probably can, but it is going to be a hell of a lot more complicated than I anticipated. <br><br></td></tr></table><br>
<a name="1185639"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >col</td><td align="right"><font class=tiny>(Posted 2013)</font>&nbsp;<a href="#28">[#28]</a></td></tr></table></td></tr><tr ><td class="posttext"> I'm curious how would the computer 'see' what is happening on screen so it can react? :-)<br><br>Oh and just realised the reason the "1" doesnt work for you is because you to need to alter two variables in the IK type. You need to change the IK._VK and IK._Scan variables.<br><br>If you're going to use the code in a project then you're better to use a function similar to what skidracer demonstrates above. Something like:<br><br><pre class=code>
Strict

Extern"Win32"
	Function GetLastError()
	Function SendInput(Count,pInput:Byte Ptr,Size)
	Function FindWindow(ClassName$z,WindowName$z) = "FindWindowA@8"
	Function GetKeyboardLayout(Thread)
	Function MapVirtualKeyEx(Code,MapType,Hkl) = "MapVirtualKeyExA@12"
	Function GetWindowThreadProcessId(hWnd,ProcessId)
	Function GetGUIThreadInfo(ThreadId,lpGUI:Byte Ptr)
EndExtern

' WindowAPI INPUT structure for the keyboard
Type INPUT_KEYBOARD
	Field _Type:Int
	
	' KEYBDINPUT
	Field _VK:Short
	Field _Scan:Short
	Field _Flags
	Field _Time
	Field _Extra
	Field _pad0
	Field _pad1
EndType

' WindowAPI
Type GUITHREADINFO
	Field _Size = SizeOf(GUITHREADINFO)
	Field _Flags
	Field _hwndActive
	Field _hwndFocus
	Field _hwndCapture
	Field _hwndMenuOwner
	Field _hwndMoveSize
	Field _hwndCaret
	' RECT
	Field _Caret_Left
	Field _Caret_Top
	Field _Caret_Right
	Field _Caret_Bottom
EndType

Function SendKeyToMAME(KeyPressed)
	Local MAMEClass$,MAMEWindowTitle$,hWndMAME
	Local ThreadId

	' Choose MAMEWindowTitle : Game Title
	MAMEClass = "MAME"
	MAMEWindowTitle = "MAME: Ms. Pac-man [mspacman]"

	' Get MAME
	' Can use FindWindow(MameClass,Null) if you don't know the windows title
	hWndMame = FindWindow(MameClass,MameWindowTitle)
	If hWndMame = 0
		DebugLog " Cannot find MAME Window: " + MameWindowTitle + " (hWnd:  " + hWndMAME + ")"
		Return
	EndIf

	' Create an instance of the INPUT structure
	Local IK:INPUT_KEYBOARD = New INPUT_KEYBOARD
	IK._Type = 1
	IK._VK = KeyPressed
	IK._Scan = MapVirtualKeyEx(KeyPressed,0,GetKeyboardLayout(0))
	IK._Flags = 8

	' Push MAME to the front to give focus otherwise SendInput doesn't work
	ShowWindow(hWndMAME,9)
	SetForegroundWindow(hWndMAME)

	' Make sure MAME has focus before sending the key press
	Local TI:GUITHREADINFO = New GUITHREADINFO
	Local TimeOut = 500 ' Timeout after approx 1/2 sec or 500 tries

	ThreadId = GetWindowThreadProcessId(hWndMAME,0)

	While TimeOut &gt; 0 
		GetGUIThreadInfo(ThreadId,TI)

		If TI._hWndActive = hWndMAME And TI._hWndFocus = hWndMAME Exit

		TimeOut :- 1
		Delay 1
	Wend

	' Send a paint message and wait for it to return,
	' then we know the MAME message is ready for input
	SendMessageW(hWndMAME,WM_PAINT,0,0)

	' Press the 'KeyPressed' key
	Return SendInput(1,IK,SizeOf(IK))
EndFunction


' Insert coin
SendKeyToMAME(KEY_5)
Delay 1000

' Start one player
SendKeyToMAME(KEY_1)
</pre> <br><br></td></tr></table><br>
<a name="1185641"></a>

<a name="1185642"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Arabia</td><td align="right"><font class=tiny>(Posted 2013)</font>&nbsp;<a href="#29">[#29]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> <br>I'm curious how would the computer 'see' what is happening on screen so it can react? :-)<br> <br></div> <br><br>Haven't got that far yet, my idea would be to grab screen (window) grabs and then analyze them for objects, but that is a fair way off yet.<br><br>The first thing is to just get Mario (Jumpman as he was known then) moving around, then work on him completing the 1st elevator stage which is the easiest board to complete in the game as you don't have to worry about enemy's.<br><br>Having said that, it would probably be a better idea to start with Pac-Man since this game can be beaten by running patterns, so no worrying about scanning the screen for ghosts.<br><br>Thanks for the code above, works like a charm :) <br><br></td></tr></table><br>
<a name="bottom"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td align="right"><a href="http://monkeycoder.co.nz" target="_blank"><img src="/img/monkey2.svg" ></a> <a href="https://github.com/blitz-research" target="_blank"><img src="/img/github.svg" ></a> <a href="https://discord.gg/qJccbSp" target="_blank"><img src="/img/discord.svg" ></a></td></tr></table><br></div><br><table width="100%"><tr><td></body></html lang="en">
