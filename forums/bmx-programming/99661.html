<!DOCTYPE html><html lang="en" ><head ><title >Anyone fancy a challenge?! (WebSockets server)</title><meta name='viewport' content='width=device-width, initial-scale=0.66'><meta name='description' content='language:basic, target:desktop, category:game development'><link rel="styleSheet" href="../skins/granite/style.css" type="text/css"><style type="text/css">div.bbcode {padding: 8px;background: #E5E5E5;color: #000000;border: 1px dashed #B4B4BE;}</style></head><body ><table width=100% cellspacing=0 cellpadding=0><tr ><td class="menubarleft"></td><td class="menubar"><table cellspacing="0" cellpadding="0"><tr ><td >&nbsp;</td><td class="menuitemleft"></td><td class="menuitem"><a href="/" class="menuitem">News</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/forums.php" class="menuitem">Forums</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/codearcs.php" class="menuitem">Code</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/logs.php" class="menuitem">Logs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/gallery.php" class="menuitem">Gallery</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/sdkspecs.php" class="menuitem">Specs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/search.php" class="menuitem">Search</a></td><td class="menuitemright"></td></tr></table></td><td class="menubarright"></td></tr></table><div class="main"><h1 >Anyone fancy a challenge?! (WebSockets server)</h1><a href="forums.php" >BlitzMax Forums</a>/<a href="topics.php?forum=102" >BlitzMax Programming</a>/<a href="#bottom" >Anyone fancy a challenge?! (WebSockets server)</a><br><br>
<a name="1171114"></a>

<a name="1171216"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >BlitzSupport</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#1">[#1]</a></td></tr></table></td></tr><tr ><td class="posttext"> Hi all,<br><br>I'm trying to write a simple WebSockets server but have run into a specific problem that's completely baffling me. This is a long shot, I know, as it requires some understanding of networking and WebSockets (or the desire to learn about them!), but there are probably not many people concerned with this particular area...<br><br>Anyway, just in case, here's a quick summary of WebSockets and what's happening:<br><br>1) a WebSocket client sends 'frames' to the server (my program) in a specific format;<br><br>2) the frame contains some information about the data contained within, plus a 'mask' that the client has XOR-applied to this frame of data, plus the data itself;<br><br>3) the length of the data may be recorded as 0-125 bytes, but can be a special code denoting that the actual length is different: if it's 126, then the next TWO bytes contain the actual length of the data; if it's 127, the next EIGHT bytes contain the length of the data;<br><br>4) regardless of the length of data, you then read each byte of the data and XOR it with each of the 4 mask bytes in turn. (In BlitzMax, the ~ symbol operates as XOR.)<br><br>This works perfectly for strings 0-125 bytes in length, but for reasons I just cannot fathom, fails for larger strings. (I'm testing where the data length's 'special code' of 126 kicks in.)<br><br>I'm receiving the correct data length from the relevant two bytes, but the data simply isn't decoded correctly <i>despite using the correct mask offsets</i>.<br><br>Here's the project as it stands, and the relevant code is in the loop marked "WEB SOCKET LOOP:" (Ctrl-F it!), while the specific decoding part is marked "XOR DATA:"...<br><br><a href="https://dl.dropbox.com/u/3592022/blitz/websocketserver.zip" target="_blank">https://dl.dropbox.com/u/3592022/blitz/websocketserver.zip</a> [UPDATE: NOW WORKING!]<br><br>To test:<br><br>1) run the program and visit <a href="http://www.websocket.org/echo.html" target="_blank">http://www.websocket.org/echo.html</a> using a WebSockets-compliant browser (latest Chrome or Firefox ought to do it);<br><br>2) enter Location as "ws://localhost" (no quotes) and hit Connect;<br><br>3) enter a short string in the Message box;<br><br>4) hit Send.<br><br>That should return the correct string. However, if the string is longer than 125 bytes, you'll run into the problem described above and get utter garbage back!<br><br>I thought I might be reading from an incorrect byte offset, but it seems to be correct and there are no bytes left over after reading.<br><br>What confuses me further, based on this, is that typing in a 'short' string after a 'long' string also returns garbage, yet it 'should' be receiving valid data and mask at this point, given that there are no extra bytes in the stream.<br><br>Anyway, as I said, this is pretty obscure stuff, so I'm not expecting much of a response, but if anyone fancies a proper challenge, please take a look!<br><br>My best guess is that I'm somehow reading the data from the wrong offset, but I've been through it over and over, and all appears correct...<br><br>References:<br><br><a href="http://tools.ietf.org/html/rfc6455#section-5.2" target="_blank">http://tools.ietf.org/html/rfc6455#section-5.2</a><br><a href="http://stackoverflow.com/questions/8125507/how-can-i-send-and-receive-websocket-messages-on-the-server-side" target="_blank">http://stackoverflow.com/questions/8125507/how-can-i-send-and-receive-websocket-messages-on-the-server-side</a><br><a href="http://www.websocket.org/echo.html" target="_blank">http://www.websocket.org/echo.html</a><br><br><font class="tiny">Last edited 2012</font> <br><br></td></tr></table><br>
<a name="1171115"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >BlitzSupport</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#2">[#2]</a></td></tr></table></td></tr><tr ><td class="posttext"> God, that looks horrible! If anyone even bothers to <i>try</i> solving this, I'll nominate them for a Nobel prize of some sort! <br><br></td></tr></table><br>
<a name="1171119"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >skidracer</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#3">[#3]</a></td></tr></table></td></tr><tr ><td class="posttext"> Only skimmed your post but just wanted you to check you were applying network order to your byte sequences. <br><br></td></tr></table><br>
<a name="1171120"></a>

<a name="1171121"></a>

<a name="1171122"></a>

<a name="1171123"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >col</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#4">[#4]</a></td></tr></table></td></tr><tr ><td class="posttext"> Hiya,<br><br>I don't know too much about network etc :P but when the datalength variable is 126, using<br><br>Local maskbyte:Byte = maskptr [3 - loop Mod 4] ' Use mask order 3,2,1,0 instead of 0,1,2,3<br><br>the mask byte order decodes the message lovely. I wonder why that works in reverse as opposed to datalength &lt;= 125 which decodes with using the mask order 0,1,2,3. I'm not sure where the real bug is, as this seems like an endian issue, however changing the endian in the code doesn't seem to work.<br><br>Nobel prize nomination eh ? :D<br><br><font class="tiny">Last edited 2012</font> <br><br></td></tr></table><br>
<a name="1171125"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Floyd</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#5">[#5]</a></td></tr></table></td></tr><tr ><td class="posttext"> So byte order is the problem, but I'm still baffled by my results.<br><br>I tried a 150 byte message consisting of 0123456789 repeated fifteen times.<br><br>Running from the BlitzMax IDE I see the default message and the new one diplayed as:<br><br><pre class=code>
MESSAGE RECEIVED: Rock it with HTML5 WebSock
MESSAGE RECEIVED: 21  65  :3  07  4; ( and this is repeated )
</pre><br>And when I try to copy/paste into Notepad it gets turned into:<br><br><pre class=code>
MESSAGE RECEIVED: Rock it with HTML5 WebSock
MESSAGE RECEIVED: 2165:3074; ( repeated )
</pre><br>When I try to save this there is a warning about Unicode characters being lost.<br><br>I had to type in some of that by hand. Trying to copy/paste the BlitzMax output into this forum produced yet another variation:<br><pre class=code>
MESSAGE RECEIVED: &amp;#148;21&amp;#151;ê65&amp;#147;&amp;#156;:3&amp;#149;&amp;#150;07&amp;#145;&amp;#146;4;ù&amp;#148;21&amp;#151;ê65&amp;#147;&amp;#156;:3&amp;#149;&amp;#150;07&amp;#145;&amp;#146;4;ù&amp;#148;21&amp;#151;ê65&amp;#147;&amp;#156;:3&amp;#149;&amp;#150;07&amp;#145;&amp;#146;4;ù&amp;#148;21&amp;#151;ê65&amp;#147;&amp;#156;:3&amp;#149;&amp;#150;07&amp;#145;&amp;#146;4;ù&amp;#148;21&amp;#151;ê65&amp;#147;&amp;#156;:3&amp;#149;&amp;#150;07&amp;#145;&amp;#146;4;ù&amp;#148;21&amp;#151;ê65&amp;#147;&amp;#156;:3&amp;#149;&amp;#150;07&amp;#145;&amp;#146;4;ù&amp;#148;21&amp;#151;ê65&amp;#147;&amp;#156;:3&amp;#149;&amp;#150;07&amp;#145;&amp;#146;4;ù&amp;#148;21&amp;#151;ê65&amp;#147;&amp;#156;:
</pre>The incomprehensible thing is that output in BlitzMax, and output  pasted into Notepad, are short repeated patterns.<br>The BlitzMax output pasted directly into this forum is not. <br><br></td></tr></table><br>
<a name="1171129"></a>

<a name="1171130"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >col</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#6">[#6]</a></td></tr></table></td></tr><tr ><td class="posttext"> There's also another problem, maybe with the logic.<br><br>Using the temporary fix of [3 - loop mod 4]<br><br>As a test I did this...<br><br>The first string to send is '0123456789' - This is scrambled.<br>The second string of '0123456789' repeated 13 times the message is clean.<br>The third string to send is '0123456789' is also clean!!<br>All messages are decoded properly after this :/<br><br>Sorry i don't have more real time to look into it. I'm just hacking about while waiting for something else :P<br><br><font class="tiny">Last edited 2012</font> <br><br></td></tr></table><br>
<a name="1171132"></a>

<a name="1171134"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >BlitzSupport</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#7">[#7]</a></td></tr></table></td></tr><tr ><td class="posttext"> @skidracer: yes, using network byte order for the multi-byte sequences, as per spec. However, that doesn't seem to be required for the "non-length" results (the ReadInt on the mask works there for &lt; 126 lengths), and switching endian-ness on the mask doesn't work when applied to multi-byte results either!<br><br>@col: sadly too drunk at this point to test (yet more sadly out of lager, lest I'd try a little more), but if that's the case then I will be your best friend forever! (Makes no sense, though!) Will try that tomorrow!<br><br>@Floyd: again, unfortunately can't interpret until sober, but it certainly sounds like I'm doing what's expected, and kinda glad I'm not the only one baffled!<br><br>I'll have to try what col sez tomorrow... kinda tricky as you can't see what the client is sending as a mask, which would help greatly. I have tried with an alternative client (a Chrome plugin) but got similar results, so I'm bravely/naively assuming it's not the client sending dodgy data/mask.<br><br>Thanks, all, as I didn't expect so many responses on this one and really appreciate it! Will pick up again tomorrow and update... hoping col has it, though, regardless of whether or not the spec agrees!<br><br><font class="tiny">Last edited 2012</font> <br><br></td></tr></table><br>
<a name="1171133"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >BlitzSupport</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#8">[#8]</a></td></tr></table></td></tr><tr ><td class="posttext"> EDIT:@ Just saw your new post, col... will parse tomorrow, but thanks in advance! <br><br></td></tr></table><br>
<a name="1171174"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Htbaa</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#9">[#9]</a></td></tr></table></td></tr><tr ><td class="posttext"> Maybe this module can be of help to you. Since the web socket spec changed a lot I doubt this one is fully compliant since it hasn't been updated in over a year. <br><br><a href="https://github.com/FWeinb/websocket.mod" target="_blank">https://github.com/FWeinb/websocket.mod</a> <br><br></td></tr></table><br>
<a name="1171208"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >BlitzSupport</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#10">[#10]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> <br>the mask byte order decodes the message lovely. I wonder why that works in reverse as opposed to datalength &lt;= 125 which decodes with using the mask order 0,1,2,3. I'm not sure where the real bug is, as this seems like an endian issue, however changing the endian in the code doesn't seem to work.<br> <br></div><br>Wow, not only does it work for large strings, it also works on the &lt; 125 strings. How the heck can they be decoding both ways?! I'm also getting the weird problem you mention later, where a short string doesn't decode unless I've decoded a long string.<br><br>Totally bizarre... will require some head-scratching/banging! It's obviously an endianness problem somewhere, but...<br><br>@Htbaa, thanks, I've had a look but it just closes the connection with the Chat sample as soon as it connects. However, I will try your unMask function against some sample data I receive in my program and see what happens -- it appears to do the same thing, though! I'll also study your processMessage and see what's different. Interesting to see a different (and more comprehensive) approach to the same thing! <br><br></td></tr></table><br>
<a name="1171215"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >BlitzSupport</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#11">[#11]</a></td></tr></table></td></tr><tr ><td class="posttext"> GAAAH! Got it! Bloody endianness, of course.<br><br>Turns out I just needed to read the entire stream as Big Endian from the start, not bother with switching the stream's endianness for multi-byte values, and use col's 3 - loop Mod 4 thing.<br><br>What I still don't get is a) why other languages apparently don't need to do this (perhaps they default to Big Endian for their web streams?), and b) why it didn't work anyway, since endianness should only affect the multi-byte values.<br><br>Anyway, seems to be working fine now, so thanks all!<br><br><a href="https://dl.dropbox.com/u/3592022/blitz/websocketserver.zip" target="_blank">https://dl.dropbox.com/u/3592022/blitz/websocketserver.zip</a> <br><br></td></tr></table><br>
<a name="1171224"></a>

<a name="1171225"></a>

<a name="1171226"></a>

<a name="1171227"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Floyd</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#12">[#12]</a></td></tr></table></td></tr><tr ><td class="posttext"> James: your post appeared as I was doing some more experiments. So you can ignore everything but my remark about LongBin and LongHex.<br><br><br>I noticed a comment in the source code that Bin() only accepts 32-bit values. There are separate functions LongBin and LongHex.<br><br>Now back to the confusion. In my 0123456789... test the output contained this:<br><br><pre class=code>
	DATA		-	MASK

	10010100	-	Byte 0: 10101011
	00110010	-	Byte 1: 00000110
	00110001	-	Byte 2: 00000101
	10010111	-	Byte 3: 00001111
	10010000	-	Byte 0: 10101011
	00110110	-	Byte 1: 00000110
	00110101	-	Byte 2: 00000101
	10010011	-	Byte 3: 00001111
	10011100	-	Byte 0: 10101011
	00111010	-	Byte 1: 00000110
	00110011	-	Byte 2: 00000101
	10010101	-	Byte 3: 00001111</pre>Now here's a mystery. My original plain text would have ASCII values less than 128 even if I had not used only the characters 0-9. So in every case the high order ( leftmost ) bit would be 0. When you see a leftmost 1-bit in the received data it must have come from a 1 in the mask. Of the four mask bytes only one of them begins with a 1. Thus, no matter what the order, only one in four of the received data bytes should begin with a 1. But in fact half of them do.<br><br><font class="tiny">Last edited 2012</font> <br><br></td></tr></table><br>
<a name="1171253"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >BlitzSupport</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#13">[#13]</a></td></tr></table></td></tr><tr ><td class="posttext"> Completely forgot about LongBin/LongHex, and nice point about the leftmost bit! Many thanks for taking the time to look into this anyway, much appreciated. <br><br></td></tr></table><br>
<a name="1171300"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Floyd</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#14">[#14]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> nice point about the leftmost bit <br></div><br>Yep, I was this close ( imagine my thumb and index finger about a millimeter apart ) to figuring it out. The pattern of leftmost 1s meant that mask0 was being applied to the first and fourth data bytes. That happened because of the endian confusion. <br><br>Encryption and decryption had been done with the masks in opposite orders. Thus ( mask0 ~ mask3 ) had been applied to the first and fourth data bytes. Likewise with ( mask1 ~ mask2 ) being applied to the second and third data bytes. <br><br></td></tr></table><br>
<a name="1171382"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >BlitzSupport</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#15">[#15]</a></td></tr></table></td></tr><tr ><td class="posttext"> I would quite like to go back and try to figure out why I got the results I did, as I'm pretty sure it should work out the same. It may be that I just didn't hit on the exact combination when manually switching between endiannesses (is that a word?) and on reading/applying the mask.<br><br>Might just brush all that under the carpet for my sanity, though...<br><br>I like to dabble in some of this bit-level of coding now and then, but for some reason the logic has just never fallen naturally into place for me, even though I understand most of it when I'm reading about it! <br><br></td></tr></table><br>
<a name="1171383"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >BlitzSupport</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#16">[#16]</a></td></tr></table></td></tr><tr ><td class="posttext"> Finally dawned on me that the other languages are reading byte-by-byte and shift-combining them manually as they go, rather than reading a short, reading an int, reading a long, etc -- hence no mention of the endianness problem! Gah! <br><br></td></tr></table><br>
<a name="bottom"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td align="right"><a href="http://monkeycoder.co.nz" target="_blank"><img src="/img/monkey2.svg" ></a> <a href="https://github.com/blitz-research" target="_blank"><img src="/img/github.svg" ></a> <a href="https://discord.gg/qJccbSp" target="_blank"><img src="/img/discord.svg" ></a></td></tr></table><br></div><br><table width="100%"><tr><td></body></html lang="en">
