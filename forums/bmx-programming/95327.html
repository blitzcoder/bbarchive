<!DOCTYPE html><html lang="en" ><head ><title >malloc trouble?</title><meta name='viewport' content='width=device-width, initial-scale=0.66'><meta name='description' content='language:basic, target:desktop, category:game development'><link rel="styleSheet" href="../skins/granite/style.css" type="text/css"><style type="text/css">div.bbcode {padding: 8px;background: #E5E5E5;color: #000000;border: 1px dashed #B4B4BE;}</style></head><body ><table width=100% cellspacing=0 cellpadding=0><tr ><td class="menubarleft"></td><td class="menubar"><table cellspacing="0" cellpadding="0"><tr ><td >&nbsp;</td><td class="menuitemleft"></td><td class="menuitem"><a href="/" class="menuitem">News</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/forums.php" class="menuitem">Forums</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/codearcs.php" class="menuitem">Code</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/logs.php" class="menuitem">Logs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/gallery.php" class="menuitem">Gallery</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/sdkspecs.php" class="menuitem">Specs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/search.php" class="menuitem">Search</a></td><td class="menuitemright"></td></tr></table></td><td class="menubarright"></td></tr></table><div class="main"><h1 >malloc trouble?</h1><a href="forums.php" >BlitzMax Forums</a>/<a href="topics.php?forum=102" >BlitzMax Programming</a>/<a href="#bottom" >malloc trouble?</a><br><br>
<a name="1097177"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Warner</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#1">[#1]</a></td></tr></table></td></tr><tr ><td class="posttext"> In my engine, I've added a c file that renders a ROAM terrain.<br>However, it gives me trouble, and I could really use some help.<br><br>There was a complaint that it gives an error in 'debug' mode.<br>I've seen this error before, when testing the engine on another PC. There, the error suddenly dissapeared after I recompiled the sample.<br> <br>I've installed MinGW  5.1.3 to be able to recreate this error, hopefully to solve it. Now, I can't seem to recreate the situation where it was working.<br><br>In release mode, the program runs. Also, when I add "GCSetMode 2", the program runs, too. So I think it could be caused by the GC.<br>I've heard once that combining malloc and GC could give trouble?<br><br>Strangely enough, the complaint was, that the error was caused by a newer version of MinGW, and reverting to 5.1.3 solved the issue. Also, my suggestion to add 'GCSetMode 2' didn't work.<br><br>The C code creates a 'roam' struct:<pre class=code>
    rm=(roam)malloc(sizeof(roam_struct));
</pre><br><br>And within that struct, an array of 'roamdm' is created<pre class=code>
     rm-&gt;dmstore=(roamdm)malloc(rm-&gt;dmstoren*sizeof(roamdm_struct));
</pre><br><br>The error appears on somewhat strangest points, for instance in a 'ResizePixmap' instruction that follows the roam creation routine.<br><br>It is difficult to pinpoint the exact error location when it appears in the C file, because the debugger doesn't seem to trace in there.<br><br>If there is anyone who could shed some light on this?<br>If needed, the engine mod can be downloaded here:<br><a href="http://code.google.com/p/warner-engine/downloads/list" target="_blank">http://code.google.com/p/warner-engine/downloads/list</a> <br><br></td></tr></table><br>
<a name="1097183"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >ima747</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#2">[#2]</a></td></tr></table></td></tr><tr ><td class="posttext"> Are you compiling with threading enabled or not? Blitz uses a different GC routine with threading vs. non threading compiles. THe multi-threaded GC has given me plenty of headaches in the past. If you don't need threading keep it off, it will make life easier.<br><br>Are you freeing the malloced memory at any point, or is it intended to be held for some later time? Are you sure you have enough memory for the malloc and the following mallocs etc. from resizepixmap?<br><br>odd that disabling the garbage collector would still fail, though again, are you sure you have enough memory to malloc (including the things blitz is going to malloc for you like with a resizepixmap)... <br><br></td></tr></table><br>
<a name="1097185"></a>

<a name="1097187"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Czar Flavius</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#3">[#3]</a></td></tr></table></td></tr><tr ><td class="posttext"> Stabbing in the dark, but don't you need to cast malloc to a pointer (roam*) and not just the struct type? Or is roam a typedef for a pointer?<br><br><font class="tiny">Last edited 2011</font> <br><br></td></tr></table><br>
<a name="1097229"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Warner</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#4">[#4]</a></td></tr></table></td></tr><tr ><td class="posttext"> Oh, man .. I feel so stupid now. I was looking into the creation part a bit better, because of what you said:<br><pre class=code>
    rm-&gt;size=0;
    rm-&gt;heights=NULL;

    rm=(roam)malloc(sizeof(roam_struct));
</pre><br>:S Must have been tired when I did that. I was using the 'roam' before creating it. It seems to work now, I'll run some tests.<br><br>So I guess you were on the right track: it seems I was using non-alloced memory.<br><br>'Roam' is no pointer, it is a struct. The function first creates a struct, then later converts it to a 'roamhandle', which is indeed a typedef for a pointer. I didn't write the terrain code, my C skills are much limited, so I just took the way it is built for granted.<br><br>Thanks for your input. I was really on a dead end. <br><br></td></tr></table><br>
<a name="1097252"></a>

<a name="1097253"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >outsider</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#5">[#5]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> 'Roam' is no pointer, it is a struct. <br></div><br>File roamtypes.h line 43:<br><pre class=code>typedef struct roam_structdef roam_struct,*roam;</pre><br>what's means that roam is a pointer but we used it before memory allocation for him. <br><br>Anyway I also have not seen this before, good job :)<br><br><font class="tiny">Last edited 2011</font> <br><br></td></tr></table><br>
<a name="1097259"></a>

<a name="1097262"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Czar Flavius</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#6">[#6]</a></td></tr></table></td></tr><tr ><td class="posttext"> malloc returns a pointer to new bland memory region, which you need to cast to a pointer to the data type you are using. In pure C, I think the cast itself is optional (you can just malloc straight to the pointer) but perhaps good practice. As outsider points out, roam is a pointer to roam_structdef.<br><br>It's been a long time since I did pure C (in C++ the struct but without a typedef is optional), but I think the long form equivalent containing cast is:<br><br><pre class=code>rm=(struct roam_structdef *)malloc(sizeof(struct roam_structdef));</pre><br><br><font class="tiny">Last edited 2011</font> <br><br></td></tr></table><br>
<a name="bottom"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td align="right"><a href="http://monkeycoder.co.nz" target="_blank"><img src="/img/monkey2.svg" ></a> <a href="https://github.com/blitz-research" target="_blank"><img src="/img/github.svg" ></a> <a href="https://discord.gg/qJccbSp" target="_blank"><img src="/img/discord.svg" ></a></td></tr></table><br></div><br><table width="100%"><tr><td></body></html lang="en">
