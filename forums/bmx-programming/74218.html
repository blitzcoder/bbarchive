<!DOCTYPE html><html lang="en" ><head ><title >Code optimisation for video</title><meta name='viewport' content='width=device-width, initial-scale=0.66'><meta name='description' content='language:basic, target:desktop, category:game development'><link rel="styleSheet" href="../skins/granite/style.css" type="text/css"><style type="text/css">div.bbcode {padding: 8px;background: #E5E5E5;color: #000000;border: 1px dashed #B4B4BE;}</style></head><body ><table width=100% cellspacing=0 cellpadding=0><tr ><td class="menubarleft"></td><td class="menubar"><table cellspacing="0" cellpadding="0"><tr ><td >&nbsp;</td><td class="menuitemleft"></td><td class="menuitem"><a href="/" class="menuitem">News</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/forums.php" class="menuitem">Forums</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/codearcs.php" class="menuitem">Code</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/logs.php" class="menuitem">Logs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/gallery.php" class="menuitem">Gallery</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/sdkspecs.php" class="menuitem">Specs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/search.php" class="menuitem">Search</a></td><td class="menuitemright"></td></tr></table></td><td class="menubarright"></td></tr></table><div class="main"><h1 >Code optimisation for video</h1><a href="forums.php" >BlitzMax Forums</a>/<a href="topics.php?forum=102" >BlitzMax Programming</a>/<a href="#bottom" >Code optimisation for video</a><br><br>
<a name="829001"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >gameshastra</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#1">[#1]</a></td></tr></table></td></tr><tr ><td class="posttext"> I have found a difference in the smoothness of video with  my code using theora as compared to the sample code provided by you for the theora module. I will be highly obliged if you could help me out on the same. My code which creates a wrapper for theora is as below. Your help is solicited. <br><br>[Code]<br><br>'-----------------------------------------------------------------------------<br>' File: TheoraMovie.bmx<br>' Author: Ramesh D <br>' Description: TheoraMovie class for playing movies in Theora Format <br>' Usage: To create a TheoraMovie object the Create function of TheoraMovie is called with the parameters as follows: video file path, audio file path, x position,y position, width, height<br>'-----------------------------------------------------------------------------<br><br>Import pantson.theora<br>SuperStrict<br><br>Type TheoraMovie<br>	Field _vid:Ttheora <br>	'Field _aud:TSound<br>	Field _frameimg:TImage<br>	Field _xpos:Int<br>	Field _ypos:Int<br>	Field _width:Int<br>	Field _height:Int<br>	Field _state:Int<br>	Field _soundchannel:TChannel<br>	Const SkipVideo:Int = 1<br>	Const EndVideo:Int = 2<br>	Const StartVideo:Int = 3<br>	<br>	Function Create:TheoraMovie(vidname:String,audname:String,xpos:Int,ypos:Int,width:Int,height:Int)<br>		Local mov:TheoraMovie = New TheoraMovie<br>		mov._vid=OpenTheora(vidname)<br>		'mov._aud = LoadSound(audname)<br>		mov._xpos=xpos<br>		mov._ypos=ypos<br>		mov._width=width<br>		mov._height=height<br>		mov._state=StartVideo<br>		Return mov<br>	End Function<br>	<br>	Method ProcessInput(id:Int,x:Int,y:Int,data:Int)<br>		Select(id)<br>			Case  EVENT_KEYDOWN<br>				If data=KEY_ESCAPE<br>					_state=SkipVideo<br>					Close()<br>				End If<br>		End Select<br>	End Method<br>	<br>	Method Start()<br>		_frameimg=CreateImage(TheoraWidth(_vid),TheoraHeight(_vid))<br>		StartTheora(_vid)<br>		'_soundchannel=PlaySound(_aud)<br>		_vid.autoloop=False<br>	End Method<br>	<br>	Method Update(elapsedTime:Int)<br>	End Method<br>	<br>	Method Draw:Int()<br>		If (DrawTheoraImage(_vid,_frameimg) = True)<br>			DrawImage _frameimg,_xpos,_ypos<br>		End If<br>		Return _vid.eot<br>	End Method<br>	<br>	<br>	Method Close()<br>		'StopChannel(_soundchannel)<br>		CloseTheora(_vid)<br>	End Method<br>	<br>	Method EndOfMovie:Int()<br>		Return _vid.eot<br>	End Method<br>	<br>	Method Pause()<br>	    'PauseChannel(_soundchannel)<br>		PauseTheora(_vid)<br>	End Method<br>	<br>End Type<br><br>'-------------------------------------------------------------------------------------------------------------------------------------<br>'Main loop <br><br>Local m:TheoraMovie<br><br>Graphics 800,600,0<br><br>' load in movie<br>m = TheoraMovie.Create("C:\\EAS_M.ogg","C:\\EAS_S.ogg",0,0,800,600)<br><br>m.Start()<br><br>' loop until EndOfTheora<br>While Not m.EndOfMovie() And Not KeyDown(key_escape)<br>	m.Draw()<br>	Flip	<br><br>Wend<br><br>' close<br>m.Close()<br>End<br><br>[/Code]<br><br><br>Thanking You<br>Regards <br><br></td></tr></table><br>
<a name="829083"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >PantsOn</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#2">[#2]</a></td></tr></table></td></tr><tr ><td class="posttext"> found a quick difference...<br><br>my code<br><pre class=code>
If DrawTheoraImage(movie,image) = True
  Drawimage image,x,y
  Flip
endif
</pre><br><br>Your code (expanded out)<br><pre class=code>
If DrawTheoraImage(movie,image) = True
  Drawimage image,x,y
endif
Flip
</pre><br><br>It seems that you are flipping the screen every loop, even when the image hasn't been drawn or updated.<br><br>Try removing the Flip from your loop...<br><pre class=code>
While Not m.EndOfMovie() And Not KeyDown(key_escape)
m.Draw()
Wend
</pre><br>and change your wrapper to...<br><pre class=code>
Method Draw:Int()
If (DrawTheoraImage(_vid,_frameimg) = True)
DrawImage _frameimg,_xpos,_ypos
Flip
End If
Return _vid.eot
End Method
</pre><br><br>See if that makes a difference <br><br></td></tr></table><br>
<a name="829223"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >gameshastra</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#3">[#3]</a></td></tr></table></td></tr><tr ><td class="posttext"> That was the problem.Thank you  very much for the help. <br><br>I have another problem in the same code, when the<br>Close() method is called for the TheoraMovie Object in the middle of the movie the application crashes with memory exception error, this happens  in my application but not in the  example above <br><br></td></tr></table><br>
<a name="829224"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >PantsOn</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#4">[#4]</a></td></tr></table></td></tr><tr ><td class="posttext"> if you turn debug on it should show you the line it crashes on.<br>If its the DrawTheoraImage command, then you have closed the movie and then tried drawing it again (obviously this won't work)<br><br>If its the CloseTheora command then I will need to investigate furthur. <br><br></td></tr></table><br>
<a name="829226"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >gameshastra</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#5">[#5]</a></td></tr></table></td></tr><tr ><td class="posttext"> It gives memory exception in  in the CloseTheora function, the line is<br><br>   _freedecoder(movie.decoder)<br><br>Thanks <br><br></td></tr></table><br>
<a name="829259"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >PantsOn</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#6">[#6]</a></td></tr></table></td></tr><tr ><td class="posttext"> i have tested the code again and it doesn't produce the error with me.<br>I have a feeling that movie is already NULL when closing the file.<br>As I don't have access to your code... can you add the following code to theora.mod<br><br>can you add the following lines to mod for testing before the _freecoder(movie.decoder) line<br><pre class=code>
print "closing"
if movie = null then print "already null"
print "file = "+movie.filename
</pre><br><br>you will have to re-compile the mod after (ctrl-d)<br><br>the ammendment should display closing when you call the close commmand and test if its already closed.<br>It will still error though.<br><br>can you see what output the ammedment produces please? <br><br></td></tr></table><br>
<a name="829269"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Czar Flavius</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#7">[#7]</a></td></tr></table></td></tr><tr ><td class="posttext"> You need to use [code] in lower case for it to work. <br><br></td></tr></table><br>
<a name="829465"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >gameshastra</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#8">[#8]</a></td></tr></table></td></tr><tr ><td class="posttext"> I checked the variables you mentioned at the line _freedecoder(movie.decoder).  <br>movie is not Null. <br>movie.filename is valid<br>movie.decoder is not Null it is Byte Ptr with some value. However movie.buffer of TBank type is allready Null at the line _freedecoder(movie.decoder).<br>movie.file has value 000000 (all zeros)<br><br>Hope that gives some clue<br>Thanks <br><br></td></tr></table><br>
<a name="829486"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >PantsOn</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#9">[#9]</a></td></tr></table></td></tr><tr ><td class="posttext"> The only time the buffer is set to null is after the _freedecoder() command.<br><br>Sounds to me the close command is getting called twice.<br><br>how many "closing" messages do you get? <br><br></td></tr></table><br>
<a name="829771"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >gameshastra</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#10">[#10]</a></td></tr></table></td></tr><tr ><td class="posttext"> The theora movie plays fast in the VLC media player software  <br>but not in our program. How do we oprimize the speed. Your help is required.<br><br>The machine specs are 1.6 GHZ with 512 MB RAM<br><br>Thanks <br><br></td></tr></table><br>
<a name="829775"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Dreamora</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#11">[#11]</a></td></tr></table></td></tr><tr ><td class="posttext"> you can't<br><br>VLC uses possibilities you don't have. <br><br></td></tr></table><br>
<a name="829856"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >PantsOn</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#12">[#12]</a></td></tr></table></td></tr><tr ><td class="posttext"> I assume when you say<br><div class="quote"> <br>The theora movie plays fast in the VLC media player software <br> <br></div><br>you mean the movie plays a a correct frame rate and is smooth. <br><br>Theora (and MPEG, and DIVx, and Xvid and TV signals) stores the data in a YUV format. This is becuase its better for compressions and transmission than RGB.<br><br>This is where the "slow" bit is.. Blitz and TheoreLib then has to convert the YUV information to an RGB environment pixel by pixel.<br><br>VLC and other media players on the other hand have a special "YUV display unit" that requires no conversion.<br><br>Unfotunately Blitz doesn't have YUV display capabilities and only RGB.<br><br>So it will always be slow.<br>But certainly good enough for free.<br><br>(I think) <br><br></td></tr></table><br>
<a name="bottom"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td align="right"><a href="http://monkeycoder.co.nz" target="_blank"><img src="/img/monkey2.svg" ></a> <a href="https://github.com/blitz-research" target="_blank"><img src="/img/github.svg" ></a> <a href="https://discord.gg/qJccbSp" target="_blank"><img src="/img/discord.svg" ></a></td></tr></table><br></div><br><table width="100%"><tr><td></body></html lang="en">
