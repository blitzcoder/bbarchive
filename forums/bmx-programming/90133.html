<!DOCTYPE html><html lang="en" ><head ><title >waitevent locks up application?</title><meta name='viewport' content='width=device-width, initial-scale=0.66'><meta name='description' content='language:basic, target:desktop, category:game development'><link rel="styleSheet" href="../skins/granite/style.css" type="text/css"><style type="text/css">div.bbcode {padding: 8px;background: #E5E5E5;color: #000000;border: 1px dashed #B4B4BE;}</style></head><body ><table width=100% cellspacing=0 cellpadding=0><tr ><td class="menubarleft"></td><td class="menubar"><table cellspacing="0" cellpadding="0"><tr ><td >&nbsp;</td><td class="menuitemleft"></td><td class="menuitem"><a href="/" class="menuitem">News</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/forums.php" class="menuitem">Forums</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/codearcs.php" class="menuitem">Code</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/logs.php" class="menuitem">Logs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/gallery.php" class="menuitem">Gallery</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/sdkspecs.php" class="menuitem">Specs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/search.php" class="menuitem">Search</a></td><td class="menuitemright"></td></tr></table></td><td class="menubarright"></td></tr></table><div class="main"><h1 >waitevent locks up application?</h1><a href="forums.php" >BlitzMax Forums</a>/<a href="topics.php?forum=102" >BlitzMax Programming</a>/<a href="#bottom" >waitevent locks up application?</a><br><br>
<a name="1024497"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rozek</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#1">[#1]</a></td></tr></table></td></tr><tr ><td class="posttext"> Hello!<br><br>For several days, I tried to isolate a casual lock-up of my multi-threaded application - and finally found that "waitEvent" did no longer return although there is a timer which should fire every 1/30 second. Surprisingly, after a few seconds, the non-returning "waitEvent" fully loads both(!) cores of my CPU (although the operating system is still repsonsive)<br><br>I have not yet managed to build a simpler application which reproduces the problem. As usual in an MT environment, my application may run fine for long - and then suddenly stop.<br><br>Has anybody out there had a similar experience? It seems to happen under both Windows and Mac OS X and, thus, might be a BMX-specific problem.<br><br>Thanks in advance for any hints! <br><br></td></tr></table><br>
<a name="1024502"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rozek</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#2">[#2]</a></td></tr></table></td></tr><tr ><td class="posttext"> By looking into the source of "waitEvent" I realized, that it mainly consists of a loop which internally invokes "waitSystem".<br><br>I tried to limit the number of iterations and/or use "pollSystem" instead of "waitSystem", but still got stuck in it - thus, the problem might be within "waitSystem" or "pollSystem".<br><br>[edit]Hmmm, "waitSystem" and "pollSystem" look very similar, namely<br><pre class=code>
  If _busy Return
  _busy=True
  Driver.Wait
  _busy=False
</pre><br>I don't know which routines may call "waitSystem" or "pollSystem" (I should have moved all GUI-related stuff into the main thread), but could the "_busy = true/false" bracketing introduce a "race condition"?<br><br>[edit]Just as a note: I already modified the code to be more thread-safe:<br><pre class=code>
' If _busy Return
' _busy=True
  if (not compareAndSwap(_busy,false,true)) then return ' return if already _busy
  Driver.Wait
  _busy=False
</pre><br>but this did not have the desired effect (i.e. the application still got stuck loading the whole CPU)<br><br>[edit]By looking even deeper into the source (under MacOSX) I found that there are even more routines which use a similar approach, e.g. "bbSystemIntr" ("Intr" sounds like "interrupt"?)<br><pre class=code>void bbSystemIntr(){
  if( !appWaiting ) return;
  appWaiting=0;
  [NSApp postEvent:anullEvent atStart:NO];
}</pre><br>Is this approach "thread-safe"? <br><br></td></tr></table><br>
<a name="1024510"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rozek</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#3">[#3]</a></td></tr></table></td></tr><tr ><td class="posttext"> Hmmm,<br><br>just for the records: "postEvent" and "waitEvent" etc. use a circular buffer with "queue_get" and "queue_put" as indices. Shouldn't these variables also bit-anded with "QUEUEMASK" when incremented? Or what will happen in case of a range overflow (well, 2 billion events may be quite a lot, though, until something bad may happen) <br><br></td></tr></table><br>
<a name="1024589"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rozek</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#4">[#4]</a></td></tr></table></td></tr><tr ><td class="posttext"> Well,<br><br>my Application seems to lock itself up within "waitEvent" - unfortunately, however, I don't know how to deal with ".m" files and, thus, can't help myself any further...<br><br>In order to proceed (and progress is now getting urgent for me - after dealing with MT issues for quite a while!), it might already be helpful to know where bbSystemIntr, bbSystemWait and bbSystemPoll get called - I *might* be able to provide workarounds then...<br><br>Did anybody have similar experiences with events in MT applications? <br><br></td></tr></table><br>
<a name="1024592"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >ima747</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#5">[#5]</a></td></tr></table></td></tr><tr ><td class="posttext"> Don't know how exactly you're working with the events, but events are not thread safe. I didn't have any problems posting and emitting from child threads though it shouldn't be safe... but defenitely can't poll or wait without some nasty issues. I currently use a secondary event que. I have a function called QueEvent which you pass an event in a child thread. You then lock the que TList mutex and shove the new event at the end, then unlocks. The main thread meanwhile locks the que Tlist and posts (or emits whatever is better for you) all the events in the que, then wipes it and unlocks. This requires your event loop to be constantly running to check the que for new events. For me I don't need any events from a child THAT frequently so I can call waitsystem() to idle the main thread when there's nothing major going on and it's not a big deal, your flow may vary. <br><br></td></tr></table><br>
<a name="1024593"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rozek</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#6">[#6]</a></td></tr></table></td></tr><tr ><td class="posttext"> Logan,<br><br>in principle, all "postEvent" and "wait/pollEvent" calls should already be made from my main thread only (but it's difficult to say as there might be some BMX commands which access the event queue internally).<br><br>Additionally, there are those bbSystemIntr, bbSystemWait and bbSystemPoll calls which don't look very thread-safe but might get called from non-MaxGUI commands (perhaps even from "delay"?)<br><br>As a consequence, even with all MaxGUI-related stuff in the main thread, there might be situations, where event-related stuff gets called from within a sub-thread. My problem is that I am heavily switching contexts and, thus, suffer from a high probability to run into race-conditions (on the other hand, this simplifies testing, of course) <br><br></td></tr></table><br>
<a name="1024622"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rozek</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#7">[#7]</a></td></tr></table></td></tr><tr ><td class="posttext"> Hmmm,<br><br>I just tried the same application under Windows - and could not yet get it to lock up. Thus, it seems as if it could be a Mac-specific problem.<br><br>I'll keep you informed... <br><br></td></tr></table><br>
<a name="bottom"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td align="right"><a href="http://monkeycoder.co.nz" target="_blank"><img src="/img/monkey2.svg" ></a> <a href="https://github.com/blitz-research" target="_blank"><img src="/img/github.svg" ></a> <a href="https://discord.gg/qJccbSp" target="_blank"><img src="/img/discord.svg" ></a></td></tr></table><br></div><br><table width="100%"><tr><td></body></html lang="en">
