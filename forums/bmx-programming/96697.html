<!DOCTYPE html><html lang="en" ><head ><title >Garbage Collector and GCMemAlloced</title><meta name='viewport' content='width=device-width, initial-scale=0.66'><meta name='description' content='language:basic, target:desktop, category:game development'><link rel="styleSheet" href="../skins/granite/style.css" type="text/css"><style type="text/css">div.bbcode {padding: 8px;background: #E5E5E5;color: #000000;border: 1px dashed #B4B4BE;}</style></head><body ><table width=100% cellspacing=0 cellpadding=0><tr ><td class="menubarleft"></td><td class="menubar"><table cellspacing="0" cellpadding="0"><tr ><td >&nbsp;</td><td class="menuitemleft"></td><td class="menuitem"><a href="/" class="menuitem">News</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/forums.php" class="menuitem">Forums</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/codearcs.php" class="menuitem">Code</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/logs.php" class="menuitem">Logs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/gallery.php" class="menuitem">Gallery</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/sdkspecs.php" class="menuitem">Specs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/search.php" class="menuitem">Search</a></td><td class="menuitemright"></td></tr></table></td><td class="menubarright"></td></tr></table><div class="main"><h1 >Garbage Collector and GCMemAlloced</h1><a href="forums.php" >BlitzMax Forums</a>/<a href="topics.php?forum=102" >BlitzMax Programming</a>/<a href="#bottom" >Garbage Collector and GCMemAlloced</a><br><br>
<a name="1119603"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rixarn</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#1">[#1]</a></td></tr></table></td></tr><tr ><td class="posttext"> Hi!<br><br>I want to code a memory manager for my current app. To see what was happening with the gc in an "empty" app this is what I wrote:<br><br><textarea class=codebox name="code" wrap=OFF readonly="true" rows="15" cols="80">
Graphics 1024, 768

Local mm:SBMemoryManager = New SBMemoryManager

Repeat

	mm.Update()
	mm.RenderInfo()
	
	Flip() ;Cls()
Until KeyDown(KEY_ESCAPE) Or AppTerminate()

Type SBMemoryManager
	
	Field min_mem:Int = 0
	
	Field max_mem:Int = 0
	
	Field mem:Int
	
	Method Update()
		mem = GCMemAlloced()
		
		If KeyHit(KEY_SPACE)
			GCSuspend()
		End If
		
		If KeyHit(KEY_RETURN)
			GCResume()
		End If

		If min_mem = 0 Then min_mem = mem
		If max_mem = 0 Then max_mem = mem
		
		If mem &lt; min_mem Then min_mem = mem
		If mem &gt; max_mem Then max_mem = mem
	End Method
	
	Method RenderInfo()
		DrawText "GCMemAlloced:" + mem, 0, 0
		DrawText "MinMemAlloced:" + min_mem + " MaxMemAlloced:" + max_mem, 0, 12
	End Method

EndType
</textarea><br><br>Now... Looking at the GCMemAlloced, it's always changing! The program is doing nothing yet it's always changing. I know it is not an error, I just want to know why is that happening? <br><br>Thanks! <br><br></td></tr></table><br>
<a name="1119604"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >GfK</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#2">[#2]</a></td></tr></table></td></tr><tr ><td class="posttext"> Because even that is adding stuff to the call stack etc.  Plus a load of other behind-the-scenes crap I don't understand.<br><br>It's normal. <br><br></td></tr></table><br>
<a name="1119607"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rixarn</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#3">[#3]</a></td></tr></table></td></tr><tr ><td class="posttext"> Hi GFK,<br><br>Thanks for the post. I know it's a normal behavior but I just was curious about what was going on behind the scenes...it's a lot of movement! <br><br></td></tr></table><br>
<a name="1119610"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >col</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#4">[#4]</a></td></tr></table></td></tr><tr ><td class="posttext"> Hiya<br><br>Put a DebugStop before the DrawText command in Debug mode then step into all the DrawText functional code. Don't alter anything though!!<br>There's plenty of background code to look at just in that one command. Before slating it - remember BMax is not built to be the fastest, but built to be respectably fast whilst being multi-platform. <br><br></td></tr></table><br>
<a name="1119611"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rixarn</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#5">[#5]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> <br>There's plenty of background code to look at just in that one command. Before slating it - remember BMax is not built to be the fastest, but built to be respectably fast whilst being multi-platform. <br> <br></div><br><br>That's true col. I'm overall happy with bmax. I just finished a long game-like project that lengthened to 3 years and a half, and just until now I had no serious problems. I'm trying to find out why that app is 'randomly' crashing with an exception access violation. Brucey and others suggested me to use an external debugger (such as GDB) but I believe I will take more time to just learn how to use GDB that to actually 'reproduce' the bug in a controlled environment.<br><br>Anyway, back to topic... I believe that learning a little bit more about the GC could help me solve that... <br><br></td></tr></table><br>
<a name="1119615"></a>

<a name="1119619"></a>

<a name="1119620"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >col</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#6">[#6]</a></td></tr></table></td></tr><tr ><td class="posttext"> I read your thread about that thinking to myself you must be pulling your hair out of over that issue!!<br><br>I recently wrote some code that accesses some dlls, ( I was messing with some direct usb access libraries ) and it actually ran faster in debugmode! Turns out an invalid return address just so happened to be a valid value giving me false impressions! So I know how you feel when things crash for no obvious reason!<br><br>Marks just updated BMax to 1.45 with some fixes to the GC. Maybe it'll help your issue?<br><br><font class="tiny">Last edited 2011</font> <br><br></td></tr></table><br>
<a name="1119642"></a>

<a name="1119643"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rixarn</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#7">[#7]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> <br>I read your thread about that thinking to myself you must be pulling your hair out of over that issue!!<br> <br></div><br><br>I am! And I'm using the newest version of BMAX too but sadly, I'm dragging this problem back from V1.42 or something...<br><br>Right now I'm building a memory manager for my app, and I will incorporate a resource manager too! My problem is when loading/writing stuff. I hope that once I've got all covered, the problem can get isolated... since I have so many modules involved.. it's hard to find the offending one :S<br><br><font class="tiny">Last edited 2011</font> <br><br></td></tr></table><br>
<a name="1119653"></a>

<a name="1119654"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >col</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#8">[#8]</a></td></tr></table></td></tr><tr ><td class="posttext"> I've had plenty of the ole 'intermittent, for no reason, works for 30secs then craps out' bugs in the past :P<br><br>From my experience with BMax - Exception Access Violations are generally associated with a resource thats a value of zero or Null, and your code or a module is expecting it to be an actual valid value. Your code or the module code ends up accessing a memory address of zero which then causes the OS to fire up the violation - ie your exe is accessing memory not assigned to it by the OS. Something as simple as a duplicate variable name is surprisingly popular at causing this!<br><br>Bruceys modules are of a high standard, but if you've completely eliminated any errors in your own code then you've got to look at the modules you're using. I'd first validate the values being passed into the mod functions and also validate them on return. Use actual values checking for null and/or zero and also check within an expected value range instead of True or False, anything outside the range and stop the code straight into the debug window. You can NEVER do too many validation checks when bug hunting :D<br><br>I love bug hunting... got kind of a 'thing' going for it lately :D<br><br>If you wanted any help, mail me any complete code that produces the error, so I can do a build, and I'll take a look?<br><br>EDIT:- BTW is the EAV in debug and/or release build?<br><br>Good luck with it. I'm sure it'll be found soon.<br><br><font class="tiny">Last edited 2011</font> <br><br></td></tr></table><br>
<a name="1119663"></a>

<a name="1119690"></a>

<a name="1119691"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rixarn</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#9">[#9]</a></td></tr></table></td></tr><tr ><td class="posttext"> Thanks col!<br><br>I know Brucey's modules are VERY reliable. Last program that "randomly but rarely" crashed with an EAV was a little one that made sprite sheets. <strike>For that module I didn't used any of brucey's mod</strike> I'm using bah.freeimage... Perhaphs it's a build thing of the mods... dunno! <br>My app is divided in 40+ modules because compiling time was slow! and I always build modules with bmk makemods modulename before compiling the final exe<br><br>BTW, One of the 'lesser' problems of my app is a memory leaking. Believing that the GC was a reason not to worry about managing memory resources was a big mistake, and I also expect to find my answers when dealing with the leak..<br><br>Anyway... back to topic I'm seriously considering your help here...but before throwing the towel I'll give a try with the memory manager and resource manager I'm writing, and probably re-write the offending module (because out of the 40, it crashes only while being in it)<br><br>I'm currently making an application to heavily "test" all the task I normally do in mi app (LoadImages, LoadAnimImages, from streams, from zipstreams, read/write to files, databases etc) in a controlled way. When I finish it, I'll let it run all day long until it crashes (: ... I hope it does<br><br>EDIT: Ok! little app testing program is taking me somewere! :D The EXCEPTION ACCESS VIOLATION is being thrown by the pixmap module, in this line of code:<br><br><pre class=code>
Case PF_BGRA8888
Return p[2] Shl 16 | p[1] Shl 8 | p[0] | p[3] Shl 24
</pre><br><br>Now... I really don't know if this is exactly the same EAV I get in my app, but what I know is that this shouldn't be happening...<br><br>For the imports, I'm using this:<br><pre class=code>
SuperStrict

Framework brl.max2d

Import bah.freeimage
Import brl.d3d7max2d
Import brl.d3d9max2d
Import brl.map
</pre><br><br>Brucey's freeimage is the only one there... I'll have to write an alternate version of the pixmap test w/o the freeimage module and see what happens...<br><br><font class="tiny">Last edited 2011</font><br><br><font class="tiny">Last edited 2011</font> <br><br></td></tr></table><br>
<a name="1119693"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rixarn</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#10">[#10]</a></td></tr></table></td></tr><tr ><td class="posttext"> Ok! Confirmed! the EAV I'm getting comes from using bah.freeimage module! Guess I can leave the GC alone for a while (:<br><br>This is the link to the test I wrote including the images I use to make the tests:<br><br><a href="http://www.smartb.mx/freeimage_test.zip" target="_blank">http://www.smartb.mx/freeimage_test.zip</a><br><br>It comes with both versions of the test, free image version, and no freeimage version... can you help me confirm the problem, col?<br><br>I'm using Bmax 1.45, mingw (GCC) 4.6.1 and bah.freeimage 1.07<br><br>P.S. Perhaphs I should make another post? This has gone offtopic (non GC Related) But I'm sooo glad I found it! :D <br><br></td></tr></table><br>
<a name="1119729"></a>

<a name="1119733"></a>

<a name="1119737"></a>

<a name="1119738"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >col</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#11">[#11]</a></td></tr></table></td></tr><tr ><td class="posttext"> You've got plenty of management going on in there :P I like it even though it is 'over the top' :D<br><br>It's not as random as you think.....<br>in <b>main.bmx</b>, comment out <b>line 54</b> and <b>line 56</b> so that Setup is run immediately and it'll crash out at exactly the same time, every time. This hinted to me that it is in fact a GC issue. Also at the 'crash point', the GC figures are up to the point that it would normally ( in this example ) be collected.<br><br>I've found a 'work around' fix for you that works in this example code. Try it with the real project :-<br><br>In <b>freeimage_pixmap_test.bmx</b>, in the <b>GenerateImageStrip(...)</b> function, squeeze a <b>GCCollect()</b> at <b>Line 104</b> at the start of the function code.<br><br>Let us know how it pans out in the main project.<br>This would be a great example to post in the Bug Forum ;-)<br><br>EDIT:- There definitely seems to be a problem with the GC when the code is large with a lot of 'still valid and active variables and data structures', the GC kicks automatically doing some collecting and something gets screwed up. Keeping the GC updated and low helps the problem.<br><br><font class="tiny">Last edited 2011</font> <br><br></td></tr></table><br>
<a name="1119739"></a>

<a name="1119741"></a>

<a name="1119742"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rixarn</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#12">[#12]</a></td></tr></table></td></tr><tr ><td class="posttext"> Hey! Thanks for testing! <br><br>The management I'm doing uses 2 clases of my main project (IGF ones) ... They are template classes for state machines... but i guess I found the bug in the 2nd test! (first one was raw image loading)<br><br>So, it was a GC issue after all huh? How ugly this GC bugs can be! In my app it looks like random because the operations involving pixmaps are not made at the same moment and depend totally on user input. <br><br>I will report the bug, but the fact that the non freeimage version of the test runs just fine without some GC trickery its good enough for me (: ... I can afford to remove bah.freeimage completely from my project. Besides, in my project I'm not doing exactly that kind of pixel manipulation, but it always crashed when loading images (pixmap?) or stuff.<br><br><div class="quote"> <br>EDIT:- There definitely seems to be a problem with the GC when the code is large with a lot of 'still valid and active variables and data structures', the GC kicks automatically doing some collecting and something gets screwed up. Keeping the GC updated and low helps the problem.<br> <br></div><br> <br>lots still valid and active variables is the case of my app lol... So you did made another test code to find that out? ... I guess it is time to report this in the bugs forums... in the meantime I'll remove bah.freeimage from my app until this gets solved.<br><br>Thank you for you help, Dave!<br><br><font class="tiny">Last edited 2011</font><br><br><font class="tiny">Last edited 2011</font> <br><br></td></tr></table><br>
<a name="1119748"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >col</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#13">[#13]</a></td></tr></table></td></tr><tr ><td class="posttext"> I've made and used some BMax sources that access a lot of external code. By external code I mean code that's Imported that doesn't use the BMax language itself:- c/c++/dll/lib etc.<br><br>When using a fair of amount of data and the code is of a mixed source ( Bmax/c/dll etc ), that's when I notice the GC can sometimes bug out, and it needs to be collected manually otherwise crashes occur with still valid data. As seen in this example.<br><br>I'm sure it's not anything to do with anyones source code, or your own, but it's the actual GC itself! It just so happens in your case it bombs out using code that accesses a module. I've had the same problem with passing arrays into dll functions. It works ok until the GC auto-collects and screws something up, then in the dll call I had an EAV. In the debug window everything was still showing as alive and active. Real pain in the arse. 'GCCollect'ing before using iterative code that accesses 'external' code fixes it up nicely.<br><br><div class="quote"> <br>lots still valid and active variables is the case of my app<br> <br></div><br><br>Yep, and tons of other large 'practical' and 'real' apps too :P <br><br></td></tr></table><br>
<a name="1119750"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rixarn</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#14">[#14]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> <br>I'm sure it's not anything to do with anyone's source code, or your own, but it's the actual GC itself!<br> <br></div><br><br>I use a lot of iterative code that accesses 'external' code, putting GCCollect all over it will take some time, but oh well...<br><br>How do we report this bug? I believe my example is too large and depends on some image files... Maybe I'll do a stripped version of the tester app that doesn't require too much to show the GC bug in action... <br><br></td></tr></table><br>
<a name="1119754"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >col</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#15">[#15]</a></td></tr></table></td></tr><tr ><td class="posttext"> To be honest I'd link the the .zip thats used above so that BRL have code thats guaranteed to crash, and also link to this topic page too.<br><br>It a great example of putting the GC to a real life test. It's not like they will have to wade through your code as we know how to reproduce the crash at the same time, every time. This should make it easier for BRL to dissect whats going on with garbage management. <br><br></td></tr></table><br>
<a name="1119758"></a>

<a name="1119759"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rixarn</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#16">[#16]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> <br>To be honest I'd link the the .zip thats used above so that BRL have code thats guaranteed to crash, and also link to this topic page too.<br> <br></div><br>Alright, then I'll take your advice and just put that in the bugs forum. Thank you for your help Dave!<br><br><font class="tiny">Last edited 2011</font> <br><br></td></tr></table><br>
<a name="1119803"></a>

<a name="1119804"></a>

<a name="1119809"></a>

<a name="1119815"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Zeke</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#17">[#17]</a></td></tr></table></td></tr><tr ><td class="posttext"> try this modified "freeimage_pixmap_test.bmx" file:<br><textarea class=codebox name="code" wrap=OFF readonly="true" rows="15" cols="80">
Const IMAGES_DIR:String = "src/pixmap_test/images/"
Const IMAGES_COPY_DIR:String = "src/pixmap_test/images_copy/"
Const STRIPS_DIR:String = "src/pixmap_test/strips/"

Type SBState_PixmapWriting_FreeImage Extends IGFSimpleState

	Field iterations:Int = 20
	
	Field current_iteration:Int = 0
	
	Function Create:SBState_PixmapWriting_FreeImage(context:IGFSimpleStateContext)
		Local p:SBState_PixmapWriting_FreeImage = New SBState_PixmapWriting_FreeImage
		p.Init("PixmapWriting", context)
		Return p
	End Function

	Method _Free()
		DeleteDir(IMAGES_COPY_DIR, True)
	End Method
	
	Method Update()
		If current_iteration &lt; iterations
			Local stripGenerator:TImageStripGenerator = New TImageStripGenerator
			stripGenerator.Run(current_iteration)
			current_iteration:+1
		Else
			ChangeToState("Controller")
			current_iteration=0 'Add This
		End If
	End Method
	
	Method Render()
		DrawText "PixmapWriting State::" + current_iteration, 0, 0
	End Method

EndType

Private

Type TImageStripGenerator
	
	Method Run(iteration:Int)
		Local strip:TFreeImage = GenerateImageStrip(IMAGES_DIR, 0)
		'No need to save the strip, as the problem arises in the Generation of pixmap
	'	strip.save(STRIPS_DIR + "strip" + iteration + ".png", FIF_PNG)
	End Method

End Type

Type TImageContainer
	
	Field filename:String
	
	Field pixmap:TPixmap
	
	Field freeimage:TFreeImage 'Add This
	
	Function Create:TImageContainer(filename:String, pixmap:TPixmap,fimage:TFreeImage) 'Modify this
		Local ic:TImageContainer = New TImageContainer
		ic.filename = filename
		ic.pixmap = pixmap
		ic.freeimage=fimage 'Add This
		Return ic
	End Function
	
EndType

Type TImageCropArea
	
	Field leftmost_x:Int = -1
	Field rightmost_x:Int = -1
	Field topmost_y:Int = -1
	Field bottommost_y:Int = -1
	
	Function CreateFromPixmap:TImageCropArea(pixmap:TPixmap)
		Local crop:TImageCropArea = New TImageCropArea
		
			'Find topmost pixel &amp; bottommost pixel
			For Local y:Int = 0 To pixmap.height - 1
				For Local x:Int = 0 To pixmap.width - 1
					If pixmap.ReadPixel(x, y) &lt;&gt; 0
						If crop.topmost_y = -1 Then crop.topmost_y = y
						crop.bottommost_y = y
					End If
				Next
			Next
			
			'Find leftmost &amp; rightmost pixel
			For Local x:Int = 0 To pixmap.width - 1
				For Local y:Int = 0 To pixmap.height - 1
					If pixmap.ReadPixel(x, y) &lt;&gt; 0
						If crop.leftmost_x = -1 Then crop.leftmost_x = x
						crop.rightmost_x = x
					End If
				Next
			Next
						
		Return crop
	End Function
	
	Method ToString:String()
		Print "leftmost_x:" + leftmost_x + " rightmost_x:" + rightmost_x + " topmost_y:" + topmost_y + " bottommost_y:" + bottommost_y
	End Method
	
EndType

Function GenerateImageStrip:TFreeImage(url:String, flipH:Byte = False, flipV:Byte = False)
	Local dir:Int = ReadDir(url)
	
	If Not dir RuntimeError "failed to read current directory"
	
	Local croppedImageList:TList = CreateList()
	
	url = url + "/"
	
	Repeat
		Local t:String = NextFile(dir)
		If t = "" Exit
		If t = "." Or t = ".." Continue
		If ExtractExt(url + t) = "png"
			Local freeimage:TFreeImage = LoadFreeImage(url + t)
			If freeimage = Null Then Throw "Could not create free image from " + url + t
			Local crop:TImageCropArea = TImageCropArea.CreateFromPixmap(freeimage.getPixmap())
			Local freeimage2:TFreeImage = GetSubFreeImage(freeimage.getPixmap(), crop)
			Local pixmap:TPixmap = freeimage2.getPixmap()
			If flipH = True Then pixmap = FlipPixmapHorizontal(pixmap)
			Local imageContainer:TImageContainer = TImageContainer.Create(url + t, pixmap,freeimage2)
			croppedImageList.AddLast(imageContainer)
		End If
	Forever
	
	CloseDir dir
	Local f:TFreeImage = GetFreeImageStrip(croppedImageList)
	Return f
End Function

Function FlipPixmapHorizontal:TPixmap(pixmap:TPixmap)
	Local pix:TPixmap = pixmap.Copy()
	
	For Local x:Int = 0 To pixmap.width - 1
		For Local y:Int = 0 To pixmap.height - 1
			Local argb:Int = pixmap.ReadPixel(x, y)
			pix.WritePixel((pixmap.width - 1) - x, y, argb)
		Next
	Next
	
	Return pix
	
End Function

Function GetFreeImageStrip:TFreeImage(croppedImageList:TList)

	Local frames:Int = croppedImageList.Count()
	Local largest_width:Int = 0
	Local largest_height:Int = 0
	'Get the largest width of all
	For Local container:TImageContainer = EachIn croppedImageList
		If container.pixmap.width &gt; largest_width
			largest_width = container.pixmap.width
		End If
		If container.pixmap.height &gt; largest_height
			largest_height = container.pixmap.height
		End If
	Next
	'Gets the minimum width for the cells. Since each cell is going to be multiplied by .75, (((cell_size * 5)*.75)/5) has to be integer.
	largest_width = getMinWidth(largest_width, frames)
	
	Local pixmap:TPixmap = CreatePixmap(largest_width * frames, largest_height, PF_BGRA8888)
	pixmap.ClearPixels(0)
	
	For Local i:Int = 0 To frames - 1
		Local container:TImageContainer = TImageContainer(croppedImageList.RemoveFirst())
		For Local x:Int = 0 To container.pixmap.width - 1
			For Local y:Int = 0 To container.pixmap.height - 1
				Local pix:Int = container.pixmap.ReadPixel(x, y)
				pixmap.WritePixel(x + i * largest_width, y, pix)
			Next
		Next
	Next
	
	Return TFreeImage.CreateFromPixmap(pixmap)

EndFunction

Function getMinWidth:Int(frame_width:Int, frames:Int = 5)
	While (frame_width * 5) *.75 Mod 5 &lt;&gt; 0
		frame_width:+1
	Wend
	Return frame_width
End Function

Function CreateFreeImage:TFreeImage(width:Int, height:Int)
	If height = 0 Then Throw "Height cannot be 0"
	If width = 0 Then Throw "Width cannot be 0"
	Local pix:TPixmap = CreatePixmap(width, height, PF_BGRA8888)
	pix.ClearPixels(0)
	Local f:TFreeImage = TFreeImage.CreateFromPixmap(pix)
	Return f
End Function

Function GetSubFreeImage:TFreeImage(pixmap:TPixmap, cropArea:TImageCropArea)
	Local p:TPixmap
	
	If croparea.leftmost_x = -1 Or cropArea.topmost_y = -1 Or croparea.rightmost_x = -1 Or CROPAREA.bottommost_y = -1
		p = CreatePixmap(1, 1, PF_BGRA8888)
		p.ClearPixels(0)
		Return TFreeImage.CreateFromPixmap(p)
	Else
		p = CreatePixmap((cropArea.rightmost_x - cropArea.leftmost_x) + 1, (cropArea.bottommost_y - croparea.topmost_y) + 1, PF_BGRA8888)
		p.ClearPixels(0)
	End If

	For Local x:Int = cropArea.leftmost_x To cropArea.rightmost_x
		For Local y:Int = cropArea.topmost_y To cropArea.bottommost_y
			Local tmp_x:Int = x - croparea.leftmost_x
			Local tmp_y:Int = y - croparea.topmost_y
			Local pix:Int = pixmap.ReadPixel(x, y)
			p.WritePixel(tmp_x, tmp_y, pix)
		Next
	Next
	Local fi:TFreeImage = TFreeImage.CreateFromPixmap(p)
	Return fi
End Function

Function getPixelAlpha:Byte(rgba:Int)
	Return rgba &amp; $ff
EndFunction

Function getPixelRed:Byte(rgba:Int)
	Return (rgba &amp; $ff000000) Shr 24
EndFunction

Function getPixelGreen:Byte(rgba:Int)
	Return (rgba &amp; $ff0000) Shr 16
EndFunction

Function getPixelBlue:Byte(rgba:Int)
	Return (rgba &amp; $ff00) Shr 8
EndFunction

Function getARGB:Int(a:Byte, r:Byte, g:Byte, b:Byte)
	Return (a Shl 24) + (r Shl 16) + (g Shl 8) + b
End Function

Function getABGR:Int(a:Byte, r:Byte, g:Byte, b:Byte)
	Return (a Shl 24) + (b Shl 16) + (g Shl 8) + r
End Function

Function getRGBA:Int(r:Byte, g:Byte, b:Byte, a:Byte)
	Return (r Shl 24) + (g Shl 16) + (b Shl 8) + a
End Function

Public
</textarea><br>with this file freeimage version works.<br><br>TFreeImage.GetPixmap() returns a static pixmap, and you save that to TImageContainer. And when GC release unneeded "FreeImages"(locals) then those "static pixmap" fields have pixmap that is no longer in memory.<br><br>Oh, even easier is to modify this line in function GenerateImageStrip:<br><pre class=code>
Local imageContainer:TImageContainer = TImageContainer.Create(url + t, pixmap.Copy())</pre><br>^^ and that works too.<br><br><font class="tiny">Last edited 2011</font> <br><br></td></tr></table><br>
<a name="1119822"></a>

<a name="1119824"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >col</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#18">[#18]</a></td></tr></table></td></tr><tr ><td class="posttext"> If I understand GC management correctly?...<br><br>Adding the TPixmap instance to the TImageContainer should increase its internal reference count and not cause the TPixmap memory to be collected? no? or is the only reference the Local variable? and theres no trace in the GC of storing it the TImageContainer then storing that in the TList?<br><br>Also how come clearing the GC at the beginning works ok?<br><br>I'm not querying your fix, just trying to gain more knowledge of the BMax garbage collector.<br><br>cheers.<br><br><font class="tiny">Last edited 2011</font> <br><br></td></tr></table><br>
<a name="1119882"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rixarn</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#19">[#19]</a></td></tr></table></td></tr><tr ><td class="posttext"> That's a nice workaround Zeke! But still, the problem in my app is not one that involves image manipulation. I get an EAV error for other unknown reason, and for that I'll have to find another particular workaround ... that's why I believe the real problem lies in what Dave said before about GC collecting memory when it shouldn't, in cases where external code is heavily used. <br><br>Dave's Dll anecdotal example of EAV goes in the same line too...<br><br>Of course, until GC is fixed, I'll have to make my own workarounds... Either keep GC garbage low OR shutting down GC while loading/writing stuff, and resume when finish? <br><br></td></tr></table><br>
<a name="1119903"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Zeke</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#20">[#20]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> <br>the real problem lies in what Dave said before about GC collecting memory when it shouldn't, in cases where external code is heavily used.<br> <br></div><br>yes. external code is c++ code. and if you check brl.mod/blitz.mod/blitz_gc.h file:<br><div class="quote"> <br>// BBRETAIN/BBRELEASE should be used to prevent an object from garbage collection.<br>//<br>// This is mainly of use if an object is being stored outside of BlitzMax's 'sight' - say, in a C++ table.<br>//<br>// You can also use bbGCRetain/bbGCRelease functions above if necessary - MACROS are just faster.<br> <br></div><br>so, those "c++ heavy"(like freeimage) modules should use bbretain/bbrelease functions. <br><br></td></tr></table><br>
<a name="1119904"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >BlitzSupport</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#21">[#21]</a></td></tr></table></td></tr><tr ><td class="posttext"> Is the problem any different in threaded mode, assuming you're in non-threaded mode? They use different garbage collection methods, so it might be worth a shot:<br><br><div class="quote"> <br>[blitz.h]<br><br>//Which GC to use...<br><br>#ifdef THREADED<br># define BB_GC_MS<br>#else<br># define BB_GC_RC<br>#endif<br> <br></div> <br><br></td></tr></table><br>
<a name="1119910"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >col</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#22">[#22]</a></td></tr></table></td></tr><tr ><td class="posttext"> For me,<br><br>One of my most recent experiences of overloading the GC was using a simple array, an array that could change size and its data every frame, when passed into external code ( a proven MS DLL ), sometimes I'd get an EAV, sometimes not.  Nulling and GCCollecting the 'old' array before reassigning the new data to it prevented the EAV ( these were Local arrays ). Almost like there was some kind of confusion in which array referrences were valid and which ones needed collecting.<br><br>Someone recently ( sorry I cant remember your name!! ) did explain that there is a recursion depth in the GC that 'could' get overloaded, causing similar issues. You know the old analogy - 'If something 'can' happen, then it probably will' so if that is the case then I'm surprised there isn't some kind of overload protection.<br><br>Oh, all in single thread mode, debug and release. Just in debug mode it would also stop at at the line of code that was accessing the 'not supposed to null' data, still with an EAV.<br><br>I'm personally along the lines of the GC getting overloaded? In Rixarns example above, GCCollecting early seems to make plenty of room for the newer Locals to be kept alive and valid for the next steps?<br><br>The code is using TPixmap references that are becoming invalid at some point. I understand pulling the TPixmap from another object probably isnt the best thing to do, but I'd expect the TPixmap reference count to increase and internally not allow any parent objects that have a reference to be released too until said TPixmap is completely unreferenced. Am I expecting too much with that school of thought?<br><br>cheers <br><br></td></tr></table><br>
<a name="1119916"></a>

<a name="1119917"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rixarn</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#23">[#23]</a></td></tr></table></td></tr><tr ><td class="posttext"> For me it's also single threaded mode, debug and release. <br><div class="quote"> <br>so, those "c++ heavy"(like freeimage) modules should use bbretain/bbrelease functions.<br> <br></div><br>Then it means I have to hack bah.freeimage and add those bbretain/bbrelease to the code in order to safely use it? Haven't checked if bah.freeimage already has them... But if not, it will be a PITA ):<br><br>As for what to expect from the GC, I rather prefer it would always crash at the same point, or never... but not "randomly". If we as programmers are doing something we aren't supposed to do then make it crash always to remove ambiguity. If not, then it's something worth looking at, as you said James (:<br><br><font class="tiny">Last edited 2011</font> <br><br></td></tr></table><br>
<a name="1119972"></a>

<a name="1119973"></a>

<a name="1119974"></a>

<a name="1119975"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Zeke</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#24">[#24]</a></td></tr></table></td></tr><tr ><td class="posttext"> no need to play with gc... just modify freeimage.bmx<br><br>freeimage.bmx-&gt;Type TFreeImage-&gt;Method Init, line 726:<br><pre class=code>
		' build a pixmap... based on the "displayable" bitmap
		pixmap = CreateStaticPixmap(bmx_freeimage_getImage(displayImagePtr), ..
				bmx_freeimage_GetWidth(displayImagePtr), ..
				bmx_freeimage_GetHeight(displayImagePtr), ..
				bmx_freeimage_GetPitch(displayImagePtr), format)
</pre><br>change to this:<br><pre class=code>
		' build a pixmap... based on the "displayable" bitmap
		pixmap = CreateStaticPixmap(bmx_freeimage_getImage(displayImagePtr), ..
				bmx_freeimage_GetWidth(displayImagePtr), ..
				bmx_freeimage_GetHeight(displayImagePtr), ..
				bmx_freeimage_GetPitch(displayImagePtr), format).Copy()
</pre><br><br>[EDIT]<br>hmm.. but then "Freeimage" image will use 2 x memory.. because pixmap isnt static anymore.. damn..<br>maybe to ask brucey if he know how this can be solved.<br><br><font class="tiny">Last edited 2011</font> <br><br></td></tr></table><br>
<a name="1120260"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rixarn</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#25">[#25]</a></td></tr></table></td></tr><tr ><td class="posttext"> Hi Zeke,<br><br>Thanks for research. Although it is a memory expense solution, I think it is a viable solution if someone is urged to use bah.freeimage while things get fixed. Better to work at 2x the amount of memory that work with flaws.<br><br>I'm my case, I can live w/o that module for the moment. In fact I already removed all the references of bah.freeimage. Biggest problem of mine is still the GC, who releases things when it shouldn't, and doesn't release things when it should (I'm currently trying to Isolate this second case into another code example)... I really hope GC gets revised by BRL. <br><br></td></tr></table><br>
<a name="1120361"></a>

<a name="1120362"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rixarn</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#26">[#26]</a></td></tr></table></td></tr><tr ><td class="posttext"> OK, here I am with yet another example ... but this time it's not a bug because of the "type" of the Garbage Collector bmax uses. <br><br>From the docs example this is a cyclic class. I can understand why you have to null the variable to make the reference count reach to 0, or else the memory will always leak. <br><br><pre class=code>
Type TCyclic
	Field cycle:TCyclic=Self
	
	Method Remove()
		cycle=Null
	End Method
	
End Type

For k=1 To 10
	Local cyclic:TCyclic=New TCyclic
	GCCollect
	Print GCMemAlloced()
Next
</pre><br><br>Now, what I have here is a more sophisticated way of cycling references that went unnoticed and was causing all the leaking in my App!<br><br><textarea class=codebox name="code" wrap=OFF readonly="true" rows="15" cols="80">
SuperStrict

Graphics 320, 240

Local app:TApp = New Tapp

Repeat

	app.Update()
	app.Render()

	Flip() ;Cls()
Until KeyDown(KEY_ESCAPE) Or AppTerminate()

'Silly class representing an application
Type TApp

	Field memoryRegister:TMemoryRegisterer

	Field obj:TClass
	
	Field created:Byte = False
	
	Field loop_creation:Byte = True
	
	Method New()
		memoryRegister = New TMemoryRegisterer
	End Method
	
	Method Update()
	
		'Hold return key to Clear the object and forcefully call the GC, this should in theory clean the generated garbage.
		If KeyDown(KEY_RETURN)
			obj = Null
			created = False
			GCCollect()
		End If
		
		If created = False And loop_creation = True
			obj = New TClass
			created = True
		End If	
	
		memoryRegister.Update()
	End Method
	
	Method Render()
		memoryRegister.RenderInfo()
		DrawText "Hold down the ReturnKey and see how the", 0, 60
		DrawText "memory footprint rises, showing the leak", 0, 72
	End Method
	
EndType

'Some silly base class
Type TClass

	'just a stringID to 'eat' a little bit of memory.
	Field id:String = "TClass"
	
	'a wrapping class of this class
	Field wrapper:TWrapper
	
	Method New()
		wrapper = TWrapper.Create(Self)
	End Method
	
EndType

'Some silly wrapper class
Type TWrapper

	'The class we are wrapping.
	Field class:TClass
	
	'A string to 'eat' some memory.
	Field id:String = "TWrapper"
	
	Function Create:TWrapper(c:TClass)
		Local w:TWrapper = New TWrapper
		w.class = c
		Return w
	EndFunction
	
EndType

'--- some silly class to show memory usage
Type TMemoryRegisterer
	
	Field mem:Int = 0

	Field min_mem:Int = 0
	
	Field max_mem:Int = 0
	
	Field delta_mem:Int[100]
	
	Field delta_index:Int = 0
	
	Field last_mem:Int = 0
	
	Method Update()
	
		last_mem = mem
		mem = GCMemAlloced()
		
		'GCCollected!
		If mem &lt; last_mem
			delta_mem[delta_index] = (last_mem - mem)
			min_mem = mem
			max_mem = last_mem
			delta_index:+1
			If delta_index = delta_mem.Length Then delta_index = 0
		End If

		If min_mem = 0 Then min_mem = mem
		If max_mem = 0 Then max_mem = mem
		
		If mem &lt; min_mem Then min_mem = mem
		If mem &gt; max_mem Then max_mem = mem
	End Method
	
	Method RenderInfo()
		Local x:Int = 0
		Local y:Int = 0
		DrawText "GCMemAlloced:" + mem, x, y
		DrawText "MinMemAlloced:" + min_mem + " MaxMemAlloced:" + max_mem, x, y + 12
		If delta_index &gt; 0
			DrawText "DeltaMem:" + delta_mem[delta_index - 1], x, y + 24
		End If
	End Method

EndType
</textarea><br><br>In my example, it is a member object of the base class that has a reference to the base class!<br><br>When I null the obj variable after the keydown, I expected the object in memory is regarded as an "isolated island of references", and thus collected!<br><br>Java (correct me if wrong) works that way. Cyclic dependencies are not counted as reference so if Object A has reference of object B and object B has reference of Object A and they don't have any other live reference then both Objects A and B will be eligible for Garbage collection. My big serious mistake was to assume Bmax GC worked that way...<br><br>Geez, I'll have to do a LOT of manual var = null stuff all over my app. BMax GC aint that automatic as I believed... I had red before some post of JoshK talking about this but I never understood what he was saying until now...<br><br><font class="tiny">Last edited 2012</font> <br><br></td></tr></table><br>
<a name="bottom"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td align="right"><a href="http://monkeycoder.co.nz" target="_blank"><img src="/img/monkey2.svg" ></a> <a href="https://github.com/blitz-research" target="_blank"><img src="/img/github.svg" ></a> <a href="https://discord.gg/qJccbSp" target="_blank"><img src="/img/discord.svg" ></a></td></tr></table><br></div><br><table width="100%"><tr><td></body></html lang="en">
