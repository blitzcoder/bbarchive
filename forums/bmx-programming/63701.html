<!DOCTYPE html><html lang="en" ><head ><title >KeyDown/KeyHit slow on Macs?</title><meta name='viewport' content='width=device-width, initial-scale=0.66'><meta name='description' content='language:basic, target:desktop, category:game development'><link rel="styleSheet" href="../skins/granite/style.css" type="text/css"><style type="text/css">div.bbcode {padding: 8px;background: #E5E5E5;color: #000000;border: 1px dashed #B4B4BE;}</style></head><body ><table width=100% cellspacing=0 cellpadding=0><tr ><td class="menubarleft"></td><td class="menubar"><table cellspacing="0" cellpadding="0"><tr ><td >&nbsp;</td><td class="menuitemleft"></td><td class="menuitem"><a href="/" class="menuitem">News</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/forums.php" class="menuitem">Forums</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/codearcs.php" class="menuitem">Code</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/logs.php" class="menuitem">Logs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/gallery.php" class="menuitem">Gallery</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/sdkspecs.php" class="menuitem">Specs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/search.php" class="menuitem">Search</a></td><td class="menuitemright"></td></tr></table></td><td class="menubarright"></td></tr></table><div class="main"><h1 >KeyDown/KeyHit slow on Macs?</h1><a href="forums.php" >BlitzMax Forums</a>/<a href="topics.php?forum=102" >BlitzMax Programming</a>/<a href="#bottom" >KeyDown/KeyHit slow on Macs?</a><br><br>
<a name="711028"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Fry Crayola</td><td align="right"><font class=tiny>(Posted 2006)</font>&nbsp;<a href="#1">[#1]</a></td></tr></table></td></tr><tr ><td class="posttext"> I was having a bit of a frustrating time with Diablo's HighGui mod (it's not the mod's fault), which returned frame rates on my Intel Mac that were about a tenth of the rates of my PC. <br><br>After many tweaks and tests I located the problem, and it came from what I would consider an unlikely source: KeyHit and KeyDown (deep in the bowels of the HighGui code).<br><br>Commenting out the offending lines (all simple tests) saw my FPS rise from 72, to about 350, using an Diablo's Button example code (six gadgets on screen, adding more drags the performance down even further).<br><br>The PC isn't blighted in this way at all. <br><br>I carried out a search here on the forums, and found a similar thread from 11 months ago in the bug bin, basically saying the same thing. A thread in the bug bin usually indicates that the matter has been dealt with.<br><br>Which leads me to ask - is this a Mac issue that can't be resolved? Has anyone else experienced this? <br><br></td></tr></table><br>
<a name="711066"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Diordna</td><td align="right"><font class=tiny>(Posted 2006)</font>&nbsp;<a href="#2">[#2]</a></td></tr></table></td></tr><tr ><td class="posttext"> Never had a problem before. <br><br></td></tr></table><br>
<a name="711077"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Floyd</td><td align="right"><font class=tiny>(Posted 2006)</font>&nbsp;<a href="#3">[#3]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote">  ...saw my FPS rise from 72...  <br></div><br><br>That makes me suspect the GUI code is synched with the screen refresh rate.<br><br>It's just a guess. I have neither Mac nor HighGui. <br><br></td></tr></table><br>
<a name="711132"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Fry Crayola</td><td align="right"><font class=tiny>(Posted 2006)</font>&nbsp;<a href="#4">[#4]</a></td></tr></table></td></tr><tr ><td class="posttext"> Unfortunately, I checked all that and there's no syncing being done - if there was, commenting out the short loop which tests 200 KeyDowns wouldn't see a rise to over 300FPS. The line 'Flip 0' in the code was also commented out just to be sure, the frame rate remained low.<br><br>Each frame, it tests all the keys to allow keyboard shortcuts in the GUI - as a last resort I could cut this from the Mac version but I'm reluctant to make sweeping changes if it's actually a fixable problem, rather than 'just the way Macs are'.<br><br><br><br>Diordna - can you try running a simple loop that checks a key and see how long it takes?<br><br><pre class=code>
start = Millisecs()
for local count:int = 1 to 200
	keydown(KEY_ESCAPE)
next

print "Time: "+(Millisecs() - start)
</pre><br><br>This takes much longer on the Mac than on the PC, yet other code (bank accessing, maths, graphics etc.) runs just as fast. <br><br></td></tr></table><br>
<a name="711147"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Brucey</td><td align="right"><font class=tiny>(Posted 2006)</font>&nbsp;<a href="#5">[#5]</a></td></tr></table></td></tr><tr ><td class="posttext"> The problem could be in updateEvents() in system.macos.m which is called every time you call keydown()<br><br>I imagine it would be better to get updateEvents called once per iteration of your main loop (by calling PollSystem), and have KeyDown simply return true or false for the specified key (rather than Poll the system, which it does now, before it returns the key value)<br><br>but I'm sure there's a reason the core stuff is coded the way it is?? ;-)<br><br><br>You could always try changing polledinput.bmx from<br>Global autoPoll=True<br>to<br>Global autoPoll=False<br><br>and then call PollSystem in your main loop...<br><br>and see what breaks ;-) <br><br></td></tr></table><br>
<a name="711172"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >ClaudeClaus</td><td align="right"><font class=tiny>(Posted 2006)</font>&nbsp;<a href="#6">[#6]</a></td></tr></table></td></tr><tr ><td class="posttext"> Fry, I runned your loop several times and I get values between 24 (once) and 38 (once) with the majority being 27. It's on a MacIntel, 10.4.7, 1GB RAM.<br>Hope this helps.<br>Klaus <br><br></td></tr></table><br>
<a name="711178"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Fry Crayola</td><td align="right"><font class=tiny>(Posted 2006)</font>&nbsp;<a href="#7">[#7]</a></td></tr></table></td></tr><tr ><td class="posttext"> With an average time of about 27ms, that means you could get about 37 frames in each second which is far from ideal.<br><br>Ok - it can be argued that testing every single key (pretty much) every frame isn't going to be necessary, but it's more the fact that its lightning quick on the PC and doggedly slow on the Mac that worries me. <br><br></td></tr></table><br>
<a name="711206"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Floyd</td><td align="right"><font class=tiny>(Posted 2006)</font>&nbsp;<a href="#8">[#8]</a></td></tr></table></td></tr><tr ><td class="posttext"> That is impressively slow!<br><br>I tried the test on a very old and slow PC, putting everyting inside another loop so it ran 25 times.<br><br>The times were always 0 or 1, most of them being 0. <br><br></td></tr></table><br>
<a name="711226"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Fry Crayola</td><td align="right"><font class=tiny>(Posted 2006)</font>&nbsp;<a href="#9">[#9]</a></td></tr></table></td></tr><tr ><td class="posttext"> ...hence my concern. Even if I hacked at the code and removed or severely cut down the key testing to fewer keys (say, 10 instead of 200) I'm still losing time that I'd rather the processor spent doing other things. <br><br>The project I'm working on is fairly processor intensive, so "time wasted" needs to be kept to a minimum. If this problem was an inherent flaw in the Mac rather than BlitzMax, any Mac version I produce would be inferior to the PC one by a substantial amount. <br><br></td></tr></table><br>
<a name="712399"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Fry Crayola</td><td align="right"><font class=tiny>(Posted 2006)</font>&nbsp;<a href="#10">[#10]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> <br>You could always try changing polledinput.bmx from<br>Global autoPoll=True<br>to<br>Global autoPoll=False<br><br>and then call PollSystem in your main loop...<br><br>and see what breaks ;-)<br> <br></div><br><br>Irritatingly, nothing broke. I tried it in the loop and I'm getting returns of 0 and 1 millisecs, which is of course great. In Diablo's HighGui, I'm getting much, much higher frame rates as a result.<br><br>But like you, I have a concern - that autopoll=true must be there for a reason, and I'd hate to be breaking something else. I'm not a fan of changing things that I don't really know much about. <br><br></td></tr></table><br>
<a name="712406"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Fry Crayola</td><td align="right"><font class=tiny>(Posted 2006)</font>&nbsp;<a href="#11">[#11]</a></td></tr></table></td></tr><tr ><td class="posttext"> Something worth sharing, I feel:<br><br>I ran a test on both Windows and OS X with the following code:<br><br><pre class=code>
For Local a:Int = 1 To 25
     start = MilliSecs()
	 
     For Local count:Int = 1 To 1000000
	     KeyDown(KEY_ESC)
     Next

     Print "Time: "+(MilliSecs() - start)

Next
</pre><br><br>Basically, I wanted to test how fast KeyDown runs, with Debug turned off. Being lazy I never bothered to actually code in the bit which would calculate the speed of a single call but that's just me. I broke out the calculator.<br><br>Windows returned results averaging around 39ms, which works out at about 0.00000004 secs per call.<br><br>OS X returned just shy of 25 seconds (yup, it's that big a difference) working out at around 624 times slower. <br><br><br>Turning off the autoPoll and calling PollSystem once for each of the 25 runs, gave 4ms results. Obviously you can't compare the two but certainly I'm happy with the speed if that's the case.<br><br><br>Ideally, if someone in the know could confirm that turning off the autoPoll isn't about to break crucial parts of BlitzMax somewhere along the line, which I think should be the case as it would only ever be called when I explicitly ask anyway (via a KeyDown or similar), then I'm a very happy man and will be running with this solution. <br><br></td></tr></table><br>
<a name="712436"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Brucey</td><td align="right"><font class=tiny>(Posted 2006)</font>&nbsp;<a href="#12">[#12]</a></td></tr></table></td></tr><tr ><td class="posttext"> It really does sound like a bug on OS X... <br><br></td></tr></table><br>
<a name="712437"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Brucey</td><td align="right"><font class=tiny>(Posted 2006)</font>&nbsp;<a href="#13">[#13]</a></td></tr></table></td></tr><tr ><td class="posttext"> btw... you realize also that HighGUI calls lots of MouseX/MouseY etc throughout, as well as many, many TextWidth/Height calls... (certainly the MouseX/Y calls will have been polling too on OS X)<br><br>I've rewritten/reorganized a lot of the under-lying code while I've been trying it out on Linux, and I've seen boosts of 10-20+% in places. (for example, I got the combobox example up from 76fps to 109fps)<br>I also converted the code from includes to imports - changing the core structure - cuz I don't like includes...<br><br>Still want to do some more work on it, but I only tinker when I need a break from my other stuff.<br><br>I have to thank Diablo for having a good base to work from ;-) <br><br></td></tr></table><br>
<a name="712458"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Fry Crayola</td><td align="right"><font class=tiny>(Posted 2006)</font>&nbsp;<a href="#14">[#14]</a></td></tr></table></td></tr><tr ><td class="posttext"> Aye, the MouseHit/Down affected the speed too but on a much smaller scale (only 3 buttons to worry about, really, and a few axes). I wasn't aware that TextWidth/Height would suffer accordingly. <br><br></td></tr></table><br>
<a name="712471"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Brucey</td><td align="right"><font class=tiny>(Posted 2006)</font>&nbsp;<a href="#15">[#15]</a></td></tr></table></td></tr><tr ><td class="posttext"> well, everytime you call TextWidth, it has to go off and calculate the width of the given string for a specific font.<br><br>Sure, it doesn't take forever to calculate that (probably iterates over the glyphs and returns the total), but if you are doing that lots of times, it all adds up - especially if you could instead cache those values which aren't going to change anyway!<br><br>Anyhoo... that was just one of the optimizations I looked into. <br><br></td></tr></table><br>
<a name="712472"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Fry Crayola</td><td align="right"><font class=tiny>(Posted 2006)</font>&nbsp;<a href="#16">[#16]</a></td></tr></table></td></tr><tr ><td class="posttext"> Always worth a shot.<br><br>I'll look into optimising it after I've finished a nice little XML wrapper thingy (I have no idea about jargon) which can let me throw together GUI screens like I'd code HTML. I plan to use this in my game and hopefully keep it powerful enough to allow for some fairly good skinning.<br><br>That's assuming I'm any good. <br><br></td></tr></table><br>
<a name="728884"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Tachyon</td><td align="right"><font class=tiny>(Posted 2006)</font>&nbsp;<a href="#17">[#17]</a></td></tr></table></td></tr><tr ><td class="posttext"> Just got a new MacIntel. I noticed this topic, ran the sample code and get that same 27ms on 200 KeyDown calls. Crazy slow!<br><br>Mark/Skid hasn't commented here. Does this need to be posted in the Bug forum? Hacking BlitzMax isn't really what I expect to be a quality solution. :) <br><br></td></tr></table><br>
<a name="729047"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Fry Crayola</td><td align="right"><font class=tiny>(Posted 2006)</font>&nbsp;<a href="#18">[#18]</a></td></tr></table></td></tr><tr ><td class="posttext"> I posted the same topic in the bug section, and Mark replied that the "hack" will work if you call PollSystem "often enough". I call it every single frame, so that's going to be at least 60 times a second. I've noticed that the only issue if you don't call it (in addition to not getting to read key presses) is that the OS thinks the program has frozen up because it's not getting any responses from it.<br><br>I've noticed no other ill effects, so there's no harm in the minor hack. <br><br></td></tr></table><br>
<a name="bottom"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td align="right"><a href="http://monkeycoder.co.nz" target="_blank"><img src="/img/monkey2.svg" ></a> <a href="https://github.com/blitz-research" target="_blank"><img src="/img/github.svg" ></a> <a href="https://discord.gg/qJccbSp" target="_blank"><img src="/img/discord.svg" ></a></td></tr></table><br></div><br><table width="100%"><tr><td></body></html lang="en">
