<!DOCTYPE html><html lang="en" ><head ><title >Console problem</title><meta name='viewport' content='width=device-width, initial-scale=0.66'><meta name='description' content='language:basic, target:desktop, category:game development'><link rel="styleSheet" href="../skins/granite/style.css" type="text/css"><style type="text/css">div.bbcode {padding: 8px;background: #E5E5E5;color: #000000;border: 1px dashed #B4B4BE;}</style></head><body ><table width=100% cellspacing=0 cellpadding=0><tr ><td class="menubarleft"></td><td class="menubar"><table cellspacing="0" cellpadding="0"><tr ><td >&nbsp;</td><td class="menuitemleft"></td><td class="menuitem"><a href="/" class="menuitem">News</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/forums.php" class="menuitem">Forums</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/codearcs.php" class="menuitem">Code</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/logs.php" class="menuitem">Logs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/gallery.php" class="menuitem">Gallery</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/sdkspecs.php" class="menuitem">Specs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/search.php" class="menuitem">Search</a></td><td class="menuitemright"></td></tr></table></td><td class="menubarright"></td></tr></table><div class="main"><h1 >Console problem</h1><a href="forums.php" >BlitzMax Forums</a>/<a href="topics.php?forum=102" >BlitzMax Programming</a>/<a href="#bottom" >Console problem</a><br><br>
<a name="958384"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >nawi</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#1">[#1]</a></td></tr></table></td></tr><tr ><td class="posttext"> How can I (in a console program)<br>a) Run some code after the user clicks the X button to close the program<br>b) Catch some keyboard input without stopping the program. Keyhit, getchar etc won't work in console program. Input() stops the program.<br><br>What I'm doing, is that my server has to do some cleanup at the end of the program, but I don't know how to execute CleanUp() function at the end of the program. <br><br></td></tr></table><br>
<a name="958394"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Kistjes</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#2">[#2]</a></td></tr></table></td></tr><tr ><td class="posttext"> Use the OnEnd() function. <br><br></td></tr></table><br>
<a name="958396"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Phil Newton</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#3">[#3]</a></td></tr></table></td></tr><tr ><td class="posttext"> I'm having the exact same problem right now. OnEnd doesn't seem to work when the X button is closed in a console app. <br><br></td></tr></table><br>
<a name="958400"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Nate the Great</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#4">[#4]</a></td></tr></table></td></tr><tr ><td class="posttext"> bmax can make games for consoles like Xbox?  sorry but have I been uninformed this whole time? or is this c++? <br><br></td></tr></table><br>
<a name="958405"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Phil Newton</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#5">[#5]</a></td></tr></table></td></tr><tr ><td class="posttext"> Nope, talking about a text-based console window, like when you run "cmd" from Windows.<br><br>Sorry :) <br><br></td></tr></table><br>
<a name="958414"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Nate the Great</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#6">[#6]</a></td></tr></table></td></tr><tr ><td class="posttext"> oh ok just making sure I wasn't missing out :) <br><br></td></tr></table><br>
<a name="958419"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >nawi</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#7">[#7]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> Use the OnEnd() function.  <br></div><br>This doesn't work, since "end" is not called when you close the program. <br><br></td></tr></table><br>
<a name="958436"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Kistjes</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#8">[#8]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> This doesn't work, since "end" is not called when you close the program.  <br></div><br>Didn't know that. <br><br></td></tr></table><br>
<a name="958441"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >plash</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#9">[#9]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> OnEnd doesn't seem to work when the X button is closed in a console app. <br></div>It does seem to, in a sense, but it does not seem like you can actually return to regular process (after any instructions you give it, it stills exits, ultimately).<br><br><pre class=code>
SuperStrict

Framework brl.blitz
Import brl.standardio
Import brl.system

OnEnd(Cleanup)

Input("Terminate me!")
End

Function Cleanup()
	
	CreateFile("Ahha.blah") ' Proof!
	
End Function</pre> <br><br></td></tr></table><br>
<a name="958451"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Nate the Great</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#10">[#10]</a></td></tr></table></td></tr><tr ><td class="posttext"> maybe have a loop that says if appterminate then do this <br><br></td></tr></table><br>
<a name="958477"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >EOF</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#11">[#11]</a></td></tr></table></td></tr><tr ><td class="posttext"> I am working on a Console Control module as it happens but I have not got round to doing the KeyDown()/KeyHit() side of things<br>I only have Input() so far as a method for reading the user input<br><br>WINDOWS ONLY<br><br>Examples of some of the commands:<br><pre class=code>
Console.Open "Test window"
Console.SetColor RED,GREY
Console.Cls
Console.SetCursorPos 10,5
Console.Write "Hello world"

t$=Console.Input("Enter your name &gt; ")

Console.Close
</pre> <br><br></td></tr></table><br>
<a name="958495"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >nawi</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#12">[#12]</a></td></tr></table></td></tr><tr ><td class="posttext"> Plash, you don't understand the problem. It's like this.<br><br><pre class=code>

'Server code
Repeat
   'Do server stuff
   UpdateClients()

Forever 'I cannot use Input, it stops updating clients
        'cannot use keyhit, getchar, etc etc..

OnEnd(Cleanup)

Function Cleanup()
	
	CreateFile("Ahha.blah") ' Proof!
	
End Function
</pre><br>Cleanup will never be called if I run this as a console app and hit X to close the server. If I could somehow catch user input like (hit key escape) then that would be an okay solution too. The user should just hit escape to close the program. But keyhit, getchar doesn't work in console mode. <br><br></td></tr></table><br>
<a name="958504"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >grable</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#13">[#13]</a></td></tr></table></td></tr><tr ><td class="posttext"> @nawi, For non-halting input, try some of the functions from <b>c stdio/conio</b>..<br><pre class=code>
Extern "C"
  Function getchar:Int()
  Function getch:Int()
  Function getche:Int()
  Function kbhit:Int()
EndExtern
</pre> <br><br></td></tr></table><br>
<a name="958511"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >plash</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#14">[#14]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> Cleanup will never be called if I run this as a console app and hit X to close the server. <br></div>Uhm.. Given the position you put your OnEnd call, that is absolutely correct.<br>How do you expect the Cleanup function to be called when it is never told to before the program actually exits? (OnEnd never gets called because it completely stops at whatever point in your loop to do the exit, at which point it calls all OnEnd callbacks)<br><br>EDIT: Think of it like this:<br>Your program is doing its main loop, updating clients and whatever.<br>Then the user hits the X button on the Console's window, which then goes through some stuff on the Win32 end.<br>It eventually calls your program's exit function (keep in mind these times are within nano/milli-seconds), which then calls all OnEnd callbacks.<br><br>If you will read that carefully, you will notice that you <b>never</b> actually called OnEnd.<br><br>EDIT2: Code example of the first edit:<br><pre class=code>
SuperStrict

Framework brl.blitz
Import brl.system

Repeat
	
	Delay(2000) ' Simulatory..
	End() ' This will be our substitute for the user pressing the X button.
		' Note that you could also just do an infinite loop and just hit the X button (not using End())
	
Forever

OnEnd(Cleanup) ' NEVER gets called. Ever.

Function Cleanup()
	
	CreateFile("Ahha.blah")
	
End Function
</pre> <br><br></td></tr></table><br>
<a name="958523"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Nate the Great</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#15">[#15]</a></td></tr></table></td></tr><tr ><td class="posttext"> so you should put onend at the beginning right after super strict. <br><br></td></tr></table><br>
<a name="958540"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Zeke</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#16">[#16]</a></td></tr></table></td></tr><tr ><td class="posttext"> <pre class=code>
Extern "WIN32"
	Function SetConsoleCtrlHandler:Int(func(),add:Int)
End Extern

Extern "C"
  Function getch:Int()
  Function kbhit:Int()
EndExtern

SetConsoleCtrlHandler(Cleanup,True)

Local running=1

Print "Close window or type something"
While running
	If kbhit() Then Print "keyhit: "+getch()
Wend

Function Cleanup()
	running=0
	Notify "Cleaning..."
End Function
</pre><br>but this is windows only.. <br><br></td></tr></table><br>
<a name="958591"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >nawi</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#17">[#17]</a></td></tr></table></td></tr><tr ><td class="posttext"> Plash, you don't understand the problem. End() is not called when the user clicks the X button in a console program, so placing OnEnd before the loop doesn't fix anything.<br><br>Windows-only solutions don't help.<br><br><div class="quote"> ' Note that you could also just do an infinite loop and just hit the X button (not using End()) <br></div><br>That's incorrect, I just tested. <br><br></td></tr></table><br>
<a name="958601"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Nurgle</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#18">[#18]</a></td></tr></table></td></tr><tr ><td class="posttext"> @nawi the code that Plash has posted does work clicking the x in a console will create a file called Ahha.blah<br>example of infinite loop with no End<br><pre class=code>SuperStrict

Framework brl.blitz
Import brl.system
Import brl.standardio

OnEnd(Cleanup) 

Print "Click x to exit"

Repeat

	
Forever

Function Cleanup()
	
	CreateFile("Ahha.blah")
	
End Function</pre> <br><br></td></tr></table><br>
<a name="958606"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >nawi</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#19">[#19]</a></td></tr></table></td></tr><tr ><td class="posttext"> @Nurgle.<br>I see now that it does work, but there seems to be a really small time to execute any code. If I try to loop 100 times and print stuff, I only get like 10 print's. Likewise, my goal is to connect to a server and there is no time for that either.. In fact, if you add delay 5000, the app still closes rapidly.<br><br>What I'm trying to do, if that when the server is closed, the server connects to a serverlist-server, and notifys it to remove that server from the list. Yeah, I have a timeout system in plaec, and it will be removed after some time, but this causes the server to be on the list for a minute or too and players will try to connect to it, even though it should've been removed. <br><br></td></tr></table><br>
<a name="958690"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >plash</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#20">[#20]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> Plash, you don't understand the problem. End() is not called when the user clicks the X button in a console program, so placing OnEnd before the loop doesn't fix anything. <br></div>OnEnd adds functions to be called when 'exit' is called (for Max use, 'End' is the same as calling 'exit'). The 'exit' function is in C, and is automatically called WHENEVER the program shuts down (via normal means - a crash/taskkill probably wont call it, afaik).<br><br><i>/mod/brl.mod/blitz.mod/blitz_app.c</i><br><pre class=code>void bbEnd(){
	exit(0);
}

void bbOnEnd( void (*f)() ){
	atexit( f );
}</pre><br>Notice the internal functions for Max. 'End' actually does call 'exit' (with the exit code 0, meaning no error).<br>OnEnd adds a function to be called when the <b>program</b> is closed (and, subsequently, when you call 'End'). <br><br></td></tr></table><br>
<a name="958739"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >nawi</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#21">[#21]</a></td></tr></table></td></tr><tr ><td class="posttext"> Yes I know that now Plash, but I explained a new problem in my post above. <br><br></td></tr></table><br>
<a name="958769"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >plash</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#22">[#22]</a></td></tr></table></td></tr><tr ><td class="posttext"> There is no way to get around that issue unless you can capture the events for the console and do with them as you wish. <br><br></td></tr></table><br>
<a name="1030526"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Cold Storage</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#23">[#23]</a></td></tr></table></td></tr><tr ><td class="posttext"> I'm a bit late to the party(!)<br><br>But, you could have used a 'boot' program to launch your main .exe. <br><br>The boot program hangs around polling every now and again to see if the main program has finished. If it has, then it closes everything off nicely for you, then self-terminates.<br><br>I've had to employ a similar set-up for my project....<br><br>I have one program that very graphically intensive but it needs to sit and wait for FTP feedback (not quick by any means!). So instead, I have an FTP program that launches the graphical program and passes data to it via a shared file. <br><br>This way the FTP program can take as long as it likes, but the graphical program can run un-hindered. ( I also hide the FTP window so the user doesn't know it's there ).<br><br>A kind of poor man's multi-thread. ;o) <br><br></td></tr></table><br>
<a name="bottom"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td align="right"><a href="http://monkeycoder.co.nz" target="_blank"><img src="/img/monkey2.svg" ></a> <a href="https://github.com/blitz-research" target="_blank"><img src="/img/github.svg" ></a> <a href="https://discord.gg/qJccbSp" target="_blank"><img src="/img/discord.svg" ></a></td></tr></table><br></div><br><table width="100%"><tr><td></body></html lang="en">
