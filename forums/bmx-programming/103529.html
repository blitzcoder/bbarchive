<!DOCTYPE html><html lang="en" ><head ><title >CloseStream and GC</title><meta name='viewport' content='width=device-width, initial-scale=0.66'><meta name='description' content='language:basic, target:desktop, category:game development'><link rel="styleSheet" href="../skins/granite/style.css" type="text/css"><style type="text/css">div.bbcode {padding: 8px;background: #E5E5E5;color: #000000;border: 1px dashed #B4B4BE;}</style></head><body ><table width=100% cellspacing=0 cellpadding=0><tr ><td class="menubarleft"></td><td class="menubar"><table cellspacing="0" cellpadding="0"><tr ><td >&nbsp;</td><td class="menuitemleft"></td><td class="menuitem"><a href="/" class="menuitem">News</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/forums.php" class="menuitem">Forums</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/codearcs.php" class="menuitem">Code</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/logs.php" class="menuitem">Logs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/gallery.php" class="menuitem">Gallery</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/sdkspecs.php" class="menuitem">Specs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/search.php" class="menuitem">Search</a></td><td class="menuitemright"></td></tr></table></td><td class="menubarright"></td></tr></table><div class="main"><h1 >CloseStream and GC</h1><a href="forums.php" >BlitzMax Forums</a>/<a href="topics.php?forum=102" >BlitzMax Programming</a>/<a href="#bottom" >CloseStream and GC</a><br><br>
<a name="1247250"></a>

<a name="1247251"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Adam Novagen</td><td align="right"><font class=tiny>(Posted 2014)</font>&nbsp;<a href="#1">[#1]</a></td></tr></table></td></tr><tr ><td class="posttext"> It's been a very long time since I last coded, and that was in Blitz3D, so I find myself encountering occasional small hiccups by jumping right in with Max nowadays. My basic understanding of garbage collection is that if there is anything in memory which is not referenced by something - like an image that is no longer "contained" in any existing variables - it will eventually get deleted. Being used to always closely managing my own memory cleanup, however, I sometimes get a bit nervous, as per the following:<br><br><pre class=code>SuperStrict

Function readSomeFile(filePath:string)
	Local file:TStream = ReadFile(filePath)
	
	' Do naughty things to file
	
	CloseStream file ; file = Null
EndFunction</pre><br><br>From my understanding, because <b>file</b> is a local variable and therefore only exists within the scope of <b>readSomeFile()</b>, once the program gets back out of the function, the file's TStream will no longer be referenced by the <b>file</b> variable, setting it for garbage collection and making the whole <b>CloseStream</b> line unnecessary. Is that right? <br><br></td></tr></table><br>
<a name="1247252"></a>

<a name="1247253"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Derron</td><td align="right"><font class=tiny>(Posted 2014)</font>&nbsp;<a href="#2">[#2]</a></td></tr></table></td></tr><tr ><td class="posttext"> TStream.Delete() (a method) gets called as soon as a stream is marked for "garbage collection".<br><br>The default implementation of "Delete()" (for TStream) calls "Close()".<br><br>Close() is also called when using "CloseStream()" (which is just a convencience function to the streams "Close" Method).<br><br><br>EDIT: Filestreams call "fclose_" in their "Close". So this means they work with the filehandle, telling the system it is used (or then unused) etc.<br>As soon as "Method Delete()" does not get overwritten BY YOU or your modules ... you could rely on "Delete()" to get called during garbage collection.<br><br>"Close()" (or CloseStream()) therefore just ensures that the file handle is available right afterwards (imagine threads - and the time between "unused" and "garbage collection" taking place ...)<br><br><br>bye<br>Ron <br><br></td></tr></table><br>
<a name="1247259"></a>

<a name="1247260"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Yasha</td><td align="right"><font class=tiny>(Posted 2014)</font>&nbsp;<a href="#3">[#3]</a></td></tr></table></td></tr><tr ><td class="posttext"> The final `file = null` is redundant; you don't need to "remove" the reference from `file` when the variable itself will stop existing too (it might be less redundant if more things, such as a long loop, were to happen in that scope afterwards but generally unnecessary).<br><br>Anyway Derron's post covers the basic part - that external resources require manual cleanup code, but this code can be placed in the managed Max object's finalizer, so the external resource will be freed when the Max object is collected.<br><br>However, there's a second aspect to this: there's no guarantee the GC will ever actually run. This is a good thing - GCs are tuned towards reducing memory pressure and staying out of the way. But if the application isn't under memory pressure, it isn't guaranteed to ever actually collect objects, which means their finalizers won't run, or more likely that they just won't run as soon as the object falls out of scope, but at some indeterminate point later, when memory starts to run low and it decides to do something about it. Therefore for scarce non-memory resources like file handles, which actually do need to be returned to the system as soon as you're done with them, an explicit call to Close (or the relevant release method) is still good practice. <br><br></td></tr></table><br>
<a name="1247279"></a>

<a name="1247280"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Adam Novagen</td><td align="right"><font class=tiny>(Posted 2014)</font>&nbsp;<a href="#4">[#4]</a></td></tr></table></td></tr><tr ><td class="posttext"> So it's just a question of forcing a closing of something early if you want to keep things streamlined, got it. And in retrospect, I dunno what I was thinking with <b>file = Null</b>.<br><br><div class="quote"> external resources require manual cleanup code, but this code can be placed in the managed Max object's finalizer, so the external resource will be freed when the Max object is collected. <br></div>Not gonna lie, I'm new enough to Max that I only understand half of this. Does this mean that if I have an image loaded into a Global, for example, then later I set that Global to <b>Null</b>, the image will stay in memory as a leak? <br><br></td></tr></table><br>
<a name="1247313"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Derron</td><td align="right"><font class=tiny>(Posted 2014)</font>&nbsp;<a href="#5">[#5]</a></td></tr></table></td></tr><tr ><td class="posttext"> No ... what he said was:<br><br>- you unset a variable<br>- you do other things<br>- if GC decides you are getting low on memory ("it is time!"), the unset variables will get freed<br><br>in the case of file streams this "close()" is needed to ensure the file handle is freed right after use... not "sometimes / maybe / ... in the future".<br><br><br>bye<br>Ron <br><br></td></tr></table><br>
<a name="1247322"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Brucey</td><td align="right"><font class=tiny>(Posted 2014)</font>&nbsp;<a href="#6">[#6]</a></td></tr></table></td></tr><tr ><td class="posttext"> You should close a stream/file as soon as it is no longer required. Really. Why keep a handle open on something just because the GC will get around to it sometime later. That's just laziness.<br><br>:o) <br><br></td></tr></table><br>
<a name="1247432"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >*</td><td align="right"><font class=tiny>(Posted 2014)</font>&nbsp;<a href="#7">[#7]</a></td></tr></table></td></tr><tr ><td class="posttext"> Coming from C++ I never rely on GC for clean up and always try to release resources when I've finished with them, its only a few extra lines so isn't major.<br><br>If GC is only fired when memory is low its good practice to release/close stuff yourself otherwise sometimes debugging an unexpected crash can stall even the best project. For example back in the day you could only have x amount of files open so leaving handles to GC to get rid of would be a no-no I don't know if its still the case but I don't want to find out :) <br><br></td></tr></table><br>
<a name="1247501"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Yasha</td><td align="right"><font class=tiny>(Posted 2014)</font>&nbsp;<a href="#8">[#8]</a></td></tr></table></td></tr><tr ><td class="posttext"> Well in C++ you should never need to release anything either, RAII and all that. Eager and deterministic is great for scarce resources like file handles, even if it is suboptimal for memory.<br><br>Some primarily-GC-oriented languages also offer limited RAII in the form of "with" or "using" blocks, that are guaranteed to close a resource at the end of the scope regardless of normal collection rules. You could probably emulate this in Max somehow using a block-wrapper function (although I'm not sure how to do it <i>elegantly</i>, with the lack of either macros - which you'd use to hack it together in C, over a `for` - or proper nested functions).<br><br><br>Being able to put together constructs like this is a seriously strong argument in favour of having either macros, or at least some kind of generic "block expression" (templates/do-blocks/lambdas), in a language. <br><br></td></tr></table><br>
<a name="bottom"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td align="right"><a href="http://monkeycoder.co.nz" target="_blank"><img src="/img/monkey2.svg" ></a> <a href="https://github.com/blitz-research" target="_blank"><img src="/img/github.svg" ></a> <a href="https://discord.gg/qJccbSp" target="_blank"><img src="/img/discord.svg" ></a></td></tr></table><br></div><br><table width="100%"><tr><td></body></html lang="en">
