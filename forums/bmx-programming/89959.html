<!DOCTYPE html><html lang="en" ><head ><title >multi-threading: what must be done in main thread?</title><meta name='viewport' content='width=device-width, initial-scale=0.66'><meta name='description' content='language:basic, target:desktop, category:game development'><link rel="styleSheet" href="../skins/granite/style.css" type="text/css"><style type="text/css">div.bbcode {padding: 8px;background: #E5E5E5;color: #000000;border: 1px dashed #B4B4BE;}</style></head><body ><table width=100% cellspacing=0 cellpadding=0><tr ><td class="menubarleft"></td><td class="menubar"><table cellspacing="0" cellpadding="0"><tr ><td >&nbsp;</td><td class="menuitemleft"></td><td class="menuitem"><a href="/" class="menuitem">News</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/forums.php" class="menuitem">Forums</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/codearcs.php" class="menuitem">Code</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/logs.php" class="menuitem">Logs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/gallery.php" class="menuitem">Gallery</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/sdkspecs.php" class="menuitem">Specs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/search.php" class="menuitem">Search</a></td><td class="menuitemright"></td></tr></table></td><td class="menubarright"></td></tr></table><div class="main"><h1 >multi-threading: what must be done in main thread?</h1><a href="forums.php" >BlitzMax Forums</a>/<a href="topics.php?forum=102" >BlitzMax Programming</a>/<a href="#bottom" >multi-threading: what must be done in main thread?</a><br><br>
<a name="1022279"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rozek</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#1">[#1]</a></td></tr></table></td></tr><tr ><td class="posttext"> Hello!<br><br>If you are following the activities in this forum, you might already have realized that I am currently (heavily) struggling with multi-threading related issues...<br><br>My current problem: it seems that even "loadImage" must only be done from within the main thread (which is really difficult for me as I need the image size in my subthread)<br><br>In order not to jump from one trap to the next: is there a list of functions which must only be called from the main thread?<br><br>Thanks in advance for any hints! <br><br></td></tr></table><br>
<a name="1022280"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rozek</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#2">[#2]</a></td></tr></table></td></tr><tr ><td class="posttext"> By the way:<br><br>does "loadImage" cache the images which have already been loaded? <br><br></td></tr></table><br>
<a name="1022307"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >_Skully</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#3">[#3]</a></td></tr></table></td></tr><tr ><td class="posttext"> You probably need to pass the objects back up to the main thread so they don't get GC'd?  I'm not threading yet so I can't back this up ;) <br><br></td></tr></table><br>
<a name="1022341"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >slenkar</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#4">[#4]</a></td></tr></table></td></tr><tr ><td class="posttext"> just graphics related functions i think <br><br></td></tr></table><br>
<a name="1022347"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >ziggy</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#5">[#5]</a></td></tr></table></td></tr><tr ><td class="posttext"> Graphic related API calls should be done from a single thread as OpenGL and DX7 are not thread safe (not sure about DX9). It does not have to be the main thread as long as there are not concurrent API calls from several threads. <br><br></td></tr></table><br>
<a name="1022371"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >marksibly</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#6">[#6]</a></td></tr></table></td></tr><tr ><td class="posttext"> Hi,<br><br>Unfortunately, working out what needs to be on the 'main thread', what is threadsafe or not etc is all very much subject to experimentation right now.<br><br>For example, the Cocoa docs state that Cocoa is 'mostly' multi-threaded - not sure what that means exactly.<br><br>OpenGL will probably require you to use the same thread that the GL context was created in (or perhaps you can duplicate the context among threads), while 'some parts' of DirectX should only apparently be called from the main thread (SetCooperativeLevel in d3d7 I think - not sure what the situation is in d3d9).<br><br>This is part of the reason I changed your glDeleteTextures fix - by flushing GC'd textures before creating textures, you at least guarantee that textures are created/deleted by the same thread, if not necessarily the main thread.<br><br>There are no doubt plenty of other caveats with threading - one of the things I was *hopefully* clear about when adding threads to bmx was that I was not gonna even attempt to handle all these issues, although I am happy to fix things on a one-by-one basis as people find them.<br><br>I suggest you google for OpenGL threading, although it's probably not a pretty situation. <br><br></td></tr></table><br>
<a name="1022374"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >marksibly</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#7">[#7]</a></td></tr></table></td></tr><tr ><td class="posttext"> <a href="http://hacksoflife.blogspot.com/2008/02/creating-opengl-objects-in-second.html" target="_blank">http://hacksoflife.blogspot.com/2008/02/creating-opengl-objects-in-second.html</a> <br><br></td></tr></table><br>
<a name="1022396"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rozek</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#8">[#8]</a></td></tr></table></td></tr><tr ><td class="posttext"> Good morning!<br><br>Thanks for all your contributions!<br><br>Would it be safe to say:<br><br>- BlitzMAX internal (i.e. non-system) functions are all thread-safe<br>- system calls may not be thread-safe<br><br>Thread-safe are<br> - BASIC compatibility<br> - BlitzMAX runtime<br> - Reflection<br> - Lists and Maps<br> - Math<br> - Banks?<br> - ZLib compression<br> - Networking (hopefully)<br> - Lua<br> - Streams?<br> - File System<br> - Standard IO<br> - Thread Synchronization, of course<br> - perhaps Joystick?<br>Can somebody (Mark?) please check and/or modify this list?<br><br>Inherently unsafe are<br> - Audio?<br> - Graphics<br> - MaxGUI<br> - System module<br> - Polled Input<br><br>Could postEvent be made thread-safe (postevent from any thread, waitevent/peekevent/pollevent etc. only in main thread - this would prevent people like me from having to implement an additional event queue besides the built-in one for those events which are sent from other threads)? (because auf EventHooks this might mean, that enqueuing a new event and invoking all event hooks might have to be separated)<br><br>Multi-threading is such a powerful tool (especially on multi-core systems) that we should come up with more precise information as soon as possible! Personally, I would not worry too much about a list of thread-safe packages which is "conservative", i.e. which excludes functions which *might* be thread-safe but are not *definitely* known to be so - because it's more important to know, which packages are *definitely* thread-safe ON ALL PLATFORMS (as you can't have multiple program designs for several platforms) <br><br></td></tr></table><br>
<a name="1022660"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >ima747</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#9">[#9]</a></td></tr></table></td></tr><tr ><td class="posttext"> EmitEvent is not safe to call from child threads? I very much second the request for a list of safe/unsafe elements. I've had no problems emitting events from a child thread so far, but maybe that's just luck... at one point due to a typo I was even reading events on 2 threads at once and it didn't crash, however it did spew a huge list of warnings regarding draining the event pool... <br><br></td></tr></table><br>
<a name="1022788"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rozek</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#10">[#10]</a></td></tr></table></td></tr><tr ><td class="posttext"> Yes,<br><br>Mark himself told us so (see <a href="http://www.blitzmax.com/Community/posts.php?topic=88828#1022023)" target="_blank">http://www.blitzmax.com/Community/posts.php?topic=88828#1022023)</a> that's why I had to implement my own queueing sysem in order to let subthreads send events to the main thread (which does the MaxGUI stuff). While queueing itself is simple, (non-busy) waiting for both a system event AND a semaphore seems to be impossible in a general context (in *my* special application, I have a 30Hz timer anyway and, thus, I use that to periodically check the contents of my own event queue) <br><br></td></tr></table><br>
<a name="1022815"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >ima747</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#11">[#11]</a></td></tr></table></td></tr><tr ><td class="posttext"> Interesting, I've been spawning events from a child thread without problem so far, however my event que is pretty weird and the events from the child are just requests for canvas refreshes when nothing else is happening so if they are ignored for a while it's not really noticeable... but I'm probably getting lucky on my posting times according to that thread.<br><br>Welp, time to make a second que. <br><br></td></tr></table><br>
<a name="1022914"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rozek</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#12">[#12]</a></td></tr></table></td></tr><tr ><td class="posttext"> As Mark said,<br><br>"postEvent" is *almost* thread-safe - but that's common in the area of multi-threading: even an unsafe solution might work most of the time! And THAT is the basic problem: you may think to be on the safe side, but experience "strange" side-effects from time to time which are difficult to isolate.<br><br>For that reason: be *very* careful when it comes to MT and reduce inter-thread communicatoin to a minimum! <br><br></td></tr></table><br>
<a name="bottom"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td align="right"><a href="http://monkeycoder.co.nz" target="_blank"><img src="/img/monkey2.svg" ></a> <a href="https://github.com/blitz-research" target="_blank"><img src="/img/github.svg" ></a> <a href="https://discord.gg/qJccbSp" target="_blank"><img src="/img/discord.svg" ></a></td></tr></table><br></div><br><table width="100%"><tr><td></body></html lang="en">
