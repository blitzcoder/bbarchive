<!DOCTYPE html><html lang="en" ><head ><title >String Memory Management</title><meta name='viewport' content='width=device-width, initial-scale=0.66'><meta name='description' content='language:basic, target:desktop, category:game development'><link rel="styleSheet" href="../skins/granite/style.css" type="text/css"><style type="text/css">div.bbcode {padding: 8px;background: #E5E5E5;color: #000000;border: 1px dashed #B4B4BE;}</style></head><body ><table width=100% cellspacing=0 cellpadding=0><tr ><td class="menubarleft"></td><td class="menubar"><table cellspacing="0" cellpadding="0"><tr ><td >&nbsp;</td><td class="menuitemleft"></td><td class="menuitem"><a href="/" class="menuitem">News</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/forums.php" class="menuitem">Forums</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/codearcs.php" class="menuitem">Code</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/logs.php" class="menuitem">Logs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/gallery.php" class="menuitem">Gallery</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/sdkspecs.php" class="menuitem">Specs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/search.php" class="menuitem">Search</a></td><td class="menuitemright"></td></tr></table></td><td class="menubarright"></td></tr></table><div class="main"><h1 >String Memory Management</h1><a href="forums.php" >BlitzMax Forums</a>/<a href="topics.php?forum=102" >BlitzMax Programming</a>/<a href="#bottom" >String Memory Management</a><br><br>
<a name="1105140"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >jtfrench</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#1">[#1]</a></td></tr></table></td></tr><tr ><td class="posttext"> Hi Blitzers,<br><br>We're trying to track down some memory allocation/leak related issues in our game. It looks as though over the runtime of our app, we're generating over 800MB of string data (we make a lot of HTTP requests, caching the responses in strings).<br><br>Aside from nulling out appropriate fields and making sure GCCollect() gets called, is there anything special I should know about managing string memory in BlitzMax? I took a peek at blitz_string.c and I noticed something rather peculiar:<br><br><pre class=code>
//***** Note: Not called in THREADED mode.
static void bbStringFree( BBObject *o ){
#ifdef BB_GC_RC
	BBString *str=(BBString*)o;
	if( str==&amp;bbEmptyString ){
		str-&gt;refs=BBGC_MANYREFS;
		return;
	}
	bbGCDeallocObject( str,sizeof(BBString)+str-&gt;length*sizeof(BBChar) );
#endif
}
</pre><br><br>Does this mean that BlitzMax strings will not get freed if running in Threaded mode? (note: our app is threaded :) )<br><br>If this is the case, how can you explicitly ensure the free-ing of a string?<br><br>Thanks folks,<br>Jason <br><br></td></tr></table><br>
<a name="1105249"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >col</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#2">[#2]</a></td></tr></table></td></tr><tr ><td class="posttext"> Only one thing initially springs to my mind is : are you using 'String.ToCString()' anywhere at all?? That requires a call MemFree to free the memory assigned to the variable once you're finished with it. It's not needed using 'standard' Blitz strings though. <br><br></td></tr></table><br>
<a name="1105257"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >jtfrench</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#3">[#3]</a></td></tr></table></td></tr><tr ><td class="posttext"> Hi Dave,<br><br>I'm actually not using String.ToCString() at all. Just regular old strings. I store them in a map, then I ClearMap() and null out the map. I'm not sure if they ever truly get freed though. That exception in the C code snippet I showed above worries me. I ran a memory profiler on my app (Instruments, part of Apple Developer Tools), and it says my #1 source of memory allocations (that aren't freed) are from strings.<br><br>In particular, it cites this stack flow:<br><br><pre class=code>
malloc
heapAlloc
allocMem
bbGCAllocObject
bbStringNew
</pre><br><br>Can anyone confirm that despite the comments in bbStringFree, that Strings will still be automatically garbage collected if nulled out prior to a call to GCCollect()?<br><br>Thanks,<br>Jason <br><br></td></tr></table><br>
<a name="1105258"></a>

<a name="1105259"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Czar Flavius</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#4">[#4]</a></td></tr></table></td></tr><tr ><td class="posttext"> Maybe - this is just a shot in the dark - when a string is freed, Blitz actually keeps the memory lying around in a reserve pool, to reuse for the next string?<br><br>Maybe you are referencing the strings in more than one place? If you assign a string variable, I don't know if it makes a copy, or if it references the original only, and only copies it if you make a change. So you could have the strings still referenced somewhere, even if the map is cleared out.<br><br>In the same map, don't mix strings and non-strings in the keys or strings and non-strings in the values.<br><br>Does this happen in non-threaded?<br><br>Somebody offical will have to answer this I think. You could try sending a customer support message. They usually reply within a day or two.<br><br>We should try to make a simple program that reproduces this error, adding lots of strings to a map in threaded mode and then clearing the map and seeing what happens.<br><br><font class="tiny">Last edited 2011</font> <br><br></td></tr></table><br>
<a name="1105275"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >col</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#5">[#5]</a></td></tr></table></td></tr><tr ><td class="posttext"> Definitely sounds like something is holding a reference somewhere. I agree with Czar Flavius in that a little test app that does exactly the same as you are doing in your code to use as a 'test bench' is needed here. Then we can hone in on the problem. <br><br></td></tr></table><br>
<a name="1144022"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >void</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#6">[#6]</a></td></tr></table></td></tr><tr ><td class="posttext"> Does the problem solved? <br><br></td></tr></table><br>
<a name="bottom"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td align="right"><a href="http://monkeycoder.co.nz" target="_blank"><img src="/img/monkey2.svg" ></a> <a href="https://github.com/blitz-research" target="_blank"><img src="/img/github.svg" ></a> <a href="https://discord.gg/qJccbSp" target="_blank"><img src="/img/discord.svg" ></a></td></tr></table><br></div><br><table width="100%"><tr><td></body></html lang="en">
