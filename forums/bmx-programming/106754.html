<!DOCTYPE html><html lang="en" ><head ><title >Appdata and foreign characters?</title><meta name='viewport' content='width=device-width, initial-scale=0.66'><meta name='description' content='language:basic, target:desktop, category:game development'><link rel="styleSheet" href="../skins/granite/style.css" type="text/css"><style type="text/css">div.bbcode {padding: 8px;background: #E5E5E5;color: #000000;border: 1px dashed #B4B4BE;}</style></head><body ><table width=100% cellspacing=0 cellpadding=0><tr ><td class="menubarleft"></td><td class="menubar"><table cellspacing="0" cellpadding="0"><tr ><td >&nbsp;</td><td class="menuitemleft"></td><td class="menuitem"><a href="/" class="menuitem">News</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/forums.php" class="menuitem">Forums</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/codearcs.php" class="menuitem">Code</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/logs.php" class="menuitem">Logs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/gallery.php" class="menuitem">Gallery</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/sdkspecs.php" class="menuitem">Specs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/search.php" class="menuitem">Search</a></td><td class="menuitemright"></td></tr></table></td><td class="menubarright"></td></tr></table><div class="main"><h1 >Appdata and foreign characters?</h1><a href="forums.php" >BlitzMax Forums</a>/<a href="topics.php?forum=102" >BlitzMax Programming</a>/<a href="#bottom" >Appdata and foreign characters?</a><br><br>
<a name="1316066"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Robby</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#1">[#1]</a></td></tr></table></td></tr><tr ><td class="posttext"> A quick question about a function to locate the users appdata folder.<br>I've had this run perfectly on many user's PC's, until a Polish friend of<br>mine apparently got caught in an infinite loop where the function is being called. The only difference is his name under \users is Michal, but the "l" is a stylized one with a line through it, much like a German Z is sometimes written.<br>Is this an issue with Windows? Here's the code, which elsewhere works fine:<br><br>' gets appdata folder in files_path, ex.<br>c:\users\robby\appdata\roaming<br><br>Const CSIDL_APPDATA = $1a<br>Const CSIDL_COMMON_APPDATA = $23<br>Global appdata_path_ptr:Byte Ptr<br>Global files_path:String<br><br><br>Extern "win32"<br>	Function SHGetFolderPathA(hWnd:Int, folder:Int, token:Int, FLAGS:Int, str:Byte Ptr)<br>End Extern<br><br>GetAppDataFolder()<br><br>' we will use this with just \madman to test shortly - putting here so no \\ double stuff<br>files_path_test = files_path<br><br>' append my madman_data directory to it. \\ needed to make, but will be just \ in actual folder<br>files_path = files_path + "\\madman_data\\"<br><br>'append the "test if exists" one with the real dir, \madman_data<br>files_path_test = files_path_test + "\madman_data"<br><br><br>' If the folder does not exist, make it - we test with \madman_data but must create with \\madman_data\\<br>If FileType(files_path_test) = 0 Then ' to test, must have the \madman_data one<br>  CreateDir(files_path) ' to create, must have the \\madman_data\\ one<br>End If<br><br>' wether created or already there, set files_path to final form to use globally on all file I\O, \ appended for ease of use<br>files_path = files_path_test + "\"<br><br>(main program here)<br><br>Function GetAppDataFolder()<br>        Local res, dir, cnt<br><br>	appdata_path_ptr = New Byte[260]<br>	res = SHGetFolderPathA(Null, CSIDL_APPDATA, Null, 1,appdata_path_ptr)<br><br>	cnt = 0<br>	While (appdata_path_ptr[cnt] &lt;&gt; 0)<br>	  cnt :+ 1<br>	Wend<br>        files_path = String.FromBytes(appdata_path_ptr, cnt)<br>EndFunction <br><br></td></tr></table><br>
<a name="1316067"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >xlsior</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#2">[#2]</a></td></tr></table></td></tr><tr ><td class="posttext"> It could be that it can't handle unicode...<br><br>IIRC bah.volumes can retrieve those folder names if they contain unusual characters. <br><br></td></tr></table><br>
<a name="1316080"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Brucey</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#3">[#3]</a></td></tr></table></td></tr><tr ><td class="posttext"> The "A" in SHGetFolderPathA is your problem. <br><br></td></tr></table><br>
<a name="1316165"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Robby</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#4">[#4]</a></td></tr></table></td></tr><tr ><td class="posttext"> I'm curious how the A would affect it? I checked on the msdn site and it seems that SHGetFolderPath has been depreciated, replaced by the newer SHGetKnownFolderPath. Not sure if that would make a difference, but does anyone know how this function would be implemented to get the correct AppData folder?<br>The API can be a bit dizzying!  Thanks,  -Rob <br><br></td></tr></table><br>
<a name="1316168"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Brucey</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#5">[#5]</a></td></tr></table></td></tr><tr ><td class="posttext"> "A" is presumably for ASCII, and "W" for Wide? <br><br>Where Wide supports Unicode characters.<br><br>As xlsior points out, BaH.Volumes handles unicode paths on all platforms. <br><br></td></tr></table><br>
<a name="1316209"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Robby</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#6">[#6]</a></td></tr></table></td></tr><tr ><td class="posttext"> The guy's actual path is:<br><br>C:\Users\Micha&amp;#322;\Appdata\Roaming<br><br>But my variable assignment is truncating the stylized L to:<br><br>C:\Users\Micha\Appdata\Roaming<br><br>I see that I can copy &amp; paste this all over windows, even in the boards here, so windows, etc. seems to know the character.<br><br>Then I logged in a new account on my notebook, using Micha&amp;#322; and sure enough I was able to get the same error.<br><br>The path string returns with the "L" chopped off.<br><br>Since this is not the actual path, madman is trying to append madman_data to a non-existant folder, which it thinks<br>is  Micha. This would explain why it keeps running but doesn't actually crash out.<br><br>So it would seem that Blitzmax isn't seeing the character, or the function isn't.<br><br>The function I'm now using is this one. Its finding the path in the section I marked "Found in W"<br><br>The key here is that the truncation is occurring at:<br>result = String.FromWString( Short Ptr( LockBank( tempBank ) ) )<br><br>result returns with the "Micha" and the Polish small L gone.<br><br>Also, do you know the meaning of the ?Win32 and the other hanging ? near the end? I found this elsewhere on the Blitz boards.  <br><br>Also, are there any examples anywhere about how to get and use a Brucey<br>module to get the appdata folder?  -Rob<br><br><br>Function SHGetFolderPath:String( nFolder:Int, dwFlags:Int )<br><br>?Win32<br>    Local tempBank:TBank<br>    Local success:Byte = False<br>   <br>    If _bbusew Then<br>        tempBank = CreateBank( MAX_PATH * 2 ) 'WCHAR<br>        success = SHGetFolderPathW( 0, nFolder, 0, dwFlags, LockBank( tempBank ) ) = S_OK<br>        backfrom = "Found in W"<br>    Else<br>        tempBank = CreateBank( MAX_PATH )<br>        success = SHGetFolderPathA( 0, nFolder, 0, dwFlags, LockBank( tempBank ) ) = S_OK<br>        backfrom = "Found in A"<br>    EndIf   <br>    UnlockBank( tempBank )<br>   <br>    If success Then<br>        Local result:String<br><br>        If _bbusew Then<br>            result = String.FromWString( Short Ptr( LockBank( tempBank ) ) )<br>        Else<br>            result = String.FromCString( LockBank( tempBank ) )<br>        EndIf<br>       <br>        UnlockBank( tempBank )<br>        Return result<br>    EndIf<br>?<br>    Return Null 'Check for a Null result to identify errors.<br>   <br>End Function <br><br></td></tr></table><br>
<a name="1316221"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >xlsior</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#7">[#7]</a></td></tr></table></td></tr><tr ><td class="posttext"> As mentioned above, the path contains a unicode character that's getting stripped. There are two workarounds posted above to keep that from happening. <br><br></td></tr></table><br>
<a name="1316222"></a>

<a name="1316223"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Brucey</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#8">[#8]</a></td></tr></table></td></tr><tr ><td class="posttext"> Here's an example of BaH.Volumes GetUserAppDir() :<br><pre class=code>
SuperStrict

Import BaH.Volumes

Notify GetUserAppDir()
</pre><br>Notify displays the string in a message box. You can "Print" the text, but MaxIDE's output window doesn't display the text correctly, even though it is correct within the String.<br><br>Here is the output :<br><img src="http://brucey.net/programming/blitz/misc/screenshots/bah_volumes_unicode_example.png"><br><br><br>&lt;uninteresting side note&gt;<br>GCC, funnily enough, refused to build anything under that username, as the Temp path it wanted, had the user name as "Michal" (normal ASCII lowercase "L"), which of course did not exist. Creating the temp dir with suitable access allowed GCC to compile...<br>So even big tools have issues with unicode usernames... pah.<br>&lt;/end&gt; <br><br></td></tr></table><br>
<a name="1316337"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Robby</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#9">[#9]</a></td></tr></table></td></tr><tr ><td class="posttext"> Thanks for all the info, guys. I must admit I'm a little confused with a few things.<br><br>For example, clicking some of the links seems to go to several places, which list a lot of modules. Which one do I download?<br><br>Implementing or importing it seems different - I checked a few other board posts about appdata. For example one has:<br>SuperStrict<br>Framework BaH.Volumes<br>Import BRL.Standardio<br><br>Another has:<br>SuperStrict<br>Import BaH.Volumes   before the GetUserAppDir() can be used.<br><br>Brucey mentioned that "A" is presumably for ASCII, and "W" for Wide? <br>Where Wide supports Unicode characters.<br><br>I put the backfrom = "Found in W" and backfrom = "Found in A" to check which form was getting the path, and it does indeed find it in W, but Michal's name is still getting the Polish L truncated.<br><br>You can see on the post where I pasted the name, the L turned into the odd &amp;@233;<br><br>So while these functions usually find the path, yet various foreign characters see to get muffed. There may be other users with foreign letters in their names, Germans with a crossed Z and the like.<br><br>My friend uses these same functions in C, but it appears a C String assigns better than a Blitz string. Maybe Blitz strings can only use ASCII chars?<br><br>Anyone ever solve this? <br><br></td></tr></table><br>
<a name="1316389"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Robby</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#10">[#10]</a></td></tr></table></td></tr><tr ><td class="posttext"> Oh! I must be getting absent-minded! I missed the part about displaying the text!<br>All I had to do was change my SHGetFolderPathA function to the SHGetFolderPathW and it worked!<br><br>It is indeed finding the path! Even saved and read back a few variables to test.<br><br>You guys really saved me here! My game, Madman, was recently greenlit on Steam. More than 5 years of work. But my bank was going through a merger so I didn't put it up on Steam right away. If I released it with that A function???<br><br>Saved me a lot of grief, guys! Can't thank you all, especially our Brucey, enough!<br><br>Also - Brucey - I looked through your many modules and commend you on your excellence. As a programmer since the TRS-80 days, I'm sure I can make use of your modules in the future.   -Rob,  aka "Dr. Dungeon" <br><br></td></tr></table><br>
<a name="1316390"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Robby</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#11">[#11]</a></td></tr></table></td></tr><tr ><td class="posttext"> That's here if anyone wants to see:<br><a href="http://steamcommunity.com/sharedfiles/filedetails/?id=457828980" target="_blank">http://steamcommunity.com/sharedfiles/filedetails/?id=457828980</a> <br><br></td></tr></table><br>
<a name="bottom"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td align="right"><a href="http://monkeycoder.co.nz" target="_blank"><img src="/img/monkey2.svg" ></a> <a href="https://github.com/blitz-research" target="_blank"><img src="/img/github.svg" ></a> <a href="https://discord.gg/qJccbSp" target="_blank"><img src="/img/discord.svg" ></a></td></tr></table><br></div><br><table width="100%"><tr><td></body></html lang="en">
