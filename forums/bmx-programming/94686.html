<!DOCTYPE html><html lang="en" ><head ><title >About Multithreading and thread safe code</title><meta name='viewport' content='width=device-width, initial-scale=0.66'><meta name='description' content='language:basic, target:desktop, category:game development'><link rel="styleSheet" href="../skins/granite/style.css" type="text/css"><style type="text/css">div.bbcode {padding: 8px;background: #E5E5E5;color: #000000;border: 1px dashed #B4B4BE;}</style></head><body ><table width=100% cellspacing=0 cellpadding=0><tr ><td class="menubarleft"></td><td class="menubar"><table cellspacing="0" cellpadding="0"><tr ><td >&nbsp;</td><td class="menuitemleft"></td><td class="menuitem"><a href="/" class="menuitem">News</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/forums.php" class="menuitem">Forums</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/codearcs.php" class="menuitem">Code</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/logs.php" class="menuitem">Logs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/gallery.php" class="menuitem">Gallery</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/sdkspecs.php" class="menuitem">Specs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/search.php" class="menuitem">Search</a></td><td class="menuitemright"></td></tr></table></td><td class="menubarright"></td></tr></table><div class="main"><h1 >About Multithreading and thread safe code</h1><a href="forums.php" >BlitzMax Forums</a>/<a href="topics.php?forum=102" >BlitzMax Programming</a>/<a href="#bottom" >About Multithreading and thread safe code</a><br><br>
<a name="1087166"></a>

<a name="1087167"></a>

<a name="1087168"></a>

<a name="1087169"></a>

<a name="1087170"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >-Phoenix-</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#1">[#1]</a></td></tr></table></td></tr><tr ><td class="posttext"> Hello,<br>I've been working with blitzmax for a while and already wrote a share of multithreaded applications.<br><br>However a while ago I wanted to test what would happen if I let multiple threads access the same field of a type at the same time<br><br>I heard a lot about Deadlocking, Runtime errors caused by that, so I always used mutexes on global access variables.<br><br>But I was surprised that (on my quad core) when I had 20 threads running at same time without mutex/semaphore, increasing the same global variable by +1 as fast as possible, and even after letting it run for 10 minutes there was no crash.<br><br>However, I added a piece of code to let the threads report their value of the global variable each time they add 500.000 to it.<br><br>So logically it should display an ever increasing number, but it did not. Some threads reported a value lower than the previous thread, even though they reported later in time than the previous thread.<br>It was a long, there was no loop through reaching max value of the variable, it didn't even get close to the maximum value<br><br>So can I assume that blitzmax makes an internal copy of a global when it's accessed at the same time, to allow both having access without causing trouble?<br><br>Or is crashing through simultanious access really that hard to achieve? (CPU usage was 100%, means all cores were being used)<br><br><font class="tiny">Last edited 2011</font> <br><br></td></tr></table><br>
<a name="1087171"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >BladeRunner</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#2">[#2]</a></td></tr></table></td></tr><tr ><td class="posttext"> I think it would be easier for us to follow with your code posted here. Maybe the problem lies in this piece of code. <br><br></td></tr></table><br>
<a name="1087173"></a>

<a name="1087174"></a>

<a name="1087175"></a>

<a name="1087180"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >-Phoenix-</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#3">[#3]</a></td></tr></table></td></tr><tr ><td class="posttext"> Here's the code :<br><br>Strict<br><br>Type MyType<br><br>Field MyField:Long<br><br>End Type<br><br>Global Handle:MyType=New MyType<br><br>Function MyThread:Object( data:Object )<br>	Local Number<br>	Local ID=Rand(1000,9999)<br>	Repeat<br>	Number:+1<br>	If Number=500000<br>		Print "ID:"+ID+"="+Handle.MyField<br>		Number=0<br>	EndIf<br>	Handle.MyField:+1		<br>	Forever<br>	<br>End Function<br><br>For Local x=0 To 19<br>	CreateThread( MyThread,Null )<br>Next<br><br>Repeat<br>Handle.MyField:+1<br>Forever<br><br><br>Remember to put debug mode OFF<br><br>it might be hard to spot but here's an example of what I meant above :<br>Output :<br>[..]<br>ID:9924=54470329<br>ID:3485=55508678<br>ID:3485=55999886<br>ID:1778=55999345 &lt;-- here, lower than the above!<br>ID:1778=56541196<br>ID:1189=56995827<br>[..]<br><br><font class="tiny">Last edited 2011</font> <br><br></td></tr></table><br>
<a name="1087197"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Czar Flavius</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#4">[#4]</a></td></tr></table></td></tr><tr ><td class="posttext"> You can put your code in [ code ] [ /code ] boxes to make it easier to read.<br><br>Two threads accessing the same variable doesn't mean an automatic crash, it just means the variable will change in a no longer predictable manner. <br><br></td></tr></table><br>
<a name="1087198"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >-Phoenix-</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#5">[#5]</a></td></tr></table></td></tr><tr ><td class="posttext"> So you mean that simultaneous access itself cannot cause any crash? You just have to make sure that unpredictable changes don't make something happen that leads to a crash? <br><br></td></tr></table><br>
<a name="1087200"></a>

<a name="1087201"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Czar Flavius</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#6">[#6]</a></td></tr></table></td></tr><tr ><td class="posttext"> Yes.<br><br>Say you have a global variable to count the number of times you've completed an action, and the program exits when this reaches a certain number. A thread reads this value and increases it by 1. Two threads read the value at the same time and it is value 8. The first thread then writes 8+1=9. The second thread, which read at the same time, then writes 8+1=9. So the count variable is 9 even though two actions were performed and should be 10. This means in theory with two threads, you could perform twice as many actions as you wanted to.<br><br>At best, the program will just waste some time re-doing redundant actions, defeating the point of using two threads. Perhaps the program will exit cleanly but the end result is incorrect because the threads messed with each other's actions. At worst, the program could run out of resources by doing more actions than expected and crash.<br><br>This is why you use mutexes on resources and variables shared between threads. The two threads read at the same time. However, the mutex picks one to go first. This reads 8 and writes 8+1=9. Now the mutex lets the second thread have a go. It reads 9 and writes 9+1=10. There is a bit of a delay as the second thread is waiting for the first thread to finish with the variable, but then both threads can do their work on actions 8 and 9 respectively and simultaneously.<br><br><font class="tiny">Last edited 2011</font> <br><br></td></tr></table><br>
<a name="1087243"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Kryzon</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#7">[#7]</a></td></tr></table></td></tr><tr ><td class="posttext"> Nice explanation, thanks. <br><br></td></tr></table><br>
<a name="bottom"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td align="right"><a href="http://monkeycoder.co.nz" target="_blank"><img src="/img/monkey2.svg" ></a> <a href="https://github.com/blitz-research" target="_blank"><img src="/img/github.svg" ></a> <a href="https://discord.gg/qJccbSp" target="_blank"><img src="/img/discord.svg" ></a></td></tr></table><br></div><br><table width="100%"><tr><td></body></html lang="en">
