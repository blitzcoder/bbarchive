<!DOCTYPE html><html lang="en" ><head ><title >Cower.PhysFS - Abstract filesystem access</title><meta name='viewport' content='width=device-width, initial-scale=0.66'><meta name='description' content='language:basic, target:desktop, category:game development'><link rel="styleSheet" href="../skins/granite/style.css" type="text/css"><style type="text/css">div.bbcode {padding: 8px;background: #E5E5E5;color: #000000;border: 1px dashed #B4B4BE;}</style></head><body ><table width=100% cellspacing=0 cellpadding=0><tr ><td class="menubarleft"></td><td class="menubar"><table cellspacing="0" cellpadding="0"><tr ><td >&nbsp;</td><td class="menuitemleft"></td><td class="menuitem"><a href="/" class="menuitem">News</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/forums.php" class="menuitem">Forums</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/codearcs.php" class="menuitem">Code</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/logs.php" class="menuitem">Logs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/gallery.php" class="menuitem">Gallery</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/sdkspecs.php" class="menuitem">Specs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/search.php" class="menuitem">Search</a></td><td class="menuitemright"></td></tr></table></td><td class="menubarright"></td></tr></table><div class="main"><h1 >Cower.PhysFS - Abstract filesystem access</h1><a href="forums.php" >BlitzMax Forums</a>/<a href="topics.php?forum=102" >BlitzMax Programming</a>/<a href="#bottom" >Cower.PhysFS - Abstract filesystem access</a><br><br>
<a name="773469"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >N</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#1">[#1]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> PhysicsFS is a library to provide abstract access to various archives. It is intended for use in video games, and the design was somewhat inspired by Quake 3's file subsystem. The programmer defines a "write directory" on the physical filesystem. No file writing done through the PhysicsFS API can leave that write directory, for security. For example, an embedded scripting language cannot write outside of this path if it uses PhysFS for all of its I/O, which means that untrusted scripts can run more safely. <br></div><br><br>If that doesn't make sense, I'll explain it this way: with PhysFS, any filesystem access your application has is likely going to be reasonably safer with write-access limited to the directory you specify.  In addition to that, you can also access archives, such as ZIP (e.g., PK3 and PK4), Quake 1 PAK files, WAD files, 7zip files, and a few others.<br><br>If you've ever worked with the Quake 3 engine, you're probably already familiar with this idea.  Personally, I love this sort of system, and think it's a great thing to use.  I've written a couple of these myself, but honestly none of them ever reached the level of quality I've seen in PhysicsFS.<br><br>If you don't know who this is for, it can pretty much be used by anyone who accesses files in their software.  Provided you don't need or want to access files outside of your game's directory (if you do, I'm never downloading your game.. scary) and you want an easy way to add support for archives (they're great for patching game code, by the way), then you can probably make use of this.<br><br>At the moment, only the raw API is provided, so you'll want to refer to the documentation on their site (can get there from the link below the download).  I'll be working on a wrapper module, but that's going to take some time.  In the meantime, you can mess with this.<br><br>Also, it should be 100% cross-platform.  Can't guarantee it, but the code is there.<br><br><b><a href="http://www.spifftastic.net/qc.php?mod/cower.physfs.zip" target="_blank">DOWNLOAD</a></b><br><br>Anyway, if you don't know whether or not to use it, you can always head over to <a href="http://icculus.org/physfs/" target="_blank">their site</a>. <br><br></td></tr></table><br>
<a name="773473"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >assari</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#2">[#2]</a></td></tr></table></td></tr><tr ><td class="posttext"> Thanks Noel, this look useful.<br>Anyhow, good to have you back. <br><br></td></tr></table><br>
<a name="774473"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >N</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#3">[#3]</a></td></tr></table></td></tr><tr ><td class="posttext"> <b>UPDATE</b><br><br>I've updated the archive to include some fixes to the original module as well as including [b]Cower.PhysWrap[b/].<br><br>PhysWrap is, as the name suggests, a wrapper for PhysFS that provides easier use.  Basically, it adds some functions and stream support via OpenStream using the pfs:: protocol (like incbin:: as mentioned in the documentation).<br><br>The code is documented, although you'll have to run docmods/whatever it is in the IDE I think to get it to be included in the documentation.  It should more or less explain the few things you have to do in order to get it working.<br><br>If anyone has any questions, I'll try to address them, add code, fix bugs, make changes, clarify documentation, etc. as necessary.<br><br>The archive now includes these changes and if you're interested in using the module, you should download it.  Shouldn't require any changes in code if you've already started using it. <br><br></td></tr></table><br>
<a name="775019"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >JoshK</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#4">[#4]</a></td></tr></table></td></tr><tr ><td class="posttext"> This looks pretty good, but I can't tell how to use it:<br><br>Import cower.physwrap<br>Import cower.physfs<br><br>InitPhysFS()<br><br>RegisterSearchPath AppDir<br><br>Local arr$[]<br>arr=GlobPhysFSFiles(AppDir,"*")<br><br>For s$=EachIn arr<br>	Notify s<br>Next <br><br></td></tr></table><br>
<a name="775021"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >N</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#5">[#5]</a></td></tr></table></td></tr><tr ><td class="posttext"> Do you have a more, em, specific question? <br><br></td></tr></table><br>
<a name="775024"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >JoshK</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#6">[#6]</a></td></tr></table></td></tr><tr ><td class="posttext"> What do you use for a wildcard?  It just crashes if I give it anything other than "*".<br><br>I got it to list files in a directory, but it doesn't seem to recognize zip files.<br><br>A simple example with a zip file would be great. <br><br></td></tr></table><br>
<a name="775031"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >N</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#7">[#7]</a></td></tr></table></td></tr><tr ><td class="posttext"> First off.. <b>UPDATE</b><br><br>There was a bug in GlobPhysFSFiles, that's been fixed.  General issue with dealing with memory.<br><br>Now:<br>When you register AppDir, its contents are added to the root ('/') directory of the PhysFS filesystem.  So, it would work like this:<br><br><pre class=code>Strict

Import Cower.PhysFS
Import Cower.PhysWrap

InitPhysFS()
RegisterSearchPath(AppDir)

Local arr$[]
arr = GlobPhysFSFiles("/", "*.bmx") ' &lt;- Gets the contents of AppDir

For Local i$ = EachIn arr
    Print i
Next

KillPhysFS()

Input()</pre><br><br>As for zip files, you just call RegisterSearchPath("c:\path\to\your.zip").  Of course, it doesn't have to be an absolute path.<br><br>If you want to list all the files though, calling Glob is unnecessary as passing a wildcard of * is going to make it call ListPhysFSFiles instead (only takes a directory, and thus lists all the files -- doesn't work the same). <br><br></td></tr></table><br>
<a name="775032"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >JoshK</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#8">[#8]</a></td></tr></table></td></tr><tr ><td class="posttext"> Thanks, it is working now.  This is pretty sweet.  I love the q3a and Unreal packages, they are very nice to work with (unless you have to write a UPackage reader). <br><br></td></tr></table><br>
<a name="775033"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >N</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#9">[#9]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> Hmmm...it only seems to be able to read zip files that have no internal directory structure.  <br></div><br><br>Got any way to test this? <br><br></td></tr></table><br>
<a name="775035"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >JoshK</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#10">[#10]</a></td></tr></table></td></tr><tr ><td class="posttext"> No, I was wrong.  It is workign in a simple test.  Still trying to figure it out, this stuff is a little different from what I normally deal with. <br><br></td></tr></table><br>
<a name="775036"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >JoshK</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#11">[#11]</a></td></tr></table></td></tr><tr ><td class="posttext"> Hmmm, your code above crashes when not in debug mode. <br><br></td></tr></table><br>
<a name="775037"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >N</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#12">[#12]</a></td></tr></table></td></tr><tr ><td class="posttext"> Unusual.  Will look into it, but I'm not promising anything soon. <br><br></td></tr></table><br>
<a name="775171"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >N</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#13">[#13]</a></td></tr></table></td></tr><tr ><td class="posttext"> Well, the issue is with the globbing extension.  I'll just rip out my old globbing code from Indigo and add it into this, at least then it'll be fine. <br><br></td></tr></table><br>
<a name="775191"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >N</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#14">[#14]</a></td></tr></table></td></tr><tr ><td class="posttext"> Well, now it's blowing up on the normal file enumeration.  Odd. <br><br></td></tr></table><br>
<a name="775938"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >N</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#15">[#15]</a></td></tr></table></td></tr><tr ><td class="posttext"> <b>UPDATE</b><br><br>Alright, everything should be fixed now.  The error, somehow or other, was caused by PhysFS being called inside of an Assert during runtime.  Now <i>why</i> an Assert would cause PhysFS to flip out and do something odd, or why BlitzMax would do something odd -- bit hard to debug something in release mode, so I can't pinpoint it any better than that it was a problem with Assert being used -- but the problem has been fixed from what I can see.<br><br>I've tested it in pretty much every situation I could find it being used in, and thus far I haven't had any problems.<br><br>Changes:<br>* Cower.PhysWrap no longer crashes when in release mode.  Something to do with using Assert.  I don't know what's wrong there and I can't really say if it's BlitzMax or PhysFS, so I'm at a loss here as to whose side this potential bug is on.  (Hell, I can't even confirm if it is a big.)<br>* The <i>caseSensitive</i> argument has been added to the glob search, but will not affect code as it defaults to the state it was in before I added it (not case sensitive).<br>* A new exception, TPhysFSException, was added to the wrapper to make up for not using Assert.<br>* Added the PHYSFS_Allocator type to Cower.PhysFS.  This is only useful if you want to write custom memory management code for PhysFS.  If you don't, don't bother reading the remaining text.<br>* Code for an allocator was added to the wrapper source code.  While fairly pointless, and commented out at the moment, it should give you a good idea of how to use the setAllocator function if you find yourself needing really customized memory management.<br><br>Since BMax and PhysFS both default to using malloc, there isn't much of an issue with memory anyway.  I suppose if I was so inclined, I could attempt to hook PhysFS up to the BMax garbage collector, but that would be messy and completely unnecessary. <br><br></td></tr></table><br>
<a name="777919"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >N</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#16">[#16]</a></td></tr></table></td></tr><tr ><td class="posttext"> <b>UPDATE</b><br><br>I've uploaded a new archive, this time 64-bit support is removed from PhysFS until I can find out why it's crashing.  If I do, I'll have to then clear it with the folks making PhysFS and see what they think about it and work on getting the changes put into the official codebase if necessary (having to apply my own changes each update isn't something I fancy doing -- there are small changes I make to the code, but large fixes/changes would not be good).<br><br>This should not break anyone's code as I highly doubt anyone here uses files larger than 2gb in their game.  If you do, sorry, but this is the best I can offer you at the moment.<br><br>(Also, I'm pretty sure support for files larger than 2gb was already off-limits in BlitzMax regularly, so probably even less of a loss there.) <br><br></td></tr></table><br>
<a name="777948"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >marksibly</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#17">[#17]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> <br>Cower.PhysWrap no longer crashes when in release mode. Something to do with using Assert.<br> <br></div><br>Make sure the asserts don't contain any critical code - eg: this is bad:<br><pre class=code>
Assert Graphics( 640,480 )
</pre><br>In release mode, it'll never execute Graphics(). <br><br></td></tr></table><br>
<a name="777951"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >N</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#18">[#18]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> In release mode, it'll never execute Graphics(). <br></div>That'd explain it.<br><br>Thanks, Mark. <br><br></td></tr></table><br>
<a name="778085"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >N</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#19">[#19]</a></td></tr></table></td></tr><tr ><td class="posttext"> <b>UPDATE</b><br><br>Forgot to remove some debugging stuff.  Fixed version uploaded. <br><br></td></tr></table><br>
<a name="bottom"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td align="right"><a href="http://monkeycoder.co.nz" target="_blank"><img src="/img/monkey2.svg" ></a> <a href="https://github.com/blitz-research" target="_blank"><img src="/img/github.svg" ></a> <a href="https://discord.gg/qJccbSp" target="_blank"><img src="/img/discord.svg" ></a></td></tr></table><br></div><br><table width="100%"><tr><td></body></html lang="en">
