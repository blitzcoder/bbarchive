<!DOCTYPE html><html lang="en" ><head ><title >image handling...</title><meta name='viewport' content='width=device-width, initial-scale=0.66'><meta name='description' content='language:basic, target:desktop, category:game development'><link rel="styleSheet" href="../skins/granite/style.css" type="text/css"><style type="text/css">div.bbcode {padding: 8px;background: #E5E5E5;color: #000000;border: 1px dashed #B4B4BE;}</style></head><body ><table width=100% cellspacing=0 cellpadding=0><tr ><td class="menubarleft"></td><td class="menubar"><table cellspacing="0" cellpadding="0"><tr ><td >&nbsp;</td><td class="menuitemleft"></td><td class="menuitem"><a href="/" class="menuitem">News</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/forums.php" class="menuitem">Forums</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/codearcs.php" class="menuitem">Code</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/logs.php" class="menuitem">Logs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/gallery.php" class="menuitem">Gallery</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/sdkspecs.php" class="menuitem">Specs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/search.php" class="menuitem">Search</a></td><td class="menuitemright"></td></tr></table></td><td class="menubarright"></td></tr></table><div class="main"><h1 >image handling...</h1><a href="forums.php" >BlitzMax Forums</a>/<a href="topics.php?forum=102" >BlitzMax Programming</a>/<a href="#bottom" >image handling...</a><br><br>
<a name="635891"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Kanati</td><td align="right"><font class=tiny>(Posted 2006)</font>&nbsp;<a href="#1">[#1]</a></td></tr></table></td></tr><tr ><td class="posttext"> How are images handled internally?  IE: Is it possible to get the hdc of an image?  Are they DIBs internally?  I am back to trying to pass an image to a dll (via pointer obviously) and if they are dibs they it's probably trivial to get it working.  If not we're back to the same problem that blitz has always had with that kind of thing. <br><br></td></tr></table><br>
<a name="635895"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Dreamora</td><td align="right"><font class=tiny>(Posted 2006)</font>&nbsp;<a href="#2">[#2]</a></td></tr></table></td></tr><tr ><td class="posttext"> Images are hardware textures and at least the OpenGL ones do not exist as textures in system memory anymore. Pro point is that you only need to send an int but are forced to use OpenGL commands ...<br> The DX ones are DX Surfaces and thus handled by DX on its own, so you should be able to send a BytePtr to the Surface structure<br><br>Might I ask, what reason you have to pass it to a DLL instead of performing the operation within BM? (Implementation for GLEW and DX9 are present) <br><br></td></tr></table><br>
<a name="635897"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Kuron</td><td align="right"><font class=tiny>(Posted 2006)</font>&nbsp;<a href="#3">[#3]</a></td></tr></table></td></tr><tr ><td class="posttext"> Stupid question, but instead of using the built in image commands, wouldn't loading the image via user32.dll meet your needs if you are just wanting to pass it to a DLL? <br><br></td></tr></table><br>
<a name="635914"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Kanati</td><td align="right"><font class=tiny>(Posted 2006)</font>&nbsp;<a href="#4">[#4]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> Might I ask, what reason you have to pass it to a DLL instead of performing the operation within BM? <br></div><br><br>Rewriting the printer dll again.  I can open a bmp file and print it no problem.  But I would LIKE to pass blitzmax timages just by passing a reference to them.<br><br>Brice...  I probably COULD do that, but I'm sure BMP is the only resource I could load like that, and I can already do that from the dll itself.  I'd much rather use blitz's image handling that the rest of the language can already use. <br><br></td></tr></table><br>
<a name="635921"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >puki</td><td align="right"><font class=tiny>(Posted 2006)</font>&nbsp;<a href="#5">[#5]</a></td></tr></table></td></tr><tr ><td class="posttext"> heloo <br><br></td></tr></table><br>
<a name="636031"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Defoc8</td><td align="right"><font class=tiny>(Posted 2006)</font>&nbsp;<a href="#6">[#6]</a></td></tr></table></td></tr><tr ><td class="posttext"> use pixmaps + convert to format + store in bank + call<br>function passing the banks buffer... <br><br></td></tr></table><br>
<a name="636041"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Dreamora</td><td align="right"><font class=tiny>(Posted 2006)</font>&nbsp;<a href="#7">[#7]</a></td></tr></table></td></tr><tr ><td class="posttext"> a pixmap is a bank (linear array of int data), you only need to convert it to the needed pixmap format and then handle the byteptr to the dll.<br><br>As you can't render to textures but only to pixmaps, using them will be the faster way as well. <br><br></td></tr></table><br>
<a name="636307"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Kanati</td><td align="right"><font class=tiny>(Posted 2006)</font>&nbsp;<a href="#8">[#8]</a></td></tr></table></td></tr><tr ><td class="posttext"> I have no clue where to start converting a pixmap to a device independent bitmap...  I guess once again mark didn't take into account wanting to pass bitmaps to a dll.  GRRRRR. <br><br></td></tr></table><br>
<a name="636321"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Kanati</td><td align="right"><font class=tiny>(Posted 2006)</font>&nbsp;<a href="#9">[#9]</a></td></tr></table></td></tr><tr ><td class="posttext"> How about this?  I have the hwnd of the printer object at this point and can pass it back to the blitz program.  Can I send an image to an hdc from blitz itself? <br><br></td></tr></table><br>
<a name="636325"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Dreamora</td><td align="right"><font class=tiny>(Posted 2006)</font>&nbsp;<a href="#10">[#10]</a></td></tr></table></td></tr><tr ><td class="posttext"> If you know how to programm with WinAPI (and the other apis if it shall be crossplattform), then yes. <br><br></td></tr></table><br>
<a name="636347"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Kanati</td><td align="right"><font class=tiny>(Posted 2006)</font>&nbsp;<a href="#11">[#11]</a></td></tr></table></td></tr><tr ><td class="posttext"> I have the code to turn a b3d image into a DIB...  but I'm thinking that's the wrong way to go about it now...  I think taking the hdc of the printer object and blitting a blitz image to the printer directly would be better.  But...  I'm not all that sure how to go about that.  (And yes it's windows only dreamora...  I don't care about cross platform much.)  <br><br>I guess the obvious would be bitblt, but I still need to get a handle to the source at that point and it's gdi... <br><br></td></tr></table><br>
<a name="636381"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Dreamora</td><td align="right"><font class=tiny>(Posted 2006)</font>&nbsp;<a href="#12">[#12]</a></td></tr></table></td></tr><tr ><td class="posttext"> In this case you might have some use for the GDI Driver project :-)<br><a href="http://www.blitzbasic.com/Community/posts.php?topic=56055" target="_blank">http://www.blitzbasic.com/Community/posts.php?topic=56055</a> <br><br></td></tr></table><br>
<a name="636383"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >skidracer</td><td align="right"><font class=tiny>(Posted 2006)</font>&nbsp;<a href="#13">[#13]</a></td></tr></table></td></tr><tr ><td class="posttext"> how about something like this?<br><br><pre class=code>
Function BitmapFromPixmap(pix:TPixmap)
	Local x,y
	Local hdc,bm
	Local src:Byte Ptr
	Local bi:BITMAPINFOHEADER

	pix=ConvertPixmap(pix,PF_BGR888)

	hdc=GetDC(0)
	bm=CreateCompatibleBitmap(hdc,pix.width,pix.height)	
	If Not bm Throw "CreateCompatibleBitmap failed"
	
	bi=New BITMAPINFOHEADER	
	bi.biSize=SizeOf(bi)
	bi.biWidth=pix.width
	bi.biHeight=-pix.height
	bi.biPlanes=1
	bi.biBitCount=24
	bi.biCompression=BI_RGB

	src=pix.pixels
	For y=0 Until pix.height
		SetDIBits hdc,bm,pix.height-y-1,1,src,bi,DIB_RGB_COLORS
		src:+pix.pitch
	Next
	Return bm
End Function

</pre> <br><br></td></tr></table><br>
<a name="636398"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Kanati</td><td align="right"><font class=tiny>(Posted 2006)</font>&nbsp;<a href="#14">[#14]</a></td></tr></table></td></tr><tr ><td class="posttext"> That very well might do it skid.  Thanks. <br><br></td></tr></table><br>
<a name="639927"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Kanati</td><td align="right"><font class=tiny>(Posted 2006)</font>&nbsp;<a href="#15">[#15]</a></td></tr></table></td></tr><tr ><td class="posttext"> I think I'm correct in assuming this returns a DC to the DIB that was created correct?  If so, then this<br><br><pre class=code>_BitBlt(phdc, 0,0, 5120,3840, imap, 0,0, 13369376)</pre><br><br>Should put the image I load and convert onto the current page in the printer assuming that phdc is the dc of the printer.<br><br>I can verify that it is, as I used 0 for the last parameter in the bitblt which blacks all pixels in rect that is defined by parameters 2-5.  But when I change the last parameter to SRCCOPY (13369376) I get nothing.  So I can only assume that either the pixmap wasn't loaded by<br><br><pre class=code>pmap = LoadPixmap("C:\picture.bmp")</pre><br><br>or it wasn't converted by the above function.<br><br>Any ideas? <br><br></td></tr></table><br>
<a name="639932"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >skidracer</td><td align="right"><font class=tiny>(Posted 2006)</font>&nbsp;<a href="#16">[#16]</a></td></tr></table></td></tr><tr ><td class="posttext"> No it returns a bitmap.<br><br>BitBlt takes an hdc source, which should be a printer compatible dc (CreateCompatibleDC) with the bitmap selected as current object (SelectObject).<br><br>Check the example code in the MSDN for more confusion. <br><br></td></tr></table><br>
<a name="639934"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Kanati</td><td align="right"><font class=tiny>(Posted 2006)</font>&nbsp;<a href="#17">[#17]</a></td></tr></table></td></tr><tr ><td class="posttext"> heh...  I'm not sure I can take any more confusion. <br><br></td></tr></table><br>
<a name="639944"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Kanati</td><td align="right"><font class=tiny>(Posted 2006)</font>&nbsp;<a href="#18">[#18]</a></td></tr></table></td></tr><tr ><td class="posttext"> <pre class=code>imap = BitmapFromPixmap(pmap)                                                 
                        
ihdc = CreateCompatibleDC(imap)                        
                        
SelectObject(ihdc, imap)                        
                                              
_BitBlt(phdc, 0,0, 5120,3840, ihdc, 0,0, 13369376)</pre><br><br>I think I'm closer now...  But still getting a big ol blank piece of paper shooting out of the printer. <br><br></td></tr></table><br>
<a name="639946"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >skidracer</td><td align="right"><font class=tiny>(Posted 2006)</font>&nbsp;<a href="#19">[#19]</a></td></tr></table></td></tr><tr ><td class="posttext"> nonono<br><br>ihdc = CreateCompatibleDC(phdc)<br><br>the CreateCompatibleBitmap call should also probably be using phdc also <br><br></td></tr></table><br>
<a name="639949"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Kanati</td><td align="right"><font class=tiny>(Posted 2006)</font>&nbsp;<a href="#20">[#20]</a></td></tr></table></td></tr><tr ><td class="posttext"> ahhhh...  I understand now.  <br><br>I actually got it to spit out the bitmap now, though at a really tiny resolution compared to the 5120,3840 that I passed to bitblt.  But I could probably use stretchblt for that...<br><br>The colors though are a bit screwed up.  People look a bit like oompa-loompas or something.  :) <br><br></td></tr></table><br>
<a name="639955"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Kanati</td><td align="right"><font class=tiny>(Posted 2006)</font>&nbsp;<a href="#21">[#21]</a></td></tr></table></td></tr><tr ><td class="posttext"> The image I'm attempting to print (which as stated is indeed printing now) is a 24 bit bmp.  I changed the PF_BGR888 to PF_RGB888 and SOME of the colors are correct now but others are still wacky.  The grass is purple for example.  Skin-tones are correct (or pretty close to it) and the sky has a bit of a green tinge to it.<br><br>Upon looking at it again, the colors are just "close" on the parts I thought were correct.  There's a lot more red in the picture than there should be I think. <br><br></td></tr></table><br>
<a name="639959"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Kanati</td><td align="right"><font class=tiny>(Posted 2006)</font>&nbsp;<a href="#22">[#22]</a></td></tr></table></td></tr><tr ><td class="posttext"> I can see where this is probably happening in SetDIBits, but I'm just not sure how it could be getting screwed up...<br><br>unless...  the colors are getting screwed up when it's loaded into the pixmap eh? <br><br></td></tr></table><br>
<a name="639964"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Kanati</td><td align="right"><font class=tiny>(Posted 2006)</font>&nbsp;<a href="#23">[#23]</a></td></tr></table></td></tr><tr ><td class="posttext"> Changed the createcompatiblebitmap call to <br><br><pre class=code>pix=ConvertPixmap(pix, PixmapFormat(pix))</pre><br><br>for "just in case" situations...  It gives me the original results of what basically looks like a negative. <br><br></td></tr></table><br>
<a name="639995"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Kanati</td><td align="right"><font class=tiny>(Posted 2006)</font>&nbsp;<a href="#24">[#24]</a></td></tr></table></td></tr><tr ><td class="posttext"> Just for poops and grins I changed and used StretchBlt and can resize the image easily enough...  But I'm still getting a "negative" of the image.  Any ideas why? <br><br></td></tr></table><br>
<a name="640007"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >skidracer</td><td align="right"><font class=tiny>(Posted 2006)</font>&nbsp;<a href="#25">[#25]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> <br>pix=ConvertPixmap(pix, PixmapFormat(pix))<br> <br></div><br>huh? no it must be PF_BGR888<br><br>I meant try changing <br><br>bm=CreateCompatibleBitmap(hdc,pix.width,pix.height)<br><br>to <br><br>bm=CreateCompatibleBitmap(phdc,pix.width,pix.height) <br><br></td></tr></table><br>
<a name="640012"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Kanati</td><td align="right"><font class=tiny>(Posted 2006)</font>&nbsp;<a href="#26">[#26]</a></td></tr></table></td></tr><tr ><td class="posttext"> I tried passing that to the function after you mentioned it and it didn't do anything.  I don't think the colors are getting into the bitmap correctly (or into the pixmap maybe).  At least that's what it LOOKS like anyway. <br><br></td></tr></table><br>
<a name="640014"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Kanati</td><td align="right"><font class=tiny>(Posted 2006)</font>&nbsp;<a href="#27">[#27]</a></td></tr></table></td></tr><tr ><td class="posttext"> I just verified it's not just on one image either.  (And I did change it so that createcompatiblebitmap uses the printer's hdc now too).<br><br>I tried it on a 24 bit bitmap and a 24 bit jpg from difference sources. <br><br></td></tr></table><br>
<a name="640016"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >skidracer</td><td align="right"><font class=tiny>(Posted 2006)</font>&nbsp;<a href="#28">[#28]</a></td></tr></table></td></tr><tr ><td class="posttext"> I would give it a test image of 5 solid rectangles, white black red green blue to work out what's happening. if the RGB are incorrect order then yes change PF_BGR888 to PF_RGB888 but I doubt thats your problem, it still sounds like an incorrectly configured context to me with a probable test result of cyan, magenta, yellow instead. <br><br></td></tr></table><br>
<a name="640023"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Kanati</td><td align="right"><font class=tiny>(Posted 2006)</font>&nbsp;<a href="#29">[#29]</a></td></tr></table></td></tr><tr ><td class="posttext"> Ok...  I forgot I still had PixmapFormat(pix) in the convertpixmap command...  once I changed that back the jpg worked as did any other jpgs I created in photoshop for testing (including the 5 box pic you suggested).  <br><br>But that original bmp file just flat out won't print correctly.  I'll do some more testing but it's LOOKING like loadpixmap isn't loading that bmp file correctly.  (just that one or maybe all bmp files?) <br><br></td></tr></table><br>
<a name="640245"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Kanati</td><td align="right"><font class=tiny>(Posted 2006)</font>&nbsp;<a href="#30">[#30]</a></td></tr></table></td></tr><tr ><td class="posttext"> ok...  I have no idea what's wrong with that bmp file that was my primary test image.  I probably wasted more time with that damn thng than I did the whole project.  I've tested with other bmp files that I've created in photoshop and can't reproduce the weird "negative" effect on any of them.<br><br>So I guess...  passing pixmaps to the dll for printing is a success.  <br><br>Thanks skids. <br><br></td></tr></table><br>
<a name="bottom"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td align="right"><a href="http://monkeycoder.co.nz" target="_blank"><img src="/img/monkey2.svg" ></a> <a href="https://github.com/blitz-research" target="_blank"><img src="/img/github.svg" ></a> <a href="https://discord.gg/qJccbSp" target="_blank"><img src="/img/discord.svg" ></a></td></tr></table><br></div><br><table width="100%"><tr><td></body></html lang="en">
