<!DOCTYPE html><html lang="en" ><head ><title >Cursor lag in DX9</title><meta name='viewport' content='width=device-width, initial-scale=0.66'><meta name='description' content='language:basic, target:desktop, category:game development'><link rel="styleSheet" href="../skins/granite/style.css" type="text/css"><style type="text/css">div.bbcode {padding: 8px;background: #E5E5E5;color: #000000;border: 1px dashed #B4B4BE;}</style></head><body ><table width=100% cellspacing=0 cellpadding=0><tr ><td class="menubarleft"></td><td class="menubar"><table cellspacing="0" cellpadding="0"><tr ><td >&nbsp;</td><td class="menuitemleft"></td><td class="menuitem"><a href="/" class="menuitem">News</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/forums.php" class="menuitem">Forums</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/codearcs.php" class="menuitem">Code</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/logs.php" class="menuitem">Logs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/gallery.php" class="menuitem">Gallery</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/sdkspecs.php" class="menuitem">Specs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/search.php" class="menuitem">Search</a></td><td class="menuitemright"></td></tr></table></td><td class="menubarright"></td></tr></table><div class="main"><h1 >Cursor lag in DX9</h1><a href="forums.php" >BlitzMax Forums</a>/<a href="topics.php?forum=102" >BlitzMax Programming</a>/<a href="#bottom" >Cursor lag in DX9</a><br><br>
<a name="1084559"></a>

<a name="1084560"></a>

<a name="1084561"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Grey Alien</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#1">[#1]</a></td></tr></table></td></tr><tr ><td class="posttext"> I felt that the cursor lagged more in DX9 than DX7 in my match-3 game, so I switched on the system cursor and verified that the in-game cursor does indeed lag more in DX9. <br><br>Does anyone know why this is and if there are any workarounds?  I'm guessing that there must be some kind of delay in rendering with DX9.  Years ago we had a big Cursor Lag issue in DX7 and that was resolved by tweaking the way DX7 drew in the module (by cleaning out any old screens to be rendered in the buffer and staying up to date).  Does DX9 need something like that or is it a no hoper?<br><br>Or perhaps there's a lag in reading the coordinates? But I doubt that would vary depending on DX use.<br><br><font class="tiny">Last edited 2011</font> <br><br></td></tr></table><br>
<a name="1084568"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Tommo</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#2">[#2]</a></td></tr></table></td></tr><tr ><td class="posttext"> Does this happen in window mode or in fullscreen mode?<br>Maybe you can try something below:<br>* always use vsync.<br>* use maxgui + CanvasGraphics for window mode<br>* don't use brl.timer to trigger rendering <br><br></td></tr></table><br>
<a name="1084574"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >JazzieB</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#3">[#3]</a></td></tr></table></td></tr><tr ><td class="posttext"> I can confirm that this happens in both windowed and fullscreen mode.  It's for this reason that I'm still using DX7 in my current project.  I also found that keyboard response didn't seem as good either - I was a worse player under DX9 than I was in DX7 ... go figure!<br><br>Anyhow, the lag is worse with vsync on.  When off, it's not so bad, but obviously dependant on how fast your system is.  The faster, the better, but this is not good if you're writing for the casual games market.<br><br>It does need fixing and I'm surprised it hasn't been yet, because of the same issue we had in DX7. <br><br></td></tr></table><br>
<a name="1084580"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Grey Alien</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#4">[#4]</a></td></tr></table></td></tr><tr ><td class="posttext"> Yes it happens in both mode here too.  I recently changed to DX9 because I discovered the SetVirtualResolution() didn't work with DX9 on netbooks with small screens. But I've realised that there is a cursor lag.  I use Vsync on as it makes the games look a lot smoother but some players are reporting bad cursor lag. <br><br></td></tr></table><br>
<a name="1084602"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >ImaginaryHuman</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#5">[#5]</a></td></tr></table></td></tr><tr ><td class="posttext"> maybe it's to do with how many extra backbuffers there are which it cycles between when you flip the display? does the old mouse hack (grab a pixmap pixel) work? <br><br></td></tr></table><br>
<a name="1084620"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Grey Alien</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#6">[#6]</a></td></tr></table></td></tr><tr ><td class="posttext"> Haven't tried that.  Perhaps I should.  Yeah it feels like there are too many backbuffers or something like that. <br><br></td></tr></table><br>
<a name="1084651"></a>

<a name="1084652"></a>

<a name="1084656"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >col</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#7">[#7]</a></td></tr></table></td></tr><tr ><td class="posttext"> Hey guys, there is still only 1 backbuffer being used in the standard Bmax DX9 setup.<br>It must be something else.<br><br>I vaguely remember there was an issue a looong time ago with mouse input and keyboard input, I can't even remember what that issue was, something along the lines of input buffers ?? I cant remember, but Mark resorted back to using the system input instead if DirectX input. Maybe its the same issue popped up again ?<br>Although I'm sure Bmax Dx uses standard input.<br><br><font class="tiny">Last edited 2011</font> <br><br></td></tr></table><br>
<a name="1084670"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Kryzon</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#8">[#8]</a></td></tr></table></td></tr><tr ><td class="posttext"> Can anyone code a simple demo? maybe even post in the bug reports. <br><br></td></tr></table><br>
<a name="1084705"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Grey Alien</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#9">[#9]</a></td></tr></table></td></tr><tr ><td class="posttext"> I'll see what I can do this coming week.  I'd like to get this fixed if possible as it's hurting sales of my game. <br><br></td></tr></table><br>
<a name="1084721"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Gabriel</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#10">[#10]</a></td></tr></table></td></tr><tr ><td class="posttext"> Yeah, there's a well-known bug with DX9 and (I think) Nvidia cards which needs to be fixed. It's a bit tricky, and IIRC the solution is to write to a (very small) rendertexture every frame. Here's the class I used in Star Sentinel Tactics. It uses TV3D, but converting to DX9 shouldn't be too tricky.<br><br>You call Init() once and Update() every frame.<br><br><pre class=code>
Type StratosMouseLagFixer
	
	Global Surfaces:CTVRenderSurface[]
	Global Textures:Int[]
	
	Global Frame:Int
	
	Function Init()
		Surfaces = New CTVRenderSurface[2]
		Textures = New Int[2]
		Surfaces[0] = TVGameEngine.CreateRenderSurface(2, 2)
		Surfaces[1] = TVGameEngine.CreateRenderSurface(2, 2)
		Surfaces[0].SetSystemMemCopy(True, True)
		Surfaces[1].SetSystemMemCopy(True, True)
		Textures[0] = Surfaces[0].GetTexture()
		Textures[1] = Surfaces[1].GetTexture()
	End Function
	
	Function Update()
		
		If StratosGameSettings.IsMouseLagFixEnabled()
			
			Frame:+1
			If Frame &gt; 2
				Frame = 1
			End If
			
			Select Frame
				Case 1
					RenderATriangleToTexture(0)
					LockAndReadTexture(1)
				Case 2
					RenderATriangleToTexture(1)
					LockAndReadTexture(0)
					
			End Select
		
		End If
		
	End Function
	
	Function RenderATriangleToTexture(Index:Int)
		Surfaces[Index].StartRender()
		TVGameEngine.TVScreen2D.Draw_Triangle(0, 0, 1, 1, 0, 1, $FFFFFFFF)
		Surfaces[Index].EndRender()
	End Function
	
	Function LockAndReadTexture(Index:Int)
		Local LockedTex:Int = TVGameEngine.TVTextureFactory.LockTexture(Textures[Index], True)
		TVGameEngine.TVTextureFactory.GetPixel(LockedTex, 0, 0)
		TVGameEngine.TVTextureFactory.UnlockTexture(Textures[Index], False)
	End Function
	
	Function Shutdown()
		Surfaces[0].Destroy()
		Surfaces[0] = Null
		Surfaces[1].Destroy()
		Surfaces[1] = Null
	End Function
	
End Type
</pre> <br><br></td></tr></table><br>
<a name="1084725"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >therevills</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#11">[#11]</a></td></tr></table></td></tr><tr ><td class="posttext"> Does the hardware cursor lag in DX9? <br><br></td></tr></table><br>
<a name="1084726"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Gabriel</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#12">[#12]</a></td></tr></table></td></tr><tr ><td class="posttext"> I honestly can't remember. Sorry. The link to the problem on Nvidia's forum that I buried in my code comments is now a dead link, so I don't have a reference any more. <br><br></td></tr></table><br>
<a name="1084735"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Grey Alien</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#13">[#13]</a></td></tr></table></td></tr><tr ><td class="posttext"> @Gabriel.  Interesting thanks, I'll see if I can get this to work.  DX9 in BMax has way less stuff exposed so may require module tweaks and I'm a noob on most internal BMax stuff.<br><br>@therevills: the windows mouse cursor doesn't lag, but if I show my in-game one at the same time, the lag is obvious. There's still a lag in DX7 but it's less bad. OpenGL also has a lag. <br><br></td></tr></table><br>
<a name="1084736"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >GfK</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#14">[#14]</a></td></tr></table></td></tr><tr ><td class="posttext"> Surely this lag is down to the fact that the Windows cursor updates itself independently of your game timing? <br><br></td></tr></table><br>
<a name="1084756"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >therevills</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#15">[#15]</a></td></tr></table></td></tr><tr ><td class="posttext"> Temp Solution: Add an option to display only the OS mouse cursor <br><br></td></tr></table><br>
<a name="1084783"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Grey Alien</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#16">[#16]</a></td></tr></table></td></tr><tr ><td class="posttext"> Yeah I added that option.  Anything you pickup in game that attaches to cursor, like a powerup, lags behind. <br><br></td></tr></table><br>
<a name="1084924"></a>

<a name="1084925"></a>

<a name="1084927"></a>

<a name="1084933"></a>

<a name="1084934"></a>

<a name="1084936"></a>

<a name="1084937"></a>

<a name="1084938"></a>

<a name="1084939"></a>

<a name="1084941"></a>

<a name="1084942"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >col</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#17">[#17]</a></td></tr></table></td></tr><tr ><td class="posttext"> I know this sounds rather bizarre, and a long shot... but have you tried ( just as a test on your own machine ) to lower the mouse sensitivity ??<br><br>After digging around the net.....<br><br>Quote :-<br><div class="quote"> "It seems the input systems ( whether using the hardware DX or System mouse ) when used with DirectX can get overloaded with trying to catch up with the thousands of mouse messages sent through the system which can then cause stalls - up to 3 or 4 frames.<br>You may find its not usually noticeable when VSYNC is OFF because of the fast refresh speeds, and more noticeable with the SYNC on." <br></div><br><br>Aparently even the top AAA games have had some complaints on some systems using Dx9, worse on Dx10 and Dx11.<br><br>They seem to work around it by adjusting mouse sensitivity in the game itself, but maybe reducing it at the source would help ?<br><br>Another thing you could test for yourself, if you don't mind playing in the BRL files is...<br><br>Goto<br>(V1.42)<br><br>brl.mod/dxgraphics.mod/d3d9graphics.bmx<br><br>line 72 ( or thereabouts :) ) reads..<br><br>pp.PresentationInterval=D3DPRESENT_INTERVAL_ONE<br><br>you could try changing it to<br><br>pp.PresentationInterval=D3DPRESENT_INTERVAL_IMMEDIATE<br><br>just to see if it makes any difference.<br>EDIT:- It appears Mark decided to leave out that Constant so here it is<br>Const D3DPRESENT_INTERVAL_IMMEDIATE  = $80000000<br><br>You could just use <br>pp.PresentationInterval = $80000000<br><br>just to test it - don't forget to 'Rebuild Modules' after you've made changes.<br><br>EDIT2 :-<br>Also make sure DirectX is always up to date by downloading the latest version from MS. It doesnt always mean updates to Dx11 etc, it also updates fixes in older versions too.<br><br>There are more things to try but it means more modifying to the BRL files. Some people dont like doing that. One of the reasons I created a whole 'complete' D3D9 driver as Mark has left some of it out. It's seems he's only included what was needed to get what he wanted done.<br><br>There is a function in there for setting the mouse cursor and using an immediate flag. Again this would mean modifying BRL and testing to see if makes any differences, it usually performs better when this flag is OFF anyway, but it may be worth testing.<br>If you don't mind going down that route, let me know.<br><br><font class="tiny">Last edited 2011</font> <br><br></td></tr></table><br>
<a name="1086414"></a>

<a name="1086416"></a>

<a name="1086417"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Grey Alien</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#18">[#18]</a></td></tr></table></td></tr><tr ><td class="posttext"> @Col Thanks for all this info!  I only just saw you added all this extra stuff.  I'll try that mod tweak out and see what happens.<br><br>I have also discovered that there's a general input lag, so even when I press keys I see an input lag. If I switch to DX7 the lag is reduced.  This is a real bummer for DX9 games, and we should get it sorted out for everyone who uses Blitz.<br><br>I tried this possible fix from CyBeRGoth and it works in full-screen mode DX9 but not windowed mode.<br><br><pre class=code>
Local MouseHack:TPixmap
MouseHack = GrabPixmap(1, 1, 1, 1)
</pre><br><br><font class="tiny">Last edited 2011</font> <br><br></td></tr></table><br>
<a name="1086419"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Grey Alien</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#19">[#19]</a></td></tr></table></td></tr><tr ><td class="posttext"> This was the old DX7 lag fix that BRL eventually implemented.  Could something like this work for DX9?<br><br><pre class=code>
		If TD3D7Max2DDriver(_max2dDriver)
			Local sdesc:DDSurfaceDesc2 = New DDSurfaceDesc2
			sdesc.dwSize = SizeOf(sdesc)
			Local res:Int = PrimaryDevice.backbuffer.Lock(Null,sdesc,DDLOCK_WAIT|DDLOCK_READONLY,Null)
			PrimaryDevice.backbuffer.unlock(Null)
			Return res
		EndIf
</pre> <br><br></td></tr></table><br>
<a name="1086568"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >col</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#20">[#20]</a></td></tr></table></td></tr><tr ><td class="posttext"> Hey Grey Alien.<br><br>I agree we ( the community ) should make it a priority to get this fixed or at least reduced to a barely noticeable level.<br><br>Do you have some sample source code that you know suffers from the lag that I could use for testing? <br><br></td></tr></table><br>
<a name="1086596"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Grey Alien</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#21">[#21]</a></td></tr></table></td></tr><tr ><td class="posttext"> I'll make some.  Stay tuned. <br><br></td></tr></table><br>
<a name="1087153"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >col</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#22">[#22]</a></td></tr></table></td></tr><tr ><td class="posttext"> This thread is continued <a href="/posts.php?topic=94676" target="_blank"><b>here</b></a> <br><br></td></tr></table><br>
<a name="bottom"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td align="right"><a href="http://monkeycoder.co.nz" target="_blank"><img src="/img/monkey2.svg" ></a> <a href="https://github.com/blitz-research" target="_blank"><img src="/img/github.svg" ></a> <a href="https://discord.gg/qJccbSp" target="_blank"><img src="/img/discord.svg" ></a></td></tr></table><br></div><br><table width="100%"><tr><td></body></html lang="en">
