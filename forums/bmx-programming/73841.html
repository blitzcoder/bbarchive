<!DOCTYPE html><html lang="en" ><head ><title >Garbage Collector Issues with Lua Scripting</title><meta name='viewport' content='width=device-width, initial-scale=0.66'><meta name='description' content='language:basic, target:desktop, category:game development'><link rel="styleSheet" href="../skins/granite/style.css" type="text/css"><style type="text/css">div.bbcode {padding: 8px;background: #E5E5E5;color: #000000;border: 1px dashed #B4B4BE;}</style></head><body ><table width=100% cellspacing=0 cellpadding=0><tr ><td class="menubarleft"></td><td class="menubar"><table cellspacing="0" cellpadding="0"><tr ><td >&nbsp;</td><td class="menuitemleft"></td><td class="menuitem"><a href="/" class="menuitem">News</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/forums.php" class="menuitem">Forums</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/codearcs.php" class="menuitem">Code</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/logs.php" class="menuitem">Logs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/gallery.php" class="menuitem">Gallery</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/sdkspecs.php" class="menuitem">Specs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/search.php" class="menuitem">Search</a></td><td class="menuitemright"></td></tr></table></td><td class="menubarright"></td></tr></table><div class="main"><h1 >Garbage Collector Issues with Lua Scripting</h1><a href="forums.php" >BlitzMax Forums</a>/<a href="topics.php?forum=102" >BlitzMax Programming</a>/<a href="#bottom" >Garbage Collector Issues with Lua Scripting</a><br><br>
<a name="825021"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Gabriel</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#1">[#1]</a></td></tr></table></td></tr><tr ><td class="posttext"> I've been playing more with my script engine and I think I've found some issues with the GC and Lua. When I first started reading up on Lua with BMax, I found a lot of information about being careful that Lua doesn't have objects which have gone out of scope in BlitzMax, because the GC won't manage Lua references to objects. Fair enough, I thought, makes sense.<br><br>I seem to have the reverse problem though. BlitzMax *is* reference counting my Lua references to objects, and I don't want it to. The Lua VM has the ability to get lots of objects, for various purposes. I intentionally want as few restrictions on scripting as possible. I certainly *don't* want to force people to manage their objects properly. They  have a right to expect me to do that for them. I mean it's not like they're actually creating objects. They're only retrieving handles for existing objects. It'd be very rude of me to expect them to free something they didn't even create.<br><br>But how can I  manage objects I don't know they have? Well ok, I know they have them, but I don't know where they are or how to break the references. I can't even fiddle with the internal reference count ( not that I would want to! ) because I have no way of determining whether a second call to get an object handle is going into a second variable or back into the first one.<br><br>I'm already destroying the VM when the program finishes, but even that doesn't seem to be enough. the GC still seems to think there are references which exist, but I don't have access to them to free them. There has to be a better way to manage this?<br><br>EDIT: I'm sending objects as LightUserData via HandleFromObject(), if that makes any difference. In Lua, the LightUserData is stored in a table. <br><br></td></tr></table><br>
<a name="825038"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Gabriel</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#2">[#2]</a></td></tr></table></td></tr><tr ><td class="posttext"> Looking through again, it seems I was misinformed when I was told that HandleFromObject is not managed. Ok, so if I just call Release() on the handle as I send it then that should resolve the issue, right? Now it will only break if I try to use an object in Lua which has already been destroyed, right?<br><br>EDIT: No, of course it won't. If the handle is Release'd, BlitzMax won't convert it back into an object even though the object still exists. <br><br></td></tr></table><br>
<a name="825041"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Dreamora</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#3">[#3]</a></td></tr></table></td></tr><tr ><td class="posttext"> You will have to try it and find it out.<br><br>Not many were "crazy" enough and tried to bind BM objects to something outside BM.<br><br>The only one I know is Koriolis with BriskVM ... <br><br></td></tr></table><br>
<a name="825049"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >skidracer</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#4">[#4]</a></td></tr></table></td></tr><tr ><td class="posttext"> from the docs:<br><pre class=code>
Function HandleFromObject( obj:Object ) 
Returns An integer object handle  
Description Convert object to integer handle 
Information After converting an object to an integer handle, you must later release it using the Release command.  
</pre> <br><br></td></tr></table><br>
<a name="825058"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Gabriel</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#5">[#5]</a></td></tr></table></td></tr><tr ><td class="posttext"> Skidracer: Yes, I referred to that in my second comment. It doesn't really help me very much though. There's no practical way for me to know when I can safely call Release.<br><br>Dreamora: Yes, that sounds about right. If ever there are only two people stupid enough to do something, you can usually bet I'll be one of them. <br><br></td></tr></table><br>
<a name="825085"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >N</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#6">[#6]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> Skidracer: Yes, I referred to that in my second comment. It doesn't really help me very much though. There's no practical way for me to know when I can safely call Release. <br></div>This is more of an issue with you not implementing your handling of objects between the application and script safely.  Your objects should have their own code to determine when they are still in use by Lua.  If they are, Lua should call a function to tell the host that it's safe to release the handle.  If not, you simply don't release the handle. <br><br></td></tr></table><br>
<a name="825091"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Gabriel</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#7">[#7]</a></td></tr></table></td></tr><tr ><td class="posttext"> That's my point though. The idea of having scripting was to let people mod the game freely and easily. Making them call functions to release handles with every object they use isn't free or easy. <br><br>They're inherently safe because the scope of scripts and objects is carefully managed by the engine itself. <br><br></td></tr></table><br>
<a name="825103"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Gabriel</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#8">[#8]</a></td></tr></table></td></tr><tr ><td class="posttext"> Right, I think I've found a solution. It's not pretty, but I don't see a better solution.<br><br>If anyone ever hits the same problem, here's my solution.<br><br><pre class=code>
Type ScriptableObject
	
	Field IntHandle:Int
	
	Method Destroy() 
		If IntHandle &lt;&gt; 0
			Release(IntHandle) 
		End If
	End Method
	
	Method GetIntHandle:Int() 
		If IntHandle = 0
			Self.IntHandle = HandleFromObject(Self) 
		End If
		Return IntHandle
	End Method

End Type
</pre><br><br>Anything you want to send as an object to Lua, has to Extend ScriptableObject. The ScriptManager object calls GetIntHandle() on all objects when sending them to get the lightuserdata which you pass to Lua.<br><br>It also has to call Super.Destroy() at some point when you want to get rid of it as well. Sadly, you won't be able to tuck that away in a delete method because it will never get called. You'll have to implement an explicit destructor, which is not ideal, but it's the cleanest solution I can find. <br><br></td></tr></table><br>
<a name="825454"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Cajun17</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#9">[#9]</a></td></tr></table></td></tr><tr ><td class="posttext"> As a general rule you want to use regular userdata instead of the light variety. <br><br>Userdata has the advantage that when the Lua GC collects it you can specify a destructor to free your resources.<br><br>Lightuserdata is only a pointer. You can use it to pass userdata to the host. <br><br></td></tr></table><br>
<a name="825484"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Dreamora</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#10">[#10]</a></td></tr></table></td></tr><tr ><td class="posttext"> I would actually make this a function.<br>Why? it does not operate on the object and therefor allow the GC to take care of it (not possible with a method until it finished).<br><br>I just realized that this would be a way to solve the problem you had before as well (with weak references)<br><br>The main problem here is: HandleFromObject and the vice versa are EXTREMELY SLOW so don't do it with speed critical objects ...<br>When I am not wrong, this 2 functions are mainly there for backwards compatibility of Blitz3D / BlitzPlus ...<br><br>This is the main reason actually why using Int handles for banks for example drops the performance to 50% of banks and the like ...<br>if you want to speed up that you could as well do your own mapping. A global array in the class which stores the object handles and you just send the array index as ID to lua and instead of release you just NULL it.<br>This would even free you from the need to handle the reference in a list -&gt; weak references for lua objects could theoretically be done this way. <br><br></td></tr></table><br>
<a name="825514"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Gabriel</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#11">[#11]</a></td></tr></table></td></tr><tr ><td class="posttext"> I've actually moved over to managing most of my resources in the way you describe, only using a hash table and referencing objects by name instead of by integer index. There are a few objects, mainly HUD and GUI stuff which don't really suit being managed in this way though, and those are the ones I'm referring to here. I can't say as I've seen any improvement in speed though, so I'm not sure that HandleFromObject was particularly slow. Or perhaps in the limited context that these are being used it just wasn't going to matter either way.<br><br>With regard to userdata vs lightuserdata, it sounds good in theory, but I'm pretty sure I only came to use lightuserdata because there was a big problem when using userdata. So I'll give it a look, but I think it might not work for what I want. <br><br></td></tr></table><br>
<a name="bottom"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td align="right"><a href="http://monkeycoder.co.nz" target="_blank"><img src="/img/monkey2.svg" ></a> <a href="https://github.com/blitz-research" target="_blank"><img src="/img/github.svg" ></a> <a href="https://discord.gg/qJccbSp" target="_blank"><img src="/img/discord.svg" ></a></td></tr></table><br></div><br><table width="100%"><tr><td></body></html lang="en">
