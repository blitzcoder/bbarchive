<!DOCTYPE html><html lang="en" ><head ><title >Convert a string into a null-terminated string?</title><meta name='viewport' content='width=device-width, initial-scale=0.66'><meta name='description' content='language:basic, target:desktop, category:game development'><link rel="styleSheet" href="../skins/granite/style.css" type="text/css"><style type="text/css">div.bbcode {padding: 8px;background: #E5E5E5;color: #000000;border: 1px dashed #B4B4BE;}</style></head><body ><table width=100% cellspacing=0 cellpadding=0><tr ><td class="menubarleft"></td><td class="menubar"><table cellspacing="0" cellpadding="0"><tr ><td >&nbsp;</td><td class="menuitemleft"></td><td class="menuitem"><a href="/" class="menuitem">News</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/forums.php" class="menuitem">Forums</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/codearcs.php" class="menuitem">Code</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/logs.php" class="menuitem">Logs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/gallery.php" class="menuitem">Gallery</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/sdkspecs.php" class="menuitem">Specs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/search.php" class="menuitem">Search</a></td><td class="menuitemright"></td></tr></table></td><td class="menubarright"></td></tr></table><div class="main"><h1 >Convert a string into a null-terminated string?</h1><a href="forums.php" >BlitzMax Forums</a>/<a href="topics.php?forum=102" >BlitzMax Programming</a>/<a href="#bottom" >Convert a string into a null-terminated string?</a><br><br>
<a name="819063"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Grey Alien</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#1">[#1]</a></td></tr></table></td></tr><tr ><td class="posttext"> I'm doing some WinAPI stuff and one of the structures is this:<br><br><pre class=code>
typedef struct _TRUSTEE {
  PTRUSTEE pMultipleTrustee;
  MULTIPLE_TRUSTEE_OPERATION MultipleTrusteeOperation;
  TRUSTEE_FORM TrusteeForm;
  TRUSTEE_TYPE TrusteeType;
  LPTSTR ptstrName;
} TRUSTEE,  *PTRUSTEE;
</pre><br><br>Basically LPTSTR ptstrName should be "A pointer to a null-terminated string that contains the name of the trustee"<br><br>Well I'm a bit wary of doing this:<br><br><pre class=code>
Type TTRUSTEE
	Field pMultipleTrustee: Byte Ptr
	Field MultipleTrusteeOperation: Int
	Field TrusteeForm: Int
	Field TrusteeType: Int
	Field ptstrName: String
End Type
</pre> <br><br>Where my ptstrName is a normal BlitzMax string.  I'm not convinced it will work.  I tried defining it as Byte Ptr but then later I can't do Trustee.ptstrName="User", whereas I can if it's a String.<br><br>I know when you do externs you can specify as null terminated string with $z but if I do:<br><br>	Field ptstrName$z<br><br>I get "Illegal variable type" on compile.<br><br>This stuff does my head in.  Any advice MEGA appreciated, thanks! <br><br></td></tr></table><br>
<a name="819064"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >JoshK</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#2">[#2]</a></td></tr></table></td></tr><tr ><td class="posttext"> mystring.ToCString() <br><br></td></tr></table><br>
<a name="819070"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Grey Alien</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#3">[#3]</a></td></tr></table></td></tr><tr ><td class="posttext"> thanks.  Seems to work if I declare the field as a Byte Ptr (Field ptstrName: Byte Ptr), that's correct is it?  OK so how would I read that back as matter of interest because if I do Print ea.Trustee.ptstrName I get "Cannot convert from Byte Ptr to String". <br><br></td></tr></table><br>
<a name="819075"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >N</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#4">[#4]</a></td></tr></table></td></tr><tr ><td class="posttext"> String.FromCString( ptstrName )<br><br>You have to free the memory allocated for ptstrName yourself, by the way. <br><br></td></tr></table><br>
<a name="819077"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Grey Alien</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#5">[#5]</a></td></tr></table></td></tr><tr ><td class="posttext"> Neat, works well thanks Noel.<br><br>So the GC won't clean that up, OK.  How would I free that memory then please? <br><br></td></tr></table><br>
<a name="819082"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Azathoth</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#6">[#6]</a></td></tr></table></td></tr><tr ><td class="posttext"> Depends how you allocated it in the first place.<br>You also need to use MemFree on the memory returned by mystring.ToCString() when you've finished with it. <br><br></td></tr></table><br>
<a name="819087"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Grey Alien</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#7">[#7]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> You also need to use MemFree on the memory returned by mystring.ToCString() when you've finished with it.  <br></div>Isn't that what Noel meant?<br><br>So if I do:<br><br><pre class=code>
Trustee.ptstrName = "Users".ToCString()
</pre><br><br>after I've used Trustee I should do:<br><br><pre class=code>
MemFree(Trustee.ptstrName)
</pre><br><br>Is that correct?  And I do that before I set Trustee to Null in order for the GC to deal with it right?<br><br>I don't have to do any more MemFree calls just because I've used String.FromCString(Trustee.ptstrName) do I? <br><br></td></tr></table><br>
<a name="819092"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Azathoth</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#8">[#8]</a></td></tr></table></td></tr><tr ><td class="posttext"> Yea, you don't have to necessarily set Trustee to null if its going to go out of scope or you're going to overwrite it. <br><br></td></tr></table><br>
<a name="819094"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Grey Alien</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#9">[#9]</a></td></tr></table></td></tr><tr ><td class="posttext"> Yep I realise that thanks. <br><br></td></tr></table><br>
<a name="819162"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >N</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#10">[#10]</a></td></tr></table></td></tr><tr ><td class="posttext"> Grey:<br><div class="quote"> Is that correct? And I do that before I set Trustee to Null in order for the GC to deal with it right? <br></div>It's a good idea to also ensure that whatever code is using the pointer makes its own copy of the data if it's stored for use beyond the initial piece where the pointer is used.  Otherwise you're going to get some unusual errors.<div class="quote"> I don't have to do any more MemFree calls just because I've used String.FromCString(Trustee.ptstrName) do I? <br></div>No.  The string returned by FromCString is managed by the garbage collector, versus the memory that ptstrName points to which is not.<br><br>Azathoth:<br><div class="quote"> Depends how you allocated it in the first place. <br></div>No it doesn't, there's only one way to free memory: MemFree. <br><br></td></tr></table><br>
<a name="819175"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Azathoth</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#11">[#11]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> No it doesn't, there's only one way to free memory: MemFree. <br></div>Not if you allocated the memory using the Win32 API. <br><br></td></tr></table><br>
<a name="819178"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >N</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#12">[#12]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> Not if you allocated the memory using the Win32 API. <br></div>That's not a good idea. <br><br></td></tr></table><br>
<a name="819181"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Azathoth</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#13">[#13]</a></td></tr></table></td></tr><tr ><td class="posttext"> Because you made reference to 'String.FromCString' I thought you were talking about an external function or some c code allocating the c-string, in which case freeing it would depend on how the function allocated it. <br><br></td></tr></table><br>
<a name="819182"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Brucey</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#14">[#14]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> No it doesn't, there's only one way to free memory: MemFree. <br></div><br>Not really. If you allocated the memory using malloc() or whatever, you would have to free() it, rather.<br>And the same goes for however the particular API says the memory should be freed. Sometimes the API allocates the memory, which you must then free. <br><br></td></tr></table><br>
<a name="819187"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >N</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#15">[#15]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> Not really. If you allocated the memory using malloc() or whatever, you would have to free() it, rather. <br></div>This is if you expose those functions and any other functions for memory manipulation not provided by BRL.  I'm talking specifically about the API provided by BRL, which has only one means of allocating and freeing memory (last I checked -- been a while since I bothered messing with their modules' internals).<br><br>Edit: Should be noted, folks, you don't want to use free() on memory allocated by MemFree. <br><br></td></tr></table><br>
<a name="819188"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Brucey</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#16">[#16]</a></td></tr></table></td></tr><tr ><td class="posttext"> True.. if your C String was created via ToCString() you would want to call MemFree() to free it. <br><br></td></tr></table><br>
<a name="819203"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Grey Alien</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#17">[#17]</a></td></tr></table></td></tr><tr ><td class="posttext"> Cool that's what I needed to know.  ToCString is a Blitz call and so any memory allocated by it should be freed in a Blitz compatible manner which seems to be MemFree(). <br><br></td></tr></table><br>
<a name="bottom"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td align="right"><a href="http://monkeycoder.co.nz" target="_blank"><img src="/img/monkey2.svg" ></a> <a href="https://github.com/blitz-research" target="_blank"><img src="/img/github.svg" ></a> <a href="https://discord.gg/qJccbSp" target="_blank"><img src="/img/discord.svg" ></a></td></tr></table><br></div><br><table width="100%"><tr><td></body></html lang="en">
