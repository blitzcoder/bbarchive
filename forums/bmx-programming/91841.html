<!DOCTYPE html><html lang="en" ><head ><title >TPixmaps broken?</title><meta name='viewport' content='width=device-width, initial-scale=0.66'><meta name='description' content='language:basic, target:desktop, category:game development'><link rel="styleSheet" href="../skins/granite/style.css" type="text/css"><style type="text/css">div.bbcode {padding: 8px;background: #E5E5E5;color: #000000;border: 1px dashed #B4B4BE;}</style></head><body ><table width=100% cellspacing=0 cellpadding=0><tr ><td class="menubarleft"></td><td class="menubar"><table cellspacing="0" cellpadding="0"><tr ><td >&nbsp;</td><td class="menuitemleft"></td><td class="menuitem"><a href="/" class="menuitem">News</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/forums.php" class="menuitem">Forums</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/codearcs.php" class="menuitem">Code</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/logs.php" class="menuitem">Logs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/gallery.php" class="menuitem">Gallery</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/sdkspecs.php" class="menuitem">Specs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/search.php" class="menuitem">Search</a></td><td class="menuitemright"></td></tr></table></td><td class="menubarright"></td></tr></table><div class="main"><h1 >TPixmaps broken?</h1><a href="forums.php" >BlitzMax Forums</a>/<a href="topics.php?forum=102" >BlitzMax Programming</a>/<a href="#bottom" >TPixmaps broken?</a><br><br>
<a name="1045382"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >taumel</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#1">[#1]</a></td></tr></table></td></tr><tr ><td class="posttext"> Hi,<br><br>could it be that TPixmaps are kind of broken?<br><br>What i tried to:<br>1) I assigned four TImages via CreateImage (DYNAMICIMAGE is set).<br>2) I copied them to RAM via creating TPixmaps and LockImage().<br>3) According to the visibility of the user, i write to the TPixmaps via WritePixel().<br>4) Then i write them back to VRAM via UnlockImage(), this can happen more than once between the vertical blanks.<br>5) Afterwards i draw the images on the screen as two tiles each consisting of two layers (Background- and Collisionlayer).<br>6) Finally i do a collisiontest via ImagesCollide() between the collisionlayer and another sprite.<br><br>Everything works fine initially but after a few updates things are broken and it seems that either the RAM or the VRAM doesn't get updated anymore, so either a) the graphics aren't upated properly anymore or b) collisions occur where they should not or don't where they should.<br><br>I tried both using SOLIDBLEND as well as ALPHABLEND for the background layers.<br>I tried to clear the buffers vie ClearPixels() before but that doesn't help anything beside of that it seems that writing an alphachannel  with no RGBs results into collisions but clearing without setting the alphachannel results into left out collisions.<br><br>Although this all should be superfluous because i update the relevant parts when writing to the buffers via WritePixel(ARGB) already.<br><br>All happens on BlitzMax 1.4.1 on OSX 10.6.4 (x86).<br><br>It's weird and just doesn't work as expected. Either i'm missing something with the pixelformats, although all use an alpha channel or something seems to be broken.<br><br>Any ideas or alternatives?<br><br><br>Thanks,<br><br>taumel <br><br></td></tr></table><br>
<a name="1045386"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >ima747</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#2">[#2]</a></td></tr></table></td></tr><tr ><td class="posttext"> Can you post an example? I would suspect something going wrong in the way you're writing the pixels that just isn't noticeable until you've done it a certain number of times... <br><br></td></tr></table><br>
<a name="1045391"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >taumel</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#3">[#3]</a></td></tr></table></td></tr><tr ><td class="posttext"> Before whipping up a example which causes the same problems is this enough?<br><br>a) Global imgHG1:TImage=CreateImage(weSizX,weSizY,1,DYNAMICIMAGE|MASKEDIMAGE) creates and 32bit per pixel image with the bytesorder ARGB, right?<br><br>b) Global pixHG:TPixmap<br>I can define just the type and then assign any Image like for instance via pixHG=LockImage(imgHG1) to it, right?<br><br>c) Then i can write as much as i want like this to the RAM, 					WritePixel(pixHG,iX,iY,colA) where the colour is set together like 		colA=colARGB|(rgbR Shl 16)|(rgbG Shl 8)|(rgbB)<br>colARGB=$ff000000<br><br>d) Then i release it via UnlockImage(imgHG1)<br><br>e) Drawing<br>		SetScale 1,1<br> 		SetBlend ALPHABLEND<br>		DrawImage imgHG1,hgPosX,hgPosY<br>		DrawImage imgPlayer,plPosX,plPosY<br><br>f) Collisiontest<br><br>		If ImagesCollide(imgPlayer,plPosX,plPosY,0,imgHG1,hgPosX,hgPosYscrY,0) Then	flaCollision=true <br><br></td></tr></table><br>
<a name="1045393"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >TomToad</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#4">[#4]</a></td></tr></table></td></tr><tr ><td class="posttext"> When doing a collision test, Max2D checks against the alpha channel, not the actual pixel.  When using LoadImage(), Max2D checks each pixel's color against a mask (default 0,0,0) and sets that pixel's alpha to 0 if it matches and to 255 if it does not.  When you use CreateImage(), the alpha channel is not set and must be set by hand.  One way to do this is to iterate through every pixel and set/clear the alpha based on pixel color<br><textarea class=codebox name="code" wrap=OFF readonly="true" rows="15" cols="80">
 Local Image:TImage = CreateImage(0,100)
Local Pixmap:TPixmap = LockImage(Image)
ClearPixels(Pixmap)
DrawToPixmap(Pixmap) 'Function to do all necessary drawing
For Local y:int = 0 Until Pixmap.Height
    For Local x:Int = 0 Until Pixmap.Width
        Local Color:Int = ReadPixel(Pixmap,x,y) &amp; $FFFFFF
        If Color = 0
            WritePixel(Pixmap,x,y,0)
        Else
            WritePixel(Pixmap,x,y,$FF000000 | Color)
        End If
    Next
Next
ContinueCode()
</textarea> <br>Of course, this could be avoided if you include the alpha with any pixels you want seen and tested against while you draw.<br><textarea class=codebox name="code" wrap=OFF readonly="true" rows="15" cols="80">
Function WriteMaskedPixel(Pixmap:TPixmap,X:Int,Y:Int,Color:Int)
    If Color = 0
        WritePixel(Pixmap,X,Y,0)
    Else
        WritePixel(Pixmap,X,Y,$FF000000 | Color)
    End If
End Function
</textarea><br>With that modification of the WritePixel(), any black pixel will be rendered with 0 alpha and will not cause collision.  Any other color will be rendered with full alpha and trigger collisions.  If you want a black pixel to be rendered and to collide, you can use $FF000000 for the color. <br><br></td></tr></table><br>
<a name="1045395"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >TomToad</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#5">[#5]</a></td></tr></table></td></tr><tr ><td class="posttext"> Also thought I might add, when you use CreateImage() you will not be guaranteed that the pixels will be cleared.  So it is a good idea to use ClearPixels() after LockImage() if you are not already rendering to every pixel. <br><br></td></tr></table><br>
<a name="1045405"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >taumel</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#6">[#6]</a></td></tr></table></td></tr><tr ><td class="posttext"> I am already rendering to each pixel i show, the way i wrote before via $ff000000|color, so i thought this wouldn't be a problem at all but somehow using ClearPixels makes a difference and both the visuals as well as the collisions work different, whilst also providing NOT the wanted result.<br><br>*sigh* I thought this would be a quick thing... <br><br></td></tr></table><br>
<a name="1045412"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Jesse</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#7">[#7]</a></td></tr></table></td></tr><tr ><td class="posttext"> The only way to tell what you are doing wrong is to look at the actual code. I have used ImagesCollided and never had problems with it as well as using it with modified images through pixmaps. <br><br></td></tr></table><br>
<a name="1045414"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >taumel</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#8">[#8]</a></td></tr></table></td></tr><tr ><td class="posttext"> I'll see how i can extract the problem.<br><br>Just another one, is there a limit regarding the sizes? <br><br></td></tr></table><br>
<a name="1045425"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >TomToad</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#9">[#9]</a></td></tr></table></td></tr><tr ><td class="posttext"> you're probably doing this, but I thought I'd ask anyway.  Are you doing Cls and calling ResetCollisions() between each frame? <br><br></td></tr></table><br>
<a name="1045426"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >taumel</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#10">[#10]</a></td></tr></table></td></tr><tr ><td class="posttext"> Okay, i got it, it works now.<br><br>I wasn't aware of that ImagesCollides() tests against the alpha channel and therefore i wasn't reinitialising leftovers in all layers.<br><br>Thanks to TomToad and the others!<br><br>Hmm, now that it works i think i will expand the test a bit for ... :O) <br><br></td></tr></table><br>
<a name="1045427"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Pete Rigz</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#11">[#11]</a></td></tr></table></td></tr><tr ><td class="posttext"> In my own experience using bmax collisions, if collisions were happening where they shouldn't it was usually because I'd forgotten to use ResetCollisions(), not sure if that's the same problem here though, might be :) <br><br></td></tr></table><br>
<a name="1045491"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >taumel</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#12">[#12]</a></td></tr></table></td></tr><tr ><td class="posttext"> Nope, thanks, my issue was that i didn't know that the alpha channel is used for the collisions. It works now as <a href="/posts.php?topic=91294#1045490" target="_blank">my little test</a> shows. <br><br></td></tr></table><br>
<a name="bottom"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td align="right"><a href="http://monkeycoder.co.nz" target="_blank"><img src="/img/monkey2.svg" ></a> <a href="https://github.com/blitz-research" target="_blank"><img src="/img/github.svg" ></a> <a href="https://discord.gg/qJccbSp" target="_blank"><img src="/img/discord.svg" ></a></td></tr></table><br></div><br><table width="100%"><tr><td></body></html lang="en">
