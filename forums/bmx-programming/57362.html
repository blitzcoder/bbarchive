<!DOCTYPE html><html lang="en" ><head ><title >Wrapping Virtual Destructors</title><meta name='viewport' content='width=device-width, initial-scale=0.66'><meta name='description' content='language:basic, target:desktop, category:game development'><link rel="styleSheet" href="../skins/granite/style.css" type="text/css"><style type="text/css">div.bbcode {padding: 8px;background: #E5E5E5;color: #000000;border: 1px dashed #B4B4BE;}</style></head><body ><table width=100% cellspacing=0 cellpadding=0><tr ><td class="menubarleft"></td><td class="menubar"><table cellspacing="0" cellpadding="0"><tr ><td >&nbsp;</td><td class="menuitemleft"></td><td class="menuitem"><a href="/" class="menuitem">News</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/forums.php" class="menuitem">Forums</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/codearcs.php" class="menuitem">Code</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/logs.php" class="menuitem">Logs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/gallery.php" class="menuitem">Gallery</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/sdkspecs.php" class="menuitem">Specs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/search.php" class="menuitem">Search</a></td><td class="menuitemright"></td></tr></table></td><td class="menubarright"></td></tr></table><div class="main"><h1 >Wrapping Virtual Destructors</h1><a href="forums.php" >BlitzMax Forums</a>/<a href="topics.php?forum=102" >BlitzMax Programming</a>/<a href="#bottom" >Wrapping Virtual Destructors</a><br><br>
<a name="637948"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Gabriel</td><td align="right"><font class=tiny>(Posted 2006)</font>&nbsp;<a href="#1">[#1]</a></td></tr></table></td></tr><tr ><td class="posttext"> This one is kicking my butt a little. One of the TV3D classes I'm wrapping has a virtual destructor. I wrap it like this :<br><br><pre class=code>
extern "C" __cdecl void CTVMesh_Destroy(CTVMesh* Ha) {
	delete Ha;
}
</pre><br><br>But I get an access violation when I call it.<br><br>PLEASE NOTE THESE TWO THINGS :<br><br>1) The pointer is valid.<br><br>2) The actual code that's calling this is perfect. It's a straight BMax copy of a C++ demo which works fine.<br><br>So I'm quite certain that it's this virtual destructor which is getting in the way. I thought I could get around it by downcasting to the derived class, but apparently there are no public derived classes. The class is just a wrapper for some other internal stuff.<br><br>Anyway, the author has kindly offered to add another way of doing it if neither of us can come with a better solution. So I'm just posting here to see if anyone has a better solution before I ask him to add anything else. <br><br></td></tr></table><br>
<a name="638024"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Chris C</td><td align="right"><font class=tiny>(Posted 2006)</font>&nbsp;<a href="#2">[#2]</a></td></tr></table></td></tr><tr ><td class="posttext"> try putting the CTVMesh_Destroy call in the delete method of a max's type<br><br>it works fatastically well with my gui module... <br><br></td></tr></table><br>
<a name="638057"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Gabriel</td><td align="right"><font class=tiny>(Posted 2006)</font>&nbsp;<a href="#3">[#3]</a></td></tr></table></td></tr><tr ><td class="posttext"> Eh? Where I'm calling it from is not the problem. It's within the C++ snippet I've posted above that it crashes. <br><br></td></tr></table><br>
<a name="638075"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >gman</td><td align="right"><font class=tiny>(Posted 2006)</font>&nbsp;<a href="#4">[#4]</a></td></tr></table></td></tr><tr ><td class="posttext"> one thing to try at least would be to wrap it up with a quick validity check.<br><pre class=code>
extern "C" __cdecl void CTVMesh_Destroy(CTVMesh* Ha) {
	if (Ha)
		delete Ha;
}
</pre><br>if that works, then i would look at if its possible that its being called twice.  this of course assumes that in your code somewhere after calling this you are setting the handle back to null on the BMAX side. <br><br></td></tr></table><br>
<a name="638152"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Gabriel</td><td align="right"><font class=tiny>(Posted 2006)</font>&nbsp;<a href="#5">[#5]</a></td></tr></table></td></tr><tr ><td class="posttext"> It's in the Delete() Method as Chris suggests, so it can't be called more than once and the pointer is already nulled before the Delete() method gets called.<br><br>The pointer is valid, I've checked. I have also added the checking you suggest, just for testing purposes and it zips right past the error checking and crashed anyway. So I'm pretty sure it's the Destructor and not the pointer. <br><br></td></tr></table><br>
<a name="638164"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Gabriel</td><td align="right"><font class=tiny>(Posted 2006)</font>&nbsp;<a href="#6">[#6]</a></td></tr></table></td></tr><tr ><td class="posttext"> Sorry guys, I've been giving out wrong information. I changed the demo and forgot about it. I'll blame it on too many 5AM work sessions.<br><br>I don't create the object in my wrapper, it is returned from the method of another Class. EG:<br><br>MyObject2-&gt;CreateObject1() - returns the MyObject.<br><br>This apparently is what is making all the difference.<br><br>If I code the entire app in C++ I can delete it just fine. But not this way because another class in the DLL created it. Is there another way of deleting it? <br><br></td></tr></table><br>
<a name="638166"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >N</td><td align="right"><font class=tiny>(Posted 2006)</font>&nbsp;<a href="#7">[#7]</a></td></tr></table></td></tr><tr ><td class="posttext"> You could add delete code to the other class (assuming you have the option of doing so), for one.<br><br>Beyond that, I just don't think there's any way I can provide a better response. <br><br></td></tr></table><br>
<a name="638173"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Gabriel</td><td align="right"><font class=tiny>(Posted 2006)</font>&nbsp;<a href="#8">[#8]</a></td></tr></table></td></tr><tr ><td class="posttext"> I think I'm gonna give this up and wait for Sylvain to look into this. I've found another class which is created exactly the same way ( through another class ) and it can be deleted just fine. <br><br></td></tr></table><br>
<a name="bottom"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td align="right"><a href="http://monkeycoder.co.nz" target="_blank"><img src="/img/monkey2.svg" ></a> <a href="https://github.com/blitz-research" target="_blank"><img src="/img/github.svg" ></a> <a href="https://discord.gg/qJccbSp" target="_blank"><img src="/img/discord.svg" ></a></td></tr></table><br></div><br><table width="100%"><tr><td></body></html lang="en">
