<!DOCTYPE html><html lang="en" ><head ><title >Threads and Performance</title><meta name='viewport' content='width=device-width, initial-scale=0.66'><meta name='description' content='language:basic, target:desktop, category:game development'><link rel="styleSheet" href="../skins/granite/style.css" type="text/css"><style type="text/css">div.bbcode {padding: 8px;background: #E5E5E5;color: #000000;border: 1px dashed #B4B4BE;}</style></head><body ><table width=100% cellspacing=0 cellpadding=0><tr ><td class="menubarleft"></td><td class="menubar"><table cellspacing="0" cellpadding="0"><tr ><td >&nbsp;</td><td class="menuitemleft"></td><td class="menuitem"><a href="/" class="menuitem">News</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/forums.php" class="menuitem">Forums</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/codearcs.php" class="menuitem">Code</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/logs.php" class="menuitem">Logs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/gallery.php" class="menuitem">Gallery</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/sdkspecs.php" class="menuitem">Specs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/search.php" class="menuitem">Search</a></td><td class="menuitemright"></td></tr></table></td><td class="menubarright"></td></tr></table><div class="main"><h1 >Threads and Performance</h1><a href="forums.php" >BlitzMax Forums</a>/<a href="topics.php?forum=102" >BlitzMax Programming</a>/<a href="#bottom" >Threads and Performance</a><br><br>
<a name="930056"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Otus</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#1">[#1]</a></td></tr></table></td></tr><tr ><td class="posttext"> Ok, I took a first look at threads with the thought of using both cores of my Athlon X2 for a math intensive task. I compiled the same program in threaded mode without actually using threads. The task took 3x as long.<br><br>Am I right in assuming this is due to the other GC?<br><br>Thinking that is the case, I added GCSuspend/GCResume around the code. This cut down the time in both cases, but in the threaded build I got an error I haven't seen before: "Too many heap sections"<br><br>So... Threads should only be used to make the UI responsive? <br><br></td></tr></table><br>
<a name="930237"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >ImaginaryHuman</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#2">[#2]</a></td></tr></table></td></tr><tr ><td class="posttext"> Well, I think you are on the right track. The threaded garbage collector is slower than the default one. However, right now you're seeing the time increase by using the garbage collector without getting a second thread doing computations. Have you actually added a second thread, or even spawn 2 threads and let the main thread give time to the cpu (Delay())?<br><br>Generally speaking, on the whole, even if there is some overhead from using threads (and there is, garbage collector or not), you should be gaining much more computation time than you're losing. Also, are you compiling in debug mode? That'll be a lot slower than release mode. <br><br></td></tr></table><br>
<a name="930257"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >xlsior</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#3">[#3]</a></td></tr></table></td></tr><tr ><td class="posttext"> I'm definitely seeing a performance difference too on my computer:<br><br>My current program does a bunch of parsing on a large text files.<br>doing a bunch of operations on an array with 10,000 strings takes 0.8 seconds in the default mode, and if I switch over to the 'threaded build' (so no changes, just using the other garbage collector) the same code takes 6.5 seconds to complete.<br><br>I guess it just goes to show that you'll need to be selective in whether or not it makes sense to go threaded. Splitting up the code to run on two CPU cores doesn't necessarily make much sense if it still takes 4 times as long to complete. <br><br></td></tr></table><br>
<a name="930303"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >ziggy</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#4">[#4]</a></td></tr></table></td></tr><tr ><td class="posttext"> Code designed to work a on a single thread bmax compilation is usually slower on threaded mode. when the diference of time is this big, it usually means the code has to be redesigned, or optimized. Obviously if you're writing a threaded application from the begining, you would not be getting this issues. <br><br>As instance, a decent multi-threaded parser would implement a string stream (instead of working with 10000 strings!!!) to make the tokening. This string stream could be used to read from the same base string, from different threads, at the same time without any problems. This could make the parsing go faster than a single brute-force thread reading byte by byte.<br><br>I mean, making a threaded application is not just putting a parameter on the compiler, it is designing the application to be fast using multithread-based algorithms. If you're not going to use this kind of algorithms, I'm sure you can expect all kind of drawbacks and performance lost. <br><br></td></tr></table><br>
<a name="930332"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >ImaginaryHuman</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#5">[#5]</a></td></tr></table></td></tr><tr ><td class="posttext"> Yah you also need to consider things like cache access, if two threads are competing for memory time and are accessing it quite randomly to get the string data, that's going to be less efficient than when one thread is just going through contiguous memory.<br><br>I did personally notice some general slowdown when using a threaded version of an app. One thing to consider also is that although you may now be using 2 or more cpu cores, they still have to *share* the same memory bus. You aren't getting twice the performance in memory accesses. You could throw 16 cores at it but if they're all accessing the same memory each thread will be held up by memory accesses. I would also think that if you are doing operations that entail a lot of memory access - like working with strings, then memory is going to become a bottleneck and the cpu is going to be kept waiting. Also if the cpu's have to share the memory bus one is going to have to stall while the other one has bus access.<br><br>This is partly why the Cell processor gives local memory to each individual cpu core so they don't have to share bus accesses. <br><br></td></tr></table><br>
<a name="930362"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Otus</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#6">[#6]</a></td></tr></table></td></tr><tr ><td class="posttext"> ziggy:<div class="quote"> Code designed to work a on a single thread bmax compilation is usually slower on threaded mode. when the diference of time is this big, it usually means the code has to be redesigned, or optimized. Obviously if you're writing a threaded application from the begining, you would not be getting this issues. <br></div><br><br>The thing is, I didn't bother to try making it threaded. Even if I would have been able to halve the time taken by using two threads (unlikely), it would have been slower than unthreaded.<br><br>Note that my code was almost pure math and used one CPU almost 100%. For something like the parser you mention, there could be additional benefits from backgrounding memory access.<br><br>ImaginaryHuman:<div class="quote"> You could throw 16 cores at it but if they're all accessing the same memory each thread will be held up by memory accesses. I would also think that if you are doing operations that entail a lot of memory access - like working with strings, then memory is going to become a bottleneck and the cpu is going to be kept waiting. Also if the cpu's have to share the memory bus one is going to have to stall while the other one has bus access. <br></div><br><br>Isn't memory access rather fast these days? With DDR3 becoming popular, I don't think that will be such a huge bottleneck compared to using a single CPU core. They will probably not increase the speed of CPUs in the near future, but add more cores instead. Also, modern multi-cores have dedicated caches for each core and the sizes are increasing. <br><br></td></tr></table><br>
<a name="930393"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >ImaginaryHuman</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#7">[#7]</a></td></tr></table></td></tr><tr ><td class="posttext"> It doesn't matter how fast the memory is, if both threads have to share the same memory and they're both trying to do memory intensive tasks they are going to have to cooperate and share, which means each gets less time, possible only 50% as much time as they'd like. It doesn't matter even if your ram is super fast, two cores trying to access it at the same time has to be split. <br><br></td></tr></table><br>
<a name="930460"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Otus</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#8">[#8]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> It doesn't matter how fast the memory is, if both threads have to share the same memory and they're both trying to do memory intensive tasks they are going to have to cooperate and share, which means each gets less time, possible only 50% as much time as they'd like. It doesn't matter even if your ram is super fast, two cores trying to access it at the same time has to be split. <br></div><br><br>Yes, but that is only an issue if the program is limited by memory access speed. With faster memory and bus that is less likely. <br><br></td></tr></table><br>
<a name="930463"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >skn3</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#9">[#9]</a></td></tr></table></td></tr><tr ><td class="posttext"> Unless of course you have dual channel memory, as this would allow double the memory throughput! (supposedly)<br><br>Have you tried designing a "job" assignment thread setup. <br>EG:<br><br>Main core (or a new core designated as "the boss") assigns "chunks" of data as individual jobs. Threads can request a job and take the chunk of memory associated. The thread is then free to perform calculations on that job and return the info to the boss thread.<br><br>This would allow you to spawn multiple threads processing on your mathmatical problem.<br><br>As everyone else has said, you cant just expect a speed increase by moving an algorythm of some sort to a seperate thread. This is not logical and is not what threading is intended for. If however you wanted to run these mathmatical problems alongside say a graphical user interface or visual display, then threading is going to sky rocket in terms of performance.<br><br>Naturally you can expect a speed decrease as the system has to do a whole lot more. I wouldnt have thought such a drastic speed decrease though. <br><br></td></tr></table><br>
<a name="930505"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >ImaginaryHuman</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#10">[#10]</a></td></tr></table></td></tr><tr ><td class="posttext"> One thing I also noticed when I implemented a thread pool, is that I got less performance than expected. But what I didn't factor in was the way the o/s redistributes system threads. If I run a single threaded app it will hog all of the time of the core it runs on and all other threads seem to get shifted to the other core (with time to spare). So then I measure the time it takes and figure that I could double that when I move to multithreaded. But that's not true - the system threads and other threads still have to get their time. It ended up being more like adding an extra 60-70% cpu time by running a second thread in the pool, rather than a 100% speedup. That said, I expect if you had like 3 or more cores you would start to see a bigger speedup for each core you add since you aren't adding more system threads. <br><br></td></tr></table><br>
<a name="930569"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Space_guy</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#11">[#11]</a></td></tr></table></td></tr><tr ><td class="posttext"> I pulled my hair when i tried to make a game engine threaded. I just couldnt make it as smooth as it was with the non threadeed GC. <br>It seems no matter how i set up the garage collection it just continued being jerky. for example every 2 seconds the fps would drop to arround 20 from an otherwise steady 60. All i could do was to change abit how long it would take between these frame skips.<br><br>In the end i just decided it wasnt worth putting more time into until improvments are made to the GC or soeone else finds out how to use it better. <br><br></td></tr></table><br>
<a name="bottom"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td align="right"><a href="http://monkeycoder.co.nz" target="_blank"><img src="/img/monkey2.svg" ></a> <a href="https://github.com/blitz-research" target="_blank"><img src="/img/github.svg" ></a> <a href="https://discord.gg/qJccbSp" target="_blank"><img src="/img/discord.svg" ></a></td></tr></table><br></div><br><table width="100%"><tr><td></body></html lang="en">
