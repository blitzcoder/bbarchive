<!DOCTYPE html><html lang="en" ><head ><title >Threaded Performance and GC</title><meta name='viewport' content='width=device-width, initial-scale=0.66'><meta name='description' content='language:basic, target:desktop, category:game development'><link rel="styleSheet" href="../skins/granite/style.css" type="text/css"><style type="text/css">div.bbcode {padding: 8px;background: #E5E5E5;color: #000000;border: 1px dashed #B4B4BE;}</style></head><body ><table width=100% cellspacing=0 cellpadding=0><tr ><td class="menubarleft"></td><td class="menubar"><table cellspacing="0" cellpadding="0"><tr ><td >&nbsp;</td><td class="menuitemleft"></td><td class="menuitem"><a href="/" class="menuitem">News</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/forums.php" class="menuitem">Forums</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/codearcs.php" class="menuitem">Code</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/logs.php" class="menuitem">Logs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/gallery.php" class="menuitem">Gallery</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/sdkspecs.php" class="menuitem">Specs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/search.php" class="menuitem">Search</a></td><td class="menuitemright"></td></tr></table></td><td class="menubarright"></td></tr></table><div class="main"><h1 >Threaded Performance and GC</h1><a href="forums.php" >BlitzMax Forums</a>/<a href="topics.php?forum=102" >BlitzMax Programming</a>/<a href="#bottom" >Threaded Performance and GC</a><br><br>
<a name="1221481"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >BLaBZ</td><td align="right"><font class=tiny>(Posted 2014)</font>&nbsp;<a href="#1">[#1]</a></td></tr></table></td></tr><tr ><td class="posttext"> I know this topic has been visited before and I was just curious if there's a work around.<br><br>Problem:<br>The threaded Garbage Collector dramatically slows the game down upon collection.<br><br>Is there a way to force garbage collection\free memory of particular objects\variables? How would you reduce the amount of Garbage before the Garbage collector automatically is executed? <br><br></td></tr></table><br>
<a name="1221491"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Brucey</td><td align="right"><font class=tiny>(Posted 2014)</font>&nbsp;<a href="#2">[#2]</a></td></tr></table></td></tr><tr ><td class="posttext"> You could garbage collect more often so that there aren't so many things to collect in one go? <br><br></td></tr></table><br>
<a name="1221492"></a>

<a name="1221493"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >BLaBZ</td><td align="right"><font class=tiny>(Posted 2014)</font>&nbsp;<a href="#3">[#3]</a></td></tr></table></td></tr><tr ><td class="posttext"> Would this lock other threads? Does this have to be done on the main thread? <br><br>I wonder if it would make sense to have a concurrent thread that Garbage Collects every 5~ms.<br><br>Thanks for your input Brucey :) <br><br></td></tr></table><br>
<a name="1221498"></a>

<a name="1221499"></a>

<a name="1221500"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Yasha</td><td align="right"><font class=tiny>(Posted 2014)</font>&nbsp;<a href="#4">[#4]</a></td></tr></table></td></tr><tr ><td class="posttext"> I believe standard practice is to try as far as possible not to put yourself in a position where GC kicks in while you're being interactive:<br><br>-- enter the loading screen<br>-- GCCollect<br>-- allocate all resources for the area in advance<br>-- GCCollect again<br>(-- GCSuspend if you need to)<br>-- end load screen and enter level<br><br>During the level, try not to allocate any objects. Create all the things you intend to use in advance and pool them, hide them if they're graphical. When you need more visible interactive things, pull them from the pool and manually return them to it later.<br><br>The downside is that some library functions may be allocating small objects behind the scenes so you may be allocating objects anyway without noticing it: one possible hack is to turn off the GC altogether once you have all <i>your</i> stuff in place, and hope that the small objects allocated in the background don't add up to too much until the next suitable pause point where you can GCResume and force another collection.<br><br>(When I say "hope", what you should actually do is profile memory usage and see how often you need to insert "slow points" throughout a level where you can turn the GC on again, to keep the background buildup below an acceptable level.)<br><br>As long as you keep allocation and collection to "slow points" and loading screens, it won't have a noticeable effect for the end user and hopefully shouldn't matter if all threads lock.<br><br>Obviously this only works if your game can be structured around loading and clearing points, if you can predict roughly (order of magnitude) how many "things" are active during interactive periods, and if you are allocating a small-medium number of largish objects instead of a huge number of tiny objects. (If you are allocating a huge number of tiny objects, you could also investigate some kind of secondary pooling technique or a flyweight-style pattern to reduce the number of things passing through the GC in total.)<br><br><br><div class="quote"> I wonder if it would make sense to have a concurrent thread that Garbage Collects every 5~ms. <br></div><br>If a concurrent thread is force-collecting from all threads I would assume it does so by locking everything up, no? (I don't know offhand how the threaded GC <i>does</i> work, but it's neither incremental nor generational which I think are prerequisites for that to happen without stopping everything.) Can't hurt to try, of course - whatever profiles well, works. <br><br></td></tr></table><br>
<a name="1221503"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >BLaBZ</td><td align="right"><font class=tiny>(Posted 2014)</font>&nbsp;<a href="#5">[#5]</a></td></tr></table></td></tr><tr ><td class="posttext"> Hmm, that's what I was thinking and afraid of, I have a lot of code right now, altogether about 60-70k lines, there's a lot to sift through to make all local objects and variables pooled.<br><br>How is the Garbage Collector activated with\without threading? Is it random? For some reason I was convinced that without threading it was activated upon "Cls" <br><br></td></tr></table><br>
<a name="1221504"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Brucey</td><td align="right"><font class=tiny>(Posted 2014)</font>&nbsp;<a href="#6">[#6]</a></td></tr></table></td></tr><tr ><td class="posttext"> The garbage collector is activated on the creation of a new object.<br>It then decides if it needs to process any old objects for collection.<br><br>So, if you are pooling objects, and not creating any for a while, the GC won't be doing any work.<br>Of course, there's code *YOU* are in control of and the framework BlitzMax code which may be creating objects as you go - it all depends what stuff you are using. <br><br></td></tr></table><br>
<a name="1221506"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >BLaBZ</td><td align="right"><font class=tiny>(Posted 2014)</font>&nbsp;<a href="#7">[#7]</a></td></tr></table></td></tr><tr ><td class="posttext"> Is the GC activated for primitive data types? <br><br></td></tr></table><br>
<a name="1221507"></a>

<a name="1221508"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Yasha</td><td align="right"><font class=tiny>(Posted 2014)</font>&nbsp;<a href="#8">[#8]</a></td></tr></table></td></tr><tr ><td class="posttext"> No: by definition a primitive is something that isn't an object and doesn't need to be allocated by itself. The only primitives in BlitzMax are the various kinds of numbers and bytepointers. Strings and arrays are objects, not primitives. Any type you can "New" is GC'd; anything where "New" makes no sense (you can't create a new integer) is not, and takes up no space on its own.<br><br>Is this what you were thinking of? <br><br></td></tr></table><br>
<a name="1226395"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >fishy</td><td align="right"><font class=tiny>(Posted 2014)</font>&nbsp;<a href="#9">[#9]</a></td></tr></table></td></tr><tr ><td class="posttext"> Hi,<br><br>I know it's a discussed topic here, so i wanted to ask if there are any other alternatives for running threaded apps other than discussed?<br><br>I've tried to manage memory a bit more but it seems there is always going to be some added mem usage for displaying strings or other things you still have to do every frame. I even did a test to only render the mouse (2d plane using irrlicht) and even just rendering that seems to be adding something to memory each frame?<br><br>I'm not an expert with this but am working on a turn based strategy game and would really like the option for Threading for the AI turns and even precalculating moves while the player still has their go?<br><br>How BMax is at the moment in threaded mode at just the start of my game I get over a 100ms delay on garbage collection which is annoying and way too noticeable pause in rendering. This pause is just from the stuff i have in memory because i tested by removing everything from the main loop (ie. no rendering or updates what so ever) it will still pause for over 100ms but not clear anything from memory as nothing changed.<br><br>Is it possible to run an external C function in a separate thread that you pass all the data too that you want to calculate or could you realistically create a game (turn based would be easier i guess) where no memory is added at all unless moves\changes actually happen. at the moment it just seems adding strings together and drawing to screen or minimal other things seem to add to memory usage that needs to be collected within 10-20 secs at best?<br><br>I've put up a simple BMX test file (you can check out my project there too :) that you can see the issue if you compile threaded. You can also see if you turn off GC that the memory usage does keep increasing which I'm guessing is from the string usage? Maybe there is a way I can manage it better to minimize the issue?<br><br>Thanks for anyone that can have a look and provide any sort of feed that would be greatly appreciated!<br><a href="http://kwflgames.blogspot.com.au/p/downloads.html" target="_blank">http://kwflgames.blogspot.com.au/p/downloads.html</a> <br><br></td></tr></table><br>
<a name="1226419"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Brucey</td><td align="right"><font class=tiny>(Posted 2014)</font>&nbsp;<a href="#10">[#10]</a></td></tr></table></td></tr><tr ><td class="posttext"> Just because something is threaded doesn't mean it has to affect the performance of your application.<br><br>Rather than creating/destroying lots of objects constantly, you may be able to reuse objects by a means of pooling. For example, if you create lots of objects for things like particle effects, create a pool of them that you can take out and put back as necessary. By not creating those objects, you don't generate anything for the GC.<br><br>There are all kinds of ways to avoid unnecessary object creation. <br><br></td></tr></table><br>
<a name="1226453"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >fishy</td><td align="right"><font class=tiny>(Posted 2014)</font>&nbsp;<a href="#11">[#11]</a></td></tr></table></td></tr><tr ><td class="posttext"> Thakns for the reply Brucey, object pooling is something i was investigating and started to try, but i thought i should investigate it to make sure it will resolve\negate the issue to be worth modifying most of the code i'd already done.<br><br>What i noticed is even if i don't create new objects or destroy any each frame the GC would always take over 100ms with my current Game. I'm guessing this is because it searches through all the current memory to confirm if anything is in use, I'm not sure?<br><br>The example of this which i have in the BMXtest file i put up is load a bunch of stuff into memory, don't make any changes and run GC every few frames, you'll see it still takes 100ms - 200ms even though it doesn't need to clear anything from memory.<br><br>The way i could imagine pooling would still help is if you can get it so each frame no extra data is added to memory. If you could get this perfect then I could call the GC just when i'm processing turns or something which would be acceptable. The reason this doesn't look like it would work is because even just a basic example (as in the test file too) it would still be increasing mem usage each frame that needs to be cleared even when nothing is happening just rendering text to the screen, so it appears just the rendering function still adds data thats needs to be collected?<br><br>I hope that makes sense, let me know if any more clarification would be useful?<br><br>Thanks,<br><br><a href="http://kwflgames.blogspot.com.au/" target="_blank">http://kwflgames.blogspot.com.au/</a> <br><br></td></tr></table><br>
<a name="1226465"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >ziggy</td><td align="right"><font class=tiny>(Posted 2014)</font>&nbsp;<a href="#12">[#12]</a></td></tr></table></td></tr><tr ><td class="posttext"> if you do not create new objects, the GC won't fire. I can assure you this. Take into account that there are little actions (like iterating a list, concatenating strings, modifying array's size, etc.) that do generate garbage for the GC <br><br></td></tr></table><br>
<a name="1226492"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >fishy</td><td align="right"><font class=tiny>(Posted 2014)</font>&nbsp;<a href="#13">[#13]</a></td></tr></table></td></tr><tr ><td class="posttext"> Ah i wasn't sure about Iterating a list or things like that so that explains a bit thanks, Is that because if any object get assigned to a local variable it will have to be collected, but int's, bytes, etc don't need to be?<br><br>For example:<br>"For Local S:Ship = EachIn ShipList"<br>"Local S:Ship"<br><br>both these would require collection? Sorry just trying to fully understand how it works so I know the limits.<br><br>also just curious why the below would still be increasing memory usage as it's isn't using any strings or objects?<br><br><textarea class=codebox name="code" wrap=OFF readonly="true" rows="15" cols="80">

Local Time:Int = MilliSecs()
Local TimePassed:Int

Local CollectTime:Int

Local XMove:Int
Graphics(800, 600, 32, 60)
While Not KeyHit(KEY_ESCAPE)
	XMove = XMove + 1

	Cls
		
		If XMove &gt; WIDTH - 15 Then XMove = 0

		CollectTime = CollectTime + TimePassed
		
		If CollectTime &gt; 20000

			GCCollect()
			CollectTime = 0
		EndIf
		
		TimePassed = MilliSecs() - Time
		Time = MilliSecs()
			
		DrawText(GCMemAlloced(), 300, 40)
	Flip
Wend
</textarea><br><br>Thanks for the info so far!<br><br><a href="http://kwflgames.blogspot.com.au/" target="_blank">http://kwflgames.blogspot.com.au/</a> <br><br></td></tr></table><br>
<a name="1226495"></a>

<a name="1226496"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Brucey</td><td align="right"><font class=tiny>(Posted 2014)</font>&nbsp;<a href="#14">[#14]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> just curious why the below would still be increasing memory usage <br></div><br>DrawText is probably creating something for the GC to do. GCMemAlloced() is a number, which is converted to a String for DrawText. <br><br></td></tr></table><br>
<a name="1226503"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >ziggy</td><td align="right"><font class=tiny>(Posted 2014)</font>&nbsp;<a href="#15">[#15]</a></td></tr></table></td></tr><tr ><td class="posttext"> When you iterate a list with EachIn, an iterator object is created. If you iterate using the list nodes (prev, next, etc) you will avoid this. Also most string operations do generate string objects, and that's quite difficult to avoid if you happen to require text to be shown on screen. <br><br></td></tr></table><br>
<a name="1226571"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >fishy</td><td align="right"><font class=tiny>(Posted 2014)</font>&nbsp;<a href="#16">[#16]</a></td></tr></table></td></tr><tr ><td class="posttext"> Thanks guys, <br><br>It makes a lot more sense now and brings me to the conclusion that I don't think i can use MT for my game because of the slow down. The GC would probably still need to run every few seconds even if i clean up code and pool a lot of resources just from rendering strings, iterating lists and other memory usage that is required in my instance.<br><br>But just investigating this I have picked up quite a few optimization tricks and helped me understand some of the bad memory management the irrlicht module has that I can work around or even fix.<br><br><a href="http://kwflgames.blogspot.com.au/" target="_blank">http://kwflgames.blogspot.com.au/</a> <br><br></td></tr></table><br>
<a name="1226572"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Yasha</td><td align="right"><font class=tiny>(Posted 2014)</font>&nbsp;<a href="#17">[#17]</a></td></tr></table></td></tr><tr ><td class="posttext"> EachIn is convenient but not a gamebreaker by itself: any code using it should convert to a "dumb" integer- or TLink-based loop with only a small amount of messing about.<br><br>For strings, it might be worth looking into creating a DrawText implementation that reads from a mutable array of integers instead of a string (or in fact a mutable C string). That way, for very small, frequently-changing pieces of text like the GCMemAlloced display, you can modify the "string" in-place and not involve object allocation. Larger strings would need to be preallocated.<br><br>This is also perhaps a stupid question, but you are on the latest version of BlitzMax, right? Older versions of BlitzMax used a different GC for multithreading that really did scan the entire stack and heap, with potentially long pauses as a result; this has since been removed and it now uses something essentially similar to the single-threaded GC, which was supposed to eliminate observable pause times.<br><br><br>In the worst-case scenario you could always try using threads from a non-threaded build, too, but do bear in mind that doing so is <i>horribly unsafe</i> and you'd need to redesign your program to make sure your worker threads never used any objects, strings or arrays at all, for any purpose (i.e. integers, floats, and byte ptrs only). Threaded builds aren't about the threading, they're about making it safe. <br><br></td></tr></table><br>
<a name="1226577"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >GfK</td><td align="right"><font class=tiny>(Posted 2014)</font>&nbsp;<a href="#18">[#18]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> and brings me to the conclusion that I don't think i can use MT for my game because of the slow down <br></div>I've just reached the same opinion.  My game runs fine, mostly, but then every now and again it runs like a lame pig for a few seconds before catching up with itself.  I was baffled until I read this thread earlier and I'm now convinced it's no more than a GC issue.<br><br>So I'll be ripping out all the MT stuff tomorrow and trying to figure out some other way of doing what I started using it for in the first place. <br><br></td></tr></table><br>
<a name="1226581"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Derron</td><td align="right"><font class=tiny>(Posted 2014)</font>&nbsp;<a href="#19">[#19]</a></td></tr></table></td></tr><tr ><td class="posttext"> This all works as long as you do not try something like multiplayer (in the sense of network/online game).<br><br>Like written here some years ago: alt tabbing out of a game stops main threads. Potential solutions provided by users were not working in all cases. Don't know if current Windows (7 and 8) still have this behaviour as on Linux this wasn't a problem at all.<br><br>So if you need to have your app do something while "in background", you might need do to this in a separate thread.<br><br><br>bye<br>Ron <br><br></td></tr></table><br>
<a name="1226590"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Jur</td><td align="right"><font class=tiny>(Posted 2014)</font>&nbsp;<a href="#20">[#20]</a></td></tr></table></td></tr><tr ><td class="posttext"> In my experience MT garbage collector in BMax is problematic when working a lot with memory. I have an application which works perfectly  stable with normal gc but leaks memory when threaded gc is used (without using any threading code). I have tried to figure out what is the cause but gave up. <br><br></td></tr></table><br>
<a name="1226591"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >GfK</td><td align="right"><font class=tiny>(Posted 2014)</font>&nbsp;<a href="#21">[#21]</a></td></tr></table></td></tr><tr ><td class="posttext"> Same here, I'm hardly using any threading at all.  It isn't the threading that's the problem, it's the iffy GC that comes with it. <br><br></td></tr></table><br>
<a name="bottom"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td align="right"><a href="http://monkeycoder.co.nz" target="_blank"><img src="/img/monkey2.svg" ></a> <a href="https://github.com/blitz-research" target="_blank"><img src="/img/github.svg" ></a> <a href="https://discord.gg/qJccbSp" target="_blank"><img src="/img/discord.svg" ></a></td></tr></table><br></div><br><table width="100%"><tr><td></body></html lang="en">
