<!DOCTYPE html><html lang="en" ><head ><title >DirectX 9  Driver (*Updated*)</title><meta name='viewport' content='width=device-width, initial-scale=0.66'><meta name='description' content='language:basic, target:desktop, category:game development'><link rel="styleSheet" href="../skins/granite/style.css" type="text/css"><style type="text/css">div.bbcode {padding: 8px;background: #E5E5E5;color: #000000;border: 1px dashed #B4B4BE;}</style></head><body ><table width=100% cellspacing=0 cellpadding=0><tr ><td class="menubarleft"></td><td class="menubar"><table cellspacing="0" cellpadding="0"><tr ><td >&nbsp;</td><td class="menuitemleft"></td><td class="menuitem"><a href="/" class="menuitem">News</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/forums.php" class="menuitem">Forums</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/codearcs.php" class="menuitem">Code</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/logs.php" class="menuitem">Logs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/gallery.php" class="menuitem">Gallery</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/sdkspecs.php" class="menuitem">Specs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/search.php" class="menuitem">Search</a></td><td class="menuitemright"></td></tr></table></td><td class="menubarright"></td></tr></table><div class="main"><h1 >DirectX 9  Driver (*Updated*)</h1><a href="forums.php" >BlitzMax Forums</a>/<a href="topics.php?forum=102" >BlitzMax Programming</a>/<a href="#bottom" >DirectX 9  Driver (*Updated*)</a><br><br>
<a name="949636"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >DStastny</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#1">[#1]</a></td></tr></table></td></tr><tr ><td class="posttext"> New version Uploaded.<br><br>This version address two things.<br><br>1. Centering of Window Mode displays like the Dx7/Open GL Drivers like 1.32 Max drivers<br>2. Render Buffering(Input Lag)<br><br>I have included a demo application provided by GFK(thanks and hope you don't mind my including for others to test) that demonstrated the problem.  I have chosen a method that should minimize performance impacts.  The method as a result of a massive Google hunt and came down to what was recommend by both ATI and NVidia to address the issue.<br><br>The mechanims uses a Direct3D Device Query and I think(*hope*) should work on all hardware.  If not there is some additonal code in there that uses the DX7 driver method and if need be we can determine when to enable that code(big performance hit,  but if its all the hardware can do...)<br><br>This will slow down max FPS(6/7%) as we are preventing render buffering,, which is really a GPU/CPU concurrency issue, not so much buffering which is why it is so difficult to track down.<br><br>I have implemented a driver option that allows disabling of the functionality all together.(See the readme or samples, if it really is big issue)<br><br><br>At this time there are 2 items I think outstanding that I would like to address before callng this a 1.0 although as of right now I think on modern hardware this is pretty much as good as it can get.<br><br>1. MIPMAPPING - currently i utilize hardware mipmap generation,  I suspect there are still some crappy cards out there that dont support this. I am just lazy to write the code to generate MIPMAPs<br><br>2. VYSYNC - tearing here too I think there are issues with older hardware.  I am also not to happy with the current implemention.  The issue here really is change on part of direct X around Direct X 8 in that VSYNC is not option of present(BMAX Flip) but option on creation of the device.(BMAX Graphics)  To make this BlitzMax like I emlulate VSYNC on the BMAX Flip command.<br><br>Frankly I dont think this works well.  I think on final release,  I am going to make it option on the driver and ignore the Flip Flag.  What this means is you would set VSYNC on or off before calling the GRAPHICS command.<br><br>All feedback is appreciated.<br><br>Doug Stastny <br><br></td></tr></table><br>
<a name="949637"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >GW</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#2">[#2]</a></td></tr></table></td></tr><tr ><td class="posttext"> Cool,<br>did you fix the issue with using the dx9 driver causes your app to want to create a socket connection to some mystery address? <br><br></td></tr></table><br>
<a name="949648"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >GaryV</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#3">[#3]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> did you fix the issue with using the dx9 driver causes your app to want to create a socket connection to some mystery address? <br></div>That is likely DX itself and has little to do with the driver.  There are likely tips somewhere in a thread on how to disable DX phoning home on your system. <br><br></td></tr></table><br>
<a name="949653"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >DStastny</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#4">[#4]</a></td></tr></table></td></tr><tr ><td class="posttext"> @GW <br><br>GaryV is correct this has nothing to due with my driver. Feel free to examine the source.<br><br><br>Doug <br><br></td></tr></table><br>
<a name="949660"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >skidracer</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#5">[#5]</a></td></tr></table></td></tr><tr ><td class="posttext"> GW, type dxdiag from the command prompt and untick the Check for WHQL digital signatures on first page. <br><br></td></tr></table><br>
<a name="949794"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >GfK</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#6">[#6]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> I have included a demo application provided by GFK(thanks and hope you don't mind my including for others to test) that demonstrated the problem. <br></div>No probs.<br><br>Just tried the new version on my cruddy old test system - no lag whatsoever now. :) <br><br></td></tr></table><br>
<a name="949913"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >DreamLoader</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#7">[#7]</a></td></tr></table></td></tr><tr ><td class="posttext"> nice one <br><br></td></tr></table><br>
<a name="950212"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Tachyon</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#8">[#8]</a></td></tr></table></td></tr><tr ><td class="posttext"> The issues I have with this D3D9 driver are following. Note that none of these problems exist with the default OpenGL or D3D7 driver:<br><br>1) It doesn't seem to lock to VSYNC properly. On my 60hz LCD, carefully timed (60fps vsync'd) sequences using D3D7 and OGL work as expected, but run too fast under D3D9. For me to use D3D9, vsync needs to work like the default BMAX vsync.<br><br>2) I get a visible seam between two "seamless" textures used on a backdrop. Sorry, I can't post a screenshot.<br><br>3) On my custom GUI I use black lines, drawn with gradating ALPHA values, to give the appearance of drop shadows on menus and windows. These lines appear solid black under D3D9, not semi-transparent like they are under D3D7/OGL. It's like SetAlpha doesn't work with DrawLine or DrawRect. <br><br></td></tr></table><br>
<a name="950227"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >DStastny</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#9">[#9]</a></td></tr></table></td></tr><tr ><td class="posttext"> @Tachyon,<br><br>I appreciate the feedback. A CAPs dump of you video card would be helpful.<br><br><br><br>1) As for the VYSNC,  if you read my comments above i intend to change the functionality of it as the technique I use is not reliable across cards known issue on my part.  I would be interested to know are you setting up a time rate on the Graphics Command or just using Flip True/False and cards refresh rate. I suspect I cant read the Raster Scan line.  Probably unsupported on the card.<br><br>2)I have not seen this, but I am assuming you are tiling a Image? Is the image scaled?  Might be my concern about mipmapping. If your card cant do hardware mipmapping this might be doing it.<br><br>3) Can you give me a snippet on how you gradating the lines.   Are you drawing lines in a loop and dropping the alpha intensity.  Not sure here, my testing of Alpha blending seem to work. Any other blend modes active.<br><br>In any case sorry you can produce sample code as when people produce samples I can address the issues faster.  <br><br>If I can get your card caps that would be appreciated. <br><br>Doug <br><br></td></tr></table><br>
<a name="950233"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >DStastny</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#10">[#10]</a></td></tr></table></td></tr><tr ><td class="posttext"> @Tachyon alphablend bug confirmed. Thanks<br><br>I cant duplicate the tile issue with a seamless texture using TileImage.<br>Are you tiling the image yourself with DrawImage?<br><br>Fix for Alpha problem.<br><br>in Dx9Max2dGraphicsDriver.bmx<br><br>this<br><pre class=code>
	Method SetAlpha( alpha:Float )
		_Drawcolor=(Int(255*alpha) Shl 24)|(_Drawcolor&amp;$ffffff)
	End Method
</pre><br><br>to this<br><br><pre class=code>
	Method SetAlpha( alpha:Float )
		_Drawcolor=(Int(255*alpha) Shl 24)|(_Drawcolor&amp;$ffffff)
		' Set drawing verts colors
		_VerticesColor[VERTD]=_DrawColor
		_VerticesColor[VERTD+6]=_DrawColor
		_VerticesColor[VERTD+12]=_DrawColor
		_VerticesColor[VERTD+18]=_DrawColor		
	End Method
</pre><br><br>That was a booboo in 0.6 when I switched the way rendering worked.<br><br>Still trying to duplicate the seamless texture issue.<br><br>Thanks<br>Doug <br><br></td></tr></table><br>
<a name="950272"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Tachyon</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#11">[#11]</a></td></tr></table></td></tr><tr ><td class="posttext"> @DStastny:<br><br>My card is a GeForce GTX 280 (top-of-the-line card just 6 months ago). I always use the latest certified driver from nVidia. I'm sure you can find CAPs info online.<br><br>Regarding the seam, after playing with the tile image, it does appear to have something to do with the alpha transparency of the .png file I use. I have made some adjustments to the image and the seam went away. However, it should still be noted that the visible seam was not there under D3D7/OGL. <br><br></td></tr></table><br>
<a name="950276"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >DStastny</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#12">[#12]</a></td></tr></table></td></tr><tr ><td class="posttext"> @Tachyon<br><br>But based upon the generation it I do know it supports the CAPS i use.  What OS are you using and are you seeing the sync issue in Fullscreen or windows mode.  If in windows mode do you have any themes ?<br><br><br>As for the image interesting.. So you had alpha channel and were tiling an alpha blended image or solid blend?<br><br>As for the seam I believe you.  But you have to understand how difficult it is to find a rendering glitch if I cant duplicate the issue. <br><br>What are you using to make your PNG.  There might be issue in the texture loading although it pretty much uses the same pixmap code that Dx7/OGL uses. Hmmm<br><br>Thanks<br>Doug <br><br></td></tr></table><br>
<a name="951383"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Grisu</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#13">[#13]</a></td></tr></table></td></tr><tr ><td class="posttext"> Thanks for the module!<br><br>Can MaxGUI apps under XP or vista benefit from using this driver as well? <br><br></td></tr></table><br>
<a name="951484"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >DStastny</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#14">[#14]</a></td></tr></table></td></tr><tr ><td class="posttext"> @Grisu yest you can use the Driver wit MaxGUI.  There is a simple dumb example in the samples that shows two canvases in use.<br><br>I am working up the next update: which fixes the AlpahBlending bug, i posted fix for above as well as a reworked VSYNC mechanism that seems to be working pretty good.<br><br>Doug <br><br></td></tr></table><br>
<a name="951512"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Grisu</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#15">[#15]</a></td></tr></table></td></tr><tr ><td class="posttext"> Great!<br><br>The driver somehow "zoomes" the images displayed in a canavas.<br><a href="http://img15.imageshack.us/img15/4285/bild4r.jpg" target="_blank">See example image here.</a><br>Any idea why might cause this?<br><br>Apart from that the driver seems faster than the Dx7 one.. :o) <br><br></td></tr></table><br>
<a name="951515"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >DStastny</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#16">[#16]</a></td></tr></table></td></tr><tr ><td class="posttext"> @Grisu,  That looks like a bug on my part just not sure exactly what.<br><br>Is that dialog just a simple image in the picture? Or collection of images?  Using simple DrawImage.  <br><br>I see two canvas, are they both Graphics Canvas?  I defiantly see the right size image messed up but it looks like the left side is butchered up pretty bad.<br><br>If you have any sample mock up that duplicates it,  I should be able to quickly find and isolate the issue.  I suspect I am not handling something correctly when the canvases are sized.<br><br>I will see if I can make a more complex demo MAXGUI and track it down.  I will try to mock up what i see in your picture.<br><br><br>*EDIT*  I think I can duplicate it.  I have modified my example and definitely is not behaving the same way as DX7.  I should be able to figure it out.<br><br>Thanks for feedback<br><br>Doug <br><br></td></tr></table><br>
<a name="951523"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >DStastny</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#17">[#17]</a></td></tr></table></td></tr><tr ><td class="posttext"> @Grisu<br><br>Ok, I found it my test program pretty much sucked.  Both my canvases where the same size so I could not see the problem.  I missed the fact that each canvas had to reset the viewport and matrix with the SetGraphics calls so everything would skew all wonky depending on which view port was created first.<br><br>Will be fixed in next released.  I need to move some code around in the Max2d driver and clean it up.<br><br>Thanks for the picture and report!<br><br>Doug <br><br></td></tr></table><br>
<a name="951564"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Grisu</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#18">[#18]</a></td></tr></table></td></tr><tr ><td class="posttext"> You're welcome. <br><br>Ouch, you were faster than me posting some example code... ;(<br><br>Will retest the module when you're done. <br><br></td></tr></table><br>
<a name="954604"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >SLotman</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#19">[#19]</a></td></tr></table></td></tr><tr ><td class="posttext"> Just found a bug, that's really a show stopper:<br><br><img src="http://img.photobucket.com/albums/v431/SLotman/temp/dx9bug.png"><br><br>Same image, same code, the top one on dx9, the low one on dx7/opengl.<br><br>If I rescale things up or down (with setscale), images that didn't show this borders sometimes show it down or to the right, or as in this picture, on both sides (never on top-left) - the sample above shows this error when on 640x480 resolution, but on 800x600 it appears normally. On 1024x768 the problem appear once again.<br><br>The image above is 200 x 44. Enlarging it to 256 x 64 makes no difference at all. <br><br>Very strange problem...<br><br>Edit: Just noticed, seems to be something related to image filtering. Loading images with flag 0 (Loadimage "name",0) seems to fix the border problem, but images don't rescale very well... <br><br></td></tr></table><br>
<a name="954620"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >SLotman</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#20">[#20]</a></td></tr></table></td></tr><tr ><td class="posttext"> Don't know if this is a "correct" fix, but solved the problem here:<br><br>on TD3D9Max2DDriver, the DrawFrame method, just after:<br><br><pre class=code>
	Method DrawFrame( frame:TDX9ImageFrame,x0#,y0#,x1#,y1#,tx#,ty#)
		Local deviceTexture : TDx9DeviceTexture=frame._Dx9DeviceTexture
		Local p: Float Ptr= Varptr(deviceTexture._Vertices[0])
		Local d: Int Ptr = Int Ptr (p)

</pre><br><br>add this:<br><br><pre class=code>
		x1:+(0.3*_jx)
		y1:+(0.3*_jy)
</pre><br><br>And now I don't get black borders anymore!<br>I don't know why this fixes it, but it does... :) <br><br></td></tr></table><br>
<a name="954655"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >DStastny</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#21">[#21]</a></td></tr></table></td></tr><tr ><td class="posttext"> Hey Slotman,<br><br>If I read it right you are scaling the image down or up?  <br><br>Whats your video card again?  Are you using  MIPMAPPEDIMAGE flag when you load the image?<br><br>I think you are seeing the one part in the read me that I commented about not implementing yet, if the hardware does not support mipmapping, or there is minor difference in hardware mipmap generation vs software rendered.<br><br>Ill try to make an image up and see if I can duplicate and get off my lazy butt and fix mipmapping.<br><br>Doug <br><br></td></tr></table><br>
<a name="954695"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >SLotman</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#22">[#22]</a></td></tr></table></td></tr><tr ><td class="posttext"> Scaling both up and down. Let me clarify: I'm re-scaling my whole game according to user desktop resolution. It works fine on dx7-ogl, but on dx9 I was seeing those artifacts on some resolutions - mainly on 640x480 and 1024x768, which is both scaled down and above from "normal" (1:1) 800x600 resolution.<br><br>And no, I´m not using the MIPMAPPEDIMAGE. But using it (or MASKEDIMAGE, FILTEREDIMAGE, etc) doesn't solve it at all.<br><br>The only thing I got to remove the lines was to disable the image filtering (D3DTEXF_LINEAR -&gt; D3DTEXF_POINT) but then scaling images gets pretty bad; or the strange hack I posted above, which does work.<br> <br>I'm on a ATI Radeon X1300. <br>If it helps, here's my CAPS:<br><pre class=code>
Adapater Info
----------------------------------------------------------------
(removed so it won't kludge the thread)
</pre> <br><br></td></tr></table><br>
<a name="954773"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >DStastny</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#23">[#23]</a></td></tr></table></td></tr><tr ><td class="posttext"> Hmmm,<br><br>I think I might now whats going on since textures are loaded to power of 2.  There is a step that is done in the Dx7 driver I dont do, regarding smearing the edges of the textures.  Did not quite understand what that was doing.<br><br>The issues with your hack is fixing the issue as you are adjusting the coordinates by a partial pixel.  This has do do with how pixels are mapped to textual and alogorim is used.<br><br>Any chance you could post simple example on how you are calculating this scaling factor?  It would make it significantly easier for me to track down.<br><br>Thanks<br>Doug <br><br></td></tr></table><br>
<a name="954828"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >DStastny</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#24">[#24]</a></td></tr></table></td></tr><tr ><td class="posttext"> Well nope, its not what I thought.<br><br>I am stumped I cant seem to duplicate the problem.  Well I can if I intentionally start butchering the texels/mapping.<br><br>Are your images PNG by chance?  Can you post a link/email me the image you are using that demonstrates the problem?<br><br>Thanks<br>Doug <br><br></td></tr></table><br>
<a name="954845"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >DStastny</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#25">[#25]</a></td></tr></table></td></tr><tr ><td class="posttext"> @Slotman<br><br>I think I might have found it...<br><br>Replace these methods in the object TDx9DeviceTexture in <br><br>Dx9Max2dGraphicsDriver.bmx<br><br><textarea class=codebox name="code" wrap=OFF readonly="true" rows="15" cols="80">
	Method OnDeviceCreate()
		dxlog "Texture created"+Self.ToString()
		Local usage:Int=0
		Local level:Int=1
		If (_Flags&amp;MIPMAPPEDIMAGE) 
			usage=D3DUSAGE_AUTOGENMIPMAP
			level=0
		End If	
		Local hr:Int= _Driver._DXDriver.Direct3DDevice9().CreateTexture(_TextureWidth,_TextureHeight,level,usage,_TextureFormat,D3DPOOL_MANAGED,_Texture,Null)
'		Local hr:Int= _Driver._DXDriver.Direct3DDevice9().CreateTexture(_TextureWidth,_TextureHeight,level,usage,_TextureFormat,D3DPOOL_DEFAULT,_Texture,Null)
		If hr&lt;&gt;D3D_OK Then Throw "Failed to Create Texture:"+HR
		' lock the surface
		Local lockrect:D3DLOCKED_RECT=New D3DLOCKED_RECT
		If  _Texture.LockRect(0,lockrect,Null,0)&lt;&gt; D3D_OK
			_Texture.Release_
			_Texture=Null
			Throw "Failed to Lock Texture"
		End If		
		' Move the pixmap to offscreen surface
		Local sp:TPixmap=TPixmap.CreateStatic(lockrect.pBits,_TextureWidth,_TextureHeight,lockrect.Pitch,PF_BGRA8888)
		sp.Paste(_Pixmap,0,0)
		SmearEdges(lockrect,_TextureWidth,_TextureHeight)
		' unlock the surface
		_Texture.UnlockRect(0)
		' Texture ready		
	End Method
	
	' from DX7 driver clean up filtering artifacts on 
	' scaled textures
	Method SmearEdges(lockrect:D3DLOCKED_RECT,width:Int,Height:Int)
		Local	p:Byte Ptr
		Local	n:Int
		Local x:Int
		Local y:Int
		Local c:Int
		If _pixmap.Width&lt;&gt;Width
			n=1
			If _Flags &amp; MIPMAPPEDIMAGE n=Width-_pixmap.Width
			For y=0 Until _pixmap.Height
				p=lockrect.pBits+y*lockrect.Pitch
				c=Int Ptr(p)[_pixmap.Width-1]
				For x=0 Until n
					Int Ptr(p)[_pixmap.Width+x]=c
				Next
			Next
		EndIf
		If _pixmap.Height&lt;&gt;Height
			n=1
			If _Flags &amp; MIPMAPPEDIMAGE n=Height-_pixmap.height
			p=lockrect.pBits+(_pixmap.height-1)*lockrect.Pitch			
			For y=1 To n
				MemCopy p+y*lockrect.Pitch,p,Width*4
			Next
		EndIf
	End Method
</textarea><br><br>There was one method in the loading of textures in Dx7 driver I never quite understood what it did..... I think I know now.  I could not exactly duplicate what you where seeing in down scaling but up scaling I saw a similar artifact.  This change cleaned it up.  <br><br>Your comment on messing with filtering gave me the clue. <br><br>Please let me know if this cleans it up as I want to upload a an update that fixes a few other issues.  The stupid alpha bug mentioned above as well as MaxGUI Canvass problem.<br><br>I still have to update to latest release of Max...<br><br>Thanks for all the feedback and help you provided.  Let see if this addresses the issue.<br><br>Doug <br><br></td></tr></table><br>
<a name="954848"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Tachyon</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#26">[#26]</a></td></tr></table></td></tr><tr ><td class="posttext"> I wonder if this would fix my seam problem (post #8 above)? <br><br></td></tr></table><br>
<a name="954850"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >DStastny</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#27">[#27]</a></td></tr></table></td></tr><tr ><td class="posttext"> @Tachyon, <br><br>It might.  Lot of factors,  scaling, filtering, pixmap size, and to make it more fun video drivers and cards.<br><br>I know I fixed the alpha issue,  and I reworked the VYSYNC that should fix the other issue your reported.<br><br>This might be fix to seam problem.  What is the size of your tiles? Any scaling?<br><br>Doug <br><br></td></tr></table><br>
<a name="954851"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >SLotman</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#28">[#28]</a></td></tr></table></td></tr><tr ><td class="posttext"> Yup, that was the problem!<br><br>I was indeed using PNGs, and using this 'SmearEdges' fixed it :) <br><br></td></tr></table><br>
<a name="955717"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >GW</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#29">[#29]</a></td></tr></table></td></tr><tr ><td class="posttext"> Are all (or any) of these imports necessary in dx9graphics? why were they included?<br><br>Edit: I guess i should rephrase my question. I try to recompile the module to remove these auto imports I get the error "cannot find interface to 'brl.maxlua'<br><br>any ideas? <br>How can i restrict what bmax tries to import when doing a 'makemod' on this module?<br><br><pre class=code>
import brl.blitz
import pub.directx
import brl.graphics
import brl.linkedlist
import brl.appstub
import brl.audio
import brl.basic
import brl.bmploader
import brl.d3d7max2d
import brl.data
import brl.directsoundaudio
import brl.eventqueue
import brl.freeaudioaudio
import brl.freetypefont
import brl.gnet
import brl.jpgloader
import brl.map
import brl.maxlua
import brl.maxutil
import brl.oggloader
import brl.openalaudio
import brl.pngloader
import brl.retro
import brl.tgaloader
import brl.threads
import brl.timer
import brl.wavloader
import pub.freejoy
import pub.freeprocess
import pub.glew
import pub.macos
</pre> <br><br></td></tr></table><br>
<a name="955721"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >plash</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#30">[#30]</a></td></tr></table></td></tr><tr ><td class="posttext"> Wow. That is totally unnecessary. <br><br></td></tr></table><br>
<a name="955732"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Brucey</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#31">[#31]</a></td></tr></table></td></tr><tr ><td class="posttext"> Heh. Cool.<br><br>Are they actually part of an import list, or is that what you had to add to get it to compile?<br><br>Whenever you get that error "cannot find interface", it usually means your build is out-of-sync (assuming that everything else is correct).<br><br>If you are using someone else's pre-compiled module, you will generally need to have at least the brl+pub modules they have. Or you will see this.<br>If you don't, you will need to rebuild the module (you should be able to get away with only building the one).<br><br>From the BlitzMax/bin folder, you can run this command-line to do it :<br><pre class=code>
bmk makemods -a modulename
</pre><br>where "modulename" is the name of the module that you would Import - for example, bah.libxml<br>(I tried to look it up on the google code page, but the source isn't in the repository.. and I wasn't going to download the zip just to check that).<br><br>:o) <br><br></td></tr></table><br>
<a name="955763"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >DStastny</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#32">[#32]</a></td></tr></table></td></tr><tr ><td class="posttext"> None of those modules are directly referenced by the module.<br><br>I think Brucey is on to the problem as the module source zip is precompiled with 1.32 so you will need to rebuild the modules if you using a different version.<br><br> just type "bmk makemods -a dbs" and "bmk makemods -h dbs" if you want threaded versions.<br><br>Doug <br><br></td></tr></table><br>
<a name="955769"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >GW</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#33">[#33]</a></td></tr></table></td></tr><tr ><td class="posttext"> Sorry for the newbish question, I'm using 1.30.  Everything after that seems to have major issues. <br>Has there been changes to the bMax native DX9 stuff after 1.30 ?<br>What would cause this error.<br><br><pre class=code>
C:\Dev\BlitzMax\bin&gt;bmk makemods -a dbs
Compiling:d3d9caps.bmx
flat assembler  version 1.66
3 passes, 24675 bytes.
Compiling:GraphicsDx9.bmx
Compile Error: Identifier 'D3DADAPTER_IDENTIFIER9' not found
[C:/Dev/BlitzMax/mod/dbs.mod/dx9graphics.mod/GraphicsDx9.bmx;459;2]
</pre> <br><br></td></tr></table><br>
<a name="955798"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >DStastny</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#34">[#34]</a></td></tr></table></td></tr><tr ><td class="posttext"> As of 1.32 the directx9 headers have been made part of the official distribution so the module now imports the direct x references from the pub\directx module that is part of 1.32<br><br>The module is currently only compatible with 1.32 and above. <br><br> You could however back port the pub/directx module into the 1.30 modules and it should work correctly.<br><br>Doug <br><br></td></tr></table><br>
<a name="955808"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >GW</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#35">[#35]</a></td></tr></table></td></tr><tr ><td class="posttext"> Thanks for clear that up. <br><br></td></tr></table><br>
<a name="955829"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Dabhand</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#36">[#36]</a></td></tr></table></td></tr><tr ><td class="posttext"> Possible bug:-<br><br><pre class=code>
SuperStrict

Import dbs.d3d9max2d

SetGraphicsDriver D3D9Max2DDriver()
Graphics 640, 480

Local mx:Int
Local my:Int

Repeat
Cls
mx = MouseX()
my = MouseY()

SetAlpha(0.0)
DrawCrosshair(mx, my) '&lt;---Should be invisible
SetAlpha(1)
DrawText mx + ":" + my, 0, 0
Flip
Until KeyDown(KEY_ESCAPE)
End

Function DrawCrosshair(xp:Int, yp:Int)
	Const midspace:Int=28,size:Int=14
	
	SetLineWidth 3
	DrawLine xp-midspace,yp,xp-midspace-size,yp
	DrawLine xp+midspace,yp,xp+midspace+size,yp
	DrawLine xp,yp-midspace,xp,yp-midspace-size
	DrawLine xp,yp+midspace,xp,yp+midspace+size
End Function
</pre><br><br>The crosshair should become invisible due to the SetAlpha(0.0) command, but it stays as bright as a button?<br><br>Removing 'SetGraphicsDriver D3D9Max2DDriver()' and rolling back to the default driver fixes it, so obviously something is wrong.<br><br>Dabz <br><br></td></tr></table><br>
<a name="955897"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >DStastny</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#37">[#37]</a></td></tr></table></td></tr><tr ><td class="posttext"> It is a bug fixed up not uploaded yet.<br><br>see<br><a href="/posts.php?topic=84089#950233" target="_blank">Here</a> <br><br></td></tr></table><br>
<a name="955934"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Dabhand</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#38">[#38]</a></td></tr></table></td></tr><tr ><td class="posttext"> Oh, I see... I'll let it go then! :)<br><br>Dabz <br><br></td></tr></table><br>
<a name="956875"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Nigel Brown</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#39">[#39]</a></td></tr></table></td></tr><tr ><td class="posttext"> Using some example code I found, I am testing speed of writting to dual screens. When using the D3D9Max2DDriver I am getting unexplained errors, please give it a go:<br><br><pre class=code>
Import dbs.d3d9max2d

Local screen:TGraphics[2]
Local x:Double[2,2] , y:Double[2,2]
Global quit% = False

'SetGraphicsDriver GLMax2DDriver()
'SetGraphicsDriver D3D7Max2DDriver()
SetGraphicsDriver D3D9Max2DDriver()

EnablePolledInput()

screen[0] = CreateGraphics( 640, 480, 0, 60, 0 )
screen[1] = CreateGraphics( 640, 480, 0, 60, 0 )
x[0 , 1] = 1
y[0 , 1] = 1.5
x[1 , 1] = 1
y[1 , 1] = 1.5


AddHook systemEventHook , _hook

While Not quit
	
	For Local n = 0 To 1
	
		SetGraphics( screen[n] )
		
		x[n , 0] :+ x[n , 1]
		y[n , 0] :+ y[n , 1]
		If x[n , 0] &gt; GraphicsWidth() Or x[n , 0] &lt; 1 Then x[n , 1] = - x[n , 1]
		If y[n , 0] &gt; GraphicsHeight() Or y[n , 0] &lt; 1 Then y[n , 1] = - y[n , 1]
		Cls
		DrawText("O" , x[n , 0] , y[n , 0] )
		SetColor 255,n*255,n*255
		If KeyDown(KEY_SPACE) And n=1 Then DrawOval 0 , 0 , 640 , 480
		
		Flip
	Next
	
Wend

Function _Hook:Object(iId:Int,tData:Object,tContext:Object)
Local Event:TEvent = TEvent(tData)
If Event.ID &lt;&gt; EVENT_MOUSEMOVE Then Print "[" + Event.ID + "] " + Event.ToString()
If event = Null Then Return tData
	Select event.id
	Case EVENT_APPTERMINATE
		quit = True
	End Select
Return tData
End Function
</pre> <br><br></td></tr></table><br>
<a name="956887"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >DStastny</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#40">[#40]</a></td></tr></table></td></tr><tr ><td class="posttext"> @Nigel<br><br>I have to admit I did not even know you could do that that.  I have to think about how to make something like that work.<br><br>That would work fine with two MAXGUI windows since the windows are created externally and you have some control over the windows.<br><br>Just curious why would you do something like this?<br><br>I will be on vacation til end of May so I wont be able to look at it til the end of the month.<br><br>Thanks<br>Doug <br><br></td></tr></table><br>
<a name="956892"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Nigel Brown</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#41">[#41]</a></td></tr></table></td></tr><tr ><td class="posttext"> @DStastny<br><br>Thanks for the reply. I am developing a game that uses two monitors and this application does a good job of showing the consequence of using a non accelerated 2nd screen, just drag one of the windows to a second screen and watch how slow things become. I was hoping that DX9 did a better job than DX7 but not been able to test as yet. <br><br></td></tr></table><br>
<a name="957058"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >DStastny</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#42">[#42]</a></td></tr></table></td></tr><tr ><td class="posttext"> @Nigel<br><br>No problem on the reply.  As for performance degradation with Dx7 probably OpenGL as well and why Dx9 does not currently work, has to do with the way resources are managed with the underlying drivers and how textures etc are shared,  with a call to CreateGraphics .... there not. <br><br>Basically if you load an image and draw it on one Graphics Context then switch to another it disposes the one resource and reloads its.  So nothing is ever cached and it just thrashes resources  <br><br>With MAXGUI it uses the AttachGraphics call which sets up a shared context and that will not suffer that penalty.  Under this the DX9 Driver works fine as I actually tested this conceptually with Dx9 and recently committed a fix as I was not correctly reseting the projection matrix on switch.  <br><br> Dx9 will work significantly better than Dx7 as internally it setups separate swap chains for each window.   Dx7 creates one huge hidden back buffer and blits internally manages rendering to a sub region the size of the window.   I have not explored totaly how OpenGL works but most like creates a separate shared Opengl context for each DC (Device Context) of the window its attached.<br><br>I can probably make CreateGraphics work like Dx7/Dx9 but the internals of Texture management will suffer the same penalty.   Unless you create the images and ensure they are only rendered in the correct window.<br><br>I recommend you try using MaxGUI to create the windows and attach Canvases and think you get what your looking for as well as performance to boot.<br><br>Doug <br><br></td></tr></table><br>
<a name="957100"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Tommo</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#43">[#43]</a></td></tr></table></td></tr><tr ><td class="posttext"> I encounter the slow-down on my second monitor too. Not only with bmx, but also other games. Dx9 just performs the same.<br>I think it might be not a problem of the gfx API. I googled about it and find some similar reports, but no solution yet. <br><br></td></tr></table><br>
<a name="bottom"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td align="right"><a href="http://monkeycoder.co.nz" target="_blank"><img src="/img/monkey2.svg" ></a> <a href="https://github.com/blitz-research" target="_blank"><img src="/img/github.svg" ></a> <a href="https://discord.gg/qJccbSp" target="_blank"><img src="/img/discord.svg" ></a></td></tr></table><br></div><br><table width="100%"><tr><td></body></html lang="en">
