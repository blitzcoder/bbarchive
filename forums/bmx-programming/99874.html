<!DOCTYPE html><html lang="en" ><head ><title >decoupling logic and render</title><meta name='viewport' content='width=device-width, initial-scale=0.66'><meta name='description' content='language:basic, target:desktop, category:game development'><link rel="styleSheet" href="../skins/granite/style.css" type="text/css"><style type="text/css">div.bbcode {padding: 8px;background: #E5E5E5;color: #000000;border: 1px dashed #B4B4BE;}</style></head><body ><table width=100% cellspacing=0 cellpadding=0><tr ><td class="menubarleft"></td><td class="menubar"><table cellspacing="0" cellpadding="0"><tr ><td >&nbsp;</td><td class="menuitemleft"></td><td class="menuitem"><a href="/" class="menuitem">News</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/forums.php" class="menuitem">Forums</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/codearcs.php" class="menuitem">Code</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/logs.php" class="menuitem">Logs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/gallery.php" class="menuitem">Gallery</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/sdkspecs.php" class="menuitem">Specs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/search.php" class="menuitem">Search</a></td><td class="menuitemright"></td></tr></table></td><td class="menubarright"></td></tr></table><div class="main"><h1 >decoupling logic and render</h1><a href="forums.php" >BlitzMax Forums</a>/<a href="topics.php?forum=102" >BlitzMax Programming</a>/<a href="#bottom" >decoupling logic and render</a><br><br>
<a name="1174927"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Cruis.In</td><td align="right"><font class=tiny>(Posted 2013)</font>&nbsp;<a href="#1">[#1]</a></td></tr></table></td></tr><tr ><td class="posttext"> Hey guys I have been pouring over lots of timing methods and implementations and the like, and one thing I am not quite clear on is the decoupling.<br><br>So in a game which has Update which updates the x&amp;y movements of objects this is your logic and anything with inside a suitably named Render or draw method/function is your rendering.<br><br>So by decoupling, do I have to call all the Updates across all my types into one Function in the main loop placing that before a Render function calling all the rendering from all the classes?<br><br>Or is it decoupled so long as I do not update logic in the same function/method as I do rendering? <br><br></td></tr></table><br>
<a name="1174928"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >GNS</td><td align="right"><font class=tiny>(Posted 2013)</font>&nbsp;<a href="#2">[#2]</a></td></tr></table></td></tr><tr ><td class="posttext"> I have both ProcessTick() and Render() methods in my objects. <br><br>ProcessTick() handles all logic functions for that object (setting x/y positions, etc.). ProcessTick() runs at a fixed interval (i.e. 60 times per second or every ~16 milliseconds). ProcessTick() could also be named Update() or RunLogic() or whatever.<br><br>Render() handles all drawing functions for the object (calls to SetColor()/SetAlpha()/DrawImage(), etc.). Render() runs as fast as the player's GPU can draw the screen (potentially thousands of times per second). Render() could also be named Draw() or whatever.<br><br>In your main game loop you'll typically run a logic loop once every X milliseconds and then, in between that time, run multiple render loops. As an example, this is my game loop:<br><br><pre class=code>
Repeat
	Game.currentTickTime = MilliSecs() ' need to replace with hifi timer?
	
	While ((Game.currentTickTime - Game.lastTickTime) &gt; Game.TICK_TIME_MS)
		Game.ProcessTick()

		Game.lastTickTime :+ Game.TICK_TIME_MS
	Wend

	Game.Render()
Forever
</pre><br><br>In the above code, the 'Game' object is responsible for forwarding ProcessTick() and Render() calls down the chain to other, more specialized object managers (e.g. Game.ProcessTick() will call GUIManager.ProcessTick(), InputManager.ProcessTick(), etc.). <br><br></td></tr></table><br>
<a name="1174929"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Cruis.In</td><td align="right"><font class=tiny>(Posted 2013)</font>&nbsp;<a href="#3">[#3]</a></td></tr></table></td></tr><tr ><td class="posttext"> Thanks for the info I have some more queries. Going to throw in some more variables here.<br><br>My gfx card is pretty high spec and I'm prototypinga 2d spacey game, , without vsync the frames are around 600 fps. Then I create 150 ships graphics on screen. The frame now drops below 60 with that amount, is it possible then to increase/optimize that performance drop by decoupling the logic calls from the render as you did above? By updating the logic only once per loop or frame and leaving the render to update as often as possible?<br><br>How does decoupling the logic/render affect delta timing? <br><br></td></tr></table><br>
<a name="1174933"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >GNS</td><td align="right"><font class=tiny>(Posted 2013)</font>&nbsp;<a href="#4">[#4]</a></td></tr></table></td></tr><tr ><td class="posttext"> The main advantage to decoupling the logic from rendering is that it allows you to perform logic updates at a stable, predictable rate. This is important for certain things (like physics solvers). With something like delta timing your update rate is tied to your render rate, both of which vary from frame to frame. <br><br>There's a great article about the different types of game loops here: <a href="http://www.koonsolo.com/news/dewitters-gameloop/" target="_blank">http://www.koonsolo.com/news/dewitters-gameloop/</a><br><br>As for performance, you probably won't see much benefit from switching to a fixed logic rate. 150 ships doesn't sound like much, though. Does each ship have a unique image? <br><br></td></tr></table><br>
<a name="1174934"></a>

<a name="1174935"></a>

<a name="1174936"></a>

<a name="1174937"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Cruis.In</td><td align="right"><font class=tiny>(Posted 2013)</font>&nbsp;<a href="#5">[#5]</a></td></tr></table></td></tr><tr ><td class="posttext"> Each ship have a unique image? No<br><br>I switched to a fixed logic rate, it was kind of cool, I put all the logic updates from the types in the logic loop and the renders outside the logic loop<br><br><textarea class=codebox name="code" wrap=OFF readonly="true" rows="15" cols="80">
Global StartTime:Float = MilliSecs()
Global lasttime:Float 
Global current_time:Float
Global waittime:Float = 16
</textarea><br><br><br><textarea class=codebox name="code" wrap=OFF readonly="true" rows="15" cols="80">

	
While Not KeyHit(KEY_ESCAPE)
Cls		
	current_time= MilliSecs() - StartTime 
	
		While current_time - lastTime &gt; waittime
			all logical update code
			
			lasttime :+ waittime
	
		Wend

render render render

flip
wend
</textarea><br><br>game timing was exactly as I had left it, I put the wait time at 16, thats 16ms so that's good right? = to 60?<br><br>I turned off vsync and though the frames were over 600, it still ran nice and smooth as though I had on vsync. Nothing was changed.<br><br>But I get the slow down far sooner, if I put just 55-60 ships on screen as opposed to my 128 before I did the logic separation. <br><br></td></tr></table><br>
<a name="1174938"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >GNS</td><td align="right"><font class=tiny>(Posted 2013)</font>&nbsp;<a href="#6">[#6]</a></td></tr></table></td></tr><tr ><td class="posttext"> What happens if you only perform 30 updates per second (waittime = 33.333)? Does the framerate increase? <br><br></td></tr></table><br>
<a name="1174939"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Cruis.In</td><td align="right"><font class=tiny>(Posted 2013)</font>&nbsp;<a href="#7">[#7]</a></td></tr></table></td></tr><tr ><td class="posttext"> it sure does! just a sec <br><br></td></tr></table><br>
<a name="1174940"></a>

<a name="1174941"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Cruis.In</td><td align="right"><font class=tiny>(Posted 2013)</font>&nbsp;<a href="#8">[#8]</a></td></tr></table></td></tr><tr ><td class="posttext"> With waittime at 33.333 , it slows down below 60 begining at about 118 ships, almost what it was before I decoupled. So not much advantage eh.<br><br>can delta timing be applied with separated logic? <br><br></td></tr></table><br>
<a name="1174942"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Cruis.In</td><td align="right"><font class=tiny>(Posted 2013)</font>&nbsp;<a href="#9">[#9]</a></td></tr></table></td></tr><tr ><td class="posttext"> note that this slow down occurs whether the ships are on the viewing screen or not.<br><br>once it gets up to 100+ created. whether in my locale or not, which leads me to think its definitely the logic boggling down the game, and therefore my logic needs serious optimizing?<br><br>Or is 128 objects a lot. Doesn't seem so! Or is there something to be done about objects which have been created but which cannot be seen right now?<br><br>Also since I separated the logic and set it to 33.333 and got near the same result in fps when I created about 120, which is quite similar to the time it slows down before I decoupled the logic, it is safe to say I can keep the original implementation while hunting down the bottlenecking, and checking if I've improved anything by creating the amount of ship objects as I go to see if performance increases? <br><br></td></tr></table><br>
<a name="1174943"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >GNS</td><td align="right"><font class=tiny>(Posted 2013)</font>&nbsp;<a href="#10">[#10]</a></td></tr></table></td></tr><tr ><td class="posttext"> Does that trend continue as you increase the waittime? If you only do 10 updates per second (waittime = 100) or 5 updates per second (waittime = 200) what happens?<br><br>Seeing a framerate increase as a result of doing less logic updates per second typically points to your game being CPU-bound. I'd start looking at optimizing whatever is running during each Update() call or perhaps spreading the workload over multiple ticks (e.g. only update half of the A.I. bots each tick). <br><br></td></tr></table><br>
<a name="1174944"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Cruis.In</td><td align="right"><font class=tiny>(Posted 2013)</font>&nbsp;<a href="#11">[#11]</a></td></tr></table></td></tr><tr ><td class="posttext"> I see, does it also help to know that when I get the stutter the cpu usage is still only at 30%? Does that still indicate a bottleneck in the code? I would have thought the cpu would be near 100. <br><br></td></tr></table><br>
<a name="1174945"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Cruis.In</td><td align="right"><font class=tiny>(Posted 2013)</font>&nbsp;<a href="#12">[#12]</a></td></tr></table></td></tr><tr ><td class="posttext"> I am running in windowed mode btw <br><br></td></tr></table><br>
<a name="1174946"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Cruis.In</td><td align="right"><font class=tiny>(Posted 2013)</font>&nbsp;<a href="#13">[#13]</a></td></tr></table></td></tr><tr ><td class="posttext"> at 200 waittimer, the fps isn't going much beyond 600, but it goes down far less, i can add hundreds of ship objects. However at 200 wait timer which is 5 updates a second, I can't 'play' much. <br><br></td></tr></table><br>
<a name="1174947"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Jesse</td><td align="right"><font class=tiny>(Posted 2013)</font>&nbsp;<a href="#14">[#14]</a></td></tr></table></td></tr><tr ><td class="posttext"> did you try running it on release mode?<br>how big are your images? <br>it might be using all of your video memory(not video ram), and it will start moving files from the video area to video ram. which will cause slowdown of graphics display. <br><br></td></tr></table><br>
<a name="1174948"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >GNS</td><td align="right"><font class=tiny>(Posted 2013)</font>&nbsp;<a href="#15">[#15]</a></td></tr></table></td></tr><tr ><td class="posttext"> Definitely sounds like it's time to optimize things. You'll probably need to pinpoint exactly what's causing the slowdown by benchmarking/profiling the code somehow. <br><br></td></tr></table><br>
<a name="1174949"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Cruis.In</td><td align="right"><font class=tiny>(Posted 2013)</font>&nbsp;<a href="#16">[#16]</a></td></tr></table></td></tr><tr ><td class="posttext"> I want to thank you very much for helping me....<br><br>I just created 1000 objects, and kept going until I couldn't create anymore lol........... I found my bottleneck<br><br>There was a drawtext in the enemy update...for all enemies in the list 'drawtext' the text was drawing the amount of ship objects created. As held in a countlist variable which used countlist.<br><br>I guess it was layering over like hundreds of drawtext commands.....plus constantly drawing them, i have to assume then that drawtext is a VERY slow command. Since apparently I can have annd draw thousands of objects on screen at once with no drop in frame rate, but with the drawtext there, it bogs at 150+<br><br>When I noticed the slowdown I was playing around with various timing methods, and believing my own wasn't any good or suitable in the long run, I started doing these tests. So then I created the thread to help me understand the various methods particularly what is meant by separation.<br><br>I guess I got two things with one stone, I do understand far more about the timing and separation than I did before, great to learn for myself that stuff, and I found and removed something which was slowing me down, and I realized in the end it was not related to my timing.<br><br>I would have removed the drawtext in the end, it is only there for debugging purposes. But perhaps I should put all my debugging text in the debug function instead of throwing it in where I feel like just to see a number quickly.<br><br>what do you think? <br><br></td></tr></table><br>
<a name="1174952"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Cruis.In</td><td align="right"><font class=tiny>(Posted 2013)</font>&nbsp;<a href="#17">[#17]</a></td></tr></table></td></tr><tr ><td class="posttext"> This could cause a slow down too right? suppose if I put 1000 ships on screen , then launch a torpedo whereby in my collision function I am checking for collision against each of those ships, from the time I launch a torpedo it begins checking for collision between it and each of those 1000 ships until the torpedo is removed by age...<br><br>Because that was my next test, 1000 ships and fired a torpedo. Frames drop bad, and the frames dont even drop when I have created 2000 ship objects on screen. <br><br></td></tr></table><br>
<a name="1174955"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >GNS</td><td align="right"><font class=tiny>(Posted 2013)</font>&nbsp;<a href="#18">[#18]</a></td></tr></table></td></tr><tr ><td class="posttext"> DrawText can be slow, especially if it's being called hundreds of times per frame. It has a particularly bad way of rendering glyphs. A custom bitmap font system that renders text from a single texture atlas via DrawSubImageRect() would be better. <br><br>Collision will also be a major bottleneck if it's not handled properly. In the example you posted above, you'd probably want to do multiple 'early-out' checks of increasing complexity before actually testing for pixel-perfect collision. Here's some pseudo-code to illustrate:<br><br><pre class=code>
for each ship in the game
	' check distance of each ship to torpedo, if they are far enough away to never be in
	' danger of being hit, move on to the next ship
	if (ship distance to torpedo) &gt; "safe distance"
		continue
	
	' if the ship is moving away from the torpedo, or at an angle that ensures it will
	' never be hit, then move on to the next ship
	if (ship is moving away (or perpendicular to) the torpedo)
		continue

	' perform a simple distance check to see if the torpedo is within collision distance
	' if it is then we can perform a more accurate collision test to see exactly where/if
	' the torpedo is going to hit
	' this could also be combined with the first test above
	if (ship distance to torpedo) &lt;= "max size of ship"
		
		' now perform the more costly pixel-perfect collision test
		if (ship collides with torpedo) then do something
	endif
next
</pre> <br><br></td></tr></table><br>
<a name="1174959"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Banshee</td><td align="right"><font class=tiny>(Posted 2013)</font>&nbsp;<a href="#19">[#19]</a></td></tr></table></td></tr><tr ><td class="posttext"> Excuse me if I missed it as I'm on my mobile ATM, but the purpose of decoupling is not to magically make everything faster. Unless you use threads...<br><br>Also, you don't have to run the entire logic cycle every update. I have 1000 of units moving in my own game in dev by being very selective how often I run the slow stuff. <br><br></td></tr></table><br>
<a name="1175002"></a>

<a name="1175003"></a>

<a name="1175008"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Cruis.In</td><td align="right"><font class=tiny>(Posted 2013)</font>&nbsp;<a href="#20">[#20]</a></td></tr></table></td></tr><tr ><td class="posttext"> I think threads would be a new area for me again :)<br><br>by the slow stuff you mean stuff which x y do not move around much? I guess the same for fixed stuff too.<br><br>So you put some of your slower stuff in a separate loop and lower the update time ? So multiple logic loops?<br><br>@GNS strangely enough I had immediately thought to do that when thinking on the collision issue. Especially since pixel perfect collision will be being tested whether the objects are thousands upon thousands of units away or not.<br><br>So I guess in the for each in loop comparing the list of projectiles and ships I can measure the distance between each ship and each projectile.<br><br>Any other tips on eliminating bottle necks, I mean from avoiding particular bad practices and traps, or is that a whole nother thread? :) <br><br></td></tr></table><br>
<a name="1175011"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >ima747</td><td align="right"><font class=tiny>(Posted 2013)</font>&nbsp;<a href="#21">[#21]</a></td></tr></table></td></tr><tr ><td class="posttext"> A couple things that might be helpful<br><br>When checking your logic always check for recursive things, and redundant list scans. e.g. if your ship logic looks at every other ship from every single ship,then every pass you're iterating over ships(squared) so each ship will cause exponential scanning growth. May be required, or may be an easy optimization depending on what you're doing obviously.<br><br>Think about what each object has to do given some easy to calculate factors. You may be able to use that to create simplified branching logic that could greatly speed up the game in certain situations. E.g. if when a ship is more than 300 units away from the player does it really need to think about it's weapons? can it just try to move towards the player in that instance? or better yet if it's far enough away can it be ignored all together. that is really common in infinite space games, generally on screen is full logic, off screen is logic to try to make it get on the screen and beyond a certain point is just ignored. further you can simplify those "distance" checks by cutting the world space into a grid and only even processing distance on grid units within a certain range of the player meaning everything outside just gets skipped. you can then optimize *that* by actually sorting the ships by the grid unit they're in so you literally only check the ships in grids that might be relevant, and then it's just a simple check to have them shuffle closer to the player. you can effectively cut out HUGE expensive code passes by finding a good way to ignore things that aren't interesting at the moment.<br><br>Regarding threading: I'm a huge fan of threading, but as with all my mentions of threading a) it's tricky b) prone to bugs c) there are a few inherent glitches with it's implementation in bmax and d) it's always best when it's designed in from the beginning rather than things adapted for it. That is said as a friendly warning, not to discourage you, just be prepared for some real head scratchers :) personally in your position I would look into optimization first since you're already finding bottlenecks and threading won't solve those, just move them and make them harder to identify moving forward. <br><br></td></tr></table><br>
<a name="1175051"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Cruis.In</td><td align="right"><font class=tiny>(Posted 2013)</font>&nbsp;<a href="#22">[#22]</a></td></tr></table></td></tr><tr ><td class="posttext"> thank for the suggestions ima747<br><br>What if some objects are on screen close to the player and others are far off? Once I call to update one set all will update, I guess this is where I separate the lists containing enemy ships into sensible different lists then?<br><br>As for the loop, if I am interpreting you correctly, I should have several subdivisions each containing only the required logic for that particular set of prevailing circumstances. Then based on the parameters, each loop will only activate once their parameter is met.<br><br><br>Main<br>while // Main loop<br><br>while objects near // 1st condition checker<br>*do all logic*<br>wend<br><br>while objects far // 2nd condition<br>*do necessary logic only*<br>wend<br><br>RenderALL<br><br><br>Wend // end of main loop<br><br>So the second loop doesn't update any other logic because its far off.<br><br><br>While I am understanding it a lot I must be missing the associated techniques with doing it. Since again let's say I am in Home space, and home space is about 10k * 10k units. Five ships patrolling home space are near to me, and the rest are not, but each of the ships patrolling home space is in one list. If the main logic loop activates, it'll be processing even the far ones.<br><br>Or wait, is the solution then to check each individually...hmm so use a for eachin loop to iterate through the enemy shiplist, then IF NEAR, with near being less than X units, let each enemy ship object call its own update logic method. <br><br>And that for/next could go around the update for the enemy ships only, not anything else. So it'll only update the individual objects near to me.<br><br>Am I thinking this through right? <br><br></td></tr></table><br>
<a name="bottom"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td align="right"><a href="http://monkeycoder.co.nz" target="_blank"><img src="/img/monkey2.svg" ></a> <a href="https://github.com/blitz-research" target="_blank"><img src="/img/github.svg" ></a> <a href="https://discord.gg/qJccbSp" target="_blank"><img src="/img/discord.svg" ></a></td></tr></table><br></div><br><table width="100%"><tr><td></body></html lang="en">
