<!DOCTYPE html><html lang="en" ><head ><title >Pixmap to Image: resource usage</title><meta name='viewport' content='width=device-width, initial-scale=0.66'><meta name='description' content='language:basic, target:desktop, category:game development'><link rel="styleSheet" href="../skins/granite/style.css" type="text/css"><style type="text/css">div.bbcode {padding: 8px;background: #E5E5E5;color: #000000;border: 1px dashed #B4B4BE;}</style></head><body ><table width=100% cellspacing=0 cellpadding=0><tr ><td class="menubarleft"></td><td class="menubar"><table cellspacing="0" cellpadding="0"><tr ><td >&nbsp;</td><td class="menuitemleft"></td><td class="menuitem"><a href="/" class="menuitem">News</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/forums.php" class="menuitem">Forums</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/codearcs.php" class="menuitem">Code</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/logs.php" class="menuitem">Logs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/gallery.php" class="menuitem">Gallery</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/sdkspecs.php" class="menuitem">Specs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/search.php" class="menuitem">Search</a></td><td class="menuitemright"></td></tr></table></td><td class="menubarright"></td></tr></table><div class="main"><h1 >Pixmap to Image: resource usage</h1><a href="forums.php" >BlitzMax Forums</a>/<a href="topics.php?forum=102" >BlitzMax Programming</a>/<a href="#bottom" >Pixmap to Image: resource usage</a><br><br>
<a name="1022451"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rozek</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#1">[#1]</a></td></tr></table></td></tr><tr ><td class="posttext"> Hello!<br><br>Whenever I convert a pixmap to an image or unlock a previously locked dynamic image, I face the problem that<br><br>- this operation is incredible slow and<br>- the process is leaking memory<br><br>Is there anything I can do in order to avoid the memory leak (and reduce the processor requirements)?<br><br>Thanks in advance for any hint! <br><br></td></tr></table><br>
<a name="1022452"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >ima747</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#2">[#2]</a></td></tr></table></td></tr><tr ><td class="posttext"> What are you doing to convert pixmap to image exactly? Can you make an example? <br><br></td></tr></table><br>
<a name="1022493"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rozek</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#3">[#3]</a></td></tr></table></td></tr><tr ><td class="posttext"> Examples<br><pre class=code>lockImage(anImage)
...(use Cairo to draw on the image)
unlockImage(anImage)</pre><br>or<br><pre class=code>...(use Cairo to draw on a pixmap)
anImage = loadImage(aPixmap)</pre><br>It's NOT Cairo, which causes the problems, but "unlockImage" or "loadImage" <br><br></td></tr></table><br>
<a name="1022512"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >ima747</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#4">[#4]</a></td></tr></table></td></tr><tr ><td class="posttext"> Hmm I'm unfamiliar with Cairo so I'm afraid this is as far as I can help in that regard. What happens if you build your image off a copy of the pixmap instead of the actual pixmap from cairo? <br><br></td></tr></table><br>
<a name="1022514"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rozek</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#5">[#5]</a></td></tr></table></td></tr><tr ><td class="posttext"> Well,<br><br>meanwhile, I got rid of the memory leak by more aggressive GLTexture deletion (see at the end of <a href="http://www.blitzmax.com/Community/posts.php?topic=89912)." target="_blank">http://www.blitzmax.com/Community/posts.php?topic=89912).</a> My Cairo drawing sequence works as follows<br><br> - Pixmap = createPixmap(320,480,PF_BGRA8888) &lt;&lt;&lt; is done once, then cached<br> - Surface = TCairoImageSurface.CreateFromPixmap(Pixmap) &lt;&lt;&lt;  is done once, then cached<br> - Cairo = TCairo.create(Surface) &lt;&lt;&lt;  is done once, then cached<br><br>what's done repeatedly is<br><br> - Cairo.createContext()<br> - ... draw something<br> - Cairo.destroy()<br> - Image = loadImage(self.Pixmap)<br><br>The image is then actually drawn on screen.<br><br>This approach is  performing awfully (it's great without "loadImage", but then nothing is shown on the screen) It's definitely the "image" step which costs a lot of performance... <br><br></td></tr></table><br>
<a name="1022519"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >ima747</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#6">[#6]</a></td></tr></table></td></tr><tr ><td class="posttext"> just out of curiosity, what happens if you user DrawPixmap instead of DrawImage? still massively slow (would imply to me it's the access to the pixmap itself) or speedyish (I believe drawpixmap is much slower than drawimage, but haven't ever really bothered to test, so it shouldn't be as fast as a timage, but it shouldn't be MASSIVELY slow...).<br><br>what happens if you do something along these lines<br><pre class=code>
...
Cairo.destroy()
local tempPixm:TPixmap = self.Pixmap.Copy() ' see if this line is crazy slow
Image = loadImage(tempPixm) ' or maybe it's slow here
</pre> <br><br></td></tr></table><br>
<a name="1022550"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rozek</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#7">[#7]</a></td></tr></table></td></tr><tr ><td class="posttext"> Logan,<br><br>using drawPixmap is as slow as using loadImage/drawImage.<br><br>Copying the Pixmap does not cost much, drawing an Image is quite cheap as well - thus, it's definitely the "loadImage" step (in my understanding, "drawPixmap" internally also generates an Image) <br><br></td></tr></table><br>
<a name="1022553"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Brucey</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#8">[#8]</a></td></tr></table></td></tr><tr ><td class="posttext"> Drawpixmap on GL is heavily driver dependent. There are much better ways to do the equivalent than those particular GL calls used.<br><br>Drawimage should be relatively quick. It depends how big your pixmap data is (if you are refreshing the texture every draw) <br><br></td></tr></table><br>
<a name="1022555"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rozek</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#9">[#9]</a></td></tr></table></td></tr><tr ><td class="posttext"> Brucey,<br><br>in my case, the Image is 480x320x4 bytes = 614400kB or 153600 32bit words. And, yes, I might have to refresh the Image quite often (up to 30 times/sec) = 18.4 MB/sec<br><br>What about the performance of "loadImage"? Do you expect loadImage/drawImage to perform better than drawPixmap? <br><br></td></tr></table><br>
<a name="1022594"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rozek</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#10">[#10]</a></td></tr></table></td></tr><tr ><td class="posttext"> Good morning!<br><br>I still suffer from the poor performance of my pixmap/image drawing...<br><br>Is there any recommendation for the Pixmap type on an Intel-based system? Currently, I am using<pre class=code>Pixmap = createPixmap(320,480,PF_BGRA8888)</pre>which works, but slowly. If I try<pre class=code>Pixmap = createPixmap(320,480,PF_RGBA8888)</pre>my application runs much(!) faster...but either the Cairo drawing sequence or the loadImage/drawImage sequence produces no output (have not yet checked where the problem is). The same applies to "PF_STDFORMAT".<br><br>Are there any recommendations? <br><br></td></tr></table><br>
<a name="1022597"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Tommo</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#11">[#11]</a></td></tr></table></td></tr><tr ><td class="posttext"> LoadImage will automatically convert input pixmap into PF_RGBA8888, and do some extra things over that pixmap(like make texture 2-power sized + smear its edges, build mipmaps if MIPMAPIMAGE flag is set), then upload it to GL Texture. It will cost quite a while if it has to do all those process jobs. <br><br></td></tr></table><br>
<a name="1022602"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rozek</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#12">[#12]</a></td></tr></table></td></tr><tr ><td class="posttext"> Tommo,<br><br>thanks for the explanation of "loadImage" - it gives me some more ideas to experiment with!<br><br>Are you certain about the format (PF_RGBA8888)? Because, if I prepare the Pixmap (and use the same format) everything runs much faster - but produces no output! But, well, perhaps I have to check if the "no output" phenomena stems from Cairo...<br><br>EDIT: yes, you can be certain - disabling the Cairo drawing stuff, changing from PF_BGRA8888 to PF_RGBA8888 makes my program 3(three!) times faster!!!! Unfortunately, however, Cairo then produces no output any longer...will have to ask Brucey what I can do next<br><br>EDIT: meanwhile I experimented with two pixmaps: PF_BGRA8888 for Cairo and PF_RGBA8888 for displaying (with "convertPixmap" in between) - but ended up with the same poor performance than before :-(<br><br>EDIT: I even wrote my own conversion routine but could speed it up only slightly - thus, it's definitely the format conversion which performs so poorly!<br><br>For those interested in my pixmap format conversion (from PF_BGRA8888 to PF_RGBA8888 or vice-versa), here is my code:<pre class=code>local i:int
local Src:int ptr = int ptr(PixmapPixelPtr(SrcMap))
local Dst:int ptr = int ptr(PixmapPixelPtr(DstMap))
local Pixel:int
for i = 0 to 320*480-1
  Pixel = Src[i]
  Dst[i] = (Pixel &amp; $FF00FF00) | ((Pixel &amp; $00FF0000) shr 16) | ((Pixel &amp; $000000FF) shl 16)
next
</pre>Both bitmaps have the size 320x480 pixels in this case. The "trick" is using "int ptr"s and doing some bit masking and shifting. If you access byte by byte you end up with the same performance as the built-in conversion routine (because the internal conversion routine uses byte-wise access)<br><br>EDIT: another note: of course, you could even do the format conversion "in-situ" (i.e. using the same pixmap as Src and Dst, but "loadImage" would still assume the old (and slow) pixmap format and convert the pixmap again - unless you find a way to change the Pixmap format setting "on-the-fly" to the one needed for Cairo or loadImage, resp.<br><br>EDIT: strange...changing an pixmap#s format is actually quite simple: just access the "format" field of the pixmap. Trying so (and converting the pixmap "in-situ"), however, ended up with even (significantly!) worse performance than before (i.e. when I used two pixmaps). I would have assumed a slightly better performance, though<br><br>Nevertheless: thanks a lot for your hint! <br><br></td></tr></table><br>
<a name="1022626"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rozek</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#13">[#13]</a></td></tr></table></td></tr><tr ><td class="posttext"> Hmmm,<br><br>it seems as if I would have to live with the necessary conversion from BGRA to RGBA (damn...I hate wasting processor cycles!)<br><br>Does anybody assume that or has an idea one could speed up the conversion somehow? Could C be somewhat faster? Or the use of assembler with special Intel CPU commands? Or even with the benefit of OpenGL?<br><br>Without that horrible conversion my program runs three times faster!!!!! <br><br></td></tr></table><br>
<a name="1022631"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rozek</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#14">[#14]</a></td></tr></table></td></tr><tr ><td class="posttext"> Ok, forget everything!<br><br>Just for curiosity, I recompiled my application without debugging support...and it became so incredibly must faster (factor 6) that it's no longer necessary to worry about performance enhancements of the conversion step!<br><br>I may probably check if any of the optimizations I made before might be dropped, but now my program is running as fast as I would like it to run!<br><br>EDIT: my conversion routine still gives a slight performance gain (18% CPU usage with "convertPixmap" vs. 15% CPU usage with my versoin) but this might not be worth using it <br><br></td></tr></table><br>
<a name="bottom"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td align="right"><a href="http://monkeycoder.co.nz" target="_blank"><img src="/img/monkey2.svg" ></a> <a href="https://github.com/blitz-research" target="_blank"><img src="/img/github.svg" ></a> <a href="https://discord.gg/qJccbSp" target="_blank"><img src="/img/discord.svg" ></a></td></tr></table><br></div><br><table width="100%"><tr><td></body></html lang="en">
