<!DOCTYPE html><html lang="en" ><head ><title >Making a callback thread safe</title><meta name='viewport' content='width=device-width, initial-scale=0.66'><meta name='description' content='language:basic, target:desktop, category:game development'><link rel="styleSheet" href="../skins/granite/style.css" type="text/css"><style type="text/css">div.bbcode {padding: 8px;background: #E5E5E5;color: #000000;border: 1px dashed #B4B4BE;}</style></head><body ><table width=100% cellspacing=0 cellpadding=0><tr ><td class="menubarleft"></td><td class="menubar"><table cellspacing="0" cellpadding="0"><tr ><td >&nbsp;</td><td class="menuitemleft"></td><td class="menuitem"><a href="/" class="menuitem">News</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/forums.php" class="menuitem">Forums</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/codearcs.php" class="menuitem">Code</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/logs.php" class="menuitem">Logs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/gallery.php" class="menuitem">Gallery</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/sdkspecs.php" class="menuitem">Specs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/search.php" class="menuitem">Search</a></td><td class="menuitemright"></td></tr></table></td><td class="menubarright"></td></tr></table><div class="main"><h1 >Making a callback thread safe</h1><a href="forums.php" >BlitzMax Forums</a>/<a href="topics.php?forum=102" >BlitzMax Programming</a>/<a href="#bottom" >Making a callback thread safe</a><br><br>
<a name="884687"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >JoshK</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#1">[#1]</a></td></tr></table></td></tr><tr ><td class="posttext"> I am working with a multi-threaded physics library that uses callbacks during the physics update routine.  GCSuspend() is called before the physics update, and GCResume() is called after.<br><br>The callbacks use the "c" calling convention.  With a single core the program runs perfectly.  A crash results when the physics use more than one thread.  How can I make the callbacks thread-safe?  As I understand it, all the function variables are "up for grabs" at any time.  Each callback has a parameter indicating which thread is in use.  So would I do something like this?:<br><br>Current code:<br><pre class=code>Function Callback( threadIndex:Int ) "C"
Local a:Int
a = 3
EndFunction</pre><br><br>Thread-safe code:<br><pre class=code>Function Callback( threadIndex:Int ) "C"
Local a:Int[ 2 ]
a[ threadindex ] = 3
EndFunction</pre> <br><br></td></tr></table><br>
<a name="884727"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Who was John Galt?</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#2">[#2]</a></td></tr></table></td></tr><tr ><td class="posttext"> I don't think it's possible, TBH. What error is Blitz throwing?<br><br>I had a problem with an FMOD callback a while ago. Kept throwing a 'scope stack underflow' and no-one seemed able to come up with a solution, even BRL. <br><br></td></tr></table><br>
<a name="884977"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >JoshK</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#3">[#3]</a></td></tr></table></td></tr><tr ><td class="posttext"> I am not using objects or doing anything crazy.  Just using some local variables.  If I write to anything global, I lock the threads while writing.<br><br>Local variables should be fine, right?  Those should not interfere with each other on separate threads. <br><br></td></tr></table><br>
<a name="885019"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Who was John Galt?</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#4">[#4]</a></td></tr></table></td></tr><tr ><td class="posttext"> Sorry mate, I'm not totally sure, but I can't see how local variables could cause a problem. I do know that I tried removing anything that I thought could create garbage from my callback and did the nogc thing and I was still getting errors. How are you locking the threads? This one REALLY needs a response from BRL. <br><br></td></tr></table><br>
<a name="885083"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >REDi</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#5">[#5]</a></td></tr></table></td></tr><tr ><td class="posttext"> Try this mate... (no promises)<br><pre class=code>
Function Callback( threadIndex:Int ) "C" NoDebug
Global a:Int[ 2 ]
a[ threadindex ] = 3
EndFunction
</pre><br>IMHO thats about as safe as it gets ATM, if that still causes problems then you could try adding a critical section.<br><br>but if you're only going to be doing a bit of math in the callback I'd suggest writing it in C. <br><br></td></tr></table><br>
<a name="885263"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >JoshK</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#6">[#6]</a></td></tr></table></td></tr><tr ><td class="posttext"> Local variables should not need to be protected like that in an array.<br><br>Does NoDebug have any effect when the code is compiled in release mode? <br><br></td></tr></table><br>
<a name="885275"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Mark Tiffany</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#7">[#7]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> Does NoDebug have any effect when the code is compiled in release mode? <br></div><br>No.  Why would you expect it to?<br><br>The point of NoDebug is to turn off *debugging* in a given function, e.g. something you call many times per loop that you know works and want to avoid the performance hit in debug.  (I think it's also used in the blitzmax source a bit too). <br><br></td></tr></table><br>
<a name="885389"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >JoshK</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#8">[#8]</a></td></tr></table></td></tr><tr ><td class="posttext"> I don't.  It did not make sense that this was suggested as a solution to the problem. <br><br></td></tr></table><br>
<a name="885427"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >skidracer</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#9">[#9]</a></td></tr></table></td></tr><tr ><td class="posttext"> Josh, the only solution is to code the callback in C, there is some sync functions available if you look in brl.system for the callback to communicate with your blitz app but I would look at a simple PostMessage type solution first. You can NOT use BlitzMax functions in the context of other threads. <br><br></td></tr></table><br>
<a name="885437"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >JoshK</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#10">[#10]</a></td></tr></table></td></tr><tr ><td class="posttext"> Thank you for the information. <br><br></td></tr></table><br>
<a name="885474"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >REDi</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#11">[#11]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> It did not make sense that this was suggested as a solution to the problem. <br></div><br>of course it does but only when you run in debug mode, as debug mode adds a load of stuff to your code to track whats going on, stuff that would probably mess up threading.<br><br>The main change was to *try* it with a global array, so the GC wouldnt get involved, as you used a local array in your original attempt that would have to be created and GCed every time the function was called.<br><br>anyway I assume it didnt work, so its time to crack out a bit of C ;) <br><br></td></tr></table><br>
<a name="bottom"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td align="right"><a href="http://monkeycoder.co.nz" target="_blank"><img src="/img/monkey2.svg" ></a> <a href="https://github.com/blitz-research" target="_blank"><img src="/img/github.svg" ></a> <a href="https://discord.gg/qJccbSp" target="_blank"><img src="/img/discord.svg" ></a></td></tr></table><br></div><br><table width="100%"><tr><td></body></html lang="en">
