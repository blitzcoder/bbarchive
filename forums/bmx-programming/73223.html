<!DOCTYPE html><html lang="en" ><head ><title >RTT for 1.26</title><meta name='viewport' content='width=device-width, initial-scale=0.66'><meta name='description' content='language:basic, target:desktop, category:game development'><link rel="styleSheet" href="../skins/granite/style.css" type="text/css"><style type="text/css">div.bbcode {padding: 8px;background: #E5E5E5;color: #000000;border: 1px dashed #B4B4BE;}</style></head><body ><table width=100% cellspacing=0 cellpadding=0><tr ><td class="menubarleft"></td><td class="menubar"><table cellspacing="0" cellpadding="0"><tr ><td >&nbsp;</td><td class="menuitemleft"></td><td class="menuitem"><a href="/" class="menuitem">News</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/forums.php" class="menuitem">Forums</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/codearcs.php" class="menuitem">Code</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/logs.php" class="menuitem">Logs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/gallery.php" class="menuitem">Gallery</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/sdkspecs.php" class="menuitem">Specs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/search.php" class="menuitem">Search</a></td><td class="menuitemright"></td></tr></table></td><td class="menubarright"></td></tr></table><div class="main"><h1 >RTT for 1.26</h1><a href="forums.php" >BlitzMax Forums</a>/<a href="topics.php?forum=102" >BlitzMax Programming</a>/<a href="#bottom" >RTT for 1.26</a><br><br>
<a name="818499"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >tonyg</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#1">[#1]</a></td></tr></table></td></tr><tr ><td class="posttext"> I have edited Indiepath's RTT code to work at Bmax 1.26.<br>There are a couple of issues :<br>- OGL driver doesn't work with MIPMAPPED images (which has always been the case).<br>- Resulting image is smaller using the supplied examples. I can workaround this but not sure why it is happening. I asked before and it was due to a Viewport flag but that doesn't help now (plus Viewports have changed since 1.24).<br>So, if Tim can give the OK for me to post the source as Public Domain and license free I will do. <br><br></td></tr></table><br>
<a name="818513"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >TartanTangerine (was Indiepath)</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#2">[#2]</a></td></tr></table></td></tr><tr ><td class="posttext"> you have my permission. <br><br></td></tr></table><br>
<a name="818518"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >tonyg</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#3">[#3]</a></td></tr></table></td></tr><tr ><td class="posttext"> Thanks Tim<br>OK. At the moment it's not a module 'cos it's easier to work on.<br>The OGL Mipmap problem is avoided by not going into that bit of code.<br>The 'wrong scale' problem can be avoided by setting the render image to the graphicswidth/height.<br>Let me know if it works, any improvments and whether anybody can see what I am doing wrong to create a smaller output than input.<br>Finally, I have taken out the setmono from the original source. <br><textarea class=codebox name="code" wrap=OFF readonly="true" rows="15" cols="80">

Rem
bbdoc: Render 2 Texture Module
'End Rem
Module Indiepath.Render2Texture

ModuleInfo "Version: 1.0"
ModuleInfo "Author: Tim Fisher"
ModuleInfo "License: Indiepath License for non warranted software"
ModuleInfo "Summary: This software is free to use, you may distribute within a pre-compiled executable file only."
ModuleInfo "Contact: If you have a license question then ask, don't assume! If you don't have a copy of the license then get one."
ModuleInfo "Modserver:Indiepath"
EndRem
'Rem
'SetGraphicsDriver GLMax2DDriver()
Graphics 800,600,0

tRender.Initialise()

AutoMidHandle(1)

Local logo:TImage = LoadImage("bmax160_2.png",MIPMAPPEDIMAGE|FILTEREDIMAGE)
Local myImage:TImage = tRender.Create(ImageWidth(logo),ImageHeight(logo),MIPMAPPED|FILTEREDIMAGE)

'Local myImage:TImage = tRender.Create(GraphicsWidth(),GraphicsHeight(),MIPMAPPED|FILTEREDIMAGE)
Local ii:Float = 0

SetBlend(ALPHABLEND)
	tRender.TextureRender_Begin(myImage,False)
	tRender.Cls	
	Repeat
		SetRotation(ii)
		DrawImage logo , 320 , 240
		ii:+5
	Until ii&gt;360
	tRender.TextureRender_End()
	SetImageHandle(logo,0,0)
	tRender.BackBufferRender_Begin()
	tRender.Cls
	DrawImage myimage , 0,0
	DrawImage logo,300,0
	tRender.BackBufferRender_End()
	Flip
WaitKey()
'End Rem

Const DDERR_INVALIDSURFACETYPE 	= $88760250
Const DDERR_INVALIDPARAMS		= $80070057
Const DDERR_INVALIDOBJECT 		= $88760082
Const DDERR_NOTFOUND 			= $887600ff
Const DDERR_SURFACELOST 		= $887601c2

Global tRenderERROR:String

Function tError:String(err:Int)

	Select err
		Case DDERR_INVALIDSURFACETYPE
			Return "DDERR_INVALIDSURFACETYPE"
			
		Case DDERR_INVALIDPARAMS
			Return "DDERR_INVALIDPARAMS"
			
		Case DDERR_INVALIDOBJECT 
			Return "DDERR_INVALIDOBJECT"
			
		Case DDERR_NOTFOUND
			Return "DDERR_NOTFOUND"
			
		Case DDERR_SURFACELOST
			Return "DDERR_SURFACELOST"
			
	End Select
End Function

Type tRender
	
	?Win32
	Global DXFrame:TD3D7ImageFrame
	Global backbuffer:IDirectDrawSurface7

	?
	Global GLFrame:TGLImageFrame
	Global DX:Int 
	Global Image:TImage = CreateImage(1,1)
	Global Width:Int
	Global Height:Int
	Global o_r,o_g,o_b
Rem
bbdoc: Initialise the Module
about: 
The module must be initialised before use. This ensures usage of the correct render pipeline. If the render device is changed then you must 
re initialise the module.
End Rem		
	Function Initialise()
	?Win32
		If _max2dDriver.ToString() = "DirectX7"
			DX = True
			D3D7GraphicsDriver().Direct3DDevice7().GetRenderTarget Varptr backbuffer

		'	ViewPort = New D3DVIEWPORT7
		Else
	?
			DX = False
		'	GlEnable(GL_TEXTURE_2D)
	?Win32
		EndIf
	?
		DebugLog "tRender : Initialise OK"
		Return True
	End Function
	
'#################################################################################

Rem
bbdoc: Create Image with Render Characteristics
returns: TImage Handle to Object
about: 
 &lt;table&gt;
		&lt;tr&gt;&lt;td&gt;&lt;b&gt;Width:Int&lt;/td&gt;&lt;td&gt;Width in Pixels of Image, try to follow the normal rules of textures&lt;/td&gt;&lt;/tr&gt;
		&lt;tr&gt;&lt;td&gt;&lt;b&gt;Height:Int&lt;/td&gt;&lt;td&gt;Height in Pixels of Image&lt;/td&gt;&lt;/tr&gt;
		&lt;tr&gt;&lt;td&gt;&lt;b&gt;Flags:Int&lt;/td&gt;&lt;td&gt;Normal Image Flags&lt;/td&gt;&lt;/tr&gt;
	&lt;/table&gt;
End Rem	
	Function Create:TImage(Width:Int,Height:Int,Flags:Int=FILTEREDIMAGE)

		Local t:TImage=New TImage
		t.width=width
		t.height=height
		t.flags=flags
		t.mask_r= 0
		t.mask_g= 0
		t.mask_b= 0
		t.pixmaps=New TPixmap[1]
		t.frames=New TImageFrame[1]
		t.seqs=New Int[1]
		t.pixmaps[0]= t.Lock(0,True,False)
		t.seqs[0]=GraphicsSeq
		
	'	MaskPixmap( t.pixmaps[0],mask_r,mask_g,mask_b )
	?Win32	
		If DX
			t.frames[0] = CreateFrame(TD3D7Max2DDriver(_max2dDriver),t.Width,t.Height,t.flags)
		Else
	?
			t.frames[0] = TGLImageFrame.CreateFromPixmap:TGLImageFrame( t.pixmaps[0],t.flags )
	?Win32
		EndIf
	?
		
		DebugLog "tRender : Create OK"
		
		
		Return t

	End Function

'#################################################################################
?Win32			
	Function CreateFrame:TD3D7ImageFrame( driver:TD3D7Max2DDriver,width,height,flags )				
		Function Pow2Size( n )
			Local t=1
			While t&lt;n
				t:*2
			Wend
			Return t
		End Function

		Local	swidth=Pow2Size(width)
		Local	sheight=Pow2Size(height)
		Local	desc:DDSURFACEDESC2=New DDSURFACEDESC2
		Local	res
						
		desc.dwSize=SizeOf(desc)
		desc.dwFlags=DDSD_WIDTH|DDSD_HEIGHT|DDSD_CAPS|DDSD_PIXELFORMAT
		desc.dwWidth=swidth
		desc.dwHeight=sheight	
		desc.ddsCaps=DDSCAPS_TEXTURE|DDSCAPS_3DDEVICE|DDSCAPS_VIDEOMEMORY|DDSCAPS_LOCALVIDMEM  ' **************************************************
		desc.ddsCaps2=DDSCAPS2_HINTDYNAMIC'|DDSCAPS2_TEXTUREMANAGE
		desc.ddpf_dwSize=SizeOf(DDPIXELFORMAT)
		desc.ddpf_dwFlags=DDPF_RGB|DDPF_ALPHAPIXELS
		desc.ddpf_BitCount=32
		desc.ddpf_BitMask_0=$ff0000
		desc.ddpf_BitMask_1=$00ff00
		desc.ddpf_BitMask_2=$0000ff
		desc.ddpf_BitMask_3=$ff000000

		
		Local surf:IDirectDrawSurface7
		If flags &amp; MIPMAPPEDIMAGE desc.ddsCaps:|DDSCAPS_MIPMAP|DDSCAPS_COMPLEX
		res=D3D7GraphicsDriver().DirectDraw7().CreateSurface( desc,Varptr surf,Null )
		If res&lt;&gt;DD_OK 
			tRenderERROR = tError(res)
			DebugLog "tRender : CreateFrame ERROR : "+tRenderERROR
			Return Null
		EndIf
		'RuntimeError "Create DX7 surface Failed"	
							
		Local frame:TD3D7ImageFrame=New TD3D7ImageFrame
		frame.driver=driver
		frame.surface=surf
		frame.sinfo=New DDSURFACEDESC2
		frame.sinfo.dwSize=SizeOf(frame.sinfo)
		frame.xyzuv=New Float[24]
		frame.width=width
		frame.height=height
		frame.flags=flags
		frame.SetUV 0.0,0.0,Float(width)/swidth,Float(height)/sheight
	
			
		'frame.BuildMipMaps()
		DebugLog "tRender : CreateFrame OK"
		Return frame
	End Function
?
	
'#################################################################################
Rem
bbdoc: Set Screen Viewport
about: 
 &lt;table&gt;
	&lt;tr&gt;&lt;td&gt;&lt;b&gt;X:Int&lt;/td&gt;&lt;td&gt;Set the X Position of the Viewport&lt;/td&gt;&lt;/tr&gt;
	&lt;tr&gt;&lt;td&gt;&lt;b&gt;Y:Int&lt;/td&gt;&lt;td&gt;Set the Y Position of the Viewport&lt;/td&gt;&lt;/tr&gt;
	&lt;tr&gt;&lt;td&gt;&lt;b&gt;Width:Int&lt;/td&gt;&lt;td&gt;Set the Viewport Width in Pixels&lt;/td&gt;&lt;/tr&gt;
	&lt;tr&gt;&lt;td&gt;&lt;b&gt;Height:Int&lt;/td&gt;&lt;td&gt;Set the Viewport Height in Pixels&lt;/td&gt;&lt;/tr&gt;
	&lt;tr&gt;&lt;td&gt;&lt;b&gt;FlipY:Byte&lt;/td&gt;&lt;td&gt;Flip the Viewport on the Y Axis, OpenGL only. Automatically done by the Texture Renderer.&lt;/td&gt;&lt;/tr&gt;
 &lt;/table&gt;
End Rem	
	Function ViewportSet(X:Int=0,Y:Int=0,Width:Int,Height:Int,FlipY:Byte=False)
	?Win32
		If DX
			Local viewport:D3DVIEWPORT7=New D3DVIEWPORT7
			viewport.dwX=x
			viewport.dwY=y
			viewport.dwWidth=width
			viewport.dwHeight=height
			D3D7GraphicsDriver().Direct3DDevice7().SetViewport(viewport)
		Else
	?
			If FlipY
				glViewport(X, Y, Width, Height)
				glMatrixMode(GL_PROJECTION)
				glPushMatrix()
				glLoadIdentity()
				gluOrtho2D(X, GraphicsWidth(), GraphicsHeight(),Y)
				glScalef(1, -1, 1)
				glTranslatef(0, -GraphicsHeight(), 0)
				glMatrixMode(GL_MODELVIEW)
			Else
				glViewport(X, Y, Width, Height)
				glMatrixMode(GL_PROJECTION)
				glLoadIdentity()
				glOrtho(X, GraphicsWidth(), GraphicsHeight(), Y, -1, 1)
				glMatrixMode(GL_MODELVIEW)
				glLoadIdentity()
			EndIf
	?Win32
		EndIf
	?
		DebugLog "tRender : ViewportSet OK"
		Return True
	EndFunction
	
'#################################################################################
Rem
bbdoc: Begin the Texture Render Process
about: 
 &lt;table&gt;
	&lt;tr&gt;&lt;td&gt;&lt;b&gt;Image:TImage&lt;/td&gt;&lt;td&gt;The Image to Render to, as created with "Create" command.&lt;/td&gt;&lt;/tr&gt;
	&lt;tr&gt;&lt;td&gt;&lt;b&gt;Viewport:Byte&lt;/td&gt;&lt;td&gt;True (default) to Automatically resize the viewport to the image size&lt;/td&gt;&lt;/tr&gt;
 &lt;/table&gt;
End Rem
	Function TextureRender_Begin(Image1:TImage,Viewport:Byte=True)
	SetScale Float(GraphicsWidth())/Float(ImageWidth(image1)),Float(GraphicsHeight())/Float(ImageHeight(image1))


		Image = Image1
		If Viewport Then 
			Width = image1.width
			Height = image1.height
		Else
			Width = GraphicsWidth()
			Height = GraphicsHeight()
		EndIf
		If DX
			DebugLog "w : " + width + " h : " + height
			ViewportSet(0,0,Width,Height)
		Else
			ViewportSet(0,0,Width,Height,True)
		EndIf
		
	?Win32	
		If DX
			Local DXFrame:TD3D7ImageFrame = TD3D7ImageFrame (image1.frame(0))
			D3D7GraphicsDriver().Direct3DDevice7().SetRenderTarget( DXFrame.Surface,0)
			D3D7GraphicsDriver().Direct3DDevice7().BeginScene()
		Else
	?
			GLFrame:TGLImageFrame = TGLImageFrame(Image1.frame(0))
		'	ViewportSet(0,0,Width,Height,True)
	?Win32
		EndIf		
	?
	'	debuglog "tRender : TextureRender_Begin OK"
		Return True
	End Function
	
'#################################################################################
Rem
bbdoc: Clear the Current Viewport with color
about: 
 &lt;table&gt;
	&lt;tr&gt;&lt;td&gt;&lt;b&gt;col:Int&lt;/td&gt;&lt;td&gt;The Color to clear the Viewport with includes Alpha AARRGGBB format.&lt;/td&gt;&lt;/tr&gt;
 &lt;/table&gt;
End Rem
	Function Cls(col:Int=$FF000000)
	?Win32	
		If dx
			D3D7GraphicsDriver().Direct3DDevice7().Clear 1,Null,D3DCLEAR_TARGET,col,0,0
		Else
	?
				Local Red# 	= (col Shr 16) &amp; $FF
				Local Green# 	= (col Shr 8) &amp; $FF
				Local Blue# 	= col &amp; $FF
				Local Alpha# 	= (col Shr 24) &amp; $FF
			'	DebugLog Alpha
				glClearColor red/255.0,green/255.0,blue/255.0,alpha/255.0
				glClear GL_COLOR_BUFFER_BIT
	?Win32	
		EndIf
	?
	End Function
	
'#################################################################################
'?win32	
	Function SetMipMap(Image:TImage,Level:Int)
		If DX
			Local DXFrame:TD3D7ImageFrame = TD3D7ImageFrame (image.frame(0))
			
			'DXFrame.BuildMipMaps()
			
			Local	src:IDirectDrawSurface7
			Local	dest:IDirectDrawSurface7
			Local	caps2:DDSCAPS2
			caps2=New DDSCAPS2
			caps2.dwCaps=DDSCAPS_TEXTURE|DDSCAPS_MIPMAP'|DDSCAPS_3DDEVICE
			caps2.dwCaps2= DDSCAPS2_MIPMAPSUBLEVEL
		
			src = DXFrame.Surface
					
			Local res = src.GetAttachedSurface(caps2,Varptr dest)
			
			If res&lt;&gt;DD_OK 
				tRenderERROR = tError(res)
				Return False
			EndIf
			
			DXFrame.Surface =  dest
			dest.Release_
			
			DebugLog "MipMap Selected OK"
			Return True
		Else
			Return False
		EndIf	
	End Function
'?	
'#################################################################################
Rem
bbdoc: End the Texture Render Process
about: 
This Must be called when you have finished rendering to the Texture
End Rem	
	Function TextureRender_End()
	SetScale 1.0,1.0

	?Win32
		If dx
			D3D7GraphicsDriver().Direct3DDevice7().EndScene()
		Else
	?
			glBindTexture GL_TEXTURE_2D,GLFrame.name
			glCopyTexImage2D(GL_TEXTURE_2D, 0, GL_RGBA, 0, 0, Width, Height, 0)
			glBindTexture GL_TEXTURE_2D,0
	?Win32
		EndIf
	?
		ViewportSet(0,0,GraphicsWidth(),GraphicsHeight())
		DrawImageRect Image,-2000,-2000,1,1
	'	debuglog "tRender : TextureRender_End OK"
		Return True
	End Function
	
'#################################################################################
Rem
bbdoc: Begin the Normal BackBuffer Rendering Process
End Rem
	Function BackBufferRender_Begin()
	?Win32
		If DX Then 
			D3D7GraphicsDriver().Direct3DDevice7().SetRenderTarget(backbuffer,0)
			
			
		Else
	?		
		'	If GLFrame &lt;&gt; Null Then glBindTexture GL_TEXTURE_2D,GLFrame.name
	?Win32
		EndIf
	?
		ViewportSet(0,0,GraphicsWidth(),GraphicsHeight())
		DebugLog "tRender : BackBufferRender_Begin OK"
		Return True
	End Function
	
'#################################################################################
Rem
bbdoc: End the Normal BackBuffer Rendering process
about: 
This Must be called when you have finished rendering to the BackBuffer and Before the Flip Command.
End Rem	
	Function BackBufferRender_End()
	?Win32
		If DX
			D3D7GraphicsDriver().Direct3DDevice7().EndScene()
		Else
	?
			glBindTexture GL_TEXTURE_2D,0
	?Win32
		EndIf
	?
		DebugLog "tRender : BackBufferRender_End OK"
		Return True
	End Function
	
'#################################################################################
		

End Type
</textarea><br>If the problems can be solved I'll comment the code, add nicer variable names and make it a module again.<br><br>&lt;edit&gt; For those interested I fixed the scale issue. My theory was the 'camera' used in Bmax is offset a little (zoomed out?) so I was rendering something smaller then smaller again. A simple setscale fixed it.... I think. <br><br></td></tr></table><br>
<a name="818521"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >altitudems</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#4">[#4]</a></td></tr></table></td></tr><tr ><td class="posttext"> Nice, thank you. I'll have a play with this later. <br><br></td></tr></table><br>
<a name="820568"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Derron</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#5">[#5]</a></td></tr></table></td></tr><tr ><td class="posttext"> Got some steps further?<br><br>May be some commands like glOrtho (with respective values) helps to get the right scale in openGL-mode ?!<br><br><br>bye<br>MB <br><br></td></tr></table><br>
<a name="820577"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >tonyg</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#6">[#6]</a></td></tr></table></td></tr><tr ><td class="posttext"> I must be missing something but it works OK for OGL. The DX driver works with the setscale although, for small images, the result is a bit blurred. <br><br></td></tr></table><br>
<a name="820613"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Derron</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#7">[#7]</a></td></tr></table></td></tr><tr ><td class="posttext"> For OGL it's not working as expected on my machine.<br><br>My game uses a resolution of 800x600 and I'm drawing some interface-graphics (a bottom image displaying some other images/informations) - this is about 800x250 pixel but it's displayed with about 1000*400 pixels.<br><br>So if using OpenGL as driver its a setscale of about 0.78, 340.0/600 to fit it... but this depends on the dimensions of the images. That's why I mentioned glOrtho - there are some values which are also not 1:1 related to resolution or image-dimensions.<br>Next to the "wrong scale" aspect the images look very blurry here.<br><br>With DX no problems occour after all.<br><br><br>bye<br>MB <br><br></td></tr></table><br>
<a name="820628"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Grey Alien</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#8">[#8]</a></td></tr></table></td></tr><tr ><td class="posttext"> As an aside, how have viewports changed since V1.24?  Do they work on all PCs now? <br><br></td></tr></table><br>
<a name="820655"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >tonyg</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#9">[#9]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> For OGL it's not working as expected on my machine. <br></div>. If anybody has the answer then please post as I never touched the OGL method in the module. <br><br></td></tr></table><br>
<a name="820682"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Dreamora</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#10">[#10]</a></td></tr></table></td></tr><tr ><td class="posttext"> Viewports always have worked with systems fullfilling DX8+ specs.<br><br>DX7 has no scissor test (DX9+ and OpenGL have it), you need to do it through clip planes and 2D office cards (totally outdated intel/sis/s3 with Pre GMA900 technology so unable to run BM Max2D anyway) just support 2 of them (one for near clip, one for far, but none left for the side. all newer support 4+) <br><br></td></tr></table><br>
<a name="820684"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Derron</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#11">[#11]</a></td></tr></table></td></tr><tr ><td class="posttext"> Try if you see all 4 Rects (Topleft,TopRight,BottomLeft,BottomRight) and all values from 50 to 750.<br><br>For doing this - exchange your example with:<br><pre class=code>
SetBlend(ALPHABLEND)
	tRender.TextureRender_Begin(myImage,False)
	tRender.Cls	
	For Local i:Int = 0 To 16 'drawing 16 marks horizontally - from 0 to 800px
	  DrawLine(i*50,0,i*50,600)
	  DrawText("x="+(i*50),i*50, 50)
	Next
	SetColor 255,0,0
		DrawRect(0,0,11,11) 'top left
		DrawRect(790,0,11,11) 'top right
		DrawRect(790,590,11,11) 'bottom right
		DrawRect(0,590,11,11) 'bottom left
	SetColor 200,200,200	
		DrawRect(1,1,10,10) 'top left
		DrawRect(789,1,10,10) 'top right
		DrawRect(789,589,10,10) 'bottom right
		DrawRect(1,589,10,10) 'bottom left
	SetColor 255,255,255
	tRender.TextureRender_End()
	SetImageHandle(logo,0,0)
	tRender.BackBufferRender_Begin()
	tRender.Cls
	DrawImage myimage , 0,0
	DrawImage logo,300,0
	tRender.BackBufferRender_End()
	Flip
WaitKey()
</pre><br><br>and replace:<br><pre class=code>
Graphics 800,600,0
</pre><br><br>with:<br><pre class=code>
SetGraphicsDriver GLMax2DDriver()
Graphics 800,600,0
</pre><br><br><br>bye<br>MB <br><br></td></tr></table><br>
<a name="820694"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >tonyg</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#12">[#12]</a></td></tr></table></td></tr><tr ><td class="posttext"> Yep I get the same problem. If anybody has the answer then please post as I never touched the OGL method in the module. <br><br></td></tr></table><br>
<a name="820705"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Derron</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#13">[#13]</a></td></tr></table></td></tr><tr ><td class="posttext"> Thanks University-lessons to give me some time on my laptop ;D ... what else is useful in "algorithms and programming".<br><br><br>think I got something which is usable...<br><br>Add function (or use the  given one in the frame-create-function):<br><br><pre class=code>
	Function NextPowSize(n) 
			Local t = 1
			While t&lt;n
				t:*2
			Wend
			Return t
		End Function
</pre><br><br>and change TextureRender_End to:<br><pre class=code>
	Function TextureRender_End()
	SetScale 1.0, 1.0

	?Win32
		If dx
			D3D7GraphicsDriver().Direct3DDevice7().EndScene()
		Else
	?
			glBindTexture GL_TEXTURE_2D, GLFrame.name
'			glCopyTexImage2D(GL_TEXTURE_2D, 0, GL_RGBA, 0, 0, Width, Height, 0)
			glCopyTexImage2D(GL_TEXTURE_2D, 0, GL_RGBA, 0, 0, NextPowSize(width), NextPowSize(Height), 0) 
			glBindTexture GL_TEXTURE_2D, 0
	?Win32
		EndIf
	?
		ViewportSet(0,0,GraphicsWidth(),GraphicsHeight())
		DrawImageRect Image,-2000,-2000,1,1


	'	debuglog "tRender : TextureRender_End OK"
		Return True
	End Function
</pre><br><br>As you see I changed the width/height thing... Because Textures are surely saved with power of 2 and some sprites (eg when fullscreen-resolutions) aren't saved this way - the stretching occours.<br><br>If now the function nextpowsize returns the correct dimensions - for 800x600 its 1024x1024, all stretching is gone... and it looks smooth again ;D...<br><br><br>Hope it works for you too.<br><br>ah and... may be for OGL you can comment out:<br><pre class=code>
		DrawImageRect Image,-2000,-2000,1,1
</pre><br>in the same function - for me commenting it out didnt change a thing in OGL.<br><br><br>bye<br>MB <br><br></td></tr></table><br>
<a name="820712"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Derron</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#14">[#14]</a></td></tr></table></td></tr><tr ><td class="posttext"> Ok ... instead of this huge change you may also change <br><br>Just change the given width/height-variables to a new value: <br><pre class=code>
	Function Create:TImage(Width:Int,Height:Int,Flags:Int=FILTEREDIMAGE)
		Local t:TImage=New TImage
		t.width=NextPowSize(width)
		t.height=NextPowSize(height)
...
</pre><br><br>would work too I think.<br><br><br>bye<br>MB <br><br></td></tr></table><br>
<a name="820718"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Tachyon</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#15">[#15]</a></td></tr></table></td></tr><tr ><td class="posttext"> Sorry for the elementary question, but: what does this Render To Texture do? What can it achieve that standard BlitzMax commands can't? <br><br></td></tr></table><br>
<a name="820720"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Derron</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#16">[#16]</a></td></tr></table></td></tr><tr ><td class="posttext"> with rtt you can manipulate an image the easy way...<br><br><br>imagine you have a part of your screen filled with a background image... and onto this image you draw other images (sprites). So you will have to draw them each time for each flip and so on...<br><br>Also if you only change the drawn-on-top-images every second this will save you the time for a whole second (60 flips or how your fps is set). When the images change you just rebuild the rtt-image and you will be able to draw this for a whole second.<br><br>short: ability to draw images on another image and use this "composition" for the next draw-loops until this image has to be changed again.<br>(huds may be a nice usage for this piece of code).<br><br><br>bye<br>MB <br><br></td></tr></table><br>
<a name="820724"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >tonyg</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#17">[#17]</a></td></tr></table></td></tr><tr ><td class="posttext"> You can also use it to blur/bloom images and create image feedback effects.<br>It can also be used to produce unique sprites from seperate images ("composite" sprites). <br><br></td></tr></table><br>
<a name="820725"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >MGE</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#18">[#18]</a></td></tr></table></td></tr><tr ><td class="posttext"> Is this a stable solution for OpenGL and DirectX? <br><br></td></tr></table><br>
<a name="820734"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >tonyg</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#19">[#19]</a></td></tr></table></td></tr><tr ><td class="posttext"> It's completely stable until somebody reports a problem with it. <br><br></td></tr></table><br>
<a name="820802"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Derron</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#20">[#20]</a></td></tr></table></td></tr><tr ><td class="posttext"> Ok...<br>Now it seems to work when using a trender.create-command with values corresponding to app-resolution (eg. 800x600).<br><br>But I don't want to waste memory so I want it the way I'm able to create 500x200 too (which boosts to 512x256).<br>All tRenders I create are dependend on the overall applications resolution ... so up to now I'm only able to create tRender-images with 800x600 (my app is using this res) else it get's blurry.<br><br>So if I create a tRender-image with 800x400 and put it on 0,0 (with resolution of 800x600) all things drawn within this image are halfed-heigh - image at 200 is visually at 100 with half of height ... and so on.<br><br>Why do the functions above scale my objects?<br><br>At the moment the function only can be used as "composition layers" not as "compositable spritelayer".<br><br><br>bye<br>MB <br><br></td></tr></table><br>
<a name="820821"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >tonyg</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#21">[#21]</a></td></tr></table></td></tr><tr ><td class="posttext"> I put the scale commands in due to the scaling problem in my original post. Tim suggested this was due to the viewport parm used but I got the same with both.<br>I checked on GameDev as my own attempt at RTT had the same issue but with DX. The response was <div class="quote"> <br>I'd guess you are transforming the data twice. If the output to the texture looks right, then make sure you move it to the screen as already transformed data. Otherwise it's like using a camera to take a picture of a picture that's 5 feet away. <br></div><br>Same might be happening with OGL. <br><br></td></tr></table><br>
<a name="834788"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >jkrankie</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#22">[#22]</a></td></tr></table></td></tr><tr ><td class="posttext"> will this work in the 1.28 update? i'd like to know before i upgrade.<br><br>Cheers<br>Charlie <br><br></td></tr></table><br>
<a name="834797"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >tonyg</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#23">[#23]</a></td></tr></table></td></tr><tr ><td class="posttext"> It works for me but I have changed the code to fix the scaling issue and removed OGL. The code above works as well but is messy. For OGL I would use Diablo's HighGfx code.<br>Here is the DX code I use now :<br><textarea class=codebox name="code" wrap=OFF readonly="true" rows="15" cols="80">
' Original author Tim Fisher
Graphics 800,600,0
tRender.Initialise()
Local logo:TImage = LoadImage("max.png",MIPMAPPEDIMAGE|FILTEREDIMAGE)
Local myImage:TImage = tRender.Create(ImageWidth(logo) , ImageHeight(logo) , MIPMAPPED | FILTEREDIMAGE)
tRender.TextureRender(myImage,True)
Cls	
DrawImage logo,0,0

SetBlend(ALPHABLEND)

While Not KeyHit(KEY_ESCAPE)
	tRender.BackBufferRender() 
	Cls
	SetAlpha 1.0
	DrawImage myimage , MouseX(),MouseY()
	DrawImage logo,300,200
	Flip
	tRender.TextureRender(myImage,True)
'	Cls	
'	DrawImage logo,0,0
	SetAlpha Rnd(0.3,1.0)
	SetColor Rand(255) , Rand(255) , Rand(255)
	Local cubx:Int = Rand(0 , 200)
	Local cuby:Int=Rand(0,200)
	DrawRect cubx,cuby,20,20
	SetColor 255,255,255
	DrawText "Hello World",10,10

	Delay 250
Wend

Const DDERR_INVALIDSURFACETYPE 	= $88760250
Const DDERR_INVALIDPARAMS		= $80070057
Const DDERR_INVALIDOBJECT 		= $88760082
Const DDERR_NOTFOUND 			= $887600ff
Const DDERR_SURFACELOST 		= $887601c2

Global tRenderERROR:String

Function tError:String(err:Int)

	Select err
		Case DDERR_INVALIDSURFACETYPE
			Return "DDERR_INVALIDSURFACETYPE"
			
		Case DDERR_INVALIDPARAMS
			Return "DDERR_INVALIDPARAMS"
			
		Case DDERR_INVALIDOBJECT 
			Return "DDERR_INVALIDOBJECT"
			
		Case DDERR_NOTFOUND
			Return "DDERR_NOTFOUND"
			
		Case DDERR_SURFACELOST
			Return "DDERR_SURFACELOST"
			
	End Select
End Function

Type tRender
	
	Global DXFrame:TD3D7ImageFrame
	Global backbuffer:IDirectDrawSurface7
	Global Image:TImage = CreateImage(1,1)
	Global Width:Int
	Global Height:Int
	Global o_r , o_g , o_b

Rem
bbdoc: Initialise the Module
about: 
The module must be initialised before use. This ensures usage of the correct render pipeline. If the render device is changed then you must 
re initialise the module.
End Rem		
	Function Initialise()
			D3D7GraphicsDriver().Direct3DDevice7().GetRenderTarget Varptr backbuffer
		DebugLog "tRender : Initialise OK"
		Return True
	End Function
	
'#################################################################################

Rem
bbdoc: Create Image with Render Characteristics
returns: TImage Handle to Object
about: 
 &lt;table&gt;
		&lt;tr&gt;&lt;td&gt;&lt;b&gt;Width:Int&lt;/td&gt;&lt;td&gt;Width in Pixels of Image, try to follow the normal rules of textures&lt;/td&gt;&lt;/tr&gt;
		&lt;tr&gt;&lt;td&gt;&lt;b&gt;Height:Int&lt;/td&gt;&lt;td&gt;Height in Pixels of Image&lt;/td&gt;&lt;/tr&gt;
		&lt;tr&gt;&lt;td&gt;&lt;b&gt;Flags:Int&lt;/td&gt;&lt;td&gt;Normal Image Flags&lt;/td&gt;&lt;/tr&gt;
	&lt;/table&gt;
End Rem	
	Function Create:TImage(Width:Int,Height:Int,Flags:Int=FILTEREDIMAGE)

		Local t:TImage=New TImage
		t.width=width
		t.height=height
		t.flags=flags
		t.mask_r= 0
		t.mask_g= 0
		t.mask_b= 0
		t.pixmaps=New TPixmap[1]
		t.frames=New TImageFrame[1]
		t.seqs=New Int[1]
		t.pixmaps[0]= t.Lock(0,True,False)
		t.seqs[0]=GraphicsSeq
		
			t.frames[0] = CreateFrame(TD3D7Max2DDriver(_max2dDriver),t.Width,t.Height,t.flags)
			
		DebugLog "tRender : Create OK"
		
		
		Return t

	End Function

'#################################################################################
		
	Function CreateFrame:TD3D7ImageFrame( driver:TD3D7Max2DDriver,width,height,flags )				
		Function Pow2Size( n )
			Local t=1
			While t&lt;n
				t:*2
			Wend
			Return t
		End Function

		Local	swidth=Pow2Size(width)
		Local	sheight=Pow2Size(height)
		Local	desc:DDSURFACEDESC2=New DDSURFACEDESC2
		Local	res
						
		desc.dwSize=SizeOf(desc)
		desc.dwFlags=DDSD_WIDTH|DDSD_HEIGHT|DDSD_CAPS|DDSD_PIXELFORMAT
		desc.dwWidth=swidth
		desc.dwHeight=sheight	
		desc.ddsCaps=DDSCAPS_TEXTURE|DDSCAPS_3DDEVICE|DDSCAPS_VIDEOMEMORY|DDSCAPS_LOCALVIDMEM  ' **************************************************
		desc.ddsCaps2=DDSCAPS2_HINTDYNAMIC'|DDSCAPS2_TEXTUREMANAGE
		desc.ddpf_dwSize=SizeOf(DDPIXELFORMAT)
		desc.ddpf_dwFlags=DDPF_RGB|DDPF_ALPHAPIXELS
		desc.ddpf_BitCount=32
		desc.ddpf_BitMask_0=$ff0000
		desc.ddpf_BitMask_1=$00ff00
		desc.ddpf_BitMask_2=$0000ff
		desc.ddpf_BitMask_3=$ff000000

		
		Local surf:IDirectDrawSurface7
		If flags &amp; MIPMAPPEDIMAGE desc.ddsCaps:|DDSCAPS_MIPMAP|DDSCAPS_COMPLEX
		res=D3D7GraphicsDriver().DirectDraw7().CreateSurface( desc,Varptr surf,Null )
		If res&lt;&gt;DD_OK 
			tRenderERROR = tError(res)
			DebugLog "tRender : CreateFrame ERROR : "+tRenderERROR
			Return Null
		EndIf
		'RuntimeError "Create DX7 surface Failed"	
							
		Local frame:TD3D7ImageFrame=New TD3D7ImageFrame
		frame.driver=driver
		frame.surface=surf
		frame.sinfo=New DDSURFACEDESC2
		frame.sinfo.dwSize=SizeOf(frame.sinfo)
		frame.xyzuv=New Float[24]
		frame.width=width
		frame.height=height
		frame.flags=flags
		frame.SetUV 0.0,0.0,Float(width)/swidth,Float(height)/sheight
	
			
		'frame.BuildMipMaps()
		DebugLog "tRender : CreateFrame OK"
		Return frame
	End Function

	
Rem
bbdoc: Begin the Texture Render Process
about: 
 &lt;table&gt;
	&lt;tr&gt;&lt;td&gt;&lt;b&gt;Image:TImage&lt;/td&gt;&lt;td&gt;The Image to Render to, as created with "Create" command.&lt;/td&gt;&lt;/tr&gt;
	&lt;tr&gt;&lt;td&gt;&lt;b&gt;Viewport:Byte&lt;/td&gt;&lt;td&gt;True (default) to Automatically resize the viewport to the image size&lt;/td&gt;&lt;/tr&gt;
 &lt;/table&gt;
End Rem
	Function TextureRender(Image1:TImage,Viewport:Byte=True)
			D3D7GraphicsDriver().Direct3DDevice7().EndScene()

		If Viewport Then 
			Width = image1.width
			Height = image1.height
			
		Else
			Width = GraphicsWidth()
			Height = GraphicsHeight()
		EndIf
		SetViewport(0 , 0 , width , height)
			Local DXFrame:TD3D7ImageFrame = TD3D7ImageFrame (image1.frame(0))
			D3D7GraphicsDriver().Direct3DDevice7().SetRenderTarget( DXFrame.Surface,0)
			D3D7GraphicsDriver().Direct3DDevice7().BeginScene()
	'	debuglog "tRender : TextureRender_Begin OK"
		Return True
	End Function
	
'?win32	
	Function SetMipMap(Image:TImage,Level:Int)
			Local DXFrame:TD3D7ImageFrame = TD3D7ImageFrame (image.frame(0))
			
			'DXFrame.BuildMipMaps()
			
			Local	src:IDirectDrawSurface7
			Local	dest:IDirectDrawSurface7
			Local	caps2:DDSCAPS2
			caps2=New DDSCAPS2
			caps2.dwCaps=DDSCAPS_TEXTURE|DDSCAPS_MIPMAP'|DDSCAPS_3DDEVICE
			caps2.dwCaps2= DDSCAPS2_MIPMAPSUBLEVEL
		
			src = DXFrame.Surface
					
			Local res = src.GetAttachedSurface(caps2,Varptr dest)
			
			If res&lt;&gt;DD_OK 
				tRenderERROR = tError(res)
				Return False
			EndIf
			
			DXFrame.Surface =  dest
			dest.Release_
			
			DebugLog "MipMap Selected OK"
			Return True
	End Function
'#################################################################################
Rem
bbdoc: Begin the Normal BackBuffer Rendering Process
End Rem
	Function BackBufferRender()
			D3D7GraphicsDriver().Direct3DDevice7().EndScene()

			D3D7GraphicsDriver().Direct3DDevice7().SetRenderTarget(backbuffer,0)
		SetViewport(0,0,GraphicsWidth(),GraphicsHeight())
		DebugLog "tRender : BackBufferRender_Begin OK"
		Return True
	End Function
	
End Type

</textarea><br>&lt;edit&gt; Just realise I have removed all the module info which listed Tim 'Indiepath' as the code originator so thanks to Tim.<br>In addition, the code now uses the setviewport command. There have been reports of this not working on some graphics cards. <br><br></td></tr></table><br>
<a name="867007"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Jake L.</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#24">[#24]</a></td></tr></table></td></tr><tr ><td class="posttext"> Using the above code, I can't save myImage to a file. Anyone knows how I can achieve this? When using<br><pre class=code>
SavePixmapPNG(myImage.Lock(0,1,0),"tex.png") 
</pre><br>I got an empty PNG. The size is correct, it's just empty.<br><br>Thanks<br><br>PS: I got the same issues with Klepto's FBO code. <br><br></td></tr></table><br>
<a name="867147"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >tonyg</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#25">[#25]</a></td></tr></table></td></tr><tr ><td class="posttext"> It's probably because the image is outside Bmax control really so doesn't have a lock method. I could be wrong though.<br>&lt;Edit&gt; You might have to resort to drawing, grabbing and saving. <br><br></td></tr></table><br>
<a name="867195"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >tonyg</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#26">[#26]</a></td></tr></table></td></tr><tr ><td class="posttext"> Does this do what you're after?<br><textarea class=codebox name="code" wrap=OFF readonly="true" rows="15" cols="80">
' Original author Tim Fisher
Graphics 800,600,0
tRender.Initialise()
Local logo:TImage = LoadImage("max.png",MIPMAPPEDIMAGE|FILTEREDIMAGE)
Local myImage:TImage = tRender.Create(ImageWidth(logo)*4 , ImageHeight(logo)*4 , MIPMAPPED | FILTEREDIMAGE)
tRender.TextureRender(myImage,True)
Cls	
DrawImageRect logo,0,0,ImageWidth(logo),ImageHeight(logo)

SetBlend(ALPHABLEND)
Local t1:Int,t2:Int
While Not KeyHit(KEY_ESCAPE)
	tRender.BackBufferRender() 
	Cls
	SetAlpha 1.0
	DrawImage myimage , MouseX(),MouseY()
	DrawImage logo,300,200
	DrawText (t2-t1),0,0
	Flip
	t1:Int=MilliSecs()
	tRender.TextureRender(myImage,True)
'	Cls	
'	DrawImage logo,0,0
	SetAlpha Rnd(0.3,1.0)
	SetColor Rand(255) , Rand(255) , Rand(255)
	Local cubx:Int = Rand(0 , 200)
	Local cuby:Int=Rand(0,200)
	DrawRect cubx,cuby,20,20
	SetColor 255,255,255
	DrawText "Hello World",10,10
	DrawText ImageWidth(myimage)+ " " + ImageHeight(myimage),10,30
	t2:Int=MilliSecs()
Wend
tRender.BackBufferRender() 
Cls
DrawImage myimage,0,0
Local mypix:TPixmap=CreatePixmap(ImageWidth(logo),ImageHeight(logo),PF_RGBA8888)
ClearPixels(mypix)
mypix=GrabPixmap(0,0,ImageWidth(logo),ImageHeight(logo))
SavePixmapPNG(mypix,"output.png")

Const DDERR_INVALIDSURFACETYPE 	= $88760250
Const DDERR_INVALIDPARAMS		= $80070057
Const DDERR_INVALIDOBJECT 		= $88760082
Const DDERR_NOTFOUND 			= $887600ff
Const DDERR_SURFACELOST 		= $887601c2

Global tRenderERROR:String

Function tError:String(err:Int)

	Select err
		Case DDERR_INVALIDSURFACETYPE
			Return "DDERR_INVALIDSURFACETYPE"
			
		Case DDERR_INVALIDPARAMS
			Return "DDERR_INVALIDPARAMS"
			
		Case DDERR_INVALIDOBJECT 
			Return "DDERR_INVALIDOBJECT"
			
		Case DDERR_NOTFOUND
			Return "DDERR_NOTFOUND"
			
		Case DDERR_SURFACELOST
			Return "DDERR_SURFACELOST"
			
	End Select
End Function

Type tRender
	
	Global DXFrame:TD3D7ImageFrame
	Global backbuffer:IDirectDrawSurface7
	Global Image:TImage = CreateImage(1,1)
	Global Width:Int
	Global Height:Int
	Global o_r , o_g , o_b

Rem
bbdoc: Initialise the Module
about: 
The module must be initialised before use. This ensures usage of the correct render pipeline. If the render device is changed then you must 
re initialise the module.
End Rem		
	Function Initialise()
			D3D7GraphicsDriver().Direct3DDevice7().GetRenderTarget Varptr backbuffer
		DebugLog "tRender : Initialise OK"
		Return True
	End Function
	
'#################################################################################

Rem
bbdoc: Create Image with Render Characteristics
returns: TImage Handle to Object
about: 
 &lt;table&gt;
		&lt;tr&gt;&lt;td&gt;&lt;b&gt;Width:Int&lt;/td&gt;&lt;td&gt;Width in Pixels of Image, try to follow the normal rules of textures&lt;/td&gt;&lt;/tr&gt;
		&lt;tr&gt;&lt;td&gt;&lt;b&gt;Height:Int&lt;/td&gt;&lt;td&gt;Height in Pixels of Image&lt;/td&gt;&lt;/tr&gt;
		&lt;tr&gt;&lt;td&gt;&lt;b&gt;Flags:Int&lt;/td&gt;&lt;td&gt;Normal Image Flags&lt;/td&gt;&lt;/tr&gt;
	&lt;/table&gt;
End Rem	
	Function Create:TImage(Width:Int,Height:Int,Flags:Int=FILTEREDIMAGE)

		Local t:TImage=New TImage
		t.width=width
		t.height=height
		t.flags=flags
		t.mask_r= 0
		t.mask_g= 0
		t.mask_b= 0
		t.pixmaps=New TPixmap[1]
		t.frames=New TImageFrame[1]
		t.seqs=New Int[1]
		t.pixmaps[0]= t.Lock(0,True,False)
		t.seqs[0]=GraphicsSeq
		
			t.frames[0] = CreateFrame(TD3D7Max2DDriver(_max2dDriver),t.Width,t.Height,t.flags)
			
		DebugLog "tRender : Create OK"
		
		
		Return t

	End Function

'#################################################################################
		
	Function CreateFrame:TD3D7ImageFrame( driver:TD3D7Max2DDriver,width,height,flags )				
		Function Pow2Size( n )
			Local t=1
			While t&lt;n
				t:*2
			Wend
			Return t
		End Function

		Local	swidth=Pow2Size(width)
		Local	sheight=Pow2Size(height)
		Local	desc:DDSURFACEDESC2=New DDSURFACEDESC2
		Local	res
						
		desc.dwSize=SizeOf(desc)
		desc.dwFlags=DDSD_WIDTH|DDSD_HEIGHT|DDSD_CAPS|DDSD_PIXELFORMAT
		desc.dwWidth=swidth
		desc.dwHeight=sheight	
		desc.ddsCaps=DDSCAPS_TEXTURE|DDSCAPS_3DDEVICE|DDSCAPS_VIDEOMEMORY|DDSCAPS_LOCALVIDMEM  ' **************************************************
		desc.ddsCaps2=DDSCAPS2_HINTDYNAMIC'|DDSCAPS2_TEXTUREMANAGE
		desc.ddpf_dwSize=SizeOf(DDPIXELFORMAT)
		desc.ddpf_dwFlags=DDPF_RGB|DDPF_ALPHAPIXELS
		desc.ddpf_BitCount=32
		desc.ddpf_BitMask_0=$ff0000
		desc.ddpf_BitMask_1=$00ff00
		desc.ddpf_BitMask_2=$0000ff
		desc.ddpf_BitMask_3=$ff000000

		
		Local surf:IDirectDrawSurface7
		If flags &amp; MIPMAPPEDIMAGE desc.ddsCaps:|DDSCAPS_MIPMAP|DDSCAPS_COMPLEX
		res=D3D7GraphicsDriver().DirectDraw7().CreateSurface( desc,Varptr surf,Null )
		If res&lt;&gt;DD_OK 
			tRenderERROR = tError(res)
			DebugLog "tRender : CreateFrame ERROR : "+tRenderERROR
			Return Null
		EndIf
		'RuntimeError "Create DX7 surface Failed"	
							
		Local frame:TD3D7ImageFrame=New TD3D7ImageFrame
		frame.driver=driver
		frame.surface=surf
		frame.sinfo=New DDSURFACEDESC2
		frame.sinfo.dwSize=SizeOf(frame.sinfo)
		frame.xyzuv=New Float[24]
		frame.width=width
		frame.height=height
		frame.flags=flags
		frame.SetUV 0.0,0.0,Float(width)/swidth,Float(height)/sheight
	
			
		'frame.BuildMipMaps()
		DebugLog "tRender : CreateFrame OK"
		Return frame
	End Function

	
Rem
bbdoc: Begin the Texture Render Process
about: 
 &lt;table&gt;
	&lt;tr&gt;&lt;td&gt;&lt;b&gt;Image:TImage&lt;/td&gt;&lt;td&gt;The Image to Render to, as created with "Create" command.&lt;/td&gt;&lt;/tr&gt;
	&lt;tr&gt;&lt;td&gt;&lt;b&gt;Viewport:Byte&lt;/td&gt;&lt;td&gt;True (default) to Automatically resize the viewport to the image size&lt;/td&gt;&lt;/tr&gt;
 &lt;/table&gt;
End Rem
	Function TextureRender(Image1:TImage,Viewport:Byte=True)
			D3D7GraphicsDriver().Direct3DDevice7().EndScene()

		If Viewport Then 
			Width = image1.width
			Height = image1.height
			
		Else
			Width = GraphicsWidth()
			Height = GraphicsHeight()
		EndIf
		SetViewport(0 , 0 , width , height)
			Local DXFrame:TD3D7ImageFrame = TD3D7ImageFrame (image1.frame(0))
			D3D7GraphicsDriver().Direct3DDevice7().SetRenderTarget( DXFrame.Surface,0)
			D3D7GraphicsDriver().Direct3DDevice7().BeginScene()
	'	debuglog "tRender : TextureRender_Begin OK"
		Return True
	End Function
	
'?win32	
	Function SetMipMap(Image:TImage,Level:Int)
			Local DXFrame:TD3D7ImageFrame = TD3D7ImageFrame (image.frame(0))
			
			'DXFrame.BuildMipMaps()
			
			Local	src:IDirectDrawSurface7
			Local	dest:IDirectDrawSurface7
			Local	caps2:DDSCAPS2
			caps2=New DDSCAPS2
			caps2.dwCaps=DDSCAPS_TEXTURE|DDSCAPS_MIPMAP'|DDSCAPS_3DDEVICE
			caps2.dwCaps2= DDSCAPS2_MIPMAPSUBLEVEL
		
			src = DXFrame.Surface
					
			Local res = src.GetAttachedSurface(caps2,Varptr dest)
			
			If res&lt;&gt;DD_OK 
				tRenderERROR = tError(res)
				Return False
			EndIf
			
			DXFrame.Surface =  dest
			dest.Release_
			
			DebugLog "MipMap Selected OK"
			Return True
	End Function
'#################################################################################
Rem
bbdoc: Begin the Normal BackBuffer Rendering Process
End Rem
	Function BackBufferRender()
			D3D7GraphicsDriver().Direct3DDevice7().EndScene()

			D3D7GraphicsDriver().Direct3DDevice7().SetRenderTarget(backbuffer,0)
		SetViewport(0,0,GraphicsWidth(),GraphicsHeight())
		DebugLog "tRender : BackBufferRender_Begin OK"
		Return True
	End Function
	
End Type


</textarea> <br><br></td></tr></table><br>
<a name="867201"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Jake L.</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#27">[#27]</a></td></tr></table></td></tr><tr ><td class="posttext"> Yes, grabpixmap works. But grabbing the backbuffer with alpha produces bad results (or I have to cheat and draw/grab multiple times), so I thought about using RTT. <br><br></td></tr></table><br>
<a name="867224"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >tonyg</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#28">[#28]</a></td></tr></table></td></tr><tr ><td class="posttext"> The problem is a pixmap is never created not the structure to create one. It's possible to do though... I'd expect. <br><br></td></tr></table><br>
<a name="bottom"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td align="right"><a href="http://monkeycoder.co.nz" target="_blank"><img src="/img/monkey2.svg" ></a> <a href="https://github.com/blitz-research" target="_blank"><img src="/img/github.svg" ></a> <a href="https://discord.gg/qJccbSp" target="_blank"><img src="/img/discord.svg" ></a></td></tr></table><br></div><br><table width="100%"><tr><td></body></html lang="en">
