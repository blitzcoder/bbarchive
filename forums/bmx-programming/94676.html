<!DOCTYPE html><html lang="en" ><head ><title >The Big BlitzMax Lag Test</title><meta name='viewport' content='width=device-width, initial-scale=0.66'><meta name='description' content='language:basic, target:desktop, category:game development'><link rel="styleSheet" href="../skins/granite/style.css" type="text/css"><style type="text/css">div.bbcode {padding: 8px;background: #E5E5E5;color: #000000;border: 1px dashed #B4B4BE;}</style></head><body ><table width=100% cellspacing=0 cellpadding=0><tr ><td class="menubarleft"></td><td class="menubar"><table cellspacing="0" cellpadding="0"><tr ><td >&nbsp;</td><td class="menuitemleft"></td><td class="menuitem"><a href="/" class="menuitem">News</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/forums.php" class="menuitem">Forums</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/codearcs.php" class="menuitem">Code</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/logs.php" class="menuitem">Logs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/gallery.php" class="menuitem">Gallery</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/sdkspecs.php" class="menuitem">Specs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/search.php" class="menuitem">Search</a></td><td class="menuitemright"></td></tr></table></td><td class="menubarright"></td></tr></table><div class="main"><h1 >The Big BlitzMax Lag Test</h1><a href="forums.php" >BlitzMax Forums</a>/<a href="topics.php?forum=102" >BlitzMax Programming</a>/<a href="#bottom" >The Big BlitzMax Lag Test</a><br><br>
<a name="1086954"></a>

<a name="1086955"></a>

<a name="1086956"></a>

<a name="1086957"></a>

<a name="1086958"></a>

<a name="1086959"></a>

<a name="1086961"></a>

<a name="1087075"></a>

<a name="1087160"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Grey Alien</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#1">[#1]</a></td></tr></table></td></tr><tr ><td class="posttext"> OK folks, I've written some test code to demonstrate the BlitzMax DX9/OpenGL rendering lag and proposed fix by CyBeRGoth.<br><br>Summary: DX9 and OpenGL have unacceptable rendering lag in full-screen mode, but it can be fixed. Windowed mode needs more work to fix.<br><br>[EDIT] There seem to be a few misunderstandings about the issue, so please let me clarify:<br><br>1) This is a RENDERING lag, not just a mouse lag, so if you use keys to control a character, you'll see the same lag.  Therefore doing fancy stuff with the mouse cursor is not a solution.<br><br>2) There's no point in discussing timing solutions (and the lack of timing other than vsync in the test code below) as there will still be a rendering lag no matter what timing solution is used if VSync is also on. <br><br>3) I don't want a solution that involves turning off VSync because I don't want to have vertical tearing in my game.  There was no lag in DX7 with VSync - I would just like the same for DX9/OpenGL.<br>[/EDIT]<br><br>Please test it on your machines and report your findings.  Here's what I see:<br><br>Full Screen Mode (fix off):<br>- DX7 green square is smooth, blue square lags a little bit.<br>- DX9 green square is smooth, blue square lags a A LOT.<br>- OpenGL green square is smooth, blue square lags a almost as much as DX9.<br><br>Full Screen Mode (fix on):<br>- DX7 green square is smooth, blue square lags a little bit (same as before)<br>- DX9 green square is smooth, blue square lags a little bit (same as Dx7)<br>- OpenGL green square is smooth, blue square lags a little bit (same as Dx7)<br><br>Full Screen conclusion: There's a bad lag in DX9 and OpenGL but the fix works and doesn't have an adverse effect.  I didn't expect a lag in OpenGL, so that's a surprise.<br><br>Windowed Mode (fix off):<br>- DX7 green square is a bit jerky, blue square lags a little bit.<br>- DX9 green square is smooth, blue square lags a more than DX7.<br>- OpenGL green square is smooth, blue square lags about the same as DX9.<br><br>Windowed Mode (fix on):<br>- DX7 green square is smooth, blue square lags a little bit (same as before)<br>- DX9 green square is smooth, blue square lags more than DX7 (ame as before)<br>- OpenGL green square is smooth, blue square lags about the same as DX9 (same as before).<br><br>Full Screen conclusion: DX7 Flip is jerky but is still VSynced.  There's a medium lag in DX9 and OpenGL.  The fix has no effect (bad or good) to any driver.<br><br><br>***GRAND CONCLUSION***<br><br>If you want your DX9 and OpenGL full-screen games to feel responsive, you need to use the fix.  Also we *need* a fix for windowed mode too, and that's where I'm hoping the uber-intelligent members of the community can help out!  Thanks in advance for your help, this benefits us all.<br><br>Also can anyone foresee any possible adverse effects from using the fix below?<br><br>**********************<br><br>[EDIT]I now made the code Mac compatible.  On Mac I see almost no lag at all in FullScreen mode and the fix does nothing.  In windowed mode I see a small lag and I'm not sure if the fix does anything, it feels like maybe it does, but it's hard to say.  What do you see?<br>[/EDIT]<br><br><pre class=code>
SuperStrict

Const DIRECTX7% = 0
Const DIRECTX9% = 1
Const OPENGL% = 2

Global currentDriver% = DIRECTX7
?MacOS
currentDriver = OPENGL
?
Global fullScreen% = 1
Global useFix% = 0
Global screenWidth% = 0
Global screenHeight% = 0
Global blockX% = 0

SetDriver()
CreateScreen()

While Not KeyHit(KEY_ESCAPE)
	Test()
Wend

End

Function Test()
	Cls

	SetColor 255,255,255
	Local x%,y% = 10
	Local gap% = 15
	DrawText "Press D to change Driver (current = "+GetDriverString()+")",x,y
	y:+gap
	DrawText "Press F to toggle Fix (current = "+useFix+")",x,y	
	y:+gap
	DrawText "Press S to toggle Full Screen",x,y	
	y:+gap
	DrawText "Press Esc to Exit",x,y	
	
	SetColor 100,100,230
	DrawRect MouseX(),MouseY(),50,50
	
	SetColor 100,230,100
	DrawRect blockX, screenHeight-100,50,50
	blockX:+1
	If BlockX&gt;screenWidth Then blockX:-screenWidth
	
	If useFix Then
		Local MouseHack:TPixmap
		MouseHack = GrabPixmap(1, 1, 1, 1)
	EndIf
	
	Flip 1
	Delay(1)	
	
	?win32
	If KeyHit(KEY_D) Then
		currentDriver:+1
		If currentDriver&gt;OPENGL Then currentDriver= DIRECTX7 'wrap
		SetDriver()
		CreateScreen()
	EndIf
	?
	
	If KeyHit(KEY_S) Then
		fullScreen = Not fullScreen
		CreateScreen()
	EndIf

	If KeyHit(KEY_F) Then
		useFix= Not useFix
	EndIf

End Function

Function SetDriver()
	Select currentDriver
		?win32
		Case DIRECTX7
			SetGraphicsDriver D3D7Max2DDriver()
		Case DIRECTX9
			SetGraphicsDriver D3D9Max2DDriver()
		?
		Case OPENGL
			SetGraphicsDriver GLMax2DDriver()
	End Select
End Function

Function CreateScreen()
	If fullScreen Then
		screenWidth = 800
		screenHeight = 600
		Graphics screenWidth, screenHeight, 32
	Else
		screenWidth = 640
		screenHeight = 480
		Graphics screenWidth, screenHeight, 0
	EndIf	
End Function

Function GetDriverString$()
	Select currentDriver
		Case DIRECTX7
			Return "DirectX 7"
		Case DIRECTX9
			Return "DirectX 9"
		Case OPENGL
			Return "Open GL"
	End Select
End Function
</pre><br><br><font class="tiny">Last edited 2011</font><br><br><font class="tiny">Last edited 2011</font> <br><br></td></tr></table><br>
<a name="1086969"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >therevills</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#2">[#2]</a></td></tr></table></td></tr><tr ><td class="posttext"> DX7 Window: Slight lag<br>DX7 Window with Fix: Slight lag<br>DX7 Full Screen: Slight lag<br>DX7 Full Screen with Fix: Slight lag<br><br>DX9 Window: Noticable lag<br>DX9 Window with Fix: Noticable lag (no change)<br>DX9 Full Screen: Noticable lag<br>DX9 Full Screen: Slight lag<br><br>OpenGL Window: Noticable lag (same as DX9)<br>OpenGL Window with Fix: Noticable lag (no change)<br>OpenGL Full Screen: Noticable lag<br>OpenGL Full Screen: Slight lag<br><br>OpenGL and DX9 performed very similar to each other... <br><br></td></tr></table><br>
<a name="1086970"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Grey Alien</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#3">[#3]</a></td></tr></table></td></tr><tr ><td class="posttext"> Great thanks for testing.  Your results are the same as mine then. <br><br></td></tr></table><br>
<a name="1086977"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >joncom2000</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#4">[#4]</a></td></tr></table></td></tr><tr ><td class="posttext"> DX7 Window: Slight lag<br>DX7 Window with Fix: Slight lag<br>DX7 Full Screen: Slight lag<br>DX7 Full Screen with Fix: Slight lag<br><br>DX9 Window: Slight lag<br>DX9 Window with Fix: Slight lag<br>DX9 Full Screen: Noticable lag<br>DX9 Full Screen: Slight lag<br><br>OpenGL Window: Noticable lag <br>OpenGL Window with Fix: Noticable lag<br>OpenGL Full Screen: Slight lag<br>OpenGL Full Screen: Slight lag<br><br>Athlon Quad Core, Vista 32bit, ATI HD4830<br><br>Hmm seems I dont lag in a window in dx9 any different to dx 7 and opengl fullscreen seems pretty low on lag but more moticable windowed. <br><br></td></tr></table><br>
<a name="1086979"></a>

<a name="1086980"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >*</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#5">[#5]</a></td></tr></table></td></tr><tr ><td class="posttext"> same as joncom2000 here:<br>WinXP, Intel 945, 1Ghz Atom<br><br><font class="tiny">Last edited 2011</font> <br><br></td></tr></table><br>
<a name="1086981"></a>

<a name="1086982"></a>

<a name="1086984"></a>

<a name="1086985"></a>

<a name="1086987"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >ziggy</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#6">[#6]</a></td></tr></table></td></tr><tr ><td class="posttext"> Just in case... couldn't you just use Flip -1 and use delta timing? This should avoid the issue... ? Obviously Graphics has to be created without vertical sync, I mean, Graphics width, height, colordepth, <b>0</b><br>most computers don't use CRC monitors nowadays, so I see no problem on doing it this way.<br><br>I got a version of your sample that is lag free, but it's using a custom built delta-timing module.<br><br>Here's the delta module source:<br><br>file: deltatiming.bmx<br><textarea class=codebox name="code" wrap=OFF readonly="true" rows="15" cols="80">
SuperStrict

rem
	More infor about DELTA TIMING here: <a href="http://blideide.wordpress.com/2009/07/01/delta-timing/" target="_blank">http://blideide.wordpress.com/2009/07/01/delta-timing/</a>
end rem

Const DefaultMinimumTimeFactor:Double = 0.25
Const DefaultMaximumTimeFactor:Double = 5

Private
	Global Handler:Int = AddHook(FlipHook, DeltaHook)
	Global Paused:Int = False
	
	Global DeltaTime:Double
	Global LastTiming:Double = MilliSecs()
	Global MinimumTimeFactor:Double = DefaultMinimumTimeFactor
	Global MaximumTimeFactor:Double = DefaultMaximumTimeFactor
	
	Global LastMillisecs:Int = Millisecs()
	Global Counter:Int = 0
	
	Global FPS:Int = 0	
	
	Global slow:Int = False
	Function DeltaHook:Object(id:Int, data:Object, context:Object)
		If Not Paused UpdateTiming()
	End Function
	
	Function UpdateTiming()
		Local MLS:Double = MilliSecs()
		DeltaTime = Abs(MLS - LastTiming) / 10.0
		If DeltaTime &lt; MinimumTimeFactor Then
			While DeltaTime &lt; MinimumTimeFactor
				Delay(1)
				MLS = MilliSecs()
				DeltaTime = Abs(MLS - LastTiming) / 10.0
			Wend
		End If
		LastTiming = MLS
		If DeltaTime &gt; MaximumTimeFactor Then
			DeltaTime = MaximumTimeFactor
			slow = True
		Else
			slow = False
		EndIf
		Counter:+1
		If Abs(LastMillisecs - MLS) &gt; 1000 Then
			FPS = Counter
			Counter = 0
			LastMillisecs = MLS
		End If
	End Function
	
	
Public

rem
	bbdoc:This shared class provides an automated delta-timing factor to be used in games.
	about: this is a shared class, so there's no need to instantiate it, just use its functions.
end rem
Type Delta Abstract
	rem
		bbdoc: This function returns the current delta-timing factor.
	end rem
	Function Factor:Double()
		Return DeltaTime
	End Function
	
	rem
		bbdoc: This function sets the minimum time factor expected.
		about: so if the computer is too fast, the engine automatically adds the needed sleep calls, to avoid a too small delta factor, that could introduce some maths precision issues.&lt;br&gt;
			   Usually a minimum of 0.5 millisec of time per frame is good for calculations.
			   This has a pretended impact on FPS, making them more stable. After setting this, you should not be getting framerates superior to 100/Factor
	end rem
	Function SetMinimumTimeFactor(Factor:Double = DefaultMinimumTimeFactor)
		MinimumTimeFactor = Factor
	End Function
	rem
		bbdoc: This function returns the minimum time factor. Usually 1 millisec per frame is good for calculations. smalle values can introduce visualization glitches.
	end rem
	Function GetMinimumTimeFactor:Double()
		Return MinimumTimeFactor
	End Function
	rem
		bbdoc: This function sets the maximum time factor expected.
		about: This is important becouse if the computer is too slow, we avoid too many frames to be dropped, at a cost of the game being shown a bit slower.&lt;br&gt;Otherwise the game could drop too many frames, affecting calculations.
	end rem
	Function SetMaximumTimeFactor(Factor:Double = DefaultMaximumTimeFactor)
		MaximumTimeFactor = Factor
	End Function
	rem
		bbdoc: This function gets the maximum time factor expected
		about:This is important becouse if the computer too slow, the engine mimics the computer is faster, to avoid getting dropping too many frames, and having too big values on calculation. The game will then be slowed to prevent errors on calculations.
	end rem
	Function GetMaximumTimeFactor:Double()
		Return MaximumTimeFactor
	End Function
	rem
		bbdoc: This function returns TRUE if the game is being slowed due bad hardware, to prevent bad calculations.
	end rem
	Function IsComputerSlow:Int()
		Return slow
	End Function
	rem
		bbdoc: This function will return the curret frames per second.
	end rem
	Function GetFPS:Int()
		Return FPS
	End Function
	
	rem
		bbdoc: Pauses the automatic DeltaTiming engine
	end rem
	Function PauseDeltaTiming()
			Paused = True
	End Function
	
	rem
		bbdoc: Resumes the automatic DeltaTiming engine
	end rem
	Function ResumeDeltaTiming()
		If Paused = True Then
			Self.FlushTiming
			Paused = False
		End If
	End Function
	
	rem
		bbdoc: Resets the delta timing engine. Usefull after a 
	end rem
	Function FlushTiming()
			LastTiming = MilliSecs()
			LastMillisecs:Int = MilliSecs()
			Counter = 0
	End Function
	rem
		bbdoc: Returns TRUE if delta timing calculation is paused. otherwise returns FALSE
	end rem
	Function IsPaused:Int()
		Return Paused
	End Function
	
	Function DebugString:String()
		Local Ret:String
		Ret = "Current delta time factor: " + DeltaTime + "~n"
		Ret:+"Current FPS: " + FPS + "~n"
		If Self.IsPaused() Then
			Ret:+"Delta time paused.~n"
		Else
			Ret:+"Delta time running.~n"
		EndIf
		Ret:+"Minimum time factor: " + MinimumTimeFactor + "~n"
		Ret:+"Maximum time factor: " + MaximumTimeFactor + "~n"
		If slow Then
			Ret:+"Application running slowly: TRUE~n"
		Else
			Ret:+"Application running slowly: FALSE~n"
		EndIf
		Return ret
	End Function
End Type
</textarea><br><br>And this is the "fixed" sample:<br><pre class=code>
SuperStrict
Import "deltatiming.bmx"

Const DIRECTX7% = 0
Const DIRECTX9% = 1
Const OPENGL% = 2

Global currentDriver% = DIRECTX7
Global fullScreen% = 1
Global useFix% = 0
Global screenWidth% = 0
Global screenHeight% = 0
Global blockX:Float = 0

SetDriver()
CreateScreen()

While Not KeyHit(KEY_ESCAPE)
	Test()
Wend

End

Function Test()
	Cls

	SetColor 255,255,255
	Local x%,y% = 10
	Local gap% = 15
	DrawText "Press D to change Driver (current = "+GetDriverString()+")",x,y
	y:+gap
	DrawText "Press F to toggle Fix (current = "+useFix+")",x,y	
	y:+gap
	DrawText "Press S to toggle Full Screen",x,y	
	y:+gap
	DrawText "Press Esc to Exit",x,y	
	
	SetColor 100,100,230
	DrawRect MouseX(),MouseY(),50,50
	
	SetColor 100,230,100
	DrawRect blockX, screenHeight-100,50,50
	blockX:+1 * Delta.Factor()
	If BlockX&gt;screenWidth Then blockX:-screenWidth
	
	If useFix Then GrabPixmap(1, 1, 1, 1)
	
	Flip(-1)
	Delay(1)
	
	If KeyHit(KEY_D) Then
		currentDriver:+1
		If currentDriver&gt;OPENGL Then currentDriver= DIRECTX7 'wrap
		SetDriver()
		CreateScreen()
	EndIf

	If KeyHit(KEY_S) Then
		fullScreen = Not fullScreen
		CreateScreen()
	EndIf

	If KeyHit(KEY_F) Then
		useFix= Not useFix
	EndIf

End Function

Function SetDriver()
	Select currentDriver
		Case DIRECTX7
			SetGraphicsDriver D3D7Max2DDriver()
		Case DIRECTX9
			SetGraphicsDriver D3D9Max2DDriver()
		Case OPENGL
			SetGraphicsDriver GLMax2DDriver()
	End Select
End Function

Function CreateScreen()
	If fullScreen Then
		screenWidth = 800
		screenHeight = 600
		Graphics screenWidth, screenHeight, 32, 0
	Else
		screenWidth = 640
		screenHeight = 480
		Graphics screenWidth, screenHeight, 0, 0
	EndIf
End Function

Function GetDriverString$()
	Select currentDriver
		Case DIRECTX7
			Return "DirectX 7"
		Case DIRECTX9
			Return "DirectX 9"
		Case OPENGL
			Return "Open GL"
	End Select
End Function</pre><br><br><font class="tiny">Last edited 2011</font><br><br><font class="tiny">Last edited 2011</font><br><br><font class="tiny">Last edited 2011</font> <br><br></td></tr></table><br>
<a name="1086992"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >GfK</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#7">[#7]</a></td></tr></table></td></tr><tr ><td class="posttext"> I get slight lag in all cases, with the 'fix' making no difference whatsoever.  And from what I've seen I'm still unconvinced this is a big problem.  Sure, some people claim huge/small/low/lots of lag but what does that really mean?  Its all subjective, really.<br><br>One observation I made from the code above, is that you have <b>Flip 1</b> in there, and then on the very next line you have <b>Delay 1</b>.  This is going to exaggerate any lag effect as you're telling the driver to wait for a vertical blank before flipping, then waste another tick doing absolutely nothing.  If you take out the Delay you'll see in task manager that CPU usage is virtually zero anyway.  Only a small demo, granted, but my current game is exactly the same and I'm not using a Delay.<br><br>On the whole, the system mouse pointer is governed by the OS and is completely independent of your app.  When you use a custom mouse pointer, then all you're really doing is drawing an image at the coordinates the mouse *was* at when you did the drawing.  By the time you get to the next Flip then that's always going to be a few millisecs ago, hence the so-called lag.<br><br>I'm not concerned at all about this any more. <br><br></td></tr></table><br>
<a name="1087010"></a>

<a name="1087011"></a>

<a name="1087019"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >SLotman</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#8">[#8]</a></td></tr></table></td></tr><tr ><td class="posttext"> Just a small comment: I never updated my bmax from 1.28 - and I still use DStatny's DX9 module... which has NO LAG on DX9 in that sample.<br><br>I do get a small lag on DX7 fullscreen, and a big one in OpenGL fullscreen. (and the same in windowed mode).<br><br>The fix only helped OpenGL windowed mode.<br><br>Now try THIS for a change:<br><br><textarea class=codebox name="code" wrap=OFF readonly="true" rows="15" cols="80">
SuperStrict

Const DIRECTX7% = 0
Const DIRECTX9% = 1
Const OPENGL% = 2

Global currentDriver% = DIRECTX7
Global fullScreen% = 1
Global useFix% = 0
Global screenWidth% = 0
Global screenHeight% = 0
Global blockX% = 0

SetDriver()
CreateScreen()

While Not KeyHit(KEY_ESCAPE)
	Test()
Wend

End

Function Test()
	Cls
	Local frameTimer%=MilliSecs()

	SetColor 255,255,255
	Local x%,y% = 10
	Local gap% = 15
	DrawText "Press D to change Driver (current = "+GetDriverString()+")",x,y
	y:+gap
	DrawText "Press F to toggle Fix (current = "+useFix+")",x,y	
	y:+gap
	DrawText "Press S to toggle Full Screen",x,y	
	y:+gap
	DrawText "Press Esc to Exit",x,y	
	
	SetColor 100,100,230
	DrawRect MouseX(),MouseY(),50,50
	
	SetColor 100,230,100
	DrawRect blockX, screenHeight-100,50,50
	blockX:+1
	If BlockX&gt;screenWidth Then blockX:-screenWidth

	Flip 0
	
	While Abs(MilliSecs()-frametimer)&lt;17
		Delay 1
	Wend
	
	If KeyHit(KEY_D) Then
		currentDriver:+1
		If currentDriver&gt;OPENGL Then currentDriver= DIRECTX7 'wrap
		SetDriver()
		CreateScreen()
	EndIf

	If KeyHit(KEY_S) Then
		fullScreen = Not fullScreen
		CreateScreen()
	EndIf

	If KeyHit(KEY_F) Then
		useFix= Not useFix
	EndIf

End Function

Function SetDriver()
	Select currentDriver
		Case DIRECTX7
			SetGraphicsDriver D3D7Max2DDriver()
		Case DIRECTX9
			SetGraphicsDriver D3D9Max2DDriver()
		Case OPENGL
			SetGraphicsDriver GLMax2DDriver()
	End Select
End Function

Function CreateScreen()
	If fullScreen Then
		screenWidth = 800
		screenHeight = 600
		Graphics screenWidth, screenHeight, 32
	Else
		screenWidth = 640
		screenHeight = 480
		Graphics screenWidth, screenHeight, 0
	EndIf	
End Function

Function GetDriverString$()
	Select currentDriver
		Case DIRECTX7
			Return "DirectX 7"
		Case DIRECTX9
			Return "DirectX 9"
		Case OPENGL
			Return "Open GL"
	End Select
End Function

</textarea><br><br>No 'mouse fix' necessary. Just Flip 0, and a small code to wait for 60 fps.<br>With this, I get no mouse lag, on any driver.<br><br>The post above which says about Flip 1 : Delay 1, is completely correct btw - you're waiting for the vertical retrace to end, and on top of that waiting 1 more millisecond, which seems to be the cause of the lag.<br><br>On my code above - I render the screen as fast as possible - then I wait 'manually' for 60fps, with delay to release the extra time to the OS.<br><br>I believe bmax has this built-in with Flip -1, but haven't tested it.<br><br><font class="tiny">Last edited 2011</font><br><br><font class="tiny">Last edited 2011</font> <br><br></td></tr></table><br>
<a name="1087013"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >GfK</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#9">[#9]</a></td></tr></table></td></tr><tr ><td class="posttext"> I don't think that using a software version that's three years out of date, is any solution at all.  There will be countless other issues that have been fixed in more recent versions.<br><br>You could probably use Doug's DX9 module with the latest version of Blitzmax if you wanted to. <br><br></td></tr></table><br>
<a name="1087018"></a>

<a name="1087020"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >SLotman</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#10">[#10]</a></td></tr></table></td></tr><tr ><td class="posttext"> Yeah, but I've been fixing stuff myself, I made all modules superstrict, built some custom commands like AppIcon, etc. So it isn't exactly 'vanilla bmax 1.28' :)<br><br>The solution isn't on bmax 1.28 - read my post again, and you'll see it's probably the flip 1 / delay 1 thingie.<br><br><font class="tiny">Last edited 2011</font> <br><br></td></tr></table><br>
<a name="1087043"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >maverick69</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#11">[#11]</a></td></tr></table></td></tr><tr ><td class="posttext"> Can somebody explain to me how and why the fix works:<br><br><pre class=code>
Local MouseHack:TPixmap
MouseHack = GrabPixmap(1, 1, 1, 1)
</pre><br><br>Sorry, if this was discussed earlier, but I didn't found anything related on the forum. <br><br></td></tr></table><br>
<a name="1087059"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >HrdNutz</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#12">[#12]</a></td></tr></table></td></tr><tr ><td class="posttext"> It seems the problem if Flip related; with vsync enabled the driver waits before presenting the back buffer, so when you see the frame, it was actually from long time in the past, and the system mouse has plenty of time to do some roaming around the screen.  <br><br>Disabling vsync allows faster screen presentation, thus reducing the discrepancy between code and system pointers.  That's why SLotman's example works; you present the frame first and the timing delay happens while you are already looking at the current frame, instead of waiting to see it.<br><br>Syncing up the pointers with vsync enabled appears to be problematic or impossible.  Disabling vsync breaks smoothness for some games.  It's really a trade-off.<br><br>Something like this could work in theory, but does not in reality:<br><br>cls<br>drawgame()<br>flip 1<br>drawmouse()<br>flip 0<br><br>Using FlipHook doesn't work either, because the delay is in the driver, so that makes no difference. <br><br></td></tr></table><br>
<a name="1087061"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >DStastny</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#13">[#13]</a></td></tr></table></td></tr><tr ><td class="posttext"> The fix works by stalling the GPU.  Grabbing a pixmap requires the GPU to finish drawing before the lock in in place.<br><br>On my version of the DX Driver I implemented a CompletionQuery to determine when the GPU was finished drawing as opposed to locking.  It seemed to work correctly on windows mode where locking did not.   <br><br>I pretty much abandoned working on the DX9 driver since most people thought mark would do better job with "Official" one.  Code is still on Google if anyone wants to try and retrofit the code into Mark's driver.<br><br>Doug <br><br></td></tr></table><br>
<a name="1087073"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Grey Alien</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#14">[#14]</a></td></tr></table></td></tr><tr ><td class="posttext"> Thanks for testing and for everyone's suggestions:<br><br>Some points:<br><br>1) I don't want to use Flip 0 or -1 as it will result in tearing on the graphics, this is why I have used VSync for years.<br>2) They Delay(1) is not causing a problem.  Take it out and see for yourself.<br>3) It's not just an issue with the mouse.  If you code in a block that moves with the keys, you'll see the same lag issue.<br><br>My understanding of the problem is the same as HrdNutz in that the display gets more than one frame behind.  Back in 2006/07 the same issue existed with DX7 and we used a temporary fix (which started off as a GrabImage I believe and then got more sophisticated) for a while until BRL fixed it.  Now I believe the same needs to happen for DX9.<br><br>@DStastny: So your fix works in windowed mode, sounds good!  Any chance of posting that code here for lazy folks like me and suggesting where it needs to be used?  Thanks! <br><br></td></tr></table><br>
<a name="1087076"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Grey Alien</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#15">[#15]</a></td></tr></table></td></tr><tr ><td class="posttext"> Ok I just made the test Mac compatible and I found this:<br><br>On Mac I see almost no lag at all in FullScreen mode and the fix does nothing.  In windowed mode I see a small lag and I'm not sure if the fix does anything, it feels like maybe it does, but it's hard to say.  What do you see? <br><br></td></tr></table><br>
<a name="1087092"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >SLotman</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#16">[#16]</a></td></tr></table></td></tr><tr ><td class="posttext"> Flip 0 won't cause tearing by itself. <br><br>Tearing happens only if you redraw the screen again, before the screen drawing (the vertical retrace) is completed - so you get part of the old screen and part of the 'new' one visible at the same time.<br><br>The waiting code right after the flip prevents it - unless the computer is too slow to draw the whole screen - which then you should use flip false anyway to improve performance. <br><br></td></tr></table><br>
<a name="1087100"></a>

<a name="1087101"></a>

<a name="1087103"></a>

<a name="1087105"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Grey Alien</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#17">[#17]</a></td></tr></table></td></tr><tr ><td class="posttext"> SLotman: Your code exhibits vertical tearing quite clearly in full screen mode and jerkiness in windowed mode on my PC (make the box about 500 pixels and it's really obvious).  The timing code you've added isn't accurate enough because 60Hz means 16.6666666 (recurring) millisecs per frame (so it'll go out of sync every so often). Also you are starting the timer at an arbitrary place in the draw cycle. The only way flip 0 would not show tearing is if you called it when the scan line was at the top or bottom of the screen, which effectively means it is vsynced anyway.<br><br><font class="tiny">Last edited 2011</font> <br><br></td></tr></table><br>
<a name="1087102"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >H&amp;K</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#18">[#18]</a></td></tr></table></td></tr><tr ><td class="posttext"> Ermm,<br><br>I don't see how anyone can say that they had lag on the green box, because there is nothing to compare it with (Ie the blue box is lagging compared to the mouse, but the green is just incomparable)<br><br>Having said that, the green box in my opengl example moves about 40 times faster then the dx ones.<br><br>As to the mouse, <br><br>You know those games that are normally full screen, but for some reason they drop to windowed? (like when your firewall pops up or the like). Well anyway often you have two mice pointers at that point, the OS one, and the game one.<br>I cannot think of a single example where this happens that the game one DOESN'T lag the OS one. <br><br></td></tr></table><br>
<a name="1087104"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Grey Alien</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#19">[#19]</a></td></tr></table></td></tr><tr ><td class="posttext"> @H&amp;K: No one is saying they had lag on the green box, that's just there to test how smooth the vsync is.<br><br>Sounds like you've disable vsync for OpenGL for your videocard, which is why you can't rely on vsync for timing, and need delta time or fixed rate logic.<br><br>Yes the game pointer will always lag the OS one, but the idea is to reduce that lag as much as possible, and it's much worse in some drivers than others. <br><br></td></tr></table><br>
<a name="1087106"></a>

<a name="1087108"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >H&amp;K</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#20">[#20]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> @H&amp;K: No one is saying they had lag on the green box, that's just there to test how smooth the vsync is <br></div>doh<br><br>OK, new test, can everyone add the command <br><pre class=code>Hidemouse()</pre><br>Just after CreateScreen().<br><br>Ok, who still has a noticeably lagging blue box?<br><br>I know this "isn't" a fix, but on my system at least I'm totally unable to tell that the box is lagging my mouse movements. I'm gonna ignore this problem unless someone is able to tell (easily) that lag is there without the OS mouse visible<br><br>Edit. If it gets "fixed" thou I wouldn't ignore the solution<br><br><font class="tiny">Last edited 2011</font> <br><br></td></tr></table><br>
<a name="1087112"></a>

<a name="1087115"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >ziggy</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#21">[#21]</a></td></tr></table></td></tr><tr ><td class="posttext"> I think the lag is caused directly becouse of the system.Poll being called before the flip operation, and the Flip operation taking too long, so when the drawed rectangle is finally shown, it is "late" it has wrong coords. It seems that the DX7 is making the SystemPoll with some diferences, so the data is not calcualted until it is requested on code, or the wait operation happens after the frame is shown (then wait, and then refresh poll). IMHO This should be the best scenario, but haven't tested.<br><br>EDIT: This is just an assumption, haven't found a way to reset the PolledInput after each Flip operation to see if it makes any difference...<br><br><font class="tiny">Last edited 2011</font> <br><br></td></tr></table><br>
<a name="1087119"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Grey Alien</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#22">[#22]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> Ok, who still has a noticeably lagging blue box? <br></div>I do and my customers noticed it too, which I why I brought up the whole issue.  The mouse cursor is just shown here to help clearly identify and fix the problem.  You can ignore the problem, but I don't want to because I view it as serious, especially for arcade games where you use keys to control a character (which I started to make recently) - it feels really laggy and will result in lost sales and bad reviews.<br><br>@Ziggy: This is the old code that fixed the issue on DX7, you can see it locks,unlocks the buffer which is like using the GrabImage fix from above:<br><br><pre class=code>

		If TD3D7Max2DDriver(_max2dDriver)
			Local sdesc:DDSurfaceDesc2 = New DDSurfaceDesc2
			sdesc.dwSize = SizeOf(sdesc)
			Local res:Int = PrimaryDevice.backbuffer.Lock(Null,sdesc,DDLOCK_WAIT|DDLOCK_READONLY,Null)
			PrimaryDevice.backbuffer.unlock(Null)
			Return res
		EndIf
</pre> <br><br></td></tr></table><br>
<a name="1087124"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >H&amp;K</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#23">[#23]</a></td></tr></table></td></tr><tr ><td class="posttext"> Change <br><pre class=code>DrawRect MouseX(),MouseY(),50,50</pre><br>to<br><pre class=code>DrawRect MouseX()+MouseXSpeed(),MouseY()+MouseYSpeed(),50,50</pre> <br><br></td></tr></table><br>
<a name="1087135"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Grey Alien</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#24">[#24]</a></td></tr></table></td></tr><tr ><td class="posttext"> An interesting workaround thanks.  That appears to make the lag look less bad, but it feels odd - hard to describe, but like jerky or something.  Unfortunately I can't use the same technique for keyboard input. <br><br></td></tr></table><br>
<a name="1087144"></a>

<a name="1087145"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >H&amp;K</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#25">[#25]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> That appears to make the lag look less bad, but it feels odd - hard to describe, but like jerky or something <br></div>Thats because the OS is probably using some sort of mouse smoothing, whereas the blue box isn't. (This means the Blue Box is REALLY where the mouse is pointing, and its the mouse which is all "damp and stiff)<br><br>It's quite easily fixed by putting in some mouse smoothing ie<br><pre class=code>DrawRect MouseX()+(MouseXSpeed()+lastmousexsp)/2,MouseY()+(MouseYSpeed()+lastmouseysp)/2,50,50</pre>However it will now almost certainly NOT keep pace with the OS mouse on the start of fast movements, (which I think you will attribute to lag, rather than simply different positional results)<br><pre class=code>DrawRect MouseX()+(MouseXSpeed()+lastmousexsp/2)/1.5,MouseY()+(MouseYSpeed()+lastmouseysp/2)/1.5,50,50</pre>Gives a better result, but again it wont look exactly like the OS, because as you said its just a workaround and without knowing exactly how the OS is going to calculate it, we are just theory modelling<br><br>As to the key input, no idea sorry, Im in the Fixed timed Event driven camp, and as long as Im keep ontop of the queue dont seem to have any problems. PLUS cos I dont have clients/customers I can accept things like this if they dont bother me that much.<br>(PS If no one else is Fixed Timed Event Driven, then Im obviously just a camp of one ;(<br><br><font class="tiny">Last edited 2011</font> <br><br></td></tr></table><br>
<a name="1087150"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >maverick69</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#26">[#26]</a></td></tr></table></td></tr><tr ><td class="posttext"> Isn't it possible to use the OS "Hardware"-Cursor?<br><br>Mac OS X:<br><a href="https://developer.apple.com/library/mac/#documentation/Cocoa/Reference/ApplicationKit/Classes/NSCursor_Class/Reference/Reference.html" target="_blank">https://developer.apple.com/library/mac/#documentation/Cocoa/Reference/ApplicationKit/Classes/NSCursor_Class/Reference/Reference.html</a><br><br>Windows:<br><a href="http://msdn.microsoft.com/en-us/library/ff468815(v=VS.85).aspx" target="_blank">http://msdn.microsoft.com/en-us/library/ff468815(v=VS.85).aspx</a><br><br>I tried it on OS X and it seems to work in windowed mode. If I switch to fullscreen within the BlitzMax Application it also works, but if I start in Fullscreen Mode it doesn't work. Very weird.<br><br>Didn't tried it on Windows yet.<br><br>I think there are also some restrictions in image size and depth of the cursor image.<br><br><pre class=code>
because the delay is in the driver
</pre><br><br>Hmmm... so can't it be fixed within the max2d-driver instead of writing ugly workarounds (or did you mean the problem is in the OS Driver)??? <br><br></td></tr></table><br>
<a name="1087151"></a>

<a name="1087152"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >col</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#27">[#27]</a></td></tr></table></td></tr><tr ><td class="posttext"> @Grey Alien...<br><br>Hiya,<br>Is this the same method that you use in all your games ??<br><br>I'd recommend to use delta timing for all games, specifically so that all machines can visualise your games at the same speed ( the speed that the game is intended to be viewed at ).<br>You'd  get a uniform gameplay speed across all machines regardless of the cpu and gpu speeds.<br>Your code does show the lag, but its too dependent on 'waiting' for the VSync.<br>Ziggys code is a good example of how to incorporate it and it doesnt suffer any lag at all in fullscreen and only the tiniest lag ( which is so small i shouldn't really even mention it, but it is there ) in windowed mode for all drivers.<br><br><font class="tiny">Last edited 2011</font> <br><br></td></tr></table><br>
<a name="1087154"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Grey Alien</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#28">[#28]</a></td></tr></table></td></tr><tr ><td class="posttext"> Thanks for the cursor suggestions people, but it's not just a mouse issue, it's a display lag and so keyboard input also lags.  Doing stuff with the mouse only solves half the problem.<br><br>@Jochen: I'm pretty sure the BlitzMax DX9/OpenGL drivers just need some small tweaks by BRL, like they did for DX7 a few years back to remove its display lag. <br><br>@col: No, of course I don't use that timing for my games :-) I have a good timing method in my framework, this is just a quick bit of sample code to show the lag issue (as per your request).  Ziggy's code is fine if you want a game with no vsync that will display vertical tearing, but I prefer to use vsync.  With Flip 1 in Dx7 there's only a tiny lag that no one really notices, so the problem is definitely with the Blitzmax DX9 (and OpenGL) drivers - that's what I'm trying to get a fix for.  The most promising of which seems to be Doug's, so I hope he checks back in soon... <br><br></td></tr></table><br>
<a name="1087156"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >maverick69</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#29">[#29]</a></td></tr></table></td></tr><tr ><td class="posttext"> @col<br><br>delta timing has other problems, for example if the framerate drops it's possible, for example, that collisions don't work any more. also, if most of the game works with integers some floating accuracy problems may occur.<br><br>another possibility is to use render tweening which is the best way to go, but it requires some extra work and is hard to implement if you have an almost finished projects. <br><br></td></tr></table><br>
<a name="1087164"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Grey Alien</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#30">[#30]</a></td></tr></table></td></tr><tr ><td class="posttext"> Did some research and someone else (http://www.gamedev.net/topic/457105-mouse-lag-under-directx9/) said "The thing causing the lag was the presentation interval. I've switched from INTERVAL_IMEMDIATE to INTERVAL_ONE, and no problems!"<br><br>Also a good explanation here of why there's a 50ms lag and using a similar lock/unlock fix: <a href="http://area.xors3d.com/forums/viewtopic.php?f=7&amp;t=470&amp;start=0" target="_blank">http://area.xors3d.com/forums/viewtopic.php?f=7&amp;t=470&amp;start=0</a><br><br>Some people trying to solve the problem in Ogre: <a href="http://area.xors3d.com/forums/viewtopic.php?f=7&amp;t=470&amp;start=0" target="_blank">http://area.xors3d.com/forums/viewtopic.php?f=7&amp;t=470&amp;start=0</a><br><br>There's a really good detailed post by Zoner at the bottom of this thread: <a href="http://www.gamedev.net/topic/592845-vsync-causing-input-lag/" target="_blank">http://www.gamedev.net/topic/592845-vsync-causing-input-lag/</a> <br><br></td></tr></table><br>
<a name="1087165"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Grey Alien</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#31">[#31]</a></td></tr></table></td></tr><tr ><td class="posttext"> And also a similar explanation from NVidia <a href="http://www.nvidia.co.in/object/General_FAQ.html#G4" target="_blank">http://www.nvidia.co.in/object/General_FAQ.html#G4</a> <br><br></td></tr></table><br>
<a name="1087172"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Grey Alien</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#32">[#32]</a></td></tr></table></td></tr><tr ><td class="posttext"> This seems to be the thread in which Doug says he fixed render buffering (input lag) but I can't see where to download the driver from, it's getting late here so I may just be blind: <a href="http://www.blitzbasic.com/Community/posts.php?topic=84089" target="_blank">http://www.blitzbasic.com/Community/posts.php?topic=84089</a> <br><br></td></tr></table><br>
<a name="1087181"></a>

<a name="1087184"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >col</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#33">[#33]</a></td></tr></table></td></tr><tr ><td class="posttext"> @maverick69<br><br>Thats very true. If youre going to use it then you need to build everything from the start incorporating it.<br>Not a good idea if the project is finished or near completion.<br><br>@Grey Alien<br>Is <a href="http://code.google.com/p/max2ddx9/" target="_blank">This</a> what you're looking for ?? I haven't checked it yet.<br><br><font class="tiny">Last edited 2011</font> <br><br></td></tr></table><br>
<a name="1087204"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Grey Alien</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#34">[#34]</a></td></tr></table></td></tr><tr ><td class="posttext"> Looks like it thanks col.  I still don't know if I'll be able to find the magic code and then figure out where to put it in BRL's DX9 modules.  That's the bit I'd love some help with. <br><br></td></tr></table><br>
<a name="1087609"></a>

<a name="1087610"></a>

<a name="1087611"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >col</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#35">[#35]</a></td></tr></table></td></tr><tr ><td class="posttext"> Out of curiosity, are those suffering from the lag using LCD or CRT screens ? If people wouldnt mind replying with 'Yes/No to lag, LCD or CRT'. Thanks.<br><br>@Grey Alien...<br>That code doesn't work 'as is' when simply put into the mod folder and built. It needs a few tweeks, maybe because of BMax updates? Also the code looks very similar in logic to the DX7 driver code... hmm :o)<br><br>Stay tuned... this isnt dismissed.<br><br><font class="tiny">Last edited 2011</font> <br><br></td></tr></table><br>
<a name="1087619"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Grey Alien</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#36">[#36]</a></td></tr></table></td></tr><tr ><td class="posttext"> OK cool.  Glad someone with epic skillz is on the case!<br><br>I was using LCD, but seeing as you can see the system mouse and the blue square are clearly lagging, screen type shouldn't make a difference right?  If there was no system cursor, then sure the lag could potentially be blamed on display device (like laggy large screen TVs and the Rock Band calibration you have to do). <br><br></td></tr></table><br>
<a name="1087687"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >TaskMaster</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#37">[#37]</a></td></tr></table></td></tr><tr ><td class="posttext"> This result is because of vsync.  I don't think you will be able to fix it.<br><br>What you are seeing is that you prepare your screen to be drawn, but then wait for 15ms before you draw it.  The world hasn't stopped to wait, the mouse is still moving.  So, when your screen finally draws to screen, the user has moved the mouse for 15ms more.<br><br>I do not believe there is any way you are going to fix this.  The only way to truly minimize this effect is to somehow know when the flip is going to occur, and draw your screen 2ms before the screen updates.<br><br>In other words:<br><br>With a vsync of 60, each frame is drawn every 16ms.  This is an example of how it is progressing...<br><br>1ms: you get the mouse coords and draw all of your stuff.<br>2ms: you sit and wait for the vsync<br>3ms: you sit and wait for the vsync<br>.<br>.<br>.<br>15ms: you sit and wait for the vsync<br>16ms: you display your screen<br><br>You updated the positions of everything and read the keyboard inputs and whatnot 15ms ago, but you just now displayed your screen.  But, the mouse has continued to be moved for 15ms more in between that time.<br><br>Now, if you could somehow do this:<br><br>1ms: Do nothing<br>2ms: Do nothing<br>3ms: Do nothing<br>.<br>.<br>.<br>15ms: Get the mouse coords and draw all of your stuff<br>16ms: Display your screen<br><br>then apparent the lag would go away.  I do not think it has anything to do with the drivers or anything else.  It is just the way you are doing it.  There is no simple solution except trying to guess when the vsync will happen and not updating your screen until right before. <br><br></td></tr></table><br>
<a name="1087690"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >TaskMaster</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#38">[#38]</a></td></tr></table></td></tr><tr ><td class="posttext"> And, I believe the reason you think you see more lag in DX9 is because DX9 is faster than DX7.  DX7 is taking a bit longer to do the graphics operations so there is maybe 11ms of dead space between between your logic and the screen actually displaying.  Whereas DX9 is probably so much faster that there is 14 or 15ms of dead space between your logic and the screen actually updating.<br><br>If you could somehow figure out how much dead time there is, then you could delay that much before doing your logic, then your logic would be happening right before the screen displays and your logic would not lag a tiny bit.<br><br>That is why not using vsync and delta timing seems to solve the problem. <br><br></td></tr></table><br>
<a name="1087694"></a>

<a name="1087695"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >col</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#39">[#39]</a></td></tr></table></td></tr><tr ><td class="posttext"> Can you try this code. I've incorporated the basics from the driver by DStastny into my core BMax setup. Had to change a few things including some filenames to get it working with minimal changes. There is still some work to be done in the driver but let's see if it a viable fix first before proceeding any further.<br><br>NOTE :- Its only the DX9 driver code that has changed. It uses the test code from the very first post above without any alterations at all. To be honest its seems to be the best ( most minimal lag while not using some kind of delta timing )  on my system in fullscreen and windowed mode, and using the fix option actually creates a slight lag in all modes by comparison.<br><br>One side effect is that the blue box isnt as smooth as with the original driver code, but it keeps up with the mouse, only lagging a few pixels at most, a small price to pay??<br><br><a href="http://www.datafilehost.com/download-37c3131e.html" target="_blank"><b>DOWNLOAD HERE</b></a><br><br><font class="tiny">Last edited 2011</font> <br><br></td></tr></table><br>
<a name="1087714"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Grey Alien</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#40">[#40]</a></td></tr></table></td></tr><tr ><td class="posttext"> @TaskMaster: The lag is much longer than a few milliseconds, it's several frames.  Those links I posted explain what DX9 is doing that makes the lag worse.  I agree that within a single frame, yes it would be better to read the mouse position at the end if using VSync.<br><br>@col: Awesome, testing now. <br><br></td></tr></table><br>
<a name="1087718"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Grey Alien</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#41">[#41]</a></td></tr></table></td></tr><tr ><td class="posttext"> @col: Great work!  Here are my findings:<br><br>Windowed Mode DX9: The lag does seem to be reduced a bit so it's less than OpenGL, but it's still not as minimal as DX7.  One problem is that the green square is jerky now, which must mean that the graphics card isn't delivering the frames smoothly.  If I switch on the original fix the green square becomes a lot smoother and so does the mouse movement.<br><br>Full Screen Mode DX8: The lag is tiny (better than DX7), it's truly excellent.  However, again the green square is jerky, and if I turn on the fix it becomes smooth.<br><br>So perhaps some combination of both fixes (original + yours) is required? <br><br></td></tr></table><br>
<a name="1087722"></a>

<a name="1087725"></a>

<a name="1087726"></a>

<a name="1087735"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >HrdNutz</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#42">[#42]</a></td></tr></table></td></tr><tr ><td class="posttext"> TaskMaster is right, the lag is coming from one frame because the driver waits to present the screen with vsync enabled.  Delaying the Flip call and processing input right before can help reduce the discrepancy, but you gotta be careful and not delay long enough to miss the vertical trace.  <br><br>I modified the original code to demonstrate:<br><br>moved the mouse and input code after the delay<br>added quick check for delta time<br>removed the delay after Flip (not sure why its there to begin with)<br><br><pre class=code>
SuperStrict

Const DIRECTX7% = 0
Const DIRECTX9% = 1
Const OPENGL% = 2

Global currentDriver% = DIRECTX9
?MacOS
currentDriver = OPENGL
?
Global fullScreen% = 1
Global useFix% = 0
Global screenWidth% = 0
Global screenHeight% = 0
Global blockX% = 0

SetDriver()
CreateScreen()

While Not KeyHit(KEY_ESCAPE)
	Test()
Wend

End

Function Test()
	Local frame_time# = MilliSecs()
	Cls

	SetColor 255,255,255
	Local x%,y% = 10
	Local gap% = 15
	DrawText "Press D to change Driver (current = "+GetDriverString()+")",x,y
	y:+gap
	DrawText "Press F to toggle Fix (current = "+useFix+")",x,y	
	y:+gap
	DrawText "Press S to toggle Full Screen",x,y	
	y:+gap
	DrawText "Press Esc to Exit",x,y	
	
	SetColor 100,230,100
	DrawRect blockX, screenHeight-100,50,50
	blockX:+1
	If BlockX&gt;screenWidth Then blockX:-screenWidth
	
	If useFix Then
		Local MouseHack:TPixmap
		MouseHack = GrabPixmap(1, 1, 1, 1)
	EndIf
	
	' process input and mouse after this delay
	' you want to stall as long as possible,
	' but not long enough to miss the vertical trace
	frame_time = MilliSecs() - frame_time
	Delay(16 - frame_time)	
	
	?win32
	If KeyHit(KEY_D) Then
		currentDriver:+1
		If currentDriver&gt;OPENGL Then currentDriver= DIRECTX7 'wrap
		SetDriver()
		CreateScreen()
	EndIf
	?
	
	If KeyHit(KEY_S) Then
		fullScreen = Not fullScreen
		CreateScreen()
	EndIf

	If KeyHit(KEY_F) Then
		useFix= Not useFix
	EndIf
	
	SetColor 100 , 100 , 230
	DrawRect MouseX() , MouseY() , 50 , 50	
	
	Flip 1
	

End Function

Function SetDriver()
	Select currentDriver
		?win32
		Case DIRECTX7
			SetGraphicsDriver D3D7Max2DDriver()
		Case DIRECTX9
			SetGraphicsDriver D3D9Max2DDriver()
		?
		Case OPENGL
			SetGraphicsDriver GLMax2DDriver()
	End Select
End Function

Function CreateScreen()
	If fullScreen Then
		screenWidth = 800
		screenHeight = 600
		Graphics screenWidth, screenHeight, 32, 60
	Else
		screenWidth = 640
		screenHeight = 480
		Graphics screenWidth, screenHeight, 0
	EndIf	
End Function

Function GetDriverString$()
	Select currentDriver
		Case DIRECTX7
			Return "DirectX 7"
		Case DIRECTX9
			Return "DirectX 9"
		Case OPENGL
			Return "Open GL"
	End Select
End Function
</pre><br><br><font class="tiny">Last edited 2011</font><br><br><font class="tiny">Last edited 2011</font> <br><br></td></tr></table><br>
<a name="1087724"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Grey Alien</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#43">[#43]</a></td></tr></table></td></tr><tr ><td class="posttext"> Thanks for posting that code HrdNutz but I'm still seeing a pretty big lag on DX9 and OpenGL when compared to DX7.  Your fix no doubt improves the lag by one frame's worth, but the DX9 lag is 3 frames worth by default: Check out those links I posted above and you'll see what I mean.  No amount of timing code is going to fix the DX9 rendering lag, only altering the way the driver renders at a lower level will. <br><br></td></tr></table><br>
<a name="1087728"></a>

<a name="1087730"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >HrdNutz</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#44">[#44]</a></td></tr></table></td></tr><tr ><td class="posttext"> it's a lot better, but getting it perfect is impossible; timing in blitz just isnt sensitive enough for max delay, and direct x is also doing things after the flip call but before actually presenting the screen.<br><br>when you run SLotmans example with vsync disabled the lag should be minimal and pretty much related to the driver.  if you're seeing minimal lag there, then the whole problem should be in one frame.  What the DX driver does with vsync enabled should be tuned for best performance.<br><br><font class="tiny">Last edited 2011</font> <br><br></td></tr></table><br>
<a name="1087729"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Grey Alien</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#45">[#45]</a></td></tr></table></td></tr><tr ><td class="posttext"> @HrdNutz: Sorry but it's not a lot better on my PC, it's only a bit better.  Col's code is a LOT better because it addresses the real issue (the 3 frames being pre-rendered when vSync is being used).  Check this out:<br><br>"Hi, i have a problem when i use vsync. Each frame is displayed every 16.6 ms @ 60fps. DirectX pre renders 3 frames by default giving a delay 50ms. Most GPU drivers allow you to change the pre-render limit down to 0 if needed. Nvidia is an example. Most modern games also allow you to change this and override the GPU Driver. A reason for this is some GPU's like all of intel's and some of ATI's don't have any driver control for DX9. Games like Battlefield 2 Bad Company and Counterstrike Source have options for this. If you have ever seen mouse lag on games when vsync is enabled, this is why. You can do a simple test by moving a sprite with the mouse while the hardware mouse cursor is displayed. The sprite will lag behind the mouse pointer. The Windows mouse pointer is also vsynced on the aero desktop (vista/win7) but there is no pre rendering going on so you can see the difference. This is very important for smooth gameplay and quick input response. By the way, this has nothing to do with double or triple buffering. I think microsoft call it the render queue and its a set of frames pre rendered before the double/triple buffering takes place."<br><br>From: <a href="http://area.xors3d.com/forums/viewtopic.php?f=7&amp;t=470&amp;start=0" target="_blank">http://area.xors3d.com/forums/viewtopic.php?f=7&amp;t=470&amp;start=0</a><br><br>This information was also backed up on other threads I found (links above) including information from NVidia. <br><br></td></tr></table><br>
<a name="1087731"></a>

<a name="1087732"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >HrdNutz</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#46">[#46]</a></td></tr></table></td></tr><tr ><td class="posttext"> Grey, whats your monitors default desktop refresh rate?  Try running the code again but in fullscreen mode @ 60Hz, Graphics 640, 480, 32, 60<br><br>im suspecting that Delay(16-frame_time) is too short for anything above 60Hz, also try enabling your fix as well.<br><br>On my PC the lag is virtually non-existent<br><br><font class="tiny">Last edited 2011</font> <br><br></td></tr></table><br>
<a name="1087733"></a>

<a name="1087734"></a>

<a name="1087736"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >AdamRedwoods</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#47">[#47]</a></td></tr></table></td></tr><tr ><td class="posttext"> HrdNutz's code:<br><pre class=code>
' process input and mouse after this delay
	' you want to stall as long as possible,
	' but not long enough to miss the vertical trace
	frame_time = MilliSecs() - frame_time
	Delay(16 - frame_time)
</pre> causes massive delays on my system.<br><br>The way I understand the problem is that the OS system's mouse runs on a different refresh than the app. The app would never be able to keep pace, unless we can draw the objects following the cursor at the same rate as the OS (decouple our internal drawing routine).<br><br>MY PROPOSED FIX:<br>Draw your own mouse cursor (looks same as OS) as a sprite and hide the OS mouse cursor when over the window.<br><br>This would slow down the cursor in the window.<br><br><font class="tiny">Last edited 2011</font> <br><br></td></tr></table><br>
<a name="1087737"></a>

<a name="1087738"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >HrdNutz</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#48">[#48]</a></td></tr></table></td></tr><tr ><td class="posttext"> Adam, you're probably missing the vertical trace with that delay.  This isn't really a fix, just wanted to demonstrate the problem with vsync.  Try changing your delay to 15- or 14- and run in full screen at 60Hz.  IMO if you can get as close as possible to vsync, you can minimize the lag, and the game will be playable.<br><br><font class="tiny">Last edited 2011</font> <br><br></td></tr></table><br>
<a name="1087741"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Grey Alien</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#49">[#49]</a></td></tr></table></td></tr><tr ><td class="posttext"> @HrdNutz: My screen refreshes at 60 so when I changed the Graphics call it didn't have any effect.  When I enable the fix the lag is very small, a little bit smaller than in my first bit of code due to your code which reads the mouse coords at the last possible split second.  Compare DX7 and DX9 in full-screen on your PC.  If there really is no difference then you must have a) turned off VSync in your gfx card drivers so that Flip 1 in BMX isn't working (I know that this is possible as I can do it on my card), or b) somehow reduced the pre-render frames from the default of 3 to 0 on your system, or c) you aren't using the default BMX DX9 driver in BMax 1.41 or higher, or d) I have no idea what else :-)<br><br>@AdamRedwoods: I already only draw my own cursor in game and the OS cursor outside, but the problem is that players can detect the lag as the move the mouse and it annoys them, that's why I'm trying to fix the actual DX9 driver render lag instead. <br><br></td></tr></table><br>
<a name="1087742"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >AdamRedwoods</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#50">[#50]</a></td></tr></table></td></tr><tr ><td class="posttext"> Is it just me or is this a problem common to most games? I was just playing Trine and the cursor does not keep up. OK-- I just checked Starcraft 2 and there's no cursor lag...<br><br><br>Ok, this sounds like a job for EVENT HOOKS! <br><br></td></tr></table><br>
<a name="1087745"></a>

<a name="1087746"></a>

<a name="1087747"></a>

<a name="1087758"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >AdamRedwoods</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#51">[#51]</a></td></tr></table></td></tr><tr ><td class="posttext"> Decoupled the mouse drawing vs. the graphics redraw.<br><br>Honestly, I'd go with MaxGUI and use event GadgetPaint of some sort to decouple these better. I'm only using a 60hz timer, which would fall out of the VSync and cause tearing.<br><br><br><textarea class=codebox name="code" wrap=OFF readonly="true" rows="15" cols="80">
SuperStrict

Const DIRECTX7% = 0
Const DIRECTX9% = 1
Const OPENGL% = 2

Global currentDriver% = DIRECTX7
?MacOS
currentDriver = OPENGL
?
Global fullScreen% = 0
Global useFix% = 0
Global screenWidth% = 0
Global screenHeight% = 0
Global blockX% = 0

Global prevMouseX%
Global prevMouseY%

SetDriver()
CreateScreen()


Local mytimer:TTimer = CreateTimer( 60 )
Global backbuffer:TImage = CreateImage(128,128) ''size of cursor
GrabImage backbuffer, MouseX()-2, MouseY()-2

Repeat 'Not KeyHit(KEY_ESCAPE)
	
	Local ev:Int = PollEvent()
	'Local ev:Int = EventID()
	'Print ev
	
	If ev = EVENT_KEYDOWN
		If EventData() = KEY_ESCAPE Then Exit
	EndIf
	
	If ev = EVENT_MOUSEMOVE
		'Cls
		'DrawImage backbuffer, prevMouseX-2, prevMouseY-2
		'GrabImage backbuffer, xm-2, ym-2 ''moved this so it doesn't slow things down, we only need it every so often, may cause smearing
		
		DrawCursor()	
		
		Flip 0 ''may cause problems if the backbuffer is not kept on gfx cards

	EndIf
	'If ev = EVENT_GADGETPAINT Then Print 123
	If ev = EVENT_TIMERTICK Then DrawScreen(0,Null,Null)
Forever

End

Function DrawCursor()
	SetColor 100,100,230
	DrawRect MouseX(),MouseY(),50,50
EndFunction

Function DrawScreen:Object( id:Int,data:Object,context:Object )

	'If id&lt;&gt; EVENT_GADGETPAINT Then Return Null
	Cls

	SetColor 255,255,255
	Local x%,y% = 10
	Local gap% = 15
	DrawText "Press D to change Driver (current = "+GetDriverString()+")",x,y
	y:+gap
	DrawText "Press F to toggle Fix (current = "+useFix+")",x,y	
	y:+gap
	DrawText "Press S to toggle Full Screen",x,y	
	y:+gap
	DrawText "Press Esc to Exit",x,y	
	
	
	
	SetColor 100,230,100
	DrawRect blockX, screenHeight-100,50,50
	blockX:+1
	If BlockX&gt;screenWidth Then blockX:-screenWidth
	
	prevMouseX = MouseX()
	prevMouseY = MouseY()
	GrabImage backbuffer, prevMouseX-2, prevMouseY-2		
	
	DrawCursor()
	
	Flip
	'Cls
	


	'Delay(1)	
	
	?win32
	If KeyHit(KEY_D) Then
		currentDriver:+1
		If currentDriver&gt;OPENGL Then currentDriver= DIRECTX7 'wrap
		SetDriver()
		CreateScreen()
	EndIf
	?
	
	If KeyHit(KEY_S) Then
		fullScreen = Not fullScreen
		CreateScreen()
	EndIf

	If KeyHit(KEY_F) Then
		useFix= Not useFix
	EndIf

End Function

Function SetDriver()
	Select currentDriver
		?win32
		Case DIRECTX7
			SetGraphicsDriver D3D7Max2DDriver()
		Case DIRECTX9
			SetGraphicsDriver D3D9Max2DDriver()
		?
		Case OPENGL
			SetGraphicsDriver GLMax2DDriver()
	End Select
End Function

Function CreateScreen()
	If fullScreen Then
		screenWidth = 800
		screenHeight = 600
		Graphics screenWidth, screenHeight, 32, 60,0
	Else
		screenWidth = 640
		screenHeight = 480
		Graphics screenWidth, screenHeight, 0, 60,0
	EndIf	
End Function

Function GetDriverString$()
	Select currentDriver
		Case DIRECTX7
			Return "DirectX 7"
		Case DIRECTX9
			Return "DirectX 9"
		Case OPENGL
			Return "Open GL"
	End Select
End Function

</textarea><br><br>UPDATE: revised a bit, sorry for the mess...<br><br><font class="tiny">Last edited 2011</font><br><br><font class="tiny">Last edited 2011</font><br><br><font class="tiny">Last edited 2011</font> <br><br></td></tr></table><br>
<a name="1087755"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Grey Alien</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#52">[#52]</a></td></tr></table></td></tr><tr ><td class="posttext"> Unfortunately that code produces such messed up results on my PC I don't know where to begin to describe it! :-) <br><br></td></tr></table><br>
<a name="1087756"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >AdamRedwoods</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#53">[#53]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> Unfortunately that code produces such messed up results on my PC I don't know where to begin to describe it! :-)  <br></div><br><br>try changing the buffer to single buffer mode, no backbuffer. <br><br></td></tr></table><br>
<a name="1087757"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Grey Alien</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#54">[#54]</a></td></tr></table></td></tr><tr ><td class="posttext"> I don't know how to do that.  Plus I'm convinced that the code won't fix the lag because as I've explained it's not a problem with getting inputs faster, it's a problem with DX9 buffering several frames when Vysnc is used. <br><br></td></tr></table><br>
<a name="1087759"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >AdamRedwoods</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#55">[#55]</a></td></tr></table></td></tr><tr ><td class="posttext"> Right-- my IDEA (though poorly executed) is that you could try to decouple the cursor refresh from your main app refresh.<br><br>it's what I'm trying to do in the above code post, by using an event trigger at 60hz, rather than the vsync.<br><br><br>To single buffer the screen, I just added (to the code above) after the graphics command:<br>Graphics screenWidth, screenHeight, 0, 60,0 <br>or<br>Graphics screenWidth, screenHeight,32, 60,0  ''for fullscreen<br><br>(again, this is not the ideal fix, just trying to formulate an idea.)<br><br><br>If you ever notice when windows would always crap out, if you move your mouse around it would leave a trail of boxes. My assumption is that they are only refreshing a small square when the mouse moves around-- but yet, the full window of graphics is refreshed during a vsync.<br><br>This is all, speculative, and I'm known to be wrong often, plus I have to check on the chicken in the oven. <br><br></td></tr></table><br>
<a name="1087769"></a>

<a name="1087770"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >col</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#56">[#56]</a></td></tr></table></td></tr><tr ><td class="posttext"> @Adam...<br><br>You only have to use some form of delta timing and the problem doesn't exist.<br>To incorporate that you have to build it into the game from the first line of code, but Grey Aliens games are finished already so thats no a real solution. Plus the fact that the lag is definitely there and very noticeable, its only a case of setting up the driver so its working 100% correct and this problem will be very minimal, agreed not completely gone, but almost unnoticeable.<br><br>EDIT - I say 'only a case of' very loosely ;o)<br><br><font class="tiny">Last edited 2011</font> <br><br></td></tr></table><br>
<a name="1087975"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Grey Alien</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#57">[#57]</a></td></tr></table></td></tr><tr ><td class="posttext"> So col, what did you make of my results? <br><br></td></tr></table><br>
<a name="1087997"></a>

<a name="1087999"></a>

<a name="1088001"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >col</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#58">[#58]</a></td></tr></table></td></tr><tr ><td class="posttext"> Hiya Grey Alien...<br><br>I find them... interesting :o)<br><br>I'm studying this one to the point that I can almost read HEX fluently as English :o)<br>I'm working on kind of a 'push backbuffer' ( probably the wrong analogy as it just displays the swapchains/back buffers really fast ) system but also trying to stabilize the framerate at the same time - bit of a nightmare - kindof delta timing using swapchains :D<br>Not sure if it will work, but hang in there.<br><br>Being as it works on my system ok, it may be an idea just to have an option in your games, so that if the user is suffering from lag they could switch over to using a fix?<br><br>EDIT - It would have been nice if more people could try it - only 3 so far! The more systems that test it, the wider the picture we can get to give a better chance to get it much more robust on a wider range of setups.<br><br><font class="tiny">Last edited 2011</font> <br><br></td></tr></table><br>
<a name="1088028"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >AdamRedwoods</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#59">[#59]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> It would have been nice if more people could try it - only 3 so far! The more systems that test it, the wider the picture we can get to give a better chance to get it much more robust on a wider range of setups. <br></div><br><br>Intel G41, Quad core intel. Win7.<br><br>Windowed mode: dx9 still lagging a bit, dx7, opengl, not so bad.<br>Fullscreen mode: dx9 not as noticeable, dx7, opengl run just fine. <br><br></td></tr></table><br>
<a name="1088034"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Grey Alien</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#60">[#60]</a></td></tr></table></td></tr><tr ><td class="posttext"> Thanks for testing Adam,  Did you notice if the green square was smooth or jerky?  On mine it's jerky but enabling the original fix made it smooth, which is weird. <br><br></td></tr></table><br>
<a name="1088035"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >AdamRedwoods</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#61">[#61]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> Thanks for testing Adam, Did you notice if the green square was smooth or jerky? <br></div><br><br>It seemed pretty smooth on most of them, but the blue mouse square was layered behind the green square. <br><br></td></tr></table><br>
<a name="1088112"></a>

<a name="1088115"></a>

<a name="1088120"></a>

<a name="1088121"></a>

<a name="1088122"></a>

<a name="1088123"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >col</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#62">[#62]</a></td></tr></table></td></tr><tr ><td class="posttext"> Hi all,<br><br><a href="http://www.datafilehost.com/download-854bd1be.html" target="_blank"><b>DOWNLOAD V0.2 HERE</b></a><br><br>Ok, this one is a skeleton version of the Dx9 engine I'm working on and I mean a skeleton version. It's still completely Bmax source, no c++ or other language.<br>Again this is not the BMax 2D engine. I want to see the feedback when using Dx9 outside of the BMax Max2D environment.<br><br>Some points to note...<br><br>0 - Windows only - Its to test DX9 only ( mostly Grey Aliens problems )<br>1 - It loads in a jpg and uses it create 2 'Sprite's.<br>2 - It does nothing more than setup DX9 in 800,600,32 @ 60 hz - please make sure your card/monitor can support this :-) kidding :p<br>3 - It's NOT a copy of Grey Aliens example in his first post. Its not the same code, it's my version, although it functions in exactly the same way.<br>4 - This is solely to test how smooth the lower box at the bottom is as well as the amount of lag with the cursor.<br><br>I've made 2 versions to test, one in full screen and one for windowed mode.<br>You may find when you first run it, it may be a little jerky for half a second or so until the GPU and example code synchronize.<br><br>It runs smooth as a baby bum in fullscreen and windowed on my system.<br><br>Sony VAIO VGN-FW31M<br><br><font class="tiny">Last edited 2011</font> <br><br></td></tr></table><br>
<a name="1088172"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Grey Alien</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#63">[#63]</a></td></tr></table></td></tr><tr ><td class="posttext"> Both crash on mine.  They don't display anything. Perhaps there's a bug loading the file? <br><br></td></tr></table><br>
<a name="1088189"></a>

<a name="1088190"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >col</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#64">[#64]</a></td></tr></table></td></tr><tr ><td class="posttext"> You do have the latest DirectX update installed I assume ?<br><br>It needs the latest version of D3D9.dll and also D3DX9_43.dll. These are both installed ( and more ) with the latest version update.<br><br><font class="tiny">Last edited 2011</font> <br><br></td></tr></table><br>
<a name="1088203"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Grey Alien</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#65">[#65]</a></td></tr></table></td></tr><tr ><td class="posttext"> I have DX11 on Windows 7.  I just extracted the 3 files into a folder and run from there.  The fullscreen app momentarily goes full screen then bombs.  I did a search for those files and found d3d9.dll but not D3DX9_43.dll.  Highest my system goes is d3dx9_34 (or d3dx10_42). Not sure I should be installed DX9 again on this system if I have DX11 or will it be fine? <br><br></td></tr></table><br>
<a name="1088214"></a>

<a name="1088215"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >col</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#66">[#66]</a></td></tr></table></td></tr><tr ><td class="posttext"> Yes, it will be fine. It explains the crash. It specifically requires the D3DX9_43.dll library. I know you already have DX11 but that probably came pre - installed ??<br><br>The required update is...<br><a href="http://www.microsoft.com/downloads/en/details.aspx?FamilyID=3b170b25-abab-4bc3-ae91-50ceb6d8fa8d" target="_blank"><b>HERE</b></a><br><br>It will only update the components that need updating. MS are still working on updates and bug fixes for the older versions. I think they've stopped updates for DX8 now but continue to update 9 , 10 and 11. The latest update is June 2010 so far.<br>[EDIT]No fear as it will only update components of all 3 versions that need updating. You won't 'go back to Dx9 only', so to speak.<br><br>Basically you need Dx9.0c to run the test code.<br><br>I had the same problem with the Dynamic Cube Mapping Demo I wrote to test this engine. Not sure if you looked at it <a href="/posts.php?topic=94423" target="_blank"><b>HERE</b></a><br>Only 1 person had a problem with it and they were in exactly the same situation as you now. They needed to update too and it worked fine after.<br><br><font class="tiny">Last edited 2011</font> <br><br></td></tr></table><br>
<a name="1088218"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Grey Alien</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#67">[#67]</a></td></tr></table></td></tr><tr ><td class="posttext"> OK thanks, installing it now.  Thing is, for a BMax solution to this problem, it will need to work on older DX9... <br><br></td></tr></table><br>
<a name="1088221"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Grey Alien</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#68">[#68]</a></td></tr></table></td></tr><tr ><td class="posttext"> Results:<br><br>Windowed mode - small lag on cursor, not too bad.  Dark green square is very jerky indeed.<br><br>Full-screen mode - no lag on cursor at all.  Dark green square is jerky (not as bad as windowed mode but still bad). <br><br></td></tr></table><br>
<a name="1088234"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >col</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#69">[#69]</a></td></tr></table></td></tr><tr ><td class="posttext"> It was only a test to see how the technique worked outside of the BMax2D environment.<br>Strange how its silky smooth on my machine.<br><br>I think as it varies in quality from one machine to another, a real solution is to have the user select an option to help the mouse lag or not? Whats your thoughts on that?<br><br>My last code simply pads out any spare time between vwaits in the GPU, so it doesnt do the extra renders to create any lag. <br><br></td></tr></table><br>
<a name="1088235"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Grey Alien</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#70">[#70]</a></td></tr></table></td></tr><tr ><td class="posttext"> It is weird how it can be so different on our machines, sounds like a good idea but doesn't work in practice on enough machines (well we could do with some more tests).<br><br>As for having an option, well a lot of people don't ever check the options, especially in casual games, so sales may still be lost anyway by people who dislike lag.<br><br>What I did in my latest Spring Bonus build was add an option to turn off the custom cursor and switch back on the system cursor - this way they won't get mouse lag.  Also I used the grabpixmap fix mentioned in the first post to at least improve full-screen mode. <br><br></td></tr></table><br>
<a name="1088628"></a>

<a name="1088637"></a>

<a name="1088640"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >col</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#71">[#71]</a></td></tr></table></td></tr><tr ><td class="posttext"> Hey Grey Alien,<br><br>Just to let you know that I tried another method, by using DirectInput to control the mouse and using an image as a pointer, and that doesnt work too, it suffers from the lag when not using VSync.<br><br>Oh if it did work, it would have been easy to incorporate back into BMax without using the D3DX stuff, that was just to load a texture and use the sprite features to display the texture. If it worked and its moulded back into BMax, then you would just revert back to using DrawRect or DrawImage as normal.<br><br>But on this issue.... I'm all out of suggestions at this time unfortunately. Sorry.<br>Maybe in the future if I have a brain wave then I'll give it another go, but until then...<br><br>[EDIT]There is one advantage to using my DirectInput code in that you can introduce a 'multiplier' to adjust the mouse sensitivity to make the mouse move very fast or very slow independent of the system mouse. Of course the idea is to hide the system mouse, but then its no problem to do this technique already in existing Bmax2D code by using a multiplier with mouse*speed().<br>Anyway DirectInput is Win32 specific. I was thinking the main problem is DX9 which is of course Win32 specific too.<br><br><font class="tiny">Last edited 2011</font> <br><br></td></tr></table><br>
<a name="1088638"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Grey Alien</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#72">[#72]</a></td></tr></table></td></tr><tr ><td class="posttext"> Thanks for trying so hard on this col, it was really appreciated!  For now I've stuck with the simple fix from the first post that reduces lag in full-screen DX9/OGL but not in windowed mode. <br><br></td></tr></table><br>
<a name="1088666"></a>

<a name="1088686"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >AdamRedwoods</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#73">[#73]</a></td></tr></table></td></tr><tr ><td class="posttext"> <a href="http://www.gamedev.net/topic/580048-dx9-vsync-lag/" target="_blank">http://www.gamedev.net/topic/580048-dx9-vsync-lag/</a><br><br>Direct3D supports hardware mouse cursors:<br><a href="http://www.gamedev.net/topic/457105-mouse-lag-under-directx9/" target="_blank">http://www.gamedev.net/topic/457105-mouse-lag-under-directx9/</a><br><br><br>My original thought on this is to use double-buffered mode, but when drawing a cursor to draw immediately to the front buffer on mousemove. Possible on opengl with glDrawBuffer(GL_FRONT) and glFlush() instead of using Flip()/SwapBuffers(). Overall, this would probably cause a little streaking, and to prevent this, just do a grabimage, etc.<br><br><font class="tiny">Last edited 2011</font> <br><br></td></tr></table><br>
<a name="1088989"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Grey Alien</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#74">[#74]</a></td></tr></table></td></tr><tr ><td class="posttext"> Thanks Adam. The 3 frame lag is also mentioned in that thread.  I don't just need to solve the mouse lag problem because of course they keyboard feels like it lags too, so would a joystick all because of the display lag. <br><br></td></tr></table><br>
<a name="1115718"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >therevills</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#75">[#75]</a></td></tr></table></td></tr><tr ><td class="posttext"> Hey Jake,<br><br>Can you please tell me where you added the DX9 "fix":<br><br><pre class=code>		Local MouseHack:TPixmap
		MouseHack = GrabPixmap(1, 1, 1, 1)
</pre><br><br>in your framework?<br><br>Cheers! <br><br></td></tr></table><br>
<a name="1115813"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Grey Alien</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#76">[#76]</a></td></tr></table></td></tr><tr ><td class="posttext"> Before ccFlip. See that other thread you started. <br><br></td></tr></table><br>
<a name="1115842"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Noobody</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#77">[#77]</a></td></tr></table></td></tr><tr ><td class="posttext"> Hi,<br><br>Windowed Mode (fix off):<br>- DX7 Blue square lags a little bit.<br>- DX9 Blue square lags a little bit.<br>- OpenGL Blue square lags a little bit.<br><br>Windowed Mode (fix on): Fix doesn't seem to do anything at all<br><br>Fullscreen Mode (fix off):<br>- DX7 Blue square lags a little bit.<br>- DX9 Blue square is incredibly jerky and lags behind a lot.<br>- OpenGL Blue square lags behind quite a bit<br><br>Fullscreen Mode (fix on):<br>- DX7 No change<br>- DX9 Blue square is a lot better, almost as good as DX7<br>- OpenGL Blue square still lags behind quite a bit<br><br>The green square is smooth in all cases.<br><br><br>I modified your code a bit to improve the OpenGL case; it works by calling glFinish, which forces all graphics commands in the queue to complete before the application resumes. Just replace your current useFix block by this <pre class=code>If useFix Then
	If currentDriver = OPENGL  Then
		glFinish()
	ElseIf currentDriver = DIRECTX7 Or currentDriver = DIRECTX9 Then
		Local MouseHack:TPixmap
		MouseHack = GrabPixmap(1, 1, 1, 1)
	EndIf
EndIf</pre><br><br>On my machine, this really helps improve the lag on the blue square down to pretty much DX7 levels. Let me know whether it works for you.<br><br>I checked and the concept of glFinish does not seem to exist in DirectX - your version with grabbing a small pixmap and thus locking the backbuffer seems to be pretty much the only solution. Another way is to put an event into the DX command stream right after flip and then busy wait for the event to complete. This way you're never too much ahead of the GPU frame-wise and decrease the lag to a minimum. <br><br></td></tr></table><br>
<a name="1116070"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Grey Alien</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#78">[#78]</a></td></tr></table></td></tr><tr ><td class="posttext"> Thanks for the tip!  I'll investigate it. <br><br></td></tr></table><br>
<a name="1116119"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Jur</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#79">[#79]</a></td></tr></table></td></tr><tr ><td class="posttext"> These fixes eliminate mouse lag but the price is lower frame rate, which is now in the range of DX7 on my system. Still it is much better that way, thanks. <br><br></td></tr></table><br>
<a name="1121639"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >therevills</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#80">[#80]</a></td></tr></table></td></tr><tr ><td class="posttext"> I've just found this article:<br><br><a href="http://my.opera.com/Vorlath/blog/2009/02/01/directx-d3d-mouse-lag" target="_blank">http://my.opera.com/Vorlath/blog/2009/02/01/directx-d3d-mouse-lag</a><br><br>He talks about a fix which uses an "occlusion query" and to make sure that the request ends AFTER the Present() call...<br><br>Does anyone has any idea how to do that? (And have any idea what he is talking about? ;)) <br><br></td></tr></table><br>
<a name="1121676"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Grey Alien</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#81">[#81]</a></td></tr></table></td></tr><tr ><td class="posttext"> Added a comment on that thread too. <br><br></td></tr></table><br>
<a name="1121677"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Grey Alien</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#82">[#82]</a></td></tr></table></td></tr><tr ><td class="posttext"> Also @therevills, did you ever try that glFinish code change above?  I never got round to testing it yet. <br><br></td></tr></table><br>
<a name="1121680"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >therevills</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#83">[#83]</a></td></tr></table></td></tr><tr ><td class="posttext"> Nope I havent tried it, since the main issue I think is DirectX lag... I havent seen much (if any) lag on OpenGL. <br><br></td></tr></table><br>
<a name="1121689"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Grey Alien</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#84">[#84]</a></td></tr></table></td></tr><tr ><td class="posttext"> I was definitely getting the lag in GL (see results at top).  Shame as I thought the issue was just a DX issue, but clearly it's not, it's some kind of graphics pipeline thing. <br><br></td></tr></table><br>
<a name="1121694"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >therevills</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#85">[#85]</a></td></tr></table></td></tr><tr ><td class="posttext"> What I've read is that we will always get input lag when using vsync, we just got to try and find ways around it - or just turn vsync off :/ <br><br></td></tr></table><br>
<a name="1121701"></a>

<a name="1121703"></a>

<a name="1121704"></a>

<a name="1121711"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >therevills</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#86">[#86]</a></td></tr></table></td></tr><tr ><td class="posttext"> I've just tried something... <br><br>I added "Delay(17)" to my main loop, so we would lose 1FPS and now the lag is gone!!!<br><br><br>17 because 1000(ms)/60(fps) = 16.666667<br><br>Any one care to try it?<br><br><font class="tiny">Last edited 2012</font><br><br>Updated example:<br><textarea class=codebox name="code" wrap=OFF readonly="true" rows="15" cols="80">
SuperStrict

Const DIRECTX7% = 0
Const DIRECTX9% = 1
Const OPENGL% = 2

Global currentDriver% = DIRECTX7
?MacOS
currentDriver = OPENGL
?
Global fullScreen% = 1
Global useFix% = 0
Global screenWidth% = 0
Global screenHeight% = 0
Global blockX% = 0


Global fps_counter% = 0
Global update_frequency% = 10
Global fps_milli% = MilliSecs()
Global fps%
Global delay_amount% = 17

Global x#, y#
Global angle#
Global cx%, cy%
Global rad% = 100

SetDriver()
CreateScreen()

While Not KeyHit(KEY_ESCAPE)
	Test()
Wend

End

Function Test()
	Cls

	SetColor 255,255,255
	Local x%,y% = 10
	Local gap% = 15
	DrawText "Press D to change Driver (current = "+GetDriverString()+")",x,y
	y:+gap
	DrawText "Press F to toggle Fix (current = "+useFix+")",x,y	
	y:+gap
	DrawText "Press S to toggle Full Screen",x,y	
	y:+gap
	DrawText "FPS:"+fps, x, y
	y:+gap
	DrawText "Delay:"+delay_amount+" (Cursor Keys Left and Right to change)", x, y
	y:+gap
	DrawText "Press Esc to Exit",x,y	
	
	SetColor 100,100,230
	DrawRect MouseX(),MouseY(),50,50
	
	SetColor 100,230,100
	DrawRect blockX, screenHeight-100,50,50
	blockX:+1
	If BlockX&gt;screenWidth Then blockX:-screenWidth
	
	If useFix Then
		Local MouseHack:TPixmap
		MouseHack = GrabPixmap(1, 1, 1, 1)
	EndIf
	
	Flip 1
	Delay(delay_amount)	
	
	
	fps_counter=fps_counter+1
	If fps_counter=update_frequency
	     fps=1000/Float(((MilliSecs()-fps_milli))/update_frequency)
	     fps_milli=MilliSecs()
	     fps_counter=0
	EndIf

	
	?win32
	If KeyHit(KEY_D) Then
		currentDriver:+1
		If currentDriver&gt;OPENGL Then currentDriver= DIRECTX7 'wrap
		SetDriver()
		CreateScreen()
	EndIf
	?
	
	angle:+4
	
	x = cx + (Sin(angle) * rad)
	y = cy + (Cos(angle) * rad)
	
	MoveMouse(x, y)
	
	If KeyHit(KEY_S) Then
		fullScreen = Not fullScreen
		CreateScreen()
	EndIf

	If KeyHit(KEY_F) Then
		useFix= Not useFix
	EndIf

	If KeyHit(KEY_LEFT)
		delay_amount:-1
		Delay(100)
	EndIf
	If KeyHit(KEY_RIGHT)
		delay_amount:+1
		Delay(100)
	EndIf
End Function

Function SetDriver()
	Select currentDriver
		?win32
		Case DIRECTX7
			SetGraphicsDriver D3D7Max2DDriver()
		Case DIRECTX9
			SetGraphicsDriver D3D9Max2DDriver()
		?
		Case OPENGL
			SetGraphicsDriver GLMax2DDriver()
	End Select
End Function

Function CreateScreen()
	If fullScreen Then
		screenWidth = 800
		screenHeight = 600
		Graphics screenWidth, screenHeight, 32, 60
	Else
		screenWidth = 640
		screenHeight = 480
		Graphics screenWidth, screenHeight, 0
	EndIf	
	
	cx = ScreenWidth/2
	cy = ScreenHeight/2
	
End Function

Function GetDriverString$()
	Select currentDriver
		Case DIRECTX7
			Return "DirectX 7"
		Case DIRECTX9
			Return "DirectX 9"
		Case OPENGL
			Return "Open GL"
	End Select
End Function

</textarea><br><br><font class="tiny">Last edited 2012</font><br><br><font class="tiny">Last edited 2012</font> <br><br></td></tr></table><br>
<a name="1121707"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Grey Alien</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#87">[#87]</a></td></tr></table></td></tr><tr ><td class="posttext"> This must mean the CPU isn't pushing the GPU too hard.  Plus of course you are only getting 30FPS now. <br><br></td></tr></table><br>
<a name="1121710"></a>

<a name="1121712"></a>

<a name="1121714"></a>

<a name="1121715"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >therevills</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#88">[#88]</a></td></tr></table></td></tr><tr ><td class="posttext"> Nope - getting 58/59 FPS, we are only losing 1FPS - I added an FPS counter ;)<br><br><font class="tiny">Last edited 2012</font><br><br>Heres my results with delay(17):<br><br>DX7 Window: No lag - 30FPS!?!<br>DX7 Full Screen: No lag - 58FPS<br><br>DX9 Window: No lag - 55FPS-58FPS<br>DX9 Full Screen: No lag - 58FPS<br><br>OpenGL Window: No lag - 58FPS<br>OpenGL Full Screen: No lag - 58FPS<br><br>So DX7 doesnt like a delay over 15 in window mode...<br><br>I actually tried this fix as on a gaming forum for RO2 players were complaining about input lag with vsync and one user suggested to alter the ini file and limit the FPS to 59.9...<br><br><font class="tiny">Last edited 2012</font> <br><br></td></tr></table><br>
<a name="1121782"></a>

<a name="1121783"></a>

<a name="1121790"></a>

<a name="1121791"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Zeke</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#89">[#89]</a></td></tr></table></td></tr><tr ><td class="posttext"> yep. dx9 with delay 17 i get 55-58fps and no lag.<br><br>if using fullscreen this "Delay(17)" fix works. constant FPS: 58 in all graphics modes.. if using fix FPS drops to constant 55.<br><br>but if using windowed. dx7 lags a lot, 30FPS. dx9 and gl lags a little. but still 50fps. fix have no difference.<br><br>so <pre class=code>if fullscreen then Delay(17)</pre><br><br>but of course it depends what kind game you are coding.<br><br><font class="tiny">Last edited 2012</font> <br><br></td></tr></table><br>
<a name="1121794"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Grey Alien</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#90">[#90]</a></td></tr></table></td></tr><tr ><td class="posttext"> Does the &lt;50 FPS look jerky though?  It surely shouldn't look smooth if frames are being dropped every so often. <br><br></td></tr></table><br>
<a name="1121835"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >therevills</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#91">[#91]</a></td></tr></table></td></tr><tr ><td class="posttext"> 30FPS does look jerky, 50+FPS looks fine.<br><br>@Zeke, when you say windowed dx7 lags a lot - is it the mouse cursor and the blue square out of sync or just the bad framerate? Also when you say "Using the fix" I guess you are talking about pressing F.<br><br>I'm thinking now to do something like this:<br><br><pre class=code>
desktopRate = GetDesktopRefreshRate()
delayAmount = Ceil( 1000 / Float(desktopRate) )

if graphicsDriver = OPENGL or DIRECTX9
   Delay(delayAmount)
end
</pre> <br><br></td></tr></table><br>
<a name="1121864"></a>

<a name="1121867"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >col</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#92">[#92]</a></td></tr></table></td></tr><tr ><td class="posttext"> Hey guys,<br>It looks like you're on the road to fixing this up, nice one!! but just for kicks I made an example that uses the D3DOCCLUSION_QUERY as suggested in the link by therevills at post #80.<br><br>I fear it may suffer inconsistent results across various machines as in the previous codes I wrote due to it's using a similar algo but its worth a look, no? :-)<br><br>Just an .exe for the moment as its a modified brl/d3d9graphics.bmx file... runs silky smooth with zero lag on my machine in Win7 and Vista in fullscreen without using the 'F' key fix. Note this is just a Dx9 fix.<br><br>Laters.<br><br>oh yeah, the link is... <a href="http://www.datafilehost.com/download-54b3668c.html" target="_blank"><b>http://www.datafilehost.com/download-54b3668c.html</b></a><br>EDIT:- with therevills FPS counter...<a href="http://www.datafilehost.com/download-a0a22136.html" target="_blank"><b>http://www.datafilehost.com/download-a0a22136.html</b></a><br><br><font class="tiny">Last edited 2012</font> <br><br></td></tr></table><br>
<a name="1121869"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >therevills</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#93">[#93]</a></td></tr></table></td></tr><tr ><td class="posttext"> Hey Dave,<br><br>When I run the LagTest.13.01.2012.exe and change drivers to DirectX9 (as it starts in DX7) all I get is a black screen and nothing responds...<br><br>Can you share the code you added to d3d9graphics.bmx? <br><br></td></tr></table><br>
<a name="1121871"></a>

<a name="1121873"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >col</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#94">[#94]</a></td></tr></table></td></tr><tr ><td class="posttext"> yeah sure.... the complete modified d3d9graphics.bmx file....<br><br><textarea class=codebox name="code" wrap=OFF readonly="true" rows="15" cols="80">

Strict

Import BRL.Graphics

Import Pub.DirectX

Import BRL.LinkedList


Private

Global _wndClass$="BBDX9Device Window Class"

Global _driver:TD3D9graphicsDriver

Global _d3d:IDirect3D9
Global _d3dCaps:D3DCAPS9
Global _modes:TGraphicsMode[]

Global _d3dOccQuery:IDirect3DQuery9 'Added by Col 13.01.2012

Global _d3dDev:IDirect3DDevice9
Global _d3dDevRefs

Global _presentParams:D3DPRESENT_PARAMETERS

Global _graphics:TD3D9Graphics

Global _autoRelease:TList

Type TD3D9AutoRelease
	Field unk:IUnknown
End Type

Function D3D9WndProc( hwnd,msg,wp,lp ) "win32"

	bbSystemEmitOSEvent hwnd,msg,wp,lp,Null
	
	Select msg
	Case WM_CLOSE
		Return
	Case WM_SYSKEYDOWN
		If wp&lt;&gt;KEY_F4 Return
	End Select

	Return DefWindowProcW( hwnd,msg,wp,lp )

End Function

Function OpenD3DDevice( hwnd,width,height,depth,hertz,flags )

	If _d3dDevRefs
		If Not _presentParams.Windowed Return False
		If depth&lt;&gt;0 Return False
		_d3dDevRefs:+1
		Return True
	EndIf

	Local windowed=(depth=0)
	Local fullscreen=(depth&lt;&gt;0)	

	Local pp:D3DPRESENT_PARAMETERS=New D3DPRESENT_PARAMETERS
	pp.BackBufferWidth=width
	pp.BackBufferHeight=height
	pp.BackBufferCount=1
	pp.BackBufferFormat=(D3DFMT_X8R8G8B8 * fullscreen) + (D3DFMT_UNKNOWN * windowed)
	pp.MultiSampleType=D3DMULTISAMPLE_NONE
	pp.SwapEffect=(D3DSWAPEFFECT_DISCARD * fullscreen) + (D3DSWAPEFFECT_COPY * windowed)
	pp.hDeviceWindow=hwnd
	pp.Windowed=windowed
	pp.Flags=D3DPRESENTFLAG_LOCKABLE_BACKBUFFER
	pp.FullScreen_RefreshRateInHz=(hertz * fullscreen)
	pp.PresentationInterval=D3DPRESENT_INTERVAL_ONE	'IMMEDIATE
	
	Local cflags=D3DCREATE_FPU_PRESERVE
	
	'OK, try hardware vertex processing...
	Local tflags=D3DCREATE_PUREDEVICE|D3DCREATE_HARDWARE_VERTEXPROCESSING|cflags
	If _d3d.CreateDevice( 0,D3DDEVTYPE_HAL,hwnd,tflags,pp,_d3dDev )&lt;0

		'Failed! Try mixed vertex processing...
		tflags=D3DCREATE_MIXED_VERTEXPROCESSING|cflags
		If _d3d.CreateDevice( 0,D3DDEVTYPE_HAL,hwnd,tflags,pp,_d3dDev )&lt;0
	
			'Failed! Try software vertex processing...	
			tflags=D3DCREATE_SOFTWARE_VERTEXPROCESSING|cflags
			If _d3d.CreateDevice( 0,D3DDEVTYPE_HAL,hwnd,tflags,pp,_d3dDev )&lt;0
			
				'Failed! Go home and watch family guy instead...
				Return False
			EndIf
		EndIf
	EndIf

	_presentParams=pp

	_d3dDevRefs:+1
	
	_autoRelease=New TList
	
	'Occlusion Query - Added by Col 13.01.2012
	If Not _d3dOccQuery
		If _d3ddev.CreateQuery(9,_d3dOccQuery)&lt;0 '9 hardcoded for D3DQUERYTYPE_OCCLUSION
			DebugLog "Cannot create Occlussion Query!"
		EndIf
	EndIf
	If _d3dOccQuery _d3dOccQuery.Issue(2) 'D3DISSUE_BEGIN
	
	Return True
End Function

Function CloseD3DDevice()
	_d3dDevRefs:-1
	If Not _d3dDevRefs

		For Local t:TD3D9AutoRelease=EachIn _autoRelease
			t.unk.Release_
		Next
		_autoRelease=Null
		
		If _d3dOccQuery _d3dOccQuery.Release_	'Added by Col 13.01.2012
		_d3dOccQuery = Null 					'Added by Col 13.01.2012
		
		_d3dDev.Release_
		_d3dDev=Null
		_presentParams=Null
	EndIf
End Function

Function ResetD3DDevice()
	If _d3dOccQuery _d3dOccQuery.Release_ 'Added by Col 13.01.2012

	If _d3dDev.Reset( _presentParams )&lt;0
		Throw "_d3dDev.Reset failed"
	EndIf
	
	'Added by Col 13.01.2012
	If _d3ddev.CreateQuery(9,_d3dOccQuery)&lt;0
		DebugLog "Cannot create Occlussion Query!"
	EndIf
	If _d3dOccQuery _d3dOccQuery.Issue(2) 'D3DISSUE_BEGIN
End Function

Public

Type TD3D9Graphics Extends TGraphics

	Method Attach:TD3D9Graphics( hwnd,flags )
		Local rect[4]
		GetClientRect hwnd,rect
		Local width=rect[2]-rect[0]
		Local height=rect[3]-rect[1]

		OpenD3DDevice hwnd,width,height,0,0,flags
		
		_hwnd=hwnd
		_width=width
		_height=height
		_flags=flags
		_attached=True
		Return Self
	End Method
	
	Method Create:TD3D9Graphics( width,height,depth,hertz,flags )
		Local wstyle

		If depth
			wstyle=WS_VISIBLE|WS_POPUP
		Else
			wstyle=WS_VISIBLE|WS_CAPTION|WS_SYSMENU|WS_MINIMIZEBOX
		EndIf
		
		Local rect[4]

		If Not depth
			Local desktopRect[4]
			GetWindowRect GetDesktopWindow(),desktopRect
				
			rect[0]=desktopRect[2]/2-width/2;		
			rect[1]=desktopRect[3]/2-height/2;		
			rect[2]=rect[0]+width;
			rect[3]=rect[1]+height;
				
			AdjustWindowRect rect,wstyle,0
		EndIf

		Local hwnd=CreateWindowExW( 0,_wndClass,AppTitle,wstyle,rect[0],rect[1],rect[2]-rect[0],rect[3]-rect[1],0,0,GetModuleHandleA(Null),Null )
		If Not hwnd Return Null

		If Not depth
			GetClientRect hwnd,rect
			width=rect[2]-rect[0]
			height=rect[3]-rect[1]
		EndIf
		
		If Not OpenD3DDevice( hwnd,width,height,depth,hertz,flags )
			DestroyWindow hwnd
			Return Null
		EndIf
		
		_hwnd=hwnd
		_width=width
		_height=height
		_depth=depth
		_hertz=hertz
		_flags=flags
		
		Return Self
	End Method
	
	Method GetDirect3DDevice:IDirect3DDevice9()
		Return _d3dDev
	End Method

	Method ValidateSize()
		If _attached
			Local rect[4]
			GetClientRect _hwnd,rect
			_width=rect[2]-rect[0]
			_height=rect[3]-rect[1]
			If _width&gt;_presentParams.BackBufferWidth Or _height&gt;_presentParams.BackBufferHeight
				_presentParams.BackBufferWidth=Max( _width,_presentParams.BackBufferWidth )
				_presentParams.BackBufferHeight=Max( _height,_presentParams.BackbufferHeight )
				ResetD3DDevice
			EndIf
		EndIf
	End Method
	
	'NOTE: Returns 1 if flip was successful, otherwise device lost or reset...
	Method Flip( sync )
		Local reset
	
		If sync sync=D3DPRESENT_INTERVAL_ONE Else sync=D3DPRESENT_INTERVAL_IMMEDIATE
		If sync&lt;&gt;_presentParams.PresentationInterval
			_presentParams.PresentationInterval=sync
			reset=True
		EndIf
		
		Select _d3dDev.TestCooperativeLevel()
		Case D3D_OK
			If reset

				ResetD3DDevice

			Else If _attached
			
				Local rect[]=[0,0,_width,_height]
				Return _d3dDev.Present( rect,rect,_hwnd,Null )&gt;=0

			Else

				Return _d3dDev.Present( Null,Null,_hwnd,Null )&gt;=0

			EndIf
		Case D3DERR_DEVICENOTRESET

			ResetD3DDevice

		End Select
	End Method

	Method Driver:TGraphicsDriver()
		Return _driver
	End Method
	
	Method GetSettings( width Var,height Var,depth Var,hertz Var,flags Var )
		'
		ValidateSize
		'
		width=_width
		height=_height
		depth=_depth
		hertz=_hertz
		flags=_flags
	End Method

	Method Close()
		If Not _hwnd Return
		CloseD3DDevice
		If Not _attached DestroyWindow( _hwnd )
		_hwnd=0
	End Method

	Method AutoRelease( unk:IUnknown )
		Local t:TD3D9AutoRelease=New TD3D9AutoRelease
		t.unk=unk
		_autoRelease.AddLast t
	End Method
	
	Method ReleaseNow( unk:IUnknown )
		For Local t:TD3D9AutoRelease=EachIn _autoRelease
			If t.unk=unk
				unk.Release_
				_autoRelease.Remove t
				Return
			EndIf
		Next
	End Method

	
	Field _hwnd
	Field _width
	Field _height
	Field _depth
	Field _hertz
	Field _flags
	Field _attached

End Type

Type TD3D9GraphicsDriver Extends TGraphicsDriver

	Method Create:TD3D9GraphicsDriver()
	
		'create d3d9
		If Not d3d9Lib Return
		
		_d3d=Direct3DCreate9( 32 )
		If Not _d3d Return Null
		
		'get caps
		_d3dCaps=New D3DCAPS9
		If _d3d.GetDeviceCaps( D3DADAPTER_DEFAULT,D3DDEVTYPE_HAL,_d3dCaps )&lt;0
			_d3d.Release_
			_d3d=Null
			Return Null
		EndIf

		'enum graphics modes		
		Local n=_d3d.GetAdapterModeCount( D3DADAPTER_DEFAULT,D3DFMT_X8R8G8B8 )
		_modes=New TGraphicsMode[n]
		Local j
		For Local i=0 Until n
			Local d3dmode:D3DDISPLAYMODE=New D3DDISPLAYMODE

			If _d3d.EnumAdapterModes( D3DADAPTER_DEFAULT,D3DFMT_X8R8G8B8,i,d3dmode )&lt;0
				Continue
			EndIf
			
			Local mode:TGraphicsMode=New TGraphicsMode
			mode.width=d3dmode.Width
			mode.height=d3dmode.Height
			mode.hertz=d3dmode.RefreshRate
			mode.depth=32
			
			_modes[j]=mode
			j:+1
		Next
		_modes=_modes[..j]
	
		'register wndclass
		Local wndclass:WNDCLASSW=New WNDCLASSW
		wndclass.hInstance=GetModuleHandleW( Null )
		wndclass.lpfnWndProc=D3D9WndProc
		wndclass.hCursor=LoadCursorW( Null,Short Ptr IDC_ARROW )
		wndclass.lpszClassName=_wndClass.ToWString()
		RegisterClassW wndclass
		MemFree wndclass.lpszClassName

		Return Self
	End Method
	
	Method GraphicsModes:TGraphicsMode[]()
		Return _modes
	End Method
	
	Method AttachGraphics:TD3D9Graphics( widget,flags )
		Return New TD3D9Graphics.Attach( widget,flags )
	End Method
	
	Method CreateGraphics:TD3D9Graphics( width,height,depth,hertz,flags )
		Return New TD3D9Graphics.Create( width,height,depth,hertz,flags )
	End Method
	
	Method SetGraphics( g:TGraphics )
		_graphics=TD3D9Graphics( g )
	End Method
	
	Method Flip( sync )
		Local present = _graphics.Flip(sync)
		
		Local pixelsdrawn
		If _d3dOccQuery
			_d3dOccQuery.Issue(1) 'D3DISSUE_END
			
			While _d3dOccQuery.GetData( Varptr pixelsdrawn,4,1 )=1 'D3DGETDATA_FLUSH
   			Wend
		EndIf
		'Can read back pixelsdrawn if really wanted :P
		
		_d3dOccQuery.Issue(2) 'D3DISSUE_BEGIN

		Return present
	End Method
	
	Method GetDirect3D:IDirect3D9()
		Return _d3d
	End Method
	
End Type

Function D3D9GraphicsDriver:TD3D9GraphicsDriver()
	Global _done
	If Not _done
		_driver=New TD3D9GraphicsDriver.Create()
		_done=True
	EndIf
	Return _driver
End Function
</textarea><br><br><font class="tiny">Last edited 2012</font> <br><br></td></tr></table><br>
<a name="1121872"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >col</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#95">[#95]</a></td></tr></table></td></tr><tr ><td class="posttext"> Modifications are at..<br>Line 21<br>Lines 102..108<br>Lines 122..123<br>Line 132<br>Lines 138..142<br>Lines 381..395 <br><br></td></tr></table><br>
<a name="1121874"></a>

<a name="1121877"></a>

<a name="1121879"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >therevills</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#96">[#96]</a></td></tr></table></td></tr><tr ><td class="posttext"> Cheers Dave :) I used KDiff (&lt;3 KDiff) to find the changes ;)<br><br>Okay got it to work with DX9 (not sure whats wrong the your exe Dave)... but I still see a small amount of lag with DX9, about the same with the grab pixel fix - I'll have to test it with the work PC on Monkey ;)<br><br><font class="tiny">Last edited 2012</font><br><br><font class="tiny">Last edited 2012</font> <br><br></td></tr></table><br>
<a name="1121878"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Grey Alien</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#97">[#97]</a></td></tr></table></td></tr><tr ><td class="posttext"> I remember testing some of col's code before and it failed because I had the wrong version of some DX files installed, so that could be it. <br><br></td></tr></table><br>
<a name="1121880"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Grey Alien</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#98">[#98]</a></td></tr></table></td></tr><tr ><td class="posttext"> So the occlusion code is a no go? :-(<br><br>Seems testing on a wide based on machines is key and also making sure people know exactly what to look for. <br><br></td></tr></table><br>
<a name="1121881"></a>

<a name="1121882"></a>

<a name="1121884"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >col</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#99">[#99]</a></td></tr></table></td></tr><tr ><td class="posttext"> Thats cool.<br><br>It sounds like it might entering an infinite loop in the Flip function during the While..WEnd of the query at Lines 387 and 388, you could squeeze in a 'get out' clause in between them, may/may not work as it the device shouldnt be lost at this stage, anyway you could  make it look like this...<br><br><b><br>While _d3dOccQuery.GetData( Varptr pixelsdrawn,4,1 )=1 'D3DGETDATA_FLUSH<br>	If  _d3dOccQuery.GetData( Varptr pixelsdrawn,4,1 )&lt;0 Exit<br>Wend<br></b><br><br>oh!! Line 393 should really before the Endif at Line 390 !!!<br><br>@Jake<br>Hey Jake, this is just regular Dx9 stuff. No need for the latest versions etc.<br><br>EDIT:-Crossposting... Im too slow :D<br><br><font class="tiny">Last edited 2012</font> <br><br></td></tr></table><br>
<a name="1121883"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >therevills</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#100">[#100]</a></td></tr></table></td></tr><tr ><td class="posttext"> @Jake - The occlusion code looks the same as the grab pixel code... I need to test it on that dodgy GPU at work.<br><br>@Dave - can you show us the Flip method with these changes, as I've got a blank line at 393. <br><br></td></tr></table><br>
<a name="1121885"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >col</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#101">[#101]</a></td></tr></table></td></tr><tr ><td class="posttext"> uh huh...<br><br><textarea class=codebox name="code" wrap=OFF readonly="true" rows="15" cols="80">
Method Flip( sync )
		Local present = _graphics.Flip(sync)
		
		Local pixelsdrawn
		If _d3dOccQuery
			_d3dOccQuery.Issue(1) 'D3DISSUE_END
			
			While _d3dOccQuery.GetData( Varptr pixelsdrawn,4,1 )=1 'D3DGETDATA_FLUSH
				If  _d3dOccQuery.GetData( Varptr pixelsdrawn,4,1 )&lt;0 Exit
   			Wend

			_d3dOccQuery.Issue(2) 'D3DISSUE_BEGIN
		EndIf
		'Can read back pixelsdrawn if really wanted :P
	
		Return present
	End Method
</textarea> <br><br></td></tr></table><br>
<a name="1121886"></a>

<a name="1121887"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >therevills</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#102">[#102]</a></td></tr></table></td></tr><tr ><td class="posttext"> Ah so just the Issue(2) within the IF statement - ta... testing now.<br><br><br>Results:<br><br>Looks nice and smooth, slight lag same as the GrabPixel fix - will test on Monkey.<br><br>Thanks for showing us how to do this Dave.<br><br>With my fix (delay(17)) I get zero lag but it does hurt the frame rate a tiny bit.<br><br><font class="tiny">Last edited 2012</font> <br><br></td></tr></table><br>
<a name="1121888"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >col</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#103">[#103]</a></td></tr></table></td></tr><tr ><td class="posttext"> Its only that if it did work acceptably and you release to the public, then say the _d3dOccQuery for whatever ends up Null, it would cause a crash at that point, keeping it within the If..EndIf makes sure it will be only called when the query pointer is valid. Also notice the extra line between While..WEnd in there. <br><br></td></tr></table><br>
<a name="1121889"></a>

<a name="1121891"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >col</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#104">[#104]</a></td></tr></table></td></tr><tr ><td class="posttext"> With your Delay... fix I get zero lag unless the delay &gt;= 16 ( Its obvious why this is ;-) ). Anything under that its silky smooth and no lag in all drivers, although the FPS shows under 60FPS ( around 55-56 ), I think it may just be inaccuracies in the algo timings. It looks like a better fix all round so far :P<br><br><font class="tiny">Last edited 2012</font> <br><br></td></tr></table><br>
<a name="1121890"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >therevills</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#105">[#105]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> Also notice the extra line between While..WEnd in there.  <br></div>  Yep I saw that ;) <br><br></td></tr></table><br>
<a name="1121892"></a>

<a name="1121893"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >therevills</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#106">[#106]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> I get zero lag unless the delay &gt;= 16 ( Its obvious why this is ;-) ). Anything under that its silky smooth and no lag in all drivers, so it looks like a better fix all round so far :P  <br></div><br><br>Sorry Dave, I've read this a few times over...<br><br>Are you saying that you get zero lag if the delay is greater or equal to 16, but anyway less (under) than 16 you get silky smooth and also no lag... I'm now confused :S<br><br><font class="tiny">Last edited 2012</font> <br><br></td></tr></table><br>
<a name="1121894"></a>

<a name="1121895"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >col</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#107">[#107]</a></td></tr></table></td></tr><tr ><td class="posttext"> Sorry for the confusion :D<br><br>My bad use of the math symbols.<br><br>Less than 16 and everything is silky smooth as expected. otherwise the framerate halves with generally bad stuttering.<br><br><font class="tiny">Last edited 2012</font> <br><br></td></tr></table><br>
<a name="1121896"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >therevills</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#108">[#108]</a></td></tr></table></td></tr><tr ><td class="posttext"> Okay... so with delay&lt;=16 you still get zero lag? With your fix or mine?<br><br>So whats the better fix all round then? <br><br></td></tr></table><br>
<a name="1121897"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >col</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#109">[#109]</a></td></tr></table></td></tr><tr ><td class="posttext"> I get good results with using your fix on its own, and a good result with my fix on its own. I get outstandingly absolute zero lag with both.<br><br>If I had to use only 1 fix, I'd use yours as its generic across all drivers, my fix is Dx9 only.<br><br>Fundamentally my fix works the same way as the GrabImage fix, which is it pretty much forces the GPU to render any queued up commands that are waiting to be rendered. Using GrabImage forces this same thing because you're asking GPU to read back what is in the backbuffer, so it needs to finish all rendering to get an accurate result. My fix just waits until all rendering in the pipeline is completed before continuing, ending up with the same result really :P <br><br></td></tr></table><br>
<a name="1121898"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >therevills</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#110">[#110]</a></td></tr></table></td></tr><tr ><td class="posttext"> Think we are getting there... so you would use my fix - Delay(17)... but you said  "otherwise the framerate halves with generally bad stuttering" if you use Delay(17)...<br><br>(BTW we really need a chatroom function with this forum to talk back and forward better) <br><br></td></tr></table><br>
<a name="1121899"></a>

<a name="1121900"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >col</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#111">[#111]</a></td></tr></table></td></tr><tr ><td class="posttext"> Using your code...<br><br>DirectX7:-<br>Delay 0 to 17, the mouse pointer stays near the top left of the moving square, but lags more and more as the Delay moves closer to 0. At 17 the lag is almost non-existant.<br><br>DirectX9:-<br>Delay 0 to 15, the mouse pointer stays exactly at the top left of the moving blue square with very little lag while super smooth and FPS shows 55-56. I'm sure its actually getting to the real Flip at the this point ( ie 60FPS ) because its so smooth.<br>Delay 16, It looks like its playing catchup inbetween frames. Its smooth then jerky, then smooth and so on.<br>Delay 17. Horrific stuttering. 29-30FPS.<br><br>OpenGL:-<br>Delay 0 to 16,  horrific lag. Worse of them all. Like really bad.<br>Delay 17. Almost zero lag.<br><br>On all drivers, going higher than Delay 17 causes the FPS to drop which then causes very noticable stuttering with the movement. No mouse lag though! although the effect is not nice, so a definite no go there.<br><br>Totally agree with the chatroom idea ;-) Archived so that others could also read the conversations at a later date too. Mods.... where are you ;-)<br><br><font class="tiny">Last edited 2012</font> <br><br></td></tr></table><br>
<a name="1121901"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >therevills</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#112">[#112]</a></td></tr></table></td></tr><tr ><td class="posttext"> Cool - thanks for Dave.<br><br>Whats PC are you testing on? (CPU,GPU etc)<br><br>On mine (specs in sig), I get no lag with delay 17, but the "catchup" now and again with all drivers. When I go into window mode with DX7 I get 30FPS.<br><br>I wonder if we could set delay to 16.6667 if it would be any better... I can't find the code which does the delay stuff, it looks like an extern calling bbDelay, but I can't find bbDelay. <br><br></td></tr></table><br>
<a name="1121902"></a>

<a name="1121904"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Grey Alien</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#113">[#113]</a></td></tr></table></td></tr><tr ><td class="posttext"> Btw, I like how the new test shows up the lag really clearly so no one can say it's not there.<br><br>Here are my results with therevills code:<br><br>**DirectX7:<br>Full screen:<br>Delay 0 to 14 = lag but very smooth movement (62FPS)<br>Delay 15 = this is the crossover point where it mostly lags but sometimes is in sync and the movement has occasional jitters<br>Delay 16 = lag disappears, more jerkiness. (55-58FPS)<br>Delay 17 = lag gone, even jerkier. (52-55FPS)<br>Delay 18+ = lag gone, horrible jerky, decreasing FPS.<br><br>Windowed mode:<br>Delay 0 to 12 = lag + jerky + 62 FPS (windowed mode never used to be jerky when I got Blitz to sort out the VSync years ago but I think they changed it again).<br>Delay 13+ = lag (never goes away), jerky as hell, FPS begins to plummet.<br><br>**Direct X9:<br>Full Screen:<br>Delay 0 to 15 = lag (bigger than DirectX7) but very smooth movement (62FPS)<br>Delay 16 = this is the crossover point with mostly lags and some jitters.<br>Delay 17 = lag gone but jerky. (58 FPS)<br>Delay 18+ = lag gone, worse jerkiness, declining FPS<br><br>Windows mode:<br>Delay 0 to 15 = lag (bigger than DirectX7 but smaller than Full Screen mode) but very smooth movement unlike DirectX 7 in windowed mode(62FPS)<br>Delay 16 = crossover point with mostly lag + occasional jitter<br>Delay 17 = lag is reduced but doesn't completely go away like in Full screen mode (58 FPS)<br>Delay 18+ = small lag still, worse jerkiness, worse FPS<br><br>**OpenGL<br>Basically exactly the same as DX9<br><br><font class="tiny">Last edited 2012</font> <br><br></td></tr></table><br>
<a name="1121903"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >therevills</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#114">[#114]</a></td></tr></table></td></tr><tr ><td class="posttext"> Oh on another note, I've just tested my Mac Mini and there isnt any need for any kind of "fixes" as it there isnt any lag in Fullscreen mode or Window mode.<br><br>Which is kind of strange, as I would have thought the whole vsync/input lag would be the same on a Mac... <br><br></td></tr></table><br>
<a name="1121905"></a>

<a name="1121907"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Grey Alien</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#115">[#115]</a></td></tr></table></td></tr><tr ><td class="posttext"> Yeah up higher I say that I tested the old code on Mac and saw no lag in Full screen and maybe a tiny bit in windowed.  Need to test your more obvious code.<br><br>From my tests on my PC, I'd prefer to run the game without any delay because as soon as the delay reaches approx 1 frame (16.66666ms) jerkiness begins to occur and only gets worse.  Plus if you write a game with varying amounts of CPU stuff happening per frame, you can't work out how much the delay should be (well maybe approx. if you checked millisecs).  I really don't feel this is a solution.<br><br>It also sounds like the occlusion code won't do anything different from the original fix in my code at the top, although definitely test it on your work PC @therevills and see if it halves the framerate.  What I'd like to know really is if you took 100 PCs with varying video cards, how many the lag fix was horrible on.<br><br>Also big thanks to you two for keeping on trying different things! It's cool.<br><br><font class="tiny">Last edited 2012</font> <br><br></td></tr></table><br>
<a name="1121906"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >col</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#116">[#116]</a></td></tr></table></td></tr><tr ><td class="posttext"> Thats cool.<br><br>Those results are on a Sony Vaio VGN-FW31M - Win7 x64. The results were very similar using the same machine and Vista x86 ( 32bit ).<br><br><div class="quote"> <br>I wonder if we could set delay to 16.6667 if it would be any better... I can't find the code which does the delay stuff, it looks like an extern calling bbDelay, but I can't find bbDelay<br> <br></div><br>How about setting a timer to 60 then waiting for the timer before Flip ? This would remove any varying timings? By varying I mean timings that are different across machines caused by varying cpu/gpus speeds and configs. The above example doesnt really push the gpu and isnt a realistic load on the cpu/gpu. As the load increases there will be less time for the cpu to take advantage of fixed Delay(s). Just throwing spanners in the works :D<br><br><br>Delay (bbDelay) uses the OS 'sleeping' mechanisms so any spare time is returned to the system - brl.mod/blitz.mod/blitz_app.c <br><br></td></tr></table><br>
<a name="1121908"></a>

<a name="1121909"></a>

<a name="1121910"></a>

<a name="1121911"></a>

<a name="1121912"></a>

<a name="1121913"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Grey Alien</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#117">[#117]</a></td></tr></table></td></tr><tr ><td class="posttext"> @Col Sounds like you are also saying that varying CPU load will throw a spanner in the works.  For me the lag ONLY goes away when jerkiness begins and that's not a compromise I'd like to do.<br><br>[EDIT]<br><br>So what are the options for PC?<br><br>1) Looks smooth on most machines with no lag (original fix) and crappy on a few (unknown how big "few" is)<br>2) Jerky on most with no lag (Delay fix)<br>3) Have no lag fix and a hardware mouse cursor (not good for keyboard based games or where mouse is used to draw/drag).<br>4) Or, ahem, go back to DX7 which had minimal lag.  Problem is no VirtualRes stuff will work and that's bad for scaling down games on modern netbooks (= lost sales)<br>5) Test out DX10/11+ and see if any better and force customers to upgrade (bad idea for casual market)<br><br>No point switching to OpenGL as that acts same as DX9.<br><br><font class="tiny">Last edited 2012</font> <br><br></td></tr></table><br>
<a name="1121914"></a>

<a name="1121916"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >therevills</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#118">[#118]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> How about setting a timer to 60 then waiting for the timer before Flip  <br></div><br>Nice idea... just tried it. Set at 60 I get the same lag. When I set it as 58 I get a tiny bit of lag, but a tad jerky...<br><br><div class="quote"> brl.mod/blitz.mod/blitz_app.c  <br></div><br>I must start removing the file filter off my search...<br>I must start removing the file filter off my search...<br>I must start removing the file filter off my search... ;)<br><br><div class="quote"> So what are the options for PC? <br></div><br>6) Use Dave's occlusion query (only for DX9)<br>7) Turn vsync off<br><br><font class="tiny">Last edited 2012</font> <br><br></td></tr></table><br>
<a name="1121917"></a>

<a name="1121920"></a>

<a name="1121921"></a>

<a name="1121922"></a>

<a name="1121923"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >col</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#119">[#119]</a></td></tr></table></td></tr><tr ><td class="posttext"> Using therevills code...<br>I just think that if using a 'fixed Delay' value, as the load increases, then there will be less time between frames, hence the required delay would need to be less. EDIT :- Different loads and different cpu speeds means a different Delay required?<br><br>I guess an automatic dynamic frame counter incorporated into the 'Delay' would help to prevent such problems? Maybe also a manual override like therevills has in his example code. Would people be put off by manually setting up the game timing ( using a one time initial setup screen ) on first time use? The delay mechanism gives the best 'all round' result for me.<br><br>@Jake BTW what system specs do you have there?<br><br>I just tested the examples above on Dx10/Dx11 driver and it suffers the same amount of lag as Dx9. The same fixes above fix it by the same amount too. I've not incorporated any multi-threading into it yet ( to keep it Dx10 compatible ), but I dont think it'll get rid of it anyway. The multi-threading helps when it comes to uploading into the GPU. It wont really help with render lag, if anything it could make it worse.<br><br><font class="tiny">Last edited 2012</font> <br><br></td></tr></table><br>
<a name="1121919"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >col</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#120">[#120]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> <br>Set at 60 I get the same lag.<br> <br></div><br><br>Is that when using any 'fixes', or when using Jakes first example? <br><br></td></tr></table><br>
<a name="1121924"></a>

<a name="1121925"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >therevills</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#121">[#121]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> Is that when using any 'fixes', <br></div><br><br>Nope, no fixes apart from a Timer...<br><br><pre class=code>Global timer:TTimer = CreateTimer(60)</pre><br><br><pre class=code>	
	WaitTimer( timer )

	Flip 1

	Delay(1)
</pre><br><br><font class="tiny">Last edited 2012</font> <br><br></td></tr></table><br>
<a name="1122120"></a>

<a name="1122121"></a>

<a name="1122123"></a>

<a name="1122124"></a>

<a name="1122125"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >therevills</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#122">[#122]</a></td></tr></table></td></tr><tr ><td class="posttext"> So Monday came around a bit too fast...<br><br>Anyway as promised - testing Dave's occlusion query on this work PC specs:<br><br>CPU: Intel Core 2 Duo E8400 @ 3GHz<br>GPU: NVIDIA Quadro NVS 290<br>RAM: 2GB<br>OS: Windows 7 32bit<br><br>Going thru the motions:<br><br>DX7 Window: Slight lag - 62FPS<br>DX7 Window with Grab Pixel Fix: Slight lag  - 62FPS<br>DX7 Full Screen: Slight lag  - 62FPS<br>DX7 Full Screen with Grab Pixel Fix: Slight lag  - 62FPS<br><br>(This is where Dave's occlusion query comes into play)<br>DX9 Window with occlusion query fix: Slight lag - 62FPS<br>DX9 Window with Grab Pixel Fix and occlusion query fix: Slight lag - 62FPS<br>DX9 Full Screen with occlusion query fix: Slight lag - 62 FPS<br>DX9 Full Screen with Grab Pixel Fix and occlusion query fix: Slight lag - <b>40FPS</b><br><br>OpenGL Window: No lag - 62FPS<br>OpenGL Window with Grab Pixel Fix: No lag - 62FPS<br>OpenGL Full Screen: No lag - 62FPS<br>OpenGL Full Screen with Grab Pixel Fix: No lag - 62FPS<br><br>Looks good :) (well its not perfect but a lot better - same as DX7 I would say)<br><br><font class="tiny">Last edited 2012</font><br><br>And without the occlusion query:<br><br>DX9 Window: Slight lag - 62FPS<br>DX9 Window with Grab Pixel Fix: Slight lag - 62FPS<br>DX9 Full Screen: <b>HUGE</b> lag - 62 FPS<br>DX9 Full Screen with Grab Pixel Fix: Slight lag - <b>40FPS</b><br><br><font class="tiny">Last edited 2012</font><br><br><font class="tiny">Last edited 2012</font><br><br><font class="tiny">Last edited 2012</font> <br><br></td></tr></table><br>
<a name="1122145"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Grey Alien</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#123">[#123]</a></td></tr></table></td></tr><tr ><td class="posttext"> Wow that's interesting, so the occlusion fix gives better performance than grab pixel on that work PC right?  Seems like that could be the best solution then.  A module tweak rather than some top level code.  I wonder if BRL would consider adding this as an official tweak, perhaps with a flag called "fixRenderLag" or something? <br><br></td></tr></table><br>
<a name="1122147"></a>

<a name="1122148"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >therevills</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#124">[#124]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> so the occlusion fix gives better performance than grab pixel on that work PC right?  <br></div><br><br>Yep, just to clarify - the occlusion fix helps the mouse lag and runs at 62FPS, the grab pixel helps the mouse lag but runs at 40FPS.<br><br>I've got one more test to run for this occlusion fix, I've got an old PC running Windows XP with DirectX8 installed. I'm going to install DX9 (so install SP2) and see how that handles this fix - from memory its got an intel onboard GPU...<br><br><div class="quote"> perhaps with a flag called "fixRenderLag" or something?  <br></div><br><br>This is exactly what I am going to add :)<br><br><font class="tiny">Last edited 2012</font> <br><br></td></tr></table><br>
<a name="1122175"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >therevills</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#125">[#125]</a></td></tr></table></td></tr><tr ><td class="posttext"> Just installed Windows XP SP2 with Directx9c on an oldish/slowish PC:<br><br>CPU: Intel Celeron E1200 @ 1.6GHz<br>GPU: Intel G33/G31 Express<br>RAM: 2GB<br>OS: Windows XP SP2<br><br>DX7 Window: No lag - 62FPS<br>DX7 Window with Grab Pixel Fix: No lag - 62FPS<br>DX7 Full Screen: Slight lag - 62FPS<br>DX7 Full Screen with Grab Pixel Fix: Slight lag - 62FPS<br><br>(This is where Dave's occlusion query comes into play)<br>DX9 Window with occlusion query fix: Slight lag - 62FPS<br>DX9 Window with Grab Pixel Fix and occlusion query fix: Slight lag - 62FPS<br>DX9 Full Screen with occlusion query fix: Slight lag - 62 FPS<br>DX9 Full Screen with Grab Pixel Fix and occlusion query fix: Slight lag - 62FPS<br><br>OpenGL Window: Cant tell the lag! - <b>500FPS!?!?!?!?</b><br>OpenGL Window with Grab Pixel Fix: No lag! - 333FPS!?!?<br>OpenGL Full Screen: No lag - 250FPS<br>OpenGL Full Screen with Grab Pixel Fix: No lag - 333FPS<br><br><br>So not sure whats happening with the OpenGL there (not waiting for the vertical sync!?), but the occlusion query fix works fine on this PC.<br><br><br>So I think I am going to do the following:<br><pre class=code>
If driver=DIRECTX7 or driver=OPENGL
  useGrabPixelFix = True
Else
  ' dont use grab pixel fix for DirectX9 due to poor performance on some pcs
  useGrabPixelFix = False
End If
' Using modified BlitzMax DirectX9 driver which does an occlusion query 
</pre> <br><br></td></tr></table><br>
<a name="1122177"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >therevills</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#126">[#126]</a></td></tr></table></td></tr><tr ><td class="posttext"> Oh and I've added the flag to BlitzMax so you can turn it on and off when you want:<br><br>In brl.mod/graphics.mod/graphics.bmx add UseDX9RenderLagFix:<br><pre class=code>
Public

Global GraphicsSeq=1
Global UseDX9RenderLagFix% = 0 ' new boolean
</pre><br><br>And in brl.mod/dxgraphics.mod/d3d9graphics.bmx:<br><pre class=code>
	Method Flip( sync )
		Local present = _graphics.Flip(sync)
		If UseDX9RenderLagFix Then
			Local pixelsdrawn
			If _d3dOccQuery
				_d3dOccQuery.Issue(1) 'D3DISSUE_END
				
				While _d3dOccQuery.GetData( Varptr pixelsdrawn,4,1 )=1 'D3DGETDATA_FLUSH
					If  _d3dOccQuery.GetData( Varptr pixelsdrawn,4,1 )&lt;0 Exit
				Wend

				_d3dOccQuery.Issue(2) 'D3DISSUE_BEGIN
			EndIf
			'Can read back pixelsdrawn if really wanted :P
		End If
		
		Return present
	End Method
</pre><br><br>Thanks again Dave for the OccQuery :) <br><br></td></tr></table><br>
<a name="1122180"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >col</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#127">[#127]</a></td></tr></table></td></tr><tr ><td class="posttext"> Very interesting results going on there with the OpenGL driver. I had a similar thing happen one time on Vista. It seemingly just started to happen. I re-installed BMax and it fixed it. I really don't know why it happened because I'm generally playing the Dx drivers :/<br><br>That's cool the occlusion query is working out ok :P <br><br></td></tr></table><br>
<a name="1122185"></a>

<a name="1122186"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Grey Alien</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#128">[#128]</a></td></tr></table></td></tr><tr ><td class="posttext"> Yeah really cool, thanks Dave and therevills for sorting that out, pretty epic teamwork there.  Guess there's no reason not to add this then.<br><br><font class="tiny">Last edited 2012</font> <br><br></td></tr></table><br>
<a name="1122189"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >therevills</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#129">[#129]</a></td></tr></table></td></tr><tr ><td class="posttext"> I've tested this on 3 Nvidia GPUs and 1 Intel... can anyone test the occlusion query on an ATi GPU? <br><br></td></tr></table><br>
<a name="1122191"></a>

<a name="1122216"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >col</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#130">[#130]</a></td></tr></table></td></tr><tr ><td class="posttext"> Thanks Jake and therevills,<br><br>For completeness, in the Flip method, I do think this line is redundant and can be safely removed :-<br><br><b>If  _d3dOccQuery.GetData( Varptr pixelsdrawn,4,1 )&lt;0 Exit</b><br><br>Reason being... logically, if the return value at the line before ( the While ) equals 1 ( which is a FAIL value ) then the loop is continued. Any other value and the loop ends anyway, which make the 'If ... &lt;0' test redundant. I only added it in thinking that the code was entering an infinite loop on therevills machine, but it appears to be a busted .exe in the download.<br><br>You don't 'need' to remove it, but it is redundant and a bit pointless :D<br><br>Have fun :-)<br><br><font class="tiny">Last edited 2012</font> <br><br></td></tr></table><br>
<a name="1122192"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >col</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#131">[#131]</a></td></tr></table></td></tr><tr ><td class="posttext"> The Gpu is ATI in my laptop :) <br><br></td></tr></table><br>
<a name="1122286"></a>

<a name="1122288"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >therevills</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#132">[#132]</a></td></tr></table></td></tr><tr ><td class="posttext"> Excellent so we can (hopefully) say it works with Nvidia, Intel and ATi :)<br><br>I'm just going to leave that line in at the moment as I've spent far too long on this issue testing multiple machines etc, and I know that with that line it works, but I do agree it "looks" redundant ;)<br><br>I've uploaded an exe if anyone else would like this:<br><br><a href="http://diddy.googlecode.com/files/dx9.debug.zip" target="_blank">http://diddy.googlecode.com/files/dx9.debug.zip</a><br><br><font class="tiny">Last edited 2012</font> <br><br></td></tr></table><br>
<a name="1122330"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Grey Alien</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#133">[#133]</a></td></tr></table></td></tr><tr ><td class="posttext"> Works great on my PC.  Both fixes work fine in full-screen DX9, no difference.  In windowed mode the fixes do nothing but the lag is less.  Shame we can't fix windowed mode too.<br><br>I forgot to post my specs:<br><br>Intel i7 870 (Quad core @ 2.93GHz)<br>4 GB RAM<br>Windows 7<br>NVidia Geforce GTX 460<br>DX 11 installed <br><br></td></tr></table><br>
<a name="1122449"></a>

<a name="1122450"></a>

<a name="1122451"></a>

<a name="1122452"></a>

<a name="1122453"></a>

<a name="1122454"></a>

<a name="1122455"></a>

<a name="1122462"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >col</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#134">[#134]</a></td></tr></table></td></tr><tr ><td class="posttext"> Taking on some ideas and info from DStastny....<br><br>I've added a couple of lines to disable aero in code using the A key for testing in Windowed mode. I'll look into the Flush method he proposes too...<br><br>Results:<br>Dx7 - Zero lag ( as opposed to some lag )<br>Dx9 - Same tiny lag as Dx7 when in full screen. A definite improvement but small and acceptable is there instead of BIG lag.<br>Opengl - <strike>VSync seems switched off, so fast the FPS returns negative</strike> EDIT:- Not sure what happened there but its OK now :D EDIT2:- I've worked out that if started in windowed mode then going to the OpenGL driver the FPS goes crazy, but after going FullScreen then back to windowed the FPS is OK ( this is with Aero DISABLED ) :/<br><br><textarea class=codebox name="code" wrap=OFF readonly="true" rows="15" cols="80">
SuperStrict

?win32
'AERO SPECIFIC
Global DwmapiDLL:Int = LoadLibraryA("dwmapi.dll")
Global IsAeroEnabled(pfEnabled:Int Var)
Global EnableAero(uCompositionAction:Int)

If DwmapiDLL
	IsAeroEnabled = GetProcAddress(DwmapiDLL,"DwmIsCompositionEnabled")
	EnableAero = GetProcAddress(DwmapiDLL,"DwmEnableComposition")
EndIf

Global AeroState%
If DwmapiDLL IsAeroEnabled(AeroState)
'END OF AERO SPECIFIC
?

Const DIRECTX7% = 0
Const DIRECTX9% = 1
Const OPENGL% = 2

Global currentDriver% = DIRECTX7
?MacOS
currentDriver = OPENGL
?
Global fullScreen% = 0
Global useFix% = 0
Global screenWidth% = 0
Global screenHeight% = 0
Global blockX% = 0
Global aerofix% = AeroState

Global fps_counter% = 0
Global update_frequency% = 10
Global fps_milli% = MilliSecs()
Global fps%
Global delay_amount% = 0

Global x#, y#
Global angle#
Global cx%, cy%
Global rad% = 100

SetDriver()
CreateScreen()

While Not KeyHit(KEY_ESCAPE)
	Test()
Wend

?Win32
If DwmapiDLL EnableAero(AeroState)
?

End

Function Test()
	Cls

	SetColor 255,255,255
	Local x%,y% = 10
	Local gap% = 15
	DrawText "Press D to change Driver (current = "+GetDriverString()+")",x,y
	y:+gap
	DrawText "Press F to toggle Fix (current = "+useFix+")",x,y	
	y:+gap
	DrawText "Press A to toggle Aero (Vista/Win7) - AeroEnabled = "+aerofix,x,y
	y:+gap
	DrawText "Press S to toggle Full Screen",x,y
	y:+gap
	DrawText "FPS:"+fps, x, y
	y:+gap
	DrawText "Delay:"+delay_amount+" (Cursor Keys Left and Right to change)", x, y
	y:+gap
	DrawText "Press Esc to Exit",x,y	
	
	SetColor 100,100,230
	DrawRect MouseX(),MouseY(),50,50
	
	SetColor 100,230,100
	DrawRect blockX, screenHeight-100,50,50
	blockX:+1
	If BlockX&gt;screenWidth Then blockX:-screenWidth
	
	If useFix Then
		Local MouseHack:TPixmap
		MouseHack = GrabPixmap(1, 1, 1, 1)
	EndIf
	
	Flip 1
	Delay(delay_amount)	
	
	
	fps_counter=fps_counter+1
	If fps_counter=update_frequency
	     fps=1000/Float(((MilliSecs()-fps_milli))/update_frequency)
	     fps_milli=MilliSecs()
	     fps_counter=0
	EndIf

	
	?win32
	If KeyHit(KEY_D) Then
		currentDriver:+1
		If currentDriver&gt;OPENGL Then currentDriver= DIRECTX7 'wrap
		SetDriver()
		CreateScreen()
	EndIf
	
	If KeyHit(KEY_A)
		aerofix = 1 - aerofix
		If DwmapiDLL EnableAero(aerofix)
	EndIf
	?
	
	angle:+4
	
	x = cx + (Sin(angle) * rad)
	y = cy + (Cos(angle) * rad)
	
	MoveMouse(x, y)
	
	If KeyHit(KEY_S) Then
		fullScreen = Not fullScreen
		CreateScreen()
	EndIf

	If KeyHit(KEY_F) Then
		useFix= Not useFix
	EndIf

	If KeyHit(KEY_LEFT)
		delay_amount:-1
		Delay(100)
	EndIf
	If KeyHit(KEY_RIGHT)
		delay_amount:+1
		Delay(100)
	EndIf
End Function

Function SetDriver()
	Select currentDriver
		?win32
		Case DIRECTX7
			SetGraphicsDriver D3D7Max2DDriver()
		Case DIRECTX9
			SetGraphicsDriver D3D9Max2DDriver()
		?
		Case OPENGL
			SetGraphicsDriver GLMax2DDriver()
	End Select
End Function

Function CreateScreen()
	If fullScreen Then
		screenWidth = 800
		screenHeight = 600
		Graphics screenWidth, screenHeight, 32, 60
	Else
		screenWidth = 640
		screenHeight = 480
		Graphics screenWidth, screenHeight, 0
	EndIf	
	
	cx = ScreenWidth/2
	cy = ScreenHeight/2
	
End Function

Function GetDriverString$()
	Select currentDriver
		Case DIRECTX7
			Return "DirectX 7"
		Case DIRECTX9
			Return "DirectX 9"
		Case OPENGL
			Return "Open GL"
	End Select
End Function
</textarea><br><br><font class="tiny">Last edited 2012</font> <br><br></td></tr></table><br>
<a name="1122492"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >therevills</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#135">[#135]</a></td></tr></table></td></tr><tr ><td class="posttext"> Yep I've just done the same :)<br><br>The only issue here is that it disables the whole desktop and on mine I get a Window 7 popup message: "The color scheme has been changed to Windows 7 Basic"<br><br>I've read that DirectX3D 9Ex is meant to help the Aero lag too... but I didnt even know about DX9Ex until this morning...<br><br><a href="http://msdn.microsoft.com/en-us/library/windows/desktop/ee890072%28v=vs.85%29.aspx#flip_model" target="_blank">http://msdn.microsoft.com/en-us/library/windows/desktop/ee890072%28v=vs.85%29.aspx#flip_model</a><br><br>Also it looks like a Windows 7 only thing... <br><br></td></tr></table><br>
<a name="1122493"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >col</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#136">[#136]</a></td></tr></table></td></tr><tr ><td class="posttext"> Yep the 9Ex is Win7 only. Would it be a little premature to make a Win7 only driver, not enough users in the real world just yet?<br><br>DirectX is a HUGE api, and Direct3D is only a part of it and thats still BIG.<br><br>No matter what method I use to disable Aero ( in the app icon or in code ), the whole desktop gets disabled, not just the app window?, except for I get the message when using the code. There might be a method to suppress the message. I'll look... <br><br></td></tr></table><br>
<a name="1122500"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >BlitzSupport</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#137">[#137]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> <br>The only issue here is that it disables the whole desktop and on mine I get a Window 7 popup message: "The color scheme has been changed to Windows 7 Basic"<br> <br></div><br><br>As far as I'm aware, that's perfectly normal when a single app requests to disable Aero. You can't have it only for some apps. <br><br></td></tr></table><br>
<a name="1122510"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Grey Alien</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#138">[#138]</a></td></tr></table></td></tr><tr ><td class="posttext"> That won't be acceptable unfortunately, we definitely can't fiddle with users' desktops.  Shame! <br><br></td></tr></table><br>
<a name="1122855"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >therevills</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#139">[#139]</a></td></tr></table></td></tr><tr ><td class="posttext"> Okay guys, I've gone back to frame limiting... can you give this a try please:<br><br><textarea class=codebox name="code" wrap=OFF readonly="true" rows="15" cols="80">
SuperStrict

?win32

'AERO SPECIFIC
Global DwmapiDLL:Int = LoadLibraryA("dwmapi.dll")
Global IsAeroEnabled(pfEnabled:Int Var)
Global EnableAero(uCompositionAction:Int)

If DwmapiDLL
	IsAeroEnabled = GetProcAddress(DwmapiDLL,"DwmIsCompositionEnabled")
	EnableAero = GetProcAddress(DwmapiDLL,"DwmEnableComposition")
EndIf

Global AeroState%
If DwmapiDLL IsAeroEnabled(AeroState)
'END OF AERO SPECIFIC

?

Const DIRECTX7% = 0
Const DIRECTX9% = 1
Const OPENGL% = 2

Global currentDriver% = OPENGL
?MacOS
currentDriver = OPENGL
?
Global fullScreen% = 0
Global useFix% = 0
Global screenWidth% = 0
Global screenHeight% = 0
Global blockX% = 0
Global aerofix% = AeroState
Global framelimiterOn% = 1

Global fps_counter% = 0
Global update_frequency% = 5
Global fps_milli% = MilliSecs()
Global fps%

Global x#, y#
Global angle#
Global cx%, cy%
Global rad% = 100

UseDX9RenderLagFix = False

Global framerate_limit:Int = 59
Global frame_start_time:Int = MilliSecs()
Global delay_amount# = 0
' frl
Global delta!
Global deltaAmount!
Global frameRateLogic# = 100
Global ms# = 0
Global tmpMs!
Global numTicks!
Global lastNumTicks!
Global maxMs% = 50
Global lastTime!

ms = 1000 / frameRateLogic
numTicks = 0
lastNumTicks = 1
lastTime = MilliSecs()

Print ms
Print lastTime

SetDriver()
CreateScreen()

While Not KeyHit(KEY_ESCAPE)
	Test()
Wend

?Win32
If DwmapiDLL EnableAero(AeroState)
?

End

Function Test()

	Local now% = MilliSecs()
	If now &lt; lastTime
		numTicks = lastNumTicks
	Else
		tmpMs = now - lastTime
		If tmpMs &gt; maxMs Then tmpMs = maxMs
		numTicks = tmpMs / ms
	EndIf
	lastTime = now
	lastNumTicks = numTicks
	
	For Local i% = 1 To Floor(numTicks)
		Update(1)
	Next
	Local re# = numTicks Mod 1
	If re &gt; 0 Then
		Update(re)
	EndIf
	Render()

End Function

Function Render()
	Cls

	SetColor 255,255,255
	Local x%, y% = 10
	Local gap% = 15
	DrawText "Press D to change Driver (current = "+GetDriverString()+")",x,y
	y:+gap
	If useFix Then SetColor 255, 255, 0
	DrawText "Press F1 to toggle Grab Pixel Fix (current = "+useFix+")",x,y	
	SetColor 255, 255, 255
	y:+gap
	If UseDX9RenderLagFix Then SetColor 255, 255, 0
	DrawText "Press F2 to toggle DX9 Fix (current = "+UseDX9RenderLagFix+")",x,y	
	SetColor 255, 255, 255
	y:+gap
	If framelimiterOn Then SetColor 255, 255, 0
	DrawText "Press F3 to toggle Frame Limiter (current = "+framelimiterOn +")",x,y	
	SetColor 255, 255, 255
	y:+gap
	DrawText "Press A to toggle Aero (Vista/Win7) - AeroEnabled = "+aerofix,x,y
	y:+gap
	DrawText "Press S to toggle Full Screen",x,y
	y:+gap
	DrawText "FPS:"+fps, x, y
	y:+gap
	DrawText "delay amount :"+delay_amount, x, y
	y:+gap
	DrawText "Delta:"+deltaAmount, x, y
	y:+gap
	If Not framelimiterOn Then SetColor 155, 155, 155
	DrawText "framerate_limit = "+framerate_limit+ " (Cursor Keys Up and Down to change)", x, y
	SetColor 255, 255, 255
	y:+gap
	DrawText "Press Esc to Exit",x,y	
	
	SetColor 100,100,230
	DrawRect MouseX(),MouseY(),50,50
	
	SetColor 100,230,100
	DrawRect blockX, screenHeight-100,50,50
	
	If BlockX &gt; screenWidth Then blockX:-screenWidth+50
	
	If useFix Then
		GrabPixmap(1, 1, 1, 1)
	EndIf
	
	Flip 1
	
	fps_counter=fps_counter+1
	If fps_counter=update_frequency
	     fps=1000/Float(((MilliSecs()-fps_milli))/update_frequency)
	     fps_milli=MilliSecs()
	     fps_counter=0
	EndIf
	
	If framelimiterOn
		Local one_frame_limit:Float = 1000.0/Float(framerate_limit) ' 16.666 ms 
	
		Local time_left:Float = one_frame_limit - (MilliSecs() - frame_start_time)
		delay_amount = 0
		While time_left &gt; 0
			If time_left &gt;= 6.0
				delay_amount:+Int(time_left)/6.0
				Delay(Int(time_left)/6.0)
		    Else
		        Delay(0)
		    EndIf
			time_left = one_frame_limit - (MilliSecs()-frame_start_time)
		Wend
		frame_start_time = MilliSecs() 
	Else
		delay_amount = 1
		Delay(1)
	EndIf
	
End Function

Function Update(delta#)
	deltaAmount = delta
	?win32
	If KeyHit(KEY_D) Then
		currentDriver:+1
		If currentDriver&gt;OPENGL Then currentDriver= DIRECTX7 'wrap
		SetDriver()
		CreateScreen()
	EndIf
	
	If KeyHit(KEY_A)
		aerofix = 1 - aerofix
		If DwmapiDLL EnableAero(aerofix)
	EndIf
	?
	blockX:+3 * delta

	angle:+3 * delta
	
	x = cx + (Sin(angle) * rad)
	y = cy + (Cos(angle) * rad)

	If Not AppSuspended()
		MoveMouse(x, y)
	EndIf
	
	If KeyHit(KEY_S) Then
		fullScreen = Not fullScreen
		CreateScreen()
	EndIf

	If KeyHit(KEY_F1) Then
		useFix = Not useFix
		If useFix
			UseDX9RenderLagFix = False
			framelimiterOn = False
		EndIf
	EndIf
	
	If KeyHit(KEY_F2) Then
		UseDX9RenderLagFix = Not UseDX9RenderLagFix
		If UseDX9RenderLagFix
			useFix = False
			framelimiterOn = False
		EndIf
	EndIf
	
	If KeyHit(KEY_F3) Then
		framelimiterOn = Not framelimiterOn
		If framelimiterOn
			UseDX9RenderLagFix = False
			useFix= False
		EndIf
	EndIf

	If framelimiterOn
		If KeyHit(KEY_DOWN)
			framerate_limit:-1
			Delay(50)
		EndIf
		If KeyHit(KEY_UP)
			framerate_limit:+1
			Delay(50)
		EndIf
	EndIf
End Function

Function SetDriver()
	Select currentDriver
		?win32
		Case DIRECTX7
			SetGraphicsDriver D3D7Max2DDriver()
		Case DIRECTX9
			SetGraphicsDriver D3D9Max2DDriver()
		?
		Case OPENGL
			SetGraphicsDriver GLMax2DDriver()
	End Select
End Function

Function CreateScreen()
	If fullScreen Then
		screenWidth = 800
		screenHeight = 600
		Graphics screenWidth, screenHeight, 32, 60
	Else
		screenWidth = 640
		screenHeight = 480
		Graphics screenWidth, screenHeight, 0', 30
	EndIf	
	
	cx = ScreenWidth/2
	cy = ScreenHeight/2
	
End Function

Function GetDriverString$()
	Select currentDriver
		Case DIRECTX7
			Return "DirectX 7"
		Case DIRECTX9
			Return "DirectX 9"
		Case OPENGL
			Return "Open GL"
	End Select
End Function
</textarea><br><br>You will need the code from post #126 if you want to test the DX9 Fix - or you can download the exe from here: <a href="http://diddy.googlecode.com/files/dx9.debug_test_2.rar" target="_blank">http://diddy.googlecode.com/files/dx9.debug_test_2.rar</a><br><br>Play around with the framerate_limit, I'm thinking about setting it to 59... <br><br></td></tr></table><br>
<a name="1123032"></a>

<a name="1123033"></a>

<a name="1123034"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >col</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#140">[#140]</a></td></tr></table></td></tr><tr ><td class="posttext"> Hiya,<br><br>Interesting...<br><br>I assume you want just windowed results with this one as the fullscreen is 'fixed enough to be acceptable' ??...<br><br>Using the code ( not the .exe )...<br><br>All drivers...<br>Every second I get a jump in the movement and the delay amount looks like its 'resetting' or i should say recalculating the timing delay. The FPS counter also reflects this by going from a steady 62 to 58 for a tiny number of frames, 1, 2 or maybe 3 frames at the most. Probably not really relevant as its only for the 1st second ( until timings are established? ) it has terrible lag. The 'long term' lag is about the same as the original Dx7 lag in full screen, but with Dx9 there is a tiny amount more lag, not much but with a keen eye you can see it - I don't think Joe Public would be able to see this difference.<br><br>These 3 results include the above 'every second' hesitation...<br><br><b>OpenGL</b> - is smoothish with the equivalent of the same amount of lag in the original Dx7 lag, but the squares and cursor seem to be moving slightly faster than the Dx drivers?? maybe its me :/ lol. During the hesitation the delay figure is altered but its too fast to what it changes to as it can only be for about 1 or 2 frames.<br><br><b>Dx7</b> - not as smooth as OpenGL, quite jerky actually especially while the figures are changing :- at the hesitation point the Delay figure increases from 0.000 to 8.000 over a number of frames then goes back to zero until the next hesitation. Using this driver the Delta figure also changes at the hesitation frame but only for 1 frame as its too fast to see the figure.<br><br><b>Dx9</b> - smoothest of them all, at the hesitation point the Delay changes to about 8.xxxx then over a number of frames ( very very fast ) steps up to 13.666666 and holds that.<br><br>Altogether, the 'hesitation' is causing bad problems.<br><br>Edit:- Oh yeah... playing with the framerate_limit makes matters worse for me no matter what the figure is.<br><br>Sony Vaio VGN-FW31M.<br><br><font class="tiny">Last edited 2012</font> <br><br></td></tr></table><br>
<a name="1123051"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >therevills</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#141">[#141]</a></td></tr></table></td></tr><tr ><td class="posttext"> Yeah its not perfect, I've added it to my game and it seems acceptable as more is happening on the screen you can't really tell the little hiccups - and yes this is just to fix window mode.<br><br>This frame limiting code is meant to be a copy of the max_fps commands you find in 3D engines like source and tech3 (quake). If any one can come up with a better/smoother limiter that would be great :) <br><br></td></tr></table><br>
<a name="1124862"></a>

<a name="1124864"></a>

<a name="1124865"></a>

<a name="1124867"></a>

<a name="1124868"></a>

<a name="1124869"></a>

<a name="1124880"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >col</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#142">[#142]</a></td></tr></table></td></tr><tr ><td class="posttext"> I got taken away from this without try the Flush method for use with Dx9 windowed. This doesn't disable Aero. While it doesn't eliminate the lag completely, on my system (Sony Vaio Win7-x64 and with Vista-x86 ) it definitely improves the issue. See what you guys think...<br><br>Turn off all 'fixes' then use F4 to toggle with the Dx9 driver. EDIT: On my system this also improves the lag on the GL driver too when windowed, but it slaughters Dx7 windowed performance by halving the FPS.<br><br><textarea class=codebox name="code" wrap=OFF readonly="true" rows="15" cols="80">
SuperStrict

?win32

'AERO SPECIFIC
Global DwmapiDLL:Int = LoadLibraryA("dwmapi.dll")
Global FlushAero()
Global IsAeroEnabled(pfEnabled:Int Var)
Global EnableAero(uCompositionAction:Int)

If DwmapiDLL
	FlushAero = GetProcAddress(DwmapiDLL,"DwmFlush")
	IsAeroEnabled = GetProcAddress(DwmapiDLL,"DwmIsCompositionEnabled")
	EnableAero = GetProcAddress(DwmapiDLL,"DwmEnableComposition")
EndIf

Global AeroState%
If DwmapiDLL IsAeroEnabled(AeroState)
'END OF AERO SPECIFIC

?

Const DIRECTX7% = 0
Const DIRECTX9% = 1
Const OPENGL% = 2

Global currentDriver% = OPENGL
?MacOS
currentDriver = OPENGL
?
Global fullScreen% = 0
Global useFix% = 0
Global screenWidth% = 0
Global screenHeight% = 0
Global blockX% = 0
Global aerofix% = AeroState
Global aeroflush% = 1
Global framelimiterOn% = 0

Global fps_counter% = 0
Global update_frequency% = 5
Global fps_milli% = MilliSecs()
Global fps%

Global x#, y#
Global angle#
Global cx%, cy%
Global rad% = 100

UseDX9RenderLagFix = False

Global framerate_limit:Int = 59
Global frame_start_time:Int = MilliSecs()
Global delay_amount# = 0
' frl
Global delta!
Global deltaAmount!
Global frameRateLogic# = 100
Global ms# = 0
Global tmpMs!
Global numTicks!
Global lastNumTicks!
Global maxMs% = 50
Global lastTime!

ms = 1000 / frameRateLogic
numTicks = 0
lastNumTicks = 1
lastTime = MilliSecs()

Print ms
Print lastTime

SetDriver()
CreateScreen()

While Not KeyHit(KEY_ESCAPE)
	Test()
Wend

?Win32
If DwmapiDLL EnableAero(AeroState)
?

End

Function Test()

	Local now% = MilliSecs()
	If now &lt; lastTime
		numTicks = lastNumTicks
	Else
		tmpMs = now - lastTime
		If tmpMs &gt; maxMs Then tmpMs = maxMs
		numTicks = tmpMs / ms
	EndIf
	lastTime = now
	lastNumTicks = numTicks
	
	For Local i% = 1 To Floor(numTicks)
		Update(1)
	Next
	Local re# = numTicks Mod 1
	If re &gt; 0 Then
		Update(re)
	EndIf
	Render()

End Function

Function Render()
	Cls

	SetColor 255,255,255
	Local x%, y% = 10
	Local gap% = 15
	DrawText "Press D to change Driver (current = "+GetDriverString()+")",x,y
	y:+gap
	If useFix Then SetColor 255, 255, 0
	DrawText "Press F1 to toggle Grab Pixel Fix (current = "+useFix+")",x,y	
	SetColor 255, 255, 255
	y:+gap
	If UseDX9RenderLagFix Then SetColor 255, 255, 0
	DrawText "Press F2 to toggle DX9 Fix (current = "+UseDX9RenderLagFix+")",x,y	
	SetColor 255, 255, 255
	y:+gap
	If framelimiterOn Then SetColor 255, 255, 0
	DrawText "Press F3 to toggle Frame Limiter (current = "+framelimiterOn +")",x,y	
	SetColor 255, 255, 255
	y:+gap
	If aeroflush Then SetColor 255,255,0
	DrawText "Press F4 to toggle AeroFlush for Vista/Win7 windowed (current = "+aeroflush+")",x,y
	SetColor 255,255,255
	y:+gap
	DrawText "Press A to toggle Aero (Vista/Win7) - AeroEnabled = "+aerofix,x,y
	y:+gap
	DrawText "Press S to toggle Full Screen",x,y
	y:+gap
	DrawText "FPS:"+fps, x, y
	y:+gap
	DrawText "delay amount :"+delay_amount, x, y
	y:+gap
	DrawText "Delta:"+deltaAmount, x, y
	y:+gap
	If Not framelimiterOn Then SetColor 155, 155, 155
	DrawText "framerate_limit = "+framerate_limit+ " (Cursor Keys Up and Down to change)", x, y
	SetColor 255, 255, 255
	y:+gap
	DrawText "Press Esc to Exit",x,y	
	
	SetColor 100,100,230
	DrawRect MouseX(),MouseY(),50,50
	
	SetColor 100,230,100
	DrawRect blockX, screenHeight-100,50,50
	
	If BlockX &gt; screenWidth Then blockX:-screenWidth+50
	
	If useFix Then
		GrabPixmap(1, 1, 1, 1)
	EndIf
	
	Flip 1
	
	fps_counter=fps_counter+1
	If fps_counter=update_frequency
	     fps=1000/Float(((MilliSecs()-fps_milli))/update_frequency)
	     fps_milli=MilliSecs()
	     fps_counter=0
	EndIf
	
	?win32
	If aeroflush
		If DwmapiDLL FlushAero
	EndIf
	?
	
	If framelimiterOn
		Local one_frame_limit:Float = 1000.0/Float(framerate_limit) ' 16.666 ms 
	
		Local time_left:Float = one_frame_limit - (MilliSecs() - frame_start_time)
		delay_amount = 0
		While time_left &gt; 0
			If time_left &gt;= 6.0
				delay_amount:+Int(time_left)/6.0
				Delay(Int(time_left)/6.0)
		    Else
		        Delay(0)
		    EndIf
			time_left = one_frame_limit - (MilliSecs()-frame_start_time)
		Wend
		frame_start_time = MilliSecs() 
	Else
		delay_amount = 1
		Delay(1)
	EndIf
	
End Function

Function Update(delta#)
	deltaAmount = delta
	?win32
	If KeyHit(KEY_D) Then
		currentDriver:+1
		If currentDriver&gt;OPENGL Then currentDriver= DIRECTX7 'wrap
		SetDriver()
		CreateScreen()
	EndIf
	
	If KeyHit(KEY_F4) aeroflush = 1 - aeroflush
	If KeyHit(KEY_A)
		aerofix = 1 - aerofix
		If DwmapiDLL EnableAero(aerofix)
	EndIf
	?
	blockX:+3 * delta

	angle:+3 * delta
	
	x = cx + (Sin(angle) * rad)
	y = cy + (Cos(angle) * rad)

	If Not AppSuspended()
		MoveMouse(x, y)
	EndIf
	
	If KeyHit(KEY_S) Then
		fullScreen = Not fullScreen
		CreateScreen()
	EndIf

	If KeyHit(KEY_F1) Then
		useFix = Not useFix
		If useFix
			UseDX9RenderLagFix = False
			framelimiterOn = False
		EndIf
	EndIf
	
	If KeyHit(KEY_F2) Then
		UseDX9RenderLagFix = Not UseDX9RenderLagFix
		If UseDX9RenderLagFix
			useFix = False
			framelimiterOn = False
		EndIf
	EndIf
	
	If KeyHit(KEY_F3) Then
		framelimiterOn = Not framelimiterOn
		If framelimiterOn
			UseDX9RenderLagFix = False
			useFix= False
		EndIf
	EndIf

	If framelimiterOn
		If KeyHit(KEY_DOWN)
			framerate_limit:-1
			Delay(50)
		EndIf
		If KeyHit(KEY_UP)
			framerate_limit:+1
			Delay(50)
		EndIf
	EndIf
End Function

Function SetDriver()
	Select currentDriver
		?win32
		Case DIRECTX7
			SetGraphicsDriver D3D7Max2DDriver()
		Case DIRECTX9
			SetGraphicsDriver D3D9Max2DDriver()
		?
		Case OPENGL
			SetGraphicsDriver GLMax2DDriver()
	End Select
End Function

Function CreateScreen()
	If fullScreen Then
		screenWidth = 800
		screenHeight = 600
		Graphics screenWidth, screenHeight, 32, 60
	Else
		screenWidth = 640
		screenHeight = 480
		Graphics screenWidth, screenHeight, 0', 30
	EndIf	
	
	cx = ScreenWidth/2
	cy = ScreenHeight/2
	
End Function

Function GetDriverString$()
	Select currentDriver
		Case DIRECTX7
			Return "DirectX 7"
		Case DIRECTX9
			Return "DirectX 9"
		Case OPENGL
			Return "Open GL"
	End Select
End Function
</textarea><br><br><font class="tiny">Last edited 2012</font> <br><br></td></tr></table><br>
<a name="1124870"></a>

<a name="1124872"></a>

<a name="1124873"></a>

<a name="1124875"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >therevills</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#143">[#143]</a></td></tr></table></td></tr><tr ><td class="posttext"> Hey Dave.... so what does the Flush/DwmFlush do?<br><br><a href="http://msdn.microsoft.com/en-us/library/windows/desktop/dd389405(v=vs.85).aspx" target="_blank">http://msdn.microsoft.com/en-us/library/windows/desktop/dd389405(v=vs.85).aspx</a><br><br><div class="quote"> Issues a flush call that blocks the caller until the next present, when all of the Microsoft DirectX surface updates that are currently outstanding have been made. This compensates for very complex scenes or calling processes with very low priority. <br></div><br><br>Errrrr.... wut ?! Also why does it help OpenGL!?!?! O_o<br><br>Just tested on my main PC - looks good for DX9 and OpenGL... it kills DX7 (drops the FPS to 30, DX7 doesnt lag too much in Window mode anyway).<br><br>And I've just tested on my WinXP box... It crashes as soon as you enable "AeroFlush"...<br><br><font class="tiny">Last edited 2012</font> <br><br></td></tr></table><br>
<a name="1124876"></a>

<a name="1124887"></a>

<a name="1124889"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >col</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#144">[#144]</a></td></tr></table></td></tr><tr ><td class="posttext"> I stand to be corrected here :-) but as I understand it...<br><br>its very similar to how the same fix can work in fullscreen mode. Aero uses the GPU to accelerate the effects, so in effect it gets a similar render queue( or even becomes a part of the Dx render queue? ) The DwmFlush command forces it to render all calls in the dx render queue before carrying on. The fullscreen methods use a similar approach but use different techniques which ( as a side-effect ) force the render queue to be rendered ( emptied/flushed ). Doing this every frame reduces the lag caused by 'render ahead'.<br><br>EDIT: Although after reading the Remarks section on the MSDN link for the command, it says that it doesn't do that!! but only seems to render any changes in the queue. wtf does that supposed to mean?!?! haha. I don't know, MS eh :P<br><br><font class="tiny">Last edited 2012</font> <br><br></td></tr></table><br>
<a name="1124881"></a>

<a name="1124882"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >col</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#145">[#145]</a></td></tr></table></td></tr><tr ><td class="posttext"> Sorry about the crash :/<br><br>I've edited the code to prevent it. Line 174.<br><br>As for GL... Aero uses Dx to add a layer of 'Aero Effects' on top of the existing desktop display. I'd imagine that a window thats using GL will have just that portion of the screen using the GL context, and the rest uses Dx?<br><br><font class="tiny">Last edited 2012</font> <br><br></td></tr></table><br>
<a name="1124893"></a>

<a name="1124896"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >therevills</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#146">[#146]</a></td></tr></table></td></tr><tr ><td class="posttext"> Dont apologise!!<br><br>Thank you for keep helping!<br><br>(Also I just read that DwmFlush minimum supported client is Windows Vista, so I should have guessed it would have crashed on XP!! And of course Desktop Window Manager is only for Vista onwards...)<br><br>This fix looks good, I'll have to test it on a few more PCs - (esp. the work PC)<br><br><font class="tiny">Last edited 2012</font> <br><br></td></tr></table><br>
<a name="1124936"></a>

<a name="1124937"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >therevills</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#147">[#147]</a></td></tr></table></td></tr><tr ><td class="posttext"> So just to recap the current good "fixes":<br><br><b><u>For Fullscreen Mode</u></b><br><br><b>DirectX9</b><br><br>Occlusion Query fix<br><br>(Not Grabpixel due to poor performance on some PCs)<br><br><b>DirectX7</b><br><br>Grabpixel fix<br><br><b>OpenGL</b><br><br>Grabpixel fix<br><br><b><u>For Window Mode - Lag caused by Aero</u></b><br><br><b>DirectX9</b><br><br>DwmFlush fix (FlushAero)<br><br><b>DirectX7</b><br><br>Grabpixel fix<br><br>(Not DwmFlush due to poor performance on some PCs)<br><br><b>OpenGL</b><br><br>DwmFlush fix (FlushAero) / Grabpixel fix<br><br>---------------------------------<br><br><pre class=code>
If fullScreen Then
	If driver = DIRECTX9
		OcclusionQuery
	ElseIf driver = DIRECTX7
		GrabPixel
	ElseIf driver = OPENGL
		GrabPixel
	EndIf
Else
	If driver = DIRECTX9
		FlushAero
	ElseIf driver = DIRECTX7
		GrabPixel
	ElseIf driver = OPENGL
		FlushAero and GrabPixel
	EndIf
EndIf
</pre><br><br>Is this about right?<br><br>---------------------------------<br><br>What a mess!!! LOL<br><br><font class="tiny">Last edited 2012</font> <br><br></td></tr></table><br>
<a name="1124938"></a>

<a name="1124939"></a>

<a name="1124940"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >col</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#148">[#148]</a></td></tr></table></td></tr><tr ><td class="posttext"> Seems about right until we're told otherwise.<br><br>To keep your main code cleaner I suggest to package the lagfix up as a TLagFix type?<br>That way you could keep all the decision making 'If's and ElseIf's out of the main loop, and in the main loop simply call one function which then calls the appropriate lag fix code. I doubt this will increase the speed of the code but your working code would be a lot cleaner and easier to read.<br><br>EDIT:- Some 'working pseudo code' maybe something along the lines of...<br><br><textarea class=codebox name="code" wrap=OFF readonly="true" rows="15" cols="80">
Strict

Const DIRECTX7 = 0
Const DIRECTX9 = 1
Const OPENGL = 2

Type TLagFix
	Field Driver:Int
	Field FullScreen:Int
	
	Field FixFunc() 'Called during the main loop via the Run method.
	
	Method SetDriverAndMode(_Driver:Int,_FullScreen:Int)
		Driver = _Driver
		FullScreen = _FullScreen
		
		Select Driver
			Case DIRECTX7
				FixFunc = DX7FixFunc 'Both windowed and fullscreen use the same _FixFunc
			
			Case DIRECTX9
				If FullScreen
					FixFunc = DX9FullScrFunc
				Else
					FixFunc = DX9WindowFunc
				EndIf
			
			Case OPENGL
				If FullScreen
					FixFunc = OpenGLFullScrFunc
				Else
					FixFunc = OpenGLWindowFunc
				EndIf
		EndSelect
	EndMethod
		
	Method Run()
		FixFunc
	EndMethod
	
	Function DX7FixFunc()
		'Do GrabPixel
		DebugLog"DX7 Windowed and Fullscreen"
	EndFunction
	
	Function DX9WindowFunc()
		'Do FlushAero
		DebugLog"DX9 Windowed"
	EndFunction
	
	Function DX9FullScrFunc()
		'Do OcclussionQuery
		DebugLog"DX9 FullScreen"
	EndFunction
	
	Function OpenGLWindowFunc()
		'Do GrabPixel 'or FlushAero
		DebugLog"OpenGL Windowed"
	EndFunction
	
	Function OpenGLFullScrFunc()
		'Do GrabPixel
		DebugLog "OpenGL Fullscreen"
	EndFunction		
EndType


'Set up code...
Local LagFix:TLagFix = New TLagFix
LagFix.SetDriverAndMode(OPENGL,False)	'True for fullscreen

'In the main loop...
LagFix.Run
</textarea><br><br><font class="tiny">Last edited 2012</font> <br><br></td></tr></table><br>
<a name="1125116"></a>

<a name="1125117"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >therevills</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#149">[#149]</a></td></tr></table></td></tr><tr ><td class="posttext"> Yep that sounds like a good idea :)<br><br>I've just tested the FlushAero on my work pc and it looks good, now the lag is small when Aero is enabled.<br><br><b>Window Mode (Aero Enabled)</b><br><br>Without Flush Aero:<br><br>DirectX11 - <b>Huge</b> lag - 62FPS<br>OpenGL - Small lag - 62FPS<br>DirectX7 - Small lag - 62FPS<br>DirectX9 - <b>Huge</b> lag - 62FPS<br><br>With Flush Aero:<br><br>DirectX11 - Small lag - 62FPS<br>OpenGL - Small lag - 62FPS<br>DirectX7 - Small lag - <b>30FPS</b><br>DirectX9 - Small lag - 62FPS<br><br>(I've recently added Col's DirectX11 driver to my BlitzMax setup ;))<br><br><font class="tiny">Last edited 2012</font> <br><br></td></tr></table><br>
<a name="1125320"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Grey Alien</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#150">[#150]</a></td></tr></table></td></tr><tr ><td class="posttext"> Interesting research and fixes guys!  Good stuff.  Yeah so when BMax supports DX11 by default I guess we'll have to go through all this stuff again!!  <br><br>So am I correct that it's only safe to call FlushAero on Vista and above?  Do we have to check it's not XP or lower ourselves or will it simply do nothing on XP? <br><br></td></tr></table><br>
<a name="1125327"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >therevills</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#151">[#151]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> Yeah so when BMax supports DX11 by default I guess we'll have to go through all this stuff again!!  <br></div><br><br>Maybe.... but with the testing I've done, I think the OcclusionQuery Fix will work for it fine.<br><br>I'm thinking we will do this all again when Windows 8 is released! ;)<br><br><div class="quote"> FlushAero on Vista and above? Do we have to check it's not XP or lower ourselves or will it simply do nothing on XP? <br></div><br><br>Yep FlushAreo is only safe on Vista and 7. The IF statement: "If DwmapiDLL" will return false on an XP machine so it doesnt run the FlushAero command. <br><br></td></tr></table><br>
<a name="1125464"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Grey Alien</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#152">[#152]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> I'm thinking we will do this all again when Windows 8 is released! ;) <br></div>Agreed and possibly other framework updates as eventually the portals will demand compliance as part of their QA tests.<br><br>Thanks for the info about FlushAero. <br><br></td></tr></table><br>
<a name="1125480"></a>

<a name="1125542"></a>

<a name="1125544"></a>

<a name="1125546"></a>

<a name="1125547"></a>

<a name="1125549"></a>

<a name="1125582"></a>

<a name="1125659"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >col</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#153">[#153]</a></td></tr></table></td></tr><tr ><td class="posttext"> Hiya,<br><br>Yesterday, I found a bug in the D3D11 driver that only occurs in fullscreen mode. When exiting from the driver and then trying to use another Dx driver ( as in the example in post 142 ), it would a crash with an EAV. Funny thing is that if it went back to windowed mode then it will still crash, but ONLY if you went into fullscreen mode at some point! Starting and staying in windowed mode didn't cause any problems. I love those!!<br><br>EDIT:- <br><br>After messing around with GitHub for an hour, I think I've uploaded it correctly :P<br><a href="https://github.com/SRSSoftware/d3d11max2d.mod" target="_blank">https://github.com/SRSSoftware/d3d11max2d.mod</a><br><br>EDIT:- The latest update includes the render lag fix for windowed and fullscreen modes.<br><br><font class="tiny">Last edited 2012</font> <br><br></td></tr></table><br>
<a name="1125660"></a>

<a name="1125670"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >col</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#154">[#154]</a></td></tr></table></td></tr><tr ><td class="posttext"> ...<br><br><font class="tiny">Last edited 2012</font> <br><br></td></tr></table><br>
<a name="1125600"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >therevills</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#155">[#155]</a></td></tr></table></td></tr><tr ><td class="posttext"> Cool! Thanks Dave!<br><br>I notice that the DX9 query is quite different to the DX11 query... <br><br></td></tr></table><br>
<a name="1125615"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >col</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#156">[#156]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> I notice that the DX9 query is quite different to the DX11 query... <br></div><br><br>Yep, both Dx10 and Dx11 apis are completely different to Dx9, and require a different approach to what's been used in all previous Dx versions.<br><br>You may have noticed some extra ( interesting? ) files in the d3d11max2d/ folder too that aren't yet finished ;-) <br><br></td></tr></table><br>
<a name="1142727"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >therevills</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#157">[#157]</a></td></tr></table></td></tr><tr ><td class="posttext"> There might be an issue with the DirectX9 OcclusionQuery stuff... I've just got a bug report from Big Fish Games:<br><br><div class="quote"> "The game crashes when resuming from sleep mode while in fullscreen mode (does not happen while in windowed mode). " <br></div><br><br>That's the only information I have and I can't test right now, but my guess is that the OcclusionQuery is causing the issue... <br><br></td></tr></table><br>
<a name="1142763"></a>

<a name="1142765"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >therevills</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#158">[#158]</a></td></tr></table></td></tr><tr ><td class="posttext"> Just testing now and it displays "_d3dDev.Reset failed" when returning from sleep mode...<br><br>[edit]Nope its not the OcclusionQuery stuff as I've just installed a fresh copy of BlitzMax and it does it on that too :(<br><br><font class="tiny">Last edited 2012</font> <br><br></td></tr></table><br>
<a name="1142782"></a>

<a name="1142783"></a>

<a name="1142785"></a>

<a name="1142795"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >col</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#159">[#159]</a></td></tr></table></td></tr><tr ><td class="posttext"> Ive been testing too, using the vanilla setup without occlusion queries. Its failing before it actually powers down going into sleep mode, and then of course after waking it won't recover.<br><br>Try commenting out the Throw "_d3dDev.Reset failed" and see if it works successfully. It works for me . I'm looking into it though. Might have something to do the WM_SIZE, not sure yet - it seems to have something to do with the fullscreen losing focus and max2d bailng out.<br><br><font class="tiny">Last edited 2012</font> <br><br></td></tr></table><br>
<a name="1142789"></a>

<a name="1142794"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >col</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#160">[#160]</a></td></tr></table></td></tr><tr ><td class="posttext"> Anyone else not using Win7 having this issue?<br><br>To replicate, you can use any code that puts D3D9 into fullscreen mode, while in fullscreen, put the pc into sleep mode, then wake it up again.<br><br>EDIT:-<br>Can you ask them for the system spec they were using, os and gpu?<br><br>If it turns out it Vista/Win7 we can use the D3D9Ex interfaces that dont suffer from lost devices.<br><br><font class="tiny">Last edited 2012</font> <br><br></td></tr></table><br>
<a name="1159945"></a>

<a name="1159946"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Grey Alien</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#161">[#161]</a></td></tr></table></td></tr><tr ><td class="posttext"> @col and @therevills<br><br>Just revisiting this thread as I never fully implemented the OcclusionQuery fix.  Now I come to look at d3d9graphics Flip() and it doesn't look the same due to the DX9 sleep/restore fix mentioned here ( <a href="http://www.blitzbasic.com/Community/posts.php?topic=96638" target="_blank">http://www.blitzbasic.com/Community/posts.php?topic=96638</a> ).  I'm using BMax 1.48.  So how should I add in the OcclusionQuery code safely to the new Flip() method? Thx!<br><br>Also @therevills I read your recap on comment #147 and thought I'd better point out that GrabPixel fix isn't needed for DX7 as it makes no difference.  DX7 is always fine.  So the options look like this:<br><br><pre class=code>
If fullScreen Then
	If driver = DIRECTX9
		OcclusionQuery
	ElseIf driver = DIRECTX7
		Nothing
	ElseIf driver = OPENGL
		GrabPixel
	EndIf
Else
	If driver = DIRECTX9
		FlushAero
	ElseIf driver = DIRECTX7
		Nothing
	ElseIf driver = OPENGL
		FlushAero
	EndIf
EndIf
</pre><br><br><font class="tiny">Last edited 2012</font> <br><br></td></tr></table><br>
<a name="1160007"></a>

<a name="1160010"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >therevills</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#162">[#162]</a></td></tr></table></td></tr><tr ><td class="posttext"> Jake I had a PC at work where you could see the lag using DX7 and the GrabPixel helped.<br><br>I havent upgraded to 1.48 yet. But here are the changes in my 1.44b files, just beware that there are two flip methods in d3d9graphics:<br><br><b>d3d9graphics.bmx</b><br><textarea class=codebox name="code" wrap=OFF readonly="true" rows="15" cols="80">
Function OpenD3DDevice( hwnd,width,height,depth,hertz,flags )

	If _d3dDevRefs
		If Not _presentParams.Windowed Return False
		If depth&lt;&gt;0 Return False
		_d3dDevRefs:+1
		Return True
	EndIf

	Local windowed=(depth=0)
	Local fullscreen=(depth&lt;&gt;0)	

	Local pp:D3DPRESENT_PARAMETERS=New D3DPRESENT_PARAMETERS
	pp.BackBufferWidth=width
	pp.BackBufferHeight=height
	pp.BackBufferCount=1
	pp.BackBufferFormat=(D3DFMT_X8R8G8B8 * fullscreen) + (D3DFMT_UNKNOWN * windowed)
	pp.MultiSampleType=D3DMULTISAMPLE_NONE
	pp.SwapEffect=(D3DSWAPEFFECT_DISCARD * fullscreen) + (D3DSWAPEFFECT_COPY * windowed)
	pp.hDeviceWindow=hwnd
	pp.Windowed=windowed
	pp.Flags=D3DPRESENTFLAG_LOCKABLE_BACKBUFFER
	pp.FullScreen_RefreshRateInHz=(hertz * fullscreen)
	pp.PresentationInterval=D3DPRESENT_INTERVAL_ONE	'IMMEDIATE
	
	Local cflags=D3DCREATE_FPU_PRESERVE
	
	'OK, try hardware vertex processing...
	Local tflags=D3DCREATE_PUREDEVICE|D3DCREATE_HARDWARE_VERTEXPROCESSING|cflags
	If _d3d.CreateDevice( 0,D3DDEVTYPE_HAL,hwnd,tflags,pp,_d3dDev )&lt;0

		'Failed! Try mixed vertex processing...
		tflags=D3DCREATE_MIXED_VERTEXPROCESSING|cflags
		If _d3d.CreateDevice( 0,D3DDEVTYPE_HAL,hwnd,tflags,pp,_d3dDev )&lt;0
	
			'Failed! Try software vertex processing...	
			tflags=D3DCREATE_SOFTWARE_VERTEXPROCESSING|cflags
			If _d3d.CreateDevice( 0,D3DDEVTYPE_HAL,hwnd,tflags,pp,_d3dDev )&lt;0
			
				'Failed! Go home and watch family guy instead...
				Return False
			EndIf
		EndIf
	EndIf

	_presentParams=pp

	_d3dDevRefs:+1
	
	_autoRelease=New TList
	
	
	'Occlusion Query - Added by Col 13.01.2012
	If Not _d3dOccQuery
		If _d3ddev.CreateQuery(9,_d3dOccQuery)&lt;0 '9 hardcoded for D3DQUERYTYPE_OCCLUSION
			DebugLog "Cannot create Occlussion Query!"
		EndIf
	EndIf
	If _d3dOccQuery _d3dOccQuery.Issue(2) 'D3DISSUE_BEGIN
	

	
	Return True
End Function

Function CloseD3DDevice()
	_d3dDevRefs:-1
	If Not _d3dDevRefs

		For Local t:TD3D9AutoRelease=EachIn _autoRelease
			t.unk.Release_
		Next
		_autoRelease=Null
		
		If _d3dOccQuery _d3dOccQuery.Release_	'Added by Col 13.01.2012
		_d3dOccQuery = Null 					'Added by Col 13.01.2012
		
		_d3dDev.Release_
		_d3dDev=Null
		_presentParams=Null
	EndIf
End Function

Function ResetD3DDevice()
	If _d3dOccQuery _d3dOccQuery.Release_ 'Added by Col 13.01.2012

'	If _d3dDev.Reset( _presentParams )&lt;0
'		Throw "_d3dDev.Reset failed"
'	EndIf
	_d3dDev.Reset( _presentParams ) ' Added by Steve
		
	'Added by Col 13.01.2012
	If _d3ddev.CreateQuery(9,_d3dOccQuery)&lt;0
		DebugLog "Cannot create Occlussion Query!"
	EndIf
	If _d3dOccQuery _d3dOccQuery.Issue(2) 'D3DISSUE_BEGIN

End Function
</textarea><br><br><textarea class=codebox name="code" wrap=OFF readonly="true" rows="15" cols="80">	'NOTE: Returns 1 if flip was successful, otherwise device lost or reset...
	Method Flip( sync )
	
		Local reset

		If sync sync=D3DPRESENT_INTERVAL_ONE Else sync=D3DPRESENT_INTERVAL_IMMEDIATE
		If sync&lt;&gt;_presentParams.PresentationInterval
			_presentParams.PresentationInterval=sync
			reset=True
		EndIf
		
		Select _d3dDev.TestCooperativeLevel()
		Case D3DERR_DRIVERINTERNALERROR ' added by Col
			Throw "D3D Internal Error"

		Case D3D_OK
			If reset

				ResetD3DDevice

			Else If _attached
			
				Local rect[]=[0,0,_width,_height]
				Return _d3dDev.Present( rect,rect,_hwnd,Null )&gt;=0

			Else

				Return _d3dDev.Present( Null,Null,_hwnd,Null )&gt;=0

			EndIf
		Case D3DERR_DEVICENOTRESET

			ResetD3DDevice

		End Select
		
		
	End Method
</textarea><br><br><textarea class=codebox name="code" wrap=OFF readonly="true" rows="15" cols="80">Type TD3D9GraphicsDriver Extends TGraphicsDriver

	Method Create:TD3D9GraphicsDriver()
		'create d3d9
		If Not d3d9Lib Return Null      '&lt;-------ADDED

		_d3d=Direct3DCreate9( 32 )
		If Not _d3d Return Null
		
		'get caps
		_d3dCaps=New D3DCAPS9
		If _d3d.GetDeviceCaps( D3DADAPTER_DEFAULT,D3DDEVTYPE_HAL,_d3dCaps )&lt;0
			_d3d.Release_
			_d3d=Null
			Return Null
		EndIf

		'enum graphics modes		
		Local n=_d3d.GetAdapterModeCount( D3DADAPTER_DEFAULT,D3DFMT_X8R8G8B8 )
		_modes=New TGraphicsMode[n]
		Local j
		For Local i=0 Until n
			Local d3dmode:D3DDISPLAYMODE=New D3DDISPLAYMODE

			If _d3d.EnumAdapterModes( D3DADAPTER_DEFAULT,D3DFMT_X8R8G8B8,i,d3dmode )&lt;0
				Continue
			EndIf
			
			Local mode:TGraphicsMode=New TGraphicsMode
			mode.width=d3dmode.Width
			mode.height=d3dmode.Height
			mode.hertz=d3dmode.RefreshRate
			mode.depth=32
			
			_modes[j]=mode
			j:+1
		Next
		_modes=_modes[..j]
	
		'register wndclass
		Local wndclass:WNDCLASSW=New WNDCLASSW
		wndclass.hInstance=GetModuleHandleW( Null )
		wndclass.lpfnWndProc=D3D9WndProc
		wndclass.hCursor=LoadCursorW( Null,Short Ptr IDC_ARROW )
		wndclass.lpszClassName=_wndClass.ToWString()
		RegisterClassW wndclass
		MemFree wndclass.lpszClassName

		Return Self
	End Method
	
	Method Graphics:TD3D9Graphics()
		Return _graphics
	End Method
</textarea><br><br><textarea class=codebox name="code" wrap=OFF readonly="true" rows="15" cols="80">
	Method Flip( sync )
		Local present = _graphics.Flip(sync)
		If UseDX9RenderLagFix Then
			Local pixelsdrawn
			If _d3dOccQuery
				_d3dOccQuery.Issue(1) 'D3DISSUE_END
				
				While _d3dOccQuery.GetData( Varptr pixelsdrawn,4,1 )=1 'D3DGETDATA_FLUSH
					If  _d3dOccQuery.GetData( Varptr pixelsdrawn,4,1 )&lt;0 Exit
				Wend

				_d3dOccQuery.Issue(2) 'D3DISSUE_BEGIN
			EndIf
			'Can read back pixelsdrawn if really wanted :P
		End If
		
		Return present
	End Method
</textarea><br><br><b>graphics.bmx</b><br>Added boolean just before BumpGraphicsSeq function:<br><pre class=code>Global UseDX9RenderLagFix% = 0 ' new boolean</pre><br><br>I think thats it...<br><br><font class="tiny">Last edited 2012</font> <br><br></td></tr></table><br>
<a name="1160023"></a>

<a name="1160033"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >therevills</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#163">[#163]</a></td></tr></table></td></tr><tr ><td class="posttext"> Just looked at the d3d9graphics.bmx in v1.48 and merged it my version:<br><br><textarea class=codebox name="code" wrap=OFF readonly="true" rows="15" cols="80">
Strict

Import BRL.Graphics

Import Pub.DirectX

Import BRL.LinkedList


Private

Global _wndClass$="BBDX9Device Window Class"

Global _driver:TD3D9graphicsDriver

Global _d3d:IDirect3D9
Global _d3dCaps:D3DCAPS9
Global _modes:TGraphicsMode[]

Global _d3dOccQuery:IDirect3DQuery9 'Added by Col 13.01.2012


Global _d3dDev:IDirect3DDevice9
Global _d3dDevRefs

Global _presentParams:D3DPRESENT_PARAMETERS

Global _graphics:TD3D9Graphics

Global _autoRelease:TList

Type TD3D9AutoRelease
	Field unk:IUnknown
End Type

Function D3D9WndProc( hwnd,msg,wp,lp ) "win32"

	bbSystemEmitOSEvent hwnd,msg,wp,lp,Null
	
	Select msg
	Case WM_CLOSE
		Return
	Case WM_SYSKEYDOWN
		If wp&lt;&gt;KEY_F4 Return
	End Select

	Return DefWindowProcW( hwnd,msg,wp,lp )

End Function

Function OpenD3DDevice( hwnd,width,height,depth,hertz,flags )

	If _d3dDevRefs
		If Not _presentParams.Windowed Return False
		If depth&lt;&gt;0 Return False
		_d3dDevRefs:+1
		Return True
	EndIf

	Local windowed=(depth=0)
	Local fullscreen=(depth&lt;&gt;0)	

	Local pp:D3DPRESENT_PARAMETERS=New D3DPRESENT_PARAMETERS
	pp.BackBufferWidth=width
	pp.BackBufferHeight=height
	pp.BackBufferCount=1
	pp.BackBufferFormat=(D3DFMT_X8R8G8B8 * fullscreen) + (D3DFMT_UNKNOWN * windowed)
	pp.MultiSampleType=D3DMULTISAMPLE_NONE
	pp.SwapEffect=(D3DSWAPEFFECT_DISCARD * fullscreen) + (D3DSWAPEFFECT_COPY * windowed)
	pp.hDeviceWindow=hwnd
	pp.Windowed=windowed
	pp.Flags=D3DPRESENTFLAG_LOCKABLE_BACKBUFFER
	pp.FullScreen_RefreshRateInHz=(hertz * fullscreen)
	pp.PresentationInterval=D3DPRESENT_INTERVAL_ONE	'IMMEDIATE
	
	Local cflags=D3DCREATE_FPU_PRESERVE
	
	'OK, try hardware vertex processing...
	Local tflags=D3DCREATE_PUREDEVICE|D3DCREATE_HARDWARE_VERTEXPROCESSING|cflags
	If _d3d.CreateDevice( 0,D3DDEVTYPE_HAL,hwnd,tflags,pp,_d3dDev )&lt;0

		'Failed! Try mixed vertex processing...
		tflags=D3DCREATE_MIXED_VERTEXPROCESSING|cflags
		If _d3d.CreateDevice( 0,D3DDEVTYPE_HAL,hwnd,tflags,pp,_d3dDev )&lt;0
	
			'Failed! Try software vertex processing...	
			tflags=D3DCREATE_SOFTWARE_VERTEXPROCESSING|cflags
			If _d3d.CreateDevice( 0,D3DDEVTYPE_HAL,hwnd,tflags,pp,_d3dDev )&lt;0
			
				'Failed! Go home and watch family guy instead...
				Return False
			EndIf
		EndIf
	EndIf

	_presentParams=pp

	_d3dDevRefs:+1
	
	_autoRelease=New TList
	
	
	'Occlusion Query - Added by Col 13.01.2012
	If Not _d3dOccQuery
		If _d3ddev.CreateQuery(9,_d3dOccQuery)&lt;0 '9 hardcoded for D3DQUERYTYPE_OCCLUSION
			DebugLog "Cannot create Occlussion Query!"
		EndIf
	EndIf
	If _d3dOccQuery _d3dOccQuery.Issue(2) 'D3DISSUE_BEGIN
	

	
	Return True
End Function

Function CloseD3DDevice()
	_d3dDevRefs:-1
	If Not _d3dDevRefs

		For Local t:TD3D9AutoRelease=EachIn _autoRelease
			t.unk.Release_
		Next
		_autoRelease=Null
		
		If _d3dOccQuery _d3dOccQuery.Release_	'Added by Col 13.01.2012
		_d3dOccQuery = Null 					'Added by Col 13.01.2012
		
		_d3dDev.Release_
		_d3dDev=Null
		_presentParams=Null
	EndIf
End Function

Function ResetD3DDevice()
	If _d3dOccQuery _d3dOccQuery.Release_ 'Added by Col 13.01.2012

'	If _d3dDev.Reset( _presentParams )&lt;0
'		Throw "_d3dDev.Reset failed"
'	EndIf
	_d3dDev.Reset( _presentParams ) ' Added by Steve
		
	'Added by Col 13.01.2012
	If _d3ddev.CreateQuery(9,_d3dOccQuery)&lt;0
		DebugLog "Cannot create Occlussion Query!"
	EndIf
	If _d3dOccQuery _d3dOccQuery.Issue(2) 'D3DISSUE_BEGIN

End Function

Public

Type TD3D9Graphics Extends TGraphics

	Method Attach:TD3D9Graphics( hwnd,flags )
		Local rect[4]
		GetClientRect hwnd,rect
		Local width=rect[2]-rect[0]
		Local height=rect[3]-rect[1]

		OpenD3DDevice hwnd,width,height,0,0,flags
		
		_hwnd=hwnd
		_width=width
		_height=height
		_flags=flags
		_attached=True
		Return Self
	End Method
	
	Method Create:TD3D9Graphics( width,height,depth,hertz,flags )
		Local wstyle

		If depth
			wstyle=WS_VISIBLE|WS_POPUP
		Else
			wstyle=WS_VISIBLE|WS_CAPTION|WS_SYSMENU|WS_MINIMIZEBOX
		EndIf
		
		Local rect[4]

		If Not depth
			Local desktopRect[4]
			GetWindowRect GetDesktopWindow(),desktopRect
				
			rect[0]=desktopRect[2]/2-width/2;		
			rect[1]=desktopRect[3]/2-height/2;		
			rect[2]=rect[0]+width;
			rect[3]=rect[1]+height;
				
			AdjustWindowRect rect,wstyle,0
		EndIf

		Local hwnd=CreateWindowExW( 0,_wndClass,AppTitle,wstyle,rect[0],rect[1],rect[2]-rect[0],rect[3]-rect[1],0,0,GetModuleHandleA(Null),Null )
		If Not hwnd Return Null

		If Not depth
			GetClientRect hwnd,rect
			width=rect[2]-rect[0]
			height=rect[3]-rect[1]
		EndIf
		
		If Not OpenD3DDevice( hwnd,width,height,depth,hertz,flags )
			DestroyWindow hwnd
			Return Null
		EndIf
		
		_hwnd=hwnd
		_width=width
		_height=height
		_depth=depth
		_hertz=hertz
		_flags=flags
		
		Return Self
	End Method
	
	Method GetDirect3DDevice:IDirect3DDevice9()
		Return _d3dDev
	End Method

	Method ValidateSize()
		If _attached
			Local rect[4]
			GetClientRect _hwnd,rect
			_width=rect[2]-rect[0]
			_height=rect[3]-rect[1]
			If _width&gt;_presentParams.BackBufferWidth Or _height&gt;_presentParams.BackBufferHeight
				_presentParams.BackBufferWidth=Max( _width,_presentParams.BackBufferWidth )
				_presentParams.BackBufferHeight=Max( _height,_presentParams.BackbufferHeight )
				ResetD3DDevice
			EndIf
		EndIf
	End Method
	
	'NOTE: Returns 1 if flip was successful, otherwise device lost or reset...
	Method Flip( sync )
	
		Local reset

		If sync sync=D3DPRESENT_INTERVAL_ONE Else sync=D3DPRESENT_INTERVAL_IMMEDIATE
		If sync&lt;&gt;_presentParams.PresentationInterval
			_presentParams.PresentationInterval=sync
			reset=True
		EndIf
		
		Select _d3dDev.TestCooperativeLevel()
		Case D3DERR_DRIVERINTERNALERROR ' added by Col
			Throw "D3D Internal Error"

		Case D3D_OK
			If reset

				ResetD3DDevice

			Else If _attached
			
				Local rect[]=[0,0,_width,_height]
				Return _d3dDev.Present( rect,rect,_hwnd,Null )&gt;=0

			Else

				Return _d3dDev.Present( Null,Null,_hwnd,Null )&gt;=0

			EndIf
		Case D3DERR_DEVICENOTRESET

			ResetD3DDevice

		End Select
		
		
	End Method

	Method Driver:TGraphicsDriver()
		Return _driver
	End Method
	
	Method GetSettings( width Var,height Var,depth Var,hertz Var,flags Var )
		'
		ValidateSize
		'
		width=_width
		height=_height
		depth=_depth
		hertz=_hertz
		flags=_flags
	End Method

	Method Close()
		If Not _hwnd Return
		CloseD3DDevice
		If Not _attached DestroyWindow( _hwnd )
		_hwnd=0
	End Method

	Method AutoRelease( unk:IUnknown )
		Local t:TD3D9AutoRelease=New TD3D9AutoRelease
		t.unk=unk
		_autoRelease.AddLast t
	End Method
	
	Method ReleaseNow( unk:IUnknown )
		For Local t:TD3D9AutoRelease=EachIn _autoRelease
			If t.unk=unk
				unk.Release_
				_autoRelease.Remove t
				Return
			EndIf
		Next
	End Method

	
	Field _hwnd
	Field _width
	Field _height
	Field _depth
	Field _hertz
	Field _flags
	Field _attached

End Type

Type TD3D9GraphicsDriver Extends TGraphicsDriver

	Method Create:TD3D9GraphicsDriver()
		'create d3d9
		If Not d3d9Lib Return Null      '&lt;-------ADDED

		_d3d=Direct3DCreate9( 32 )
		If Not _d3d Return Null
		
		'get caps
		_d3dCaps=New D3DCAPS9
		If _d3d.GetDeviceCaps( D3DADAPTER_DEFAULT,D3DDEVTYPE_HAL,_d3dCaps )&lt;0
			_d3d.Release_
			_d3d=Null
			Return Null
		EndIf

		'enum graphics modes		
		Local n=_d3d.GetAdapterModeCount( D3DADAPTER_DEFAULT,D3DFMT_X8R8G8B8 )
		_modes=New TGraphicsMode[n]
		Local j
		For Local i=0 Until n
			Local d3dmode:D3DDISPLAYMODE=New D3DDISPLAYMODE

			If _d3d.EnumAdapterModes( D3DADAPTER_DEFAULT,D3DFMT_X8R8G8B8,i,d3dmode )&lt;0
				Continue
			EndIf
			
			Local mode:TGraphicsMode=New TGraphicsMode
			mode.width=d3dmode.Width
			mode.height=d3dmode.Height
			mode.hertz=d3dmode.RefreshRate
			mode.depth=32
			
			_modes[j]=mode
			j:+1
		Next
		_modes=_modes[..j]
	
		'register wndclass
		Local wndclass:WNDCLASSW=New WNDCLASSW
		wndclass.hInstance=GetModuleHandleW( Null )
		wndclass.lpfnWndProc=D3D9WndProc
		wndclass.hCursor=LoadCursorW( Null,Short Ptr IDC_ARROW )
		wndclass.lpszClassName=_wndClass.ToWString()
		RegisterClassW wndclass
		MemFree wndclass.lpszClassName

		Return Self
	End Method
	
	Method Graphics:TD3D9Graphics()
		Return _graphics
	End Method
	
	Method GraphicsModes:TGraphicsMode[]()
		Return _modes
	End Method
	
	Method AttachGraphics:TD3D9Graphics( widget,flags )
		Return New TD3D9Graphics.Attach( widget,flags )
	End Method
	
	Method CreateGraphics:TD3D9Graphics( width,height,depth,hertz,flags )
		Return New TD3D9Graphics.Create( width,height,depth,hertz,flags )
	End Method
	
	Method SetGraphics( g:TGraphics )
		_graphics=TD3D9Graphics( g )
	End Method
	
	Method Flip( sync )
		Local present = _graphics.Flip(sync)
		If UseDX9RenderLagFix Then
			Local pixelsdrawn
			If _d3dOccQuery
				_d3dOccQuery.Issue(1) 'D3DISSUE_END
				
				While _d3dOccQuery.GetData( Varptr pixelsdrawn,4,1 )=1 'D3DGETDATA_FLUSH
					If  _d3dOccQuery.GetData( Varptr pixelsdrawn,4,1 )&lt;0 Exit
				Wend

				_d3dOccQuery.Issue(2) 'D3DISSUE_BEGIN
			EndIf
			'Can read back pixelsdrawn if really wanted :P
		End If
		
		Return present
	End Method


	
	Method GetDirect3D:IDirect3D9()
		Return _d3d
	End Method
	
End Type

Function D3D9GraphicsDriver:TD3D9GraphicsDriver()
	Global _done
	If Not _done
		_driver=New TD3D9GraphicsDriver.Create()
		_done=True
	EndIf
	Return _driver
End Function</textarea><br><br>You should just be able to copy the above and overwrite the file... and just add the new boolean in graphics.bmx.<br><br>(The above code contains the lag fixes and the sleep crash fix)<br><br><font class="tiny">Last edited 2012</font> <br><br></td></tr></table><br>
<a name="1160066"></a>

<a name="1160067"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Grey Alien</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#164">[#164]</a></td></tr></table></td></tr><tr ><td class="posttext"> Re: DX7 lag, I went through the whole thread looking for any evidence of grabpixel improving (or worsening) DX7 and there doesn't seem to be any.<br><br>You even posted this about your work PC:<br><br><pre class=code>
DX7 Window: Slight lag - 62FPS
DX7 Window with Grab Pixel Fix: Slight lag - 62FPS
DX7 Full Screen: Slight lag - 62FPS
DX7 Full Screen with Grab Pixel Fix: Slight lag - 62FPS
</pre><br><br>Which infers no change right?  You can see why I'm confused :-)<br><br><font class="tiny">Last edited 2012</font> <br><br></td></tr></table><br>
<a name="1160068"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Grey Alien</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#165">[#165]</a></td></tr></table></td></tr><tr ><td class="posttext"> Anyway thanks for the merge!  I didn't realise the OcclusionQuery went in the second flip in the file which is where I was getting confused :-) <br><br></td></tr></table><br>
<a name="1160156"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >therevills</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#166">[#166]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote">  You can see why I'm confused :-) <br></div><br><br>Yeah, totally ;) I've got a spread sheet somewhere which details a bunch of tests I did at the time and one of the results showed the grabpixel fix helped a DX7 machine.<br><br>I think we can pretty safe these days to drop DX7 anyway.<br><br><div class="quote"> Anyway thanks for the merge! <br></div><br>No problem...<br><br>You seem like you are working on something again Jake... any clues? ;) <br><br></td></tr></table><br>
<a name="1160170"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Grey Alien</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#167">[#167]</a></td></tr></table></td></tr><tr ><td class="posttext"> Cool, well I'll take your word for it that DX7 needs the grab pixel fix but I might leave it out of my version simply because back in the day BRL added a pretty good lag fix for DX7 (it used to be bad) and I don't want to overload it with a second fix.  I'm just being paranoid :-)<br><br>Well mainly I've been fixing up my framework with stuff that was well overdue like finishing off the lag test stuff, fixing some DX alt+tab crashes, adding in widescreen support etc. Plus looking into Windows 8 and Gatekeeper on Mountain Lion to figure out what kind of code-signing I have to do to stay up to date.  This is all so I can put updated games on my site and send them to portals to make sure that the epic long tail of my games can continue a bit longer.  I don't want these games to die prematurely due to having out of date tech as the OSes move forward.<br><br>All that of course puts me in a good position to make a new casual game, and really I need to do that ASAP to bring in some money as moving back from Canada was expensive, and I have some great ideas ready to roll.  However, for a short while I'm going to do lots of monkey stuff, more "indie"-style games, so I can relive my teenage years and see if I can make anything of it. If it goes well I'll continue and leave casual behind, if not, I'll be back on casual until I have more money to do more indie stuff again.  Now is the golden age of indie and I want to be part of it.<br><br>There you go, hope that wasn't TL:DR. <br><br></td></tr></table><br>
<a name="bottom"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td align="right"><a href="http://monkeycoder.co.nz" target="_blank"><img src="/img/monkey2.svg" ></a> <a href="https://github.com/blitz-research" target="_blank"><img src="/img/github.svg" ></a> <a href="https://discord.gg/qJccbSp" target="_blank"><img src="/img/discord.svg" ></a></td></tr></table><br></div><br><table width="100%"><tr><td></body></html lang="en">
