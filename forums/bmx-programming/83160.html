<!DOCTYPE html><html lang="en" ><head ><title >Severe memory leak with OpenAL sound driver</title><meta name='viewport' content='width=device-width, initial-scale=0.66'><meta name='description' content='language:basic, target:desktop, category:game development'><link rel="styleSheet" href="../skins/granite/style.css" type="text/css"><style type="text/css">div.bbcode {padding: 8px;background: #E5E5E5;color: #000000;border: 1px dashed #B4B4BE;}</style></head><body ><table width=100% cellspacing=0 cellpadding=0><tr ><td class="menubarleft"></td><td class="menubar"><table cellspacing="0" cellpadding="0"><tr ><td >&nbsp;</td><td class="menuitemleft"></td><td class="menuitem"><a href="/" class="menuitem">News</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/forums.php" class="menuitem">Forums</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/codearcs.php" class="menuitem">Code</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/logs.php" class="menuitem">Logs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/gallery.php" class="menuitem">Gallery</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/sdkspecs.php" class="menuitem">Specs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/search.php" class="menuitem">Search</a></td><td class="menuitemright"></td></tr></table></td><td class="menubarright"></td></tr></table><div class="main"><h1 >Severe memory leak with OpenAL sound driver</h1><a href="forums.php" >BlitzMax Forums</a>/<a href="topics.php?forum=102" >BlitzMax Programming</a>/<a href="#bottom" >Severe memory leak with OpenAL sound driver</a><br><br>
<a name="938508"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Grey Alien</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#1">[#1]</a></td></tr></table></td></tr><tr ><td class="posttext"> OK there is definitely a memory leak with the OpenAL sound driver.<br><br>[EDIT] Test Code here: <a href="http://www.blitzbasic.com/Community/posts.php?topic=83229" target="_blank">http://www.blitzbasic.com/Community/posts.php?topic=83229</a><br><br>I'm using OpenAL in Vista and FreeAudio in XP.  I noticed that with my game on Vista the app memory consumption was going up FAST in Task Manager when I changed screens, but the GC memory level was stable. Note that the different screens play different music.<br><br><br>I tested the game on XP with Freeaudio and Task Manager and GC are stable.  I used OpenAL on XP and Task Manager memory consumption shot up (about 4Mb every screen change due to size of music files) and GC is stable.<br><br>OK there is definitely a memory leak with the OpenAL sound driver.<br><br>I'm using OpenAL in Vista and FreeAudio in XP.  I noticed that with my game on Vista the app memory consumption was going up FAST in Task Manager when I changed screens, but the GC memory level was stable. Note that the different screens play different music.<br><br><br>I tested the game on XP with Freeaudio and Task Manager and GC are stable.  I used OpenAL on XP and Task Manager memory consumption shot up (about 4Mb every screen change due to size of music files) and GC is stable.<br><br>I found this exact same bug quite a long time ago but I can't remember with which driver it was (OpenAL or FreeAudio) anyway it got fixed at the time, or maybe I used some different code, I can't recall.  I need to find it in the fixed bug bin...<br><br>What was happening back then was when you stopped a channel playing the sound was being left in memory and was causing task manager memory to shoot up but GC to remain stable.  Sounds very similar.<br><br>My code for playing sounds and music is exactly the same for OpenAL and FreeAudio (no need to make it different) just the sound driver itself is different.  So I don't know if the bug is in the BRL modules or OpenAL itself.<br><br>I'd love to make a test to demonstrate but today is the last day of working on my game, it goes to QA probably at about 4am!  So if anyone else feels like making an app to help prove this (it's in everyone's interested to get it fixed), that would be fantastic!  Thanks. <br><br></td></tr></table><br>
<a name="938509"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Brucey</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#2">[#2]</a></td></tr></table></td></tr><tr ><td class="posttext"> Got an example? <br><br></td></tr></table><br>
<a name="938511"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Grey Alien</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#3">[#3]</a></td></tr></table></td></tr><tr ><td class="posttext"> Sorry Brucey I made that post halfway through by mistake.  You can see that today I don't have time to make an example, but thought I'd better raise the issue right away.<br><br>To confirm the fix that happened ages ago was simply that I was using PauseChannel when a sound stopped (because it prevents a click noise) instead of StopChannel.  StopChannel properly frees the sound sample, whereas PauseChannel and then nulling the channel for GC to collect does not.<br><br>Anyway, that's not the issue here as both drivers use the same code which is StopChannel based...<br><br>Old Thread about the StopChannel issue: <a href="http://www.blitzmax.com/Community/posts.php?topic=65001" target="_blank">http://www.blitzmax.com/Community/posts.php?topic=65001</a> <br><br></td></tr></table><br>
<a name="938513"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Brucey</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#4">[#4]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> whereas PauseChannel and then nulling the channel for GC to collect does not. <br></div><br>That would make sense, as it's possible they may not have properly implemented the Delete() to tidy up after itself... <br><br></td></tr></table><br>
<a name="938514"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Grey Alien</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#5">[#5]</a></td></tr></table></td></tr><tr ><td class="posttext"> Is there are way to test for mem leaks in OSX btw? <br><br></td></tr></table><br>
<a name="938515"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Grey Alien</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#6">[#6]</a></td></tr></table></td></tr><tr ><td class="posttext"> Fingers crossed that this is just a simple module fix that I can patch in... <br><br></td></tr></table><br>
<a name="938516"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Grey Alien</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#7">[#7]</a></td></tr></table></td></tr><tr ><td class="posttext"> freeaudioglue.cpp has this:<br><br><pre class=code>
int BBCALL fa_StopChannel( int channel ){
	output	*out;
	if (io==0) return 0;
	out=io-&gt;getchannel(channel);
	if (out) {
		out-&gt;stop(1);
		io-&gt;freechannel(channel);
	}
	return 0;
}
</pre><br>But I can't find anything similar in the OpenAL code, it's completely different. <br><br></td></tr></table><br>
<a name="938524"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Brucey</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#8">[#8]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote">  Is there are way to test for mem leaks in OSX btw? <br></div><br>Oh yes! :-)<br><br>(... note the sound of Brucey rubbing his hands together as he gets comfortable...)<br><br>The following assumes you are using 10.5.x. (lesser versions are similar, but not so full featured)<br>Righty... in Finder, go to your Developer folder. (on mine, you open the main Disk, and you should see the Developer folder there).<br>Then into Applications.<br><br>There you will find an application called "Instruments". However these are not of the musical variety :-p<br>Open Instruments, and you should have a launch window which offers you tools such as Activity Monitor, File Activity, and of most interest, Object Allocations and Leaks.<br><br>Kick off Leaks, and your instrument panel should change to show two empty graphs of Leaks and Object Allocations.<br><br>Click on the Launch Executable combo, and find the app you want to execute.<br>You should now see the app appear in that combobox.<br><br>When you are ready, hit the red Record button.<br>Your app will start and all objects will be monitored.<br>You can use your app while this is monitoring and at any time, Pause recording, and examine the status of all live and deallocated objects.<br>The graph will indicate if something is leaking - if levels off after a while, all is well (obviously ;-)<br><br>I used this system to track and plug all the Mac MaxGUI leaks.<br>It's an excellent tool. <br><br></td></tr></table><br>
<a name="938525"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Brucey</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#9">[#9]</a></td></tr></table></td></tr><tr ><td class="posttext"> I'm not current with how the official audio modules work. I presume they are loading/decoding audio directly into memory and running that through whatever audio driver can play the sounds. <br><br></td></tr></table><br>
<a name="938531"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Grey Alien</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#10">[#10]</a></td></tr></table></td></tr><tr ><td class="posttext"> lol @ Brucey, sounds great but I only have OSX 10.4 on my Macbook Pro.  However I need to get a PPC Mac for the office so I'll stick 10.5 on that and check it out.  Many thanks for the detail.  Some users have reported sound failures on the Mac so I'm keen to see if there is a mem leak on OSX (with FreeAudio) for some reason.<br><br>As for official modules yeah, they load a music ogg (may be several Mb) into RAM, and play it with the correct driver.  The StopChannel should free up the sound sample, but it does NOT in OpenAL.  This is a pretty major bug if you are playing big music files.<br><br>You can see it in action by downloading any of my games and running on Vista and using Task Manager.  Swap between two screens with different music. The memory should stay similar (varies a little), but it goes up a lot with OpenAL. <br><br></td></tr></table><br>
<a name="938533"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Brucey</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#11">[#11]</a></td></tr></table></td></tr><tr ><td class="posttext"> Okay. On 10.4, go into Developer, the Applications, then Performance Tools.<br>There you will see "ObjectAlloc", which work much in the same way as I've described above. <br><br></td></tr></table><br>
<a name="938755"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Grey Alien</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#12">[#12]</a></td></tr></table></td></tr><tr ><td class="posttext"> Thanks for that, will test soon just to be sure FreeAudio is OK on Mac, but I guess other people would have reported problems before now if there were some.  Mind you no one has reported the OpenAL one... <br><br></td></tr></table><br>
<a name="939241"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Grey Alien</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#13">[#13]</a></td></tr></table></td></tr><tr ><td class="posttext"> OK posted an example in the bugs forum: <a href="http://www.blitzbasic.com/Community/posts.php?topic=83229" target="_blank">http://www.blitzbasic.com/Community/posts.php?topic=83229</a><br><br>It would be great if someone can verify my findings, thx!  It's in all our interests to get this fixed. <br><br></td></tr></table><br>
<a name="bottom"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td align="right"><a href="http://monkeycoder.co.nz" target="_blank"><img src="/img/monkey2.svg" ></a> <a href="https://github.com/blitz-research" target="_blank"><img src="/img/github.svg" ></a> <a href="https://discord.gg/qJccbSp" target="_blank"><img src="/img/discord.svg" ></a></td></tr></table><br></div><br><table width="100%"><tr><td></body></html lang="en">
