<!DOCTYPE html><html lang="en" ><head ><title >Passing a string to a BlitzMax dll?</title><meta name='viewport' content='width=device-width, initial-scale=0.66'><meta name='description' content='language:basic, target:desktop, category:game development'><link rel="styleSheet" href="../skins/granite/style.css" type="text/css"><style type="text/css">div.bbcode {padding: 8px;background: #E5E5E5;color: #000000;border: 1px dashed #B4B4BE;}</style></head><body ><table width=100% cellspacing=0 cellpadding=0><tr ><td class="menubarleft"></td><td class="menubar"><table cellspacing="0" cellpadding="0"><tr ><td >&nbsp;</td><td class="menuitemleft"></td><td class="menuitem"><a href="/" class="menuitem">News</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/forums.php" class="menuitem">Forums</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/codearcs.php" class="menuitem">Code</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/logs.php" class="menuitem">Logs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/gallery.php" class="menuitem">Gallery</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/sdkspecs.php" class="menuitem">Specs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/search.php" class="menuitem">Search</a></td><td class="menuitemright"></td></tr></table></td><td class="menubarright"></td></tr></table><div class="main"><h1 >Passing a string to a BlitzMax dll?</h1><a href="forums.php" >BlitzMax Forums</a>/<a href="topics.php?forum=102" >BlitzMax Programming</a>/<a href="#bottom" >Passing a string to a BlitzMax dll?</a><br><br>
<a name="711102"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >JoshK</td><td align="right"><font class=tiny>(Posted 2006)</font>&nbsp;<a href="#1">[#1]</a></td></tr></table></td></tr><tr ><td class="posttext"> BlitzMax dlls crash when a string is passed to them (using BlitzPlus).  What is the correct way to handle this?<br><br>I also am having some strange errors when my dll uses DebugLog or RuntimeError, so I got rid of those commands.<br><br>Other than that, the dll compilation is working great! <br><br></td></tr></table><br>
<a name="711112"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Filax</td><td align="right"><font class=tiny>(Posted 2006)</font>&nbsp;<a href="#2">[#2]</a></td></tr></table></td></tr><tr ><td class="posttext"> It's possible to make DLL with bmax ???? :) If you have a link<br>for me ! <br><br></td></tr></table><br>
<a name="711153"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >ozak</td><td align="right"><font class=tiny>(Posted 2006)</font>&nbsp;<a href="#3">[#3]</a></td></tr></table></td></tr><tr ><td class="posttext"> Actually you could just have the functions inside an exe and then rename it as dll no? They have specific entry points. <br><br></td></tr></table><br>
<a name="711155"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Azathoth</td><td align="right"><font class=tiny>(Posted 2006)</font>&nbsp;<a href="#4">[#4]</a></td></tr></table></td></tr><tr ><td class="posttext"> How would that work? Most exes wont have their function names visible. <br><br></td></tr></table><br>
<a name="711168"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Dreamora</td><td align="right"><font class=tiny>(Posted 2006)</font>&nbsp;<a href="#5">[#5]</a></td></tr></table></td></tr><tr ><td class="posttext"> Currently DLL support is in test stage.<br><br>Strings as nearly all data from outside comes in through Byte Ptr (I assume you have that).<br>This enforces that you, at least on string, use freemem before returning whatever you wanted to return.<br>Main point is, if you want to work with Blitz, is that you return 1 at the end of the operation.<br><br>The following function is "a minimum function" that should work:<br><br><pre class=code>
Function PrintText:Int(_text:Byte Ptr)
	Print "Test: " + String.fromcstring(_text)
	MemFree _text
	Return 0
End Function</pre> <br><br></td></tr></table><br>
<a name="711217"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Azathoth</td><td align="right"><font class=tiny>(Posted 2006)</font>&nbsp;<a href="#6">[#6]</a></td></tr></table></td></tr><tr ><td class="posttext"> The freeing of the string shouldn't be done by DLL if it was allocated by the main program, it has no idea if the program is still using the ptr. <br><br></td></tr></table><br>
<a name="711261"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Dreamora</td><td align="right"><font class=tiny>(Posted 2006)</font>&nbsp;<a href="#7">[#7]</a></td></tr></table></td></tr><tr ><td class="posttext"> Normally, right.<br>In this case, where it interfaces with old Blitz which actually don't have anything like pointer, it is a different thing, as you won't be able to free it again from within Blitz (I actually don't know if B3D / B+ frees the string after the DLL command returns automatically or not) <br><br></td></tr></table><br>
<a name="711263"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >JoshK</td><td align="right"><font class=tiny>(Posted 2006)</font>&nbsp;<a href="#8">[#8]</a></td></tr></table></td></tr><tr ><td class="posttext"> It works...not sure about freeing the memory, though. <br><br></td></tr></table><br>
<a name="711269"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Azathoth</td><td align="right"><font class=tiny>(Posted 2006)</font>&nbsp;<a href="#9">[#9]</a></td></tr></table></td></tr><tr ><td class="posttext"> Judging by the mvsc demo.dll that comes with Blitzplus, it doesn't free the string from Blitzplus only its own copy that was allocated in the previous call. <br><br></td></tr></table><br>
<a name="711376"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >JoshK</td><td align="right"><font class=tiny>(Posted 2006)</font>&nbsp;<a href="#10">[#10]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> Main point is, if you want to work with Blitz, is that you return 1 at the end of the operation. <br></div><br>So if you have a function that doesn't return a value, you have to make it return an integer (0)?  I noticed a crash when a Blitz3D program ended, with the debugger on. <br><br></td></tr></table><br>
<a name="712364"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >JoshK</td><td align="right"><font class=tiny>(Posted 2006)</font>&nbsp;<a href="#11">[#11]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> Main point is, if you want to work with Blitz, is that you return 1 at the end of the operation. <br></div><br>Please explain why an integer return value is needed. <br><br></td></tr></table><br>
<a name="764165"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >JoshK</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#12">[#12]</a></td></tr></table></td></tr><tr ><td class="posttext"> I have determined that the MemFree in the above example will crash BlitzMax.  You should not free the byte ptr that gets passed to the dll!<br><br><pre class=code>Function PrintText(htext:Byte Ptr)
	text$=String.fromcstring(htext)
	Print text
EndFunction</pre> <br><br></td></tr></table><br>
<a name="764166"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Paul "Taiphoz"</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#13">[#13]</a></td></tr></table></td></tr><tr ><td class="posttext"> you can make a dll with blitz max??? link ? source ? <br><br></td></tr></table><br>
<a name="764178"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >ziggy</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#14">[#14]</a></td></tr></table></td></tr><tr ><td class="posttext"> In the calling program, the String should be properly counted by the garbage collector.<br>But in the DLL program, using Byte Ptr should avoid the usage of the GC reference counter, so as long as the function is not running on a separated thread, the string object references should be the same in the calling program, before and after the function call, so you shouldn't have to free memory. In fact, when you do text$ = string.fromcstring(htext) you're creating a new and separated BlitzMax string object. Strings are the only objects that doesn't increase reference counting when assigned. they just duplicate objects, this way, they work as if they where 'regular' variables.<br><br>And the real problem here is freeing memory when the calling program still has at last one string reference count of it (the one placed in the calling sentence).<br>So my advice whould be to not free memory as long as you are not creating multithread dlls. I see no way to do this without confusing the GC <br><br></td></tr></table><br>
<a name="764299"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Azathoth</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#15">[#15]</a></td></tr></table></td></tr><tr ><td class="posttext"> The program calling ToCString or ToWString should be the one freeing the memory, if your Dll does it that will make it incompatible with other programming languages. <br><br></td></tr></table><br>
<a name="bottom"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td align="right"><a href="http://monkeycoder.co.nz" target="_blank"><img src="/img/monkey2.svg" ></a> <a href="https://github.com/blitz-research" target="_blank"><img src="/img/github.svg" ></a> <a href="https://discord.gg/qJccbSp" target="_blank"><img src="/img/discord.svg" ></a></td></tr></table><br></div><br><table width="100%"><tr><td></body></html lang="en">
