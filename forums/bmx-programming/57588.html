<!DOCTYPE html><html lang="en" ><head ><title >Wrapping this Method for BMax</title><meta name='viewport' content='width=device-width, initial-scale=0.66'><meta name='description' content='language:basic, target:desktop, category:game development'><link rel="styleSheet" href="../skins/granite/style.css" type="text/css"><style type="text/css">div.bbcode {padding: 8px;background: #E5E5E5;color: #000000;border: 1px dashed #B4B4BE;}</style></head><body ><table width=100% cellspacing=0 cellpadding=0><tr ><td class="menubarleft"></td><td class="menubar"><table cellspacing="0" cellpadding="0"><tr ><td >&nbsp;</td><td class="menuitemleft"></td><td class="menuitem"><a href="/" class="menuitem">News</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/forums.php" class="menuitem">Forums</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/codearcs.php" class="menuitem">Code</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/logs.php" class="menuitem">Logs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/gallery.php" class="menuitem">Gallery</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/sdkspecs.php" class="menuitem">Specs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/search.php" class="menuitem">Search</a></td><td class="menuitemright"></td></tr></table></td><td class="menubarright"></td></tr></table><div class="main"><h1 >Wrapping this Method for BMax</h1><a href="forums.php" >BlitzMax Forums</a>/<a href="topics.php?forum=102" >BlitzMax Programming</a>/<a href="#bottom" >Wrapping this Method for BMax</a><br><br>
<a name="640507"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Gabriel</td><td align="right"><font class=tiny>(Posted 2006)</font>&nbsp;<a href="#1">[#1]</a></td></tr></table></td></tr><tr ><td class="posttext"> Ok, Here's a Method I have wrapped for BlitzMax, which I believe I have wrapped incorrectly.<br><br>c++<br><pre class=code>
extern "C" __cdecl cTV_3DVECTOR CTVPhysics_GetBodyPosition(CTVPhysics* Ha,int rigidBodyIndex) {
	return Ha-&gt;GetBodyPosition(rigidBodyIndex);
}
</pre><br><br>bmx<br><pre class=code>
Function CTVPhysics_GetBodyPosition:Byte Ptr(Ha:Byte Ptr,rigidBodyIndex:Int)
</pre><br><br>I'm getting an unhandled memory exception on it though. I know that Ha-&gt;GetBodyPosition returns a cTV_3DVECTOR, that's correct. But normally when I get objects back from my C++ wrapped functions, get them back as Blah* not just Blah. Could this be the problem? If so, what can I do? I can't just change the return type of the C++ function to cTV_3DVECTOR* because it complains that the function return type does not match ( because, as I said, Ha-&gt;GetBodyPosition returns a cTV_3DVECTOR, not a cTV_3DVECTOR* <br><br></td></tr></table><br>
<a name="640510"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >N</td><td align="right"><font class=tiny>(Posted 2006)</font>&nbsp;<a href="#2">[#2]</a></td></tr></table></td></tr><tr ><td class="posttext"> Try this:<br><br><pre class=code>
extern "C" __cdecl void CTVPhysics_GetBodyPosition(CTVPhysics* Ha,int rigidBodyIndex, float* vector) {
     cTV_3DVECTOR vec = Ha-&gt;GetBodyPosition(rigidBodyIndex);
     memcpy(vector,&amp;vec,sizeof(cTV_3DVECTOR)); // copy the data to the output vector ('vector')
}



Function CTVPhysics_GetBodyPosition(Ha:Byte Ptr,rigidBodyIndex:Int, output:Float Ptr)
</pre> <br><br></td></tr></table><br>
<a name="640511"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Dreamora</td><td align="right"><font class=tiny>(Posted 2006)</font>&nbsp;<a href="#3">[#3]</a></td></tr></table></td></tr><tr ><td class="posttext"> Why not simply change the return then as well to *.... when you set cTV_3DVECTOR* as return type? :-) <br><br></td></tr></table><br>
<a name="640512"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >N</td><td align="right"><font class=tiny>(Posted 2006)</font>&nbsp;<a href="#4">[#4]</a></td></tr></table></td></tr><tr ><td class="posttext"> Because the vector is not allocated in the heap, it's in the stack.  So you're returning a pointer to something that, once out of the stack frame, is freed.  You can probably guess what's wrong with that. <br><br></td></tr></table><br>
<a name="640516"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Gabriel</td><td align="right"><font class=tiny>(Posted 2006)</font>&nbsp;<a href="#5">[#5]</a></td></tr></table></td></tr><tr ><td class="posttext"> Thanks for the suggestion, Noel, but I get the same result. Still an unhandled memory exception.<br><br>How does this look :<br><br><pre class=code>
extern "C" __cdecl cTV_3DVECTOR* CTVPhysics_GetBodyPositionTwo(CTVPhysics* Ha,int rigidBodyIndex) {
	cTV_3DVECTOR v=Ha-&gt;GetBodyPosition(rigidBodyIndex);
	return new cTV_3DVECTOR(v.x,v.y,v.z);
}

</pre> <br><br></td></tr></table><br>
<a name="640520"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >N</td><td align="right"><font class=tiny>(Posted 2006)</font>&nbsp;<a href="#6">[#6]</a></td></tr></table></td></tr><tr ><td class="posttext"> That could work, however you'd better have a way to delete the vector. <br><br></td></tr></table><br>
<a name="640560"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Sweenie</td><td align="right"><font class=tiny>(Posted 2006)</font>&nbsp;<a href="#7">[#7]</a></td></tr></table></td></tr><tr ><td class="posttext"> I would go for the method Noel suggested.<br>Ogre returns the whole vector as well and that is how I solved it. <br><br></td></tr></table><br>
<a name="640634"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Gabriel</td><td align="right"><font class=tiny>(Posted 2006)</font>&nbsp;<a href="#8">[#8]</a></td></tr></table></td></tr><tr ><td class="posttext"> Is there a flaw inherent in my way of doing it then? Because unfortunately Noel's method also gave me an unhandled memory exception. <br><br></td></tr></table><br>
<a name="640638"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >gman</td><td align="right"><font class=tiny>(Posted 2006)</font>&nbsp;<a href="#9">[#9]</a></td></tr></table></td></tr><tr ><td class="posttext"> i used your proposed second method extensively in the Irrlicht mod.  just  have a delete routine and remember to incorporate that in your BMAX wrapper when you are done with it and your good to go.  the only thing wrong with the creating a new based on the return value is making sure you clean it up properly. <br><br></td></tr></table><br>
<a name="640652"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Sweenie</td><td align="right"><font class=tiny>(Posted 2006)</font>&nbsp;<a href="#10">[#10]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> Is there a flaw inherent in my way of doing it then? Because unfortunately Noel's method also gave me an unhandled memory exception.  <br></div><br>Well, is the float ptr passed by the bmax app valid?<br>I assume the 3DVector contains three floats, so it should be something like this...<br>Local Position:Float[3]<br>MyWrappedGetPositionFunction(varptr Position[0]) <br><br></td></tr></table><br>
<a name="641338"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Gabriel</td><td align="right"><font class=tiny>(Posted 2006)</font>&nbsp;<a href="#11">[#11]</a></td></tr></table></td></tr><tr ><td class="posttext"> Thanks for the confirmation, GMan. If you used it for Irrlicht, that's good enough for me. I do already have a delete method in place which deletes the wrapped object pointer, as I have no way of knowing how it was created.<br><br>Sweenie: Yes, that's how I had it and it was erroring. Perhaps I had something wrong somewhere, but some of these returned objects are going to be far more complex, made out of mixed datatypes and possibly even other objects, so doing things this way would mean having to pass back into a bank or block of memory and pull it all apart at the other end, so I think just creating a new one in the wrapper is easier there anyway. <br><br></td></tr></table><br>
<a name="bottom"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td align="right"><a href="http://monkeycoder.co.nz" target="_blank"><img src="/img/monkey2.svg" ></a> <a href="https://github.com/blitz-research" target="_blank"><img src="/img/github.svg" ></a> <a href="https://discord.gg/qJccbSp" target="_blank"><img src="/img/discord.svg" ></a></td></tr></table><br></div><br><table width="100%"><tr><td></body></html lang="en">
