<!DOCTYPE html><html lang="en" ><head ><title >Using COM Objects from Max</title><meta name='viewport' content='width=device-width, initial-scale=0.66'><meta name='description' content='language:basic, target:desktop, category:game development'><link rel="styleSheet" href="../skins/granite/style.css" type="text/css"><style type="text/css">div.bbcode {padding: 8px;background: #E5E5E5;color: #000000;border: 1px dashed #B4B4BE;}</style></head><body ><table width=100% cellspacing=0 cellpadding=0><tr ><td class="menubarleft"></td><td class="menubar"><table cellspacing="0" cellpadding="0"><tr ><td >&nbsp;</td><td class="menuitemleft"></td><td class="menuitem"><a href="/" class="menuitem">News</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/forums.php" class="menuitem">Forums</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/codearcs.php" class="menuitem">Code</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/logs.php" class="menuitem">Logs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/gallery.php" class="menuitem">Gallery</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/sdkspecs.php" class="menuitem">Specs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/search.php" class="menuitem">Search</a></td><td class="menuitemright"></td></tr></table></td><td class="menubarright"></td></tr></table><div class="main"><h1 >Using COM Objects from Max</h1><a href="forums.php" >BlitzMax Forums</a>/<a href="topics.php?forum=102" >BlitzMax Programming</a>/<a href="#bottom" >Using COM Objects from Max</a><br><br>
<a name="503328"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Shaun Sullivan</td><td align="right"><font class=tiny>(Posted 2005)</font>&nbsp;<a href="#1">[#1]</a></td></tr></table></td></tr><tr ><td class="posttext"> Any of you have any experience doing this?  Any samples would be greatly appreciated!<br><br>Shaun Sullivan<br>PureSim Baseball<br>www.puresim.com <br><br></td></tr></table><br>
<a name="503388"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Nennig</td><td align="right"><font class=tiny>(Posted 2005)</font>&nbsp;<a href="#2">[#2]</a></td></tr></table></td></tr><tr ><td class="posttext"> Yes, I agree this would be marvelous!<br>If you know, please teach us! <br><br></td></tr></table><br>
<a name="503898"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Red Ocktober</td><td align="right"><font class=tiny>(Posted 2005)</font>&nbsp;<a href="#3">[#3]</a></td></tr></table></td></tr><tr ><td class="posttext"> i dunno... from what i can remember, COM (activex) is a two way street... you app has to be a COM container before it can host a COM server... <br><br>but that may apply to in process only, cause there is such a thing as an ActiveX exe... <br><br>anyway, i think that a COM wrapper that is a COM container, and also exports the COM interfaces (iUknown and QueryInterface me thinks) will have to be written...<br><br>in short... i don't remember, but i will be looking into this in the near future...<br><br>--Mike <br><br></td></tr></table><br>
<a name="503992"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Nennig</td><td align="right"><font class=tiny>(Posted 2005)</font>&nbsp;<a href="#4">[#4]</a></td></tr></table></td></tr><tr ><td class="posttext"> Hope to hear from you again about this.<br>Have fun. <br><br></td></tr></table><br>
<a name="504275"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >JoJo</td><td align="right"><font class=tiny>(Posted 2005)</font>&nbsp;<a href="#5">[#5]</a></td></tr></table></td></tr><tr ><td class="posttext"> Mark mentioned Max using COM Objects.<br><br><a href="http://www.blitzbasic.com/Community/posts.php?topic=44853" target="_blank">http://www.blitzbasic.com/Community/posts.php?topic=44853</a> <br><br></td></tr></table><br>
<a name="504306"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >ziggy</td><td align="right"><font class=tiny>(Posted 2005)</font>&nbsp;<a href="#6">[#6]</a></td></tr></table></td></tr><tr ><td class="posttext"> You have to 'comunicate' with the COM objetc in the same way you would do with a DLL, but you have to follow an specific protocol, you have to interact with the IDispatch of the Object and 'emulate' a container. You have to pass function pointer to let the COM object throw events (or event). and then interpret the info received by the COM. In fact, once the COM is registered in the container app. You have to deal basically only with one function, that uses only two parameters, the first one is the name of the 'logical' function to call, and the second one is an array with all the paramenters to pass to the 'logical' function.<br>What I mean is that a COM object has is just and interface and this interface can be managed from a Blitz Max application. <br><br></td></tr></table><br>
<a name="504307"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >marksibly</td><td align="right"><font class=tiny>(Posted 2005)</font>&nbsp;<a href="#7">[#7]</a></td></tr></table></td></tr><tr ><td class="posttext"> Hi,<br><br>I think all that dispatch stuff is to do with OLE - which is based on COM.<br><br>There are no plans to add OLE to Max - too complex for my liking. You may be able to do it yourself, though. <br><br></td></tr></table><br>
<a name="504407"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Sweenie</td><td align="right"><font class=tiny>(Posted 2005)</font>&nbsp;<a href="#8">[#8]</a></td></tr></table></td></tr><tr ><td class="posttext"> Here is an interesting article on how to use COM in Visual Basic.<br>I think it could be "ported" to Bmax.<br>In the article a helper dll is used but I'm sure the functions in the helper dll could be made directly in Bmax.<br><br><a href="http://msdn.microsoft.com/library/default.asp?url=/library/en-us/dncomg/html/msdn_house6.asp" target="_blank">http://msdn.microsoft.com/library/default.asp?url=/library/en-us/dncomg/html/msdn_house6.asp</a> <br><br></td></tr></table><br>
<a name="504424"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Shaun Sullivan</td><td align="right"><font class=tiny>(Posted 2005)</font>&nbsp;<a href="#9">[#9]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> There are no plans to add OLE to Max - too complex for my liking. You may be able to do it yourself, though <br></div><br><br>Mark, I saw an earlier post from you where you were calling DirectX9 (for some new stuff that is coming).  How were you able to do that?  DX9 is based on COM. <br><br></td></tr></table><br>
<a name="504452"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Drago</td><td align="right"><font class=tiny>(Posted 2005)</font>&nbsp;<a href="#10">[#10]</a></td></tr></table></td></tr><tr ><td class="posttext"> mark wont be giving us access to the directX interface in blitz, the C/C++ code for the library will be doing all that, since if mark writes the engine properly (abstract interface) then engine wont know if it is running in openGL or DX, it will just tell it to render, or add a vertex, and the interface does all the work. <br><br></td></tr></table><br>
<a name="504754"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >marksibly</td><td align="right"><font class=tiny>(Posted 2005)</font>&nbsp;<a href="#11">[#11]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> <br>Mark, I saw an earlier post from you where you were calling DirectX9 (for some new stuff that is coming). How were you able to do that? DX9 is based on COM<br> <br></div><br><br>I've 'tweaked' the compiler so that you can use 'native' C++ objects from within Max, like this:<br><br><pre class=code>
Extern "Win32"
Type IUnknown
   Method QueryInterface()
   Method AddRef()
   Method Release()
End Type
Type IDirect3D9 Extends IUnknown
  Method Blah()
  Method Etc()
End Type
End Extern
</pre><br><br>There are some limitations: You can't 'New' such 'extern objects' - this must be done by somewhere else by non-Max code, and of course they're not managed for you. They can't extend normal Blitz Types, and vice versa. <br><br>COM objects are really simplified C++ objects, so this is enough to be able to access DirectX pretty cleanly. I haven't looked into the 'CoCreateInstance' stuff, as DirectX functions do this for you, but I don't think that would be a huge headache.<br><br>As far as I know, OLE/ActiveX and all that crud is built on top of COM and CoCreate etc, but its not something I'll be spending any time on. <br><br></td></tr></table><br>
<a name="504803"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >gman</td><td align="right"><font class=tiny>(Posted 2005)</font>&nbsp;<a href="#12">[#12]</a></td></tr></table></td></tr><tr ><td class="posttext"> and when might we see this 'tweaked' version of the compiler? :)  it would seriously impact the direction i take on my current project if the capability of using an object natively were available to me. <br><br></td></tr></table><br>
<a name="504805"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >GW</td><td align="right"><font class=tiny>(Posted 2005)</font>&nbsp;<a href="#13">[#13]</a></td></tr></table></td></tr><tr ><td class="posttext"> Wouldnt that also allow someone to make a port of some of the open source, cross platform C++ graphics libraries out there like Ogre? <br><br></td></tr></table><br>
<a name="504807"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >gman</td><td align="right"><font class=tiny>(Posted 2005)</font>&nbsp;<a href="#14">[#14]</a></td></tr></table></td></tr><tr ><td class="posttext"> you can do that now by wrapping the methods up in functions and passing in pointers to instances of the classes...  but mark's tweak would make something like that much, much easier and more intuitive :) <br><br></td></tr></table><br>
<a name="504928"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Red Ocktober</td><td align="right"><font class=tiny>(Posted 2005)</font>&nbsp;<a href="#15">[#15]</a></td></tr></table></td></tr><tr ><td class="posttext"> yes... that would save us a ton of work... ok, maybe not a ton :)   <br><br>so far i'm just using the mac demo version, but this looks like it would definitely be a work saver...<br><br>--Mike <br><br></td></tr></table><br>
<a name="505143"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >marksibly</td><td align="right"><font class=tiny>(Posted 2005)</font>&nbsp;<a href="#16">[#16]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> <br>Wouldnt that also allow someone to make a port of some of the open source, cross platform C++ graphics libraries out there like Ogre? <br> <br></div><br><br>Alas, no.<br><br>All methods in the c++ class must be 'virtual' - this is rarely the case for most C++ libs. <br><br></td></tr></table><br>
<a name="505154"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Drago</td><td align="right"><font class=tiny>(Posted 2005)</font>&nbsp;<a href="#17">[#17]</a></td></tr></table></td></tr><tr ><td class="posttext"> so it is only COM objects then, not c++ classes? <br><br></td></tr></table><br>
<a name="509320"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >StuC</td><td align="right"><font class=tiny>(Posted 2005)</font>&nbsp;<a href="#18">[#18]</a></td></tr></table></td></tr><tr ><td class="posttext"> IDispatch is used for making late bound calls to COM objects, and being able to discover their methods and properties at runtime.  To happen seemlessly, it must be generated by the compiler, so you can write code like to call a method e.g. 'ObjInstance.Method'.  The compiler generates calls to GetIDsOfNames, and Invoke behind the scenes.  Not good if you want fast code, as you are making indirect calls to the COM objects methods.<br><br>Also, these COM objects must implement IDispatch before this is even possible.<br><br>If Mark has 'tweaked' the compiler, as he says, I assume that the IUnknown declaration above generates a virtual method table (vtable), compatible with COM (and C++ for that matter).<br><br>This means that you could call any COM object, but you must inspect the type library yourself to extract the exact definition of the interface.  In the case of IUnknown, the methods "QueryInterface", "AddRef" and "Release" MUST be defined in this order, so the vtables match.<br><br>Say COM object MyObj was defined as :<br><br><pre class=code>
interface IMyObj : IUnknown
{
  void Initialize;
  void SomeMethod;
  void Uninitialize;
}
</pre><br><br>You could define your BMax object as:<br><br><pre class=code>
Type MyObj Extends IUnknown
  Method Initialize
  Method SomeMethod
  Method Uninitialize
End Type
</pre><br><br>All COM objects must be derived from IUnknown.  <br><br>If the object you wanted to call was derived from IDispatch, you would have to include a definition of IDispatch in BMax.<br>Since it wouldn't be called by your code, and is just a place holder for the vtable, I've only defined the methods, and not their parameters<br><br><pre class=code>
Type IDispatch Extends IUnknown
  
  Method GetTypeInfoCount
  Method GetTypeInfo
  Method GetIDsOfNames
  Method Invoke
  
End Type
</pre><br><br>Your IDispatch derived object would then be defined as:<br><br><pre class=code>
Type MyObj Extends IDispatch
  Method Initialize
  Method SomeMethod
  Method Uninitialize
End Type
</pre><br><br>I don't have BMax, so I can't show you how to create the COM object, but check out CoCreateInstance and CLSIDFromProgID.<br><br>Cheers,<br><br>Stu <br><br></td></tr></table><br>
<a name="509640"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Nennig</td><td align="right"><font class=tiny>(Posted 2005)</font>&nbsp;<a href="#19">[#19]</a></td></tr></table></td></tr><tr ><td class="posttext"> Hi Stuart,<br><br>You seem to know your way around COM....<br>Too bad you did not purchase Blitzmax yet...<br><br>You could bring a very nice addition to the product.<br>I would do it myself, if only I had the skills...<br>;-) <br><br></td></tr></table><br>
<a name="509673"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >StuC</td><td align="right"><font class=tiny>(Posted 2005)</font>&nbsp;<a href="#20">[#20]</a></td></tr></table></td></tr><tr ><td class="posttext"> Hi Nennig,<br><br>what COM object specifically do you want to interact with?  I will purchase Blitz Max soon (I am already a Blitz3D owner).  I can then show you how to create your COM object.<br><br>I just don't have a Mac, and there was no literature indicating I would get the beta of Blitz Max for the PC - but as I understand, I will :)<br><br>Cheers,<br><br>Stu <br><br></td></tr></table><br>
<a name="509696"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Nennig</td><td align="right"><font class=tiny>(Posted 2005)</font>&nbsp;<a href="#21">[#21]</a></td></tr></table></td></tr><tr ><td class="posttext"> Hi Stuart,<br><br>It is very generous of you.<br>I would like to learn how to interact with Excel.<br><br>This would open for me huge possibilities to use Bmax at work. <br><br>Thank you.<br><br>Nennig <br><br></td></tr></table><br>
<a name="510675"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >StuC</td><td align="right"><font class=tiny>(Posted 2005)</font>&nbsp;<a href="#22">[#22]</a></td></tr></table></td></tr><tr ><td class="posttext"> Nennig,<br><br>I purchased BMax, and did some experimentation.  I added an ole32.bmx module to the Pub.Win32 space, to include the functions I mentioned above.  <br><br>I was able to create an instance of Excel and receive an IUnknown pointer, however there are a number of limitations with BMax at the moment, that would mean you have to jump through considerable hoops to use Excel.<br><br>A question you ask yourself when choosing a development environment for a particular task is 'How well suited is it for the task I'm trying to solve?'.  Also 'Will I be most productive in this environment when trying to solve this task?'.  <br>If you ask youself that question for this problem, BMax is not that environment.  <br><br>I spent several hours yesterday attempting to interact with Excel.  Granted, some time was spent getting up to speed with BMax, but not a great deal.  <br>I could have achieved the same result in less than 10 minutes in Delphi, C#, C++ or an active script language.<br><br><br>Some food for thought:<br><br>There are two primary ways we interact with COM objects, either using early binding or late binding.<br><br>Early binding involves importing the COM object's type library, which generates a set of interface definitions (like an abstract Type in BMax) and additionally class / type / object wrappers (depending on your language) for you to use natively in your development environment.  These tools are specific to each development environment.<br><br>Using early binding generates code that is almost as fast as using native objects.  It also has the benefit of compile-time error checking and type verification.<br><br>For late bound interaction, firstly the COM object must be derived from IDispatch, and to be of any use, your dev environment should support late bound calls.  Late binding means the compiler generates calls to IDispatch-&gt;Invoke behind the scenes at runtime.  There are a few disadvantages to this method.  <br>1. If your object doesn't support a particular method, you will receive runtime errors, as there is no type checking performed at compile time (as the compiler doesn't know what the instance of your object will be).  (Not impossible, but no environment I have used does).<br><br>So back to BMax.<br><br>Reason 1. BMax does not support late bound calls to IDispatch-able COM objects (like VBScript, JScript, Delphi).<br><br>Reason 2. BMax does not have the supporting tools for early bound COM interaction (like C++, Delphi and .Net).  <br><br>I would recommend you either create a DLL to wrap calls to Excel or use VB.Net or some other more suited environment for COM.<br><br>Cheers,<br><br>Stu <br><br></td></tr></table><br>
<a name="510695"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Nennig</td><td align="right"><font class=tiny>(Posted 2005)</font>&nbsp;<a href="#23">[#23]</a></td></tr></table></td></tr><tr ><td class="posttext"> Hi Stuart,<br><br>Thanks a lot for all your explanations. I am very aware that Bmax is probably not the best tool for playing with Excel.<br><br>I was just hoping that this would have  been possible in a way, I was not aware of.<br><br>Now, thanks to you, I have a better picture of the situation.<br><br>I have to admit, that I would have loved to have Bmax installed on my PC at work with my manager's approval.<br><br>It would have give me, very certainly, the opportunity to spend a bit of time on my own projects. :-)<br><br>Thanks for trying.<br><br>Bye<br><br>Nennig <br><br></td></tr></table><br>
<a name="510717"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >gman</td><td align="right"><font class=tiny>(Posted 2005)</font>&nbsp;<a href="#24">[#24]</a></td></tr></table></td></tr><tr ><td class="posttext"> @StuC<br><br>i will be the first to admit i know little about the inner-workings of COM so this may come out a little goofy...  but would there be a way to use the ability of BMAX to build in C++ code via MingW, exposing functions through the Extern statement, and function pointers to potentially build a dynamic calling system?  use C++ underneath to make all the calls to the COM contol and expose a single interface through Extern...  kinda like:<br><br>Module StuC.ReallyCoolCOMInterfaceMod<br><br>Import "COMinterface.cpp"<br><br>Public<br>(this exposes a few functions like)<br>Extern<br>Function createCOMControl:Int(comidstring:Byte Ptr) ' returns handle to instantiated control<br>Function closeCOM(handle:Int)<br>Function callMethod(handle:Int, stuff...)<br>Function getProp(handle:Int, prop:Byte Ptr)<br>Function setProp(handle:Int, prop:Byte Ptr, stuff...)<br>EndExtern<br><br>--------------------------<br><br>then in BMAX we could interact with the control using your interface functions.  data would probably have to go back and forth via banks...  heck i dont know... is this type of thing possible? <br><br>basically the goal would be to keep the instance of the COM object in C++ and use a handle to access it via BMAX using functions exposed via the Extern statement.  the exposed functions would be written in C++ and access the COM object directly using the handle passed in. <br><br></td></tr></table><br>
<a name="510762"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >StuC</td><td align="right"><font class=tiny>(Posted 2005)</font>&nbsp;<a href="#25">[#25]</a></td></tr></table></td></tr><tr ><td class="posttext"> Yes, absolutely.  You are pretty much spot on.<br><br>It would require using all late bound calls, since we wouldn't want to rebuild the C++ module anytime we wanted to add a new COM object.  No a big deal though<br><br>The only problem is handling the variety of parameter lists for the method calls.  My thinking would be to provide some way to add the parameters to a list or array.  I'd hate to have to deal with poking / peeking bytes..  We can be smarter than that.<br><br>Something like:<br><br><pre class=code>
Extern
  Function COMCreateArgList:Int()  ' returns handle to arg list

  Function COMAddArg(value:Byte Ptr, ArgType:Int) 
  ' value would be a pointer to the variable containing the data.  Variable would be any type
  ' ArgType would be a constant, indicating the type of pointer.  Somewhat similar in principal to a variant type.  e.g. ARG_INT, ARG_STRING, ARG_FLOAT...

  Function COMCallMethod(Handle:Int, MethodName:Byte Ptr, ArgList:Int) ' ArgList could be Null.

End Extern
</pre> <br><br></td></tr></table><br>
<a name="bottom"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td align="right"><a href="http://monkeycoder.co.nz" target="_blank"><img src="/img/monkey2.svg" ></a> <a href="https://github.com/blitz-research" target="_blank"><img src="/img/github.svg" ></a> <a href="https://discord.gg/qJccbSp" target="_blank"><img src="/img/discord.svg" ></a></td></tr></table><br></div><br><table width="100%"><tr><td></body></html lang="en">
