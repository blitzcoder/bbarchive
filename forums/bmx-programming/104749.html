<!DOCTYPE html><html lang="en" ><head ><title >Win 8 directory mayhem</title><meta name='viewport' content='width=device-width, initial-scale=0.66'><meta name='description' content='language:basic, target:desktop, category:game development'><link rel="styleSheet" href="../skins/granite/style.css" type="text/css"><style type="text/css">div.bbcode {padding: 8px;background: #E5E5E5;color: #000000;border: 1px dashed #B4B4BE;}</style></head><body ><table width=100% cellspacing=0 cellpadding=0><tr ><td class="menubarleft"></td><td class="menubar"><table cellspacing="0" cellpadding="0"><tr ><td >&nbsp;</td><td class="menuitemleft"></td><td class="menuitem"><a href="/" class="menuitem">News</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/forums.php" class="menuitem">Forums</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/codearcs.php" class="menuitem">Code</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/logs.php" class="menuitem">Logs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/gallery.php" class="menuitem">Gallery</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/sdkspecs.php" class="menuitem">Specs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/search.php" class="menuitem">Search</a></td><td class="menuitemright"></td></tr></table></td><td class="menubarright"></td></tr></table><div class="main"><h1 >Win 8 directory mayhem</h1><a href="forums.php" >BlitzMax Forums</a>/<a href="topics.php?forum=102" >BlitzMax Programming</a>/<a href="#bottom" >Win 8 directory mayhem</a><br><br>
<a name="1271083"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Robby</td><td align="right"><font class=tiny>(Posted 2015)</font>&nbsp;<a href="#1">[#1]</a></td></tr></table></td></tr><tr ><td class="posttext"> Hi all! Having a big problem with my app! It is set to save and load files into<br>the directory it is installed to, and works fine - at least on win xp,vista,7.<br><br>But when I ran it in Windows 8.1, a fresh install after deleting everything from a previous install, I noticed the OLD files were loading into my app - from the previous install, which I had removed.<br><br>I did a search, and found that not only was my app saving files in the directory where the app was installed, but also just about everywhere else!!<br><br>Places like c:\users\robby\appdata\roaming\microsoft\windows<br>c:\users\robby\appdata\virtualstore   and many other odd places!!<br><br>Some of these are labeled as "shortcuts". My files were indeed in my main folder, but nearly 20 other places as well!<br><br>What's going on? Is there any way I can insure the app saves and loads files only in the directory in which it is installed? Usually that's in the c:\programfiles i86 dir, but the user has a choice as to where to install.<br><br>My product was ready for release, now this major problem.<br><br>Desperate for a little advice!  Thanks!!   -Rob <br><br></td></tr></table><br>
<a name="1271084"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Yasha</td><td align="right"><font class=tiny>(Posted 2015)</font>&nbsp;<a href="#2">[#2]</a></td></tr></table></td></tr><tr ><td class="posttext"> Basically, no. Installed programs aren't really supposed to do that. It "appeared to work" (i.e. that business with the virtual store) as a backward compatibility feature, because Windows has a lot of those (one that I think is usually disabled?).<br><br>You can do one of two things:<br><br>-- make a "portable" deployment, which doesn't get installed to a system-aware folder (because it doesn't get installed at all); if the program simply runs out of a Documents subdirectory, it's fine to save files where it is. If the files move, the program moves with them, and users often have their own copies. This is only really practical for small utilities, and it has the disadvantage that a user might still try to put it in a protected folder and then it stops working as expected.<br><br>-- design your application to save to a fixed location queried from the system, like a My Whatever or one of the local user data hidden folders. This is what everyone else usually does. It has the advantage that a user doesn't lose their files if the program needs to be uninstalled or if they move their work to another machine, and multiple users can share the program.<br><br>Writing to a Program Files folder during operation is a relic of the twentieth century that's only still possible because Microsoft hate killing old software (and enable buggy designs as a result). It's not actually supposed to be a design option for new software. <br><br></td></tr></table><br>
<a name="1271085"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Brucey</td><td align="right"><font class=tiny>(Posted 2015)</font>&nbsp;<a href="#3">[#3]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> Is there any way I can insure the app saves and loads files only in the directory in which it is installed? Usually that's in the c:\programfiles i86 dir <br></div><br>Program Files *should* be a protected folder. Your app shouldn't really be writing anything in there. That's what the user/app data folders are for.<br>On the new versions of Windows, I believe (someone can correct me if I'm wrong) the OS will not let your app write into Program Files at all, and uses some kind of virtual storage area that mimics that folder structure. <br><br></td></tr></table><br>
<a name="1271087"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Robby</td><td align="right"><font class=tiny>(Posted 2015)</font>&nbsp;<a href="#4">[#4]</a></td></tr></table></td></tr><tr ><td class="posttext"> Thanks for the info. Probably be safest to write to other then the Program Files.<br><br>However, in tests, I think its not so much my Blitz app as much as the installer.<br>The excess of file locations only appeared when I ran the installer, which was made with<br>Inno Setup Compiler.<br><br>I'll fiddle with this and check back. Thanks again! <br><br></td></tr></table><br>
<a name="1271091"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >xlsior</td><td align="right"><font class=tiny>(Posted 2015)</font>&nbsp;<a href="#5">[#5]</a></td></tr></table></td></tr><tr ><td class="posttext"> When it comes to file locations, you need to follow Microsoft's guidelines, it's the only way that your program 'should' work on any computer.<br>MS says that no program is allowed to write to the program files folders after the initial program install, you have to use those other folders. you can dink around with folder permissions on your own PC and get it to let you write to program files normally, but that obviously won't be a working strategy when you intent to release your program to the world.<br>Not following the 'rules' could also keep your program from getting accepted by some publishers, and rightfully so -- any new windows version could stop your workarounds in their tracks.<br><br>However, keep in mind that you cannot just hardcode those paths either -- they will be called different on non-English windows versions, and if you hardcode c:\users in your program it will fail on those. there are windwos API calls that your program can query that will return the proper locations that the program should be writing to -- there's a few different modules for blitzmax that allow you to query those paths.<br><br>Another big reason to use the API calls is that if Microsoft changes their minds again with some future windows version, the old API calls should automatically be redirected to the new proper location for backwards compatibility support. <br><br></td></tr></table><br>
<a name="1271097"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Robby</td><td align="right"><font class=tiny>(Posted 2015)</font>&nbsp;<a href="#6">[#6]</a></td></tr></table></td></tr><tr ><td class="posttext"> Thanks again for all the help. My usual method for saving out files is just making<br>a stream like this - saves to the current directory where the app is:<br><br>' (induntest is an integer made elsewhere)<br>savext = ".svn"<br>filename = "induntest" + savext<br>CreateFile(filename)<br>Local indungsvn:TStream = OpenStream(filename)<br>WriteInt(indungsvn, induntest)<br>CloseFile(indungsvn))<br><br>I found a little function somewhere here on the forum (see below)<br>It does seem to find the AppData folder, and gives me this for files_path$:<br><br>C:\Users\Robby\AppData\Roaming/<br><br>I'm not sure if that's a typo, the "/" instead of "\"?<br><br>More importantly, I'm not sure how to attach my save variables, like induntest.svn,<br>to the C:\Users\Robby\AppData\Roaming/ path found?<br><br>Don't I need a sub-dir first? Like:<br>C:\Users\Robby\AppData\Roaming/gamesaves<br><br>How would I make that? There's several dozen variables that get saved out,<br>and read in as well. I'm almost there, with the rest of the app done! Thanks!<br><br><br>Const	CSIDL_APPDATA		= $1a<br>Const CSIDL_COMMON_APPDATA = $23<br>Global	appdata_path_ptr:Byte Ptr, files_path$<br><br>Extern "win32"<br> Function SHGetFolderPathA(hWnd:Int, folder:Int, token:Int, FLAGS:Int, str:Byte Ptr)<br>End Extern<br><br><br>Function GetAppDataFolder()<br>     Local res, dir, cnt<br>    appdata_path_ptr = New Byte[260]<br>    res = SHGetFolderPathA(Null, CSIDL_APPDATA, Null, 1, appdata_path_ptr)<br>    cnt = 0<br><br>    While (appdata_path_ptr[cnt] &lt;&gt; 0)<br>	cnt :+ 1<br>    Wend<br><br>files_path$ = String.FromBytes(appdata_path_ptr, cnt)<br>files_path$ :+ "/" + AppName$	<br>			<br>EndFunction <br><br></td></tr></table><br>
<a name="1271101"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Brucey</td><td align="right"><font class=tiny>(Posted 2015)</font>&nbsp;<a href="#7">[#7]</a></td></tr></table></td></tr><tr ><td class="posttext"> You probably want to create a folder for your specific game - usually the name of your game, or perhaps one for your company, and inside that, another for your game.<br>Inside that folder, you may wish to create several different folders if you intend to separate out different kinds of data - saved/resources/etc.<br><br>One other thing to note is that SHGetFolderPathA() isn't always 100% effective - depending on your particular circumstances. Microsoft recommend you rather use SHGetKnownFolderPath if it is available. <br><br></td></tr></table><br>
<a name="1271106"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >xlsior</td><td align="right"><font class=tiny>(Posted 2015)</font>&nbsp;<a href="#8">[#8]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> I'm not sure if that's a typo, the "/" instead of "\"? <br></div><br><br>They're mostly interchangeable on Windows. <br><br></td></tr></table><br>
<a name="1271149"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Pingus</td><td align="right"><font class=tiny>(Posted 2015)</font>&nbsp;<a href="#9">[#9]</a></td></tr></table></td></tr><tr ><td class="posttext"> You may have a look there for a similar issue:<br><br><a href="http://www.blitzbasic.com/Community/posts.php?topic=104301#1262754" target="_blank">http://www.blitzbasic.com/Community/posts.php?topic=104301#1262754</a> <br><br></td></tr></table><br>
<a name="1271185"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Robby</td><td align="right"><font class=tiny>(Posted 2015)</font>&nbsp;<a href="#10">[#10]</a></td></tr></table></td></tr><tr ><td class="posttext"> Ok - I got this to work. It actually finds the appdata folder and I can save a file to it!<br>The trouble is that it keeps re-creating the directory even if it exists. I thought FileType() could determine if a directory exists as well as a file?<br><br>You can copy &amp; paste this code as is to see. Let me know if I got this right.  Thanks.<br><br>Const	CSIDL_APPDATA = $1a<br>Const CSIDL_COMMON_APPDATA = $23<br>Global	appdata_path_ptr:Byte Ptr<br>Global files_path:String, savext:String<br>Global files_path_test:String<br>Global induntest:Int, filename:String<br><br>induntest = 5<br><br>Extern "win32"<br>	Function SHGetFolderPathA(hWnd:Int, folder:Int, token:Int, FLAGS:Int, str:Byte Ptr)<br>End Extern<br><br>' Get the correct appdata folder<br>GetAppDataFolder()<br><br>Print "Folder from sub: "<br>Print files_path<br><br><br>' put it in a test string to test<br>files_path_test = files_path<br><br>' add my games save directory<br>files_path_test = files_path_test + "\\madman_data\\"<br><br>Print "Folder to test:"<br>Print files_path_test<br><br> <br>' If the folder does not exist, make it  (is &lt;&gt; 2 the same?)<br>If FileType(files_path_test) = 0 Then<br>  CreateDir(files_path_test)<br>  Print "CREATED DIR"<br>End If<br><br>' But this still shows zero! Why not 2, now that it exists?<br>Print FileType(files_path_test)<br><br><br>' append a typical save file to test <br>filename = files_path_test + "\induntest.svn"<br><br>' save it out<br>CreateFile(filename)<br>Local indungsvn2:TStream = OpenStream(filename)<br>WriteInt(indungsvn2, induntest)<br>CloseFile(indungsvn2)<br><br>' exists? = 1   works!!!<br>Print FileType(filename)<br><br><br>End<br><br>Function GetAppDataFolder()<br>	Local res, dir, cnt<br><br>		appdata_path_ptr = New Byte[260]<br>	<br>		res = SHGetFolderPathA(Null, CSIDL_APPDATA, Null, 1, appdata_path_ptr)<br>		cnt = 0<br>		While (appdata_path_ptr[cnt] &lt;&gt; 0)<br>			cnt :+ 1<br>		Wend<br>		files_path = String.FromBytes(appdata_path_ptr, cnt)<br>	<br>		'files_path :+ "/" + AppName$<br>		'files_path :+ "\mad_dat\"	<br>		'Print files_path<br>		'Print AppTitle				<br>EndFunction <br><br></td></tr></table><br>
<a name="1271198"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Robby</td><td align="right"><font class=tiny>(Posted 2015)</font>&nbsp;<a href="#11">[#11]</a></td></tr></table></td></tr><tr ><td class="posttext"> OK - I'm fine! I was checking for "\\madman_data\\" but when created,<br>its actually c:\users\robby\appdata\roaming\madman_data so I append another variable with just "\madman_data" appended and all is well!<br><br>I just hope it works on most Windows versions. <br><br></td></tr></table><br>
<a name="bottom"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td align="right"><a href="http://monkeycoder.co.nz" target="_blank"><img src="/img/monkey2.svg" ></a> <a href="https://github.com/blitz-research" target="_blank"><img src="/img/github.svg" ></a> <a href="https://discord.gg/qJccbSp" target="_blank"><img src="/img/discord.svg" ></a></td></tr></table><br></div><br><table width="100%"><tr><td></body></html lang="en">
