<!DOCTYPE html><html lang="en" ><head ><title >Problem with shader and non-shader graphics</title><meta name='viewport' content='width=device-width, initial-scale=0.66'><meta name='description' content='language:basic, target:desktop, category:game development'><link rel="styleSheet" href="../skins/granite/style.css" type="text/css"><style type="text/css">div.bbcode {padding: 8px;background: #E5E5E5;color: #000000;border: 1px dashed #B4B4BE;}</style></head><body ><table width=100% cellspacing=0 cellpadding=0><tr ><td class="menubarleft"></td><td class="menubar"><table cellspacing="0" cellpadding="0"><tr ><td >&nbsp;</td><td class="menuitemleft"></td><td class="menuitem"><a href="/" class="menuitem">News</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/forums.php" class="menuitem">Forums</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/codearcs.php" class="menuitem">Code</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/logs.php" class="menuitem">Logs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/gallery.php" class="menuitem">Gallery</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/sdkspecs.php" class="menuitem">Specs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/search.php" class="menuitem">Search</a></td><td class="menuitemright"></td></tr></table></td><td class="menubarright"></td></tr></table><div class="main"><h1 >Problem with shader and non-shader graphics</h1><a href="forums.php" >BlitzMax Forums</a>/<a href="topics.php?forum=102" >BlitzMax Programming</a>/<a href="#bottom" >Problem with shader and non-shader graphics</a><br><br>
<a name="1245142"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Brucey</td><td align="right"><font class=tiny>(Posted 2014)</font>&nbsp;<a href="#1">[#1]</a></td></tr></table></td></tr><tr ><td class="posttext"> Hallo !<br><br>So I have a module that wants to draw text on the screen using a shader program.<br><br>DrawText draws stuff on the screen until I use the shader, after which DrawText never outputs anything again on subsequent Flips. However, the shader is always able to draw to the screen.<br><br>Is there anything in particular I need to reset in order to get GLMax2D to keep rendering after using a shader program?<br><br>The render section looks like this :<br><pre class=code>
	glBindTexture( GL_TEXTURE_2D, buf-&gt;atlas-&gt;id );

	glUseProgram( buf-&gt;shader );
	
	glUniform1i( glGetUniformLocation( buf-&gt;shader, "texture" ), 0 );
	glUniformMatrix4fv( glGetUniformLocation( buf-&gt;shader, "model" ), 1, 0, buf-&gt;model.data);
	glUniformMatrix4fv( glGetUniformLocation( buf-&gt;shader, "view" ), 1, 0, buf-&gt;view.data);
	glUniformMatrix4fv( glGetUniformLocation( buf-&gt;shader, "projection" ), 1, 0, buf-&gt;projection.data);
	vertex_buffer_render( buf-&gt;buffer, GL_TRIANGLES );
</pre><br><br>Thanks :-) <br><br></td></tr></table><br>
<a name="1245145"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >zoqfotpik</td><td align="right"><font class=tiny>(Posted 2014)</font>&nbsp;<a href="#2">[#2]</a></td></tr></table></td></tr><tr ><td class="posttext"> What are you working on, Brucey? <br><br></td></tr></table><br>
<a name="1245148"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Brucey</td><td align="right"><font class=tiny>(Posted 2014)</font>&nbsp;<a href="#3">[#3]</a></td></tr></table></td></tr><tr ><td class="posttext"> Something called <b><a href="https://github.com/rougier/freetype-gl" target="_blank">FreeType-GL</a></b>. <br><br></td></tr></table><br>
<a name="1245150"></a>

<a name="1245151"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >LT</td><td align="right"><font class=tiny>(Posted 2014)</font>&nbsp;<a href="#4">[#4]</a></td></tr></table></td></tr><tr ><td class="posttext"> Textures should be unbound after use.  I noticed that was missing from the GL2Max2D module, as well.<br><pre class=code>glBindTexture( GL_TEXTURE_2D, 0 );</pre> <br><br></td></tr></table><br>
<a name="1245228"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Brucey</td><td align="right"><font class=tiny>(Posted 2014)</font>&nbsp;<a href="#5">[#5]</a></td></tr></table></td></tr><tr ><td class="posttext"> Okay, so the initial version is under source control now : <a href="https://github.com/maxmods/bah.mod/tree/master/freetypegl.mod" target="_blank">https://github.com/maxmods/bah.mod/tree/master/freetypegl.mod</a><br>(or via SVN).<br><br>The example "benchmark" app has been tested and runs on the 3 core platforms. The disappearing DrawText "feature" still exists, and I've no idea what to reset to make it come back. (you'll see what I mean when you press 2 or 3 in the example app).<br><br>Also note the somewhat improved FPS when running under options 2 and 3. (See console output for values).<br><br>Linux in particular seems to be very slow with DrawText, whereas on my Mac, the difference between 1 and 2 are not so much.<br><br>Fonts render slightly differently with this library because it is taking kerning into account. This is most pronounced in the example with "Y.", where the period sits closer to the vertical than it does with DrawText. In theory, rendering should appear more "natural" with this library than with DrawText. <br><br></td></tr></table><br>
<a name="1245237"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >JoshK</td><td align="right"><font class=tiny>(Posted 2014)</font>&nbsp;<a href="#6">[#6]</a></td></tr></table></td></tr><tr ><td class="posttext"> glUseProgram(0) <br><br></td></tr></table><br>
<a name="1245238"></a>

<a name="1245239"></a>

<a name="1245242"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Derron</td><td align="right"><font class=tiny>(Posted 2014)</font>&nbsp;<a href="#7">[#7]</a></td></tr></table></td></tr><tr ><td class="posttext"> I assume glUseProgram(0) does what I suggested: it detaches the shader from the program again. (EDIT: I suggested it per mail.)<br><br>I added your whole post below the two cases in the "benchmark"-example and it displayed the text accordingly.<br><br><br><br>But I must confess: the BlitzMax-DrawText looks a bit more crisp here... the anti-aliasing is a bit "soft" (maybe it is the subpixel aligning of the draw coordinates for the texture).<br><br><br>The speed improvements are really huge here on linux (for this static text):<br>60fps "blitzmax"<br>420fps "freetypegl draw"<br>1900fps "freetypegl cache draw"<br><br><br>Of course "cache" could be done with vanilla blitzmax too (rendering the glyphs to a TImage and then drawing the image) but that "rendering" would be done using writepixel ... which does not make it that realtime-fancy.<br><br><br><br>bye<br>Ron <br><br></td></tr></table><br>
<a name="1245240"></a>

<a name="1245241"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Kryzon</td><td align="right"><font class=tiny>(Posted 2014)</font>&nbsp;<a href="#8">[#8]</a></td></tr></table></td></tr><tr ><td class="posttext"> Hello.<br>According to the specification, you only need to retrieve the uniform locations after the shader program is linked, so you can store the locations in variables and just reuse them.<br><a href="https://www.opengl.org/sdk/docs/man/docbook4/xhtml/glGetUniformLocation.xml" target="_blank">https://www.opengl.org/sdk/docs/man/docbook4/xhtml/glGetUniformLocation.xml</a><br><br>When the next link command occurs, all uniform locations are modified and need to be queried again. You can facilitate this by making use of a hook like "updateUniformLocations," that you run inside the linking method and that every shader program class is hooked to. <br><br></td></tr></table><br>
<a name="1245244"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Brucey</td><td align="right"><font class=tiny>(Posted 2014)</font>&nbsp;<a href="#9">[#9]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> glUseProgram(0)  <br></div><br>Thanks :-) <br><br></td></tr></table><br>
<a name="1245252"></a>

<a name="1245253"></a>

<a name="1245254"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >JoshK</td><td align="right"><font class=tiny>(Posted 2014)</font>&nbsp;<a href="#10">[#10]</a></td></tr></table></td></tr><tr ><td class="posttext"> Supertip:<br>Add 1.0 / (context width or height) * 0.5 to your vertex coords to get pixel-perfect drawing on 2D objects. <br><br></td></tr></table><br>
<a name="1245314"></a>

<a name="1245317"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Derron</td><td align="right"><font class=tiny>(Posted 2014)</font>&nbsp;<a href="#11">[#11]</a></td></tr></table></td></tr><tr ><td class="posttext"> Could you explain your supertip?<br><br>1.0 / contextDimension = factor for 1 pixel<br><br>so when adding half of this value you move the pixel position to the next subpixel, or maybe you have luck and it hits a real "integer pixel" position. Without "ceiling/flooring" this should not help... so what is missing in my thought?<br><br><br>Another thing: while "Pixel perfect" is possible for the left,top and right,bottom areas (the borders), you cannot achieve this for pixel data on the texture.<br><br>The freetypegl-module does exactly this: it draws the glyphs on a texture. So the plain texture already contains "smoothed glyphs" (subpixel-positioned). To avoid this, each glyph should "beautify" its own texture position). Hinting alone isn't enough. Modern desktops (Windows, Gnome, ...) do more than just relying on the hinting-information.<br><br>PLEASE do not read the above as solely critics... it is a fantastic opportunity for text-heavy applications ... so there is no need to cache the text anylonger (I cache tooltips, datasheets, ... as it shapes off some fps).<br><br><br><br>So your supertip is more of interest for image/sprite-drawing. That freetypgl-thing IS one of these sprites/images.<br><br><br>EDIT2: Just had another look at the output of freetypegl. Brucey mentioned the hinting (the dot after Y -&gt; "Y."). Maybe one should have a look at the last line containing "royal" - dunno if the hinting is broken there - or if the algorithm does something fancy, but for me it almost looks like "roy al" - with a thinspace-unicode-character inbetween).<br><br>But like said... critics on a high level.<br><br><br><br>bye<br>Ron <br><br></td></tr></table><br>
<a name="1245318"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >zoqfotpik</td><td align="right"><font class=tiny>(Posted 2014)</font>&nbsp;<a href="#12">[#12]</a></td></tr></table></td></tr><tr ><td class="posttext"> If there were a fast grabimage, caching would become trivial. <br><br></td></tr></table><br>
<a name="1245321"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Derron</td><td align="right"><font class=tiny>(Posted 2014)</font>&nbsp;<a href="#13">[#13]</a></td></tr></table></td></tr><tr ><td class="posttext"> Instead of transfering the "screen content" you better would have access to some kind of virtual canvas ... so at the end you would not draw everything to your screens canvas but to another canvas - and THIS is then drawn to the screen canvas.<br>Think you could call this "render to texture".<br><br>bye<br>Ron <br><br></td></tr></table><br>
<a name="1245326"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >zoqfotpik</td><td align="right"><font class=tiny>(Posted 2014)</font>&nbsp;<a href="#14">[#14]</a></td></tr></table></td></tr><tr ><td class="posttext"> Ahh I see.  I actually did that for pixeldoubling on the game I wrote in Monkey but I hadn't considered doing something likewise for fast grabimage. <br><br></td></tr></table><br>
<a name="bottom"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td align="right"><a href="http://monkeycoder.co.nz" target="_blank"><img src="/img/monkey2.svg" ></a> <a href="https://github.com/blitz-research" target="_blank"><img src="/img/github.svg" ></a> <a href="https://discord.gg/qJccbSp" target="_blank"><img src="/img/discord.svg" ></a></td></tr></table><br></div><br><table width="100%"><tr><td></body></html lang="en">
