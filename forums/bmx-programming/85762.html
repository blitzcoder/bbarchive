<!DOCTYPE html><html lang="en" ><head ><title >Max2d bottle neck for caustic 2d effect</title><meta name='viewport' content='width=device-width, initial-scale=0.66'><meta name='description' content='language:basic, target:desktop, category:game development'><link rel="styleSheet" href="../skins/granite/style.css" type="text/css"><style type="text/css">div.bbcode {padding: 8px;background: #E5E5E5;color: #000000;border: 1px dashed #B4B4BE;}</style></head><body ><table width=100% cellspacing=0 cellpadding=0><tr ><td class="menubarleft"></td><td class="menubar"><table cellspacing="0" cellpadding="0"><tr ><td >&nbsp;</td><td class="menuitemleft"></td><td class="menuitem"><a href="/" class="menuitem">News</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/forums.php" class="menuitem">Forums</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/codearcs.php" class="menuitem">Code</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/logs.php" class="menuitem">Logs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/gallery.php" class="menuitem">Gallery</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/sdkspecs.php" class="menuitem">Specs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/search.php" class="menuitem">Search</a></td><td class="menuitemright"></td></tr></table></td><td class="menubarright"></td></tr></table><div class="main"><h1 >Max2d bottle neck for caustic 2d effect</h1><a href="forums.php" >BlitzMax Forums</a>/<a href="topics.php?forum=102" >BlitzMax Programming</a>/<a href="#bottom" >Max2d bottle neck for caustic 2d effect</a><br><br>
<a name="970771"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Armitage 1982</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#1">[#1]</a></td></tr></table></td></tr><tr ><td class="posttext"> Hi<br><br>Well I think I arrive to a point were Max2d drawing module is slowing down my game while my code is not necessary bad.<br>Since I can't do nothing about it I need to find quicker way to do this :<br><br><img src="http://img268.imageshack.us/img268/6375/caustic.png"><br><br>I'm blending 2 images in order to give this shiny caustic effect to my water.<br>The problem is that I'm using a height map and so I need to cut every columns into polygons.<br><br>Since those columns changing permanently I need to redraw every polygon each time TWICE :<br>One time with DrawPoly in order to get a blue shape for blending.<br>And then with a DrawTexturedPoly function that use my caustic texture with a GL_TEXTURE_WRAP option (GL_REPEAT and GL_CLAMP).<br><br>The second one is the most power consuming since I have to calculate every UV coordinate to render the texture correctly.<br><br>I was wondering if any of you know a better function in OpenGl to render such textured polygon or maybe if you know the old way in BlitzMax for doing this effect (you know, drawing a region of pixel in a buffer and then render a texture inside like a mask object then render the obtained texture).<br>I remember game using real time caustic effect like this but unfortunately with this method multiplayer splitscreen on low machine slowing down my FPS substantially !<br><br>It's only 2D, should be faster than reflecting water in 3D game huh ?<br>Thanks for any advices. <br><br></td></tr></table><br>
<a name="970886"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Armitage 1982</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#2">[#2]</a></td></tr></table></td></tr><tr ><td class="posttext"> Hum... as a side note !<br><br>This current rendering allow me to achieve a nice effect were the caustic texture UV follow the height-map and give great result when object dive into.<br><br>This would probably not be possible with the old effect idea (as it's more intended to be a flat reflect in most of old game).<br><br>Is reducing the number of column in the height-map or removing the first step (see above) is the only possible way to speed-up this effect ? <br><br></td></tr></table><br>
<a name="970900"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Nate the Great</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#3">[#3]</a></td></tr></table></td></tr><tr ><td class="posttext"> I would say just cut out the first step or optimize your uv coord finding code. <br><br></td></tr></table><br>
<a name="970958"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >ImaginaryHuman</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#4">[#4]</a></td></tr></table></td></tr><tr ><td class="posttext"> Could you just render a single quad of texture to the backbuffer, draw a mask of the water surface into the destination alpha channel, grab the image into a texture, render the texture as one quad.? <br><br></td></tr></table><br>
<a name="970962"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Tommo</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#5">[#5]</a></td></tr></table></td></tr><tr ><td class="posttext"> I guess UV calculation may be not the main bottleneck, because it's just some simple instructions.<br>Did you try polygon culling£¿<br>If you are using GL only, maybe you can try vertex array, that would help a lot. <br><br></td></tr></table><br>
<a name="970971"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >AlexO</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#6">[#6]</a></td></tr></table></td></tr><tr ><td class="posttext"> While I can't really be certain what would be 'slow' about your approach, or what you deem as 'slow' but one thing I find a lot when I'm optimizing Bmax code is:<br><br>Make sure you aren't generating any garbage in the rendering code. If you're using anything like a Vector2 class, etc to help calculate things be sure to cache the object (ie make it a field in the object that uses it in the tight loop), or inline those method calls by doing the x/y calculations manually. Creating objects in tight loops is a big no-no in blitzmax if you want to stay performant.<br><br>But before that, I would measure, measure, <b>measure</b>. Be certain that there isn't anything in your code can can be inadvertently causing bmax's max2D modules to slow down (texture swapping, renderstate changes, etc, etc). <br><br></td></tr></table><br>
<a name="971012"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Armitage 1982</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#7">[#7]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> Could you just render a single quad of texture to the backbuffer, draw a mask of the water surface into the destination alpha channel, grab the image into a texture, render the texture as one quad.?  <br></div><br><br>I would like to try this solution since I could add a true refracting feature with it.<br>Does that mean I must add a GRAPHICS_ALPHABUFFER and use some of the glewinit() advanced functions ?<br><br><div class="quote"> If you are using GL only, maybe you can try vertex array, that would help a lot. <br></div><br>Vertex Array is a good idea, I will examine this possibilities to reduce overhead.<br>I find this example about OGL Vertex Array : <a href="http://www.blitzbasic.com/Community/posts.php?topic=66184" target="_blank">http://www.blitzbasic.com/Community/posts.php?topic=66184</a><br>And you are right with the polygon culling I did it for the whole surrounding object but for each polygon. Could improve the performance a bit :)<br><br><br>When I talk about slowdown is mainly on a 800mhz with 1Go and old ATI radeon 9200 (my referral test machine to minimal config).<br>No problem at all with CPU above 1Ghz. <br><br></td></tr></table><br>
<a name="971032"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Armitage 1982</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#8">[#8]</a></td></tr></table></td></tr><tr ><td class="posttext"> Damned !<br><br>As soon as I'm trying Vertex Array code my GL_QUADS turn to semi-transparent black and even disapear when I use Max2D functions elsewhere in my game !<br>This even if I setup or not a blending mode (cannot produce any color, only black or semi-transparent black !).<br><br><pre class=code>Local Colors:Float[] = [1.0, 0.2, 0.2, 1.0,  ..
			0.2, 0.2, 1.0, 1.0,  ..
			0.8, 1.0, 0.2, 1.0,  ..
			0.5, 1.0, 0.5, 1.0,  ..
			0.8, 0.8, 0.8, 1.0]

glEnableClientState(GL_VERTEX_ARRAY)
glEnableClientState(GL_COLOR_ARRAY)

glColorPointer(3, GL_FLOAT, 0, Colors)

For Local PolyArray:Float[] = EachIn Poly

	glVertexPointer(2, GL_FLOAT, 0, PolyArray)
	glDrawArrays(GL_QUADS, 0, 4)
				
Next

glDisableClientState(GL_VERTEX_ARRAY)
glDisableClientState(GL_COLOR_ARRAY)</pre><br><br>I have several module using OpenGl like CEGUI or GLMAX2D obviously, and at this stage of my game I cannot switch to true OpenGl Driver.<br>Do you know what could produce this bug ??<br><br>I don't know much about All OpenGl Options.<br>I suppose later on If I get rid of that bug I would be able to pass the whole Array of VertexPointer to glVertexPointer ?<br>This would be faster than EachIn within max no ?<br><br><b>EDIT</b><br>I try this : <a href="http://blitzmax.com/Community/posts.php?topic=53361#596500" target="_blank">http://blitzmax.com/Community/posts.php?topic=53361#596500</a><br><pre class=code>glEnable(GL_BLEND)
glBlendFunc(GL_SRC_ALPHA, GL_ONE_MINUS_SRC_ALPHA)</pre><br>But won't help :( My Quads are still Black !<br><br>Also why is my glTexCoordPointer mess up with the correct MAX2D UV coordinate ?<br>My texture is all stretched like if the UV (or S,T) were at different places... <br><br></td></tr></table><br>
<a name="971274"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Armitage 1982</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#9">[#9]</a></td></tr></table></td></tr><tr ><td class="posttext"> I discovered I was using too much of FILTEREDIMAGE for such a slow machine (800mhz, 1Go RAM, ATI radeon 9200).<br>But even knowing that I think this effect still use much performances !<br><br>I will add a level of details option which load special texture responsible of this slowdown with the desired flag.<br>But I still have no clues about the Black Quads rendering and UV problems...<br><br>I suppose using a single Vertex Array Drawing per splitscreen (in multiplayer mode) would really improve performances. <br><br></td></tr></table><br>
<a name="971694"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Armitage 1982</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#10">[#10]</a></td></tr></table></td></tr><tr ><td class="posttext"> Okay !<br><br>I know the source of this major slow down on my old test machine !<br>I was testing the new Glew 1.5.1 last week and forgot to rebuild some of my mod folder like the brl.max2D<br><br>For more information consult this thread : <a href="http://blitzmax.com/Community/posts.php?topic=85518" target="_blank">http://blitzmax.com/Community/posts.php?topic=85518</a><br><br>(Should have try this in a new fresh installation of BlitzMax but without this I would never discover the slowdown differences).<br><br>Currently my code is enough optimized which is great :)<br>No need to read the full manual of OpenGl to find the Vertex Array bug today!<br><br>I will probably switch to a full openGl driver on my next project.<br>This one is too advanced with the Max2D module to change anything more deeply.<br><br>Thanks for your help :) <br><br></td></tr></table><br>
<a name="971740"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Arowx</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#11">[#11]</a></td></tr></table></td></tr><tr ><td class="posttext"> Why even have a government, couldn't we replace most of the elected officials with a few Web 2.0 pages and a twitter feed, then all we would have to do was plug everyone into the internet and let the 'collective' decide....<br><br>Node Adjuct 345684391 of 8045637593<br><br>You know when you have too many IE windows open at once when this happens ;o) <br><br></td></tr></table><br>
<a name="971762"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >markcw</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#12">[#12]</a></td></tr></table></td></tr><tr ><td class="posttext"> I'll have whatever Merx has been eating. <br><br></td></tr></table><br>
<a name="971805"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >TaskMaster</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#13">[#13]</a></td></tr></table></td></tr><tr ><td class="posttext"> LOL<br><br>I'm guessing he accidentally posted in the wrong thread. <br><br></td></tr></table><br>
<a name="bottom"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td align="right"><a href="http://monkeycoder.co.nz" target="_blank"><img src="/img/monkey2.svg" ></a> <a href="https://github.com/blitz-research" target="_blank"><img src="/img/github.svg" ></a> <a href="https://discord.gg/qJccbSp" target="_blank"><img src="/img/discord.svg" ></a></td></tr></table><br></div><br><table width="100%"><tr><td></body></html lang="en">
