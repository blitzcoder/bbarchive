<!DOCTYPE html><html lang="en" ><head ><title >Using callbacks in a DLL</title><meta name='viewport' content='width=device-width, initial-scale=0.66'><meta name='description' content='language:basic, target:desktop, category:game development'><link rel="styleSheet" href="../skins/granite/style.css" type="text/css"><style type="text/css">div.bbcode {padding: 8px;background: #E5E5E5;color: #000000;border: 1px dashed #B4B4BE;}</style></head><body ><table width=100% cellspacing=0 cellpadding=0><tr ><td class="menubarleft"></td><td class="menubar"><table cellspacing="0" cellpadding="0"><tr ><td >&nbsp;</td><td class="menuitemleft"></td><td class="menuitem"><a href="/" class="menuitem">News</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/forums.php" class="menuitem">Forums</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/codearcs.php" class="menuitem">Code</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/logs.php" class="menuitem">Logs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/gallery.php" class="menuitem">Gallery</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/sdkspecs.php" class="menuitem">Specs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/search.php" class="menuitem">Search</a></td><td class="menuitemright"></td></tr></table></td><td class="menubarright"></td></tr></table><div class="main"><h1 >Using callbacks in a DLL</h1><a href="forums.php" >BlitzMax Forums</a>/<a href="topics.php?forum=102" >BlitzMax Programming</a>/<a href="#bottom" >Using callbacks in a DLL</a><br><br>
<a name="764589"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >JoshK</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#1">[#1]</a></td></tr></table></td></tr><tr ><td class="posttext"> I am running one BlitzMax program and calling a DLL written in BlitzMax with it.<br><br>I am experiencing some random variable changes, which only happen when I have an error in a dll.  It usually happens when I forget to add GCEnter() at the start of a dll function, or when I forget to add "win32" to the end of the function declaration.<br><br>However, this is now happening when I use my callback function.  The function accepts a function pointer, then calls that function for every object in the list:<br><pre class=code>Function dll_ForEachTextureGroupDo(fn:Byte Ptr) "win32"
	GCEnter()
	Local callback:Int(handle:Int)
	callback=fn
	For texturegroup:TTextureGroup=EachIn TTextureGroup.list
		If Not callback(texturegroup.handle) Exit
	Next
EndFunction</pre><br><br>The callback looks like this.  (This is a part of the main program):<br><pre class=code>Function Callback:Int(handle:Int)
	Return True
EndFunction</pre><br><br>So the main program sends the function pointer to the dll, and the dll performs the function for all objects in a list.<br><br>And the program is actually going like this:<br><pre class=code>EXE stuff
	DLL stuff
		EXE stuff
	DLL stuff
EXE stuff</pre><br><br>Do I need to add GCLeave() or do anything extra like that before the dll calls the callback? <br><br></td></tr></table><br>
<a name="765161"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >JoshK</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#2">[#2]</a></td></tr></table></td></tr><tr ><td class="posttext"> No comment? <br><br></td></tr></table><br>
<a name="765229"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >TartanTangerine (was Indiepath)</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#3">[#3]</a></td></tr></table></td></tr><tr ><td class="posttext"> No idea with BMAX, I only know c/c++ for DLLS. <br><br></td></tr></table><br>
<a name="765233"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Paul "Taiphoz"</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#4">[#4]</a></td></tr></table></td></tr><tr ><td class="posttext"> Are there any examples of creating a DLL with Max? iv not seen anything of this yet but seen it mentioned a few times. <br><br></td></tr></table><br>
<a name="765304"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Dreamora</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#5">[#5]</a></td></tr></table></td></tr><tr ><td class="posttext"> If you use callbacks don't forget to use GCSuspend and GCResume around the callback when you start using Ptrs to stuff<br><br>Don't know about GCLeave as the DLL stuff is still not officially there but I would say: why not simply test it and see what it does. <br><br></td></tr></table><br>
<a name="765427"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >JoshK</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#6">[#6]</a></td></tr></table></td></tr><tr ><td class="posttext"> Because dll errors do not cause consistent visible errors.  When the stack is screwed up, you get random variable changes and weird stuff. <br><br></td></tr></table><br>
<a name="765449"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >tonyg</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#7">[#7]</a></td></tr></table></td></tr><tr ><td class="posttext"> @Yavin, this has the basics <a href="/posts.php?topic=66616#744496" target="_blank"> here </a> <br><br></td></tr></table><br>
<a name="765457"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >JoshK</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#8">[#8]</a></td></tr></table></td></tr><tr ><td class="posttext"> Hmmmm, I think I will have to avoid callbacks altogether.  I must not understand something crucial, because even using a simple callback results in things like my comboboxes become totally black.  Obviously something is off in the stack or GC, and it is overwriting program memory. <br><br></td></tr></table><br>
<a name="765486"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >JoshK</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#9">[#9]</a></td></tr></table></td></tr><tr ><td class="posttext"> Interesting...<br><br>Here is the section in the dll that calls the callback:<br><pre class=code>	If AppLogCallback&lt;&gt;Null
		'If RETURNSTRING&lt;&gt;Null MemFree RETURNSTRING
		RETURNSTRING=s.tocstring()
		GCSuspend()
		AppLogCallback(RETURNSTRING,flags)
		GCResume()
		Return
	EndIf</pre><br><br>RETURNSTRING is a global byte ptr.  It is used to return a string value from the dll.<br><br>A crash occurs when I use MemFree on the variable RETURNSTRING.  Actually, a crash occurs in a different unrelated function, indicating that this probably screws up memory somewhere.<br><br>What is the proper procedure to use a string this way?  Does the byte ptr need to be freed if I am assigning it to a new CString? <br><br></td></tr></table><br>
<a name="765494"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >JoshK</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#10">[#10]</a></td></tr></table></td></tr><tr ><td class="posttext"> Ha!<br><br>I was using a global variable for all my callbacks, and of course, some callbacks call functions in the main program that set callbacks, so my callback function was getting changed!<br><br>I'm still a little hazy on how byte ptr's should be freed, but I am getting somewhere. <br><br></td></tr></table><br>
<a name="765668"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Dreamora</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#11">[#11]</a></td></tr></table></td></tr><tr ><td class="posttext"> memfree is the correct way to free bytePtr memory.<br><br>But I fear such kind of problems somewhere were to be expected. DLL support is not officially in nor ever mentioned to be anywhere near stable. So what you do is alpha test the feature most likely.<br><br>I'm quite a BM fan, but for DLL I would suggest using PureBasic, because its threadsafe and supports threads and mutexes. Don't know when or if this will ever be added to BM. <br><br></td></tr></table><br>
<a name="765730"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >JoshK</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#12">[#12]</a></td></tr></table></td></tr><tr ><td class="posttext"> Nah, it works great.  You just have to understand a few caveats. <br><br></td></tr></table><br>
<a name="765744"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Dreamora</td><td align="right"><font class=tiny>(Posted 2007)</font>&nbsp;<a href="#13">[#13]</a></td></tr></table></td></tr><tr ><td class="posttext"> Basically, yes, in most cases it works :)<br><br>But that does not always help. And writting wrappers around C++ although its officially supported as "to be importable" is kind of annoying just to prevent the GC from commiting suicide. (if this wrapper is in C or if you do it through management layers in BM does not make a difference out of my sight. Not beeing able to use a C++ object directly without killing the GC in some cases, although I can fully declare it, is a critical problem) <br><br></td></tr></table><br>
<a name="bottom"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td align="right"><a href="http://monkeycoder.co.nz" target="_blank"><img src="/img/monkey2.svg" ></a> <a href="https://github.com/blitz-research" target="_blank"><img src="/img/github.svg" ></a> <a href="https://discord.gg/qJccbSp" target="_blank"><img src="/img/discord.svg" ></a></td></tr></table><br></div><br><table width="100%"><tr><td></body></html lang="en">
