<!DOCTYPE html><html lang="en" ><head ><title >Threading question</title><meta name='viewport' content='width=device-width, initial-scale=0.66'><meta name='description' content='language:basic, target:desktop, category:game development'><link rel="styleSheet" href="../skins/granite/style.css" type="text/css"><style type="text/css">div.bbcode {padding: 8px;background: #E5E5E5;color: #000000;border: 1px dashed #B4B4BE;}</style></head><body ><table width=100% cellspacing=0 cellpadding=0><tr ><td class="menubarleft"></td><td class="menubar"><table cellspacing="0" cellpadding="0"><tr ><td >&nbsp;</td><td class="menuitemleft"></td><td class="menuitem"><a href="/" class="menuitem">News</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/forums.php" class="menuitem">Forums</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/codearcs.php" class="menuitem">Code</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/logs.php" class="menuitem">Logs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/gallery.php" class="menuitem">Gallery</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/sdkspecs.php" class="menuitem">Specs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/search.php" class="menuitem">Search</a></td><td class="menuitemright"></td></tr></table></td><td class="menubarright"></td></tr></table><div class="main"><h1 >Threading question</h1><a href="forums.php" >BlitzMax Forums</a>/<a href="topics.php?forum=102" >BlitzMax Programming</a>/<a href="#bottom" >Threading question</a><br><br>
<a name="1006489"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >GfK</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#1">[#1]</a></td></tr></table></td></tr><tr ><td class="posttext"> I've started using threading to load media for my game and generally it works fine.  But not always.<br><br>I have a 'loading' animation running in the main thread, and load all the assets via LoadImage, Loadsound etc, from a separate thread.  As I said, most of the time this works perfectly well, but maybe once out of 50 or so times, the thread just hangs.<br><br>Due to the frequency of the bug its going to be an absolute ball ache to track down.  Is there some sort of etiquette when using threads that I should know about?<br><br>I'm aware that graphics operations aren't thread-safe (apparently), but all I'm doing is loading stuff into areas of memory that are (as far as I know) not being accessed by another thread.  All of the actual drawing whilst the thread is running, is done from the main thread.<br><br>There'a a bunch of threading stuff I don't understand about, like semaphores and condVars and its not very well explained in the docs, so I don't know if I should be using that or not.  Also I'm only using one thread other than the main one, so do I really need a mutex?  (I tried a mutex already and it made no difference, unless I did it wrong).<br><br>Any help/lowdown on correct usage of threads much appreciated. <br><br></td></tr></table><br>
<a name="1006500"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >BlitzSupport</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#2">[#2]</a></td></tr></table></td></tr><tr ><td class="posttext"> I believe LoadImage works sometimes, but it has ties to the graphics context if I remember rightly, and that may occasionally be causing problems, since the graphics context (particularly in the case of DirectX; not too sure about OpenGL) is not thread-safe.<br><br>I'm not clear from the wording whether you mean you're calling LoadImage in the second thread, but you should be using LoadPixmap in the second thread (since a pixmap is just a block of memory, not tied to the graphics context), then calling LoadImage (loaded_pixmap) from the main thread as each pixmap loads.<br><br>... if that makes sense. <br><br></td></tr></table><br>
<a name="1006508"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >GfK</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#3">[#3]</a></td></tr></table></td></tr><tr ><td class="posttext"> It makes sense but as I understand it, aren't images just loaded into RAM (as pixmaps) until the first time you draw them?  I say this [apart from the fact that i'm sure its been said before] because its perfectly legal in Blitzmax to load all your graphics and then set a graphics mode and start drawing.  So LoadImage can't possibly be tied to the graphics context in any way, can it?<br><br>But if that is the case then I'll probably drop threading completely as implementing it that way would mean a colossal amount of work.  I have around 120 source files and over 20,000 lines of code.<br><br>Anyway, that aside, one thing I did note, is that my loader() function (which plays the loading animation in the main thread, and waits for the loader thread to finish), was waiting for the progress bar I have to hit 100%.  The very last line in the function which loads game assets, sets the progress bar to 100%.<br><br>If I set a global variable from within a thread, is it at all possible that on occasion, the thread might end and the variable may not be set?  If so, then my progress bar will never get to 100% and the whole thing will hang, as it is doing.<br><br>Anyhow, I've restructured my code on that assumption and I'll keep an eye on it for now.  In the meantime I'd like a few more people's takes on this LoadImage thing. <br><br></td></tr></table><br>
<a name="1006516"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >BlitzSupport</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#4">[#4]</a></td></tr></table></td></tr><tr ><td class="posttext"> Looks like you're right on the issue of images only being related to the graphics context when drawn -- I've just looked through TImage and DrawImage, and it looks like it's only when DrawImage calls TImage.Frame that a call to the driver is made. Apologies! <br><br></td></tr></table><br>
<a name="1006553"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >MGE</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#5">[#5]</a></td></tr></table></td></tr><tr ><td class="posttext"> You spend a long time on a game and in the final stages try out threading? It's not worth 1/50 or 1/1000 errors. I would forget about it.<br><br>"But if that is the case then I'll probably drop threading completely as implementing it that way would mean a colossal amount of work. "<br><br>Thank you.<br><br>p.s.  Yes..I'm looking forward to your game!! <br><br></td></tr></table><br>
<a name="1006555"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Brucey</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#6">[#6]</a></td></tr></table></td></tr><tr ><td class="posttext"> Don't you also have to assume that the relevant image loading library code is also thread-safe?<br>If you know for sure that it is (ie. libpng, libjpeg, etc), then time to focus attention on BlitzMax itself. <br><br></td></tr></table><br>
<a name="1006557"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >ImaginaryHuman</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#7">[#7]</a></td></tr></table></td></tr><tr ><td class="posttext"> If you only have one background thread doing the loading and the loading code is just reading a file then I would say libjpeg has absolutely nothing to do with the problem, unless libjpeg itself has a separate problem with being in a thread... but you'd think it would be ok?<br><br>Is there absolutely nothing that the background thread accesses that the main thread might be accessing also? <br><br></td></tr></table><br>
<a name="1006618"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Retimer</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#8">[#8]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> You spend a long time on a game and in the final stages try out threading? It's not worth 1/50 or 1/1000 errors. I would forget about it. <br></div><br><br>Eh, coding is boring without adding a challenge or learning experience to a project. <br><br></td></tr></table><br>
<a name="1006626"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >GfK</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#9">[#9]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> You spend a long time on a game and in the final stages try out threading? <br></div>Its hardly my fault if Blitzmax didn't even have threading when I started it, is it?  Plus...<br><div class="quote"> Eh, coding is boring without adding a challenge or learning experience to a project. <br></div>...what he said.<br><br><div class="quote"> Is there absolutely nothing that the background thread accesses that the main thread might be accessing also? <br></div>Only the var which controls the 'progress' of the progress bar.  But I've catered for that now. <br><br></td></tr></table><br>
<a name="1006637"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >_JIM</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#10">[#10]</a></td></tr></table></td></tr><tr ><td class="posttext"> To be on the safe side you could try loading pixmaps then after the loading is done, convert them to images in the main thread. <br><br></td></tr></table><br>
<a name="1006641"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >GfK</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#11">[#11]</a></td></tr></table></td></tr><tr ><td class="posttext"> Well, I was setting up collision layers in a thread too.  Seems thats unreliable as well so I've just started taking out all the threading stuff as I can live without it. <br><br></td></tr></table><br>
<a name="1006662"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >MGE</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#12">[#12]</a></td></tr></table></td></tr><tr ><td class="posttext"> ...what he said. <br><br></td></tr></table><br>
<a name="1016809"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Danny</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#13">[#13]</a></td></tr></table></td></tr><tr ><td class="posttext"> Not suggesting you should re-implement threading again ;) but could perhaps your problem have anything to do with FreeImage not being thread safe?!<br>As spotted in this one: <a href="http://www.blitzbasic.com/Community/posts.php?topic=88923" target="_blank">http://www.blitzbasic.com/Community/posts.php?topic=88923</a><br><br>Just a thought..<br><br>Danny. <br><br></td></tr></table><br>
<a name="bottom"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td align="right"><a href="http://monkeycoder.co.nz" target="_blank"><img src="/img/monkey2.svg" ></a> <a href="https://github.com/blitz-research" target="_blank"><img src="/img/github.svg" ></a> <a href="https://discord.gg/qJccbSp" target="_blank"><img src="/img/discord.svg" ></a></td></tr></table><br></div><br><table width="100%"><tr><td></body></html lang="en">
