<!DOCTYPE html><html lang="en" ><head ><title >String.fromBytes ... fails outside the MainThread</title><meta name='viewport' content='width=device-width, initial-scale=0.66'><meta name='description' content='language:basic, target:desktop, category:game development'><link rel="styleSheet" href="../skins/granite/style.css" type="text/css"><style type="text/css">div.bbcode {padding: 8px;background: #E5E5E5;color: #000000;border: 1px dashed #B4B4BE;}</style></head><body ><table width=100% cellspacing=0 cellpadding=0><tr ><td class="menubarleft"></td><td class="menubar"><table cellspacing="0" cellpadding="0"><tr ><td >&nbsp;</td><td class="menuitemleft"></td><td class="menuitem"><a href="/" class="menuitem">News</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/forums.php" class="menuitem">Forums</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/codearcs.php" class="menuitem">Code</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/logs.php" class="menuitem">Logs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/gallery.php" class="menuitem">Gallery</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/sdkspecs.php" class="menuitem">Specs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/search.php" class="menuitem">Search</a></td><td class="menuitemright"></td></tr></table></td><td class="menubarright"></td></tr></table><div class="main"><h1 >String.fromBytes ... fails outside the MainThread</h1><a href="forums.php" >BlitzMax Forums</a>/<a href="topics.php?forum=102" >BlitzMax Programming</a>/<a href="#bottom" >String.fromBytes ... fails outside the MainThread</a><br><br>
<a name="1021794"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rozek</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#1">[#1]</a></td></tr></table></td></tr><tr ><td class="posttext"> Hello again!<br><br>Another problem in a multi-threaded application: while it is already well-known, that MaxGUI-related stuff should only be done within the MainThread - did you know that code like<br><br><pre class=code>incbin "Text.txt"
local Text:String = String.fromBytes(IncBinPtr("Text.txt"),IncBinLen("Text.txt"))</pre><br>crashes when the assignment is made in a separate thread?<br><br>This happened to me under Mac OS X, at least (don't yet know about the other platforms)<br><br>Make the assignment in your main thread - afterwards, you may use the "Text" in any (other) thread!<br><br>Are there any other pitfalls like this one? It would be good to know... <br><br></td></tr></table><br>
<a name="1021797"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rozek</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#2">[#2]</a></td></tr></table></td></tr><tr ><td class="posttext"> Hmmm,<br><br>it's probably more complicated: my application now crashes again, somewhere else, but with a similar calling chain. Here is an excerpt of the Mac OS X crash report:<br><br>Thread 4 Crashed:<br>0   libGL.dylib                    	0x92b3f96f glDeleteTextures + 59<br>1   Simulator.debug.mt             	0x002cc3d2 533 + 0<br>2   Simulator.debug.mt             	0x00381bf1 bbObjectFree + 28<br>3   Simulator.debug.mt             	0x0037bde0 collectMem + 674<br>4   Simulator.debug.mt             	0x0037b84f allocMem + 189<br>5   Simulator.debug.mt             	0x0037c103 bbGCAllocObject + 60<br>6   Simulator.debug.mt             	0x00381bbb bbObjectNew + 80<br>7   Simulator.debug.mt             	0x0002d5f2 bb_processEnterFrameEvent + 65<br>8   Simulator.debug.mt             	0x0002f07f 11093 + 43<br>9   Simulator.debug.mt             	0x0002e091 bb_runProject + 152<br>10  Simulator.debug.mt             	0x00219460 330 + 9<br>11  Simulator.debug.mt             	0x0037cafa threadProc + 191<br>12  libSystem.B.dylib              	0x90023d67 _pthread_body + 84<br><br>The pattern looks as if the Garbage Collector would be running and - somehow - invoke "glDeleteTextures" which actually crashes (before, the "String.fromBytes" expression triggered the GC in the same way) <br><br></td></tr></table><br>
<a name="1021806"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Otus</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#3">[#3]</a></td></tr></table></td></tr><tr ><td class="posttext"> Probably a GC induced problem and nothing to do with String.FromBytes. The GC begins to free up objects when you create the String object, and so may run any Delete methods.<br><br>To debug the specific problem you could try <a href="/posts.php?topic=88462#1006339" target="_blank">this debugger hack</a>, which allows thread-debugging. (Use at own risk.) <br><br></td></tr></table><br>
<a name="1021809"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Brucey</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#4">[#4]</a></td></tr></table></td></tr><tr ><td class="posttext"> <pre class=code>
0 libGL.dylib 0x92b3f96f glDeleteTextures
</pre><br>That's interesting :-p<br>The GC is clearing up an object referencing some GL data which you can only affect in the main thread.<br>Bit of a bugger, that. Dunno how you tell the GC to free references of some objects only from the main thread.<br><br>I'd class this under "serious bug". <br><br></td></tr></table><br>
<a name="1021833"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rozek</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#5">[#5]</a></td></tr></table></td></tr><tr ><td class="posttext"> Hmmm,<br><br>my problem looks somewhat similar to that mentioned in <a href="http://www.blitzmax.com/Community/posts.php?topic=88578#1005858" target="_blank">http://www.blitzmax.com/Community/posts.php?topic=88578#1005858</a><br><br>There, a rollback to BlitzMAX 1.34 solved the issue (for the moment, at least)<br><br>And, since that bug is a serious "stopper" for me, I'm currently trying to rollback as well...let's see how far I'll get!<br><br>[edit]<br>Well, BlitzMAX 1.36 still shows the same problem as described above. Currently, I can't rollback further because it turned out that I am using methods which were introduced with version 1.36 - thus, I will first have to implement alternatives for them before being able to proceed (or recede, resp.) <br>[/edit]<br><br>[edit]<br>BlitzMAX 1.35 crashes even sooner - here is an excepert of the Mac OS X crash report:<br><br>Thread 0 Crashed:<br>0   Simulator.debug.mt       	0x0022af02 collectMem + 115<br>1   Simulator.debug.mt       	0x0022b29e allocMem + 117<br>2   Simulator.debug.mt       	0x0022b412 bbGCAllocObject + 51<br>3   Simulator.debug.mt       	0x0022ef79 bbStringFromInt + 210<br>4   Simulator.debug.mt       	0x00209983 _brl_event_TEvent_RegisterId + 74<br>5   Simulator.debug.mt       	0x00209233 122 + 1020<br>6   Simulator.debug.mt       	0x00205b0e 62 + 37<br>7   Simulator.debug.mt       	0x001b58ef 195 + 37<br>8   Simulator.debug.mt       	0x000f1ffe 1246 + 42<br>9   Simulator.debug.mt       	0x000fb68d 306 + 37<br>10  Simulator.debug.mt       	0x000ebc8b 946 + 57<br>11  Simulator.debug.mt       	0x000d6c08 636 + 37<br>12  Simulator.debug.mt       	0x000d6ba8 13 + 37<br>13  Simulator.debug.mt       	0x000d6b48 11 + 37<br>14  Simulator.debug.mt       	0x00005892 3010 + 1147<br>15  Simulator.debug.mt       	0x000035d1 4 + 25<br>16  Simulator.debug.mt       	0x00002fbd run + 77<br>17  com.apple.Foundation     	0x927fab97 _nsnote_callback + 230<br>18  com.apple.CoreFoundation 	0x908563d2 __CFXNotificationPost + 345<br>19  com.apple.CoreFoundation 	0x9084db51 _CFXNotificationPostNotification + 600<br>20  com.apple.Foundation     	0x927f3128 -[NSNotificationCenter postNotificationName:object:userInfo:] + 121<br>21  com.apple.Foundation     	0x927fa0c9 -[NSNotificationCenter postNotificationName:object:] + 55<br>22  com.apple.AppKit         	0x93289976 -[NSApplication _postDidFinishNotification] + 124<br>23  com.apple.AppKit         	0x93289860 -[NSApplication _sendFinishLaunchingNotification] + 67<br>24  com.apple.AppKit         	0x9328935d -[NSApplication(NSAppleEventHandling) _handleAEOpen:] + 273<br>25  com.apple.AppKit         	0x93288f28 -[NSApplication(NSAppleEventHandling) _handleCoreEvent:withReplyEvent:] + 96<br>26  com.apple.Foundation     	0x92800881 -[NSAppleEventManager dispatchRawAppleEvent:withRawReply:handlerRefCon:] + 447<br>27  com.apple.Foundation     	0x928006ab _NSAppleEventManagerGenericHandler + 91<br>28  com.apple.AE             	0x915237c9 aeDispatchAppleEvent(AEDesc const*, AEDesc*, unsigned long, unsigned char*) + 147<br>29  com.apple.AE             	0x915236fa dispatchEventAndSendReply(AEDesc const*, AEDesc*) + 44<br>30  com.apple.AE             	0x915235c6 aeProcessAppleEvent + 190<br>31  com.apple.HIToolbox      	0x92e04084 AEProcessAppleEvent + 37<br>32  com.apple.AppKit         	0x9328711d _DPSNextEvent + 1044<br>33  com.apple.AppKit         	0x93286b37 -[NSApplication nextEventMatchingMask:untilDate:inMode:dequeue:] + 137<br>34  com.apple.AppKit         	0x932808c4 -[NSApplication run] + 512<br>35  Simulator.debug.mt       	0x00003582 main + 1013<br>36  Simulator.debug.mt       	0x000028fe _start + 216<br>37  Simulator.debug.mt       	0x00002825 start + 41<br><br>Very early in my program, I define my own EventIds (for asynchronous thread-to-thread communication), together with a literal description - that's where BlitzMAX crashes (sigh)<br>[/edit]<br><br>[edit]<br>BlitzMax 1.34 crashes not much later than BlitzMAX 1.35 - see the crash report:<br><br>Thread 0 Crashed:<br>0   Simulator.debug.mt       	0x00037657 _bah_cairo_TCairo_Delete + 18<br>1   Simulator.debug.mt       	0x002260b9 collectMem + 437<br>2   Simulator.debug.mt       	0x00226313 allocMem + 117<br>3   Simulator.debug.mt       	0x00226487 bbGCAllocObject + 51<br>4   Simulator.debug.mt       	0x0022a32d bbObjectNew + 34<br>5   Simulator.debug.mt       	0x00204867 _brl_event_TEvent_Create + 101<br>6   Simulator.debug.mt       	0x00204d33 brl_event_CreateEvent + 136<br>7   Simulator.debug.mt       	0x0011566e 121 + 58<br>8   Simulator.debug.mt       	0x001152a5 71 + 8<br>9   com.apple.Foundation     	0x92849cca __NSFireTimer + 199<br>10  com.apple.CoreFoundation 	0x9082d756 CFRunLoopRunSpecific + 3341<br>11  com.apple.CoreFoundation 	0x9082ca42 CFRunLoopRunInMode + 61<br>12  com.apple.HIToolbox      	0x92e01878 RunCurrentEventLoopInMode + 285<br>13  com.apple.HIToolbox      	0x92e00f82 ReceiveNextEventCommon + 385<br>14  com.apple.HIToolbox      	0x92e00dd9 BlockUntilNextEventMatchingListInMode + 81<br>15  com.apple.AppKit         	0x93286f45 _DPSNextEvent + 572<br>16  com.apple.AppKit         	0x93286b37 -[NSApplication nextEventMatchingMask:untilDate:inMode:dequeue:] + 137<br>17  Simulator.debug.mt       	0x00202f04 updateEvents + 273<br>18  Simulator.debug.mt       	0x00202f3b bbSystemWait + 33<br>19  Simulator.debug.mt       	0x0020372b _brl_system_TMacOSSystemDriver_Wait + 51<br>20  Simulator.debug.mt       	0x00200dea 80 + 8<br>21  Simulator.debug.mt       	0x00200428 5 + 35<br>22  Simulator.debug.mt       	0x00008c8f 401 + 18<br>23  Simulator.debug.mt       	0x00003cd1 4 + 25<br>24  Simulator.debug.mt       	0x000036bd run + 77<br>25  com.apple.Foundation     	0x927fab97 _nsnote_callback + 230<br>26  com.apple.CoreFoundation 	0x908563d2 __CFXNotificationPost + 345<br>27  com.apple.CoreFoundation 	0x9084db51 _CFXNotificationPostNotification + 600<br>28  com.apple.Foundation     	0x927f3128 -[NSNotificationCenter postNotificationName:object:userInfo:] + 121<br>29  com.apple.Foundation     	0x927fa0c9 -[NSNotificationCenter postNotificationName:object:] + 55<br>30  com.apple.AppKit         	0x93289976 -[NSApplication _postDidFinishNotification] + 124<br>31  com.apple.AppKit         	0x93289860 -[NSApplication _sendFinishLaunchingNotification] + 67<br>32  com.apple.AppKit         	0x9328935d -[NSApplication(NSAppleEventHandling) _handleAEOpen:] + 273<br>33  com.apple.AppKit         	0x93288f28 -[NSApplication(NSAppleEventHandling) _handleCoreEvent:withReplyEvent:] + 96<br>34  com.apple.Foundation     	0x92800881 -[NSAppleEventManager dispatchRawAppleEvent:withRawReply:handlerRefCon:] + 447<br>35  com.apple.Foundation     	0x928006ab _NSAppleEventManagerGenericHandler + 91<br>36  com.apple.AE             	0x915237c9 aeDispatchAppleEvent(AEDesc const*, AEDesc*, unsigned long, unsigned char*) + 147<br>37  com.apple.AE             	0x915236fa dispatchEventAndSendReply(AEDesc const*, AEDesc*) + 44<br>38  com.apple.AE             	0x915235c6 aeProcessAppleEvent + 190<br>39  com.apple.HIToolbox      	0x92e04084 AEProcessAppleEvent + 37<br>40  com.apple.AppKit         	0x9328711d _DPSNextEvent + 1044<br>41  com.apple.AppKit         	0x93286b37 -[NSApplication nextEventMatchingMask:untilDate:inMode:dequeue:] + 137<br>42  com.apple.AppKit         	0x932808c4 -[NSApplication run] + 512<br>43  Simulator.debug.mt       	0x00003c82 main + 1013<br>44  Simulator.debug.mt       	0x00002ffe _start + 216<br>45  Simulator.debug.mt       	0x00002f25 start + 41<br><br>Thus, it always seems to be a problem related to GC...<br><br>I won't go back any further but publish a bug report instead...<br>[/edit] <br><br></td></tr></table><br>
<a name="1021842"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rozek</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#6">[#6]</a></td></tr></table></td></tr><tr ><td class="posttext"> Hmmm,<br><br>due to the severity of the problem, I have no other chance than to dig into the foundations of BlitzMAX myself (deep sigh)<br><br>Let's see: according to the crash report<br><br>Thread 4 Crashed:<br>0 libGL.dylib 0x92b3f96f glDeleteTextures + 59<br>1 Simulator.debug.mt 0x002cc3d2 533 + 0<br>2 Simulator.debug.mt 0x00381bf1 bbObjectFree + 28<br>3 Simulator.debug.mt 0x0037bde0 collectMem + 674<br>4 Simulator.debug.mt 0x0037b84f allocMem + 189<br>5 Simulator.debug.mt 0x0037c103 bbGCAllocObject + 60<br>6 Simulator.debug.mt 0x00381bbb bbObjectNew + 80<br>7 Simulator.debug.mt 0x0002d5f2 bb_processEnterFrameEvent + 65<br>8 Simulator.debug.mt 0x0002f07f 11093 + 43<br>9 Simulator.debug.mt 0x0002e091 bb_runProject + 152<br>10 Simulator.debug.mt 0x00219460 330 + 9<br>11 Simulator.debug.mt 0x0037cafa threadProc + 191<br>12 libSystem.B.dylib 0x90023d67 _pthread_body + 84<br><br>"bbObjectFree" is one of the last functions called. It is found in "mod/brl.mod/blitz.mod/blitz_object.c":<br><br><pre class=code>void bbObjectFree( BBObject *o ){
	BBClass *clas=o-&gt;clas;
#ifdef BB_GC_RC
	if( o==&amp;bbNullObject ){
		o-&gt;refs=BBGC_MANYREFS;
		return;
	}

	clas-&gt;dtor( o );
	bbGCDeallocObject( o,clas-&gt;instance_size );
#else
	clas-&gt;dtor( o );
#endif
}</pre><br>"bbObjectFree + 28" sounds as if "clas-&gt;dtor( o );" is called which then crashes...<br><br>Is there any possibility to find out what "0x002cc3d2" refers to? (i.e. which function get's called) According to the address, it's definitely part of my program!<br><br>I am using Brucey's Cairo wrapper (which might be the reason why glDeleteTextures get's called - I definitely do not want to indicate that the wrapper is faulty - I'm just trying to find out where the app crashes...) <br><br></td></tr></table><br>
<a name="1021845"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rozek</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#7">[#7]</a></td></tr></table></td></tr><tr ><td class="posttext"> Hmmm,<br><br>let's look at the other threads (just an excerpt for the moment):<br><br><br>Exception:  EXC_BAD_ACCESS (0x0001)<br>Codes:      KERN_PROTECTION_FAILURE (0x0002) at 0x00000ac0<br><br>Thread 0:<br>0   libSystem.B.dylib              	0x9002447f semaphore_wait_trap + 7<br>1   libSystem.B.dylib              	0x9011073c _sigtramp + 49<br>2   libSystem.B.dylib              	0x90024407 semaphore_wait_signal_trap + 7<br>3   Simulator.debug.mt             	0x0037c271 bbGCSuspend + 42<br>4   Simulator.debug.mt             	0x00005362 164 + 24<br>5   Simulator.debug.mt             	0x0036000c 15 + 17<br>6   Simulator.debug.mt             	0x0035fa92 185 + 102<br>7   Simulator.debug.mt             	0x0035caf3 390 + 92<br>8   Simulator.debug.mt             	0x002cc9f0 615 + 31<br>9   Simulator.debug.mt             	0x002cd6e4 _brl_glmax2d_TGLMax2DDriver_CreateFrameFromPixmap + 104<br>10  Simulator.debug.mt             	0x002d9307 141 + 50<br>11  Simulator.debug.mt             	0x002d1421 1296 + 15<br>12  Simulator.debug.mt             	0x00016380 6106 + 71<br>13  Simulator.debug.mt             	0x0000d507 4001 + 22<br>14  Simulator.debug.mt             	0x0000f055 4469 + 248<br>15  Simulator.debug.mt             	0x00016d3b 6253 + 24<br>16  Simulator.debug.mt             	0x0035acfb 142 + 23<br>17  Simulator.debug.mt             	0x00359de6 _brl_event_TEvent_Emit + 66<br>18  Simulator.debug.mt             	0x0035a5a5 354 + 8<br>19  Simulator.debug.mt             	0x001ec81b 216 + 74<br>20  Simulator.debug.mt             	0x001c48d5 901 + 66<br>21  Simulator.debug.mt             	0x001ca2a5 PostGuiEvent + 82<br>22  Simulator.debug.mt             	0x001cc26f -[CanvasView drawRect:] + 140<br><br>What does it mean, when "bbGCSuspend" is called? Does that mean s.th. in this situation? <br><br></td></tr></table><br>
<a name="1021847"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Otus</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#8">[#8]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> "bbObjectFree + 28" sounds as if "clas-&gt;dtor( o );" is called which then crashes...<br><br>Is there any possibility to find out what "0x002cc3d2" refers to? (i.e. which function get's called) According to the address, it's definitely part of my program! <br></div><br>That would be a call to a Delete method of some object. You could put some debug statements into different Delete methods to find out what might be going on.<br><br>If your code is not OS X specific and you want me have a look, you could send be an email. <br><br></td></tr></table><br>
<a name="1021848"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rozek</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#9">[#9]</a></td></tr></table></td></tr><tr ><td class="posttext"> For a short moment,<br><br>I thought I would have found a workaround, namely not explicitly setting<br><pre class=code>setGraphicsDriver(GLMax2DDriver())</pre><br>on the Mac (I still need it under Windows).<br><br>But then, my app crashed again - thread 4 again, and at a similar position as before:<br><br>Thread 4 Crashed:<br>0   libGL.dylib                    	0x92b3f96f glDeleteTextures + 59<br>1   Simulator.debug.mt             	0x002cc3ce 533 + 0<br>2   Simulator.debug.mt             	0x00381bed bbObjectFree + 28<br>3   Simulator.debug.mt             	0x0037bddc collectMem + 674<br>4   Simulator.debug.mt             	0x0037b84b allocMem + 189<br>5   Simulator.debug.mt             	0x0037c0ff bbGCAllocObject + 60<br>6   Simulator.debug.mt             	0x00381bb7 bbObjectNew + 80<br>7   Simulator.debug.mt             	0x0035a17b _brl_event_TEvent_Create + 101<br>8   Simulator.debug.mt             	0x0035a647 brl_event_CreateEvent + 136<br>9   Simulator.debug.mt             	0x0002ee95 395 + 93<br>10  Simulator.debug.mt             	0x0002e08a bb_runProject + 152<br>11  Simulator.debug.mt             	0x0021945c 330 + 9<br>12  Simulator.debug.mt             	0x0037caf6 threadProc + 191<br>13  libSystem.B.dylib              	0x90023d67 _pthread_body + 84<br><br>But the first thread is now at a very different position:<br><br>Thread 0:<br>0   libSystem.B.dylib              	0x9002447f semaphore_wait_trap + 7<br>1   libSystem.B.dylib              	0x9011073c _sigtramp + 49<br>2   libSystem.B.dylib              	0x90009817 mach_msg_trap + 7<br>3   com.apple.CoreFoundation       	0x9082d227 CFRunLoopRunSpecific + 2014<br>4   com.apple.CoreFoundation       	0x9082ca42 CFRunLoopRunInMode + 61<br>5   com.apple.HIToolbox            	0x92e01878 RunCurrentEventLoopInMode + 285<br>6   com.apple.HIToolbox            	0x92e00f82 ReceiveNextEventCommon + 385<br>7   com.apple.HIToolbox            	0x92e00dd9 BlockUntilNextEventMatchingListInMode + 81<br>8   com.apple.AppKit               	0x93286f45 _DPSNextEvent + 572<br>9   com.apple.AppKit               	0x93286b37 -[NSApplication nextEventMatchingMask:untilDate:inMode:dequeue:] + 137<br>10  Simulator.debug.mt             	0x003577f0 updateEvents + 334<br>11  Simulator.debug.mt             	0x003579d7 bbSystemWait + 40<br>12  Simulator.debug.mt             	0x00359064 _brl_system_TMacOSSystemDriver_Wait + 51<br>13  Simulator.debug.mt             	0x00356336 81 + 8<br>14  Simulator.debug.mt             	0x00355974 5 + 35<br>15  Simulator.debug.mt             	0x000087bf 401 + 18<br>16  Simulator.debug.mt             	0x0000385d 4 + 25<br>17  Simulator.debug.mt             	0x0000338b run + 81<br>18  Simulator.debug.mt             	0x000035c3 -[BlitzMaxAppDelegate applicationDidFinishLaunching:] + 355 <br><br></td></tr></table><br>
<a name="1021849"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rozek</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#10">[#10]</a></td></tr></table></td></tr><tr ><td class="posttext"> Otus,<br><br>the problem is that I do not have any (explicit) "d'tor" which invokes "glDeleteTextures".<br><br>Is there any possibility to find out what "0x002cc3ce" refers to? It could be within the "GLMax2DDriver" or somewhere within Brucey's Cairo wrapper. <br><br></td></tr></table><br>
<a name="1021855"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Otus</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#11">[#11]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> Is there any possibility to find out what "0x002cc3ce" refers to? <br></div><br>If I read the trace correctly, it should be a Delete method in some Type, either one defined by you or in a module. There's only one Delete method in Cairo, so that should be easily verifiable by inserting a Print or something there.<br><br>Alternatively, you could use reflection and e.g. print out the address of each Delete method to find which it might be. (This is a bit complicated. You need the _class field of the TTypeId and add the _index of the TMethod and look up the address there.) <br><br></td></tr></table><br>
<a name="1021866"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rozek</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#12">[#12]</a></td></tr></table></td></tr><tr ><td class="posttext"> Otus,<br><br>great idea! Thanks - I'll try that immediately!<br><br>first Result: the "delete" method in Cairo gets indeed called - but not from the crashing thread (I would have expected a meaningful symbol in the crash report anyway in that case, but it says "533" only - does anybody know what that means? a binary compiled without debugging support?)<br><br>second result: TCairo has a method "destroy", which I modified as follows<br><pre class=code>	Method Destroy()
	debuglog("**** a")
		NoContextError()
		cairo_destroy(contextPtr)
		contextPtr = Null
	debuglog("**** b")
	End Method
</pre><br>Adding this pair of "debuglog" calls let my program run much longer than before(!) - although it again crashed in the end (with a report that looks similar to those mentioned above and *NOT* within the "a"..."b" pair)<br><br>Now, I would like to "trace" the routine "cairo_destroy" found in "cairo.c" - do you have any idea how I could do that? E.g., may I write to the BlitzMAX console from within that routine?<br><br>third result: I simply tried to "printf" from within "cairo_destroy" - with success! (great! printf directly writes to the output area - is the output buffered or unbuffered?) Along with some "enter"/"exit" marks I also printed the address of the routine itself: it is definitely not the mysterious "533" function! Depending on the amount of output written, the app sometimes crashes sooner, sometimes later - a typical situation in multi-threaded environments with improper synchronization (but also in environments with improper pointers!) I'm still looking for the crash reason and its solution!<br><br>fourth result: I am now able to predict when my app will crash: it is indeed within the line<br><pre class=code>clas-&gt;dtor( o );</pre>in file "blitz_object.c" where a (still unknown) destructor is called which will finally crash my program. I can check the address of the destructor and - if the "right one" is detected - react somehow. The question is now: is there anything I can do? e.g. printing the current stack trace, entering the debugger etc? (Don't forget that I am deep in some C code!)<br><br>fifth result: if I simply avoid calling the destructor which would crash my app, the program seems to continue running fine (presumably with a memory leak, though) - it is therefore important to find out which destructor is the faulty one! The crash report mentions it as "533" which might indicate that it has been compiled without debugging support (or stems from the operating system?) <br><br></td></tr></table><br>
<a name="1021901"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rozek</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#13">[#13]</a></td></tr></table></td></tr><tr ><td class="posttext"> Well,<br><br>I now have the BBClass structure of the affected objects - how do I find out their type?<br><br>Any ideas? <br><br></td></tr></table><br>
<a name="1021923"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rozek</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#14">[#14]</a></td></tr></table></td></tr><tr ><td class="posttext"> Hmmm,<br><br>meanwhile, I found out how to throw an exception from within C code, which guides me directly to the debugger - but not where the object has been created, but at "waitEvent". By inspecting the object addresses within the debugger, I could not find the affected object (which is obvious as GC only removes objects that are no longer used)<br><br>Thus, I am stuck again - does anybody have an idea how I can find out which (type of) object contains the faulty destructor? <br><br></td></tr></table><br>
<a name="1021966"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rozek</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#15">[#15]</a></td></tr></table></td></tr><tr ><td class="posttext"> Well, I got some results!<br><br>"BBClass" contains a field "debug_scope" which itself contains a field "name" - thus, I simply tried to print that "name" when I found the d'tor which would crash my program.<br><br>And the result of that print command was..."TGLImageFrame"!<br><br>This seems to be the type with the faulty destructor!!!!<br><br>Does anybody know this type? Surprisingly, I can't find it on my machine...is this name constructed at compile/run time and not part of some source? <br><br></td></tr></table><br>
<a name="1021967"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >plash</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#16">[#16]</a></td></tr></table></td></tr><tr ><td class="posttext"> TGLImageFrame can be found in glmax2d.<br>Again, echoing others here, it seems that deconstructors are being called from alternate threads which are doing things that should not be done in said threads.<br>It's not a particularly easy thing to fix. <br><br></td></tr></table><br>
<a name="1021970"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rozek</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#17">[#17]</a></td></tr></table></td></tr><tr ><td class="posttext"> Tim,<br><br>thanks for your hint - I found the type (in contrast to the "search" function on my Mac!?)<br><br>The problem is that I don't have any alternative: I HAVE TO find a solution (workaround or similar) or I can't continue with my development.<br><br>Let's see what I can do... <br><br></td></tr></table><br>
<a name="1021972"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rozek</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#18">[#18]</a></td></tr></table></td></tr><tr ><td class="posttext"> Ok guys,<br><br>thanks for all your help - meanwhile, I have a workaround for my problem (isn't that great!?)<br><br>Here is how it works:<br> - instead of letting glDeleteTextures be called directly, I add a "request" with all relevant data to an "EventQueue"<br> - within my main thread, I repeatedly check that queue and invoke glDeleteTextures whenever necessary<br>As it seems, that glDeleteTextures is only rarely needed, this approach should not be too inefficient (albeit being a nasty workaround)<br><br>Here is the code (in case that anybody will need it as well):<br><br>in mod/brl.mod/glmax2d.mod/glmax2d.bmx:<br><br>- add<pre class=code>import brl.Threads</pre> to the import list at the beginning<br>- look for the line <pre class=code>Type TGLImageFrame Extends TImageFrame</pre><br>- just below, add<pre class=code>  global TexEventId:int         = allocUserEventId("glDeleteTextures Request")
  global TexEventQueue:TEvent[] = new TEvent[0]
  global TexEventMutex:TMutex   = TMutex.create()

  method enqueueTexEvent ()
    TexEventMutex.lock()
      local QueueLength:int = TexEventQueue.length
      TexEventQueue = TexEventQueue[..QueueLength+1]
      TexEventQueue[QueueLength] = createEvent(TexEventId, null, self.name)
    TexEventMutex.unlock()
  end method

  function dequeuedTexEvent:TEvent ()
    TexEventMutex.lock()
      local Result:TEvent = null

      local QueueLength:int = TexEventQueue.length
      if (QueueLength &gt; 0) then
        Result = TexEventQueue[0]
        TexEventQueue = TexEventQueue[1..QueueLength]
      end if
    TexEventMutex.unlock()

    return Result ' might be null - that's ok!
  end function
</pre><br>- look for <pre class=code>Method Delete()</pre><br>- replace the method by <pre class=code>	Method Delete()
		If Not seq Return

		If (seq = GraphicsSeq) then 
' 	    glDeleteTextures(1,Varptr auxName) ' crashes when called outside MainThread()
		  enqueueTexEvent()
		end if
		
		seq=0
	End Method
</pre><br><br>Then rebuild the module - it should build without problems<br><br>In your application: extend the event loop(s) in your main(!) thread as follows<br><pre class=code>    local TexEvent:TEvent = TGLImageFrame.dequeuedTexEvent()
    while (TexEvent &lt;&gt; null)
      local TexName:int = TexEvent.data
'     debuglog("deleting Texture #" + TexName)
      glDeleteTextures(1,Varptr TexName)

      TexEvent = TGLImageFrame.dequeuedTexEvent()
    wend
</pre><br>It is important, that you periodically check for pending "glDeleteTextures" requests (let's say: once a second) otherwise you just created a memory leak...<br><br>This workaround seems to work for me, but it is still...well..."suboptimal", especially, as there might be other destructors out there which might cause similar problems.<br><br>I will post a bug report in a minute <br><br></td></tr></table><br>
<a name="1021982"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rozek</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#19">[#19]</a></td></tr></table></td></tr><tr ><td class="posttext"> Hmmm,<br><br>just as a side note: would it be useful to "embrace" the code snippets shown above with<br><pre class=code>?threaded
  ...
?</pre><br>lines? <br><br>I have only limited insight into the way BlitzMAX-internal modules are compiled - does "?threaded" apply in such a case? Or is it mainly foreseen for compilation of applications?<br><br>Main reason for my thoughts: all the code shown above applies to multi-threaded environments only, of course, and is useless whenever only a single thread is needed. <br><br></td></tr></table><br>
<a name="1058018"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >jtfrench</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#20">[#20]</a></td></tr></table></td></tr><tr ><td class="posttext"> wow rozek --- great analysis of this stuff. I'm going through pretty much the same problem right now and have been in desperate look for an answer as it has pretty much halted development.<br><br>Your patch makes sense, though I'm wondering if there are any other approaches to solving this. dunno yet. <br><br></td></tr></table><br>
<a name="bottom"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td align="right"><a href="http://monkeycoder.co.nz" target="_blank"><img src="/img/monkey2.svg" ></a> <a href="https://github.com/blitz-research" target="_blank"><img src="/img/github.svg" ></a> <a href="https://discord.gg/qJccbSp" target="_blank"><img src="/img/discord.svg" ></a></td></tr></table><br></div><br><table width="100%"><tr><td></body></html lang="en">
