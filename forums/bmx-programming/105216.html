<!DOCTYPE html><html lang="en" ><head ><title >[BMX64] One instance of an app only</title><meta name='viewport' content='width=device-width, initial-scale=0.66'><meta name='description' content='language:basic, target:desktop, category:game development'><link rel="styleSheet" href="../skins/granite/style.css" type="text/css"><style type="text/css">div.bbcode {padding: 8px;background: #E5E5E5;color: #000000;border: 1px dashed #B4B4BE;}</style></head><body ><table width=100% cellspacing=0 cellpadding=0><tr ><td class="menubarleft"></td><td class="menubar"><table cellspacing="0" cellpadding="0"><tr ><td >&nbsp;</td><td class="menuitemleft"></td><td class="menuitem"><a href="/" class="menuitem">News</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/forums.php" class="menuitem">Forums</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/codearcs.php" class="menuitem">Code</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/logs.php" class="menuitem">Logs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/gallery.php" class="menuitem">Gallery</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/sdkspecs.php" class="menuitem">Specs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/search.php" class="menuitem">Search</a></td><td class="menuitemright"></td></tr></table></td><td class="menubarright"></td></tr></table><div class="main"><h1 >[BMX64] One instance of an app only</h1><a href="forums.php" >BlitzMax Forums</a>/<a href="topics.php?forum=102" >BlitzMax Programming</a>/<a href="#bottom" >[BMX64] One instance of an app only</a><br><br>
<a name="1280454"></a>

<a name="1280456"></a>

<a name="1287508"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Grisu</td><td align="right"><font class=tiny>(Posted 2015)</font>&nbsp;<a href="#1">[#1]</a></td></tr></table></td></tr><tr ><td class="posttext"> Hi guys,<br><br>can someone point me to a working code that limits the execution of an exe file to just one instance.<br><br>I tried doing this via a simple ini-file setting. But If my app crashes (which should seldom happen), it can't be run again.<br><br>Would be great to offer such a feature, so that users can en-/disable the behavior "on the fly". <br><br>Grisu <br><br></td></tr></table><br>
<a name="1280455"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >grable</td><td align="right"><font class=tiny>(Posted 2015)</font>&nbsp;<a href="#2">[#2]</a></td></tr></table></td></tr><tr ><td class="posttext"> You can do it with a mutex, there is some old windows only code for this in maxide-ce <a href="http://sourceforge.net/p/blitzmax-ide/code/HEAD/tree/singleinstance.bmx" target="_blank">http://sourceforge.net/p/blitzmax-ide/code/HEAD/tree/singleinstance.bmx</a> <br><br></td></tr></table><br>
<a name="1280503"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >xlsior</td><td align="right"><font class=tiny>(Posted 2015)</font>&nbsp;<a href="#3">[#3]</a></td></tr></table></td></tr><tr ><td class="posttext"> Another option is to query your app for its name immediate after launch:<br>Print appargs[0]<br><br>Then query the list of running processes,  and if you see more than one instance with that name in the list,  immediately exit the program.<br><br>Unexpected crashes won't leave lock files which would prevent other instances. <br><br></td></tr></table><br>
<a name="1280561"></a>

<a name="1280562"></a>

<a name="1280563"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Kryzon</td><td align="right"><font class=tiny>(Posted 2015)</font>&nbsp;<a href="#4">[#4]</a></td></tr></table></td></tr><tr ><td class="posttext"> You can do that with a named mutex like grable mentioned OR a shared memory object (either of these options work). These are all part of "interprocess communication."<br>You know that there's already another instance running when you can't map a shared memory object for writing, or lock the named mutex.<br><br>You can use bah.Interprocess:<br><a href="https://github.com/maxmods/bah.mod/tree/master/interprocess.mod/examples" target="_blank">https://github.com/maxmods/bah.mod/tree/master/interprocess.mod/examples</a> <br><br></td></tr></table><br>
<a name="1280567"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >xlsior</td><td align="right"><font class=tiny>(Posted 2015)</font>&nbsp;<a href="#5">[#5]</a></td></tr></table></td></tr><tr ><td class="posttext"> Shared memory between processes:<br><br><pre class=code>
' By Budman
' Simple program to demonstrate sharing memory between process
' compile as console program and run one or more times the first run sets the 
' shared memory
' additonal runs read it

SuperStrict
Extern "Win32"
    Function CloseHandle:Int(Handle:Int)
	Function MapViewOfFile:Byte Ptr(hFileMappingObject: Int,dwDesiredAccess: Int, dwFileOffsetHigh:Int, dwFileOffsetLow:Int, dwNumberOfBytesToMap:Int)
	Function UnmapViewOfFile:Int(lpBaseAddress: Byte Ptr)
	Function CreateFileMappingA:Int(hFile: Int, lpFileMappingAttributes: Byte Ptr,flProtect:Int, dwMaximumSizeHigh:Int, dwMaximumSizeLow:Int, lpName$z)
	Function GetLastError:Int()
End Extern

Const PAGE_READWRITE : Int=4
Const FILE_MAP_WRITE : Int=2

Type TSharedMemory 
	Field _Handle : Int
	Field _Name   : String
	Field _Size   : Int
    Field _Owner  : Int
	Field _Data   : Byte Ptr

   
	Method Delete()
		Close
	End Method
	Method Open:Int(Name: String, Size: Int)
		Close()
   		_Name = Name
    	_Size = Size
       ' CreateFileMapping, when called with $FFFFFFFF For the hanlde value, creates a region of shared memory }
   		_Handle = CreateFileMappingA($FFFFFFFF, Null, PAGE_READWRITE, 0,_Size,_Name)
    	If _Handle = 0 Then Return False
        _Owner = GetLastError() = 0
       ' We still need To map a pointer To the handle of the shared memory region 
        _Data= MapViewOfFile(_Handle, FILE_MAP_WRITE, 0, 0, _Size)
    	If Not _Data
			Close
			Return False
		End If
		Return True
	End Method 
	Method Close()
  		If _Data
	    	UnmapViewOfFile(_Data);
			_Data=Null
		End If
		If _Handle 
			CloseHandle(_Handle)
			_Handle=0
		End If 		
	End Method
End Type

Print "Test Share Mem"
Local mem:TSharedMemory = New TSharedMemory 


mem.Open("TESTMEM",30)

If mem._Owner
	MemClear mem._Data,30
	Local title:String="Start Blank!"
	Local pTitle:Byte Ptr=title.toCString()
	MemCopy mem._Data,pTitle,title.length+1
	MemFree pTitle
End If 
	
Repeat
If mem._Owner
	
	Print "Getting Title (Owner)"
	Local title : String = string.FromCString(mem._Data)		
	Print "The Title is "+title
	GCCollect()
Else
	Print "Setting Title (Guest)"
	MemClear mem._Data,30
	SeedRnd MilliSecs() 

	Local title:String=Rand(0,100000)
	Local pTitle:Byte Ptr=title.toCString()
	MemCopy mem._Data,pTitle,title.length+1
	MemFree pTitle
	GCCollect()
	mem.close
	End
'	Print "Getting Title"
'	Local title : String = string.FromCString(mem._Data)		
'	Print "The Title is "+title
End If
'Input
'Delay 2000

Forever
mem.Close
</pre> <br><br></td></tr></table><br>
<a name="1280569"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Grisu</td><td align="right"><font class=tiny>(Posted 2015)</font>&nbsp;<a href="#6">[#6]</a></td></tr></table></td></tr><tr ><td class="posttext"> I'd love to keep the footprint of my app light. Using a mutex forces an app to compile in multi-threaded mode, right? <br><br>Will try out grable's code example and see how it goes. <br><br></td></tr></table><br>
<a name="1280581"></a>

<a name="1280582"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Kryzon</td><td align="right"><font class=tiny>(Posted 2015)</font>&nbsp;<a href="#7">[#7]</a></td></tr></table></td></tr><tr ><td class="posttext"> No, threaded-mode I think just uses a different code path in BMax modules, but you can for example use the OS API for threads in a non-threaded BMax build.<br><br>If you're going cross platform, there seems to be this lightweight library that supports named mutexes for this single instance stuff:<br><a href="https://github.com/cubiclesoft/cross-platform-cpp" target="_blank">https://github.com/cubiclesoft/cross-platform-cpp</a><br><br>You would just need to interface it with your BMax code by making use of C-style externs.<br>Since it's an external library, building in the threaded or non-threaded mode would make no difference. <br><br></td></tr></table><br>
<a name="1287504"></a>

<a name="1287510"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Grisu</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#8">[#8]</a></td></tr></table></td></tr><tr ><td class="posttext"> Hello again!<br><br>I'm currently using the code example form here: <a href="http://sourceforge.net/p/blitzmax-ide/code/HEAD/tree/singleinstance.bmx" target="_blank">http://sourceforge.net/p/blitzmax-ide/code/HEAD/tree/singleinstance.bmx</a><br><br>With Brucey's latest BMX 64 release, it stopped working. :(<br><br>Has anyone a code that is compatible with the latest version (and if possible, compiles in non-threaded mode)? As I dropped Linux and Mac support. This only needs to work under Windows.<br><br>Grisu <br><br></td></tr></table><br>
<a name="1287529"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >degac</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#9">[#9]</a></td></tr></table></td></tr><tr ><td class="posttext"> Hi<br>I just looked at the source, I think you need to update some refers...<br><br>in pub.mod/kernel32.bmx Brucey had changed many things<br><br><pre class=code>
Function GlobalAlloc:Byte Ptr(uFlags,dwBytes) '&lt;... before it was an Int
Function GlobalSize(hMem:Byte Ptr)
Function GlobalFree(hMem:Byte Ptr)
Function GlobalLock:Byte Ptr(hMem:Byte Ptr)
Function GlobalUnlock(hMem:Byte Ptr)
</pre><br><br>After I changed to<br><pre class=code>
Local hdrop:Byte Ptr = GlobalAlloc( GHND | GMEM_SHARE, sz)
</pre><br>there's no more errore (here!), now there are error in other part!<br><br>The source code for IDE was written with WinXP/32 in mind... <br><br></td></tr></table><br>
<a name="1287531"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >degac</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#10">[#10]</a></td></tr></table></td></tr><tr ><td class="posttext"> Well, I tried to change step by step every single error reported (the error message is very handy! Brucey did a good job, you can find easy what could be the possible error...)<br><br>One thing I found is that many 'extern' functions seems already defined (but with other return-type or parameter-type) in some BMX module. I changed all the name in singleinstance.bmx (I added an X at GetClassNameW for example) and changed parameter where required.<br><br>The only problem is that I found many errors like the following<br><div class="quote"> <br>Duplicate identifier 'addgadgetitem' found in module 'maxgui.maxgui' and module 'm_locale_language'.<br> <br></div><br>And I think it's a problem with the translator/compiler.<br>I post this (and other) on the proper forum. <br><br></td></tr></table><br>
<a name="1287544"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Brucey</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#11">[#11]</a></td></tr></table></td></tr><tr ><td class="posttext"> Hallo :-)<br><br>I've updated pub.win32 with some of those missing APIs.<br>This is singleinstance.bmx hacked around a bit to work with pointers :<br><textarea class=codebox name="code" wrap=OFF readonly="true" rows="15" cols="80">

Import PUB.Win32

SuperStrict

?Win32
Private
Global Mutex:Byte Ptr
Public

OnEnd ReleaseInstance

Function ReleaseInstance()
	If Mutex Then
		ReleaseMutex( Mutex)
		Mutex = 0
	EndIf
EndFunction
?

Function InitSingleInstance:Int( name:String)
?Win32
	Const ERROR_ALREADY_EXISTS:Int = 183
	Mutex = CreateMutexW( Null, True, name)
	If (Not Mutex) Or (GetLastError() = ERROR_ALREADY_EXISTS) Then Return False
?
	Return True
EndFunction

Function SendOpenFileMessage:Int( classname:String, title:String, fn:String[])
?Win32
	Const DROPFILES_SIZE:Int = 16
	Const GHND:Int = 32
	Const GMEM_SHARE:Int = 8192
	
	' this function checks each window and compares CLASSNAME &amp; partial WINDOWTITLE

	Function EnumProc:Int( hwnd:Byte Ptr, lparam:size_t Ptr) "win32"
		Local buf:Short[512]
		
		GetClassNameW( hwnd, buf, buf.Length)
		If String.FromWString(buf) = String.FromWString(Short Ptr lparam[0]) Then
			GetWindowTextW( hwnd, buf, buf.Length)
			If String.FromWString(buf).StartsWith( String.FromWString(Short Ptr lparam[1])) Then
				lparam[2] = size_t(hwnd)
				Return False
			EndIf
		EndIf
		Return True
	EndFunction

	' enumerate over all windows and find the one we want
	Local enumdata:size_t[3]
	enumdata[0] = size_t(classname.ToWString())
	enumdata[1] = size_t( title.ToWString())
	EnumWindows( EnumProc, enumdata)
	MemFree Byte Ptr enumdata[0]
	MemFree Byte Ptr enumdata[1]
	
	If Not enumdata[2] Then Return False
	Local hwnd:Byte Ptr = Byte Ptr(enumdata[2])
	
	' check that the executables are the same
	Local buf:Short[512], myexe:String, otherexe:String
	GetModuleFileNameW( 0, buf, buf.Length)
	myexe = String.FromWString(buf)
	GetWindowModuleFileNameW( hwnd, buf, buf.Length)
	otherexe = String.FromWString(buf)
	If myexe &lt;&gt; otherexe Then Return False
	
	' activate and show the window
	SetForegroundWindow( hwnd)
	If IsIconic(hwnd) Then ShowWindow( hwnd, SW_RESTORE)
	
	' send file drop message
	If fn Then
		' get size of all filenames
		Local fsz:Int
		For Local s:String = EachIn fn
			fsz :+ s.Length + 1
		Next
		' create HDROP data
		Local sz:Int = DROPFILES_SIZE + fsz + 1
		Local hdrop:Byte Ptr = GlobalAlloc( GHND | GMEM_SHARE, sz)
		Local p:Byte Ptr = GlobalLock(hdrop)
		If Not p Then
			GlobalFree(hdrop)
			Return False
		EndIf
		MemClear p, sz
		Int Ptr(p)[0] = DROPFILES_SIZE
		' copy all filenames to HDROP data
		p :+ DROPFILES_SIZE
		For Local s:String = EachIn fn
			Local cstr:Byte Ptr = s.ToCString()
			MemCopy p, cstr, s.Length
			MemFree cstr
			p :+ s.Length + 1
		Next
		GlobalUnlock(hdrop)
		
		' send message
		PostMessageA( hwnd, WM_DROPFILES, hdrop, 0)
		GlobalFree(hdrop)
	EndIf
?
	Return True
EndFunction
</textarea><br>It compiles okay, but I'm not sure about the file drop message stuff at the end. Might need done properly (as an HDROP type?)<br>I used a size_t type for the enumdata array so that it can scale properly for 32-bit and 64-bit.<br>I also added "win32" to the EnumProc() callback function so that the compiler produces the correct stdcall code for it. <br><br></td></tr></table><br>
<a name="1287572"></a>

<a name="1287573"></a>

<a name="1287575"></a>

<a name="1287576"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >dw817</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#12">[#12]</a></td></tr></table></td></tr><tr ><td class="posttext"> Hi Grisu:<br><br>I gave a brief thought about you opening a dummy file, and YES, if it crashed, it would be a problem. But with THIS program even if the executable crashes, it will work correctly and cannot hang or incorrectly think another task is open under any circumstances.<br><br>So - here is some code I wrote to determine if it's a first run, and it's small too. :)<br><br><textarea class=codebox name="code" wrap=OFF readonly="true" rows="15" cols="80">
Strict
Global fp:TStream,e
Graphics 640,480
SetScale 3,3
e=DeleteFile("busy") ' try to delete it
If e=0 ' if cannot, then it must be open by another task
  DrawText "Already running !",50,50
  DrawText "Press any key to exit",50,100
  Flip
  WaitKey
  End
EndIf
fp=WriteStream("busy") ' open dummy file
WriteLine fp,"" ' =LEAVE= it open
Repeat
  SetColor Rand(0,255),Rand(0,255),Rand(0,255)
  Plot Rand(640),Rand(480)
  SetColor 255,255,255
  DrawText "Running ...",50,50
  DrawText "Press SPACEBAR To Exit",50,100
  Flip
Until KeyDown(32)
CloseStream(fp) ' shutting down, close file
DeleteFile("busy") ' delete it too
</textarea><br><br>Please let me know if this covers what you need. <br><br></td></tr></table><br>
<a name="1287600"></a>

<a name="1287601"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >BlitzSupport</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#13">[#13]</a></td></tr></table></td></tr><tr ><td class="posttext"> I think a 'lockfile' approach like dw817's here would probably be the easiest cross-platform option.<br><br>I've used a similar setup on a Linux server, via PHP, and it seemed to work very well: incoming Monkey source code sent from a web-based editor would lock an empty file (waiting for lock if currently in-use), build a HTML5 project in a single folder (which was the resource to be protected from shared usage), send the .js back to the requester, then unlock the build file, all of which took a fraction of a second. <br><br></td></tr></table><br>
<a name="1287616"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >xlsior</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#14">[#14]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> I think a 'lockfile' approach like dw817's here would probably be the easiest cross-platform option. <br></div><br><br>Depends on your point of view -- how do you deal reliably with left-over lockfiles that may be left in place due to unexpected applicaiton crashes, manually ended tasks, power outages, etc. where the lockfile didn't get cleaned up by the program that was in charge of it?<br><br>Next time you run the app it would see the existing lock file, think there's already a copy running, and terminate itself. How do you recover from that other than manually removing the lock file? <br><br></td></tr></table><br>
<a name="1287628"></a>

<a name="1287629"></a>

<a name="1287630"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >BlitzSupport</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#15">[#15]</a></td></tr></table></td></tr><tr ><td class="posttext"> What's your better <u>cross-platform</u> alternative? There are countless options if you disregard non-Windows platforms.<br><br>[EDIT: Also, if the holding program has crashed, the locking program shouldn't actually have any problem acquiring a lock/deleting the file as in dw***'s example.] <br><br></td></tr></table><br>
<a name="1287632"></a>

<a name="1287637"></a>

<a name="1287638"></a>

<a name="1287639"></a>

<a name="1287640"></a>

<a name="1287641"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >dw817</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#16">[#16]</a></td></tr></table></td></tr><tr ><td class="posttext"> Xlsior, I appreciate your attempt at a downplay to my solution but if you look carefully, even if the computer manages to crash as royally as you described, it won't matter. The file is only locked so long as the EXE is running.<br><br>The check file can exist or not when you run the program, it makes no difference.<br><br>Once the EXE is removed from running, by any means possible, normal shutdown or hot flying bullet through the motherboard, then the hold on the file is always released. This is true with ANY application that has a file open.<br><br>If, however, your main program DOES lock and will not shut down, then you should NOT be attempting to run an additional copy in the first place ! That WAS the reason you wrote the code to begin with, was it not ? You need to bring up task manager and shut down the offending main program. This is true with any application that locks.<br><br>If you want to bypass your check of a single instance, you can do this via adding code to check a simple command string. I could write this code if you want to cover this instance.<br><br>I think the word you are looking for is Checkmate, Xlsior. And yes, I do indeed play a fair game of chess. :)<br><br>. . .<br><br>Hey, BlitzSupport, glad you like my solution. Sometimes you just gotta make things easy, or as CHRIS tells me, KISS. Keep It Simple Stupid.<br><br>I also wrote you a PM, please let me know what is happening on your end, and I love your usage of asterisks !<br><br>And really, what is an Asterisk ? A wildcard. It always has been, and I resemble that remark. Thanks !!<br><br>Just watch out for the Asterisk Police. They are in strong force this season. <br><br></td></tr></table><br>
<a name="1287649"></a>

<a name="1287689"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Grisu</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#17">[#17]</a></td></tr></table></td></tr><tr ><td class="posttext"> Thanks a lot for your support guys! <br><br>I'm going to use Brucey's version. Together with his module updates it works fine. Also running 32 Bit vs 64 Bit an app is recognised. <br><br>@dw817: Will keep your solution as well for future projects. It's always nice to have different methods for a problem in store. <br><br></td></tr></table><br>
<a name="1287675"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Derron</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#18">[#18]</a></td></tr></table></td></tr><tr ><td class="posttext"> @dw817 and post #12<br><br>What is it supposed to do?<br><br>I run it twice simultaneously:<br><img src="http://abload.de/img/singleinstanceqcq0f.png"><br><br><br>I assume, your solution only works when running Windows OS - and only as long as it does handle files like it is handling currently.<br><br>On Linux you are able to "delete" a file (aka "moving to trash") or just move it to another location - applications having a file handle to it transparently are using the new location then.<br><br>So your code won't work on Linux - because the app is able to "delete" the file and the other instance is still having valid access to this file then.<br><br><br>Did not check "Mac OS" now, but I think it handles files similar to Linux.<br><br><br><br><br>Regarding crashing apps you might do something in the likes of:<br>- during execution update your lockfile with a timestamp (eg. every 10 seconds)<br>- when starting up, check if there exists a lockfile<br>- - if the lockfile exists and the timestamp is "younger than 10 seconds", another app is running, or it crashed a short time ago (you then either wait the time-difference and check again, or you prompt a "did your app crash"-dialogue to the user which allows for convenient restarts including a lockfile-removal)<br>- - if the lockfile does not exist, start as usual<br><br>if you cannot delete your lockfile, the app might really still be running (but not drawing the gui anymore - like an partial hanging app), in this case you should give the user the hint, where to manually delete the lockfile if he is really sure that there is no stalled instance of the app.<br><br><br>The "10 seconds" is an adjustable time frame - it depends on how time critical it is (eg for single instance scripts run automatically - compared to a user application which is started by a mouse click). Do not forget, that this would kill any power saving functionality for your hard discs).<br><br><br>bye<br>Ron <br><br></td></tr></table><br>
<a name="1287697"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >dw817</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#19">[#19]</a></td></tr></table></td></tr><tr ><td class="posttext"> Hi Ron. I would check. I'd be very surprised if ANY operating system allows you to delete a file that is already open and contains data from a separate program. Surprise me. Check it.<br><br>If for some reason you can run =2= copies of my program simultaneously, that is a serious handicap of the operating system to permit deletion of an open file that already has data in it.<br><br>And that would not be an error on my part - but the operating system, or possibly BlitzMAX for permitting it. <br><br></td></tr></table><br>
<a name="1287699"></a>

<a name="1287700"></a>

<a name="1287702"></a>

<a name="1287703"></a>

<a name="1287704"></a>

<a name="1287708"></a>

<a name="1287711"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Derron</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#20">[#20]</a></td></tr></table></td></tr><tr ><td class="posttext"> I wont discuss with you about this topic.<br><br>I just said what is happening, and that the given solution might not work on all OS.<br><br>My proposal instead is trying to avoid this problem but of course adds other disadvantages (more file accesses).<br><br><br>Regarding potential bugs in BlitzMax:<br><br><pre class=code>
$ pidof running1
12901

$ lsof -a -p 12901
COMMAND    PID  USER   FD   TYPE             DEVICE SIZE/OFF     NODE NAME
running1 12901 ronny  cwd    DIR                8,7    16384  3686414 /home/ronny/PATH/testcodes
running1 12901 ronny  rtd    DIR                8,6     4096        2 /
running1 12901 ronny  txt    REG                8,7  1182359  3706202 /home/ronny/PATH/testcodes/running1

[...] 
running1 12901 ronny   19w   REG                8,7        0  3706207 /home/ronny/PATH/testcodes/busy
</pre><br><br>So while running, the file connection is kept alive.<br><br><br>Now if I run the second instance:<br><pre class=code>
$ lsof -a -p 12901
COMMAND    PID  USER   FD   TYPE             DEVICE SIZE/OFF     NODE NAME
[...]
running1 12901 ronny   19w   REG                8,7        0  3706207 /home/ronny/PATH/testcodes/busy (deleted)
</pre><br>important: "(deleted)"<br><br>For linux and working with file handles: <br><a href="http://stackoverflow.com/questions/2028874/what-happens-to-an-open-file-handler-on-linux-if-the-pointed-file-gets-moved-de" target="_blank">http://stackoverflow.com/questions/2028874/what-happens-to-an-open-file-handler-on-linux-if-the-pointed-file-gets-moved-de</a><br><br>Maybe it is done this way, to avoid data loss (one app is working with fileA and another one tries to clean up fileA meanwhile).<br><br><br>Albeit it is not intended, it is to state, that your solution is then no solution for linux - and as this is the expected behaviour of Linux OS, it is not "their" (linux dev) problem, but the problem of the one trying to limit its app to a single instance.<br><br>Edit:<br>I think for Linux you should use some file-locking functionality provided by the OS (you might know it from other languages: "flock" or "fcntl").<br>But even then, "flock" might have issues with the "unlink()" command used to remove files.<br><br><br>Edit2:<br>Instead of using a file it might be interesting to use a socket-lock (your process tries to register to a specific "inet socket" and if this is not possible: either an other app is blocking it - or another instance of "our" app).<br>Nonetheless: better use Brucey's code as this is avoids race conditions and other problems. (renaming the app is then of course still possible) <br><br>bye<br>Ron <br><br></td></tr></table><br>
<a name="1287747"></a>

<a name="1287751"></a>

<a name="1287754"></a>

<a name="1287757"></a>

<a name="1287758"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >dw817</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#21">[#21]</a></td></tr></table></td></tr><tr ><td class="posttext"> No, I'm not accepting that, Derron. Let's make a few "user-friendly" changes to the code that should fix it.<br><br>If the system returns back a flag that says the file does not exist after we 'delete' it and it is already open by another task, then quite simply a few things are taking place.<br><br>1. Most likely by running the file, the 'directory' where it is run is different than where the file is stored. We can fix this easily by returning our running directory.<br><br>2. More serious, BlitzMAX is returning an invalid result for a deleted file. Let's add code to ensure it even exists after deletion.<br><br><textarea class=codebox name="code" wrap=OFF readonly="true" rows="15" cols="80">
'    ______________________________________
'   //                                   //
'  //    First Instance v0.02           //
' //    Written by David W - 01/03/16  //
'//___________________________________//

Strict
Global fp:TStream,e,x,cd$=CurrentDir$()
If Right$(cd$,1)&lt;&gt;"\" Then cd$:+"\"
Graphics 640,480
SetScale 3,3
e=DeleteFile(cd$+"busy") ' try to delete it
x=FileType(cd$+"busy") ' see if it exists
If e=0 Or x=1 ' if failure, then it must be open by another task
  DrawText "Already running !",50,50
  DrawText "Press any key to exit",50,100
  Flip
  WaitKey
  End
EndIf
fp=WriteStream(cd$+"busy") ' open dummy file
WriteLine fp,"" ' =LEAVE= it open
Repeat
  SetColor Rand(0,255),Rand(0,255),Rand(0,255)
  Plot Rand(640),Rand(480)
  SetColor 255,255,255
  DrawText "Running ...",50,50
  DrawText "Press SPACEBAR To Exit",50,100
  Flip
Until KeyDown(32)
CloseStream(fp) ' shutting down, close file
DeleteFile(cd$+"busy") ' delete it too
</textarea> <br><br></td></tr></table><br>
<a name="1287765"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Brucey</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#22">[#22]</a></td></tr></table></td></tr><tr ><td class="posttext"> <pre class=code>If Right$(cd$,1)&lt;&gt;"\" Then cd$:+"\"</pre><br>Those slashes are not *nix friendly... <br><br></td></tr></table><br>
<a name="1287766"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Derron</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#23">[#23]</a></td></tr></table></td></tr><tr ><td class="posttext"> This does not help either.<br><br>If you have an instance running which holds "busy" open... and another one then is trying to delete the file, the returned value will be "1" (aka successful).<br>An later added filetype() of course mentions the non-existance of the "busy" file.<br><br>If you would now switch back to the first instance, an potential still existing file handle would be valid and working. An filetype() call in that first instance would lead to the same result than the second instance though.<br><br>This is one of the reasons why people tend to describe lockfiles as flawed.<br><br>Bye<br>Ron <br><br></td></tr></table><br>
<a name="1287771"></a>

<a name="1287773"></a>

<a name="1287776"></a>

<a name="1287777"></a>

<a name="1287778"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >dw817</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#24">[#24]</a></td></tr></table></td></tr><tr ><td class="posttext"> Well that's a puzzling thing there, Ron. That's my good bag of tricks on the subject and if that particular OS you are using is going to break the rules of normal file handling, I can't fix that kind of black magic.<br><br>It works for Windows though, likely all the way back to Win95. I am now immensely curious to see ANY source code that can solve this little puzzle.<br><br>BTW, the simple example that GRISU was referring to earlier would be something like this:<br><textarea class=codebox name="code" wrap=OFF readonly="true" rows="15" cols="80">
' Simple First Instance
Strict
Global fp:TStream
Graphics 640,480
SetScale 3,3
If FileType("busy")=1 ' if this marker file exists
  DrawText "Already running !",50,50
  DrawText "Press any key to exit",50,100
  Flip
  WaitKey
  End
EndIf
fp=WriteStream("busy") ' open marker file that we're active
WriteLine fp,""
CloseStream fp ' close it, we're not locking it
Repeat
  SetColor Rand(0,255),Rand(0,255),Rand(0,255)
  Plot Rand(640),Rand(480)
  SetColor 255,255,255
  DrawText "Running ...",50,50
  DrawText "Press SPACEBAR To Exit",50,100
  Flip
Until KeyDown(32)
DeleteFile("busy") ' delete marker file
</textarea><br><br>That should work for =ALL= operating systems. The disadvantage, you need to delete the "busy" file if the program crashes or exits prematurely. If this solution is chosen, that previous information about deleting the marker file manually in case of a crash should be included in the instructs. <br><br></td></tr></table><br>
<a name="1287781"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >xlsior</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#25">[#25]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> and if that particular OS you are using is going to break the rules of normal file handling, I can't fix that kind of black magic <br></div><br><br>It's not really "breaking the rules" since the normal behavior under Linux has always been different than under Windows. <br><br></td></tr></table><br>
<a name="1287790"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Derron</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#26">[#26]</a></td></tr></table></td></tr><tr ><td class="posttext"> Like xlsior already pointed out, this is no black magic, this is common behaviour for multiple OS. Seems Mac OS also only removes a file if all handles got closed/freed.<br><br>That is why Brucey's code box contains "process peeking", which is one of the other solutions (drawback is that a rename of the app will circumvent the identification).<br><br>At the end it is best, to use at least 2 of the available options: a lockfile approach, an inet_socket (multiple sockets option, so other apps might block one then...) or process peeking.<br><br><br>Back to your code: <br>- "\" as path separator is only working for Windows, while "/" works for Linux/Mac/Windows<br>- using "CurrentDir()" gets circumvented if you have a self-contained file and copy it to somewhere else (similar to process peeking and process renaming), you better use an absolute path (your application data folder on win, on linux its "/home/username/.config/yourapp/datafiles.*")<br>- DeleteFile(file) returns "1" (true) even if there was no file :<br><pre class=code>
print "filetype = " + FileType("busy")
e=DeleteFile("busy") ' try to delete it
print "deletefile = " + e
</pre><br><br><pre class=code>
[100%] Linking:running1
Executing:running1
filetype = 0
deletefile = 1
</pre><br><br>This is of course avoidable if you change it to `if FileType("busy") = 1 then e = DeleteFile("busy")` (so the "e" keeps initialized as "0" if it is not existing). One might call it a bug in BlitzMax, but maybe "DeleteFile()" is returning whether it failed (file still there, or did not fail - file is now gone).<br><br><br><br>You see: it is not as easy as it first seemed to be. Of course the KISS  thing would say: use that simple filelock-check and if it seems already to run, present the user a dialogue informing: "app is running. If you are sure it is not, remove the lockfile placed at PATH".<br><br><br>bye<br>Ron <br><br></td></tr></table><br>
<a name="1287851"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >dw817</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#27">[#27]</a></td></tr></table></td></tr><tr ><td class="posttext"> Well now, Ron and Xlsior, BlitzMAX does have the ability of retrieving it's own filename if that will help. This was something I needed back in S2 to directly append binary data on the end of the main EXE.<br><br>Let's see ... in BlitzMAX, that is:<pre class=code>print appfile$</pre>Which also includes the hard directory it is being run from.<br><br>As for the forward and backward slash, I did not know this. I'm pretty Sure Windows 95 and maybe Windows XP will be unhappy with a forward slash. Is there any reason to have a backslash except to separate directories ? Is a backslash a real error on other operating systems ? <br><br></td></tr></table><br>
<a name="1287858"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Derron</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#28">[#28]</a></td></tr></table></td></tr><tr ><td class="posttext"> A backslash is a "real error" on other OS, yes.<br><br>Dunno if BMax has a builtin function but you could do<br><br>?Win32<br>global dirSeparator:string = "\"<br>?not Win32<br>global dirSeparator:string = "/"<br>?<br><br>XP does fine with "/", as I am using this for some cross-platform tools.<br><br><br>@own filename<br>You will have to use the whole call URI (path + binary name) to distinguish between "copies". <br><br>@appending data<br>What do AntiVirus-Tools say to this behaviour (serious question) ?<br><br><br>bye<br>Ron <br><br></td></tr></table><br>
<a name="1287864"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >dw817</td><td align="right"><font class=tiny>(Posted 2016)</font>&nbsp;<a href="#29">[#29]</a></td></tr></table></td></tr><tr ><td class="posttext"> Hi Ron. That function, appfile$, does return the entire URL (path+binary name).<br><br>Appending data is only something I did to start with. Me and Chris had a long talk about coding ethics and finally convinced me that I can keep my data files separate.<br><br>Back on Commodore Amiga though, it was quite a thrill to run a tiny single binary program and have it animate the screen wildly and play tinny binary music. :)<br><br>In S2, I did binary attach a ton of stuff to the main EXE, no anti-virus raised a flag, nor the 200-some odd people who downloaded it, built world files in it, and sent them back to me.<br><br>Nonetheless, it's a pain to do, to keep track of it all, to build your own VTOC. I can still write code like that today, but there really is no need as many MANY games written today do not attach all their media to the main EXE.<br><br>It's also not really necessary since BlitzMAX can attach many other files. The main purpose I was attaching binary in BlitzMAX was to create unique and new executables that contained morphing world data from other sources.<br><br>Now if BlitzMAX had a unique in-house compiler built for runtime to allow you to create new separate EXEs, that would certainly circumvent any need for me to do binary extension attachments. <br><br></td></tr></table><br>
<a name="bottom"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td align="right"><a href="http://monkeycoder.co.nz" target="_blank"><img src="/img/monkey2.svg" ></a> <a href="https://github.com/blitz-research" target="_blank"><img src="/img/github.svg" ></a> <a href="https://discord.gg/qJccbSp" target="_blank"><img src="/img/discord.svg" ></a></td></tr></table><br></div><br><table width="100%"><tr><td></body></html lang="en">
