<!DOCTYPE html><html lang="en" ><head ><title >Anyone has any issues with Max crashing on 64 bit</title><meta name='viewport' content='width=device-width, initial-scale=0.66'><meta name='description' content='language:basic, target:desktop, category:game development'><link rel="styleSheet" href="../skins/granite/style.css" type="text/css"><style type="text/css">div.bbcode {padding: 8px;background: #E5E5E5;color: #000000;border: 1px dashed #B4B4BE;}</style></head><body ><table width=100% cellspacing=0 cellpadding=0><tr ><td class="menubarleft"></td><td class="menubar"><table cellspacing="0" cellpadding="0"><tr ><td >&nbsp;</td><td class="menuitemleft"></td><td class="menuitem"><a href="/" class="menuitem">News</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/forums.php" class="menuitem">Forums</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/codearcs.php" class="menuitem">Code</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/logs.php" class="menuitem">Logs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/gallery.php" class="menuitem">Gallery</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/sdkspecs.php" class="menuitem">Specs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/search.php" class="menuitem">Search</a></td><td class="menuitemright"></td></tr></table></td><td class="menubarright"></td></tr></table><div class="main"><h1 >Anyone has any issues with Max crashing on 64 bit</h1><a href="forums.php" >BlitzMax Forums</a>/<a href="topics.php?forum=102" >BlitzMax Programming</a>/<a href="#bottom" >Anyone has any issues with Max crashing on 64 bit</a><br><br>
<a name="981704"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >sswift</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#1">[#1]</a></td></tr></table></td></tr><tr ><td class="posttext"> A publisher I've submitted Space Beetles to has indicated that the game crashed their Mac when they were running an XP emulator or something, and a test on a 64bit Vista installation crashed as well.  The game runs fine otherwise.<br><br>Any ideas what might cause this issue?  Also, I've heard there's a way to run games in some kind of 32bit emulation layer in Vista?  How does one go about enabling that for a particular game? <br><br></td></tr></table><br>
<a name="981729"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Arowx</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#2">[#2]</a></td></tr></table></td></tr><tr ><td class="posttext"> I think in blitzmax the game is only built as a 32bit application so run's on 64bit Vista systems as a 32bit app by default, the OS works out that it's 32bit and runs it accordingly. <br><br></td></tr></table><br>
<a name="981732"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >GfK</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#3">[#3]</a></td></tr></table></td></tr><tr ><td class="posttext"> Yep, Blitzmax builds win32 apps but I'm not aware of any specific problems with running them on 64-bit systems.<br><br>As for it not running on a Mac with Win emulation.... is that really such an issue?  If you want to play PC games, get a PC. <br><br></td></tr></table><br>
<a name="981733"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Jim Teeuwen</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#4">[#4]</a></td></tr></table></td></tr><tr ><td class="posttext"> I never had any problems running blitz apps on my 64 bit linux system. <br><br></td></tr></table><br>
<a name="981738"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >xlsior</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#5">[#5]</a></td></tr></table></td></tr><tr ><td class="posttext"> Are you using OpenAL, by any chance?<br><br>I'm just curious, what would happen if you have spread a 32-bit OpenAL DLL to a computer that may at some point have manually installed a 64-bit DLL, confusing your application? (32 bit Blitzmax App probably wouldn't be able to call / handle a 64-bit system DLL)<br><br>As far as the XP-on-a-Mac crashing: Perhaps a side-effect of hardware virtualization not being handled properly somewhere along the road?<br><br>for troubleshooting purposes, I'd wonder if you may wish to compile a version of your program will all sound routines and libraries stripped out, and see if that makes the problem go away. If it does, at least it may show you what area to focus on. <br><br></td></tr></table><br>
<a name="981743"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >ziggy</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#6">[#6]</a></td></tr></table></td></tr><tr ><td class="posttext"> This or send the publisher a debug build with console mode and tell him to tell you any possible crash message in the console window, so you can locate any possible issue in the code. <br><br></td></tr></table><br>
<a name="981744"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >skidracer</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#7">[#7]</a></td></tr></table></td></tr><tr ><td class="posttext"> From what I have read on these forums, I would be more suspicious of the high def mouse hacks you may have in place.<br><br>Tablet peripherals and touch pads being a possible source of confusion for your driver.<br><br>Also, are you overriding default audio driver? <br><br></td></tr></table><br>
<a name="981748"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >SLotman</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#8">[#8]</a></td></tr></table></td></tr><tr ><td class="posttext"> No need for 32 bit emulation: blitzmax games run fine on Vista 64. <br><br>The only problem I had with my game was with OpenAL, which was distorting very badly the music, and even seemed to duplicate the audio in some part... switched back to directsound and it's working perfectly. <br><br></td></tr></table><br>
<a name="981760"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >xlsior</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#9">[#9]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> No need for 32 bit emulation: blitzmax games run fine on vista 64. <br></div><br><br>...That's because Vista64 does the emulating for you, through WOW64. :-? <br><br></td></tr></table><br>
<a name="981774"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >sswift</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#10">[#10]</a></td></tr></table></td></tr><tr ><td class="posttext"> Skid:<br>I wouldn't call them "hacks".  I'm simply accessing data the Win32 api provides.<br><br>Here's the code:<br><textarea class=codebox name="code" wrap=OFF readonly="true" rows="15" cols="80">

' This code is used only on Win32 systems.

?Win32

Extern "Win32"
	Function RegisterRawInputDevices:Int(pRawInputDevices:Byte Ptr, uiNumDevices:Int, cbSize:Int)
	Function GetRawInputData:Int(hRawInput:Byte Ptr, uiCommand:Int, pData:Byte Ptr, pcbSize:Int Ptr, cbSizeHeader:Int)
End Extern


Global OldWinProc:Int ' This is the old blitzmax WinProc() function pointer.  This is set when you call HookWinProc().  


Const HID_USAGE_PAGE_GENERIC%  = $1
Const HID_USAGE_GENERIC_MOUSE% = $2
Const RIDEV_INPUTSINK% = $100
Const RIM_TYPEMOUSE% = 0
Const RID_INPUT% = $10000003


' If more than one raw input device needs to be registered, you will need to duplicate the fields in this type, because BltizMax types don't work like C structs,
' and creating arrays of them creates arrays of pointers to the data, rather than arranging multiple copies of the data within the array itself.

Type RAWINPUTDEVICE
   Field usUsagePage:Short
   Field usUsage:Short
   Field dwFlags:Int
   Field hwndTarget:Int
End Type

Global Rid:RAWINPUTDEVICE = New RAWINPUTDEVICE


' This type is a combination of the Windows structs RAWINPUTHEADER, RAWINPUT, and RAWMOUSE.
' This was done to avoid the need for unions (which BlitzMAx does not support) and issues with type variables being a pointer to data rather than having the data at that location.

Type RAWINPUT 
	
	' RAWINPUTHEADER:
		Field dwType:Int
		Field dwSize:Int
		Field hDevice:Byte Ptr
		Field WPARAM:Int Ptr 
	
	' RAWMOUSE:
		Field usFlags:Short 
		Field ulButtons:Int ' Depending on flags, can either be single long value ulButtons or short values usButtonFlags in low word, and usButtonData in high word.  Again, a work around for unions.
	  	Field ulRawButtons:Int 
		Field lLastX:Int 
	  	Field lLastY:Int 
  		Field ulExtraInformation:Int 

End Type 


' ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
' This function registers the mouse as a raw input device, so that WM_INPUT events will be generated for it.
' hWnd is the pointer to your window.  See HookWinProc() above for more details.
' ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------


	Function RegisterRID_MOUSE(hWnd:Int)
		
		Rid.usUsagePage = HID_USAGE_PAGE_GENERIC
		Rid.usUsage = HID_USAGE_GENERIC_MOUSE 
		Rid.dwFlags = RIDEV_INPUTSINK   
		Rid.hwndTarget = hWnd			

		RegisterRawInputDevices(Rid, 1, SizeOf(Rid))

	End Function


' ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
' hWnd is the pointer to your window.  hWnd is not the gadget pointer! 
' You can get hWnd with hWnd = GetActiveWindow(), or with hWnd = QueryGadget(Window, QUERY_HWND), where Window is your window's gadget pointer.
' ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

	Function HookWinProc(hWnd:Int)
		Local GWL_WNDPROC:Int = -4
		OldWinProc = SetWindowLongA(hWnd, GWL_WNDPROC, Int(Byte Ptr(WinProc)))
	End Function  


' ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
' This function is called automatically.  It grabs raw windows events before Blitzmax processes them, so that you can handle events that Blitzmax doesn't provide an interface for.
'
' Blitzmax has its own function like this internally, and this one calls that when it is done processing.
' Presumably, events handled by this function will still be passsed onto BlitzMax, so avoid processing the same data in both event handlers!
' ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

	Function WinProc:Int(hWnd:Int, Msg:Int, wParam:Int, lParam:Int) "win32"
	
		Const WM_INPUT% = $00FF
	
		Function LWord:Short(I:Int) ' Returns the lower 16 bits of a 32 bit integer.
			Return I &amp; $FFFF
		End Function
	
		Function HWord:Short(I:Int) ' Returns the upper 16 bits of a 32 bit integer.
			Return I Shr 16
		End Function
		
		Mouse_RawVx# = 0
		Mouse_RawVy# = 0
		
		Select Msg
	
		    Case WM_INPUT

	    			Local dwSize:Int = 40
				Local Raw:RAWINPUT = New RAWINPUT
    
				GetRawInputData(Byte Ptr(lParam), RID_INPUT, Raw, Varptr dwSize, 16) ' Get data in RAWINPUT structure.
    
				If Raw.dwType = RIM_TYPEMOUSE
				
					Mouse_NetDeltaX# = Mouse_NetDeltaX# + Raw.lLastX
					Mouse_NetDeltaY# = Mouse_NetDeltaY# + Raw.lLastY
				
					'Mouse_RawVx# = Raw.lLastX
					'Mouse_RawVy# = Raw.lLastY
					
					'DebugLog("Raw LastX = " + Raw.lLastX)
					'DebugLog("Raw LastY = " + Raw.lLastY)
					
				EndIf
				
			'Default
			'	DebugLog("Unknown Msg: " + Msg)
					
		End Select
	
		If OldWinProc &lt;&gt; 0 Then Return CallWindowProcA(Byte Ptr(OldWinProc), hWnd, Msg, wParam, lParam)   
		
	End Function

?
</textarea><br><br><br>And this is how I handle the sound driver issue:<br><textarea class=codebox name="code" wrap=OFF readonly="true" rows="15" cols="80">
			' If running on windows, use the directsound audio driver to fix sound delays in Vista.
				?Win32
					If Not SetAudioDriver("directsound") Then DebugLog("Error in App.Create(): Could not set DirectSound audio driver!")
				?
</textarea><br><br>So, DirectSound.<br><br><br>Here's the whole app setup actually, there's something in there about hooking the windows procedure that I don't remember what it was for.  Maybe the mouse code.<br><br><textarea class=codebox name="code" wrap=OFF readonly="true" rows="15" cols="80">
		Function Create(AppName$, AppWidth%, AppHeight%, AppDepth%=0, UseGL%=False)
	
			Local X%, Y%	
			
			' If we should use OpenGL on all platforms, then enable the openGL driver.
				If UseGL% Then SetGraphicsDriver GLMax2DDriver()
			
			' Warn programmer if the game is running in debug mode so they don't wonder why game is running choppy.
				DebugLog("WARNING: Game running debug mode - Performance will be reduced!")
									
			' Store application settings.
				Name$  = AppName$
								
				Full_Width  = AppWidth
				Full_Height = AppHeight	
				
				' If Depth is 0, try to find a suitable fullscreen bit depth.
			
					If AppDepth = 0
						If GraphicsModeExists(Full_Width, Full_Height, 16) Then AppDepth = 16
						If GraphicsModeExists(Full_Width, Full_Height, 24) Then AppDepth = 24
						If GraphicsModeExists(Full_Width, Full_Height, 32) Then AppDepth = 32
					EndIf		
					
				Full_Depth     = AppDepth
				Windowed_Depth = AppDepth
					
			' Create a window in the center of the screen.
			' ClientWidth/Height is used because GadgetWidth/Height returns the entire width of the desktop in dual screen setups.
		
				X = ClientWidth(Desktop())/2  - Windowed_Width/2
				Y = ClientHeight(Desktop())/2 - Windowed_Height/2
				
				'Window = CreateWindow(Name$, X, Y, Windowed_Width, Windowed_Height, Null, WINDOW_TITLEBAR|WINDOW_RESIZABLE|WINDOW_CLIENTCOORDS|WINDOW_HIDDEN)
				'SetMinWindowSize(Window, GadgetWidth(Window), GadgetHeight(Window))

				
				' Create a non-resizable window.
					Window = CreateWindow(Name$, X, Y, Windowed_Width, Windowed_Height, Null, WINDOW_TITLEBAR|WINDOW_CLIENTCOORDS|WINDOW_HIDDEN)
				
				' If running on Windows, add minimize button to window.

					?Win32 
				
						Local xs%
				
						' Get window pointer.
							App.hWnd = QueryGadget(Window, QUERY_HWND) 
	
						' Get window appearance flags, and add Minimize button.
							xs = GetWindowLongA(hWnd, -16) | $20000 

						' Set new window appearance, and apply changes.
							SetWindowLongA(hWnd, -16, xs)
							UpdateWindowMenu(Window)
												
					?
											
			' Create a panel in the window, drawn behind the canvas, which fills the empty space around the gameplay area when the window is maximized.
				
			'	Panel = CreatePanel(0, 0, Windowed_Width, Windowed_Height, Window)
				
			'		SetPanelColor(Panel, 0, 0, 0)
			'		SetGadgetLayout(Panel, EDGE_ALIGNED, EDGE_ALIGNED, EDGE_ALIGNED, EDGE_ALIGNED)
			
			' If running on windows, hook the window's event handler so we can capture events not exposed by BlitzMax.
				?Win32
					HookWinProc(App.hWnd) 
				?
			
			' Set game to windowed or fullscreen as desired.
				Select App.Windowed
					Case True  SetWindowed()
					Case False SetFullscreen()
				End Select
			
			' Enable polled input.
				EnablePolledInput()

			' Load mouse cursor and create mouse sprite.
				InitMouse()
			
			' If running on windows, use the directsound audio driver to fix sound delays in Vista.
				?Win32
					If Not SetAudioDriver("directsound") Then DebugLog("Error in App.Create(): Could not set DirectSound audio driver!")
				?
															
		End Function
</textarea><br><br><br>This is the bit where I'm not sure what I was doing:<br>HookWinProc(App.hWnd) <br><br><br>I hate when I comment stuff and the comment I wrote wasn't clear enough to help me remember why I did something later. :-) <br><br></td></tr></table><br>
<a name="981775"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >sswift</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#11">[#11]</a></td></tr></table></td></tr><tr ><td class="posttext"> Ah I figured out what I was doing.  <br><br>(But as far as I know this has nothing to do with the crashing.)<br><br>That calls this function in the mouse code:<br><br><pre class=code>
	Function HookWinProc(hWnd:Int)
		Local GWL_WNDPROC:Int = -4
		OldWinProc = SetWindowLongA(hWnd, GWL_WNDPROC, Int(Byte Ptr(WinProc)))
	End Function  
</pre><br><br>Which tells Windows to hook the function WinProc, also in the mouse code, to the BlitzMax window procedure.  This is what allows me to capture the mouse events BlitzMAx doesn't normally expose. <br><br></td></tr></table><br>
<a name="bottom"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td align="right"><a href="http://monkeycoder.co.nz" target="_blank"><img src="/img/monkey2.svg" ></a> <a href="https://github.com/blitz-research" target="_blank"><img src="/img/github.svg" ></a> <a href="https://discord.gg/qJccbSp" target="_blank"><img src="/img/discord.svg" ></a></td></tr></table><br></div><br><table width="100%"><tr><td></body></html lang="en">
