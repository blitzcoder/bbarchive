<!DOCTYPE html><html lang="en" ><head ><title >Threaded BlitzMax!</title><meta name='viewport' content='width=device-width, initial-scale=0.66'><meta name='description' content='language:basic, target:desktop, category:game development'><link rel="styleSheet" href="../skins/granite/style.css" type="text/css"><style type="text/css">div.bbcode {padding: 8px;background: #E5E5E5;color: #000000;border: 1px dashed #B4B4BE;}</style></head><body ><table width=100% cellspacing=0 cellpadding=0><tr ><td class="menubarleft"></td><td class="menubar"><table cellspacing="0" cellpadding="0"><tr ><td >&nbsp;</td><td class="menuitemleft"></td><td class="menuitem"><a href="/" class="menuitem">News</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/forums.php" class="menuitem">Forums</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/codearcs.php" class="menuitem">Code</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/logs.php" class="menuitem">Logs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/gallery.php" class="menuitem">Gallery</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/sdkspecs.php" class="menuitem">Specs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/search.php" class="menuitem">Search</a></td><td class="menuitemright"></td></tr></table></td><td class="menubarright"></td></tr></table><div class="main"><h1 >Threaded BlitzMax!</h1><a href="forums.php" >BlitzMax Forums</a>/<a href="topics.php?forum=102" >BlitzMax Programming</a>/<a href="#bottom" >Threaded BlitzMax!</a><br><br>
<a name="903246"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >marksibly</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#1">[#1]</a></td></tr></table></td></tr><tr ><td class="posttext"> Hi,<br><br>Well, as many of you will have already noticed, a new 'threaded' version of BlitzMax is now available via SVN!<br><br>This is all highly experimental and will probably take some time to get right, but bear with us as I think it's worth taking the leap into threads-land! If nothing else, it's kind of fun...<br><br>How to/notes etc:<br><br>* After svn updating, you will need to 'bmk -a -h' to rebuild all modules in 'threaded mode'.<br><br>* After this, using '-h' with bmk to build apps can be used to build threaded mode apps. The IDE source on SVN allows you to do this via a new 'Threaded Build?' menu item. However, to rebuild threaded modules <br>you'll have to stick with raw bmk for now.<br><br>* Threaded mode is a bit like debug/release - it's static and can't be changed at runtime. Your app is either threaded or it's not.<br><br>* In threaded mode, the garbage collector is replaced with the "Boehm-Demers-Weiser" (bdwgc) collector. More information here: <a href="http://www.hpl.hp.com/personal/Hans_Boehm/gc/" target="_blank">http://www.hpl.hp.com/personal/Hans_Boehm/gc/</a><br><br>* The new collector is slower than BlitzMax's ref-counting system. How much slower will depend a lot on the app. Although performance *will* improve, it will likely always be 'somewhat' slower. The bdwgc does however handle cyclic data structures (the ref-counter doesn't) which you may find useful even without threads.<br><br>* The debugger has been tweaked to ignore non-main-thread code.<br><br>* Exception handling has also been disabled for non-main-thread code. If non-main-thread throws an exception, the app will be rudely terminated.<br><br>* A new experimental Pub.Threads module has been added. Very, very simple for now but will grow and improve over time. See help/modules/System/Threads for the vast of array of powerful threading commands now at your disposal (Ok, there's just 7).<br><br>* Lots of OS specific stuff has its own rules when it comes to threading: GL contexts are 'per-thread'; dx devices are 'main thread only' (I think - perhaps just in fullscreen?); Mac's Cocoa is 'mostly' threadsafe etc. So don't expect to be able to 'load images in the background' suddenly/magically - all this stuff will take time to learn about and find the right approach for.<br><br>* The internal BBObject data structure will eventually change in threaded mode. Currently, the compiler still generates unnecessary ref-counting code but long term this will go. Anything that depends on BBObject-&gt;refs will break in threaded mode!<br><br>Finally, the current single-threaded ref-counting memory management will stay: My biggest fear in doing all this is that it will cripple 99.9% of apps for the sake of a handful of people actually capable of doing something useful with threads. I'm not exactly wild about having to now support 2 types of memory management but, well, let's just see what happens...! <br><br></td></tr></table><br>
<a name="903247"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Yahfree</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#2">[#2]</a></td></tr></table></td></tr><tr ><td class="posttext"> Great news, this (and the 3d module) are the 2 biggest complaints i've seen on the forums, good work!<br><br>Prehapes have this build option built into the ide? for example: compile-threaded/run-threaded buttons? Of course after the experimental phase <br><br></td></tr></table><br>
<a name="903254"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >REDi</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#3">[#3]</a></td></tr></table></td></tr><tr ><td class="posttext"> Thank you! oh and, <b>YAY THREADS</b> :D <br><br></td></tr></table><br>
<a name="903255"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Ked</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#4">[#4]</a></td></tr></table></td></tr><tr ><td class="posttext"> Because I'm an idiot, I'm going to ask, "What is threading?" <br><br></td></tr></table><br>
<a name="903257"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >kfprimm</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#5">[#5]</a></td></tr></table></td></tr><tr ><td class="posttext"> <a href="http://en.wikipedia.org/wiki/Thread_(computer_science)" target="_blank">Wikipedia</a> is your friend!<br><br>But yeah, this is great! Thanks alot! <br><br></td></tr></table><br>
<a name="903258"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Ked</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#6">[#6]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> A thread in computer science is short for a thread of execution. Threads are a way for a program to split itself into two or more simultaneously (or pseudo-simultaneously) running tasks (see also: fork). Threads and processes differ from one operating system to another but, in general, a thread is contained inside a process and different threads in the same process share some resources while different processes do not.<br><br>On a single processor, Multithreading generally occurs by time-division multiplexing ("time slicing") in very much the same way as the parallel execution of multiple tasks (computer multitasking): the processor switches between different threads. This context switching can happen so fast as to give the illusion of simultaneity to an end user. On a multiprocessor or multi-core system, threading can be achieved via multiprocessing, wherein different threads and processes can run literally simultaneously on different processors or cores.<br><br>Many modern operating systems directly support both time-sliced and multiprocessor threading with a process scheduler. The operating system kernel allows programmers to manipulate threads via the system call interface. Some implementations are called a kernel thread, whereas a lightweight process (LWP) is a specific type of kernel thread that shares the same state and information.<br><br>Absent that, programs can still implement threading by using timers, signals, or other methods to interrupt their own execution and hence perform a sort of ad hoc time-slicing. These are sometimes called user-space threads. <br></div><br>You couldn't have just typed that? Pssh, lazy. :P <br><br></td></tr></table><br>
<a name="903262"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >ziggy</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#7">[#7]</a></td></tr></table></td></tr><tr ><td class="posttext"> Great to see this public!<br>Been playing with this along this week and it works incredible well. I'm working on a sort-of parallels FOR implementation. I'm not sure if I will get anywhere with this, but it's being very fun. <br><br></td></tr></table><br>
<a name="903267"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >xlsior</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#8">[#8]</a></td></tr></table></td></tr><tr ><td class="posttext"> . <br><br></td></tr></table><br>
<a name="903273"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >JoshK</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#9">[#9]</a></td></tr></table></td></tr><tr ><td class="posttext"> Thank you for the info.  I am glad to see this development.<br><br>My main use for threads is writing callbacks that won't crash for multithreaded Newton physics.  Newton accepts a bunch of function pointers, and then the different threads call those functions during the physics update.  I guess this requires some locking mechanism when a variable all threads can access is written to, although that situation can be avoided 95% of the time.<br><br>Other applications are definitely possible, but the physics is something I know I will get working and use it a lot within a few weeks, once it is ready.<br><br>For objects that must be stored in a global list or map, it is possible to work around the loss of ref counts by using a reference/instance class design and doing your own refcounts with the instances.  In the instance destructor, you just decrement the reference object's "fake" ref count, and then remove it from the list when it reaches zero.  I'll figure out something like that.<br><br>This will work great for our renderer, because the potential visiblity set routine is already divided up into big chunks that can be chucked at different threads, with no OpenGL calls or messy data exchange. <br><br></td></tr></table><br>
<a name="903279"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >plash</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#10">[#10]</a></td></tr></table></td></tr><tr ><td class="posttext"> I reckon this started, mostly, because of Max3D, Mark? <br><br></td></tr></table><br>
<a name="903282"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >MGE</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#11">[#11]</a></td></tr></table></td></tr><tr ><td class="posttext"> "* Threaded mode is a bit like debug/release - it's static and can't be changed at runtime. Your app is either threaded or it's not."<br><br>"Finally, the current single-threaded ref-counting memory management will stay: My biggest fear in doing all this is that it will cripple 99.9% of apps for the sake of a handful of people actually capable of doing something useful with threads."<br><br>PHEW! Thank you. As someone who has invested over a year learning Blitzmax I have no intentions of ever using a multi threaded version of Blitzmax. When games are already running at hundreds of frames per second on even modest hardware, there is simply no reason for me to change anything. <br><br></td></tr></table><br>
<a name="903285"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >xlsior</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#12">[#12]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> PHEW! Thank you. As someone who has invested over a year learning Blitzmax I have no intentions of ever using a multi threaded version of Blitzmax. When games are already running at hundreds of frames per second on even modest hardware, there is simply no reason to change anything.  <br></div><br><br>There are plenty of possible uses: e.g. spin off resource-intensive pathfinding to a seperate thread, or things like enemy A.I.<br><br>If those run in seperate threads, then you don't necessarily have to have all their work done before the next video frame is due. <br><br></td></tr></table><br>
<a name="903286"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >MGE</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#13">[#13]</a></td></tr></table></td></tr><tr ><td class="posttext"> oops... I edited my post to correctly state "no reason for ME to change anything". ;) <br><br></td></tr></table><br>
<a name="903291"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >impixi</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#14">[#14]</a></td></tr></table></td></tr><tr ><td class="posttext"> Very interesting. I’m experiencing significant performance increases for certain projects when making use of threads (running on my quad core system).<br><br>EDIT: Removed outdated example. <br><br></td></tr></table><br>
<a name="903295"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >xlsior</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#15">[#15]</a></td></tr></table></td></tr><tr ><td class="posttext"> impixi: It does seem to run faster on my core 2 Duo, but your threaded sample above does bomb out a bunch of times with: "***** UNKNOWN THREAD EXCEPTION *****"<br>(Hit and miss) <br><br></td></tr></table><br>
<a name="903298"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >REDi</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#16">[#16]</a></td></tr></table></td></tr><tr ><td class="posttext"> . <br><br></td></tr></table><br>
<a name="903299"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >*</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#17">[#17]</a></td></tr></table></td></tr><tr ><td class="posttext"> Excellent stuff :) <br><br></td></tr></table><br>
<a name="903308"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >REDi</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#18">[#18]</a></td></tr></table></td></tr><tr ><td class="posttext"> I seem to be getting much steadier/better FPS if I call GCCollect once a frame.<br><br>I've also noticed that calling GCSuspend and then using GCCollect in the main loop, doesn't actually free anything, unlike it would with the standard GC. <br><br></td></tr></table><br>
<a name="903321"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >degac</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#19">[#19]</a></td></tr></table></td></tr><tr ><td class="posttext"> Great news, thank you.<br><br><div class="quote"> <br>In threaded mode, the garbage collector is replaced with the "Boehm-Demers-Weiser" (bdwgc) collector<br> <br></div><br><div class="quote"> <br>Finally, the current single-threaded ref-counting memory management will stay: <br> <br></div><br><br>This means we have (will have) the possibility to choose to create SINGLE-THREADED or MULTI-THREADED applications. Perfect.<br>But every time do we need to rebuild all the mods to make them single/multi threaded? Or the 'new' bmk creates (automatically) 2 version of the mods? <br><br></td></tr></table><br>
<a name="903326"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Hotcakes</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#20">[#20]</a></td></tr></table></td></tr><tr ><td class="posttext"> I believe multithreaded mods (which is not really correct, it's really more just 'old simple GC/new complex GC) are given a .mt extension, so yeh, two versions. <br><br></td></tr></table><br>
<a name="903334"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >ziggy</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#21">[#21]</a></td></tr></table></td></tr><tr ><td class="posttext"> <pre class=code>But every time do we need to rebuild all the mods to make them single/multi threaded? Or the 'new' bmk creates (automatically) 2 version of the mods?</pre><br>Yes there will be 2 versions, so you don't have to rebuild everything just to compile your app <br><br></td></tr></table><br>
<a name="903366"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >degac</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#22">[#22]</a></td></tr></table></td></tr><tr ><td class="posttext"> Thanks.<br>So I need to do 'BMK -a -h' once, and then select the option 'Build threaded' and Bmax does the work. Perfect! <br><br></td></tr></table><br>
<a name="903368"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Brucey</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#23">[#23]</a></td></tr></table></td></tr><tr ><td class="posttext"> <pre class=code>
bmk makemods -a -h
</pre> <br><br></td></tr></table><br>
<a name="903383"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >ImaginaryHuman</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#24">[#24]</a></td></tr></table></td></tr><tr ><td class="posttext"> Okay, so threads are really cool. Now, how can we find out (cross-platform) how many cpu's/cores the hardware is providing? It would be really useful to know if you are running on a multicore machine and how many cores you have available - ie if you wanted to create as many threads as there are cores, for example ??? <br><br></td></tr></table><br>
<a name="903389"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Mark Tiffany</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#25">[#25]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> So I need to do 'BMK [b]makemods[b]-a -h' once, and then select the option 'Build threaded' and Bmax does the work. Perfect! <br></div><br>You'll need to do this every time modules get updated (Rebuild All Mods will *not* also do the threaded versions just yet).<br><div class="quote"> So don't expect to be able to 'load images in the background' suddenly/magicall <br></div><br>I guess the best thing to do would be to load the file into memory in a bank, return that data to the main thread, and then load the image from the memory bank into a TImage object.  Or something... <br><br></td></tr></table><br>
<a name="903390"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Ian Thompson</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#26">[#26]</a></td></tr></table></td></tr><tr ><td class="posttext"> The O.S. will spread your total amount of threads amongst the cores, if there is more threads than cores then the thread execution will be split the core CPU clock up into individual threads... even single core CPU have simple hardware threading built into them... <br><br></td></tr></table><br>
<a name="903392"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Mauft</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#27">[#27]</a></td></tr></table></td></tr><tr ><td class="posttext"> How "unsafe" is the threading in this release yet?<br><br>And how soon can we expect it to be "easily accessed" feature? ^^ <br><br></td></tr></table><br>
<a name="903401"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Brucey</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#28">[#28]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> You'll need to do this every time modules get updated  <br></div><br>Well, you can leave off the "-a" part if you don't want to spend half your day rebuilding everything.<br><br>So something like:<br><pre class=code>
bmk makemods
bmk makemods -h
</pre><br>would build those that need it, after updating some of them. Obviously you need -a when you want to rebuild everything.<br><br>Just the same as usual, except for an extra step of including a -h build. <br><br></td></tr></table><br>
<a name="903412"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >BlitzSupport</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#29">[#29]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> <br>how can we find out (cross-platform) how many cpu's/cores the hardware is providing?<br> <br></div><br><br>Well, here's the Windows version. Mac and Linux will have to be done by someone else!<br><br><textarea class=codebox name="code" wrap=OFF readonly="true" rows="15" cols="80">
Type SYSTEM_INFO
	Field wProcessorArchitecture:Short
	Field wReserved:Short
	Field dwPageSize:Int
	Field lpMinimumApplicationAddress:Byte Ptr
	Field lpMaximumApplicationAddress:Byte Ptr
	Field dwActiveProcessorMask:Int
	Field dwNumberOfProcessors:Int
	Field dwProcessorType:Int
	Field dwAllocationGranularity:Int
	Field wProcessorLevel:Short
	Field wProcessorRevision:Short
End Type

Extern "win32"
	Function GetSystemInfo (si:Byte Ptr)
End Extern

Function CountProcessors ()
	GetSystemInfo (info:SYSTEM_INFO)
	Return info.dwNumberOfProcessors
End Function

Print ""
Print "Number of processors: " + CountProcessors ()
Print ""
</textarea> <br><br></td></tr></table><br>
<a name="903415"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Mark Tiffany</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#30">[#30]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> How "unsafe" is the threading in this release yet? <br></div><br>I rather suspect the "safe-ness" will relate to the code people try to write much more than the core code.<br><br><div class="quote"> Well, you can leave off the "-a" part if you don't want to spend half your day rebuilding everything. <br></div><br>Well, duh! ;-P My point was more that you'll have to force a manual makemods each time and not rely on the menu option in the ide. <br><br></td></tr></table><br>
<a name="903421"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >degac</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#31">[#31]</a></td></tr></table></td></tr><tr ><td class="posttext"> I've run the Impixi program and I got (for the MT example) "***** UNKNOWN THREAD EXCEPTION *****"<br>The Debug tree highlithts (it changes at every run) the commands Cls, DrawPixmpa or DrawText...sometimes compares the window, sometime no. <br><br></td></tr></table><br>
<a name="903472"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >markcw</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#32">[#32]</a></td></tr></table></td></tr><tr ><td class="posttext"> Re: Processor Count.<br><br>In OSX Carbon has an MPProcessors() but Cocoa needs this:<br><a href="http://www.cocoadev.com/index.pl?ProcessorCount" target="_blank">http://www.cocoadev.com/index.pl?ProcessorCount</a><br><br>In Linux it's in the cpuinfo file:<br><a href="http://paste.lisp.org/display/30651" target="_blank">http://paste.lisp.org/display/30651</a> <br><br></td></tr></table><br>
<a name="903484"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Grisu</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#33">[#33]</a></td></tr></table></td></tr><tr ><td class="posttext"> You guys rock! :) <br><br></td></tr></table><br>
<a name="903524"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Winni</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#34">[#34]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> <br>Okay, so threads are really cool. Now, how can we find out (cross-platform) how many cpu's/cores the hardware is providing? It would be really useful to know if you are running on a multicore machine and how many cores you have available - ie if you wanted to create as many threads as there are cores, for example ??? <br> <br></div><br><br>It's actually quite irrelevant to know the amount of cores in your machine: You should use threads wherever it makes sense to move a bulk of operations into the background. <br><br>Even on a single core machine, your app would 'feel' more responsive because the user won't see the hour glass or beach ball while waiting for a job to be finished. And that's a very positive effect although that when measured with a stop watch the application might actually perform a bit slower because of the administrative overhead that multi-threading causes. But in return you will experience increased performance on a multi-core machine when you use threads. <br><br></td></tr></table><br>
<a name="903526"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >GfK</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#35">[#35]</a></td></tr></table></td></tr><tr ><td class="posttext"> Can this be used to show an animated loading icon for example?  (one that won't freeze as the data is being loaded) <br><br></td></tr></table><br>
<a name="903527"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >REDi</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#36">[#36]</a></td></tr></table></td></tr><tr ><td class="posttext"> AFAIK, DirectX doesn't allow rendering in a thread (or at least you must only use it from the same thread the device was created with), so you would do it the other way around, draw in your main program and load the media in the thread.<br><br>I think DX9 has a multi thread flag that needs to be used for threaded apps, but that doesn't help us much, as things stand. <br><br></td></tr></table><br>
<a name="903528"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >impixi</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#37">[#37]</a></td></tr></table></td></tr><tr ><td class="posttext"> degac and xlsior:<br><br>On my Windows XP system (Intel Q6600 CPU - 2.4ghz quad core), the code I posted hasn’t crashed at all when run in release mode, but did seem to hang on one occasion when run in debug mode. However, the value returned by GCMemAlloced() is not correct.<br><br>In any case, it could be something I’m doing or not doing, related to threads. It’s not a field with which I’ve had any programming experience before… <br><br>I’ll try the code on my dual core OS X MacBook Pro later today and see if I have any problems… <br><br></td></tr></table><br>
<a name="903532"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >ImaginaryHuman</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#38">[#38]</a></td></tr></table></td></tr><tr ><td class="posttext"> I actually specifically want to be able to tell how many cores there are in total from all cpu units, and to use that number to create only that many threads - I appreciate your comments (various) about how the o/s will split things up for you and why what I want to do is irrelevant but I still want to be able to get a core count and launch that many threads - it's part of my design for a distributed computing system. It's not really worthwhile for me to just create threads on the offchance that they might end up on another core.<br><br>Thanks all for posting initial code for finding the core count. <br><br></td></tr></table><br>
<a name="903533"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >BlitzSupport</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#39">[#39]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> <br>However, the value returned by GCMemAlloced() is not correct.<br> <br></div><br>It's considered invalid with the new GC, so you have to use Task Manager to monitor memory usage. <br><br></td></tr></table><br>
<a name="903542"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Winni</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#40">[#40]</a></td></tr></table></td></tr><tr ><td class="posttext"> Gfk, yes, that would be one of the uses for multi-threading. ;-)<br><br>ImaginaryHuman, I knew that you had something specific in mind, and it looks like you want to do something where that approach makes perfect sense. It was just one of those general comments for the record. ;-)<br><br>markcw, thanks for that link!<br><br>For those of you who prefer OOP (like myself), here's a basic skeleton of an actual thread class with mini code to demonstrate that it works:<br><br><pre class=code>
'A very basic abstract thread class. Derive your own class from it.
Type Thread Abstract
	Field handle:Int = 0

	'Call this to build and launch your actual thread.
	Method Start() Final
		Self.handle=CreateThread( Self.SpawnThread,  Object( Self ) )
	End Method

	'The thread factory
	Function SpawnThread:Object( data:Object) Final
		'Cast 'data' back to type Thread
		Local myThread:Thread = Thread(data)
		myThread.Run()
	End Function
	
	'This must be implemented by the derived thread class;
	'it contains what the thread(!) is supposed to do.
	'It is !-never-! called directly by the user.
	Method Run() Abstract
End Type


'Derived class - this will contain YOUR code for thread.
'Don't do anything fancy, just demonstrate that you're doing -something-.
Type MyThread Extends Thread
	Method Run()
		For Local n:Int = 1 To 100
			Print n
		Next
	End Method
End Type


'Create two instances and let them fly
Global T1:MyThread = New MyThread
T1.Start()

Global T2:MyThread = New MyThread
T2.Start()

Repeat
Forever

</pre> <br><br></td></tr></table><br>
<a name="903546"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >REDi</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#41">[#41]</a></td></tr></table></td></tr><tr ><td class="posttext"> Winni, You need to call DetachThread otherwise the threads handle will not be closed.<br><br>*BUG* It seems CloseMutex() is missing the (BBMutex*) handle in threads.bmx <br><br></td></tr></table><br>
<a name="903550"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Retimer</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#42">[#42]</a></td></tr></table></td></tr><tr ><td class="posttext"> Support for threading? <br><br>Looks like all that ranting of "blitz doesn't support us" by myself and the rest just got returned with a double slap to the face. Sorry for the previous disrespect in that matter, as you did come through spontaneously.<br><br>Now to play with this, woohoo ! <br><br></td></tr></table><br>
<a name="903551"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >ImaginaryHuman</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#43">[#43]</a></td></tr></table></td></tr><tr ><td class="posttext"> When you're doing a repeat-forever, isn't that basically a third thread which is going to hog a lot of cpu time doing an infinite loop? Maybe stick a delay in there or something? <br><br></td></tr></table><br>
<a name="903553"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Winni</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#44">[#44]</a></td></tr></table></td></tr><tr ><td class="posttext"> Yep, that's right. It should come before the end of method 'run'.<br><br>I've added a detach() method to the class skeleton, and I've also wrapped the OS X version of getProcessorCount() and it seems to work. It's actually not counting the CPUs, but the cores, by the way. When you're on Windows, getProcessorCount() should perform the code provided above by BlitzSupport.<br><br>Somebody still needs to do the Linux version.<br><br>I've put everything that I have so far into a module. It can be downloaded from <a href="http://www.wmaus.net/BlitzMax/wmaus.mod.zip" target="_blank">here</a>. <br><br></td></tr></table><br>
<a name="903556"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >REDi</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#45">[#45]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> Yep, that's right. It should come before the end of method 'run'. <br></div><br>I'd say it would be better in the SpawnThread function, so the thread returns properly instead on being terminated. also worth setting "handle" to 0 after detaching the thread, you should then add another detachthread in a delete method that checks that the thread hasn't already been deleted ( if handle&lt;&gt;0 detachthread() ), just in case the class gets GCed.  You could then also use the handle in a Status method to work out if the thread is still active or not (as so far we dont have a function for that yet)<br><br>Just my 2p :) <br><br></td></tr></table><br>
<a name="903565"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Winni</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#46">[#46]</a></td></tr></table></td></tr><tr ><td class="posttext"> Hmm. That's a rather scary thought: Can the class actually get GCed while the thread is still running? If so, then this is a serious problem and would be a bitch to debug.<br><br>I'll change my ThreadClass mod following your 2p - what you say makes a lot of sense. It's on the download page of my blog now, in case somebody wants to look at or add to it. getProcessorCount() is still waiting for a Linux implementation. ;-) <br><br></td></tr></table><br>
<a name="903566"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Winni</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#47">[#47]</a></td></tr></table></td></tr><tr ><td class="posttext"> I think detaching the thread should be handled in Start(), not in SpawnThread() - Start()'s context knows the valid handle. <br><br></td></tr></table><br>
<a name="903567"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >REDi</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#48">[#48]</a></td></tr></table></td></tr><tr ><td class="posttext"> but then your thread will die as soon as you create it. "myThread" in SpawnThread knows the handle ( myThread.handle ;) ).<br><br>*EDIT* Actually no, it seems that detachthread doesn't currently terminate the thread if its still running. <br><br></td></tr></table><br>
<a name="903569"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Winni</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#49">[#49]</a></td></tr></table></td></tr><tr ><td class="posttext"> Good point, and again, you're right. ;-)<br><br>Strangely enough, the code still ran through exactly as it did before - but that could have been a coincidence. <br><br>Anyway. Another update on its way. <br><br></td></tr></table><br>
<a name="903575"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Regular K</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#50">[#50]</a></td></tr></table></td></tr><tr ><td class="posttext"> Thanks mark for multithreading.<br><br>I'll be needing it soon... <br><br></td></tr></table><br>
<a name="903593"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >REDi</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#51">[#51]</a></td></tr></table></td></tr><tr ><td class="posttext"> could we have something like...<br><pre class=code>?Not threaded
	' allow non-threaded build of threaded modules.
	Function CreateThread:Int(entry:Object( data:Object ),data:Object) ; EndFunction
	Function DetachThread(thread:Int) ; EndFunction
	... blah blah
	' complain if this module is used in non-threaded mode.
	RuntimeError "Threading mode required!"
?</pre><br>defined in threads.bmx, because atm it complains if you use threading commands in a module and run non-threaded "build modules", as we cant use nested conditional compiling it can be it quite awkward to remedy. ie: if you need ?win32 + ?threaded on the same lines of code. <br><br></td></tr></table><br>
<a name="903637"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Yan</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#52">[#52]</a></td></tr></table></td></tr><tr ><td class="posttext"> For those of you that may want to tinker with this stuff from within the CEIDE (and missed the other thread)...<br><br><a href="/posts.php?topic=80119#902918" target="_blank"><b><u>http://www.blitzbasic.com/Community/posts.php?topic=80119#902918</u></b></a> <br><br></td></tr></table><br>
<a name="903638"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >GfK</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#53">[#53]</a></td></tr></table></td></tr><tr ><td class="posttext"> Is there any benefit to using this on single core systems?<br><br>Sorry if that's a stupid question but having used Blitz exclusively for almost the last decade, I don't know about these things. <br><br></td></tr></table><br>
<a name="903644"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >GaryV</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#54">[#54]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> Is there any benefit to using this on single core systems? <br></div>Yes <br><br></td></tr></table><br>
<a name="903655"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Ian Thompson</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#55">[#55]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> Sorry if that's a stupid question but having used Blitz exclusively for almost the last decade, I don't know about these things. <br></div><br><br>Yes, even single core CPUs have hardware threads, its the most efficient method of doing tasks concurrently. <br><br></td></tr></table><br>
<a name="903701"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Scaremonger</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#56">[#56]</a></td></tr></table></td></tr><tr ><td class="posttext"> Exciting times eh? Thanks Mark. <br><br></td></tr></table><br>
<a name="903722"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >xlsior</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#57">[#57]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> Is there any benefit to using this on single core systems? <br></div><br><br>Yes -- especially since single core systems can also have optimizations like Hyperthreading where it can start executing new commands before the current ones have exited the CPU pipelines.  Obviously not as efficient as an actual multi-core chip, but it can still give a noticible difference.<br><br>Obviously (?) you may not gain a huge speed increase on single core (and it may be detrimental in some cases thanks to the supposedly slower new garbage collection system used for threading) but it's definitely worth trying. <br><br></td></tr></table><br>
<a name="903742"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Wiebo</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#58">[#58]</a></td></tr></table></td></tr><tr ><td class="posttext"> Sounds awesome! Please get it in the regular release as quickly as you can 'cos I don't use SVN =] <br><br></td></tr></table><br>
<a name="903858"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Grey Alien</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#59">[#59]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> Can this be used to show an animated loading icon for example? (one that won't freeze as the data is being loaded) <br></div>That's the main purpose I'd use it for too initially. <br><br></td></tr></table><br>
<a name="903890"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >xlsior</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#60">[#60]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> Can this be used to show an animated loading icon for example? (one that won't freeze as the data is being loaded)  <br></div><br><br>Apparently you can't (yet?) load your images themselves by a secondary thread and have them be available to the main thread, but <br><br>I do wonder -- Can you have the main program spawn a second thread that displays the animated icon while the main program itself loads in all the images?  <br><br>Can the worker thread load its own animation graphic from disk and just twiddle it thumbs animating it, or won't it have access to draw to the screen at all? <br><br></td></tr></table><br>
<a name="903897"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >REDi</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#61">[#61]</a></td></tr></table></td></tr><tr ><td class="posttext"> Well I've just knocked together a little test program and it seems to work fine! but I'll leave it running for a while to see if anything untoward happens.<br><br>I didn't think this was possible because of a statement in the purebasic docs that reads...<br><div class="quote"> Note: Don't use DirectX inside threads (MS Windows limitation)! If you need to display graphics in threads use Images and 2DDrawing instead.  <br></div><br>But so far it seems to be working very well! :)<br><br>*EDIT* here's a simple test app, first choose an image (not a massive one) then a song, the song will be loaded in the main thread, and the image will be drawn with the new thread.  the music will be loaded over and over again to simulate loading a lot of media.<br><textarea class=codebox name="code" wrap=OFF readonly="true" rows="15" cols="80">SuperStrict
Import PUB.Threads

Graphics 800,600,0

Local file$ = RequestFile("Choose some music...","ogg,wav")
Local sound:TSound

Local Thread:TThread = New TThread
Thread.Start()

sound = LoadSound(file)		' load once for a playable version
PlaySound sound

Repeat
	LoadSound(file)		' keep loading the music to see if we can make it crash
	Print "load audio complete"
	GCCollect()			' memleak if no gccollect!!!!
	Delay 5
Until KeyHit(KEY_ESCAPE) Or AppTerminate()
Thread.Terminate()
End

Type TThread

	Field ThreadID:Int
	Field Terminate_Mutex:Int = CreateMutex()
	Field Terminate_:Int
	Field Image:TImage

	Field x:Double, r:Double

	Method Start()
		Image = LoadImage(RequestFile("Choose an image...","bmp,png,jpg"))
		MidHandleImage(Image)
		ThreadID = CreateThread(ThreadFunc,Self)
	EndMethod
	
	Method Terminate()
		LockMutex(Terminate_Mutex)
		Terminate_ = True
		UnlockMutex(Terminate_Mutex)
		WaitThread(ThreadID)
	EndMethod
	
	Function ThreadFunc:Object(data:Object)
		Local T:TThread = TThread(data)
		Local res:Object = t.ThreadProc()
		DetachThread(T.ThreadID)
		Return res
	EndFunction
	
	Method ThreadProc:Object()
		Repeat
		
			LockMutex(Terminate_Mutex)
			If Terminate_ UnlockMutex(Terminate_Mutex) ; Exit
			UnlockMutex(Terminate_Mutex)
		
			Cls
			SetRotation(r)
			DrawImage(Image,x,GraphicsHeight()/2)
			x:+1 ; r:+1
			If x&gt;GraphicsWidth()+ImageWidth(Image) Then x=-ImageWidth(Image) ; r=0
			Flip True
			Sleep(2)
		Forever
	EndMethod

EndType</textarea><br><br>The window isnt very responsive because the main thread is busy, but I suppose in full screen it wouldnt really matter, still it would be better the other way around with loading in the thread and drawing in the main thread.<br><br>*EDIT* updated <br><br></td></tr></table><br>
<a name="903900"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Tachyon</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#62">[#62]</a></td></tr></table></td></tr><tr ><td class="posttext"> I haven't yet dove into this wonderful Threads module yet, but I have a few questions regarding <i>what it is good for</i>? Obviously, I know the benefit to breaking computationally intensive tasks into multiple threads for increased speed, but I have also read how this feature won't be of benefit to 'everyone' based on what your program actually does.<br><br>So, I guess I would love to hear some opinions on exactly what this means to the average game developer? In a real-world game such as Fairway Solitaire, Runes of Avalon or Eschalon, what kinds of fantastic benefits or tricks can be performed by having the code threaded? <br><br></td></tr></table><br>
<a name="903904"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Gabriel</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#63">[#63]</a></td></tr></table></td></tr><tr ><td class="posttext"> Games are not ideally suited for threading, and particularly not relatively simple (technically) ones. I guess the most obvious ones would be input, sound, physics and resource loading.<br><br>Threading your input means that your game is always responsible even when it's chugging along quite badly, struggling with some heavy duty graphics. Unresponsive input is a big turn off.<br><br>Threading your audio ensures that it never skips and there are no unfortunate clicks and pops when things slow down a bit. Mind you, most (third party) audio engines do this anyway, I guess.<br><br>Threading your physics is fairly obvious because it's computationally expensive, but I imagine most physics engines are already doing this, and you don't need threading in your language to use it.<br><br>Threading your loading means you can keep the screen animating while you load, or even (in advanced cases) stream in the next section of the game world while you play.<br><br>Unless you're doing something with some seriously heavy duty physics, I doubt you'll notice or need any speed improvement. Indeed, on a single core machine, you'll even sacrifice a tiny bit of speed. It's more about ensuring the separate components of the game are all responsive.<br><br>There are other game-related features that don't necessarily end up in a game which would benefit, of course. If you were writing a lightmapper, then having the application remain responsive and even update itself with a progress bar would be great. Not that you can't do it without threads, but it's easier with. <br><br></td></tr></table><br>
<a name="903923"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >xlsior</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#64">[#64]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> Well I've just knocked together a little test program and it seems to work fine! but I'll leave it running for a while to see if anything untoward happens <br></div><br><br>It appears to work just fine on my machine -- interesting sample, thanks for sharing! :-) <br><br></td></tr></table><br>
<a name="903943"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Grey Alien</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#65">[#65]</a></td></tr></table></td></tr><tr ><td class="posttext"> Thanks for the explanation Gabriel.  To be honest I only see it as useful for loading whilst animating on the types of games I make.  Maybe I'll try this for my next game.  Thing is most, players aren't bothered by 1 second loading times anyway :-) <br><br></td></tr></table><br>
<a name="903961"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >DStastny</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#66">[#66]</a></td></tr></table></td></tr><tr ><td class="posttext"> @Gabriel nice example.<br><br>FYI you dont need the mutex on the Terminate since in the thread context you are just reading it.  Externally you are writting it.  Worst thing to happen is it will continue run one more time.<br><br>Mutexs are expensive use them only on data that you are reading and writing from different threads.<br><br>DStastny <br><br></td></tr></table><br>
<a name="903967"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >markcw</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#67">[#67]</a></td></tr></table></td></tr><tr ><td class="posttext"> Not that I'm much of a game developer, but I wouldn't use threading in a game. Exceptions would be network or physics intensive games which are rarely made. From the sounds of it, non-threaded BMax would be faster for most 3d games and maybe all 2d games. I think that's why threading was never added until now, when Mark finally gave in. Still, it's nice to have it as an option. <br><br></td></tr></table><br>
<a name="903983"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >TomToad</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#68">[#68]</a></td></tr></table></td></tr><tr ><td class="posttext"> Just tried writing a simple particle engine using a thread to update the particles.  Probably not the best way to handle this, but I did get some weird side effects with the GC.<br><br>First, run this example while you have the task manager open so you can see how much memory is being used.  The top number is the number of particles being rendered and the bottom number is the framerate.  Notice that when no particles are being drawn, the framerate is 60fps.  Now hold the left mouse button and move around to fill the window full of particles.  You'll notice that the memory usage will creep up for a while.  It does stop eventually, but it never goes back down.  Also, at some point you will notice that the frame rate will drop.<br><br>Now release the mouse button and wait for the particles to disappear off the bottom of the screen.  First you'll notice that the memory usage never drops.  It will stay at its maximum level.  Also you'll notice that as there are less and less particles to render, the framerate will actually drop!  On my machine, I'll get 40-60 fps with the screen full of particles and only 30-40 once all the particles disappear!  This is strange as there are no particles to update and no particles to render.<br>Now uncomment the GCCollect().  The memory problem is still there, but the total memory usage only ends up being about half as before.  The framerate though, will creep back up to 60fps as the particles disappear from the screen.  So do you need to have a GCCollect() when using the threaded GC?<br><br>System specs AMD Athalon 64 Dual Core 5000+ 2.6Ghz<br>2gig Ram<br>Vista Home Premium SP 1<br>BFG NVidia GeForce 8800 GT OC 16X PCI-E 512MB<br><textarea class=codebox name="code" wrap=OFF readonly="true" rows="15" cols="80">SuperStrict

Type TParticle
	Global Mutex:Int = CreateMutex()
	Global List:TList = CreateList()
	Global OldTime:Int = MilliSecs()
	Global Flag:Int = False
	
	Field x:Float
	Field y:Float
	Field SpeedX:Float
	Field SpeedY:Float
	Field Life:Float

	Function Create(Number:Int, x:Float, y:Float)
			LockMutex(Mutex)

		For Local i:Int = 1 To Number
			Local Particle:TParticle = New TParticle
			Particle.X = X
			Particle.Y = Y
			
			Local Speed:Float = Rnd(0,100)
			Local Angle:Float = Rnd(-180,180)
			
			Particle.SpeedX = Cos(Angle)*Speed
			Particle.SpeedY = Sin(Angle)*Speed
			Particle.Life = Rnd(20,30)
			
				List.AddLast(Particle)
			
		Next
			UnlockMutex(Mutex)

	End Function
			
	
	Function Run:Object(data:Object)
		Repeat
			Local Time:Int = MilliSecs()
			Local Delta:Float = (Time - Oldtime)/1000.0
			OldTime = Time
			LockMutex(mutex)

			For Local Particle:TParticle = EachIn TParticle.List
					Particle.X :+ Particle.SpeedX * Delta
					Particle.Y :+ Particle.SpeedY * Delta
					Particle.SpeedY :+ 100.0*Delta
					If Particle.X &lt; 0 Or Particle.X &gt;=800 Or Particle.y &gt;= 600 Then List.Remove(Particle)
			Next
			UnlockMutex(mutex)

		Until Flag
	End Function
End Type

Graphics 800,600

Local Thread:Int = CreateThread(TParticle.Run,Null)
Local Time:Int = MilliSecs() + 1000
Local FPS:Int = 0
Local Frames:Int = 0

While Not KeyHit(KEY_ESCAPE) And Not AppTerminate()
	Cls
	LockMutex(TParticle.Mutex)
		For Local Particle:TParticle = EachIn TParticle.List
				Plot Particle.x,Particle.y
		Next
		DrawText(TParticle.List.Count(),10,10)
		DrawText FPS, 10,40
	UnlockMutex(TParticle.Mutex)
	Flip
	
	If MouseDown(1)
		Local MX:Int = MouseX()
		Local MY:Int = MouseY()
		
		TParticle.Create(100,MX,MY)
	End If
	
	Frames :+ 1
	If MilliSecs() &gt;= Time
		Time :+ 1000
		FPS = frames
		frames = 0
	End If
	'GCCollect()
Wend

TParticle.Flag = True
DetachThread(Thread)
</textarea> <br><br></td></tr></table><br>
<a name="904041"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Kurator</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#69">[#69]</a></td></tr></table></td></tr><tr ><td class="posttext"> Q6600, 20k particels, no framerate drops, mem usage goes up to 20k and stays there<br><br>with gc on (on every flip) in naturally decreases framerate, and memory usage stays low as 8k.<br><br>if you want do reduce mem usage, create a gc thread with a specific timer - say 1000 msec, so you don't have to call it every flip :)<br><br>i will test your programm again when i installed the latest fixes from svn <br><br></td></tr></table><br>
<a name="904051"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >ImaginaryHuman</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#70">[#70]</a></td></tr></table></td></tr><tr ><td class="posttext"> I can think of many many ways that theads are useful for applications, like with MaxGui, you can have things rendering and calculating and processing in parallel, you can have multiple windows open at the same time doing processing in parallel, etc.<br><br>I do agree that the uses in games is less obvious but I think in part this has something to do with a) that most games are very linear and b) we just haven't had the freedom before to do things in parallel so game design hasn't explored the possibilities.<br><br>I would definitely try to get file access into a thread but only if that helps to completely remove file loading from the user's perception of what's going on. You should be trying to load files without causing the user to wait around doing nothing, regardless of whether it's threaded, it's just that a thread for file access would help to achieve that (e.g. load your files while the user is operating the menu buttons, reading some important text/instructions, or viewing a cut-scene).<br><br>A thread would definitely help with spooling data from disk during gameplay, like for a large terrain landscape or extra models or level data, but only really if you have multiple cpu cores - doing it on a single cpu isn't really going to give you anything other than the ability to pretend that you're doing two things at once, and that amounts to a coding technique. Instead of managing the concurrent operations youreself you're just asking the o/s to conveniently switch between then for you to try to complete both in virtual-paralellism.<br><br>I think mainly larger more advanced game engines will benefit the most from threads, but less so for simpler stuff. <br><br></td></tr></table><br>
<a name="904062"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Retimer</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#71">[#71]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> From the sounds of it, non-threaded BMax would be faster for most 3d games and maybe all 2d games <br></div> <br><br>From a developer stance, and working with custom tools and servers, threads are oh so beautiful. Having a quad core server with an application that only uses one core was depressing.<br><br>Today i've started to faithfully integrate threads into my editors and servers. I'm astonished at how stable blitzmax threads currently are after such little time, and ofcourse, due to it being blitz, finding it easier to work with. Thank you so much Mark.S and anyone who assisted this addition. I have a permasmile that won't even let me drink my coffee.<br><br>I think blitzmax is back into the competition with other languages (including for 3d), even for application development. This is grand.<br><br>I'm sure leadwerks is in a state of awe even moreso lol. <br><br></td></tr></table><br>
<a name="904145"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >TomToad</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#72">[#72]</a></td></tr></table></td></tr><tr ><td class="posttext"> robobimbo:  Try changing the TParticle.Create(100,MX,MY) line to something like TParticle.Create(<b>200</b>,MX,MY).  Leave the 'GCCollect() line REMed for now.<br>The idea is to get so many particles going at once that the frame rate drops.  Get enough going so it drops to something like 40fps.<br>After that, let go of the mouse button and let all the particles fall off screen.  You would expect at this point that the framerate would go back up to 60, just like it was before you started spewing out particles, but on my machine, the framerate actually drops even further!<br>If your machine is acting like mine at this point, try it again with GCCollect() active.  Notice how the framerate returns normally after the particles disappear?  It just seems that particles are being processed even though there are no more references to any, and those "pseudoparticles" are not getting cleaned up by the GC without an explicit GCCollect(). <br><br></td></tr></table><br>
<a name="904154"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >TomToad</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#73">[#73]</a></td></tr></table></td></tr><tr ><td class="posttext"> Ok, it seems that when a thread grabs CPU cycles, it doesn't want to give them back.  I rewrote my example to destroy the thread when there are no particles to render and respawn it when new particles need to be updated.  Now the framerate goes back up to 60 when no particles are left.  Also, before my cpu usage was about 60% with a screen full of particles, but dropped to 50% when no particles were present.  Now, with the change, CPU usage drops to about 3-4%  indicating that it was the spawned thread grabbing my CPU (dual core).<br>Here it is again with the change.  Also, I changed the program so that only the main thread adds or removes particles from the list, removing the need to use LockMutex().<br><textarea class=codebox name="code" wrap=OFF readonly="true" rows="15" cols="80">SuperStrict

Type TParticle
	Global Mutex:Int = CreateMutex()
	Global List:TList = CreateList()
	Global OldTime:Int = MilliSecs()
	Global Flag:Int = False
	
	Field x:Float
	Field y:Float
	Field SpeedX:Float
	Field SpeedY:Float
	Field Life:Float
	Field Remove:Int = False

	Function Create(Number:Int, x:Float, y:Float)

		For Local i:Int = 1 To Number
			Local Particle:TParticle = New TParticle
			Particle.X = X
			Particle.Y = Y
			
			Local Speed:Float = Rnd(0,100)
			Local Angle:Float = Rnd(-180,180)
			
			Particle.SpeedX = Cos(Angle)*Speed
			Particle.SpeedY = Sin(Angle)*Speed
			Particle.Life = Rnd(20,30)
			
				List.AddLast(Particle)
			
		Next

	End Function
			
	
	Function Run:Object(data:Object)
		Repeat
			Local Time:Int = MilliSecs()
			Local Delta:Float = (Time - Oldtime)/1000.0
			OldTime = Time

			For Local Particle:TParticle = EachIn TParticle.List
					If Particle.Remove Then Continue
					Particle.X :+ Particle.SpeedX * Delta
					Particle.Y :+ Particle.SpeedY * Delta
					Particle.SpeedY :+ 100.0*Delta
					If Particle.X &lt; 0 Or Particle.X &gt;=800 Or Particle.y &gt;= 600 Then Particle.Remove = True
			Next

		Until Flag
	End Function
End Type

Graphics 800,600

Local Time:Int = MilliSecs() + 1000
Local FPS:Int = 0
Local Frames:Int = 0

While Not KeyHit(KEY_ESCAPE) And Not AppTerminate()
	Cls
		For Local Particle:TParticle = EachIn TParticle.List
				If Particle.Remove
					TParticle.List.Remove(Particle)
					Continue
				End If
				Plot Particle.x,Particle.y
		Next
		DrawText(TParticle.List.Count(),10,10)
		DrawText FPS, 10,40
	Flip
	
	If MouseDown(1)
		Local MX:Int = MouseX()
		Local MY:Int = MouseY()
		
		If TParticle.Flag
			TParticle.Flag = False
			DetachThread CreateThread(TParticle.Run,Null)
		End If
		
		TParticle.Create(100,MX,MY)
	End If
	
	If TParticle.List.Count() = 0 And TParticle.Flag = False
		TParticle.Flag = True
	End If
	
	Frames :+ 1
	If MilliSecs() &gt;= Time
		Time :+ 1000
		FPS = frames
		frames = 0
	End If
	
	If MouseHit(2)
		GCCollect()
	End If
Wend

TParticle.Flag = True</textarea> <br><br></td></tr></table><br>
<a name="904299"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >ImaginaryHuman</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#74">[#74]</a></td></tr></table></td></tr><tr ><td class="posttext"> One other thing that I'm planning to use threads for, is to run multiple scripts in a script engine at the same time. Each thread can have its own instance of the script interpreter/execution engine and thus run scripts in parallel, increasing the total amount of script execution that can be done on multicore cpu's, plus providing the flexibility of running two or more scripts `at the same time`.<br><br>Each of my script execution engines has its own system of `processes` and a pre-emptive scheduler, so it can actually do the equivalent of multitasking threads without using real threads, but `real threads` make it even more capable of using the available CPU power, particularly if the script calls some function that is particularly time consuming and not very fine grained - the o/s would be able to give time to some other task in the middle of it. So overall threads would allow for more accurate timing and less `locking up`. I plan to run one script engine on each core of the cpu, so one thread per core.<br><br>One thing that you can't do with threads, though, is manage their distribution amongst cores or the way in which it would multitask or schedule other threads to run, because that's something usually managed by the o/s. But with some ingenuity I'm sure it should be possible to get threads to cooperatively multitask or something. <br><br></td></tr></table><br>
<a name="904303"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >BlitzSupport</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#75">[#75]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> <br>One thing that you can't do with threads, though, is manage their distribution amongst cores<br> <br></div><br><br>I haven't done it yet, but, on Windows NT at least, threads can be forced to a particular processor, or a 'preferred' processor specified. From what I've read, Microsoft advises just to leave it all to the OS though.<br><br>This example forces a whole <i>process</i> onto a specific CPU (right-click on the Task Manager entry and select "Set Affinity" to see the result), but you can do similar for threads using SetThreadAffinityMask or SetThreadIdealProcessor:<br><br><textarea class=codebox name="code" wrap=OFF readonly="true" rows="15" cols="80">
' -----------------------------------------------------------------------------
' NEW - Force to one CPU for single-core testing on multi-core [NT-ONLY!]
' -----------------------------------------------------------------------------

Extern "win32"
	Const PROCESS_SET_INFORMATION = $200
	Function GetCurrentProcessId ()
	Function OpenProcess (desiredaccess, inherithandle, processid)
	Function SetProcessAffinityMask (processhandle, processaffinitymask)
End Extern

' -------------------------------------------------------------------------
' Get process and open process handle...
' -------------------------------------------------------------------------

Local proc:Int = GetCurrentProcessId ()
Local handle:Int = OpenProcess (PROCESS_SET_INFORMATION, 0, proc)

' -------------------------------------------------------------------------
' Force process to CPU...
' -------------------------------------------------------------------------

' First CPU:
SetProcessAffinityMask (handle, %00000000000000000000000000000001)

' Second CPU:
'SetProcessAffinityMask (handle, %00000000000000000000000000000010)

' First 2 CPUs (default on dual-core):
'SetProcessAffinityMask (handle, %00000000000000000000000000000011)
	
' -------------------------------------------------------------------------

Graphics 640, 480

' -------------------------------------------------------------------------
' Use Task Manager -&gt; Right-click on program -&gt; Set Affinity to check!
' -------------------------------------------------------------------------

Repeat

	Cls
	Flip
	
Until KeyHit (KEY_ESCAPE)

End
</textarea> <br><br></td></tr></table><br>
<a name="904330"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Kurator</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#76">[#76]</a></td></tr></table></td></tr><tr ><td class="posttext"> I created a simple Threadpool-implementation.<br><br>A Threadool creates a defined number of Threads. These Threads do not die after their work is done, so there is no syscall overhead when they are needed again. They rest in a pool, used simply when they are needed and some work has to be done.<br><br>The work is organised in so called "Tasks"<br><br>You can create 1000's of different Tasks, and add them to an Workingqueue - The queue is simply First in - First out.<br><br>The queue simply looks for unused threads in its threadspool, and assigns them some work.<br><br>It's pretty effecient:<br><br><textarea class=codebox name="code" wrap=OFF readonly="true" rows="15" cols="80">SuperStrict

' *** THREADPOOL CLASSES START ***

Type TWorkQueue

	Field nThreads:Int
	Field threads:TThread[]
	Field queue:TList
	
	Field mut_List:Int
	
	Function Create:TWorkQueue(nThreads:Int = 10)
		Local t:TWorkQueue = New TWorkQueue
		t.nThreads = nThreads
		t.threads = New TThread[nThreads]
		t.queue = New TList
		t.mut_List = CreateMutex()
		
		For Local i:Int = 0 To nThreads-1
			t.threads[i] = TThread.Create( QueueWrapper, Object(t) )
		Next
		
		Return t
	EndFunction
	
	Function QueueWrapper:Object( data:Object)
		
		Local myTask:TWorkQueue = TWorkQueue(data)
		myTask.Execute()
	
	EndFunction
	
	Method AddTask(obj:TTask)
		LockMutex(mut_List)
		  queue.AddLast(obj)
		UnlockMutex(mut_List)		
	EndMethod
	
	Method DoWork:Int()
		If Not queue.IsEmpty()
			LockMutex(mut_List)
			  Local t:TTask = TTask(queue.First())
			UnlockMutex(mut_List)
			
			Local i:Int = 0

			While i &lt; nThreads
				If threads[i].GetStatus() = False
					threads[i].SetFunction(t.func, t.data)
					LockMutex(mut_List)
					  queue.RemoveFirst
					UnlockMutex(mut_List)
					threads[i].Start()
					Exit
				Else
					i :+ 1
				EndIf
			Wend

			Return True
		Else
			Return False
		EndIf
	EndMethod
	
	Method Execute()
	
		' Dummy
		
	EndMethod

EndType


Type TTask

	Field func:Object( data:Object )
	Field data:Object
	
	Method Run()
		If func Then func(data)
	EndMethod
	
	Function Create:TTask(func:Object( data:Object ), data:Object )
		Local t:TTask = New TTask
		t.func = func
		t.data = data
		Return t

	EndFunction
	
EndType

Type TThread
	
	Field id:Int
	Field mutex:Int
	
	Field func:Object( data:Object )
	Field data:Object
	
	Field working:Int

	
	Function Create:TThread(func:Object( data:Object ), data:Object)
		Local t:TThread = New TThread
		t.id    = CreateThread( ThreadWrapper, Object(t) )
		t.mutex = CreateMutex()
		t.func = func
		t.data = data
		t.working = False
		
		LockMutex(t.mutex)

		Return t

	EndFunction
	
	Function ThreadWrapper:Object( data:Object)
		
		Local myTask:TThread = TThread(data)
		myTask.Execute()
	
	EndFunction
	
	Method SetFunction(func:Object( data:Object ), data:Object)
		Self.func = func
		Self.data = data
		Self.working = False
	EndMethod

	Method GetStatus:Int()
		Return working
	EndMethod
	
	
	Method Destroy()
		DetachThread(id)
		id = 0
		CloseMutex(mutex)
		mutex = 0
		working = False
		func = Null
		data = Null
	EndMethod
	
	Method Execute()

		Repeat
			
			If Self.working = True 
				working = Self.DoWork()
			EndIf
			
			If Self.working = False
				LockMutex(mutex)
			EndIf
	
		Forever
	
	EndMethod
	
	Method DoWork:Int()
		If func Then func(data)
		Return False
	EndMethod
	
	Method Start()
		UnlockMutex(mutex)
		Self.working = True
	EndMethod
	
	Method Suspend()
		Self.working = False
	EndMethod
	
EndType

' *** THREADPOOL CLASSES END ***


' ***** EXAMPLE START ****
' Demo Functions, just generate some heavy Workload :)


Function fTest1:Object(data:Object)
	Local superCalcResult:Double
	For Local x:Int = 0 To 1000000
		superCalcResult = x*Cos(x)+Tan(x)*x/x
	Next
EndFunction

Function fTest2:Object(data:Object)
	Local superCalcResult:Double
	For Local x:Int = 0 To 1000000
		superCalcResult = x*Cos(x)+Tan(x)*x/x
	Next
EndFunction


'Create a WorkQueue with 8 preinitalised Threads waiting for work
Local q:TWorkQueue = TWorkQueue.Create(8)


'Create a LOT of Tasks to be done

Local test1:TTask[] = New TTask[200]
Local test2:TTask[] = New TTask[200]


'Assign the Functions you want to be done to the Tasks
'I'm pretty lazy - using, just the same functions :)
For Local i:Int = 0 To 199
	test1[i] =  TTask.Create(fTest1, String(i))
	test2[i] =  TTask.Create(fTest2, String(i))
Next

Print "Initialized..."
' To prove that ther is no CPU time wasted with 8 Threads waiting for work (look at the Taskmanager)
Delay 1000
Print "Starting..."


'Assign the 400 Tasks to the WorkQeue

For Local i:Int = 0 To 199
	q.AddTask(test1[i])
	q.AddTask(test2[i])
Next

Local starttime:Int = MilliSecs()

While Not KeyHit(KEY_ESCAPE)
	'Update the WorkQueue
	If Not q.DoWork() Exit
	'Print q.queue.Count()
	'it should also be possible to but this loop in an extra thread, maybe in future :)
Wend

Print "Duration "+String(MilliSecs()-starttime)+" ms"
</textarea><br><br>I'm using a Quadcore Intel Q6600 (2.4 GHz)<br><br>Here are my results with different numbers of threads created on initialization:<br><br>1 Thread  in Threadpool: 48818 ms<br>2 Threads in Threadpool: 24178 ms<br>4 Threads in Threadpool: 12234 ms<br>8 Threads in Threadpool: 12230 ms<br><br>So it scales pretty lineary (of course caused by the simple workload with no raceconditions :) )<br><br>Have fun with it <br><br></td></tr></table><br>
<a name="904331"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >AlexO</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#77">[#77]</a></td></tr></table></td></tr><tr ><td class="posttext"> Grey Alien<br><div class="quote"> <br>Thanks for the explanation Gabriel. To be honest I only see it as useful for loading whilst animating on the types of games I make. Maybe I'll try this for my next game. Thing is most, players aren't bothered by 1 second loading times anyway :-) <br> <br></div><br><br>One application you may find useful for casual games would be to thread particle engines. This would allow more intricate/elaborate particle animations with minimal hit on the rest of the game engine. <br><br></td></tr></table><br>
<a name="904354"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Winni</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#78">[#78]</a></td></tr></table></td></tr><tr ><td class="posttext"> These developers wrote a few interesting things about multi-threading in games:<br><br><a href="http://www.powerof2games.com/node/36" target="_blank">http://www.powerof2games.com/node/36</a> <br><br></td></tr></table><br>
<a name="904376"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >plash</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#79">[#79]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> * After svn updating, you will need to 'bmk -a -h' to rebuild all modules in 'threaded mode'. <br></div>That would be 'bmk makemods -a -h' ;) <br><br></td></tr></table><br>
<a name="904581"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Banshee</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#80">[#80]</a></td></tr></table></td></tr><tr ><td class="posttext"> Thank you for taking the time to do this module Mark.  I am really exciting to have the chance to play around with threads, not just learning something new, but harnessing the full power of modern systems - fantastic!<br><br>My question:<br>Am I missing the obvious, but i've no idea how to access the SVN ? <br><br></td></tr></table><br>
<a name="904587"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >ImaginaryHuman</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#81">[#81]</a></td></tr></table></td></tr><tr ><td class="posttext"> Is SVN for Windows only? <br><br></td></tr></table><br>
<a name="904588"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Banshee</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#82">[#82]</a></td></tr></table></td></tr><tr ><td class="posttext"> No SVN is a technology, like FTP except it is specifically for source code and allows multiple programmers to work together on the same source and handles merging of files, and allows you to roll back to old versions.  It's like a central repository for programming teams to work with that is fully historical.  It's very powerful, and apparently Blitz has one with code I want on it ! lol <br><br></td></tr></table><br>
<a name="904590"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >GfK</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#83">[#83]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> No SVN is a technology, like FTP except it is specifically for source code <br></div>Not completely accurate.  You don't *have* to use it for source code.  You can use it for any file that gets revised from time to time. <br><br></td></tr></table><br>
<a name="904592"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Mark Tiffany</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#84">[#84]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> Am I missing the obvious, but i've no idea how to access the SVN ? <br></div><br><a href="/posts.php?topic=74439" target="_blank">SVN thread</a><br><a href="/posts.php?topic=76731" target="_blank">Seb's guide</a> (Maxgui specific, but should help)<br><br><div class="quote"> Is SVN for Windows only? <br></div><br>No.  Google SVN and your platform of choice.  I'd suggest TortoiseSVN for Win, and RapidSVN for Linux.  I believe SmartSVN is okay for macos. <br><br></td></tr></table><br>
<a name="904624"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Banshee</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#85">[#85]</a></td></tr></table></td></tr><tr ><td class="posttext"> Lots of flaffing around learning about bmk, but i'm there - it's terrific !  Cheers Mark. <br><br></td></tr></table><br>
<a name="904746"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Banshee</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#86">[#86]</a></td></tr></table></td></tr><tr ><td class="posttext"> Can I ask is there some guidance somewhere on mutexing, it's a new concept to me so I wanted to check a few things?<br><br>Do I only need to lock data down if it is being written too?  Or would that cause problems if a read operation started just before a write operation - should I lock all data down?<br><br>I've wiki'd on mutexing but it doesnt reveal much except what the concept is and the docs are, well, not written yet :)  Can anyone offer some basic guidance on it for me please? <br><br></td></tr></table><br>
<a name="904752"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Mark Tiffany</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#87">[#87]</a></td></tr></table></td></tr><tr ><td class="posttext"> While I've not read this (or used threading yet!), Brucey's posted links to pages on this site before, which while not max specific, look like they might help with concepts:<br><br><a href="http://www.pdc.kth.se/doc/osf/osf40b/HTML/AA-Q2DPC-TKT1_html/thrd0036.html#mutex_sec" target="_blank">MUTEXES</a> <br><br></td></tr></table><br>
<a name="904757"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Brucey</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#88">[#88]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> Do I only need to lock data down if it is being written too? <br></div><br>You should lock all shared data access, both reading and writing, if you want to be sure of its state at the time you access it.<br><br>Unless of course, you don't mind reading data that may return out-of-date results? (a bit like a dirty-read in database-land) - but most of the time you will want all access locked.<br><br><br>The latest SVN also has some new functionality - <b>Condition Variables</b>. They allow you to have a thread "wait" inside a locked section. This lets you have a much finer grain of synchronisation between threads. While "waiting", the thread releases its lock, allowing others to lock/unlock the mutex. When signalled, the thread regains its lock, and carries as before.<br><br>This is a very basic example of using a condition variable :<br><textarea class=codebox name="code" wrap=OFF readonly="true" rows="15" cols="80">
SuperStrict

Framework BRL.StandardIO
Import Pub.Threads

Global mutex:Int = CreateMutex()
Global cond:Int = CreateCond()

Global resources:Int
Global finished:Int
Const max_res:Int = 1000

Local getter:TThread = New TThread

Local count:Int
While count &lt; 50

	Delay 100
	AddResources(100)
	
	count:+ 1
	
Wend
finished = True
BroadcastCond(cond) ' tidy up :-p

Delay 1000

End


Function GetResources()
	Print "getting resources"
	
	LockMutex(mutex)
	While resources &lt; max_res And Not finished
		Print "waiting..."
		WaitCond(cond, mutex)
	Wend
     
	Print "processing resources"

	resources :- max_res
	UnlockMutex(mutex)
End Function

Function AddResources(amount:Int)
	Print "adding resources : " + amount
	
	LockMutex(mutex)
	resources :+ amount
	SignalCond(cond)
	UnlockMutex(mutex)
End Function


Type TThread
	Field handle:Int
	
	Method New()
		handle = CreateThread( Self.Init,  Object( Self ) )
	End Method

	Function Init:Object( data:Object) Final
		Local thread:TThread = TThread(data)
		thread.Run()
	End Function
	
	Method Run()
		While Not finished
			GetResources()
		Wend
	End Method
	
End Type
</textarea><br><br><br>You just need to be careful when crafting your thread interaction, that you don't get into a situation that Thread A has a lock on Mutex 1, and is waiting to lock Mutex 2, while Thread B has a lock on Mutex 2, and is waiting to lock Mutex 1... oops.. :-p <br><br></td></tr></table><br>
<a name="904787"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Retimer</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#89">[#89]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> You just need to be careful when crafting your thread interaction, that you don't get into a situation that Thread A has a lock on Mutex 1, and is waiting to lock Mutex 2, while Thread B has a lock on Mutex 2, and is waiting to lock Mutex 1... oops.. :-p  <br></div><br><br>What about Thread Alpha, Thread Theta, Thread Z and Thread Magneta running a perpendicular wait to Mutex 18, 76 and 22? lol..lets not make it confusing for people or anything =P <br><br></td></tr></table><br>
<a name="904873"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Otus</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#90">[#90]</a></td></tr></table></td></tr><tr ><td class="posttext"> Cool! Why haven't I visited the site for a few days?!?<br><br>*Starts TortoiseSVN...* <br><br></td></tr></table><br>
<a name="904886"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Grisu</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#91">[#91]</a></td></tr></table></td></tr><tr ><td class="posttext"> I'm new to this. <br>Could the bmx compiler benefit from threading? <br>I.e. shorter build times for modules and our apps? <br><br></td></tr></table><br>
<a name="904891"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >ImaginaryHuman</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#92">[#92]</a></td></tr></table></td></tr><tr ><td class="posttext"> Also now that Max has threading, couldn't there be a threaded version of the basic libraries of BlitzMax *itself*, to provide things like asynchronous file access as part of the language, just as a starter? <br><br></td></tr></table><br>
<a name="904897"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Brucey</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#93">[#93]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> Could the bmx compiler benefit from threading?  <br></div><br>Messy... it would have to build an ordered process hierarchy, so that dependent modules get built first. Modules that then had no other dependencies could then in theory be compiled at the same time.<br>I've given it some thought, but haven't actually tried it yet. Not sure how much difference it would make - especially if you already turn on the "super quick build" option. <br><br></td></tr></table><br>
<a name="905717"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >plash</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#94">[#94]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> Also now that Max has threading, couldn't there be a threaded version of the basic libraries of BlitzMax *itself*, to provide things like asynchronous file access as part of the language, just as a starter? <br></div>Threading is not standard, yet. ASync would be interesting, but unless your loading a lot of files at once it won't be much use (loading 1 file, have to wait until it is finished to use it.) <br><br></td></tr></table><br>
<a name="905749"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >skn3</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#95">[#95]</a></td></tr></table></td></tr><tr ><td class="posttext"> Cool!<br><br>Just tried this on my lunch break (after hassling with bloody MinGW needing a restart for path to take effect). Works really well!<br><br>I can see a few immediate uses for this. One of those being a network library. Which I think I may have to make!!! Could open a new thread for sending files. Dealing with database updates, etc! Oh that and finally the ability to have tcp that doesn't screw your framerate over!<br><br>Have struggled immensley in the past making network libraries, having to resort to splitting packets into tiny sizes, using a seperate exe with local coms, you name it I have done it!<br><br>Awesome stuff, thanking you greatly Mr Mark Sibly! <br><br></td></tr></table><br>
<a name="908059"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Dreamora</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#96">[#96]</a></td></tr></table></td></tr><tr ><td class="posttext"> Somehow I missed this news, have not been much on the board here lately.<br><br>Great to see this happening even if pure experimental. Hopefully at some point with semaphores or even better monitors. Mutex are, thought nice, a near guarantee to run into walls depending on the implementation which don't exist with Semaphores<br>Luckily I won't have those issues as the threads work on distinct stuff and only need Mutex to block the access to queues temporally when adding / removing jobs to work on.<br>There are various uses for it on my work (script handling, networking, potentially the MySQL related stuff as well. all feeding global lists with data for the main thread and vice versa). Potentially it will also allow me to push my "node" approach even further. Right now its main app - tcp - node and pushing many distinct nodes that have to replicate the data. With the threads part of that can be gathered on the main app, making the node potentially a fully distinct unit for larger scale / math jobs instead of just a replacement for threads<br><br><br>Thank you very much for this chance :) <br><br></td></tr></table><br>
<a name="908958"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Arowx</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#97">[#97]</a></td></tr></table></td></tr><tr ><td class="posttext"> Just getting to grips with this as I'm very keen to thread the loading of music in the background!<br><br>Got threaded building working, and the Coffee,Inc example appears to work fine!<br><br>But the play and load sound whilst loading and displaying an image example from REDi keeps failing to load the image, in my case a small png failing with a Null exception when it gets to the MidHandleImage(Image) line!<br><br>Is anyone else having this issue with this example?<br><br>Running on Vista, tried to change the AudioDriver to OpenAL to get some sound playing (a known problem with Vista) but currently no joy! <br><br></td></tr></table><br>
<a name="909040"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Mark Tiffany</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#98">[#98]</a></td></tr></table></td></tr><tr ><td class="posttext"> From mark's post at the top:<br><br><div class="quote"> * Lots of OS specific stuff has its own rules when it comes to threading: GL contexts are 'per-thread'; dx devices are 'main thread only' (I think - perhaps just in fullscreen?); Mac's Cocoa is 'mostly' threadsafe etc. So don't expect to be able to 'load images in the background' suddenly/magically - all this stuff will take time to learn about and find the right approach for. <br></div><br><br>i.e. if you load an image in a separate thread, it may exist in a separate graphics mode, and hence not be accessible.<br><br>I suspect the threadsafe way to load an image or sound in a background thread would be to actually load it into a bank, pass that bank back to the main thread, and the main thread can then create the image / sound.<br><br>But I'm no expert on threading, and haven't played with the goodies yet myself! <br><br></td></tr></table><br>
<a name="909483"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Kurator</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#99">[#99]</a></td></tr></table></td></tr><tr ><td class="posttext"> Hm, <br><br>I also never tried it, but I think you can load it in another thread, but only do the Draw-Call in the main-Thread <br><br></td></tr></table><br>
<a name="910141"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >JoshK</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#100">[#100]</a></td></tr></table></td></tr><tr ><td class="posttext"> I think loading files like textures asynchrously is a little overblown.  If you designed your file format right, the loading should not take much time at all.  The main delay is in uploading the data to the video card, which must be done by the main thread.<br><br>I have heard DX11 is going to be a multithreaded API, i.e. each thread can access it, but we'll see how that works out in practice. <br><br></td></tr></table><br>
<a name="910765"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >ImaginaryHuman</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#101">[#101]</a></td></tr></table></td></tr><tr ><td class="posttext"> Presumably if you use LoadPixmap instead of LoadImage, you can have one thread loading pixmap data and another thread (or main thread) can be uploading to the graphics card.<br><br>It would be nice if you could be doing both at the same time, ie as the pixmap data is being streamed from disk, it starts to be uploaded to the graphics card, but that would require mutexes/conditions to be used to stop the main thread from reading data that hasn't been loaded yet, which presumably would mean having to add mutexes/conditions to pixmap loader (doable) and the uploader (probably, maybe not doable).<br><br>A way to avoid having to do those locks would be to be loading several pixmaps and to be just `one pixmap behind` in your upload to the graphics card. ie you load one pixmap, then when it's done you start the main thread uploading it to the graphics card while you load another pixmap in the second thread, and so on. <br><br></td></tr></table><br>
<a name="910766"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >ImaginaryHuman</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#102">[#102]</a></td></tr></table></td></tr><tr ><td class="posttext"> So when do threads stop being `experimental` and start being something `official`? <br><br></td></tr></table><br>
<a name="910847"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Galaxy613</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#103">[#103]</a></td></tr></table></td></tr><tr ><td class="posttext"> I was thinking, couldn't you use threads to make a animated loading screen? While stuff is loading in the main thread, you could have a secondary thread drawing a animated loading screen at the same time... <br><br></td></tr></table><br>
<a name="910874"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Kurator</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#104">[#104]</a></td></tr></table></td></tr><tr ><td class="posttext"> You can do it the other way round, Drawing Operations have do be done from the main thread, you can load Data in a Backgroundthread <br><br></td></tr></table><br>
<a name="910893"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >itsdanreed</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#105">[#105]</a></td></tr></table></td></tr><tr ><td class="posttext"> I've been waiting for threading for sometime, since I'm mostly doing some network server-client experiments this shall prove most usefull indeed. <br><br></td></tr></table><br>
<a name="911334"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >ImaginaryHuman</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#106">[#106]</a></td></tr></table></td></tr><tr ><td class="posttext"> What kind of range of values are returned as the thread handle when you create one? Does it start at 0 and increment from there each time you create, or is it just some random number up to 2^31?<br><br>ie how can I use the handle to provide storage local to a thread? <br><br></td></tr></table><br>
<a name="911455"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Kurator</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#107">[#107]</a></td></tr></table></td></tr><tr ><td class="posttext"> The handle ist nothing but an identifier for the os to manage its threads. The number returned is depending on the actual system state, threads since system startup, os version, threadlib used and last but not least depending on the platform (win, mac, linux)<br><br>to provide storage for your threads just use local varaiables and types. The thread itself can return :Object, so it is up to you what Data you want to get back, also you can pass in a :Object as a Parameter <br><br></td></tr></table><br>
<a name="911482"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >ImaginaryHuman</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#108">[#108]</a></td></tr></table></td></tr><tr ><td class="posttext"> I understand the use of locals and types and all that, that part is obvious. What I was asking is how to make sure a specific thread is referencing a specific type or array or index, even when it's doing exactly the same tasks with the same code as other threads. Obviously if I run a thread which calls MyFunction(), and that function does some processing which accesses a Global called MyGlobal, then other threads that call MyFunction are also going to be accessing MyGlobal, which is not what I want to happen. I want each thread to access a unique global which is somehow associated with that thread and only that thread, even though it's globally accessible data. (it must be global but just not used by every thread).<br><br>You spoke about passing in an object - I understand that object can't be just an Integer, it has to be a custom type. So if I pass it a custom type, how would the functions executed by that thread access that instance of that custom type? <br><br></td></tr></table><br>
<a name="911514"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >dynaman</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#109">[#109]</a></td></tr></table></td></tr><tr ><td class="posttext"> &gt; how would the functions executed by that thread access that instance of that custom type?<br><br>You will need to pass the instance of the type to the functions as a parameter. <br><br></td></tr></table><br>
<a name="911528"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >ImaginaryHuman</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#110">[#110]</a></td></tr></table></td></tr><tr ><td class="posttext"> Ouch. That's a no-go. What if the type instance were in a Global array and the array index itself was not passed the program, but rather the type instance is passed? Could the functions then access the type instance without having to pass it to them as a parameter? <br><br></td></tr></table><br>
<a name="911640"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Armitage 1982</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#111">[#111]</a></td></tr></table></td></tr><tr ><td class="posttext"> Does cyclic references explain here by Ziggy is about to change with the new Garbage collector introduced with Thread ?<br><a href="http://blitzmax.com/Community/posts.php?topic=63263#706547" target="_blank">http://blitzmax.com/Community/posts.php?topic=63263#706547</a><br><br>I'm also wondering why this new GC will only be available in the thread mode... <br><br></td></tr></table><br>
<a name="911655"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Yan</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#112">[#112]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> Does cyclic references explain here by Ziggy is about to change with the new Garbage collector introduced with Thread ? <br></div>Yes. It's my understanding that the BDWGC can handle cyclic references.<br><br><br><div class="quote"> <br>I'm also wondering why this new GC will only be available in the thread mode... <br></div>Mainly because it's slower than BRL's GC, I believe. <br><br></td></tr></table><br>
<a name="911663"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Armitage 1982</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#113">[#113]</a></td></tr></table></td></tr><tr ><td class="posttext"> Thanks<br>I will wait official release to test it.<br>I found the actual GC pretty fast so it's not an issue for me. <br><br></td></tr></table><br>
<a name="911665"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Kurator</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#114">[#114]</a></td></tr></table></td></tr><tr ><td class="posttext"> @ImaginaryHuman: If you need a "own" global, you have to "clone" the existing Object and pass the Copy insider the ThreadFunctionality.<br><br>Alternatively you can write a ThreadWrapper Class extending the Existing TThread Class and add some of the members you want to have inside. <br><br></td></tr></table><br>
<a name="911830"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >ImaginaryHuman</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#115">[#115]</a></td></tr></table></td></tr><tr ><td class="posttext"> but then you have to pass the object to all functions that the thread calls. <br><br></td></tr></table><br>
<a name="912064"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >TomToad</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#116">[#116]</a></td></tr></table></td></tr><tr ><td class="posttext"> Anybody else get errors with this?<br><pre class=code>SuperStrict
Global Mutex:Int

Function MyThread:Object(data:Object)
	LockMutex(Mutex)
	Print "Inside the thread"
	UnlockMutex(Mutex)
End Function

For Local i:Int = 1 To 10
	Local ThreadHandle:Int = CreateThread(MyThread,Null)
	DetachThread(ThreadHandle)
Next

WaitKey()
</pre> <br><br></td></tr></table><br>
<a name="912091"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Kurator</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#117">[#117]</a></td></tr></table></td></tr><tr ><td class="posttext"> You just declare the Mutex, but you didn't call the Init-Function<br><br>Global Mutex:Int = CreateMutex()<br><br>works <br><br></td></tr></table><br>
<a name="912097"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Armitage 1982</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#118">[#118]</a></td></tr></table></td></tr><tr ><td class="posttext"> Look like threaded version of BlitzMax is robust.<br>I wonder when it's gonna be official :)<br>So much stuff you can do with this to speed up games and applications ! <br><br></td></tr></table><br>
<a name="912107"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >ImaginaryHuman</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#119">[#119]</a></td></tr></table></td></tr><tr ><td class="posttext"> I guess when the next official full version or update gets released, and not via SVN only. <br><br></td></tr></table><br>
<a name="912179"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >ImaginaryHuman</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#120">[#120]</a></td></tr></table></td></tr><tr ><td class="posttext"> I'm trying to jump on the SVN bandwagon on OSX but I'm having problems with BMK. The SVN part of things went okay and I have the max files in Applications/BlitzMax1.30SVN folder. I used my original blitzmax 1.30 to compile the IDE. But now I need to bmk makemods -a -h to get the threaded version to work.<br><br>I went to the terminal and did:<br><pre class=code>
cd /applications/blitzmax1.30svn/bin
ls
</pre><br>It shows the presence of bmk and the other contents of bin, so I type:<br><pre class=code>
bmk makemods -a -h
</pre><br>but all I get is that the command is not found. I figured out to do `open bmk` but that won't let me pass parameters to it. I tried to `exec` it but that didn't work. What am I doing wrong or missing? <br><br></td></tr></table><br>
<a name="912265"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Kurator</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#121">[#121]</a></td></tr></table></td></tr><tr ><td class="posttext"> try like in unix ./bmk makemods -a -h <br><br></td></tr></table><br>
<a name="912317"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >xlsior</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#122">[#122]</a></td></tr></table></td></tr><tr ><td class="posttext"> Under UNIX, Linux, BSD, OSX , (and the other UNIX-derivative operating systems) your current folder is NOT in the path by default, unlike DOS/Windows.<br><br>To run a program in the current folder, you'll have to prefix ./ to it.<br><br>There are a couple of other 'special' indicators:<br><br>./ = current folder<br>../ = parent folder of the one you are in<br>../../ = two folders up from the folder you are in<br>../../../ = three folders up from the folder you are in, et.<br>~/ = the user's home directory <br><br>'.' for your current folder and '..' for the parent also work under DOS/Windows, but there the current folder is always checked before the other folders in the path, so normally you don't need to explicitely specify it. <br><br></td></tr></table><br>
<a name="912336"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >ImaginaryHuman</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#123">[#123]</a></td></tr></table></td></tr><tr ><td class="posttext"> ./bmk makemods<br><br>works, and <br><br>./bmk makemods -a<br><br>works, but<br><br>./bmk makemods -a -h<br><br>does not, it says there is an error in the command. I thought maybe I'd overwritten bmk with a version that I compiled, so I redownloded it via SVN, but still the same. I can't get the -h to work? <br><br></td></tr></table><br>
<a name="912342"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >ImaginaryHuman</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#124">[#124]</a></td></tr></table></td></tr><tr ><td class="posttext"> Ok I got it to work - I figured out that I needed to download the DEV version of Blitzmax, not the 1.30 version (doh). No wonder.<br><br>After that<br><pre class=code>
./bmk makemods -a -h
</pre><br>worked no problem. Then I had to build maxide from the command line, because the 1.30 IDE does not recognize some modules/commands so can't compile the ide ...:<br><pre class=code>
./bmk makeapp -t gui -h -d ./../src/maxide/maxide.bmx
</pre><br>Now I see the threaded build option in the IDE and can access the threads module. Gotta test it out now! Thanks again for the help. <br><br></td></tr></table><br>
<a name="913529"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Regular K</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#125">[#125]</a></td></tr></table></td></tr><tr ><td class="posttext"> Are there any known problems with MaxGUI and threads? I get some odd bugs when trying to manipulate a textarea in a thread (of course in between mutex lock/unlock) <br><br></td></tr></table><br>
<a name="913532"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >grable</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#126">[#126]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> I get some odd bugs when trying to manipulate a textarea in a thread <br></div><br>On Windows, TextAreas are not thread-safe, though proper synchronization should fix that.<br><a href="http://support.microsoft.com/kb/957833" target="_blank">http://support.microsoft.com/kb/957833</a> <br><br></td></tr></table><br>
<a name="913537"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Regular K</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#127">[#127]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> On Windows, TextAreas are not thread-safe, though proper synchronization should fix that.<br><a href="http://support.microsoft.com/kb/957833" target="_blank">http://support.microsoft.com/kb/957833</a>  <br></div><br><br>Hmm, thanks. Odd though, the textarea is disabled (so the user isn't editing it) and the command that edits it is wrapped in a lock/unlock mutex so its only edited by one thread at a time. Only thing I can think of is MaxGUI doing something I'm not aware of. <br><br></td></tr></table><br>
<a name="913558"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Htbaa</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#128">[#128]</a></td></tr></table></td></tr><tr ><td class="posttext"> Maybe it has something to do with the events it's emitting? <br><br></td></tr></table><br>
<a name="913726"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Regular K</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#129">[#129]</a></td></tr></table></td></tr><tr ><td class="posttext"> I managed to narrow it down to when the 'main thread' (whats the proper term?) tries to add a message before the thread  finishes its own message, it craps out.<br><br><pre class=code>Function Msg(Text:String)
	DebugPrint "msg: locking mutex (" + Text + ")"
	LockMutex(MsgMutex)
	
	DebugPrint "msg: adding " + Text
	AddTextAreaText(Output, Text + Chr(13))
	
	UnlockMutex(MsgMutex)
	DebugPrint "msg: unlocking mutex (" + Text + ")"
End Function</pre><br><br>an example of the text printed into the debug console would be:<br><br><pre class=code>thread: calling msg
msg: locking mutex (Called from 'Run' in 'TThread': this message should be added randomly every 50ms to 100ms)
msg: adding Called from 'Run' in 'TThread': this message should be added randomly every 50ms to 100ms
main loop: calling msg
msg: locking mutex (Called from main loop: this message should be added randomly every 50ms to 100ms)</pre><br><br>so<br>the thread locks mutex, adds its message, but right before it unlocks the mutex the 'main thread' tries to add a message. The program hangs while the 'main thread'tries to lock the mutex. <br><br></td></tr></table><br>
<a name="913868"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Kurator</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#130">[#130]</a></td></tr></table></td></tr><tr ><td class="posttext"> As far as i know, Win GUI is not threadsafe. Also in C# you may not acces the UI from a Background Thread <br><br></td></tr></table><br>
<a name="914002"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >*</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#131">[#131]</a></td></tr></table></td></tr><tr ><td class="posttext"> Will we see an official update (1.31) with threading soon? :) <br><br></td></tr></table><br>
<a name="914003"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Brucey</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#132">[#132]</a></td></tr></table></td></tr><tr ><td class="posttext"> Mixing threading and native-GUIs is going to cause a lot of headaches, me thinks :-p<br><br>Basically, you probably don't want to be doing anything to the UI controls themselves outside of the main thread. If you stick to that rule, you should be fine. <br><br></td></tr></table><br>
<a name="914597"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Regular K</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#133">[#133]</a></td></tr></table></td></tr><tr ><td class="posttext"> Mmkay, thanks. I managed to get around the errors by passing commands to the engine that are executed on the main thread. <br><br></td></tr></table><br>
<a name="914624"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >ImaginaryHuman</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#134">[#134]</a></td></tr></table></td></tr><tr ><td class="posttext"> I'm having a problem compiling the thread pool example by Kurator. It says it does not recognize the TList that's being defined in the field of the first custom type. Why would TList not be found when it's such a standard part of BlitzMax and the code isn't using a framework or imports?<br><br><pre class=code>
Strict

' *** THREADPOOL CLASSES START ***

Type TWorkQueue

	Field nThreads:Int
	Field threads:TThread[]
	Field queue:TList
</pre><br><pre class=code>
Identifier TList not found
</pre><br>Is it because the SVN IDE can't compile properly yet? Do I have to go to the terminal?<br><br>[Edit]It's also not finding TBank?[/edit] <br><br></td></tr></table><br>
<a name="914628"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >plash</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#135">[#135]</a></td></tr></table></td></tr><tr ><td class="posttext"> @ImaginaryHuman: That's strange.. The standard IDE definitely, by default, imports brl.linkedlist - perhaps it was a module change on the SVN side? (the standard imported module(s) do not import brl.linkedlist?) <br><br></td></tr></table><br>
<a name="914739"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >ImaginaryHuman</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#136">[#136]</a></td></tr></table></td></tr><tr ><td class="posttext"> When I try to compile a non-threaded app in the same ide I get different errors. I guess maybe this is just not ready for use yet, or are we supposed to import all modules?<br><br>Another question - load balancing. If my CPU has 4 cores, for example, and I am creating a thread pool, should I create just 4 threads, or would there be any benefit to creating more? If, say, each thread uses 75% of the cpu time for the core it's running on, it can't really be moved to another core or `split`, so does the o/s know to put each thread on a separate core? Or should I create like 16 threads and hope the o/s will distribute it more evenly? <br><br></td></tr></table><br>
<a name="914807"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Kurator</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#137">[#137]</a></td></tr></table></td></tr><tr ><td class="posttext"> how many threads to put in a pool depends on how many threads are locked while working. so if you only use 4 threads on a quadcore - and one of the threads locks waiting for another you loose computing-power because one of the cores idling :) <br><br></td></tr></table><br>
<a name="914883"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >ImaginaryHuman</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#138">[#138]</a></td></tr></table></td></tr><tr ><td class="posttext"> Good point. Any idea about why your pool example doesn't compile? <br><br></td></tr></table><br>
<a name="914884"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >plash</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#139">[#139]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> Any idea about why your pool example doesn't compile?  <br></div>You have tried doing the imports, right? <br><br></td></tr></table><br>
<a name="914906"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >ImaginaryHuman</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#140">[#140]</a></td></tr></table></td></tr><tr ><td class="posttext"> No idea what needs to be imported. And why would I need to, anyway? Has this compiled okay for anyone else? <br><br></td></tr></table><br>
<a name="914918"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Kurator</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#141">[#141]</a></td></tr></table></td></tr><tr ><td class="posttext"> It compiles for me when I tried it with my actual BlitzMax DEV - with the acutal IDE in this package <br><br></td></tr></table><br>
<a name="914984"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >ImaginaryHuman</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#142">[#142]</a></td></tr></table></td></tr><tr ><td class="posttext"> I'll have to download the sourcecode of the dev IDE again and recompile it. Does it need to be compiled *after* building multithreaded modules? <br><br></td></tr></table><br>
<a name="915043"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Kurator</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#143">[#143]</a></td></tr></table></td></tr><tr ><td class="posttext"> Good question, I compiled after building the mt - modules <br><br></td></tr></table><br>
<a name="915100"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >ImaginaryHuman</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#144">[#144]</a></td></tr></table></td></tr><tr ><td class="posttext"> Tried that, still doesn't work. <br><br></td></tr></table><br>
<a name="916838"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >ImaginaryHuman</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#145">[#145]</a></td></tr></table></td></tr><tr ><td class="posttext"> I get the following errors when I am initially building modules:<br><br><pre class=code>
Compiling:blitz.bmx
Archiving:blitz.debug.mt.macos.x86.a
libtool: file: /Applications/BlitzMax1.30SVN/mod/brl.mod/blitz.mod/bdwgc/.bmx/thread_local_alloc.c.debug.mt.macos.x86.o has no symbols
libtool: file: /Applications/BlitzMax1.30SVN/mod/brl.mod/blitz.mod/bdwgc/.bmx/win32_threads.c.debug.mt.macos.x86.o has no symbols
libtool: file: /Applications/BlitzMax1.30SVN/mod/brl.mod/blitz.mod/bdwgc/.bmx/backgraph.c.debug.mt.macos.x86.o has no symbols
libtool: file: /Applications/BlitzMax1.30SVN/mod/brl.mod/blitz.mod/bdwgc/.bmx/gc_dlopen.c.debug.mt.macos.x86.o has no symbols
libtool: file: /Applications/BlitzMax1.30SVN/mod/brl.mod/blitz.mod/bdwgc/.bmx/specific.c.debug.mt.macos.x86.o has no symbols
libtool: file: /Applications/BlitzMax1.30SVN/mod/brl.mod/blitz.mod/bdwgc/.bmx/pthread_stop_world.c.debug.mt.macos.x86.o has no symbols
libtool: file: /Applications/BlitzMax1.30SVN/mod/brl.mod/blitz.mod/bdwgc/.bmx/checksums.c.debug.mt.macos.x86.o has no symbols
libtool: file: /Applications/BlitzMax1.30SVN/mod/brl.mod/blitz.mod/bdwgc/.bmx/real_malloc.c.debug.mt.macos.x86.o has no symbols
libtool: file: /Applications/BlitzMax1.30SVN/mod/brl.mod/blitz.mod/bdwgc/.bmx/pcr_interface.c.debug.mt.macos.x86.o has no symbols
</pre><br><pre class=code>
Compiling:blitz.bmx
Archiving:blitz.release.mt.macos.x86.a
libtool: file: /Applications/BlitzMax1.30SVN/mod/brl.mod/blitz.mod/bdwgc/.bmx/thread_local_alloc.c.release.mt.macos.x86.o has no symbols
libtool: file: /Applications/BlitzMax1.30SVN/mod/brl.mod/blitz.mod/bdwgc/.bmx/win32_threads.c.release.mt.macos.x86.o has no symbols
libtool: file: /Applications/BlitzMax1.30SVN/mod/brl.mod/blitz.mod/bdwgc/.bmx/backgraph.c.release.mt.macos.x86.o has no symbols
libtool: file: /Applications/BlitzMax1.30SVN/mod/brl.mod/blitz.mod/bdwgc/.bmx/gc_dlopen.c.release.mt.macos.x86.o has no symbols
libtool: file: /Applications/BlitzMax1.30SVN/mod/brl.mod/blitz.mod/bdwgc/.bmx/specific.c.release.mt.macos.x86.o has no symbols
libtool: file: /Applications/BlitzMax1.30SVN/mod/brl.mod/blitz.mod/bdwgc/.bmx/pthread_stop_world.c.release.mt.macos.x86.o has no symbols
libtool: file: /Applications/BlitzMax1.30SVN/mod/brl.mod/blitz.mod/bdwgc/.bmx/checksums.c.release.mt.macos.x86.o has no symbols
libtool: file: /Applications/BlitzMax1.30SVN/mod/brl.mod/blitz.mod/bdwgc/.bmx/real_malloc.c.release.mt.macos.x86.o has no symbols
libtool: file: /Applications/BlitzMax1.30SVN/mod/brl.mod/blitz.mod/bdwgc/.bmx/pcr_interface.c.release.mt.macos.x86.o has no symbols
</pre><br>Some issue with blitz.mod? I don't get any of these errors when building regular non-threaded modules. Also if I build nonthreaded modules first then threaded ones, I can get the IDE to compile thread-using programs, but they crash. <br><br></td></tr></table><br>
<a name="916842"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >ImaginaryHuman</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#146">[#146]</a></td></tr></table></td></tr><tr ><td class="posttext"> I'm glad to say  all other examples work for me, except the thread pool example which just bombs out.<br><br>On another note- could BRL put a command like `CPUCount()` as part of the threading module itself, to hide all the multiplatform c sourcefiles and such? Winni's module is nice but it's still a nonstandard module. Can this be made official?<br><br>Also, wouldn't the linux version be easily writeable in blitzmax code if it's just reading a text file? <br><br></td></tr></table><br>
<a name="916993"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >foosh</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#147">[#147]</a></td></tr></table></td></tr><tr ><td class="posttext"> Would it be possible to release a pre-compiled threaded version? Updating from SVN and trying to run the included threading example yields the following error:<br><br>Module does not match commandline module.<br><br>I've recompiled all the modules, and it still doesn't work. <br><br></td></tr></table><br>
<a name="917036"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >TaskMaster</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#148">[#148]</a></td></tr></table></td></tr><tr ><td class="posttext"> Did you build all modules in threaded mode? <br><br></td></tr></table><br>
<a name="917176"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >ImaginaryHuman</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#149">[#149]</a></td></tr></table></td></tr><tr ><td class="posttext"> A question about detach thread: If I call DetachThread and let it keep executing while I go about my business doing other stuff... when the thread gets to the end of its work/function will the thread actually `close` in the same way that CloseThread closes it, and be deallocated ie removed from the system completely, or do I still have to explicitly call CloseThread at some point down the road? Does DetachThread do the same thing as CloseThread but just automatically `when it's finished`?<br><br>I think the answer is that once I call DetachThread it will close when it's finished and will no longer consume any CPU time whatsoever, but I would like someone else's interpretation??<br><br>Thanks. <br><br></td></tr></table><br>
<a name="917217"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >foosh</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#150">[#150]</a></td></tr></table></td></tr><tr ><td class="posttext"> @TaskMaster: Yes, I used the -a -h flags. <br><br></td></tr></table><br>
<a name="917560"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >ImaginaryHuman</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#151">[#151]</a></td></tr></table></td></tr><tr ><td class="posttext"> Does DetachThread close the thread completely when it's finished executing its function? Or do I need to call CloseThread at some point? <br><br></td></tr></table><br>
<a name="917977"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >foosh</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#152">[#152]</a></td></tr></table></td></tr><tr ><td class="posttext"> EDIT: D'oh, forgot to check "threaded build"<br><br>I keep getting errors whenever trying to compile any of the examples found:<br><br>Compile Error: Identifier 'CreateMutex' not found<br><br>I've rebuilt all the mods using -a -h, built the IDE from the SVN dev repository, what else am I missing? <br><br></td></tr></table><br>
<a name="917988"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >ImaginaryHuman</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#153">[#153]</a></td></tr></table></td></tr><tr ><td class="posttext"> AllocThreadData() has to be used like:<br><br>handle:Int=AllocThreadData()<br>SetThreadData(handle,obj)<br>obj=GetThreadData(handle)<br><br>Which is all okay, except this means you have to know the handle of the storage area in order to access the local storage area. You can't just store an object at like handle 0. And since you need something *outside of* local thread storage to tell you where IN the local thread storage to look to get your local data, it sort of defeats the purpose?<br><br>For me personally it means I cannot store a custom TThread type in TLS because the handle to the storage area has to be kept outside somewhere, and if I put it in a Field in the type this now means I have to pass that to all functions instead of functions being able to selectively call GetThreadData, which defeats the ability of using GetThreadData to read thread-specific data. I want to be able to store the TThread type instance within the TLS and access different instances of that from each thread, using the same code for each thread. Can't be done. If I have to pass the handle to the type or the handle to the thread storage, there is no point using TLS.<br><br>[Edit]Potential workaround??? ... if AllocThreadData() always returns the same value the *first* time it is called within a thread (which it appears to, at least for me), I could put that value in a Global and have every thread use that global as its handle to the local store, to be able to pull up the type instance local to the thread??? How predictable is that?[/edit][edit2]Nope, it's different for each thread[/edit2]<br><br>I think it could be done if thread storage was a stack and you push and pop objects to/from it, then I would know that if i push one value and pop it once (or read it without removing it), I could make this work? <br><br></td></tr></table><br>
<a name="918212"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >JoJo</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#154">[#154]</a></td></tr></table></td></tr><tr ><td class="posttext"> @foosh<br><br>see topic <br><a href="http://www.blitzbasic.com/Community/posts.php?topic=80696#908121" target="_blank">http://www.blitzbasic.com/Community/posts.php?topic=80696#908121</a> <br><br></td></tr></table><br>
<a name="918458"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >foosh</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#155">[#155]</a></td></tr></table></td></tr><tr ><td class="posttext"> thanks! <br><br></td></tr></table><br>
<a name="bottom"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td align="right"><a href="http://monkeycoder.co.nz" target="_blank"><img src="/img/monkey2.svg" ></a> <a href="https://github.com/blitz-research" target="_blank"><img src="/img/github.svg" ></a> <a href="https://discord.gg/qJccbSp" target="_blank"><img src="/img/discord.svg" ></a></td></tr></table><br></div><br><table width="100%"><tr><td></body></html lang="en">
