<!DOCTYPE html><html lang="en" ><head ><title >Floating Point Determinism</title><meta name='viewport' content='width=device-width, initial-scale=0.66'><meta name='description' content='language:basic, target:desktop, category:game development'><link rel="styleSheet" href="../skins/granite/style.css" type="text/css"><style type="text/css">div.bbcode {padding: 8px;background: #E5E5E5;color: #000000;border: 1px dashed #B4B4BE;}</style></head><body ><table width=100% cellspacing=0 cellpadding=0><tr ><td class="menubarleft"></td><td class="menubar"><table cellspacing="0" cellpadding="0"><tr ><td >&nbsp;</td><td class="menuitemleft"></td><td class="menuitem"><a href="/" class="menuitem">News</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/forums.php" class="menuitem">Forums</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/codearcs.php" class="menuitem">Code</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/logs.php" class="menuitem">Logs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/gallery.php" class="menuitem">Gallery</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/sdkspecs.php" class="menuitem">Specs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/search.php" class="menuitem">Search</a></td><td class="menuitemright"></td></tr></table></td><td class="menubarright"></td></tr></table><div class="main"><h1 >Floating Point Determinism</h1><a href="forums.php" >BlitzMax Forums</a>/<a href="topics.php?forum=102" >BlitzMax Programming</a>/<a href="#bottom" >Floating Point Determinism</a><br><br>
<a name="1083170"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Scienthsine</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#1">[#1]</a></td></tr></table></td></tr><tr ><td class="posttext"> Is there a blitzmax builtin way of setting floating point internal precision and round modes? If not, has anyone looked into what would be required to add a couple of functions to do this?<br><br>I was considering doing a quick rts in bmax, and I'd like to be able to use floats/doubles. With a lockstep networked game, sending only inputs, this needs to be exactly deterministic for all players involved in a game.<br><br>A few links to relevant information regarding the issue:<br><a href="http://www.christian-seiler.de/projekte/fpmath/" target="_blank">http://www.christian-seiler.de/projekte/fpmath/</a><br><a href="http://gafferongames.com/networking-for-game-programmers/floating-point-determinism/" target="_blank">http://gafferongames.com/networking-for-game-programmers/floating-point-determinism/</a><br><br>It would be best to have determinism across all 3 platforms, but this may be too difficult to achieve. At the very least setting the rounding mode, and internal precision should all the same executable to perform deterministically from one one processor to another.d<br><br>In addition to this, are there any other determinism problems in bmax? I remember some sort of rand() bug in one of the blitz languages causing some sort of problem... vaguely... <br><br></td></tr></table><br>
<a name="1083175"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >ImaginaryHuman</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#2">[#2]</a></td></tr></table></td></tr><tr ><td class="posttext"> How about implementing your own fixed point math with, say, numbers up to 24-bit and 8-bit decimal part? Or numbers up to 65536 and decimal part with same resolution? <br><br></td></tr></table><br>
<a name="1083198"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Scienthsine</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#3">[#3]</a></td></tr></table></td></tr><tr ><td class="posttext"> Well, that's an option. I would rather not though. That seems like it would introduce many headaches. The range would be significantly decreased. The computational overhead could be a ton. Without operator overloading and neat syntactical tricks, it would be ugly. I would have to implement complex trigonometric functions, or use tables. Finally, I really dislike the idea of having to mock up something that I could easily find a library for in another language... just to use my 'RAD' language.<br><br>So, although other solutions exist, they are _far_ from ideal compared to being able to set the rounding and precision in blitz. Now, they do have the advantage of being completely deterministic, even across platforms and processors... and possibly the best choice due to that. I still wish I had the option to set these in Blitz though. <br><br></td></tr></table><br>
<a name="1083203"></a>

<a name="1083204"></a>

<a name="1083205"></a>

<a name="1083206"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Czar Flavius</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#4">[#4]</a></td></tr></table></td></tr><tr ><td class="posttext"> My rts game uses its own fixed point. It's relatively basic but the game isn't heavy on physics. I have look up tables for sin, cos tan that have 3600 elements and the angle of "900" corrosponds to the angle of 90.0 and the angle of "2795" is the angle 279.5. I have a support program that generates these tables and dumps to a file which is incbinned in the main executable, so every exe will always generate the same values.<br><br>Each pixel is subdivided into 10, so a position of 5000, 5000 is drawn at pixel 500, 500. 5005, 5005 is halfway between 500, 500 and 501, 501. You could convert this to float in order to position the draw image. In retrospect, I think 10 is too high a subdivision. It also means positions need to be stored in longs unless the map is small.<br><br>Is there a better way? I don't know, but I'd be interested if there were. Don't use arbitrary position libraries, they are super too slow.<br><br>The built-in rand function isn't deterministic across platforms but Brucey has a random module replacement that is. It's handy to have two randoms (Brucey's and a third party one), and use the second one for unimportant things such as graphical candy, particle effects.<br><br><font class="tiny">Last edited 2011</font> <br><br></td></tr></table><br>
<a name="1083258"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >ImaginaryHuman</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#5">[#5]</a></td></tr></table></td></tr><tr ><td class="posttext"> Working with fixed point is easy, all you have to remember is to do a Shl or Shr when you want to convert it to an integer value? The rest of the time you do integer math on it which is possibly faster than doing floating point? <br><br></td></tr></table><br>
<a name="1083290"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Scienthsine</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#6">[#6]</a></td></tr></table></td></tr><tr ><td class="posttext"> Well, also when doing multiplies or divides you need to do some 'shifts'. Though not as simple as just shl/shr, as those are binary shifts ofcourse.<br><br>I'm just spoiled I guess. I get alot of ideas like using randomly generated maps with resources being destributed by different noise functions. I tend to make everything into a formula, and it just seems a pain to have to break those up into discrete steps worrying about overflows and crap at each step.<br><br>Anyway thanks for the responses guys. <br><br></td></tr></table><br>
<a name="1083341"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >ImaginaryHuman</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#7">[#7]</a></td></tr></table></td></tr><tr ><td class="posttext"> I don't think you can really change the float precision because that'd be changing the float format itself which is IEEE standard and made to work natively with the cpu or whatever? <br><br></td></tr></table><br>
<a name="1083369"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Scienthsine</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#8">[#8]</a></td></tr></table></td></tr><tr ><td class="posttext"> Ehh read the links ;)<br><br>The specification has provisions allowed for using higher internal precision when performing operations. So basically if you add two floats then multiply by another float, then the cpu can store the intermediate result of the add in a higher precision format, reducing the accumulated error from rounding and truncating between every operation. Intel has 80 bit registers and operatons for example. <br><br></td></tr></table><br>
<a name="1083528"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >BlitzSupport</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#9">[#9]</a></td></tr></table></td></tr><tr ><td class="posttext"> Weirdly, I found myself reading the Gaffer articles tonight (having got a really crude UDP server/client going), coming across floating-point determinism and remembering this thread...<br><br><div class="quote"> <br>The specification has provisions allowed for using higher internal precision when performing operations<br> <br></div><br><br>Not exactly an answer, but Mark <a href="/posts.php?topic=74977#838649" target="_blank">posted about this</a> some time ago, which you might find of interest. (See Floyd's post four up too.) <br><br></td></tr></table><br>
<a name="1083530"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Scienthsine</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#10">[#10]</a></td></tr></table></td></tr><tr ><td class="posttext"> Yep, thats caused by the same problem.<br><br>How hard would it be to try to impliment _controlfp?<br><a href="http://msdn.microsoft.com/en-us/library/e9b52ceh(v=vs.80).aspx" target="_blank">http://msdn.microsoft.com/en-us/library/e9b52ceh(v=vs.80).aspx</a><br><br>Mingw includes it too under it's math.h<br><br>Blitzmax uses mingw right? Is it possible to use this function somehow? I'm not really sure at what point this function is implimented.<br><br>Ofcourse there may still be issues with the optimizer reordering float instructions, which due to rounding are not fully communtative. Meaning we may still get different answers depending on platform, small code changes, debug or release mode, etc...<br><br>I'm fine with this though, aslong as the same executable always runs the same. Ofcourse with a cross platform system like ming, I wonder if it would optimize similarly... <br><br></td></tr></table><br>
<a name="bottom"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td align="right"><a href="http://monkeycoder.co.nz" target="_blank"><img src="/img/monkey2.svg" ></a> <a href="https://github.com/blitz-research" target="_blank"><img src="/img/github.svg" ></a> <a href="https://discord.gg/qJccbSp" target="_blank"><img src="/img/discord.svg" ></a></td></tr></table><br></div><br><table width="100%"><tr><td></body></html lang="en">
