<!DOCTYPE html><html lang="en" ><head ><title >Handling ReadBank error</title><meta name='viewport' content='width=device-width, initial-scale=0.66'><meta name='description' content='language:basic, target:desktop, category:game development'><link rel="styleSheet" href="../skins/granite/style.css" type="text/css"><style type="text/css">div.bbcode {padding: 8px;background: #E5E5E5;color: #000000;border: 1px dashed #B4B4BE;}</style></head><body ><table width=100% cellspacing=0 cellpadding=0><tr ><td class="menubarleft"></td><td class="menubar"><table cellspacing="0" cellpadding="0"><tr ><td >&nbsp;</td><td class="menuitemleft"></td><td class="menuitem"><a href="/" class="menuitem">News</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/forums.php" class="menuitem">Forums</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/codearcs.php" class="menuitem">Code</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/logs.php" class="menuitem">Logs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/gallery.php" class="menuitem">Gallery</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/sdkspecs.php" class="menuitem">Specs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/search.php" class="menuitem">Search</a></td><td class="menuitemright"></td></tr></table></td><td class="menubarright"></td></tr></table><div class="main"><h1 >Handling ReadBank error</h1><a href="forums.php" >BlitzMax Forums</a>/<a href="topics.php?forum=102" >BlitzMax Programming</a>/<a href="#bottom" >Handling ReadBank error</a><br><br>
<a name="1032831"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >ima747</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#1">[#1]</a></td></tr></table></td></tr><tr ><td class="posttext"> The following code can crash even if doesn't over run the end of the stream. It crashes with the error "Error reading from stream". I know the data in the file I'm reading from is bad (the program crashed while writing it), and I also know the length it's trying to load is reasonable and there's enough ram. Why might readbank be crashing with ugly data, and how can I detect that or in some way stop the crash and just have it report back that the file is bad?<br><br><pre class=code>
Local pixBank:TBank = CreateBank(length)
ReadBank(pixBank, stream, 0, length)
</pre> <br><br></td></tr></table><br>
<a name="1032835"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Pineapple</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#2">[#2]</a></td></tr></table></td></tr><tr ><td class="posttext"> This replacement function *should* prevent any screwups.<br><br>It returns -1 if the stream doesn't exist<br>0 if it runs into the file's end before the length is complete<br>1 if everything went as expected.<br><br><pre class=code>Function ReadBank:Int(bank:TBank Var,stream:TStream,offset:Long,count:Long)
	If Not stream Return -1
	For Local read:Long=0 To count-1
		If Eof(stream) And read&lt;count Then Return 0
		PokeByte bank,read+offset,ReadByte(stream)
	Next
	Return 1
End Function
</pre> <br><br></td></tr></table><br>
<a name="1032904"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >ima747</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#3">[#3]</a></td></tr></table></td></tr><tr ><td class="posttext"> I'm already doing all those checks.<br><br>I am reading plenty before the crash so I know the stream still exists, I check for remaining length before trying any read to ensure I won't hit the end... there's bad data caused by a crash during write and when I try to read through that space it crashes... I guess I could go byte by byte as in your example checking for EOF, but the stream should have plenty of length left so I doubt that would solve it...<br><br>I don't really know why it crashes ultimately, because even with bad data it should just read the garbage... it's like the stream dies when you try to read through that area... <br><br></td></tr></table><br>
<a name="1032907"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Jesse</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#4">[#4]</a></td></tr></table></td></tr><tr ><td class="posttext"> if for some reason the system crashed before completely writing the file then there is a possibility that your hard drive is corrupted at a point in the file location. the problem with that is that if the Hard Drive TOC is pointing to an area where there is no data or is corrupt then the drive reports an error reading and is what you are getting. You can do a hard Drive error checking and repair. The possible problem is that you may loose or recover all of the data in that file, more of a chance that you will loose all of it. try at your own risk. <br>I only mention it because that happened to me before and is not guarantee that it will solve your problem. I had a file reporting it was 1.5 GB when it was less than 1 MB <br><br></td></tr></table><br>
<a name="1032936"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Brucey</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#5">[#5]</a></td></tr></table></td></tr><tr ><td class="posttext"> It's not crashing.. it's throwing an exception, because the number of bytes returned by the Read() is less than it expected - i.e. it prematurely reached the end of the file.<br><br>ReadBytes() throws the Exception. If you don't want to handle that, you can always implement your own reading to avoid ReadBytes altogether - I personally don't like the way it handles the streams in that method. Internally ReadBytes() calls Read(). You may want to call that method and handle the &lt;&gt; expected cases yourself. <br><br></td></tr></table><br>
<a name="1033169"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >ima747</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#6">[#6]</a></td></tr></table></td></tr><tr ><td class="posttext"> Haven't had time to try this, but if it's hitting a premature end, i.e. the file says it's longer than it really is (which makes sense) if I were to set the read point to the last point in the file and read 1 byte from there, that should return an error, as it's past the premature end... I could then handle that 1 byte read rather than re-writing all of my reads... in my case if a file is damaged I can afford to just throw it away, I just need to know it's bad so I can give up on it, rather that getting kicked out by the exception. <br><br></td></tr></table><br>
<a name="1033177"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Nate the Great</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#7">[#7]</a></td></tr></table></td></tr><tr ><td class="posttext"> maybe the program that wrote it screwed up the file info on the HD so the computer thinks it is longer than it really is? <br><br></td></tr></table><br>
<a name="1033189"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >BlitzSupport</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#8">[#8]</a></td></tr></table></td></tr><tr ><td class="posttext"> Use Try/Catch -- see <a href="/codearcs.php?code=2477" target="_blank">this example</a>. It's used many times there, but see the first function, GetBMPInfo. I used to it prevent my program crashing on unexpected stream ends and it works a treat, with no obvious slowdown. <br><br></td></tr></table><br>
<a name="1033217"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >ima747</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#9">[#9]</a></td></tr></table></td></tr><tr ><td class="posttext"> re: nate<br>It did, that's the point, how to handle those situations without the program choking.<br><br>re: james<br>Thanks! I'll take a look, could save me much time. <br><br></td></tr></table><br>
<a name="1033325"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >ima747</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#10">[#10]</a></td></tr></table></td></tr><tr ><td class="posttext"> Question about try...<br><br>If I have a try block in a method or function, and I return IN the try block is that going to cause bad things (because the try never reached it's end) or is it fine? <br><br></td></tr></table><br>
<a name="1033383"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Brucey</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#11">[#11]</a></td></tr></table></td></tr><tr ><td class="posttext"> Yeah, it's fine. <br><br></td></tr></table><br>
<a name="bottom"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td align="right"><a href="http://monkeycoder.co.nz" target="_blank"><img src="/img/monkey2.svg" ></a> <a href="https://github.com/blitz-research" target="_blank"><img src="/img/github.svg" ></a> <a href="https://discord.gg/qJccbSp" target="_blank"><img src="/img/discord.svg" ></a></td></tr></table><br></div><br><table width="100%"><tr><td></body></html lang="en">
