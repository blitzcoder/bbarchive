<!DOCTYPE html><html lang="en" ><head ><title >Squish - compression module</title><meta name='viewport' content='width=device-width, initial-scale=0.66'><meta name='description' content='language:basic, target:desktop, category:game development'><link rel="styleSheet" href="../skins/granite/style.css" type="text/css"><style type="text/css">div.bbcode {padding: 8px;background: #E5E5E5;color: #000000;border: 1px dashed #B4B4BE;}</style></head><body ><table width=100% cellspacing=0 cellpadding=0><tr ><td class="menubarleft"></td><td class="menubar"><table cellspacing="0" cellpadding="0"><tr ><td >&nbsp;</td><td class="menuitemleft"></td><td class="menuitem"><a href="/" class="menuitem">News</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/forums.php" class="menuitem">Forums</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/codearcs.php" class="menuitem">Code</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/logs.php" class="menuitem">Logs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/gallery.php" class="menuitem">Gallery</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/sdkspecs.php" class="menuitem">Specs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/search.php" class="menuitem">Search</a></td><td class="menuitemright"></td></tr></table></td><td class="menubarright"></td></tr></table><div class="main"><h1 >Squish - compression module</h1><a href="forums.php" >Monkey Archive Forums</a>/<a href="topics.php?forum=511" >Monkey Projects</a>/<a href="#bottom" >Squish - compression module</a><br><br>
<a name="2017282"></a>

<a name="2017283"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >muddy_shoes</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#1">[#1]</a></td></tr></table></td></tr><tr ><td class="posttext"> I wanted to make my json files smaller and somewhat encrypted for release and so I created a monkey implementation of the LZW algorithm. I figure that I'm likely to need to add more compression/encoding tools down the road and it also seems likely to be of use to others so I've created a new module and put it up on google code: <a href="http://code.google.com/p/monkey-squish/" target="_blank">http://code.google.com/p/monkey-squish/</a><br><br>There's very little to it right now, just an LZW class with two functions, CompressString and DecompressString. Example usage (ignore the PerfTimer stuff):<br><br><textarea class=codebox name="code" wrap=OFF readonly="true" rows="15" cols="80">
Function TestLZW()
    Local uncompressed:String = LoadString("level0.json")

    Local pt:PerfTimer = New PerfTimer()
    pt.Start()
    Local compressed:String = LZW.CompressString(uncompressed)
    pt.Stop()
    Print "time to compress: " + pt.Elapsed()
    pt.Restart()
    uncompressed = LZW.DecompressString(compressed)
    pt.Stop()
    Print "time to decompress: " + pt.Elapsed()
    Print "uncompressed length: " + uncompressed.Length()
    Print "compressed length: " + cs.Length()
End
</textarea><br><br>Compression of test json level definition:<br>uncompressed length: 3980<br>compressed length: 1525<br><br>Times(ms):<br><br>Chrome/HTML5:<br>From init<br>time to compress: 15<br>time to decompress: 1<br>Repeat run<br>time to compress: 9<br>time to decompress: 1<br><br>Android - ZTE Blade<br>From init<br>time to compress: 403<br>time to decompress: 357<br>Repeat run<br>time to compress: 361<br>time to decompress: 134 <br><br></td></tr></table><br>
<a name="2017286"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >muddy_shoes</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#2">[#2]</a></td></tr></table></td></tr><tr ><td class="posttext"> Bah... it looks like I've neglected to test with extended characters so this currently won't work with unicode strings or with the encoded data strings used in some modules. I'll take a look at that tomorrow. <br><br></td></tr></table><br>
<a name="2017425"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >muddy_shoes</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#3">[#3]</a></td></tr></table></td></tr><tr ><td class="posttext"> Well the LZW compression is working. Now I'm left with the problem of Monkey's lack of binary file access. The in memory stuff is all fine, but saving and reloading puts the strings through various encoding mincers and the data doesn't survive. <br><br>I can encode the data in plain text but as the output seems to be using 2 bytes per char it renders the compression pointless for smaller files as it just bloats everything back out with 50% unused space. <br><br></td></tr></table><br>
<a name="2017428"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >muddy_shoes</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#4">[#4]</a></td></tr></table></td></tr><tr ><td class="posttext"> I've managed to find a subset of values that don't upset XNA's desire to be able to resolve a character for each value. As LZW can be restricted to an arbitrary dictionary size it's easy enough to reduce that output range at the cost of some compression efficiency.<br><br>The next problem is that the os.SaveString writes out UTF-16 with a BOM. GLFW, XNA, HTML5 and Flash skip that BOM and don't include it in the output string but Android leaves it in. I assume this is a bug.<br><br>If I can skip the BOM then I at least have loading of compressed files via the App.LoadString function. Save/LoadState is something else though. <br><br></td></tr></table><br>
<a name="2017479"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >muddy_shoes</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#5">[#5]</a></td></tr></table></td></tr><tr ><td class="posttext"> Actually, the android loader doesn't just include the BOM, it also completely ignores it and spits out 8-bit char encoding values. In other words, Monkey's own save format isn't compatible with itself across all targets. Great. <br><br></td></tr></table><br>
<a name="2017486"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >therevills</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#6">[#6]</a></td></tr></table></td></tr><tr ><td class="posttext"> This looks great muddy_shoes :)<br><br><div class="quote"> In other words, Monkey's own save format isn't compatible with itself across all targets <br></div> Sounds like a bug to me... <br><br></td></tr></table><br>
<a name="2017489"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >muddy_shoes</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#7">[#7]</a></td></tr></table></td></tr><tr ><td class="posttext"> It's a bug, but one that reflects a larger hole in the design thinking around what a Monkey String is. Not only does the GLFW target save strings in a format that the Android target doesn't read correctly, but Strings are inconsistently handled across the Save/LoadState and Save/LoadString interfaces as well as across targets. In some places they're UTF16LE, in others they're treated as ascii byte streams, elsewhere they're read as 16bit integers and then truncated to single bytes. <br><br></td></tr></table><br>
<a name="2017491"></a>

<a name="2017492"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >skid</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#8">[#8]</a></td></tr></table></td></tr><tr ><td class="posttext"> IMHO LoadString and SaveString should be renamed LoadAscii and SaveAscii with only 7 bit support and 0 meaning terminate ie illegal.<br><br>Muddy, you may have missed some earlier code I wrote to manage such things (mime64, utf etc.)<br><br><a href="http://monkeycoder.co.nz/Community/posts.php?topic=56" target="_blank">http://monkeycoder.co.nz/Community/posts.php?topic=56</a><br><br>I would look at wrapping your binary in mime64 as your file format and offer user both binary and string based interfaces to you API.<br><br>checking out squish.... <br><br></td></tr></table><br>
<a name="2017496"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >muddy_shoes</td><td align="right"><font class=tiny>(Posted 2011)</font>&nbsp;<a href="#9">[#9]</a></td></tr></table></td></tr><tr ><td class="posttext"> Thanks, but I've got text encoding functions. As I said above, encoding the compressed strings into ascii text is a bit pointless when the text is then saved out as UTF16.<br><br>As far as I'm concerned, if Monkey's intention is to provide a consistent code-base, the String representation should be consistent across all targets and supported consistently in all interfaces that take or return Strings. With the need to support multiple languages, plain ascii is a no-go unless it's only being used as lowest common denominator encoding and some form of unicode support is layered on top.<br><br>Edit: And if you're looking at squish I think the version currently on Google has a bug where it fails to reset the dictionary when it runs out of index values. I've fixed it but I need to unravel some of the test code I've been putting in to diagnose the various string read/write issues before committing it. <br><br></td></tr></table><br>
<a name="2017495"></a>

<a name="2017494"></a>

<a name="2017493"></a>

<a name="bottom"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td align="right"><a href="http://monkeycoder.co.nz" target="_blank"><img src="/img/monkey2.svg" ></a> <a href="https://github.com/blitz-research" target="_blank"><img src="/img/github.svg" ></a> <a href="https://discord.gg/qJccbSp" target="_blank"><img src="/img/discord.svg" ></a></td></tr></table><br></div><br><table width="100%"><tr><td></body></html lang="en">
