<!DOCTYPE html><html lang="en" ><head ><title >Call dll at runtime (no not CallDLL).</title><meta name='viewport' content='width=device-width, initial-scale=0.66'><meta name='description' content='Calls DLL functions and com methods during runtime, language=bb, category=Miscellaneous'><meta name='author' content='Spinduluz'><link rel="styleSheet" href="../skins/granite/style.css" type="text/css"><style type="text/css">div.bbcode {padding: 8px;background: #E5E5E5;color: #000000;border: 1px dashed #B4B4BE;}</style></head><body ><table width=100% cellspacing=0 cellpadding=0><tr ><td class="menubarleft"></td><td class="menubar"><table cellspacing="0" cellpadding="0"><tr ><td >&nbsp;</td><td class="menuitemleft"></td><td class="menuitem"><a href="/" class="menuitem">News</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/forums.php" class="menuitem">Forums</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/codearcs.php" class="menuitem">Code</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/logs.php" class="menuitem">Logs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/gallery.php" class="menuitem">Gallery</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/sdkspecs.php" class="menuitem">Specs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/search.php" class="menuitem">Search</a></td><td class="menuitemright"></td></tr></table></td><td class="menubarright"></td></tr></table><div class="main"><h1 ><a href=codearcs.php>Code archives</a>/<a href=codearcs.php?cat=9>Miscellaneous</a>/Call dll at runtime (no not CallDLL).</h1><div class="quote">This code has been declared by its author to be Public Domain code.</div><br><a href="1710.bb">Download source code</a><br><br><table width="100%" cellspacing="0" cellpadding="0"><tr ><td width="100%"><table width=100% cellspacing=0 cellpadding=0><tr ><td class=headleft></td><td class=head><table width=100% cellspacing=0 cellpadding=0><tr ><td >Call dll at runtime (no not CallDLL). by Spinduluz</td><td align="right">2006 </td></tr></table></td><td class=headright></td></tr></table></td></tr><tr ><td class="cell"> Ok this is something I found on my HD, it's not that old just that I forgotten I've done it.<br>Though I might as well share it with the community and with hopes that someone finds it usefull.<br><br>So what does this do?<br><br>Well it enables you to call dll functions during runtime. <br>First thing you have todo is to include "CallDLL.bb"<br><br>This file includes these functions.<br><br>CBegin()			- Allocate data and and prepares a call<br>CEnd()				- Free data and stuff	<br>CPushInt(Value%)		- Push an int on the stack<br>CPushFloat(Value#)		- Push a float on the stack<br>CPushString(Value$)		- Push a string on the stack<br>CPushBank(Value)		- Push an allocated bank on the stack<br>ComCallInt%(Func,Method)	- Make a call to an com object interface<br>				  returns an int<br>CallInt%(Func)			- Make a call to a func (ret value int)<br>CallStr$(Func)			- Same as above but returns a string<br>CallFloat#(Func)		- yeah yeah returns a float<br><br>What you have to remember when pushing values to the stack is to do it like you would do in assembler.<br>In the reverse order. This is because the first value you put on the stack is actually the last that is retrived.<br><br>Lets for example make a function that displays the good old MessageBox.<br><br>Lets take a peek on MessageBox function first though.<br><br>int MessageBox(HWND hWnd,LPCTSTR lpText,LPCTSTR lpCaption,UINT uType);<br><br>Example:<br>-----------------------------------------------------------<br><br>Include "CallDLL.bb"<br><br>Function MessageBox(hWnd%,Text_$,Caption$,uType%)<br><br>	Local User32 = LoadDLL("User32.dll") ; LoadLibrary<br><br>	if User32 = 0 Then RuntimeError("MessageBox : Failed to load User32.dll")<br><br>	Local MsgBox = ProcDLL(User32,"MessageBoxA") ;GetProcAddress<br><br>	CBegin()<br>	CPushInt(uType) ;In the reverse order remeber?<br>	CPushString(Caption)<br>	CPushString(Text_)<br>	CPushInt(hWnd)<br>	;Since MessageBox returns an int we'll use CallInt<br>	Local Ret = CallInt(Msgbox)<br> 	CEnd()<br>	FreeDLL(User32)<br>	Return Ret<br><br>End Function<br><br>Print MessageBox(0,"This is" + Chr(13) + "a test","Info",0)<br>WaitKey()<br><br>-----------------------------------------------------------<br><br>You can also make calls to Com objects using ComCallInt function.<br><br>So how do you do this?<br>Well lets take a look at the IUnknown interface methods and some of the IDirect3D9 methods.<br><br>(This is copied from d3d9.h)<br>STDMETHOD(QueryInterface)(THIS_ REFIID riid, void** ppvObj) PURE;<br>STDMETHOD_(ULONG,AddRef)(THIS) PURE;<br>STDMETHOD_(ULONG,Release)(THIS) PURE;<br>STDMETHOD(RegisterSoftwareDevice)(THIS_ void* pInitializeFunction) PURE;<br>STDMETHOD_(UINT, GetAdapterCount)(THIS) PURE;<br>STDMETHOD(GetAdapterIdentifier)(THIS_ UINT Adapter,DWORD Flags,D3DADAPTER_IDENTIFIER9* pIdentifier) PURE;<br><br>So lets say you make a call to Direct3D9Create create and it returns an interface address.<br>And you want to make a call Release.<br><br>Then all you have todo is to use ComCallInt,<br>i.e.<br>ComCallInt([Interface Address],8)<br><br>So why 8?<br><br>It's because it's the 3rd function in this interface.<br>QueryInterface is on 0 (ComCallInt([Addr],0)<br>AddRef is on 4 (ComCallInt([Addr],4)<br>Release on 8<br>RegisterSoftware on 12 ...<br>So on so forth, in other words [Address + Method * 4] (if you count QueryInterface as 0).<br><br>Well thats pretty much all folks. Hope it made sense.<br>And hope that the spacing isn't to f*cked up.<br><br>Ohh and this is rather untested (tested on 2 different computers).<br>So I take no responsibility of what this code might do to your computer and stuff.<br><br>Oh and I forgot to add the decl file needed for the extremly simple directx9 test that are in the zip.<br>(It creates an device and goes into fullscreen).<br>So I'll just add it to the code field below.<br><br>Oh and the blitzasm stuff is heavily based on Kevin Poole's stuff with my own additions.<br><br>Have fun...or not :-P , hope someone find this usefull.<br><br>Ahh well back to my wrestling match with Quaternions....<br><br><a href="http://w1.265.telia.com/~u26503161/dyndllcall.zip" target="_blank">Download</a> </td></tr><tr ><td class="cell"><pre class="code">.lib "d3d9.dll"
Direct3DCreate9_%(SDK%):"Direct3DCreate9"</pre></td></tr></table><br><a name="comments">Comments</a><br><br>None.<br><br><a href="codearcs.php" >Code Archives Forum</a><table width=100% cellspacing=0 cellpadding=0><tr ><td align="right"><a href="http://monkeycoder.co.nz" target="_blank"><img src="/img/monkey2.svg" ></a> <a href="https://github.com/blitz-research" target="_blank"><img src="/img/github.svg" ></a> <a href="https://discord.gg/qJccbSp" target="_blank"><img src="/img/discord.svg" ></a></td></tr></table><br></div><br><table width="100%"><tr><td></body></html lang="en">
