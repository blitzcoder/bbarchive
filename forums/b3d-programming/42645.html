<!DOCTYPE html><html lang="en" ><head ><title >Small problem with Ball physics code...</title><meta name='viewport' content='width=device-width, initial-scale=0.66'><meta name='description' content='language:basic, target:desktop, category:game development'><link rel="styleSheet" href="../skins/granite/style.css" type="text/css"><style type="text/css">div.bbcode {padding: 8px;background: #E5E5E5;color: #000000;border: 1px dashed #B4B4BE;}</style></head><body ><table width=100% cellspacing=0 cellpadding=0><tr ><td class="menubarleft"></td><td class="menubar"><table cellspacing="0" cellpadding="0"><tr ><td >&nbsp;</td><td class="menuitemleft"></td><td class="menuitem"><a href="/" class="menuitem">News</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/forums.php" class="menuitem">Forums</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/codearcs.php" class="menuitem">Code</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/logs.php" class="menuitem">Logs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/gallery.php" class="menuitem">Gallery</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/sdkspecs.php" class="menuitem">Specs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/search.php" class="menuitem">Search</a></td><td class="menuitemright"></td></tr></table></td><td class="menubarright"></td></tr></table><div class="main"><h1 >Small problem with Ball physics code...</h1><a href="forums.php" >Blitz3D Forums</a>/<a href="topics.php?forum=82" >Blitz3D Programming</a>/<a href="#bottom" >Small problem with Ball physics code...</a><br><br>
<a name="477474"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >D_Town_Tony</td><td align="right"><font class=tiny>(Posted 2005)</font>&nbsp;<a href="#1">[#1]</a></td></tr></table></td></tr><tr ><td class="posttext"> Can someone please help me with this Ball physics code, I adapted it from the Ball rolling physics example by Jeppe Nielsen.  I made it directional control using the arrow keys.<br><br>The problem is that at first pressing up,down,left,right works fine but after bouncing around the board for awhile the directions start to act as if the ball is turned, but I can't find in the code what does this, can someone please take a look and help me find whats causing this. Thanks in advance.  Press space to jump, do this a few times while moving around and the problem surfaces when you try to roll around.<br><br><br>Graphics3D 800,600,32<br>SetBuffer BackBuffer()<br>WBuffer False<br>HidePointer<br>SeedRnd MilliSecs()<br><br>;frametweening<br>Global gameFPS = 60<br>Global framePeriod = 1000 / gameFPS <br>Global frameTime = MilliSecs () - framePeriod<br>framePeriod = 1000 / gameFPS<br>frameTime = MilliSecs () - framePeriod<br><br>Const gravity#=-0.06<br><br><br>arena=CreatePlane()<br>EntityColor arena,Rnd(0,200),Rnd(0,200),Rnd(0,200)<br>PositionEntity arena,0,-5,0<br>EntityType arena,world_col<br><br>obj_1=CreateCube()<br>EntityType obj_1,world_col<br>PositionEntity obj_1,-10,-10,15<br>ScaleEntity obj_1,10,10,10<br>RotateEntity obj_1,45,90,0<br>EntityColor obj_1,Rnd(0,200),Rnd(0,200),Rnd(0,200)<br><br>obj_2=CreateSphere()<br>EntityType obj_2,world_col<br>PositionEntity obj_2,25,-1,-17<br>ScaleEntity obj_2,15,5,15<br>EntityColor obj_2,Rnd(0,200),Rnd(0,200),Rnd(0,200)<br><br>obj_3=CreateCube();walls<br>EntityType obj_3,world_col<br>PositionEntity obj_3,0,-10,0<br>ScaleEntity obj_3,70,70,70<br>EntityColor obj_3,Rnd(0,200),Rnd(0,200),Rnd(0,200)<br>FlipMesh obj_3<br><br>light=CreateLight(1)<br>RotateEntity light,30,20,0<br><br><br>camera=CreateCamera()<br>CameraClsColor camera,0,100,155<br>PositionEntity camera,0,600,-420<br>RotateEntity camera,55,0,0<br>CameraZoom Camera,10<br><br>ball.ball=ballnew(0,4,-40,2,.8,1)<br>ball.ball=ballnew(-10,4,-40,2,.8,2)<br>ball.ball=ballnew(10,100,-30,1.75,.8,3)<br><br>Const ball_col=1<br>Const world_col=3<br><br>Collisions ball_col,world_col,2,2<br>Collisions ball_col,ball_col,1,2<br><br>Type ball<br>Field Ball_Type<br>Field e ;entity<br>Field sphere<br>Field pivot<br>Field x#,y#,z# ; position in 3d-space<br>Field vx#,vy#,vz# ; velocity<br>Field ax#,ay#,az# ; acceleration<br>Field size#<br>Field bounce# ; bounce factor<br>Field vel#<br>Field vx2#,vy2#,vz2# ; temp velocity<br>Field xSpd#,xSpdMax#,xSpdMin#<br>Field zSpd#,zSpdMax#,zSpdMin#<br>End Type<br><br>Function ballnew.ball(x#,y#,z#,size#=1,bounce#=0.9,Ball_Type)	<br>	c.ball=New ball	<br>	c\x#=x#<br>	c\y#=y#<br>	c\z#=z#	<br>	c\size=size	<br>	c\bounce#=bounce#	<br>	c\e=CreatePivot()<br>	c\sphere=CreateSphere(16)	<br>	c\pivot=CreatePivot()	<br>	EntityType c\e,ball_col<br>	EntityRadius c\e,c\size	<br>	PositionEntity c\e,c\x,c\y,c\z<br>	ScaleEntity c\sphere,c\size,c\size,c\size	<br>	EntityColor c\sphere,Rnd(0,255),Rnd(0,255),Rnd(0,255)<br>	c\Ball_Type=Ball_Type<br>	c\xSpdMin#=-.02<br>	c\xSpdMax#=.02<br>	c\zSpdMin#=-.02<br>	c\zSpdMax#=.02<br>	Return c	<br>End Function<br><br>Function ballupdate()<br>	For c.ball=Each ball		<br>		c\vy#=c\vy#+gravity#<br><br>		c\vx#=c\vx#+c\ax#<br>		c\vy#=c\vy#+c\ay#<br>		c\vz#=c\vz#+c\az#<br><br>		c\x#=EntityX(c\e)<br>		c\y#=EntityY(c\e)<br>		c\z#=EntityZ(c\e)	<br>		TranslateEntity c\e,c\vx,c\vy,c\vz	<br>	Next<br>	UpdateWorld()	<br>	For c.ball=Each ball<br>		;correct velocity if collided<br>		c\vx2=(EntityX(c\e)-c\x)<br>		c\vy2=(EntityY(c\e)-c\y)<br>		c\vz2=(EntityZ(c\e)-c\z)	<br>		c\x#=EntityX(c\e)<br>		c\y#=EntityY(c\e)<br>		c\z#=EntityZ(c\e)	<br>		PositionEntity c\sphere,c\x,c\y,c\z<br>		PositionEntity c\pivot,c\x,c\y,c\z	<br>		If EntityCollided(c\e,world_col)	<br>			For i = 1 To CountCollisions(c\e)<br>			<br>			Ent=CollisionEntity (c\e, i)<br>				; Get the normal of the surface which the entity collided with. <br>				Nx# = CollisionNX(c\e, i) <br>				Ny# = CollisionNY(c\e, i) <br>				Nz# = CollisionNZ(c\e, i) 			<br>				; Compute the dot product of the entity's motion vector and the normal of the surface collided with. <br>				VdotN# = c\vx#*Nx# + c\vy#*Ny# + c\vz#*Nz# 				<br>				; Calculate the normal force. <br>				NFx# = -2.0 * Nx# * VdotN# <br>				NFy# = -2.0 * Ny# * VdotN# <br>				NFz# = -2.0 * Nz# * VdotN# 				<br>				; Add the normal force to the direction vector. <br>				c\vx# = c\vx# + NFx# * c\bounce#<br>				c\vy# = c\vy# + NFy# * c\bounce#<br>				c\vz# = c\vz# + NFz# * c\bounce#<br>				avx#=EntityPitch(c\sphere)<br>				avy#=EntityYaw(c\sphere)<br>				avz#=EntityRoll(c\sphere)<br>				;Rotate stuff<br>				;Get vector from center to collision<br>				dx1#=(CollisionX(c\e,i)-c\x)<br>				dy1#=(CollisionY(c\e,i)-c\y)<br>				dz1#=(CollisionZ(c\e,i)-c\z)<br>				dx2#=c\vx<br>				dy2#=c\vy<br>				dz2#=c\vz<br>				;Cross product<br>				cx# = ( dy1 * dz2 ) - ( dz1 * dy2 ) <br>				cy# = ( dz1 * dx2 ) - ( dx1 * dz2 ) <br>				cz# = ( dx1 * dy2 ) - ( dy1 * dx2 ) 															<br>				AlignToVector c\pivot,cx,cy,cz,1<br><br>                ;Add Force to other Ball<br>				For Hit.Ball = Each Ball<br>				If Hit\E = Ent Then<br>				    If Hit\Ball_Type=2 div=2<br>					If Hit\Ball_Type=3 div=1.5<br>					Hit\vx# = Hit\vx# - NFx#/div<br>					Hit\vy# = Hit\vy# - NFy#/div	;Force /2 assumes balls equal in mass<br>					Hit\vz# = Hit\vz# - NFz#/div<br>				End If<br>		  	    Next<br>			Next<br>			<br>			Nx# = CollisionNX(c\e, 1) <br>			Ny# = CollisionNY(c\e, 1) <br>			Nz# = CollisionNZ(c\e, 1) 				<br>			AlignToVector c\e,Nx#,Ny#,Nz#,2,0.5			<br>			c\vel#=Sqr(c\vx2*c\vx2+c\vy2*c\vy2+c\vz2*c\vz2)						<br>			;slow down due to friction<br>			c\vx#=c\vx*0.99<br>			c\vy#=c\vy*0.99<br>			c\vz#=c\vz*0.99<br>		EndIf<br>		EntityParent c\sphere,c\pivot								<br>		TurnEntity c\pivot,-c\vel#*(180/Pi)/c\size#,0,0<br>		EntityParent c\sphere,0<br>		c\ax#=0<br>		c\ay#=0<br>		c\az#=0			<br>	Next	<br>End Function<br><br>Function ballcontrol(Ball_Type)<br>	For c.ball=Each ball<br>	If Ball_Type=c\Ball_Type<br>;**** Add Directional Speed ****<br>       If KeyDown(203) And c\xSpd#&gt;c\xSpdMin#<br>       c\xSpd#=c\xSpd#-.001;Left<br>       EndIf<br>       If KeyDown(205) And c\xSpd#&lt;c\xSpdMax#<br>       c\xSpd#=c\xSpd#+.001;Right<br>       EndIf<br>       If KeyDown(200) And c\zSpd#&gt;c\zSpdMin#<br>       c\zSpd#=c\zSpd#+.001;Up<br>       EndIf<br>       If KeyDown(208) And c\zSpd#&lt;c\zSpdMax#<br>       c\zSpd#=c\zSpd#-.001;Down<br>       EndIf<br><br>;**** Subtract Directional Speed ****<br>       If Not KeyDown(203) And KeyDown(205)<br>        If c\xSpd#&lt;0 c\xSpd#=c\xSpd#*.96<br>        If c\xSpd#&gt;0 c\xSpd#=c\xSpd#*.96<br>        If c\xSpd#&lt;.0001 And c\xSpd#&gt;-.0001 Then c\xSpd#=0<br>       EndIf<br><br>       If Not KeyDown(200) And KeyDown(208)<br>        If c\zSpd#&lt;0c\zSpd#=c\zSpd#*.96<br>        If c\zSpd#&gt;0 c\zSpd#=c\zSpd#*.96<br>        If c\zSpd#&lt;.0001 And c\zSpd#&gt;-.0001 Then c\zSpd#=0<br>       EndIf<br><br>	    TFormVector c\xSpd#,0,c\zSpd#,c\e,0		<br>		c\ax#=TFormedX()<br>		c\ay#=TFormedY()<br>		c\az#=TFormedZ()<br>	<br>		If KeyHit(57);jump<br>			TFormVector 0,2,0,c\e,0			<br>			c\ax#=c\ax+TFormedX()<br>			c\ay#=c\ay+TFormedY()<br>			c\az#=c\az+TFormedZ()								<br>		EndIf<br>	EndIf<br>	Next<br>End Function<br><br>Function In_Action()<br>While Not KeyDown(1)<br>	; Frame limiting <br>	Repeat <br>		frameElapsed = MilliSecs () - frameTime <br>	Until frameElapsed <br>	frameTicks = frameElapsed / framePeriod <br>	frameTween# = Float (frameElapsed Mod framePeriod) / Float (framePeriod) <br>	; Update game and world state <br>	For frameLimit = 1 To frameTicks <br>		If frameLimit = frameTicks Then CaptureWorld <br>		frameTime = frameTime + framePeriod <br>		; ----------------------------------<br><br>ballcontrol(1)<br>ballupdate()<br><br>Next<br><br>RenderWorld frameTween<br>Text 10,10,"Rendered Tris : "+ TrisRendered()<br>Text 10,30,"Use the Arrow Keys to Move"<br>Text 10,40,"Use the Spacebar to jump"<br>Flip<br>Wend<br>End Function<br><br>While Not KeyDown(1)<br>In_Action()<br>Wend <br><br></td></tr></table><br>
<a name="477523"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >DJWoodgate</td><td align="right"><font class=tiny>(Posted 2005)</font>&nbsp;<a href="#2">[#2]</a></td></tr></table></td></tr><tr ><td class="posttext"> Well I think I know why it is doing it.  You are tforming a vector from the entity to the world.  All well and good but you are also aligning this entity to the normals of the collision with another ball.  The two combined are causing the problem.<br><br>Now I am not sure you need that aligntovector at all, and as for the ball control impulses I would apply them based on the camera yaw, which may be more useful. (Tform from a pivot which just yaws the camera).<br><br>Something else to bear in mind with colliding balls is that you can from memory get anywhere from 1 to 3 collisions per impact. (There is some code posted somewhere that demonstrates this - here it is <a href="http://www.blitzbasic.co.nz/Community/posts.php?topic=27138" target="_blank">http://www.blitzbasic.co.nz/Community/posts.php?topic=27138</a> ). You might want to account for this, but at the end of the day as long as the thing behaves as you want I would not worry too much. <br><br></td></tr></table><br>
<a name="477539"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >D_Town_Tony</td><td align="right"><font class=tiny>(Posted 2005)</font>&nbsp;<a href="#3">[#3]</a></td></tr></table></td></tr><tr ><td class="posttext"> YOU ARE MY NEW FAVORITE PERSON. <br><br></td></tr></table><br>
<a name="477541"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >D_Town_Tony</td><td align="right"><font class=tiny>(Posted 2005)</font>&nbsp;<a href="#4">[#4]</a></td></tr></table></td></tr><tr ><td class="posttext"> Taking out the aligntovector worked great <br><br></td></tr></table><br>
<a name="477572"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Barliesque</td><td align="right"><font class=tiny>(Posted 2005)</font>&nbsp;<a href="#5">[#5]</a></td></tr></table></td></tr><tr ><td class="posttext"> I'm afraid I've found a problem.  I tried pushing the system a little further by creating several objects.  Try this in place of the three lines to create the balls...<br><br><pre class=code>
For MakinBalls = 1 To 40
	ball.ball=ballnew(10+Rnd(0,5),100+Rnd(0,5),-30-Rnd(0,20), Rnd(1,2), 0.8, (MakinBalls Mod 3)+1) 
Next
</pre><br><br>I find that they gradually get stuck in space.  Looks to me like they're getting caught up in a perpetual loop reacting to collisions-- except that they aren't vibrating at all.  So I don't know.  I'll keep looking. <br><br></td></tr></table><br>
<a name="477609"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >DJWoodgate</td><td align="right"><font class=tiny>(Posted 2005)</font>&nbsp;<a href="#6">[#6]</a></td></tr></table></td></tr><tr ><td class="posttext"> Well as it stands it's only processing collisions when there is a world contact.   But it is a work in progress. <br><br></td></tr></table><br>
<a name="477610"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >D_Town_Tony</td><td align="right"><font class=tiny>(Posted 2005)</font>&nbsp;<a href="#7">[#7]</a></td></tr></table></td></tr><tr ><td class="posttext"> Barliesque-Thanks for pointing that out, fortunatly for me I don't need that many balls on the screen during the game. <br><br></td></tr></table><br>
<a name="477943"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Barliesque</td><td align="right"><font class=tiny>(Posted 2005)</font>&nbsp;<a href="#8">[#8]</a></td></tr></table></td></tr><tr ><td class="posttext"> Well it's a great little piece of code.  Would be nice to sort out that problem so it's usable for other projects as well---either new projects of your own, or others in the community.<br><br>Actually...  I don't think it's the <i>number</i> of balls that causes the problem.  It's just that having so many in there at once makes it more likely for the problem to occur.  If that's true, then it could happen infrequently even with only three balls. <br><br></td></tr></table><br>
<a name="bottom"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td align="right"><a href="http://monkeycoder.co.nz" target="_blank"><img src="/img/monkey2.svg" ></a> <a href="https://github.com/blitz-research" target="_blank"><img src="/img/github.svg" ></a> <a href="https://discord.gg/qJccbSp" target="_blank"><img src="/img/discord.svg" ></a></td></tr></table><br></div><br><table width="100%"><tr><td></body></html lang="en">
