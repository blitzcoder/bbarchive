<!DOCTYPE html><html lang="en" ><head ><title >Sprite Masking problem</title><meta name='viewport' content='width=device-width, initial-scale=0.66'><meta name='description' content='language:basic, target:desktop, category:game development'><link rel="styleSheet" href="../skins/granite/style.css" type="text/css"><style type="text/css">div.bbcode {padding: 8px;background: #E5E5E5;color: #000000;border: 1px dashed #B4B4BE;}</style></head><body ><table width=100% cellspacing=0 cellpadding=0><tr ><td class="menubarleft"></td><td class="menubar"><table cellspacing="0" cellpadding="0"><tr ><td >&nbsp;</td><td class="menuitemleft"></td><td class="menuitem"><a href="/" class="menuitem">News</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/forums.php" class="menuitem">Forums</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/codearcs.php" class="menuitem">Code</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/logs.php" class="menuitem">Logs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/gallery.php" class="menuitem">Gallery</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/sdkspecs.php" class="menuitem">Specs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/search.php" class="menuitem">Search</a></td><td class="menuitemright"></td></tr></table></td><td class="menubarright"></td></tr></table><div class="main"><h1 >Sprite Masking problem</h1><a href="forums.php" >Blitz3D Forums</a>/<a href="topics.php?forum=82" >Blitz3D Programming</a>/<a href="#bottom" >Sprite Masking problem</a><br><br>
<a name="365016"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Nesbitt</td><td align="right"><font class=tiny>(Posted 2004)</font>&nbsp;<a href="#1">[#1]</a></td></tr></table></td></tr><tr ><td class="posttext"> I'm creating a basic solar system simulator. I want to have spheres for planets, with floating text labels under them. The logical thing seemed to use sprites, so I wrote code to create a texture, draw the text on the screen, and copy the text to the texture using copyrect. Then I created a sprite and told it to use that texture.<br><br>Everything was going fine until I tried to make the sprite transparent. You see, I just want the words to float in space with no annoying black box around them. I had already set the "flags" value in the createtexture command to 48 in order to use the ClampU and ClampV modes and prevent the text from wrapping, and it worked just fine... so I added 4 to turn on masking as well, and then things went goofy. <br>The words became transparent, but got squished into the left half of the sprite, while the right half became a non-transparent black box. I'm a newcomer to B3d and have no idea why this is happening.  Any tips? <br><br></td></tr></table><br>
<a name="365022"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Nesbitt</td><td align="right"><font class=tiny>(Posted 2004)</font>&nbsp;<a href="#2">[#2]</a></td></tr></table></td></tr><tr ><td class="posttext"> Me again. Here's a sample program to illustrate the problem.  Set the constant at the top to 48, run it, and use the arrow keys to rotate, and the label looks good but has a black box around it.  Change the constant to 52, and you should see the weird behavior I described above, rather than the black box just being transparent.<br><br>---<br><br>; This value is the oddball... I need Clamp U and Clamp V flags turned on, so it should be 16+32=48.<br>; When I turn on masking (4) and use a value of 52, it halves my text and adds a black box.<br><br>Global mode = 48 ; switch this between 48 and 52<br><br>Global camera_obj<br>Global light_obj<br>Global sphere_obj<br>Global sprite_obj<br>Global sphere2_obj<br><br>Global rot<br><br>Global scrap<br><br><br><br>; initialize graphics modes<br><br>Graphics3D maxx, maxy, 16, 1<br>SetBuffer BackBuffer()<br><br><br><br>; define camera and light<br><br>camera_obj = CreateCamera()<br>PositionEntity camera_obj, 0, 0, -10<br>	<br>light = CreateLight()<br>RotateEntity light, 45, 45, 0<br><br><br>; define spheres<br><br>sphere_obj = CreateSphere()<br><br>sphere2_obj = CreateSphere()<br>PositionEntity sphere2_obj, -1, -1.5, 5<br><br><br>; draw sphere's label on screen and copy it into texture<br>; define the label as being 256 pixels across and 32 down<br><br>scrap = CreateTexture (256, 32, mode)<br><br><br>; draw the text on this label, then use copyrect to put it in the texture buffer<br><br>Cls<br>Text 128, 0, "This is a sphere", 1<br>CopyRect 0, 0, 256, 32, 0, 0, BackBuffer(), TextureBuffer(scrap)<br>		<br>		<br>; create label sprite and texture it with "scrap"<br>		<br>label_obj = CreateSprite()<br>PositionEntity label_obj, 0, -1.5, 0<br>ScaleSprite label_obj, 4, 0.5<br>EntityTexture label_obj, scrap<br><br><br>; we don't need scrap anymore - clear it out		<br><br>FreeImage scrap<br><br><br>; draw the world<br><br>While Not KeyHit(1)<br><br>	PositionEntity camera_obj, 0, 0, 0<br>	RotateEntity camera_obj, 0, rot, 0<br>	MoveEntity camera_obj, 0, 0, -10<br><br>	RenderWorld()<br>	Flip<br>	<br>	If KeyDown(203) Then<br>		rot = (rot-2) Mod 360<br>	End If<br>	If KeyDown(205) Then<br>		rot = (rot+2) Mod 360<br>	End If<br>	<br>Wend <br><br></td></tr></table><br>
<a name="365041"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >sswift</td><td align="right"><font class=tiny>(Posted 2004)</font>&nbsp;<a href="#3">[#3]</a></td></tr></table></td></tr><tr ><td class="posttext"> An image on the backbuffer has no alpha information.  When you load an image with masking, Blitz calculates the alpha from the image color.  But when you copy an image into an image with masking enabled, the alpha is not calculated.<br><br>Search the code archives for code which allows you to "set any masking color".  It will probably calculate the alpha for you.<br><br>Alternatively, you can just set your sprite to add blend.  That will make black transparent, and may make your text look cooler as it will appear to be transparent when in front of a planet or stars. <br><br></td></tr></table><br>
<a name="365087"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Ross C</td><td align="right"><font class=tiny>(Posted 2004)</font>&nbsp;<a href="#4">[#4]</a></td></tr></table></td></tr><tr ><td class="posttext"> Hey, go here :)<br><br><a href="http://www.blitzbasic.com/Community/posts.php?topic=33427" target="_blank">http://www.blitzbasic.com/Community/posts.php?topic=33427</a> <br><br></td></tr></table><br>
<a name="365225"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Nesbitt</td><td align="right"><font class=tiny>(Posted 2004)</font>&nbsp;<a href="#5">[#5]</a></td></tr></table></td></tr><tr ><td class="posttext"> Thanks for the tips, guys! What great service - I post last thing before I go to bed, and I have the explanation and a solution when I get up.  Very convenient!<br><br>Regards, <br>Pete <br><br></td></tr></table><br>
<a name="365255"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Nesbitt</td><td align="right"><font class=tiny>(Posted 2004)</font>&nbsp;<a href="#6">[#6]</a></td></tr></table></td></tr><tr ><td class="posttext"> To Ross C (or anybody else who can help):<br><br>I tried implementing your algorithms from the link above, and they work, though I have a couple of questions:<br><br>1. Is it necessary to call prepare_texture() in this case, or is it unneccessary since no alpha information exists anyway? <br><br>2. Although the label is now properly transparent (woo hoo!) it's still shrunk to half its required size... This is odd, because it's the correct size when the texture mode is 48, and it shrinks when I use mode 52 to get masking.  Any ideas what might be causing this?<br><br>Here's the new code, with your functions in place:<br><br>---<br><br>; This value is the oddball... I need Clamp U and Clamp V flags turned on, so it should be 16+32=48.<br>; When I turn on masking (4) and use a value of 52, it halves my text and adds a black box.<br><br>Global mode = 52 ; switch this between 48 and 52<br><br>Global camera_obj<br>Global light_obj<br>Global sphere_obj<br>Global sprite_obj<br>Global sphere2_obj<br><br>Global rot<br><br>Global scrap<br><br><br><br>; initialize graphics modes<br><br>Graphics3D maxx, maxy, 16, 1<br>SetBuffer BackBuffer()<br><br><br><br>; define camera and light<br><br>camera_obj = CreateCamera()<br>PositionEntity camera_obj, 0, 0, -10<br>	<br>light = CreateLight()<br>RotateEntity light, 45, 45, 0<br><br><br>; define spheres<br><br>sphere_obj = CreateSphere()<br><br>sphere2_obj = CreateSphere()<br>PositionEntity sphere2_obj, -1, -1.5, 5<br><br><br>; draw sphere's label on screen and copy it into texture<br>; define the label as being 256 pixels across and 32 down<br><br>scrap = CreateTexture (256, 32, mode)<br><br><br>; draw the text on this label, then use copyrect to put it in the texture buffer<br><br>Cls<br>Text 128, 0, "This is a sphere", 1<br>CopyRect 0, 0, 256, 32, 0, 0, BackBuffer(), TextureBuffer(scrap)<br>		<br>		<br>; create label sprite and texture it with "scrap"<br>		<br>label_obj = CreateSprite()<br>PositionEntity label_obj, 0, -1.5, 0<br>ScaleSprite label_obj, 4, 0.5<br>EntityTexture label_obj, scrap<br><br>; apply Ross C's function<br>prepare_texture(scrap)<br>texture_mask_colour(scrap, 0, 0, 0)<br><br><br>; draw the world<br><br>While Not KeyHit(1)<br><br>	PositionEntity camera_obj, 0, 0, 0<br>	RotateEntity camera_obj, 0, rot, 0<br>	MoveEntity camera_obj, 0, 0, -10<br><br>	RenderWorld()<br>	Flip<br>	<br>	If KeyDown(203) Then<br>		rot = (rot-2) Mod 360<br>	End If<br>	If KeyDown(205) Then<br>		rot = (rot+2) Mod 360<br>	End If<br>	<br>Wend<br><br>;--------------------------------------------------------------------<br>;  PREPARE_TEXTURE() created by Ross C								|<br>;  This function will clear a texture of all it's alpha information |<br>;--------------------------------------------------------------------<br>;parameters  =  texture : the texture you wish to clear alpha information from<br><br>Function prepare_texture(texture)<br><br>	LockBuffer TextureBuffer(texture)<br><br>	For loop=0 To TextureWidth(texture)<br>		For loop1=0 To TextureHeight(texture)<br><br>			RGB1=ReadPixelFast(loop,loop1,TextureBuffer(texture))<br>			r=(RGB1 And $FF0000)Shr 16;separate out the red<br>			g=(RGB1 And $FF00) Shr 8;green<br>			b=RGB1 And $FF;and blue parts of the color<br>			a=(RGB1 And $FF000000)Shr 24<br>			<br>			a=255; remove any alpha information currently in the texture.<br><br>			newrgb= (a Shl 24) Or (r Shl 16) Or (g Shl 8) Or b; combine the ARGB back into a number<br><br>			WritePixelFast(loop,loop1,newrgb,TextureBuffer(texture)); write the info back to the texture<br>		Next<br>	Next<br><br>	UnlockBuffer TextureBuffer(texture)<br><br>End Function<br><br><br>;---------------------------------------------------------------------<br>;  TEXTURE_MASK_COLOUR created by Ross C							 |<br>;  This function will mask the passed across RGB of the texture also |<br>;  passed across. Do NOT pass across a value for flag if you only    |<br>;  want to mask an exact colour.                                     |<br>;---------------------------------------------------------------------<br>;parameters = texture   : the texture you wish to clear alpha information from<br>;           = r1        : the red value to mask<br>;           = g1        : the green value to mask<br>;           = b1        : the blue value to mask<br>;           = tolerance : the tolerance value. If set to 0, then the function will only mask the<br>;                         EXACT colours passed across. Higher value will mask values close to the colour.<br><br>Function texture_mask_colour(texture,r1,g1,b1,tolerance=0)<br><br>	<br>	LockBuffer TextureBuffer(texture)<br><br>	For loop=0 To TextureWidth(texture)<br>		For loop1=0 To TextureHeight(texture)<br>			RGB1=ReadPixelFast(loop,loop1,TextureBuffer(texture)) ; read the RGB value from the texture<br>			r=(RGB1 And $FF0000)Shr 16;separate out the red<br>			g=(RGB1 And $FF00) Shr 8;green<br>			b=RGB1 And $FF;and blue parts of the color<br>			a=(RGB1 And $FF000000)Shr 24 ; extract the alpha<br><br>			If r&gt;=r1-tolerance And r=&lt;r1+tolerance And g=&gt;g1-tolerance And g=&lt;g1+tolerance And b=&gt;b1-tolerance And b=&lt;b1+tolerance Then; check RGB lies with the tolerance<br>				;temp=((Abs(r-r1)+Abs(g-g1)+Abs(b-b1))/3.0)*4.0 ; alpha the values based on the tolerance value<br>				a=0;temp<br><br>			End If<br><br>			newrgb= (a Shl 24) Or (r Shl 16) Or (g Shl 8) Or b ; combine the ARGB back into one value<br><br>			WritePixelFast(loop,loop1,newrgb,TextureBuffer(texture)); write back to the texture<br>		Next<br>	Next<br>	UnlockBuffer TextureBuffer(texture)<br>	<br>End Function <br><br></td></tr></table><br>
<a name="bottom"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td align="right"><a href="http://monkeycoder.co.nz" target="_blank"><img src="/img/monkey2.svg" ></a> <a href="https://github.com/blitz-research" target="_blank"><img src="/img/github.svg" ></a> <a href="https://discord.gg/qJccbSp" target="_blank"><img src="/img/discord.svg" ></a></td></tr></table><br></div><br><table width="100%"><tr><td></body></html lang="en">
