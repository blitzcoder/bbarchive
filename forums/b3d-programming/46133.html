<!DOCTYPE html><html lang="en" ><head ><title >Trees and leaves</title><meta name='viewport' content='width=device-width, initial-scale=0.66'><meta name='description' content='language:basic, target:desktop, category:game development'><link rel="styleSheet" href="../skins/granite/style.css" type="text/css"><style type="text/css">div.bbcode {padding: 8px;background: #E5E5E5;color: #000000;border: 1px dashed #B4B4BE;}</style></head><body ><table width=100% cellspacing=0 cellpadding=0><tr ><td class="menubarleft"></td><td class="menubar"><table cellspacing="0" cellpadding="0"><tr ><td >&nbsp;</td><td class="menuitemleft"></td><td class="menuitem"><a href="/" class="menuitem">News</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/forums.php" class="menuitem">Forums</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/codearcs.php" class="menuitem">Code</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/logs.php" class="menuitem">Logs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/gallery.php" class="menuitem">Gallery</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/sdkspecs.php" class="menuitem">Specs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/search.php" class="menuitem">Search</a></td><td class="menuitemright"></td></tr></table></td><td class="menubarright"></td></tr></table><div class="main"><h1 >Trees and leaves</h1><a href="forums.php" >Blitz3D Forums</a>/<a href="topics.php?forum=82" >Blitz3D Programming</a>/<a href="#bottom" >Trees and leaves</a><br><br>
<a name="513157"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >DH</td><td align="right"><font class=tiny>(Posted 2005)</font>&nbsp;<a href="#1">[#1]</a></td></tr></table></td></tr><tr ><td class="posttext"> Alright, I think I have it down.  Please correct me on this technique.<br><br>I have been trying to learn how to do tree/leaf effects like speedtree and blitztree3d and I think I have it.<br><br>Create a mesh, parent it to the camera.<br><br>Create all your leaf quads in it facing camera.<br><br>Go through the tree list and simply move the quads to the needed location (this way they stay facing camera).<br><br>Rotate the texture a bit for the leaves and modify the texture u,v positioning to keep the leaf texture in the center.<br><br>I have been playing with this technique and it seems pretty decent.<br><br>Speed comparrisons:<br>Using sprites: Max in scene before I see a slow down is 1000.<br>Using quads and rotating the verts to match camera: can do about 4,000 before a noticable slowdown (before the frame rate comes off strong).<br>Using the above method: about 12,000 quads before a slow down.<br><br>Now that makes a huge difference...  Each tree having roughly 40 leaf quads, rotating and such yet still facing camera.  That gives me ...<br><br>25 trees for the 1st method<br>100 trees for the 2nd method<br>and 300 trees for the method described at the beg of this post.<br><br>Not that I NEED 300 trees, but the ability to have more, means that the system can do other things than just do trees...<br><br>Anything I could be doing better????<br><br><br>I also found out that when modifying a mesh's structure, dont leave the function (or call other functions).  It impacts the performance somewhat.  It may not be noticable on a few operations per mesh, but when going through a list of 2000 verticies, it gives a hella slow down..  <br><br>For example:<br><pre class=code>Function ModifyLeafs()
	Local L.Leaf
	Local RX#,RY#,RZ#

	For l.Leaf = Each Leaf
		For x22 = 1 To 4
		X# = Rnd(-10,10)
		Y# = Rnd(-10,10)
		Z# = Rnd(-10,10)
		X# = X# + 5			
		Y# = Y# + 5	
		Z# = Z# + 5	
			;Rotate3d()
			VertexCoords(L\Surface,L\Vert[x22],X#,Y#,Z#)
		Next
	Next
End Function</pre><br><br>is 25 ms faster then doing this:<br><pre class=code>
Function ModifyLeafs()
	Local L.Leaf
	Local RX#,RY#,RZ#

	For l.Leaf = Each Leaf
		For x22 = 1 To 4
			;Rotate3d()
			VertexCoords(L\Surface,L\Vert[x22],RotX#(),RotY#(),RotZ#())
		Next
	Next
End Function
Function RotX#()
	Return Rnd(-10,10)
End Function

Function RotY#()
	Return Rnd(-10,10)
End Function

Function RotZ#()
	Return Rnd(-10,10)
End Function</pre><br><br>Just to give you an idea on my system:<br>Fresh install, default Board config, XP Pro set to performance config rather then appearance config, 2.4 GHZ P4 with Hyperthreading, 512 MB DDR, 120 GIG 7200 rpm WD Special Edition, Geforce 4200 128mb<br><br><br>But anyway, anyone with any ideas on how i can speed up my tree process?<br><br>I was considering publishing the system in the code archives if I can get something decent cooked out. <br><br></td></tr></table><br>
<a name="513160"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Hujiklo</td><td align="right"><font class=tiny>(Posted 2005)</font>&nbsp;<a href="#2">[#2]</a></td></tr></table></td></tr><tr ><td class="posttext"> How about not randomly manipulating all the leaves and only doing a set ammount such as 150 and then just have all other leaves use 1 of these pre-set calculations...or maybe generate bunches of leaves as a single mesh and have them copied rotated and placed randomly? Would that not speed up the whole caboodle? <br><br></td></tr></table><br>
<a name="513170"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >mrtricks</td><td align="right"><font class=tiny>(Posted 2005)</font>&nbsp;<a href="#3">[#3]</a></td></tr></table></td></tr><tr ><td class="posttext"> I don't get it - how is the method you describe different to using quads and moving them to face the camera? You still have to move the quads each frame.<br><br>Good tip about leaving the function though. I'll check that out for my geomod system to see if I can get it going faster... <br><br></td></tr></table><br>
<a name="513420"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >DH</td><td align="right"><font class=tiny>(Posted 2005)</font>&nbsp;<a href="#4">[#4]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> I don't get it - how is the method you describe different to using quads and moving them to face the camera? You still have to move the quads each frame. <br></div><br><br>well, doing sin, cos, or tan can get cpu heavy when it comes to doing 1,000 plus calculations.  Doing rotations on verticies require 6 sin calculations and 6 cosine calculations per vertex (proper 3d rotation),  Not to mention doing the dot product involved and such to find the plane facing the camera to rotate to.<br><br>This is basically how sprites operate (to my knowledge).  I found that doing the calculations required to mimic a sprite were just as costly (cpu-wise) as using the sprites themselves.<br><br>Whereas doing a simple distance calculation on where to move the quad to, and letting it stay facing the camera (because it was created facing the camera, and the mesh is parented to the camera), is much more efficient.<br><br>I did quite a bit of testing with each method above (including what your describing) and have found my final method to be the most efficent to gain the results I am after.<br><br><div class="quote"> Good tip about leaving the function though. I'll check that out for my geomod system to see if I can get it going faster...  <br></div><br><br>Although it is faster not to leave the function or call others in a function, the increase in speed is unmessurable unless your doing it 1,000 + times a frame.  Only updating 50 leaves I noticed no measurable slowdown, but when approaching 2,000 leaves (just the three function calls you see above doing returning the rnd() statement) and my frame rate dropped by 30%.<br><br>With this discovery, it shines me away from keeping my code as modular as possible, since I dont want to be making that many function calls for speed, yet I want to use functions like that to keep everything A. organized and B. Modular. <br><br>I doubt that someone like Alienhead will respond to this thread seen as though I am trying to create something that he sells (where in his eyes, I should just purchase it from him and save the hassle)...  Although it would be benifical to me that he would respond since he has traveled this road before. <br><br></td></tr></table><br>
<a name="513473"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >DH</td><td align="right"><font class=tiny>(Posted 2005)</font>&nbsp;<a href="#5">[#5]</a></td></tr></table></td></tr><tr ><td class="posttext"> Well, I have started to create the system and run into a few snags......<br><br>When modifying the leafes vertex coordinates, I tform the points of where the leaves should be (relative to the trees) into the leaf mesh which causes a bit of slow down. <br><br></td></tr></table><br>
<a name="513489"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >mrtricks</td><td align="right"><font class=tiny>(Posted 2005)</font>&nbsp;<a href="#6">[#6]</a></td></tr></table></td></tr><tr ><td class="posttext"> Okay, worth knowing. How about if you're using Sin and Cos lookup tables instead of calculating them? I must admit, modular code layout is something I don't want to go away from if I can help it. <br><br></td></tr></table><br>
<a name="513520"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Stevie G</td><td align="right"><font class=tiny>(Posted 2005)</font>&nbsp;<a href="#7">[#7]</a></td></tr></table></td></tr><tr ><td class="posttext"> In my experience using the tform commands to rotate the individual quads is almost twice as fast as using sin/cos etc...  You may get some speed up using Lookups for sin/cos but very little on modern hardware. <br><br></td></tr></table><br>
<a name="513562"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Ross C</td><td align="right"><font class=tiny>(Posted 2005)</font>&nbsp;<a href="#8">[#8]</a></td></tr></table></td></tr><tr ><td class="posttext"> I found look up tables were slightly slower. I agree with the tform commands being faster too. <br><br></td></tr></table><br>
<a name="513645"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >DH</td><td align="right"><font class=tiny>(Posted 2005)</font>&nbsp;<a href="#9">[#9]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> In my experience using the tform commands to rotate the individual quads is almost twice as fast as using sin/cos etc... You may get some speed up using Lookups for sin/cos but very little on modern hardware. <br> <br></div><br><br>You are correct, the slowdown over 2000 leaves (4,000 polys, 8,000 verts) is only about 4-5 ms on my machine using Tform (which I can live with).  Whereas doing a sin,cos operation (just to rotate the verts around a center point) slows the operation down 30-45 ms.<br><br>Tform is the way I am going.<br><br><br><div class="quote"> I found look up tables were slightly slower. I agree with the tform commands being faster too.  <br></div><br><br>My findings are the same, lookup tables are a bit slower because you still have to do a lot of calculating after you get the sin/cos lookup to rotate the verts and such.  Tform converts it into the mesh's local coord, and my merely move the vert to where it should be (so 1 tform, and an XYZ addition to each vertex). <br><br></td></tr></table><br>
<a name="513716"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >DH</td><td align="right"><font class=tiny>(Posted 2005)</font>&nbsp;<a href="#10">[#10]</a></td></tr></table></td></tr><tr ><td class="posttext"> <a href="http://www.blitzbasic.com/Community/posts.php?topic=46177" target="_blank">http://www.blitzbasic.com/Community/posts.php?topic=46177</a><br><br>That is the thread to the zip for the test..  It looks pretty decent for a start.  Bare in mind that the textures need work, and I need more variation in trunks/trunk textures.<br><br>I was thinking that this might be a good solution for a particle engine as well.  I am unsure how particle engines work yet (haven't really had a need to get into them just yet), but if they are anything like everyone is describing (facing quads twords the camera), then this solution might prove to be a huge speed increase. <br><br></td></tr></table><br>
<a name="513738"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >DH</td><td align="right"><font class=tiny>(Posted 2005)</font>&nbsp;<a href="#11">[#11]</a></td></tr></table></td></tr><tr ><td class="posttext"> update:<br>After some further playing with this 'camera displacement' technique of single surface manipulation, I generated the following pic:<br><img src="http://www.kcstudios.net/enginetests/treelod.jpg"><br><br>This is 6,000 trees runing as a billboards using the camera displacement technique.  (the fps are low because I am running in debug and in windowed mode which gives horrid flip times) and these radeon 7000's suck.  <br><br>Now if I take a few thousand from the far back and create a basic billboard out of that, I believe I can (using the system in my previous post to control the moving trees with leaves, this system for lod trees, and a huge billboard for anything over 1,000 units away as one big billboard) re-create speedtree's 1 million tree demo (probably at about 30-40 fps though which is a bit of a downfall).  <br><br>This is kind of exciting! <br><br></td></tr></table><br>
<a name="bottom"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td align="right"><a href="http://monkeycoder.co.nz" target="_blank"><img src="/img/monkey2.svg" ></a> <a href="https://github.com/blitz-research" target="_blank"><img src="/img/github.svg" ></a> <a href="https://discord.gg/qJccbSp" target="_blank"><img src="/img/discord.svg" ></a></td></tr></table><br></div><br><table width="100%"><tr><td></body></html lang="en">
