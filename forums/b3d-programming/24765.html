<!DOCTYPE html><html lang="en" ><head ><title >Efficient RTS "fog of war" setup.</title><meta name='viewport' content='width=device-width, initial-scale=0.66'><meta name='description' content='language:basic, target:desktop, category:game development'><link rel="styleSheet" href="../skins/granite/style.css" type="text/css"><style type="text/css">div.bbcode {padding: 8px;background: #E5E5E5;color: #000000;border: 1px dashed #B4B4BE;}</style></head><body ><table width=100% cellspacing=0 cellpadding=0><tr ><td class="menubarleft"></td><td class="menubar"><table cellspacing="0" cellpadding="0"><tr ><td >&nbsp;</td><td class="menuitemleft"></td><td class="menuitem"><a href="/" class="menuitem">News</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/forums.php" class="menuitem">Forums</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/codearcs.php" class="menuitem">Code</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/logs.php" class="menuitem">Logs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/gallery.php" class="menuitem">Gallery</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/sdkspecs.php" class="menuitem">Specs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/search.php" class="menuitem">Search</a></td><td class="menuitemright"></td></tr></table></td><td class="menubarright"></td></tr></table><div class="main"><h1 >Efficient RTS "fog of war" setup.</h1><a href="forums.php" >Blitz3D Forums</a>/<a href="topics.php?forum=82" >Blitz3D Programming</a>/<a href="#bottom" >Efficient RTS "fog of war" setup.</a><br><br>
<a name="256984"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >poopla</td><td align="right"><font class=tiny>(Posted 2003)</font>&nbsp;<a href="#1">[#1]</a></td></tr></table></td></tr><tr ><td class="posttext"> I for the life of me can't figure out how to do an efficient fog of war effect.  I would rather not kill the speed of my application by using up the fill rate with alot of transperancy. <br><br></td></tr></table><br>
<a name="256990"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Codemonger</td><td align="right"><font class=tiny>(Posted 2003)</font>&nbsp;<a href="#2">[#2]</a></td></tr></table></td></tr><tr ><td class="posttext"> Ok this might sound stupid, because I haven't really thought it through, but ...if you create camera fog and disable fog on the ground or entities using the entityfx command, so fog does not affect them for the areas that you can see... ? <br><br></td></tr></table><br>
<a name="256995"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >RifRaf</td><td align="right"><font class=tiny>(Posted 2003)</font>&nbsp;<a href="#3">[#3]</a></td></tr></table></td></tr><tr ><td class="posttext"> You could place large mesh over the map with many vertices and quades in it like a grid over your map when the guy/unit picks up you remove the face of the fog mesh where he picked.  Now the cam will only see through where your guys have been..  <br><br>To make it war craft style.. You could start the fog mesh at an alpha of like .8 you can still see through a little, to keep from seeing the enemy units they too would pick up, and if they hit the fog layer they alpha to 0, otherwise alpha to normal. <br><br></td></tr></table><br>
<a name="257014"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >RexRhino</td><td align="right"><font class=tiny>(Posted 2003)</font>&nbsp;<a href="#4">[#4]</a></td></tr></table></td></tr><tr ><td class="posttext"> Dev, I would use a very simple method:<br><br>Split the game board up into a grid, and only allow the camera into areas on the grid where your units have explored. It is fast, easy to implement, and it seems natural. <br><br></td></tr></table><br>
<a name="257106"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >octothorpe</td><td align="right"><font class=tiny>(Posted 2003)</font>&nbsp;<a href="#5">[#5]</a></td></tr></table></td></tr><tr ><td class="posttext"> Here are a couple ideas:<br><br>A second set of map tiles and building graphics which are darkened.  You could have your program automatically generate these, or automatically generate them if your source artwork has been modified.  To make it look really great you could generate gradient versions of each of these tiles to make the map "blend" between visible areas and your fog-of-war, but that might be a little memory intensive!<br><br>Alternately, draw a dithered fog-of-war on top of your map instead of a transparent one.  Should be much faster than translucency.  (e.g. transparent pixel, black pixel, transparent pixel, black pixel, etc.) <br><br></td></tr></table><br>
<a name="257210"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >poopla</td><td align="right"><font class=tiny>(Posted 2003)</font>&nbsp;<a href="#6">[#6]</a></td></tr></table></td></tr><tr ><td class="posttext"> Becuase of the fact that the camera has variable height, and rotational positions, I will most likely implement an entity fading and camera fogging combination.  Im so used to traditional isometric RTSs that I threw this method out the window first thing :).  Thanks for the suggestions. <br><br></td></tr></table><br>
<a name="257302"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >RifRaf</td><td align="right"><font class=tiny>(Posted 2003)</font>&nbsp;<a href="#7">[#7]</a></td></tr></table></td></tr><tr ><td class="posttext"> copy this code to get a crude idea of what I meant above.<br>sorry but I dont know how to color the code below green for easy viewing.<br><br><br><br>removed.. not effective for large number of units <br><br></td></tr></table><br>
<a name="257393"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >RifRaf</td><td align="right"><font class=tiny>(Posted 2003)</font>&nbsp;<a href="#8">[#8]</a></td></tr></table></td></tr><tr ><td class="posttext"> The code above is very slow with many units.. Here is a new fog of war method, using Psuedo grid, and type structure that flags everything visable or not.  Here it is.<br>NOTE:<br><br>I was able to make 500 enemies without any real noticable <br>slowdowns on my machine.. P4 2.4GHZ GeforceTI4200.<br>Could someone else with a lower spec machine test it out?<br><br>EDIT: I updated code with Banks, and it moves 2x fast.  1000 enemies moving around going in and out of fog of war.  I now have it set so that the instant they are out of a "players units" area they fade into fog of war even if the area of terrain has been explored.  All done via phsuedo map and banks.. No b3d collision or distance checking done. <br><br>Ill post more code if anyone is interested.<br><br><br>;the Psuedo Grid (500,500) is equal to real world 0,0<br>;VALUES if =0 then invisable area, =1 then visbale<br>Dim mapgrid(1000,1000)<br>;This is how large each grid square will be in real XZ world values, play with this to see how it works<br>Global gridindex=20<br><br>;tree type<br>Type tree<br>Field entity<br>Field woodleft<br>Field Visable<br>End Type<br><br><br>;all units have these properties<br>Type Unit<br>  Field Friendly<br>  Field Visable<br>  Field Entity<br>End Type<br> <br><br><br>Graphics3D 640,480<br><br>;create friendly unit<br>U.unit=New unit<br>u\friendly=True<br>u\visable=True<br>u\entity=CreateCube()<br>EntityColor u\entity,0,0,200<br>PositionEntity u\entity,Rand(-20,20),0,Rand(-20,20)<br><br>;create a few enemies<br>For i=1 To 5<br>U.unit=New unit<br>u\friendly=False<br>u\visable=False<br>u\entity=CreateCube()<br>EntityColor u\entity,200,0,0<br>PositionEntity u\entity,Rand(-35,35),0,Rand(-35,35)<br>Next<br><br><br><br>;put some ground underneath it all<br>ground=CreatePlane()<br>EntityColor ground,0,100,0<br><br><br>For I=1 To 100<br>t.tree=New tree<br>T\entity=CreateCone()<br>PositionEntity t\entity,Rand(-100,100),0,Rand(-100,100)<br>EntityAlpha t\entity,.2<br>EntityColor t\entity,0,200,0<br>ScaleEntity t\entity,4,4,4<br>Next<br><br>;our camera<br>camera=CreateCamera()<br>temp=CreatePivot()<br>PositionEntity camera,10,40,40<br>PointEntity camera,temp<br>FreeEntity temp<br>CameraFogMode camera,1<br>CameraFogColor camera,100,100,100<br>CameraFogRange camera,25,190<br><br>;main loop<br>While Not KeyDown(1)<br>For u.unit=Each unit<br>	checkgridarea(u)<br>;if unit is friendly we change grid he is in to <br>;visable, if unit is enemy we just check to see if he is<br>;inside of a visable area or invisable area, in in visable<br>;we change his alpha and visable state.<br>If u\friendly=True Then <br>	MoveEntity u\entity,0,0,.1<br>	TurnEntity u\entity,0,-.35,0<br>	Else<br>	MoveEntity u\entity,0,0,-.1<br>	TurnEntity u\entity,0,.35,0<br>	EndIf<br>Next<br>RenderWorld()<br>UpdateWorld()<br>Flip<br>Wend<br><br><br>Function CheckGridArea(cu.unit)<br>entity=cu\entity<br>Px=EntityX(entity,1)<br>Pz=EntityZ(entity,1)<br>gridX=Int((px/gridindex))+500<br>gridZ=Int((pz/gridindex))+500<br>If cu\friendly=True Then<br>If MapGrid(Gridx,Gridz)=0 Then <br> mapgrid(gridx,gridz)=1<br>;tree check not neccessary in a rts game as<br>;you cn usually see the terrain.  You could get<br>;by with only unit checks. wich are fast.<br> For t.tree=Each tree<br>  If t\visable=0 Then<br>   If EntityDistance(t\entity,entity)&lt;=GridIndex Then <br>     t\visable=1  <br>     EntityAlpha t\entity,1<br>     EndIf<br>     EndIf<br>     Next<br>     EndIf<br>Else<br>;enemy/unfriendly unit check.. does not reveal map<br>;only reveals unit if map area is already explored<br>If mapgrid(gridx,gridz)=1 Then <br> cu\visable=1<br> EntityAlpha cu\entity,1<br> Else<br> cu\visable=0<br> EntityAlpha cu\entity,.1<br> EndIf <br> EndIf<br>End Function <br><br></td></tr></table><br>
<a name="258830"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >SabataRH</td><td align="right"><font class=tiny>(Posted 2003)</font>&nbsp;<a href="#9">[#9]</a></td></tr></table></td></tr><tr ><td class="posttext"> If you are wanting fog of war for a 3d-setup then i might suggest something i pulled off awhile back..<br><br>Using camera fog (black).<br>Place entity boxes (markers) like a grid around the map.<br>As the player approaches these boxes turn their flag on.<br><br>Have the game engine determine how heavy the fog should be around the camera based off the entity box flags positioned around the area..<br><br>Of course this is just a quick explanation and the calcs behind it go much deeper.. but in theory it worked fine for me and my 3d-rts.<br><br>good luck! <br><br></td></tr></table><br>
<a name="259885"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Tranz</td><td align="right"><font class=tiny>(Posted 2003)</font>&nbsp;<a href="#10">[#10]</a></td></tr></table></td></tr><tr ><td class="posttext"> RifRaf&gt; "I'll post more code if anyone is interested"<br><br>I'm interested...I'd like to see your updated code. <br><br></td></tr></table><br>
<a name="259945"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >RifRaf</td><td align="right"><font class=tiny>(Posted 2003)</font>&nbsp;<a href="#11">[#11]</a></td></tr></table></td></tr><tr ><td class="posttext"> Forgive the lengthly code, its mostly remarks<br><br><br><br><br>;the Psuedo Grid (500,500) is equal to real world 0,0<br>;if =0 then invisable area, =1 then visable<br>Dim mapgrid(1000,1000)<br><br>;This is how large each grid square will be in real XZ world values<br>;meaning our virtual grid squares are 20x20 on x+z axi in 3d space<br>Global gridindex=20<br><br>;globals required for the BANK functions<br>;all of our checks will be at an offset of 500<br>;this is because our bank array cannot go into negative numbers<br>;using 500 offset makes 500 equal to 0,0 of real 3d space.. now 0,0 <br>;of our grid is equal to -500*gridindex,-500*gridindex of real 3d XZ space<br>Global MapBank,CleanBank<br>mapbank=makebank(1000,1000)<br>CleanBank=makebank(1000,1000)<br><br><br>;how often we will zero out the vitual grid <br>Global DetailFogtimer#=MilliSecs()+100<br><br><br>;tree type<br>Type tree<br>Field entity<br>Field woodleft<br>Field Visable<br>End Type<br><br><br>;all units have these properties<br>Type Unit<br>  Field Friendly<br>  Field Visable<br>  Field Entity<br>End Type<br> <br><br><br>Graphics3D 640,480<br>;our camera<br>camera=CreateCamera()<br>temp=CreatePivot()<br>PositionEntity camera,10,60,-40<br>PointEntity camera,temp<br>FreeEntity temp<br>CameraFogMode camera,1<br>CameraFogColor camera,100,100,100<br>CameraFogRange camera,5,110<br><br>;create friendly unit<br>U.unit=New unit<br>u\friendly=True<br>u\visable=True<br>EntityParent camera,u\entity<br>u\entity=CreateCube()<br>EntityColor u\entity,0,0,200<br>PositionEntity u\entity,Rand(-20,20),0,Rand(-20,20)<br><br>;create a few enemies<br>For i=1 To 200<br>U.unit=New unit<br>u\friendly=False<br>u\visable=False<br><br>u\entity=CreateCube()<br>EntityColor u\entity,200,0,0<br>PositionEntity u\entity,Rand(-35,35),0,Rand(-35,35)<br>Next<br><br><br><br>;put some ground underneath it all<br>ground=CreatePlane()<br>EntityColor ground,0,100,0<br><br><br>For I=1 To 100<br>t.tree=New tree<br>T\entity=CreateCone()<br>PositionEntity t\entity,Rand(-100,100),0,Rand(-100,100)<br>EntityAlpha t\entity,.3<br>EntityColor t\entity,0,200,0<br>ScaleEntity t\entity,14,14,14<br>Next<br><br>;main loop<br>While Not KeyDown(1)<br>If MilliSecs()&gt;detailfogtimer# Then <br>	detailfogtimer#=MilliSecs()+200<br>	detailfog()<br>	EndIf<br><br>moving#=0<br>turn#=0<br>If KeyDown(200) Then Moving#=.3<br>If KeyDown(203) Then turn#=-2<br>If KeyDown(205) Then turn#=2<br>For u.unit=Each unit<br> 	checkgridarea(u)<br>;if unit is friendly we change grid he is in to <br>;visable, if unit is enemy we just check to see if he is<br>;inside of a visable area or invisable area, in in visable<br>;we change his alpha and visable state.<br>If u\friendly=True Then <br>	MoveEntity u\entity,0,0,moving<br>	TurnEntity u\entity,0,turn,0<br>	Else<br>	MoveEntity u\entity,0,0,-.1<br>	TurnEntity u\entity,0,.35,0<br>	EndIf<br>Next<br>RenderWorld()<br>UpdateWorld()<br>Flip<br>Wend<br><br><br>Function CheckGridArea(cu.unit)<br>entity=cu\entity<br>Px=EntityX(entity,1)<br>Pz=EntityZ(entity,1)<br>gridX=Int((px/gridindex))+500<br>gridZ=Int((pz/gridindex))+500<br>If cu\friendly=True Then<br>If Getbank(Mapbank,Gridx,Gridz,4000)=0 Then <br> Putbank(Mapbank,gridx,gridz,4000,1)<br>;tree check not neccessary in an rts game as<br>;you cn usually see the terrain.  You could get<br>;by with only unit checks. wich are fast.<br> For t.tree=Each tree<br>  If t\visable=0 Then<br>   If EntityDistance(t\entity,entity)&lt;=GridIndex Then <br>     t\visable=1  <br>     EntityAlpha t\entity,1<br>     EndIf<br>     EndIf<br>     Next<br>     EndIf<br>Else<br>;enemy/unfriendly unit check.. does not reveal map<br>;only reveals unit if map area is already explored<br>If Getbank(mapbank,gridx,gridz,4000)=1 Then <br> cu\visable=1<br> EntityAlpha cu\entity,1<br> Else<br> cu\visable=0<br> EntityAlpha cu\entity,0<br> EndIf <br> EndIf<br>End Function<br><br><br><br><br><br>Function detailfog()<br>;this function will set the whole grid back to 0<br>;meaning unexplored.  Terrain should have a way<br>;to stay visable.. here is how I did it.  When terrain<br>;is in sight, its alpha is chaged from a low number to 1<br>;this will change it to visable regardless of the grid value<br>;units are different, they always check grid value to see<br>;if they should be visable.  So when a friendly unit is not<br>;nearby  they are not visable.  <br>CopyBank cleanbank,1,mapbank,1,4000000<br>;if you remove the call to this function. Enemy units will<br>;remain visable in areas the player has been, even if player<br>;is no longer there<br>End Function<br><br>Function MakeBank(Xlen,Ylen)<br>;makes a bank with the 2 dimensions you specify<br>Mybank=CreateBank((xlen*4)*(ylen*4))<br>Return Mybank<br>End Function<br><br>Function GetBank(Bank,Xindex,Yindex,AXlen)<br>;will return the value in the bank. Lets you use it <br>;like a 2 dimensional array though.  AXLEN is the first <br>;arrays max length.. so in b=CREATEBANK(10,20)<br>;you would call Getbank(b,x,y,10)<br>Return PeekInt(bank,((Yindex-1)*(AXlen)+((Xindex-1)*4)-1))<br>End Function<br><br>Function PutBank(Bank,Xindex,Yindex,AXlen,VALUE)<br>;same as getbank but you insert a value<br>PokeInt(bank,((Yindex-1)*(AXlen)+((Xindex-1)*4)-1),value)<br>End Function <br><br></td></tr></table><br>
<a name="259967"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Tranz</td><td align="right"><font class=tiny>(Posted 2003)</font>&nbsp;<a href="#12">[#12]</a></td></tr></table></td></tr><tr ><td class="posttext"> wow!  <br><br>That is much faster!<br><br>cool stuff! <br><br></td></tr></table><br>
<a name="259981"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >RifRaf</td><td align="right"><font class=tiny>(Posted 2003)</font>&nbsp;<a href="#13">[#13]</a></td></tr></table></td></tr><tr ><td class="posttext"> Thanks.  Are you doing an rts?  if so I have some models I made that you can have for RPG style. <br><br></td></tr></table><br>
<a name="260034"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >poopla</td><td align="right"><font class=tiny>(Posted 2003)</font>&nbsp;<a href="#14">[#14]</a></td></tr></table></td></tr><tr ><td class="posttext"> We are working on an RTS, but the art is all being done by the team artist to keep legal problems to a minimum.  Thanks for the offer though dude!! <br><br></td></tr></table><br>
<a name="261373"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Pepsi</td><td align="right"><font class=tiny>(Posted 2003)</font>&nbsp;<a href="#15">[#15]</a></td></tr></table></td></tr><tr ><td class="posttext"> Hi Dev,<br><br>I've been thinking for awhile about traditional isometric RTS's on how to do 3D fog of war like that. I dunno if you have found a final solution to what you asked for yet or not, but this is my theory I will approach in which I havn't tested via code... yet.<br><br>For a 3D RTS that only pans the camera view with no view rotation what so ever, this method would use some type of fog of war layer configuration over the terrain itself.<br><br>The Fog would actaully be setup as a single surface mesh built with enough evenly spaced small polys. This fog mesh will have a single dark color to it and also have EntityOrder to set it to display in front of the terrain. Yes, the Z-Order is out the window for it. The fog of war is usually above everything else on the terrain anyways.<br><br>Now, we need an algorithm to match your unit's position on the x/z plane to an array that points to a vertex index of the Fog mesh. So basically here, we want to know exactly the vertex index closest to the center of your unit at all times. Then we alpha the vertex to 0 and then the Fog of War Mesh opens up to let you see your unit and the terrain around it.<br><br>Ofcoarse we want more than one vertex to be alpha'd down. My suggestion here is to use some kind of circular array'd pattern to instantly make the Fog of War area around your unit disappear. This pattern can be made to fit a "view range" from the center of your unit. Ofcoarse we want to have an old copy of the pattern to fill in the old fog of war area when the unit is moving. This circular pattern can have various alpha values to make the edges of this circular view range to seem to fade into the dark fog. Also, when a unit view range area merges in with another unit there shouldn't be any problems with various alpha values between the two. Just keep the highest alpha value of the two patterns by comparison( I get that right?).<br><br>Thinking more into it, the Fog mesh would probably be more efficient if split up into 9 same sized meshes in which a section is a bit bigger then the size of the current playfield resolution. With that, you can do something similuar as a scrolling 2d tiling effect. This can help to eliminate the "bigger the map the more polys used" problem I see in using only one fog mesh for the whole map. Obviously, coding that is a bit more envolved, but should be more awarding in certain situations.<br><br>One thing that eludes me at the moment is thinking how I would approach the algorithm to get the closest vertex of the fog mesh to the center of your unit. Looking directly down on the terrain is easy to calculate, but when you have the iso view from an angle, the alogirthm needs to shift the unit's position in order to get the 'view area' of the unit to be centered with it( I guess a simple tweak of the unit position will do it). Otherwise, we'll definitly get an uncentered circular area in the fog.<br><br>---------<br><br>Just thought I'd throw this idea out at you or any one else just in case if you are still looking. It will be awhile until I get to program this up. I really like the idea of using the vertex alpha capability this way. Should be able to make some smooth looking effects( ie: mabie different colored fog, the circular area could breath in and out a bit, the circular area doesn't have to be completly circular as in it could have a puffy looking pattern look,  unit gets killed then the fog smoothly swallows up the dead unit's viewing area, rotating pattern to only show the field of view, etc...).<br><br>talk ta ye laters... <br><br></td></tr></table><br>
<a name="bottom"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td align="right"><a href="http://monkeycoder.co.nz" target="_blank"><img src="/img/monkey2.svg" ></a> <a href="https://github.com/blitz-research" target="_blank"><img src="/img/github.svg" ></a> <a href="https://discord.gg/qJccbSp" target="_blank"><img src="/img/discord.svg" ></a></td></tr></table><br></div><br><table width="100%"><tr><td></body></html lang="en">
