<!DOCTYPE html><html lang="en" ><head ><title >Can someone with winapi experience look at this code and see why it gets errors?</title><meta name='viewport' content='width=device-width, initial-scale=0.66'><meta name='description' content='language:basic, target:desktop, category:game development'><link rel="styleSheet" href="../skins/granite/style.css" type="text/css"><style type="text/css">div.bbcode {padding: 8px;background: #E5E5E5;color: #000000;border: 1px dashed #B4B4BE;}</style></head><body ><table width=100% cellspacing=0 cellpadding=0><tr ><td class="menubarleft"></td><td class="menubar"><table cellspacing="0" cellpadding="0"><tr ><td >&nbsp;</td><td class="menuitemleft"></td><td class="menuitem"><a href="/" class="menuitem">News</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/forums.php" class="menuitem">Forums</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/codearcs.php" class="menuitem">Code</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/logs.php" class="menuitem">Logs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/gallery.php" class="menuitem">Gallery</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/sdkspecs.php" class="menuitem">Specs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/search.php" class="menuitem">Search</a></td><td class="menuitemright"></td></tr></table></td><td class="menubarright"></td></tr></table><div class="main"><h1 >Can someone with winapi experience look at this code and see why it gets errors?</h1><a href="forums.php" >Blitz3D Forums</a>/<a href="topics.php?forum=82" >Blitz3D Programming</a>/<a href="#bottom" >Can someone with winapi experience look at this code and see why it gets errors?</a><br><br>
<a name="323862"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Mike Yurgalavage</td><td align="right"><font class=tiny>(Posted 2004)</font>&nbsp;<a href="#1">[#1]</a></td></tr></table></td></tr><tr ><td class="posttext"> here's some code to get the list of running process IDs, but there's a slight 'issue' in that I seem to be missing something with the process name (it says 'illegal type conversion'). I think the Process32First/Next functions are overwriting something?<br><br>You should find the process in this list IDs match those in Task Manager, at least! <br><br><br>; -----------------------------------------------------------------------------<br>; Create or open existing kernel32.decls file in userlibs folder and place<br>; these lines in it (uncommented!)...<br>; -----------------------------------------------------------------------------<br>;<br>; .lib "kernel32.dll"<br>;<br>; CreateToolhelp32Snapshot% (flags, th32processid)<br>; Process32First% (snapshot, entry*)<br>; Process32Next% (snapshot, entry*)<br>; CloseHandle% (object)<br>;<br>; -----------------------------------------------------------------------------<br><br>Const MAX_PATH = 264<br>Const TH32CS_SNAPHEAPLIST = $1<br>Const TH32CS_SNAPPROCESS = $2<br>Const TH32CS_SNAPTHREAD = $4<br>Const TH32CS_SNAPMODULE = $8<br>Const TH32CS_SNAPALL = TH32CS_SNAPHEAPLIST Or TH32CS_SNAPPROCESS Or TH32CS_SNAPTHREAD Or TH32CS_SNAPMODULE<br>Const TH32CS_INHERIT = $80000000<br>Const INVALID_HANDLE_VALUE = -1<br>Const SizeOf_PE32 = 296<br><br>Type PROCESSENTRY32<br>    Field dwSize<br>    Field cntUsage<br>    Field th32ProcessID<br>    Field th32DefaultHeapID<br>    Field th32ModuleID<br>    Field cntThreads<br>    Field th32ParentProcessID<br>    Field pcPriClassBase<br>    Field dwFlags<br>    Field szExeFile$ [MAX_PATH]<br>End Type<br><br>snap = CreateToolhelp32Snapshot (TH32CS_SNAPPROCESS, 0)<br><br>If snap<br><br>	Proc32.PROCESSENTRY32 = New PROCESSENTRY32<br>    Proc32\dwSize = SizeOf_PE32<br><br>    If Process32First (snap, Proc32)<br><br>	Print "Process ID: " + Proc32\th32ProcessID<br><br>   		While Process32Next (snap, Proc32)<br>			Print "Process ID: " + Proc32\th32ProcessID<br>			Print "----&gt; Parent process ID: " + Proc32\th32ParentProcessID<br>			Print Proc32\szExeFile ; Illegal type conversion?<br>	    Wend<br>            <br>    EndIf<br><br>    CloseHandle (snap)<br>    <br>EndIf<br><br>Print "Hit ENTER..."<br>Input ()<br>End<br><br>;-------------- end of code---------------------<br><br><br>thanks,<br>best,<br>mike <br><br></td></tr></table><br>
<a name="323871"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >soja</td><td align="right"><font class=tiny>(Posted 2004)</font>&nbsp;<a href="#2">[#2]</a></td></tr></table></td></tr><tr ><td class="posttext"> Well, it's giving you that error becuase you've declared szExeFile to be an array of strings, and Print doesn't know how to handle arrays.<br><br>What the ProcessSentry32 structure needs for szExeFile is just a character array of MAX_PATH characters -- in other words, a plain bank will do.  Unfortunately, you can't just create an instance of your PROCESSENTRY32 type and say "Proc32\szExeFile = CreateBank(MAX_PATH)", because the memory created would not be contiguous, and Windows would overwrite the bank address and probably other memory of your program... so...<br><br>The best thing to do in this case would probably be to create a bank of 296 bytes, and fill in each item manually with PokeInt and such.  Then read the exefile string with peekbyte starting at offset 33 or such.  Make sense? <br><br></td></tr></table><br>
<a name="323902"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Mike Yurgalavage</td><td align="right"><font class=tiny>(Posted 2004)</font>&nbsp;<a href="#3">[#3]</a></td></tr></table></td></tr><tr ><td class="posttext"> to soja-<br><br>thanks for the reply soja.  the explanation does make sense but i regret that i am at a loss how to do what you suggested.  where would the bank be created at and when/where would it be filled and how would i access the bank to display the array of strings?  i am simply trying to get it to list each of the running processes (like in the windows taskbar).  this has been an incredible headache. i guess i am learning from it!  i thought that perhaps there was a blitz bug or something preventing this code from working, but it just might be what you are saying.  i hope you don't mind replying to this again!  i have noticed that you have helped many others with code problems.  thanks again!<br><br>best,<br>mike <br><br></td></tr></table><br>
<a name="323932"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >soja</td><td align="right"><font class=tiny>(Posted 2004)</font>&nbsp;<a href="#4">[#4]</a></td></tr></table></td></tr><tr ><td class="posttext"> I'm glad to help.<br><br>Basically, when you pass a struct (C terminology for a custom type) to a DLL, it's just a particular chunk of memory with a certain size.  When you create an instance of the PROCESSENTRY32 type, you are creating the chuck of memory.  But instead of thinking of it as having a bunch of fields with values, just think of all the values crammed together into one memory chunk.<br><br>So, the first 9 parameters are all expected to be DWORDS or LONGS (32 bits each which is the same as a Blitz Int, so that works out just fine).  The last parameter is expected to be an array of MAX_PATH (264) TCHARs.  A TCHAR is the same as a CHAR which is just 1 byte.  So if you add up the number of bytes needed by each parameter, here's what you get:<br><br>4 + 4 + 4 + 4 + 4 + 4 + 4 + 4 + 4 + 264 = 300 bytes<br>(See the MSDN documentation for the PROCCESSENTRY32 structure.  I guess you forgot one byte becuase your SizeOf_PE32 = 296...?  Or maybe I added one too many.)<br><br>Anyway, this means that you can now create your memory chunk to store this in and get it ready to pass to the Windows API:<br><pre class=code>Proc32 = CreateBuffer(300)</pre><br>And then you procede to fill it up with the "in" parts of it (which I think is just the first parameter, right?):<br>PokeInt(Proc32, 0, BankSize(Proc32)) ; dwSize<br><br>Then make the call to Process32First/Next.<br><br>Then you can read what it gets back.  Something like:<br><pre class=code>
cntUsage = PeekInt(Proc32, 4) ; Offset at 4th byte -- read 4 bytes (sizeof Int)
th32ProcessID = PeekInt(Proc32, 8)
th32DefaultHeapID = PeekInt(Proc32, 12)
;...etc...
</pre><br>...and then when you get to the last bit, everything from byte 36 to the end of the bank will correspond to szExeFile.  You'll have to do something like this:<br><pre class=code>
offset = 36
Repeat
    char = Peekbyte(Proc32, offset)
    offset = offset + 1
    s$ = s$ + Chr$(char)
Until char = 0
</pre><br><br>Does this help you a bit?  Is anything unclear?<br><br>(Warning -- the code I typed from memory and didn't test it.) <br><br></td></tr></table><br>
<a name="324134"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Mike Yurgalavage</td><td align="right"><font class=tiny>(Posted 2004)</font>&nbsp;<a href="#5">[#5]</a></td></tr></table></td></tr><tr ><td class="posttext"> thanks soja.  i'll see if i can patch this into the code already and try it out and see if i can get it to work.  thanks again for your help.  it seems clear and easy.  i'll try not to bug you further unless i get stuck.  also, how do you guys print your code on the forum like that (green text with black background?)  i'd like to know how so that i can post the code for others to examine that way.<br><br>thanks,<br>mike <br><br></td></tr></table><br>
<a name="324244"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Mike Yurgalavage</td><td align="right"><font class=tiny>(Posted 2004)</font>&nbsp;<a href="#6">[#6]</a></td></tr></table></td></tr><tr ><td class="posttext"> Soja, I got it to work! I listed the final code below.  I wish that I could display the code segments like you do (black with green text) in this forum but i don't know how!<br><br>anywayz, here it is-<br><br>thanks,<br>mike<br><br><br>; -----------------------------------------------------------------------------<br>; Create or open existing kernel32.decls file in userlibs folder and place<br>; these lines in it (uncommented!)...<br>; -----------------------------------------------------------------------------<br>;<br>; .lib "kernel32.dll"<br>;<br>; CreateToolhelp32Snapshot% (flags, th32processid)<br>; Process32First% (snapshot, entry*)<br>; Process32Next% (snapshot, entry*)<br>; CloseHandle% (object)<br>;<br>; -----------------------------------------------------------------------------<br><br>Const MAX_PATH = 264<br>Const TH32CS_SNAPHEAPLIST = $1<br>Const TH32CS_SNAPPROCESS = $2<br>Const TH32CS_SNAPTHREAD = $4<br>Const TH32CS_SNAPMODULE = $8<br>Const TH32CS_SNAPALL = TH32CS_SNAPHEAPLIST Or TH32CS_SNAPPROCESS Or TH32CS_SNAPTHREAD Or TH32CS_SNAPMODULE<br>Const TH32CS_INHERIT = $80000000<br>Const INVALID_HANDLE_VALUE = -1<br>Const SizeOf_PE32 = 296<br><br>Type PROCESSENTRY32<br>    Field dwSize<br>    Field cntUsage<br>    Field th32ProcessID<br>    Field th32DefaultHeapID<br>    Field th32ModuleID<br>    Field cntThreads<br>    Field th32ParentProcessID<br>    Field pcPriClassBase<br>    Field dwFlags<br>    Field szExeFile$ [MAX_PATH]<br>End Type<br><br><br>snap = CreateToolhelp32Snapshot (TH32CS_SNAPPROCESS, 0)<br><br>If snap<br>	;Print snap<br>	Proc32=CreateBank(SizeOf_PE32)<br>        PokeInt(Proc32, 0, BankSize(Proc32)) ; dwSize <br><br><br>	If Process32First (snap, Proc32)<br>	;cntUsage = PeekInt(Proc32, 4) ; Offset at 4th byte -- read 4 bytes (sizeof Int) <br>	;th32ProcessID = PeekInt(Proc32, 8) <br>	;th32DefaultHeapID = PeekInt(Proc32, 12) <br>	<br>	Print "Process ID: " + th32ProcessID<br>		Print<br><br>   		While Process32Next (snap, Proc32)<br>			dwSize=PeekInt(Proc32,0)<br>			cntUsage=PeekInt(Proc32,4)<br>			th32ProcessID=PeekInt(Proc32,8)<br>			th32DefaultHeapID=PeekInt(Proc32,12)<br>			th32ModuleID=PeekInt(Proc32,16)<br>			cntThreads=PeekInt(Proc32,20)<br>			th32ParentProcessID=PeekInt(Proc32,24)<br>			pcPriClassBase=PeekInt(Proc32,28)<br>			dwFlags=PeekInt(Proc32,32)<br>			offset = 36 <br>			Repeat <br>			char = PeekByte(Proc32, offset) <br>			offset = offset + 1 <br>			szExeFile$ = szExeFile$ + Chr$(char) <br>			Until char = 0  <br>			szExeFile$=Left$(szExeFile$,Len(szExeFile$)-1)<br>			Print szExeFile$<br>			Print "Process ID: " + th32ProcessID<br>			Print "----&gt; Parent process ID: " + th32ParentProcessID<br>			szExeFile$=""<br>			<br>			Input()<br>	    Wend<br>		Input()<br>            <br>    EndIf<br><br>    CloseHandle (snap)<br>    <br>EndIf<br><br>Print "Hit ENTER..."<br>Input ()<br>End <br><br></td></tr></table><br>
<a name="324280"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Tom</td><td align="right"><font class=tiny>(Posted 2004)</font>&nbsp;<a href="#7">[#7]</a></td></tr></table></td></tr><tr ><td class="posttext"> Hi,<br><br>Nice work!<br><br>To highlight code in green, use these tags but take out the *, I put them in in case BB tries to format the message :)<br><br>[CODE*] your code here [/CODE*] <br><br></td></tr></table><br>
<a name="bottom"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td align="right"><a href="http://monkeycoder.co.nz" target="_blank"><img src="/img/monkey2.svg" ></a> <a href="https://github.com/blitz-research" target="_blank"><img src="/img/github.svg" ></a> <a href="https://discord.gg/qJccbSp" target="_blank"><img src="/img/discord.svg" ></a></td></tr></table><br></div><br><table width="100%"><tr><td></body></html lang="en">
