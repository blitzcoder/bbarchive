<!DOCTYPE html><html lang="en" ><head ><title >Ever increasing VidMem usage</title><meta name='viewport' content='width=device-width, initial-scale=0.66'><meta name='description' content='language:basic, target:desktop, category:game development'><link rel="styleSheet" href="../skins/granite/style.css" type="text/css"><style type="text/css">div.bbcode {padding: 8px;background: #E5E5E5;color: #000000;border: 1px dashed #B4B4BE;}</style></head><body ><table width=100% cellspacing=0 cellpadding=0><tr ><td class="menubarleft"></td><td class="menubar"><table cellspacing="0" cellpadding="0"><tr ><td >&nbsp;</td><td class="menuitemleft"></td><td class="menuitem"><a href="/" class="menuitem">News</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/forums.php" class="menuitem">Forums</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/codearcs.php" class="menuitem">Code</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/logs.php" class="menuitem">Logs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/gallery.php" class="menuitem">Gallery</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/sdkspecs.php" class="menuitem">Specs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/search.php" class="menuitem">Search</a></td><td class="menuitemright"></td></tr></table></td><td class="menubarright"></td></tr></table><div class="main"><h1 >Ever increasing VidMem usage</h1><a href="forums.php" >Blitz3D Forums</a>/<a href="topics.php?forum=82" >Blitz3D Programming</a>/<a href="#bottom" >Ever increasing VidMem usage</a><br><br>
<a name="563500"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >HappyCat</td><td align="right"><font class=tiny>(Posted 2005)</font>&nbsp;<a href="#1">[#1]</a></td></tr></table></td></tr><tr ><td class="posttext"> I'm working out VidMem used simply as TotalVidMem() - AvailVidMem() and despite my best effort I can't stop it from always increasing. I'm freeing textures when they're not required and deleting entities when they're done with and as far as I can tell this is all happening correctly, but still the VidMem usage keeps going up. Is this normal with Blitz or am I missing something in my code? <br><br></td></tr></table><br>
<a name="563507"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >skidracer</td><td align="right"><font class=tiny>(Posted 2005)</font>&nbsp;<a href="#2">[#2]</a></td></tr></table></td></tr><tr ><td class="posttext"> Check for missing UnlockBuffer commands. <br><br></td></tr></table><br>
<a name="563512"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >HappyCat</td><td align="right"><font class=tiny>(Posted 2005)</font>&nbsp;<a href="#3">[#3]</a></td></tr></table></td></tr><tr ><td class="posttext"> Just checked - they're all Unlocked. <br><br></td></tr></table><br>
<a name="563532"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >John Blackledge</td><td align="right"><font class=tiny>(Posted 2005)</font>&nbsp;<a href="#4">[#4]</a></td></tr></table></td></tr><tr ><td class="posttext"> Are you playing mpg or avi? There is a definite memory leak each time they loop - found by me, confirmed by a few people, unreplied to by Blitz Support. <br><br></td></tr></table><br>
<a name="563535"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Neochrome</td><td align="right"><font class=tiny>(Posted 2005)</font>&nbsp;<a href="#5">[#5]</a></td></tr></table></td></tr><tr ><td class="posttext"> Memory leak in movies??? Oh not good! i was going to use them!<br>Thanks for the heads up!<br><br>freetextures arn't enough, besure your freeing entities your not using too!<br><br>simply making the "pointer" setting that to 0 wont work. <br><br></td></tr></table><br>
<a name="563537"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >HappyCat</td><td align="right"><font class=tiny>(Posted 2005)</font>&nbsp;<a href="#6">[#6]</a></td></tr></table></td></tr><tr ><td class="posttext"> Nope, no movie files. And I'm freeing entities too.<br><br>As it looks like this isn't normal then I presume I've just missed one somewhere. I'll have another look. <br><br></td></tr></table><br>
<a name="563561"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Uncle</td><td align="right"><font class=tiny>(Posted 2005)</font>&nbsp;<a href="#7">[#7]</a></td></tr></table></td></tr><tr ><td class="posttext"> Its a long shot, but I had a similar problem.  I went through my code line by line, and still had the same problem.  Then I updated my graphics card driver and since then no problems.  Might be worth a shot?<br><br>Cheers,<br><br><br>Unc <br><br></td></tr></table><br>
<a name="563574"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >HappyCat</td><td align="right"><font class=tiny>(Posted 2005)</font>&nbsp;<a href="#8">[#8]</a></td></tr></table></td></tr><tr ><td class="posttext"> It's happening on both my PCs and they both have different gfx cards (one is a Geforce 4, the other an Intel thingumywotsit). <br><br></td></tr></table><br>
<a name="563586"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >John Blackledge</td><td align="right"><font class=tiny>(Posted 2005)</font>&nbsp;<a href="#9">[#9]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> Memory leak in movies??? Oh not good! i was going to use them! <br></div><br>It all depends.<br>If it's a one-shot movie intro, that's probably ok, but if it loops then each time it will chew the memory equivalent roughly to the file size.<br>There appears to be no way to Free(the memory of) a movie.<br><br>It is quite a bind for me - I wanted movies on quads to simulate fire, water etc, not to mention TV. Now I've simply had to give up the idea, because even though it might take a few hours, eventually the user's machine/app will lock. <br><br></td></tr></table><br>
<a name="563930"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >HappyCat</td><td align="right"><font class=tiny>(Posted 2005)</font>&nbsp;<a href="#10">[#10]</a></td></tr></table></td></tr><tr ><td class="posttext"> Okay, I <i>think</i> I've tracked it down. I'm using Syntax Error's Sprite Control code for pixel-perfect quad sprites. Sprites are loaded with the following Sprite Control function:<br><pre class=code>Function LoadImage3D(Filename$, Masked = True, texflags=4, Parent=-1, RetainAlpha=False)
	; Create quad mesh
	If Parent = -1 Parent = SpritePivot
	Local sprite=CreateMesh(Parent)
	Local s=CreateSurface(sprite)
	AddVertex s,0,0,0 ,0,0 : AddVertex s,2,0,0 , 1,0
	AddVertex s,0,-2,0 ,0,1 : AddVertex s,2,-2,0 , 1,1
	AddTriangle s,0,1,2 : AddTriangle s,3,2,1

	; transfer image into texture buffer (with alpha)
	Local tmpimage=LoadImage(Filename$)
	Local spritetexture=LoadTexture(Filename$,texflags)
	Local iw=ImageWidth(tmpimage) , ih=ImageHeight(tmpimage)
	Local tw=TextureWidth(spritetexture) , th=TextureHeight(spritetexture)

	If Not RetainAlpha Then
		
		If iw&lt;&gt;tw Or ih&lt;&gt;th
			ib=ImageBuffer(tmpimage)
			LockBuffer(ib)
			tb=TextureBuffer(spritetexture)
			LockBuffer(tb)
			For x=0 To iw-1
				For y=0 To ih-1
					rgbc=ReadPixelFast(x,y,ib) And $00ffffff
					If rgbc=((r Shl 16)+(g Shl 8)+b) And Masked  ; ALB - added And Masked 
						WritePixelFast x,y,($00000000),tb
					Else
						WritePixelFast x,y,(rgbc Or $ff000000),tb
					EndIf
				Next
			Next
			UnlockBuffer(ib)
			UnlockBuffer(tb)
		EndIf
	
	End If

	FreeImage tmpimage

	; Texture and resize sprite. Move handle to top/left
	ScaleTexture spritetexture,Float(tw)/Float(iw),Float(th)/Float(ih)
	EntityTexture sprite,spritetexture
	FreeTexture spritetexture

	EntityFX sprite,1+16
	EntityOrder sprite,-100
	ScaleEntity sprite,Float(iw)/2,Float(ih)/2,1
	PositionEntity sprite,-10000,-10000,0

	Return sprite

End Function
</pre><br><br>and free'd with <br><pre class=code>Function FreeImage3D(Sprite)
	Local brush = GetEntityBrush(Sprite)
	Local tex = GetBrushTexture(brush)
	If brush &lt;&gt; 0 FreeBrush brush
	If tex &lt;&gt; 0 FreeTexture tex
	If Sprite &lt;&gt; 0 FreeEntity Sprite
End Function</pre><br>But FreeImage3D doesn't seem to actually release the Vid Mem, it just keeps going up. These Sprite Control functions are wrapped in my own code, but they don't really add much - eg. my delete sprite function is just:<br><br><pre class=code>Function DeleteSprite(Sprite.Sprite)

	If Sprite &lt;&gt; Null Then
		FreeImage3D(Sprite\SpriteControlID)
		Delete Sprite
	End If
	
End Function</pre><br><br>Any ideas why FreeImage3D wouldn't be freeing up Vid Memory? <br><br></td></tr></table><br>
<a name="564054"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >John Blackledge</td><td align="right"><font class=tiny>(Posted 2005)</font>&nbsp;<a href="#11">[#11]</a></td></tr></table></td></tr><tr ><td class="posttext"> It's a long shot but try freeing the texture before the brush. <br><br></td></tr></table><br>
<a name="564333"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >HappyCat</td><td align="right"><font class=tiny>(Posted 2005)</font>&nbsp;<a href="#12">[#12]</a></td></tr></table></td></tr><tr ><td class="posttext"> Nah, didn't help. Is Blitz perhaps optimising things by just releasing textures but not actually freeing vid mem until it has to? <br><br></td></tr></table><br>
<a name="564347"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Shambler</td><td align="right"><font class=tiny>(Posted 2005)</font>&nbsp;<a href="#13">[#13]</a></td></tr></table></td></tr><tr ><td class="posttext"> According to the docs 'GetEntityBrush' and 'GetEntityTexture' actually create a new brush and a new texture so it would appear you aren't actually deleting the brush/texture applied to the sprite, only copies of them.<br><br>Is that what the docs mean?<br><br>If so you would have to store a handle to the actual texture+brush then delete them if no other sprites are using them.<br><br>If not then I'm just being very confused O.o <br><br></td></tr></table><br>
<a name="564349"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >HappyCat</td><td align="right"><font class=tiny>(Posted 2005)</font>&nbsp;<a href="#14">[#14]</a></td></tr></table></td></tr><tr ><td class="posttext"> It appears that that might be the case. In which case, how do I actually delete the entity's texture?<br><br>What I'm finding confusing is that freeing the textures used by Planes and Terrains (which I use for backgrounds) works fine and frees up the vid mem they were using, but doing it for these quads doesn't seem to work. <br><br></td></tr></table><br>
<a name="564419"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >BlitzSupport</td><td align="right"><font class=tiny>(Posted 2005)</font>&nbsp;<a href="#15">[#15]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> <br>There is a definite memory leak each time they loop - found by me, confirmed by a few people, unreplied to by Blitz Support<br> <br></div><br>When was that? <br><br></td></tr></table><br>
<a name="564435"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Sledge</td><td align="right"><font class=tiny>(Posted 2005)</font>&nbsp;<a href="#16">[#16]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> <br>When was that? <br> <br></div><br><a href="http://www.blitzbasic.com/Community/posts.php?topic=46958&amp;hl=leak" target="_blank">http://www.blitzbasic.com/Community/posts.php?topic=46958&amp;hl=leak</a><br><br>I gotta tell you, the number one thing putting me off BlitzMax is the way you keep "disappearing" continuing problems (FMOD anyone?) into the "Bug Bin", as if they were resolved. Doesn't exactly inspire confidence. <br><br></td></tr></table><br>
<a name="564491"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >John Blackledge</td><td align="right"><font class=tiny>(Posted 2005)</font>&nbsp;<a href="#17">[#17]</a></td></tr></table></td></tr><tr ><td class="posttext"> Thanks, Sledge. I didn't want to say that, coz I love Blitz3D, Mark Sibly, and Blitz Support with a passion.<br><br>But this vid loop memory leak does make the use of video pretty well unusable, especially if you expect to leave it running in front of a customer (as in TV display, billboard display). <br><br></td></tr></table><br>
<a name="564495"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >big10p</td><td align="right"><font class=tiny>(Posted 2005)</font>&nbsp;<a href="#18">[#18]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> I didn't want to say that, coz I love Blitz3D, Mark Sibly, and Blitz Support with a passion. <br></div><br>You're their customer, not the other way around. If something doesn't work properly, you're allowed to complain...<br><br><br><br><br><br><br>...and they'll duly ignore you completely. :) <br><br></td></tr></table><br>
<a name="564696"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Hotcakes</td><td align="right"><font class=tiny>(Posted 2005)</font>&nbsp;<a href="#19">[#19]</a></td></tr></table></td></tr><tr ><td class="posttext"> Hopefully that one was missed by BRL by accident.  I remember when the bug bin was created a LOT of random stuff went in there straight away, so this one may have slipped in there without them knowing. <br><br></td></tr></table><br>
<a name="bottom"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td align="right"><a href="http://monkeycoder.co.nz" target="_blank"><img src="/img/monkey2.svg" ></a> <a href="https://github.com/blitz-research" target="_blank"><img src="/img/github.svg" ></a> <a href="https://discord.gg/qJccbSp" target="_blank"><img src="/img/discord.svg" ></a></td></tr></table><br></div><br><table width="100%"><tr><td></body></html lang="en">
