<!DOCTYPE html><html lang="en" ><head ><title >How to improve DirectX lights dramatically</title><meta name='viewport' content='width=device-width, initial-scale=0.66'><meta name='description' content='language:basic, target:desktop, category:game development'><link rel="styleSheet" href="../skins/granite/style.css" type="text/css"><style type="text/css">div.bbcode {padding: 8px;background: #E5E5E5;color: #000000;border: 1px dashed #B4B4BE;}</style></head><body ><table width=100% cellspacing=0 cellpadding=0><tr ><td class="menubarleft"></td><td class="menubar"><table cellspacing="0" cellpadding="0"><tr ><td >&nbsp;</td><td class="menuitemleft"></td><td class="menuitem"><a href="/" class="menuitem">News</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/forums.php" class="menuitem">Forums</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/codearcs.php" class="menuitem">Code</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/logs.php" class="menuitem">Logs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/gallery.php" class="menuitem">Gallery</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/sdkspecs.php" class="menuitem">Specs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/search.php" class="menuitem">Search</a></td><td class="menuitemright"></td></tr></table></td><td class="menubarright"></td></tr></table><div class="main"><h1 >How to improve DirectX lights dramatically</h1><a href="forums.php" >Blitz3D Forums</a>/<a href="topics.php?forum=82" >Blitz3D Programming</a>/<a href="#bottom" >How to improve DirectX lights dramatically</a><br><br>
<a name="351337"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >JoshK</td><td align="right"><font class=tiny>(Posted 2004)</font>&nbsp;<a href="#1">[#1]</a></td></tr></table></td></tr><tr ><td class="posttext"> The major problems with DX (or GL) lights are as follows:<br><br>1)  There can only be 8.<br><br>2)  They have an unlimited range, more or less.<br><br>The solution to both, which I have implemented in OpenGL, is as follows:  For each object, calculate the closest 8 light entities to it, and enable the 8 or less DX lights you need for that object.  Give the DX lights infinite range, and just darken them according to distance from the current object, so as to give the lights a definite inverse square or linear falloff.  It's easy to do, and improves the quality of the dynamic lighting dramatically.  The same can be done with vertex lights, but DX light handling is so much more optimized.  As of now, DX lights are pretty much useless for dynamic lighting of characters and items, which is what they are usually used for. <br><br></td></tr></table><br>
<a name="351350"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rob Farley</td><td align="right"><font class=tiny>(Posted 2004)</font>&nbsp;<a href="#2">[#2]</a></td></tr></table></td></tr><tr ><td class="posttext"> Josh,<br><br>I showed a demo of exactly this about 6 months back now. Although it only used the 2 lights closest to the player rather than 8. <br><br></td></tr></table><br>
<a name="351372"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >smilertoo</td><td align="right"><font class=tiny>(Posted 2004)</font>&nbsp;<a href="#3">[#3]</a></td></tr></table></td></tr><tr ><td class="posttext"> The 8 light limit doesnt quite hold up, after 5 geforce cards take a big performance hit. <br><br></td></tr></table><br>
<a name="351379"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >JoshK</td><td align="right"><font class=tiny>(Posted 2004)</font>&nbsp;<a href="#4">[#4]</a></td></tr></table></td></tr><tr ><td class="posttext"> Rob, unfortunately this can only be implemented by Mark, since it involves changes during the rendering process.  I'm sure you know that, but I am just stating it for anyone reading. <br><br></td></tr></table><br>
<a name="351392"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >RetroBooster</td><td align="right"><font class=tiny>(Posted 2004)</font>&nbsp;<a href="#5">[#5]</a></td></tr></table></td></tr><tr ><td class="posttext"> I've been using exactly the same setup in OpenGL ever since I started using it, in blitz reducing the scene lights to the 8 most vital ones (or less) works quite well too however. <br><br></td></tr></table><br>
<a name="351407"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >AntonyWells</td><td align="right"><font class=tiny>(Posted 2004)</font>&nbsp;<a href="#6">[#6]</a></td></tr></table></td></tr><tr ><td class="posttext"> Per pixel lighting is the best method for lighting.<br><br>What you do is go through each poly in the scene, map it as you would if it were a lightmapper, only for each texel you've got mapped into u,v space, get the normalized vector from it's world space position into the centre of the surface.<br>flip this vector, and paint it as a dot3 compatible normal into the lightmap.<br><br>Now, when you move your light you get some absolutely awesome glowing per-pixel lights. <br><br></td></tr></table><br>
<a name="351427"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Shambler</td><td align="right"><font class=tiny>(Posted 2004)</font>&nbsp;<a href="#7">[#7]</a></td></tr></table></td></tr><tr ><td class="posttext"> DX lights do have a 'range' parameter. It acts like a cutoff point and beyond this the light has no effect at all, i.e no lighting calculations are carried out by the gpu. Unfortunately Blitz does not expose this parameter to us so we have 'infinite' lights. <br><br></td></tr></table><br>
<a name="351444"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >JoshK</td><td align="right"><font class=tiny>(Posted 2004)</font>&nbsp;<a href="#8">[#8]</a></td></tr></table></td></tr><tr ><td class="posttext"> Blitz has a LightRange() command.<br><br>If DX is like OpenGL the light range actually has no point at which lighting is zero, and the falloff seems to be even less than linear.<br><br>This is an extremely simple solution that could be introduced in a few lines of code. <br><br></td></tr></table><br>
<a name="351467"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rob</td><td align="right"><font class=tiny>(Posted 2004)</font>&nbsp;<a href="#9">[#9]</a></td></tr></table></td></tr><tr ><td class="posttext"> I think vert lighting is pretty cool too. You can set this up yourself. <br><br></td></tr></table><br>
<a name="351470"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >JoshK</td><td align="right"><font class=tiny>(Posted 2004)</font>&nbsp;<a href="#10">[#10]</a></td></tr></table></td></tr><tr ><td class="posttext"> But it isn't hardware optimized, so it is much slower. <br><br></td></tr></table><br>
<a name="351508"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Shambler</td><td align="right"><font class=tiny>(Posted 2004)</font>&nbsp;<a href="#11">[#11]</a></td></tr></table></td></tr><tr ><td class="posttext"> The Blitz LightRange() command just modifies the attenuation parameters. The range parameter of a DirectX light is something else. It looks like Blitz by default sets the range parameter to the C++ #defined 'FLT_MAX' i.e. the maximum value that a float can hold. Thats why the lighting is calculated pretty much to infinity. The range parameter of a DirectX light overrules any attenuation curve falloff and all vertices beyond the range receive no lighting calculations at all.If you set the range to a value where the lighting is still visible you get a sharp cutoff of lighting i.e. a black edge around the light.<br><br>Here's the DX9 struct for a hardware light. <br><br>It has more parameters than the DX7 version but you can see the separate attenuation and range parameters.<br><br>typedef struct _D3DLIGHT9 {<br>    D3DLIGHTTYPE Type;<br>    D3DCOLORVALUE Diffuse;<br>    D3DCOLORVALUE Specular;<br>    D3DCOLORVALUE Ambient;<br>    D3DVECTOR Position;<br>    D3DVECTOR Direction;<br>    float Range;<br>    float Falloff;<br>    float Attenuation0;<br>    float Attenuation1;<br>    float Attenuation2;<br>    float Theta;<br>    float Phi;<br>} D3DLIGHT9;<br><br>Members<br><br>Type<br>Type of the light source. This value is one of the members of the D3DLIGHTTYPE enumerated type. <br>Diffuse<br>Diffuse color emitted by the light. This member is a D3DCOLORVALUE structure. <br>Specular<br>Specular color emitted by the light. This member is a D3DCOLORVALUE structure. <br>Ambient<br>Ambient color emitted by the light. This member is a D3DCOLORVALUE structure. <br>Position<br>Position of the light in world space, specified by a D3DVECTOR structure. This member has no meaning for directional lights and is ignored in that case. <br>Direction<br>Direction that the light is pointing in world space, specified by a D3DVECTOR structure. This member has meaning only for directional and spotlights. This vector need not be normalized, but it should have a nonzero length. <br>Range<br>Distance beyond which the light has no effect. The maximum allowable value for this member is the square root of FLT_MAX. This member does not affect directional lights. <br>Falloff<br>Decrease in illumination between a spotlight's inner cone (the angle specified by Theta) and the outer edge of the outer cone (the angle specified by Phi). <br>The effect of falloff on the lighting is subtle. Furthermore, a small performance penalty is incurred by shaping the falloff curve. For these reasons, most developers set this value to 1.0.<br><br>Attenuation0<br>Value specifying how the light intensity changes over distance. Attenuation values are ignored for directional lights. This member represents an attenuation constant. For information about attenuation, see Light Position, Range, and Attenuation. Valid values for this member range from 0.0 to infinity. For non-directional lights, all three attenuation values should not be set to 0.0 at the same time. <br>Attenuation1<br>Value specifying how the light intensity changes over distance. Attenuation values are ignored for directional lights. This member represents an attenuation constant. For information about attenuation, see Light Position, Range, and Attenuation. Valid values for this member range from 0.0 to infinity. For non-directional lights, all three attenuation values should not be set to 0.0 at the same time.<br>Attenuation2<br>Value specifying how the light intensity changes over distance. Attenuation values are ignored for directional lights. This member represents an attenuation constant. For information about attenuation, see Light Position, Range, and Attenuation. Valid values for this member range from 0.0 to infinity. For non-directional lights, all three attenuation values should not be set to 0.0 at the same time.<br>Theta<br>Angle, in radians, of a spotlight's inner conethat is, the fully illuminated spotlight cone. This value must be in the range from 0 through the value specified by Phi.<br>Phi<br>Angle, in radians, defining the outer edge of the spotlight's outer cone. Points outside this cone are not lit by the spotlight. This value must be between 0 and pi. <br><br>[Edit] OpenGL does not appear to have the equivalent. <br><br></td></tr></table><br>
<a name="351606"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >sswift</td><td align="right"><font class=tiny>(Posted 2004)</font>&nbsp;<a href="#12">[#12]</a></td></tr></table></td></tr><tr ><td class="posttext"> I actually read about this technique a week or so ago, but I thought Blitz must already have it implemented and I just didn't notice in my tests because I tested on a single floor grid once a long time ago.  <br><br>Are you SURE it's not the case in Blitz, Halo?  <br><br>I don't see what you mean about it making everything look better, because even if the 8 closest lights to an obejct were used, that would still not help much with lighting a level, where one room is bound to be only a few objects.  In fact, it might be worse than whattever method Blitz is using if it is not already doing this.  Imagine if a user made one big level mesh, and Blitz picked the 8 closest lights to the center of the level instead of the 8 closest to the camera...  If a user stuck a lot of lights in the level they might not see lights anywhere until they got near the middle of the level.<br><br>I know this is not the optimal way to light a level, or build a level, but Mark can't assume all his users will do stuff in the more efficient manner. <br><br></td></tr></table><br>
<a name="351653"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Paolo</td><td align="right"><font class=tiny>(Posted 2004)</font>&nbsp;<a href="#13">[#13]</a></td></tr></table></td></tr><tr ><td class="posttext"> Talking about DX lights...<br><br>Why a lightmapped level can not be affected by a DX light?<br>I have my levels with lighmaps but when I need a dynamic lighting effect I have to disable it.<br>Actually it could look amazing if I could combine both techniques...<br><br>Any suggestion...<br><br>Paolo. <br><br></td></tr></table><br>
<a name="351659"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >MadJack</td><td align="right"><font class=tiny>(Posted 2004)</font>&nbsp;<a href="#14">[#14]</a></td></tr></table></td></tr><tr ><td class="posttext"> Because your level mesh/es are probably set to Entityfx 1 - fullbright. <br><br></td></tr></table><br>
<a name="351685"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Mustang</td><td align="right"><font class=tiny>(Posted 2004)</font>&nbsp;<a href="#15">[#15]</a></td></tr></table></td></tr><tr ><td class="posttext"> Paolo, lightmaps are precalculated lighting and adding real lights on top of it will screw the effect. So with lightmaps you can't light the geometry without it looking funny (unless you can burn away lightmaps etc but that's not what we are talking about here). <br><br></td></tr></table><br>
<a name="351709"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Ruz</td><td align="right"><font class=tiny>(Posted 2004)</font>&nbsp;<a href="#16">[#16]</a></td></tr></table></td></tr><tr ><td class="posttext"> I have my level mesh textures set to multiplyX2 and the dx lighting makes the lighting then looks really good. I Am using 3 dx lights and there is no slowdown.<br>combined with That i am manually altering vertex colours in max. <br><br></td></tr></table><br>
<a name="351714"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rob Farley</td><td align="right"><font class=tiny>(Posted 2004)</font>&nbsp;<a href="#17">[#17]</a></td></tr></table></td></tr><tr ><td class="posttext"> Maybe I didn't explain myself well...<br><br>What my demo did was take the 2 lights closest to the player (from a light mapped level) plonk a DX light at those 2 positions, colour the DX lights so they were the same colour and darken them based on their distance from the player.<br><br>It worked really well...<br><br>Drawbacks:<br>Everything was based around the player rather than anything else in the game.<br>I wasn't checking if lights were behind walls so you would sometimes be lit from lights on the other side of walls.<br><br>Other than that it looks cool. <br><br></td></tr></table><br>
<a name="351755"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rob</td><td align="right"><font class=tiny>(Posted 2004)</font>&nbsp;<a href="#18">[#18]</a></td></tr></table></td></tr><tr ><td class="posttext"> Spotlights are the preferred method I think. They have a basic directional setup with falloff. <br><br></td></tr></table><br>
<a name="351800"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >sswift</td><td align="right"><font class=tiny>(Posted 2004)</font>&nbsp;<a href="#19">[#19]</a></td></tr></table></td></tr><tr ><td class="posttext"> "Paolo, lightmaps are precalculated lighting and adding real lights on top of it will screw the effect. So with lightmaps you can't light the geometry without it looking funny (unless you can burn away lightmaps etc but that's not what we are talking about here)."<br><br>If your lightmap is a seperate mesh or surface from your textures then you can light those instead of the textures to burn them away...<br><br>And...  MAYBE with a single surface with textures and lightmaps you CAN also achieve lightmaps + lights.<br><br>Here's what I'm thinking.<br><br>First you have the lit model.  Normally, you set this model to fullbright, so this first color pass is always white.  Then in the second texture channel you have the textures set to multiply, and then the lightmap, also set to multiply.  This gives the result:  <br><br>(((Polygon color) * texture color) * lightmap color)<br><br>But what if instead you set it up so that the first texture layer was the lightmap, set that to add, and made the object  affected by light?  <br><br>Then you would have:<br>(((polygon color) + lightmap color) * texture color)<br><br>Now, because the object is affected by light it's color would be black unless a light source is in the area.  The result is that the lightmap would be added to a black object, unless a light source is in the area in which case it would be added to a lighter color, thus lightening parts of the lightmap which are less than fullbright.  And then when you multiply the texture with it, set to multiply x2 if you so desire, you'll get a world which is both lit by DX lights and by lightmaps, all in a single pass. <br><br></td></tr></table><br>
<a name="351852"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >JoshK</td><td align="right"><font class=tiny>(Posted 2004)</font>&nbsp;<a href="#20">[#20]</a></td></tr></table></td></tr><tr ><td class="posttext"> This would be useful for lighting entities, which is what vertex lights are for, in my opinion. It wouldn't help much with vertex-lighting a map or large mesh, but that's what lightmaps are for.<br><br>I wonder if it's possible to find and modify the DX structure, although it would be a million times easier for Mark to do. <br><br>Additionally, an entityvisible() command should be used internally to check if the entity is lit by the light. <br><br></td></tr></table><br>
<a name="bottom"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td align="right"><a href="http://monkeycoder.co.nz" target="_blank"><img src="/img/monkey2.svg" ></a> <a href="https://github.com/blitz-research" target="_blank"><img src="/img/github.svg" ></a> <a href="https://discord.gg/qJccbSp" target="_blank"><img src="/img/discord.svg" ></a></td></tr></table><br></div><br><table width="100%"><tr><td></body></html lang="en">
