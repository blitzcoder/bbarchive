<!DOCTYPE html><html lang="en" ><head ><title >A new shadow system</title><meta name='viewport' content='width=device-width, initial-scale=0.66'><meta name='description' content='language:basic, target:desktop, category:game development'><link rel="styleSheet" href="../skins/granite/style.css" type="text/css"><style type="text/css">div.bbcode {padding: 8px;background: #E5E5E5;color: #000000;border: 1px dashed #B4B4BE;}</style></head><body ><table width=100% cellspacing=0 cellpadding=0><tr ><td class="menubarleft"></td><td class="menubar"><table cellspacing="0" cellpadding="0"><tr ><td >&nbsp;</td><td class="menuitemleft"></td><td class="menuitem"><a href="/" class="menuitem">News</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/forums.php" class="menuitem">Forums</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/codearcs.php" class="menuitem">Code</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/logs.php" class="menuitem">Logs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/gallery.php" class="menuitem">Gallery</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/sdkspecs.php" class="menuitem">Specs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/search.php" class="menuitem">Search</a></td><td class="menuitemright"></td></tr></table></td><td class="menubarright"></td></tr></table><div class="main"><h1 >A new shadow system</h1><a href="forums.php" >Blitz3D Forums</a>/<a href="topics.php?forum=82" >Blitz3D Programming</a>/<a href="#bottom" >A new shadow system</a><br><br>
<a name="437795"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Braincell</td><td align="right"><font class=tiny>(Posted 2004)</font>&nbsp;<a href="#1">[#1]</a></td></tr></table></td></tr><tr ><td class="posttext"> I've been thinking about making a completely new shadow system for Blitz which will be the fastest and most usable at the same time ever. I had a few ideas but after being force to modify the code several times I discovered limitations. Now I'd like to discuss some of my ideas which I think are valid, and if anyone points me in a good direction I will do all the work to finish the system so that the whole community can benefit.<br><br>We all know about sswifts shadow system (which has nothing wrong about it), but I want to try and make a faster one, and for some more importantly, a free one.<br><br>Here is the main idea that I was/am working on (please read the whole thing):<br><br>*Edit: This is just the first idea, which I conclude here isn't so efficient. The second idea listed below is more probable to be a success.<br><br>Each mesh reciever is firstly processed to make a higher poly "map" of it. So a 100*100 plane is divided into say 1*1 squares, each with 2 polygons. The size of each square can be set depending on your needs. Each poly is processed then, and the coordinates of each of the virtual vertices are saved in a file. This is applied to all triangles on any mesh that can be any shape or size, as long as they dont use bones or other similar deformations. Now why do we make this? Once we have this file on disk for each mesh, and each mesh entity has a name so that they can be related, we do the following. There is a light in the scene, can be more. We first make a bounding box around the caster. Then we project 6 lines into infinity each starting at the light and going down onto each corner of the bounding box. This makes a 6-sided pyramid. We go through each mesh that is close enough to the camera and see if each of its polygons is inside the 6sided pyramid. So far only maths are used, no other major blitz-specific function. Once we see that at least the part of the tri (polygon) is inside the pyramid, that means that part of it is shaded. Then, we access the saved high-res mesh version of the mesh which is recieving the shadow. We find the big tri in it, and where each of the small triangles is located on it. Then, we go through each of the triangles vertices XYZ and do a LinePick cast from the vertice towards the light. If it hits the caster first, that means that in this small area (which is predefined in the saved file) there is a shadow, and a small transparent black tri is formed (using a certain 3 vertices stored in that file) to darken the main mesh right there. Then it goes onto the next small tri on and on through the current big tri (on the mesh) and looks if they are in shade. Once done, it moves onto the next tri on the mesh, and so on. It also checks if the triangle on the mesh is inside the camera view, the "4 sided pyramid". So this is what the DrawShadows() function would look like:<br><br><br><pre class=code>
	wipe the previous shadows
	
	1-for every caster in the level (including receivers which cast)
		2-for each light that influences the caster
			3-for each mesh whoose shadows need to be calculated (in camera range)
				4-for each poly that needs to be shaded (is inside light and camera pyramid)
					5-shade those polys from the high-res map file
				next
			next
		next
	next

</pre><br><br>Now theres a lot of smaller finetuning I've done. The function that makes the small triangles on big triangles makes it so that you cannot see the differences around the edges of each triangle on the mesh since the edges are closed together. This is all maths, some of which I have already done.<br><br>But you see the problem don't you? In my tests on an average P4, 256 MB RAM, with GForce 4 440MX, I could get no considerable slowdown until the drawn shadow triangles reached more than 2500 and LinePick reached more than 7000. On my better P4 at home, that number was 4000 and 10000, but the ratio there can change. This means that the shadow polycount can be max 2500 and that a max of 7000 small tris can be checked before there was slowdown. I should have expected this. But. As for the small-tri count, that can be reduced by smarter checking of the big triangle. That is what I'm working on now, and this could possibly decrease the number of LinePicks needed as well. But honestly I don't see a great solution coming with this kind of system. However, with this kind of thing we could make the shadows have a gradient by assigning a uvw coordinate to a newly made vertex. <br><br>I could probably decrease the polycount of the shadows by making more inteligent code, but i'm looking towards finding better ideas replacing linepick. I dont believe collisions would be faster.<br><br>There are a few other ideas, and together with the stuff already written I'd like to hear your thoughts about them. Some of you surely have more experience than a n00b like me! So here is one i think great idea i just had: <br>Each STATIC mesh has its VertexXYZ accessible using the Blitz commands. Sadly, not so for boned ones. I could make a mathematical function to check angles between certain vertexes and the light, so that the ones that are furthest out create the outline of the mesh. But the mesh can be hollow. Then, that outline could be projected using a part of the system previously mentioned down onto the recievers. We would have a much smaller polygon count, and LinePick would be eliminated, but there will be one problem. We would previously have to make an extra file containing information about which vertice (connected to each poly on the mesh) forms an edge with which other vertice(s). Only then could this be used, with of course a truckload of maths!<br><br>So far that is the only next idea i'm keen to discuss but I have others too.<br><br>Also, I've finished mathematical functions checking if an edge (a line) is inside a 4-sided pyramid in space. This could be useful for anything else at least, if nothing comes out of it.<br><br>sswift, please don't be  "un-constructive" to us and to yourself! ;) <br><br></td></tr></table><br>
<a name="437799"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >N</td><td align="right"><font class=tiny>(Posted 2004)</font>&nbsp;<a href="#2">[#2]</a></td></tr></table></td></tr><tr ><td class="posttext"> First off, I hope you're good with math.<br><br><div class="quote"> finding better ideas replacing linepick <br></div><br><br>Coldet.  Look for elias_t's wrapper in the Toolbox.<br><br>Now, after reading most of that, I really don't know what advantages this would present over sswift's or any other shadow casting system.  Frankly, this sounds like it'd be much slower thanks to the increased polygon count through subdividing triangles into a great deal more triangles.  The best way I can see of doing shadows is projecting a shadow texture (created by a render to texture procedure) onto the receiving mesh (such a system would not require you to calculate the position and alignment of bones or vertices in a mesh [typically] for animated meshes). (Easier said than done, I know)<br><br>Anyhow, just me rambling, and I've already forgotten where I was going with my response. <br><br></td></tr></table><br>
<a name="437807"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Braincell</td><td align="right"><font class=tiny>(Posted 2004)</font>&nbsp;<a href="#3">[#3]</a></td></tr></table></td></tr><tr ><td class="posttext"> Oh ye, I think I'm good enough with maths.<br><br>Coldet. I'll look into it. Thanks.<br><br>You didnt read the "great idea" at the end. I was saying, same like you, that that would be slow, so I should have probably devoted more space to the other idea that i want to work on now. I just talked about the first idea in case anyone could notice any obvious improvements. Also I think it will be faster than swifts. A shadow of a 2000 poly mesh would be made of about 300 polys, since only outlines are calculated and the rest is filled in, but cut off at the edges of any reciever poly. So maybe more polys in some cases, but linepick will be gone... <br><br>Oh and isnt the way of doing shadows you mentioned, basically sswifts one? <br><br></td></tr></table><br>
<a name="437819"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >N</td><td align="right"><font class=tiny>(Posted 2004)</font>&nbsp;<a href="#4">[#4]</a></td></tr></table></td></tr><tr ><td class="posttext"> I don't own sswift's system, so asking me if it is sswift's technique is pointless. <br><br></td></tr></table><br>
<a name="437824"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Jeremy Alessi</td><td align="right"><font class=tiny>(Posted 2004)</font>&nbsp;<a href="#5">[#5]</a></td></tr></table></td></tr><tr ><td class="posttext"> Yeah Sswift's renders a texture.  I can't remember if it's cast directly on the polygons or if a proxy mesh is made and laid over the area ... but I think it's cast directly.  At least in the old version which we used in AA.  Aerial Antics had one problem though.  Logic was updated at 60 FPS.  I used to have this thing with game control being updated a lot and always went overboard ... but that would slow things down quite a bit.  Anyway, Sswift's system is plenty fast ... you just have to use low polygon proxy recievers and such.  Aerial Antics used all low polygon collision detection and shadow recievers.<br><br>Personally, I think it's a bit late in the game to develop a new shadow system.  B3D is already old and on the way out sometime next year once BMax has it's 3D module.  If you plan on releasing a game between now and then ... just use Sswift's system and save yourself a few weeks work.  If you're not actually making a game and just doing it for the intellectual stimulation ... have fun and good luck. <br><br></td></tr></table><br>
<a name="437838"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >sswift</td><td align="right"><font class=tiny>(Posted 2004)</font>&nbsp;<a href="#6">[#6]</a></td></tr></table></td></tr><tr ><td class="posttext"> "I've been thinking about making a completely new shadow system for Blitz which will be the fastest and most usable at the same time ever."<br><br>Hehe.  Good luck!  But I won't go down without a fight! :-) <br><br></td></tr></table><br>
<a name="437840"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >John Pickford</td><td align="right"><font class=tiny>(Posted 2004)</font>&nbsp;<a href="#7">[#7]</a></td></tr></table></td></tr><tr ><td class="posttext"> You lost me at the 6 lines bit; doesn't a bounding box have 8 corners? <br><br></td></tr></table><br>
<a name="437890"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Braincell</td><td align="right"><font class=tiny>(Posted 2004)</font>&nbsp;<a href="#8">[#8]</a></td></tr></table></td></tr><tr ><td class="posttext"> Jeremy:<br>Yes, intellectual stimulation is what i think this is. Also what you say about B3D is true, but i think still it'll take a while b4 BMax picks up that much pace. So i think it'll take about a 1.5 years from now till when its fully 3d usable. Just my opinion!<br><br>sswift:<br>Youre on buddy!!!!!!! :))))<br><br>John:<br>It has 8 corners but viewed from a point other than front,back,top (where it has 4), etc, it projects as a 6-sided shape!! <br><br></td></tr></table><br>
<a name="919437"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Zeotrope</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#9">[#9]</a></td></tr></table></td></tr><tr ><td class="posttext"> So did the new great shadow sys ever see the light of day?<br><br>I see a shadow monopoly being that of sswift<br><br>:) <br><br></td></tr></table><br>
<a name="919468"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Stevie G</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#10">[#10]</a></td></tr></table></td></tr><tr ><td class="posttext"> It did, it was a stencil system, it was bugged to hell and unfinished so completely unusable. <br><br></td></tr></table><br>
<a name="919597"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Dicon</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#11">[#11]</a></td></tr></table></td></tr><tr ><td class="posttext"> Sswift.<br> I finaly got your shadow system working. My fault. A way out of date Blitz re-installed after a crash but NOT UPDATED.<br> ( blush )<br>Looking good, and using it with .3DS exports and Giles.<br> Thanks.<br> Dicon <br><br></td></tr></table><br>
<a name="919622"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Zeotrope</td><td align="right"><font class=tiny>(Posted 2008)</font>&nbsp;<a href="#12">[#12]</a></td></tr></table></td></tr><tr ><td class="posttext"> I thought so!<br><br>The monopoly lives on. <br><br></td></tr></table><br>
<a name="bottom"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td align="right"><a href="http://monkeycoder.co.nz" target="_blank"><img src="/img/monkey2.svg" ></a> <a href="https://github.com/blitz-research" target="_blank"><img src="/img/github.svg" ></a> <a href="https://discord.gg/qJccbSp" target="_blank"><img src="/img/discord.svg" ></a></td></tr></table><br></div><br><table width="100%"><tr><td></body></html lang="en">
