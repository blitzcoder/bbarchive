<!DOCTYPE html><html lang="en" ><head ><title >Copy DIB to array?</title><meta name='viewport' content='width=device-width, initial-scale=0.66'><meta name='description' content='language:basic, target:desktop, category:game development'><link rel="styleSheet" href="../skins/granite/style.css" type="text/css"><style type="text/css">div.bbcode {padding: 8px;background: #E5E5E5;color: #000000;border: 1px dashed #B4B4BE;}</style></head><body ><table width=100% cellspacing=0 cellpadding=0><tr ><td class="menubarleft"></td><td class="menubar"><table cellspacing="0" cellpadding="0"><tr ><td >&nbsp;</td><td class="menuitemleft"></td><td class="menuitem"><a href="/" class="menuitem">News</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/forums.php" class="menuitem">Forums</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/codearcs.php" class="menuitem">Code</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/logs.php" class="menuitem">Logs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/gallery.php" class="menuitem">Gallery</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/sdkspecs.php" class="menuitem">Specs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/search.php" class="menuitem">Search</a></td><td class="menuitemright"></td></tr></table></td><td class="menubarright"></td></tr></table><div class="main"><h1 >Copy DIB to array?</h1><a href="forums.php" >Blitz3D Forums</a>/<a href="topics.php?forum=82" >Blitz3D Programming</a>/<a href="#bottom" >Copy DIB to array?</a><br><br>
<a name="1037475"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >FlagDKT</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#1">[#1]</a></td></tr></table></td></tr><tr ><td class="posttext"> How to copy bytes from a DIB pointer (using GETDC method) to an array without using getpixel() that is very slow?<br>I need to access data directly but I cannot access memory as far as I know..<br>BitBlt won't work with banks or array pointers..It needs a DC<br><br>Maybe I could use apiRtlMoveMemory() but it needs a memory pointer not a DC.. <br><br></td></tr></table><br>
<a name="1037520"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Adam Novagen</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#2">[#2]</a></td></tr></table></td></tr><tr ><td class="posttext"> I don't mean to sound like a total idiot, but... I have no idea what you're talking about. XD What is a DIB, what is GETDC, and come to that, what is a DC? o.O <br><br></td></tr></table><br>
<a name="1037531"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >dynaman</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#3">[#3]</a></td></tr></table></td></tr><tr ><td class="posttext"> DIB - Device Independant Bitmap.<br>GETDC - Get Device Context.  (I think)<br>DC - Device Context.  (In thise case a graphics device)<br><br>Sorry, I don't know how to answer the original question though.  I had enough trouble doing this in .net way back. <br><br></td></tr></table><br>
<a name="1037556"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Adam Novagen</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#4">[#4]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> DIB - Device Independant Bitmap.<br>GETDC - Get Device Context. (I think)<br>DC - Device Context. (In thise case a graphics device) <br></div><br><br>Oh, okay, clears that up. So um... How does this relate at all to Blitz3D... ? <br><br></td></tr></table><br>
<a name="1037641"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >dynaman</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#5">[#5]</a></td></tr></table></td></tr><tr ><td class="posttext"> &gt; How does this relate at all to Blitz3D... ?<br><br>It was the original question, my guess is that FlagDKT has a pointer to some screen memory and is trying to get an image of it.  Although I thought someone had written a library to do that. <br><br></td></tr></table><br>
<a name="1037647"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Serpent</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#6">[#6]</a></td></tr></table></td></tr><tr ><td class="posttext"> GetDIBits is probably what you're looking for.  It will save the 4-byte BGRA values at the specified memory address.  You'll just need to get the memory address of the array.  See <a href="http://msdn.microsoft.com/en-us/library/dd144879%28VS.85%29.aspx" target="_blank">MSDN</a> for more info on GetDIBits.<br>If you want an example of using GetDIBits in Blitz, I move everything into a bank, and then into a Blitz Buffer in my screenshot code in the archives. <a href="/codearcs/codearcs.php?code=2682" >Screenshot Functions</a> <br><br></td></tr></table><br>
<a name="1037690"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >FlagDKT</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#7">[#7]</a></td></tr></table></td></tr><tr ><td class="posttext"> Cool Serpent!<br>I guess it is much faster than getPixel() method?<br><br>I'm going to try it, I will let you know :) <br><br></td></tr></table><br>
<a name="1037721"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >FlagDKT</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#8">[#8]</a></td></tr></table></td></tr><tr ><td class="posttext"> <pre class=code>
LocBnk = CreateBank(76)
MoveMemoryObjInt(LocBnk,DestinationBuffer,76)
Loc = PeekInt(LocBnk,72)
FreeBank LocBnk
GetDIBitsInt hDC,hMemBmp,0,BufferHeight,Loc,bmi,0
</pre><br><br>Loc is the memory pointer where GetDIBitsInt() will write. It is the 72th byte of LocBnk. right?<br><br>why do you use MoveMemoryObjInt() ?<br><br>After GetDIBitsInt(),  should I read the Locbnk bank ?But it is only 76 bytes long..uhm<br>How to access copied data now?I have only a memory pointer..Loc<br><br>I'm missing something... <br><br></td></tr></table><br>
<a name="1038038"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Serpent</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#9">[#9]</a></td></tr></table></td></tr><tr ><td class="posttext"> Before I begin, yes this method is MUCH faster than using thousands of getPixel() calls.  The command executes in less than 1ms if I remember correctly (on my machine at least) and it gets all the data in a nice 4-byte integer progression.<br><br><br>Alright - a definite explanation of my screenshot code is in order.  It's not very intuitive and due to my bad practices it lacks comments :P<br><br>The idea of this function was to capture an image from the DC and put it into a Blitz 'Buffer' (e.g. ImageBuffer, BackBuffer, TextureBuffer, FrontBuffer).  So, unless you're doing something different and really don't want to try and comprehend my explanation, just skip to where I talk about using the GetDIBits function.<br><br>So the first thing I needed to do was get the memory address of the actual Bitmap data for the Buffer.  This is what the LocBnk and Loc stuff is all about.<br>According to:<br>http://translate.google.com/translate?hl=en&amp;ie=UTF-8&amp;sl=ru&amp;tl=en&amp;u=http://blitz.pp.ru/forum/showthread.php%3Fs%3D969a613d7deeb67f32385669ba81bcbb%26threadid%3D203%26perpage%3D15%26highlight%3D%26pagenumber%3D1&amp;prev=_t&amp;rurl=translate.google.com<br>there, the integer of the Blitz Buffer information which specifies the location of the bitmap data is at offset 72.  Hence, I copy 76 bytes of info to the bank, and then read the last four as an integer, placing it into the 'Loc' variable.<br><br><i>Skip this if you want:</i><br>The 'ObjInt' part of it is due to the different ways you can get Blitz to pass parameters to user-declared functions.  Whenever you create special objects as such (like Banks), Blitz will create an internal structure in memory which stores info about the bank.  The handle returned by functions like CreateBank is a pointer to this internal structure, not the bank data itself.  I think at least :P.<br>I don't want the memory to be copied to the internal Blitz structure, so I use the * symbol as a data type instead of % in the .decls file.  This means that Blitz will pass the memory location of the data automatically to the user-declared function.  So in my terms, ObjInt means the first variable is declared with a * so it is ideal for Banks, and the second is declared as an int (%) so it's ideal for handles, pointers, etc.<br><br><br><br>Okay, so after those four lines of code and a lot of (attempted) explaining, the location of the bitmap data for a Blitz Buffer is stored in the Loc variable.  Now, the exciting bit.  My GetDIBitsInt saves the bitmap data to the memory location Specified by the Loc variable.<br><br>Due to weird things like auto-rounding of Bitmap sizes to the nearest 16 in terms of width, or powers of 2 (in 3D modes), this function requires tweaking to work.  But depending on what you want to do, you'll need a similiar thing.<br><br><br><br>In my example, you'll noticed that I've put 'Int' on the end of GetDIBits.  This indicates that Blitz will pass a pointer that I specify as a straight-out integer.<br><br>I don't know why you need the values in an array, but if you do (and the array wasn't a roundabout way of putting them in an image or something) then you'll need to find the pointer to your array so you can pass it to GetDIBits.  If you're content with getting the data into a bank, that's easily done by manipulating memory with RTLMoveMemory.<br><br>If you can give more of an indication of what you need to do this for that would be great, or at least confirm that you need it in an array or not something else :)<br><br><br>eeek that was long for me :)  - well not really compared to some of the stuff i've posted before XD <br><br></td></tr></table><br>
<a name="1038072"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >FlagDKT</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#10">[#10]</a></td></tr></table></td></tr><tr ><td class="posttext"> Wow thanx! :D<br><br>Just a question now:<br>how to use RTLMoveMemory to fill a blitz bank or array with image data? <br><br></td></tr></table><br>
<a name="1038336"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Serpent</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#11">[#11]</a></td></tr></table></td></tr><tr ><td class="posttext"> I made a mistake in that last post :P<br><br>You don't even need one RTLMoveMemory call to fill a blitz bank with image data.  I'm not sure how to get the data into an array directly, but for a bank you just need to use a * in the .decls file because then Blitz will pass the pointer to the Bank data to the user-declared function.<br><br>Here's my example (a modified version of my screenshot function):<br><br>.decls Required:<br><pre class=code>.lib "gdi32.dll"
BitBlt%(hDestDC%,X%,Y%,nWidth%,nHeight%,hSrcDC,XSrc,YSrc,dwRop)
CreateCompatibleDC%(hdc%)
CreateCompatibleBitmap%(hdc%,Width%,Height%)
SelectObject%(obj%,selobj%)
DeleteDC(hdc%)
DeleteObject(hdc%)
GetDIBits%(hDC%,hbmp%,uStartScan%,uScanLines%,lpvBits*,lpbi*,uUsage%)

.lib "user32.dll"
GetDC%(hWnd%)
ReleaseDC%(hWnd%,hDC%)</pre>Note that the parameter 'lpvBits' in GetDIBits has an * for its type.<br><br>Example Code:<br><textarea class=codebox name="code" wrap=OFF readonly="true" rows="15" cols="80">Const SRCCOPY = $00CC0020

Local Width, Height
Local Bank

Width = 1024
Height = 768

Bank = CreateBank(Width * Height * 4)

Screenshot(Bank, Width, Height)

Graphics Width,Height,32,2

SetBuffer FrontBuffer()
LockBuffer FrontBuffer()

Local n, x, y

For n = 0 To Width * Height - 1
	
	x = n Mod Width
	y = n / Width
	
	WritePixelFast x, y, PeekInt(Bank, n*4)
	
Next

UnlockBuffer FrontBuffer()

WaitKey
End


Function Screenshot(DestinationBank,BankWidth,BankHeight)
	
	Local hDC, hMemDC, hMemBmp, bmi
	
	hDC = GetDC(0)
	hMemDC= CreateCompatibleDC(hDC)
	hMemBmp= CreateCompatibleBitmap(hDC,BankWidth,BankHeight)
	
	bmi = CreateBank(48)
	PokeByte bmi,0,44
	PokeInt bmi,4,BankWidth
	PokeInt bmi,8,-BankHeight
	PokeByte bmi,12,1
	PokeByte bmi,14,32
	
	SelectObject hMemDC, hMemBmp
	BitBlt hMemDC, 0, 0, BankWidth, BankHeight, hDC, 0, 0, SRCCOPY
	
	GetDIBits hDC,hMemBmp,0,BankHeight,DestinationBank,bmi,0
	
	ReleaseDC 0, hDC
	DeleteDC hMemDC
	DeleteObject hMemBmp
	
	FreeBank bmi
	Return True
	
End Function</textarea>Note that 'SRCCOPY' is used as one of the parameters for BitBlt.  It tells it to just copy the data.  There are other options as well.<br><br>One more note:  In the 'bmi' bank (my BITMAPINFO structure) you'll notice that a negative value is saved in it for the height.  This is because of a feature of GetDIBits.  If the height is positive, it will get an image from bottom-up.  If the height is negative it will get an image top-down.<br>In most work with Blitz top-down is the useful option, which is why I haven't bothered to have another parameter or something to allow the user to specify whether the image is top-down or bottom-up. <br><br></td></tr></table><br>
<a name="1038744"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >FlagDKT</td><td align="right"><font class=tiny>(Posted 2010)</font>&nbsp;<a href="#12">[#12]</a></td></tr></table></td></tr><tr ><td class="posttext"> great!<br>Thank you very much Serpent! :) <br><br></td></tr></table><br>
<a name="bottom"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td align="right"><a href="http://monkeycoder.co.nz" target="_blank"><img src="/img/monkey2.svg" ></a> <a href="https://github.com/blitz-research" target="_blank"><img src="/img/github.svg" ></a> <a href="https://discord.gg/qJccbSp" target="_blank"><img src="/img/discord.svg" ></a></td></tr></table><br></div><br><table width="100%"><tr><td></body></html lang="en">
