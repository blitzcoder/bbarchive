<!DOCTYPE html><html lang="en" ><head ><title >Mark.. Blitz's Z-buffer accessible,  but...</title><meta name='viewport' content='width=device-width, initial-scale=0.66'><meta name='description' content='language:basic, target:desktop, category:game development'><link rel="styleSheet" href="../skins/granite/style.css" type="text/css"><style type="text/css">div.bbcode {padding: 8px;background: #E5E5E5;color: #000000;border: 1px dashed #B4B4BE;}</style></head><body ><table width=100% cellspacing=0 cellpadding=0><tr ><td class="menubarleft"></td><td class="menubar"><table cellspacing="0" cellpadding="0"><tr ><td >&nbsp;</td><td class="menuitemleft"></td><td class="menuitem"><a href="/" class="menuitem">News</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/forums.php" class="menuitem">Forums</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/codearcs.php" class="menuitem">Code</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/logs.php" class="menuitem">Logs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/gallery.php" class="menuitem">Gallery</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/sdkspecs.php" class="menuitem">Specs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/search.php" class="menuitem">Search</a></td><td class="menuitemright"></td></tr></table></td><td class="menubarright"></td></tr></table><div class="main"><h1 >Mark.. Blitz's Z-buffer accessible,  but...</h1><a href="forums.php" >Blitz3D Forums</a>/<a href="topics.php?forum=82" >Blitz3D Programming</a>/<a href="#bottom" >Mark.. Blitz's Z-buffer accessible,  but...</a><br><br>
<a name="325733"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Tom</td><td align="right"><font class=tiny>(Posted 2004)</font>&nbsp;<a href="#1">[#1]</a></td></tr></table></td></tr><tr ><td class="posttext"> ... there's no way to find it from within Blitz, we need a native pointer to it (please!).<br><br><br>I weren't familiar with Zbuffers until MasterBeaker showed me a little demo, and explained why access to it could be useful for shadows. After my messing with banks/imagebuffers the other day, I thought I'd see if I could hunt the Zbuffer down.<br><br>I sniffed through Blitz allocated memory and come across this image<br><br><img src="http://www.tomspeed.com/hmm.jpg"><br><br>I noticed the polygons had definiton, even though the colors are screwed up. After some tinkering about (cheers Beaker &amp; Andreas) we managed to figure out how to convert the values into something visibly pleasing<br><br><a href="http://www.tomspeed.com/z-buffer.avi" target="_blank">http://www.tomspeed.com/z-buffer.avi</a> (600k Divx)<br><br>For those that don't understand the theory, this is what I learned after reading up on it:<br><br><img src="http://www.tomspeed.com/zbuffer.gif"><br><br>If this could speed up the creation of shadows, and it's just sitting there doing nothing, that's a terrible waste.<br><br>PLEASE can we have a pointer to it :)<br><br>Cheers!<br>Tom <br><br></td></tr></table><br>
<a name="325736"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rob</td><td align="right"><font class=tiny>(Posted 2004)</font>&nbsp;<a href="#2">[#2]</a></td></tr></table></td></tr><tr ><td class="posttext"> I have to support any request for z buffer access. Thumbs up! <br><br></td></tr></table><br>
<a name="325738"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >fredborg</td><td align="right"><font class=tiny>(Posted 2004)</font>&nbsp;<a href="#3">[#3]</a></td></tr></table></td></tr><tr ><td class="posttext"> The ability to access the z buffer directly, would be nothing short of: lækkert :)<br><br>Any chance of posting some code, so that we can start poking away now? <br><br></td></tr></table><br>
<a name="325746"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Beaker</td><td align="right"><font class=tiny>(Posted 2004)</font>&nbsp;<a href="#4">[#4]</a></td></tr></table></td></tr><tr ><td class="posttext"> To add to the argument here is my toon stencil shadow demo:<br><a href="http://www.zen28085.zen.co.uk/toon_stencil.zip" target="_blank">Click</a><br><br>This would be much improved (speed and functionality) with any of the following:<br>full access to the z-buffer<br>a pointer to z-buffer<br>triple buffered flipping <br><br></td></tr></table><br>
<a name="325762"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Tom</td><td align="right"><font class=tiny>(Posted 2004)</font>&nbsp;<a href="#5">[#5]</a></td></tr></table></td></tr><tr ><td class="posttext"> Fredborg, unfortunately the buffer will appear in different places on everyones PC, and I had more than a fair few craches trying to look at memory I shouldn't have been looking at :P<br><br>If Mark kindly supplies a pointer in a new build, or can indicate if maybe the backbuffer() or frontbuffer() memory heaps have a definite link to it, then it's as simple as peeking the buffer address+offset<br><br>To clamp the value to within 0 - 255 for a bitmap:<br><br>v=peekmemint(Zbuffer + offset) Shr 24<br><br>The buffer's 16 or 24bit, not entirely sure :) In the case of creating realtime shadows using the method above, you can avoid the need to convert the backbuffer to a bitmap, and just peek the X,Y value when you need it, so it should be very quick.<br><br>One thing I did notice, was that when using CameraRange cam,near,far only the 'near' value seemed to have an effect on the Z range.<br><br>Might I also suggest you check the other thread I started about redirecting Banks to imagebuffers which allows direct poking/peeking, and also the ability to pass an imagebuffer to a DLL for processing. Andreas has made some nice functions that act just like Blitz+ equivalents, they come in handy when messing with buffers.<br><br>Tom<br><br>p.s What is 'lækkert'? :P <br><br></td></tr></table><br>
<a name="325765"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >fredborg</td><td align="right"><font class=tiny>(Posted 2004)</font>&nbsp;<a href="#6">[#6]</a></td></tr></table></td></tr><tr ><td class="posttext"> Ok, I figured there would be a direct pointer from the screen buffers to the zbuffer. I can see how it becomes nasty if you have to second guess it's memory location.<br><br>lækkert = nice in a corny way :) <br><br></td></tr></table><br>
<a name="325772"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Warren</td><td align="right"><font class=tiny>(Posted 2004)</font>&nbsp;<a href="#7">[#7]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> Fredborg, unfortunately the buffer will appear in different places on everyones PC, and I had more than a fair few craches trying to look at memory I shouldn't have been looking at  <br></div><br>Yeah, I really would advise against using this technique to any great extent.  Different cards and different machines are going to store things in different places. <br><br></td></tr></table><br>
<a name="325788"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >sswift</td><td align="right"><font class=tiny>(Posted 2004)</font>&nbsp;<a href="#8">[#8]</a></td></tr></table></td></tr><tr ><td class="posttext"> I find it odd that the zbuffer would be in memory.  <br><br>I'm pretty sure that the zbuffer is generated on the 3D card, and copying it to memory would have the same speed hit as copying a full screen buffer to memory, which is to say, a significant one, which is why people want to be able to render directly to a texture instead of to video ram.  So why is Mark copying it to ram if it's not used?<br><br>I admit I don't know exactly what goes on when one renders a scene, but I'd like to understand why this is in ram. <br><br></td></tr></table><br>
<a name="325816"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Tom</td><td align="right"><font class=tiny>(Posted 2004)</font>&nbsp;<a href="#9">[#9]</a></td></tr></table></td></tr><tr ><td class="posttext"> sswift: Would having zbuffer access benefit your shadow routines?<br><br>The bottom address in the AVI is the starting memory address for that instance of the program, is there a way I could tell if that was video memory?<br><br>EpicBoy: Indeed, I don't recommend anyone tries this manualy.<br><br>A simple Zbuffer pointer would do the job!<br><br>Tom <br><br></td></tr></table><br>
<a name="325830"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >sswift</td><td align="right"><font class=tiny>(Posted 2004)</font>&nbsp;<a href="#10">[#10]</a></td></tr></table></td></tr><tr ><td class="posttext"> "sswift: Would having zbuffer access benefit your shadow routines?"<br><br><br>No, not really.  <br><br>In fact, without pixel shaders, I'm not sure that having access to the zbuffer would allow us to generate zbuffer shadows in realtime.<br><br>The traditional way would be to generate a zbuffer for the camera, and a zbuffer for the light source, and then using the distance of each pixel in the camera view from the camera, transform that pixel to light space to camera space, and then determine if the pixel's Z value in light space is greater than the distance of the pixel at that location which is in the light's zbuffer.  If so, then it is in shadow.<br><br>This would be expensive. <br><br></td></tr></table><br>
<a name="325833"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >sswift</td><td align="right"><font class=tiny>(Posted 2004)</font>&nbsp;<a href="#11">[#11]</a></td></tr></table></td></tr><tr ><td class="posttext"> I'm not even sure how one would convert a 2D screen coordinate  + Z value to camera space.  Anyone know a good way that doesn't reuqire you to know the camera's FOV? <br><br></td></tr></table><br>
<a name="325854"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Tom</td><td align="right"><font class=tiny>(Posted 2004)</font>&nbsp;<a href="#12">[#12]</a></td></tr></table></td></tr><tr ><td class="posttext"> Wouldn't you be doing each lightmap pixel, and not each camera pixel? <br><br></td></tr></table><br>
<a name="325864"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Koriolis</td><td align="right"><font class=tiny>(Posted 2004)</font>&nbsp;<a href="#13">[#13]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> In fact, without pixel shaders, I'm not sure that having access to the zbuffer would allow us to generate zbuffer shadows in realtime <br></div>Sure it does. Using shadow volumes. What you're refering to are shadow maps, a pretty different technique. <br><br></td></tr></table><br>
<a name="325865"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >sswift</td><td align="right"><font class=tiny>(Posted 2004)</font>&nbsp;<a href="#14">[#14]</a></td></tr></table></td></tr><tr ><td class="posttext"> No.  Because then you would miss a lot of camera pixels and hit a lot of them twice.<br><br>It's kind of like trying to draw a circle by detrmine if each point in a sqaure is in a circle, or drawing the circle by drawing circles of increasing size until you reach the radius you want.  In the latter you miss some pixels and hit quite a few others more than once. <br><br></td></tr></table><br>
<a name="325867"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >sswift</td><td align="right"><font class=tiny>(Posted 2004)</font>&nbsp;<a href="#15">[#15]</a></td></tr></table></td></tr><tr ><td class="posttext"> "Sure it does. Using shadow volumes. What you're refering to are shadow maps, a pretty different technique."<br><br>Uh... shadow volumes?  Shadow maps?<br><br>Shadow maps are what I use.  Shadow volumes sounds like the technique used for stencil shadows.  <br><br>Neither sounds like it has any realtion to zbuffer shadows, which use the method I described and which is probably one of the only methods for which calculating a zbuffer of the scene would be useful.<br><br>But feel free to find a webpage proving me wrong. :-) <br><br></td></tr></table><br>
<a name="325872"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >sswift</td><td align="right"><font class=tiny>(Posted 2004)</font>&nbsp;<a href="#16">[#16]</a></td></tr></table></td></tr><tr ><td class="posttext"> I found one papaer from NVidia referring to z-buffer shadows as "shadow mapping", but most pages I see are refering to stencil shadows when they mention shadow volumes, with no mention of zbuffers. <br><br></td></tr></table><br>
<a name="325873"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Koriolis</td><td align="right"><font class=tiny>(Posted 2004)</font>&nbsp;<a href="#17">[#17]</a></td></tr></table></td></tr><tr ><td class="posttext"> Doh!<br>... I must be tired (well, I am) ...<br>Somehow I read "Stendil buffer" when it was "z-buffer".<br>Erm, my bad.<br>I must say it seemed a bit weird that *you* used the wrong terms :p<br><br>Side note: I probably thought "stencil buffer" (when it was z buffer) because actually that is the buffer whos access lacks the most in blitz, and especially regarding the ability it would give to do fast stencil shadows. I don't even consider for one second z-buffer as an option for shadows (multiple lights -&gt; nightmare). <br><br></td></tr></table><br>
<a name="325879"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >sswift</td><td align="right"><font class=tiny>(Posted 2004)</font>&nbsp;<a href="#18">[#18]</a></td></tr></table></td></tr><tr ><td class="posttext"> Actually, even if we had access to the stencil buffer in Blitz we still couldn't do shadows because there is no way to get the vertex locations in an animated mesh.  Thus we could not extrude a volume from one and thus we could not render that volume to the stencil buffer.  In addition, because stencil buffers require such low ploygon models, and we lack pixel shaders to do proper dot3 normal mapping, we'd be stuck using very crappy looking low polygon models instead of svery snazzy looking low polygons models like Doom 3.<br><br>Neither zbuffer access nor stencil buffer access alone is a magic bullet for fast, great looking shadows. <br><br></td></tr></table><br>
<a name="325884"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Koriolis</td><td align="right"><font class=tiny>(Posted 2004)</font>&nbsp;<a href="#19">[#19]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> Actually, even if we had access to the stencil buffer in Blitz we still couldn't do shadows because there is no way to get the vertex locations in an animated mesh <br></div>Yep, I know. Actually there are alternatives, but too kludgy for being that appealing.<br><br><div class="quote">  In addition, because stencil buffers require such low ploygon models <br></div>I don't see the problem. You're not forced to use the same model for rendering and for collisions/shadows. It's not that uncommon to use a low-poly version for the latter 2 cases. <br><br></td></tr></table><br>
<a name="325887"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >(tu) sinu</td><td align="right"><font class=tiny>(Posted 2004)</font>&nbsp;<a href="#20">[#20]</a></td></tr></table></td></tr><tr ><td class="posttext"> that coming from the shadow expert, so it's final for now :) <br><br></td></tr></table><br>
<a name="325888"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >sswift</td><td align="right"><font class=tiny>(Posted 2004)</font>&nbsp;<a href="#21">[#21]</a></td></tr></table></td></tr><tr ><td class="posttext"> If you use a low poly version of the model for stencil shadows you'll get all sorts of glitches in self shadowing situations.<br><br>It's probably not possible to do stencil shadows and NOT enable self shadowing, but I'm not sure about that. <br><br></td></tr></table><br>
<a name="325892"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Koriolis</td><td align="right"><font class=tiny>(Posted 2004)</font>&nbsp;<a href="#22">[#22]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> If you use a low poly version of the model for stencil shadows you'll get all sorts of glitches in self shadowing situations <br></div>Eh eh, true. It was mainly for the sake of keeping discussing about it :p<br>I'm sure there is some trick to cope with this problem.<br><br><div class="quote"> It's probably not possible to do stencil shadows and NOT enable self shadowing, but I'm not sure about that.  <br></div>Indeed, AFAIK you can't do this (in a reasonably fast way). As it would require a way to determine what "self" is. And the beauty of the tecnique is precisely that it works blindly on the whole framebuffer, without any geometry knowledge.<br><br>BTW, do you provide in your lib any mean to associate a low-poly version of the shadow casting meshes? Even if you don't render them (for shadows) each frame, it would be better with a low poly version. Please bear with me, I never really checked your lib. <br><br></td></tr></table><br>
<a name="325908"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >sswift</td><td align="right"><font class=tiny>(Posted 2004)</font>&nbsp;<a href="#23">[#23]</a></td></tr></table></td></tr><tr ><td class="posttext"> "BTW, do you provide in your lib any mean to associate a low-poly version of the shadow casting meshes?" <br>"Even if you don't render them (for shadows) each frame, it would be better with a low poly version."<br><br>I don't understand what you mean. <br><br>Even if you don't render them (the low poly mesh) (for shadows) each frame it would be better with low poly mesh?  <br><br>Huh?<br><br><br><br>I presume you are asking if you can cast a shadow from a low poly version of the mesh instead of casting the shadow from the high poly mesh.<br><br>The answer to that is yes.  You can hide a mesh and still cast a shadow from it.  So you can have a visible high poly mesh that does not cast shadows, and an invisible low poly mesh that moves with it that casts shadows which then will appear to be originating from the high poly mesh.<br><br>I'm not really sure how much of a speed benefit you would gain from this, but I suppose if your shadow casting meshes were very high polygon you might get some benefit. <br><br></td></tr></table><br>
<a name="325913"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Koriolis</td><td align="right"><font class=tiny>(Posted 2004)</font>&nbsp;<a href="#24">[#24]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> I presume you are asking if you can cast a shadow from a low poly version of the mesh instead of casting the shadow from the high poly mesh <br></div>Er, yes, what I said that is.<br>[edit]Oh I see, you understood "even if you don't render them at all". I said "even if you don't render them *each frame*" but rather like each N frames, which is already far more efficient. You use some error threshold if I understood correctly.[/edit]<br><br>Anyway, that answers the question, thanks. <br><br></td></tr></table><br>
<a name="325934"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >sswift</td><td align="right"><font class=tiny>(Posted 2004)</font>&nbsp;<a href="#25">[#25]</a></td></tr></table></td></tr><tr ><td class="posttext"> Ah. <br><br>Yes, there is an error threshold, so the shadow maps do not get rendered every frame.  However, this only applies to objects which are not animating.  (By animating I mean an animated boned mesh)  I have not yet implemented a way to have a threshold for animated meshes.  For optimal results one would have to set a custom threshhold for each animated mesh, but even that is not the most idea solution because you could desire a large threshhold for portions of an animation which don't move much, and a small threshold for those which move a lot, like when one swings an arm.<br><br>I suppose then the ideal solution would be animation thrresholds which one could specify per mesh, and a function to change the animtion threshhold of an object which is already casting shadows.  Then at least you could have one threashold for the standing idle animation and then change it when the character is walking and change it again when he breaks into a run.<br><br>Of course right now you can't even cast shadows from MD2's and semgented 3D model animations require multiple shadows.  That being the case boned B3D models are the ideal choice for animated models, and as such if it were possible to determine which children of a model were boned then it might be possible to algorithmically determine the best threshold to use.  <br><br>Hm... <br><br></td></tr></table><br>
<a name="bottom"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td align="right"><a href="http://monkeycoder.co.nz" target="_blank"><img src="/img/monkey2.svg" ></a> <a href="https://github.com/blitz-research" target="_blank"><img src="/img/github.svg" ></a> <a href="https://discord.gg/qJccbSp" target="_blank"><img src="/img/discord.svg" ></a></td></tr></table><br></div><br><table width="100%"><tr><td></body></html lang="en">
