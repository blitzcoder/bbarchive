<!DOCTYPE html><html lang="en" ><head ><title >Quaternion Functions OK ?</title><meta name='viewport' content='width=device-width, initial-scale=0.66'><meta name='description' content='language:basic, target:desktop, category:game development'><link rel="styleSheet" href="../skins/granite/style.css" type="text/css"><style type="text/css">div.bbcode {padding: 8px;background: #E5E5E5;color: #000000;border: 1px dashed #B4B4BE;}</style></head><body ><table width=100% cellspacing=0 cellpadding=0><tr ><td class="menubarleft"></td><td class="menubar"><table cellspacing="0" cellpadding="0"><tr ><td >&nbsp;</td><td class="menuitemleft"></td><td class="menuitem"><a href="/" class="menuitem">News</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/forums.php" class="menuitem">Forums</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/codearcs.php" class="menuitem">Code</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/logs.php" class="menuitem">Logs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/gallery.php" class="menuitem">Gallery</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/sdkspecs.php" class="menuitem">Specs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/search.php" class="menuitem">Search</a></td><td class="menuitemright"></td></tr></table></td><td class="menubarright"></td></tr></table><div class="main"><h1 >Quaternion Functions OK ?</h1><a href="forums.php" >Blitz3D Forums</a>/<a href="topics.php?forum=82" >Blitz3D Programming</a>/<a href="#bottom" >Quaternion Functions OK ?</a><br><br>
<a name="293668"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Ricky Smith</td><td align="right"><font class=tiny>(Posted 2003)</font>&nbsp;<a href="#1">[#1]</a></td></tr></table></td></tr><tr ><td class="posttext"> Just want to know if anyone has tried successfully to convert Blitz pitch,yaw and roll values to quaternions using either the Functions in the code archives or the many functions available on the internet.<br>I have tried a few and they all seem to return the w value ok but the x,y,z components are always mixed up (z=x,x=y,y=z) with the x and y values having reverse polarity.<br>Its not a major issue as I just adjust the values returned to the correct component part, but I was just wondering why this should be and is it because of the different coordinate types/standards ? e.g. Max inverts the y and z component but I would have thought that pitch ,yaw and roll were global.<br>I'm pretty sure I am using the functions correctly but you never know ! <br><br></td></tr></table><br>
<a name="294332"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Wavey</td><td align="right"><font class=tiny>(Posted 2003)</font>&nbsp;<a href="#2">[#2]</a></td></tr></table></td></tr><tr ><td class="posttext"> They seem to work OK for me. How do you know what the x, y and z components should be?<br><br>If I remember correctly, there *is* a change in "handedness" of coordinate systems somewhere, but the code in the archives should compensate for this. There are examples of the quaternion code being used here: <a href="http://www.dscho.co.uk/blitz/tutorials/quaternions.shtml" target="_blank">http://www.dscho.co.uk/blitz/tutorials/quaternions.shtml</a> if you want to make sure you're using them correctly. <br><br></td></tr></table><br>
<a name="294368"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Ricky Smith</td><td align="right"><font class=tiny>(Posted 2003)</font>&nbsp;<a href="#3">[#3]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> <br>How do you know what the x, y and z components should be?<br> <br></div><br><br>I'm using the returned quaternion values to write animation keys. When these keys are replayed then the animation has the correct amount values but on the wrong x,y,z axis. I have tested this extensively and compared the generated  quaternion values using the functions in the archives with standard animation key values for identical frames and they are different.<br>Take an animated model -set the model to any frame using SetAnimTime()- convert the local pitch,yaw and roll values of each joint to a quaternion - the values returned are different to  the animation key values for that frame - the components are mixed as explained above with the x and y component inverted - you may have to view the .b3d file as XML to view what the keys quaternion values should be.<br>As I said, its no big deal as I simply reallocate the value to the correct component and reverse polarity where needed.<br>However as you say it works for you then it could well be something else that I've overlooked.<br>Thanks for the reply - much appreciated ! <br><br></td></tr></table><br>
<a name="294373"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Wavey</td><td align="right"><font class=tiny>(Posted 2003)</font>&nbsp;<a href="#4">[#4]</a></td></tr></table></td></tr><tr ><td class="posttext"> Sorry, I'm not sure what "standard key values" are - have these been generated outside of Blitz? If so, it might be that change in handedness I mentioned before that's causing the discrepancy. <br><br></td></tr></table><br>
<a name="294382"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Ricky Smith</td><td align="right"><font class=tiny>(Posted 2003)</font>&nbsp;<a href="#5">[#5]</a></td></tr></table></td></tr><tr ><td class="posttext"> The standard animation keys I am comparing against were generated in CharacterFX and exported as .b3d. These, of course, load fine and play the animation correctly.<br> Translating these key positions back to quats from the local pitch,yaw and roll values of each joint does  return the same values but not in the right component except for w.<br>Its not just the function in the archives - I have created my own from C++ examples on the net and I get  similar results. <br><br></td></tr></table><br>
<a name="294383"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Wavey</td><td align="right"><font class=tiny>(Posted 2003)</font>&nbsp;<a href="#6">[#6]</a></td></tr></table></td></tr><tr ><td class="posttext"> Ah, I think I see what might be going on - if the quats are in a b3d file, they'll have been generated by something else. I think there are different ways to calculate quaternions, and the method in the archives may not be the same as Blitz uses internally. So the QuatToEuler function should generally only be used on quats made by the EulerToQuat function, and vice versa. <br><br></td></tr></table><br>
<a name="294385"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Ricky Smith</td><td align="right"><font class=tiny>(Posted 2003)</font>&nbsp;<a href="#7">[#7]</a></td></tr></table></td></tr><tr ><td class="posttext"> That sounds logical - many thanks ! <br><br></td></tr></table><br>
<a name="294390"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >MattG</td><td align="right"><font class=tiny>(Posted 2003)</font>&nbsp;<a href="#8">[#8]</a></td></tr></table></td></tr><tr ><td class="posttext"> i have had many problems like this when trying to convert values from the GTA games , as this is how they store there objects , would you mind trying to help me out if i can sort some examples out<br><br>Matt <br><br></td></tr></table><br>
<a name="294403"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Ricky Smith</td><td align="right"><font class=tiny>(Posted 2003)</font>&nbsp;<a href="#9">[#9]</a></td></tr></table></td></tr><tr ><td class="posttext"> Over to you MattG ! <br><br></td></tr></table><br>
<a name="294587"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rob</td><td align="right"><font class=tiny>(Posted 2003)</font>&nbsp;<a href="#10">[#10]</a></td></tr></table></td></tr><tr ><td class="posttext"> The ones in code archives worked fine back when I was developing the max exporter. <br><br></td></tr></table><br>
<a name="294594"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Floyd</td><td align="right"><font class=tiny>(Posted 2003)</font>&nbsp;<a href="#11">[#11]</a></td></tr></table></td></tr><tr ><td class="posttext"> I hope we're all talking about the same code.<br><br>Here's a test of the EulerToQuat function. It has problems.<br><br><pre class=code>
; Quat.bb : v1.0 : 15/11/02

; A tutorial on how to use this file is at <a href="http://www.dscho.co.uk/blitz/tutorials/quaternions.shtml" target="_blank">http://www.dscho.co.uk/blitz/tutorials/quaternions.shtml</a>

; Types
Type Rotation
	Field pitch#, yaw#, roll#
End Type

Type Quat
	Field w#, x#, y#, z#
End Type

; convert a Rotation to a Quat
Function EulerToQuat(out.Quat, src.Rotation)
	; NB roll is inverted due to change in handedness of coordinate systems
	Local cr# = Cos(-src\roll/2)
	Local cp# = Cos(src\pitch/2)
	Local cy# = Cos(src\yaw/2)

	Local sr# = Sin(-src\roll/2)
	Local sp# = Sin(src\pitch/2)
	Local sy# = Sin(src\yaw/2)

	; These variables are only here to cut down on the number of multiplications
	Local cpcy# = cp * cy
	Local spsy# = sp * sy
	Local spcy# = sp * cy
	Local cpsy# = cp * sy

	; Generate the output quat
	out\w = cr * cpcy + sr * spsy
	out\x = sr * cpcy - cr * spsy
	out\y = cr * spcy + sr * cpsy
	out\z = cr * cpsy - sr * spcy
End Function

; convenience function to fill in a rotation structure
Function FillRotation(r.Rotation, pitch#, yaw#, roll#)
	r\pitch = pitch
	r\yaw = yaw
	r\roll = roll
End Function


; **********************************************************************

; Test 90 degree rotation around X+ axis: pitch = 90, yaw = roll = 0.

; Resulting quaternion rotates 90 degrees around Y+ axis.


q.quat = New quat
r.rotation = New rotation

fillrotation r,  90, 0, 0

EulerToQuat q, r

Print " Axis:   " + q\x + ",   " + q\y + ",   " + q\z

Print "Angle:   " + ( 2 * ACos(q\w) )

WaitKey : End
</pre><br><br>It should produce a rotation around the X-axis, but actually produces rotation around Y-axis. <br><br></td></tr></table><br>
<a name="295563"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Wavey</td><td align="right"><font class=tiny>(Posted 2003)</font>&nbsp;<a href="#12">[#12]</a></td></tr></table></td></tr><tr ><td class="posttext"> Floyd: Quaternions are *not* the same as (angle, axis) format, and so shouldn't be interpreted that way. Have a look at <a href="http://www.gamasutra.com/features/19980703/quaternions_01.htm" target="_blank">http://www.gamasutra.com/features/19980703/quaternions_01.htm</a> for some background info (it also briefly mentions the differences between the two representations). <br><br></td></tr></table><br>
<a name="295663"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Floyd</td><td align="right"><font class=tiny>(Posted 2003)</font>&nbsp;<a href="#13">[#13]</a></td></tr></table></td></tr><tr ><td class="posttext"> Quaternions are essentially the same as angle/axis, with some restrictions.<br><br>Quaternion (w,x,y,z) represents a rotation around an axis. <br><br>1. The axis points in the same direction as vector (x,y,z).<br>2. w is the cosine of half the angle of rotation.<br>3. The quaternion is scaled so it has length 1.<br><br>For example, consider a rotation of 120 degrees around the Y+ axis.<br>The angle is 120, so w is Cos(60).<br><br>(x,y,z) must point in the direction of (0,1,0).<br>This can be anything of the form (0,y,0), where y is a positive number.<br>But rule #3 says w*w + x*x + y*y + z*z = 1.0, so 0.25 + y*y = 1.0.<br>So y must be Sqr(0.75).<br><br>Thus the quaternion (w, x, y, z) is about ( 0.5, 0, 0.866, 0 ). <br><br>But if you try this with the test code EulerToQuat gives (x,y,z) = ( 0, 0, 0.866 ).<br><br>The coordinates x,y,z are mixed up. And a change in handedness can't explain this.<br>That would change the sign of something, interchanging positive and negative. <br><br></td></tr></table><br>
<a name="295675"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Wavey</td><td align="right"><font class=tiny>(Posted 2003)</font>&nbsp;<a href="#14">[#14]</a></td></tr></table></td></tr><tr ><td class="posttext"> Sorry, you're right. The functions were imported from a number of sources, so I don't know why it's behaving incorrectly. When I was testing them, I only used EulerToQuat then QuatToEuler, I don't think I paid much attention to what was actually in the Quat.<br><br>I don't currently have access to Blitz (or for the next few months), so if anyone would like to fix it and put it back in the code archives, they're more than welcome. <br><br></td></tr></table><br>
<a name="296178"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Ricky Smith</td><td align="right"><font class=tiny>(Posted 2003)</font>&nbsp;<a href="#15">[#15]</a></td></tr></table></td></tr><tr ><td class="posttext"> The function is ok as long as you do the following:<br><br>Reassign the resulting x,y and z components to :<br><br>z=x<br>x*-1=y<br>y*-1=z<br><br>the w component is ok.<br><br>Depending on which quat function you use this may alter slightly - I haven't found a quat function yet that does it right first time - they're ok when working with their own generated quats but using  .b3d quaternion animation keys they screw up big time. <br><br></td></tr></table><br>
<a name="bottom"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td align="right"><a href="http://monkeycoder.co.nz" target="_blank"><img src="/img/monkey2.svg" ></a> <a href="https://github.com/blitz-research" target="_blank"><img src="/img/github.svg" ></a> <a href="https://discord.gg/qJccbSp" target="_blank"><img src="/img/discord.svg" ></a></td></tr></table><br></div><br><table width="100%"><tr><td></body></html lang="en">
