<!DOCTYPE html><html lang="en" ><head ><title >How to deal with lag in a network game.</title><meta name='viewport' content='width=device-width, initial-scale=0.66'><meta name='description' content='language:basic, target:desktop, category:game development'><link rel="styleSheet" href="../skins/granite/style.css" type="text/css"><style type="text/css">div.bbcode {padding: 8px;background: #E5E5E5;color: #000000;border: 1px dashed #B4B4BE;}</style></head><body ><table width=100% cellspacing=0 cellpadding=0><tr ><td class="menubarleft"></td><td class="menubar"><table cellspacing="0" cellpadding="0"><tr ><td >&nbsp;</td><td class="menuitemleft"></td><td class="menuitem"><a href="/" class="menuitem">News</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/forums.php" class="menuitem">Forums</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/codearcs.php" class="menuitem">Code</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/logs.php" class="menuitem">Logs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/gallery.php" class="menuitem">Gallery</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/sdkspecs.php" class="menuitem">Specs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/search.php" class="menuitem">Search</a></td><td class="menuitemright"></td></tr></table></td><td class="menubarright"></td></tr></table><div class="main"><h1 >How to deal with lag in a network game.</h1><a href="forums.php" >Blitz3D Forums</a>/<a href="topics.php?forum=82" >Blitz3D Programming</a>/<a href="#bottom" >How to deal with lag in a network game.</a><br><br>
<a name="995603"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >WERDNA</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#1">[#1]</a></td></tr></table></td></tr><tr ><td class="posttext"> Hey everyone!<br><br>Things are going pretty good in WERDNA WORLD right now, having<br>finally made my first online game :)<br><br>I have one question though.<br>How do I account for lag?<br><br>The game played perfectly when my 2 play testers played it locally<br>on their LAN network with each other, but as soon as I started<br>hosting it, they could join just fine but there were massive lag spikes<br>every 30 seconds or so.<br><br>Changing the code so the network updated every 5th loop, instead<br>of every single loop seemed to fix most of it, but it was still there<br>to some extent.<br><br>Currently I pack player data into a string, and send it through<br>sendnetmsg like this.<br>Function PackPlayerMsg$( p.Player )<br>	Return LSet$( Int(p\x),6 )+LSet$( Int(p\y),6 )+LSet$( Int(p\r),6 )+LSet$( Int(p\typ),6 )+LSet$( Int(p\Pos),6 )+LSet$( Int(p\T),6 )+LSet$( Int(BallNum),6)+LSet$( Int(Ball1X),6 )+LSet$( Int(Ball1Y),6 )<br>End Function<br><br><br>And then Unpack player data through this.<br>Function UnpackPlayerMsg( msg$,p.Player )<br>	x=Mid$( msg$,1,6 )<br>	y=Mid$( msg$,7,6 )<br>	r=Mid$( msg$,13,6 )<br>	typ=Mid$( msg$,19,6 )<br>	pos=Mid$( msg$,25,6 )<br>	T=Mid$( msg$,31,6 )<br>	NewBNum=Mid$( msg$,37,6 )<br>	B1X=Mid$( msg$,43,6 )<br>	B1Y=Mid$( msg$,49,6 )<br>	p\dx=(x-p\x)/smoothing<br>	p\dy=(y-p\y)/smoothing<br>	p\dr=(r-p\r)/smoothing<br>	p\typ = typ<br>	p\Pos = Pos<br>	p\T = T<br>	If P\T = False <br>	BallNum=NewBNum<br>	Ball1X = B1X<br>	Ball1Y = B1Y<br>	End If <br>End Function<br><br><br>Should I split up the data transfers throughout the code, so not<br>too much at once is being sent?<br><br>Thanks, <br><br></td></tr></table><br>
<a name="995610"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >jfk EO-11110</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#2">[#2]</a></td></tr></table></td></tr><tr ><td class="posttext"> Do I get this right, SentNetMsg is part of the DirectPlay Network Command Set? I think you maybe better use plain TCP or UDP instead. Spikes, as you described, shouldn't be there unless the connection was interrupted by the provider, or a defect cable etc. Maybe try one of the existing TCP or UDP solutions. Sending packets of a certain size is ok, because if they are too small then there's a handling-overhead. But basicly data should be reduced to the min, of course.<br><br>Then there is the Lag of non-LAN connections, around the world. However, Lags are often handled with "dead reckoning" algorithms. So they don't send the players coordinates, but their direction and speed, so each computer can "continue" an other players motion in the most likely way, when there is a lag, and try to display everyones position in realtime. Then, frequently, the positions and esp. the actions are updated, using the players real position and current action/speed etc. But this kind of Lag-fight shouldn't be an issue in LAN only games. <br><br></td></tr></table><br>
<a name="995635"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >WERDNA</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#3">[#3]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote">   However, Lags are often handled with "dead reckoning" algorithms.   <br></div><br><br>Thats what I was looking for!<br><br>Someone came up with a really useful method, similar to what you describe<br>for dealing with framerate speeds.<br><br>And yes, SendNetMsg is part of the DirectPlay Network Command Set.<br>I might try using TCP, or UDP instead, although I'll play test a tad more<br>first :)<br><br><br>Thanks a bundle jfk!<br><br>And if anyone else has anything to add to his advice, it would be much<br>appreciated :D <br><br></td></tr></table><br>
<a name="995684"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >RifRaf</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#4">[#4]</a></td></tr></table></td></tr><tr ><td class="posttext"> I dont recommend dead reckoning just based off my own attempts with various methods.<br><br> I also recommend UDP. there are libraries out there that already handle it very well.   Bplay pro 2.0 (2.2 has gnet bugs that can crash randomly), Rottnett (Free), a few others including some DLL libraries that I havent tried. <br><br>I recommend sending only position orientation packets and interpolating them. using this you know the players are always in sync and in the correct position across the network.  Other methods ive tried were more complicated to sync up.<br><br>  If you want to see how this method works download my game and try it.  <br><br>A few tips<br><br><br>1.<br> if possible cluster your packets.. for example if you have a server-client setup, when the server receives a group of messages.. wait until you check all the messages in that loop and lump all similar together and rebroadcast that rather than rebroadcasting each one as you pass it in the loop.<br>example of this is to add a byte to your master packet indicating how many <br>packets were added to the cluster, after you read that loop through the rest of the packet accordingly.<br>code example<br><pre class=code>
;pseudo netmessage cluster recieve code  
Case movementpack%
 numberof=BP_StrToInt(Mid$(msg\msgdata,1,2))
 offset=3
 For i=1 To numberof
   miscdata=Int(Mid$(msg\msgdata,offset,1))
    offset=offset+1
   pitch#=BP_StrToFloat(Mid$(msg\msgdata,offset,4))
    offset=offset+4
   roll#=BP_StrToFloat(Mid$(msg\msgdata,offset,4))
    offset=offset+4
   yaw#=BP_StrToFloat(Mid$(msg\msgdata,offset,4))	
    offset=offset+4
   y#=BP_StrToFloat(Mid$(msg\msgdata,offset,4))
    offset=offset+4
   x#=BP_StrToFloat(Mid$(msg\msgdata,offset,4))				
    offset=offset+4
   z#=BP_StrToFloat(Mid$(msg\msgdata,offset,4))				
    offset=offset+4
   pid=Asc(Mid$(msg\msgdata,offset,1))
    offset=offset+1
   p.player=FindPlayer_ByNetID.player(PID)
   If p&lt;&gt;Null Then do_somthing here
Next
</pre><br>2.<br>  If you have a twitch game like an fps.  You can get away with  5 orientation updates per second (in my testing), but I think if your game is slower  you could do between one and three per second, turn based you can send only when actions are taken.<br><br>3.<br> Put a local client check on actions that send data.. For example if a client can only fire when hes not reloading , dont allow the client to send the network command to fire to the server.   Even if the server will double check this as well, theres no need to even get to the servers check if you are still reloading. Also add some sort of delay for repeatable actions that require packets sent out. One example could be chat, have a spam check so that players cannot packet flood the server intentionally<br><br>4. <br> Dependable packets should have some sort of resend limit.. dont resend them indefinatly. Kick players that dont send a confirmation packet after x tries.<br><br>5.<br> Compress your packets .. blitzplay lite and rottnett have examples of this. with BP_INTTOSTR() BP_FLOATTOSTR(). in your example you are using six characters per coordinate.. if your coords are always positive you can use two characters, if not you can use four.<br>  If all of you data is positive it would reduce a single packet to only 18 bytes  <br>6.<br> Dont send everything dependable. Just critical data. <br><br></td></tr></table><br>
<a name="995772"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >WERDNA</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#5">[#5]</a></td></tr></table></td></tr><tr ><td class="posttext"> Thanks a lot RifRaf!<br><br>That advice was invaluable :)<br><br>I'll check out Bplay pro 2.0, and rottnett, but will probably attempt to<br>write my own.(Not because it would be better, but because it would<br>broaden my knowledge of network code. I just want to have a solid<br>understanding of how it all works)<br><br><br>Thanks a bundle! <br><br></td></tr></table><br>
<a name="995796"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rroff</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#6">[#6]</a></td></tr></table></td></tr><tr ><td class="posttext"> As above you deff. wanna be using UDP - and get to grips with interpolation and extrapolation - typically with network games the clients will be running upto 1 frame behind the most current one they have and intepolating between the latest one and the previous set of data. <br><br></td></tr></table><br>
<a name="995821"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >RifRaf</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#7">[#7]</a></td></tr></table></td></tr><tr ><td class="posttext"> a good article that may help you.. if you are using Blitz3D you may want to consider what you can afford to do and what you cannot , since Blitz3D is not as fast as C++, or Bmax. using all the listed techniques might be too costly.<br><br><a href="http://developer.valvesoftware.com/wiki/Source_Multiplayer_Networking" target="_blank">http://developer.valvesoftware.com/wiki/Source_Multiplayer_Networking</a> <br><br></td></tr></table><br>
<a name="995850"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >WERDNA</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#8">[#8]</a></td></tr></table></td></tr><tr ><td class="posttext"> Thanks once again RifRaf!(And Rroff)<br><br>I'll check this out in a bet, going to be working on my blender lessons right now :)<br><br>I just used the DirectPlay commands because they were the easiest<br>ones to learn. I'll work on both the UDP, and ICP commands next.<br><br>Thanks a bundle! <br><br></td></tr></table><br>
<a name="996454"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Blitzplotter</td><td align="right"><font class=tiny>(Posted 2009)</font>&nbsp;<a href="#9">[#9]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote">  a good article that may help you.. if you are using Blitz3D you may want to consider what you can afford to do and what you cannot , since Blitz3D is not as fast as C++, or Bmax. using all the listed techniques might be too costly.  <br></div><br><br>Hmm, I wonder if there has ever been an attempt at a true comparison between apps (i.e.B3D, BMax with miniB3D, C/C++ with how many libs to achieve what can be done with relative ease within Blitz products? etc) performing similar networked functionality.  I made some progress with network code within B3D, however the math of trying to correlate vehicles at varying speeds in 2 separate worlds on computers with vastly different hardware eluded me. I opted for a Server/Client variant in B3D messing about at the byte level with 512 byte packets. <br><br></td></tr></table><br>
<a name="bottom"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td align="right"><a href="http://monkeycoder.co.nz" target="_blank"><img src="/img/monkey2.svg" ></a> <a href="https://github.com/blitz-research" target="_blank"><img src="/img/github.svg" ></a> <a href="https://discord.gg/qJccbSp" target="_blank"><img src="/img/discord.svg" ></a></td></tr></table><br></div><br><table width="100%"><tr><td></body></html lang="en">
