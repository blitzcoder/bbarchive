<!DOCTYPE html><html lang="en" ><head ><title >I have solved the dark edges in lightmaps problem!</title><meta name='viewport' content='width=device-width, initial-scale=0.66'><meta name='description' content='language:basic, target:desktop, category:game development'><link rel="styleSheet" href="../skins/granite/style.css" type="text/css"><style type="text/css">div.bbcode {padding: 8px;background: #E5E5E5;color: #000000;border: 1px dashed #B4B4BE;}</style></head><body ><table width=100% cellspacing=0 cellpadding=0><tr ><td class="menubarleft"></td><td class="menubar"><table cellspacing="0" cellpadding="0"><tr ><td >&nbsp;</td><td class="menuitemleft"></td><td class="menuitem"><a href="/" class="menuitem">News</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/forums.php" class="menuitem">Forums</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/codearcs.php" class="menuitem">Code</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/logs.php" class="menuitem">Logs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/gallery.php" class="menuitem">Gallery</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/sdkspecs.php" class="menuitem">Specs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/search.php" class="menuitem">Search</a></td><td class="menuitemright"></td></tr></table></td><td class="menubarright"></td></tr></table><div class="main"><h1 >I have solved the dark edges in lightmaps problem!</h1><a href="forums.php" >Blitz3D Forums</a>/<a href="topics.php?forum=82" >Blitz3D Programming</a>/<a href="#bottom" >I have solved the dark edges in lightmaps problem!</a><br><br>
<a name="262118"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >sswift</td><td align="right"><font class=tiny>(Posted 2003)</font>&nbsp;<a href="#1">[#1]</a></td></tr></table></td></tr><tr ><td class="posttext"> And it is absurdly simple to solve! <br>(Even though some folks claimed it could not be solved!)<br><br>I was playing around with YAL from the code archives... the newer 1.4 version today. (As opposed to the actually older "update" version listed after it.)<br><br>Anyhow, I looked at a few pages on lightmapping an radiosity trying to find info on how someone else solved the problem, but I couldn't find anything.<br><br>Then, it occured to me that a texel that is inside a wall is on the back side of all polygons the wall is made of.  <br><br>But a texel which is actually obscured by geometry is on the OUTSIDE of the geometry.<br><br>It was then that I realised that the only problem with YAL's lightmapping was that one function call had the paramters reversed:<br><br>If EntityVisible(LumelPivot, LightPivot)<br>;If EntityVisible(LightPivot, LumelPivot)<br>   NHits = NHits + 1<br>EndIf<br><br>The original code, commented out, can be found in the LMLightProcess() function.<br><br>As you can see, instead of the light looking at the lumel to see if the light can see the lumel, the lumel looks at the light to see if it can see the light.  Now, if a lumel is inside a wall, it can see the light, because the wall, facing away from the lumel, will be culled, and the lumel will be lit.  But if it is on the outside of the wall, but on the opposite side from the light, a polygon, which is not culled because it faces the lumel, will be in the way, and the lumel will not be able to see the light.<br><br>...<br><br>There is one problem with this method of lighting however.<br><br>With this method, it becomes possible for light to bleed under walls.  This will be potentially visible in dark areas.<br><br>However, because of the nature of levels being brightly lit, and the fact that you're much less likely to have pixels improperly lit by light, than improperly shadowed by being partly outside of the level or partially inside walls, this is a worthwhile tradeoff.<br><br>Also, I beleive that if you sampled each texel from the four corners rather than from the center, and if any of those were shadowed the texel was shadowed, then that would solve that final issue of light bleeding under walls.<br><br>Here is a before and after pic from YAL:<br><br><img src="http://home.earthlink.net/~sswift/before.jpg"><br><img src="http://home.earthlink.net/~sswift/after.jpg"><br><br><br>You'll notice that something doesn't look quite right with the cube in the center.  For one, there appears to be a dark shadow extending out from the bottom of it onto the larger cube.  And for another, the sides of it are darker.<br><br>I'm not sure exactly what is causing these issues.  I beleive that there's couple bugs elsewhere in YAL which is causing these two issues.  <br><br>I think that the dark edges on the small cube may be caused by bilinear filtering because the areas adjacent to those edges are outside of the area calculated by the lightmap.  I think YAL may be calculating lighting info for only those texels which are actually inside the polygons.    If so, then the solution is to calculate an extra texel or two outside of the polygons.<br><br>As for the dark shadow along the base of the cube...  That's caused by the dark area inside the cube leaking out.  If you go inside the cube it's the same color as the area inside the cube.  Come to think of it, I'm not sure actually why there is any dark area inside the cube at all.  The floor under the cube should be able to see the light...  Unless...  Maybe the cube's bottom side is managing to hide those texels.  That could be it I suppose.  I'm not posiive though.  If so, then it seems that a properly consturcted level would not have this issue because you shouldn't even have a floor inside that cube, nevermind having that cube have a bottom to it.<br><br>[edit]<br>Yes, moving the little cube down a fraction of an inch puts it's bottom beneath the floor of the larger cube, and as a result, the shadow along the lower edge of the small cube which should not be there dissapeared, and a tiny bit of light bleed under the cube showed up, but it's much less visible and would probably be virtually impossible to see with real textures there.<br><br>But the dark edges are still on the small cube itself.  Have to find some way to calculate extra pixels around the polygosn for the lightmaps... But I'm not very familiar with YAL's code yet.<br>[/edit] <br><br></td></tr></table><br>
<a name="262128"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >IPete2</td><td align="right"><font class=tiny>(Posted 2003)</font>&nbsp;<a href="#2">[#2]</a></td></tr></table></td></tr><tr ><td class="posttext"> I hope some of this cleverness rubs off on others who frequent these forums...er like me!<br><br>Well done Shawn!<br><br>IPete2. <br><br></td></tr></table><br>
<a name="262144"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >sswift</td><td align="right"><font class=tiny>(Posted 2003)</font>&nbsp;<a href="#3">[#3]</a></td></tr></table></td></tr><tr ><td class="posttext"> I have solved the dark edges on the cube problem, and significantly reduced the dark band you got on one side of the cube.<br><br>You need to change this function.  Look for the comments that have (sswift) in them.  You will also need to change the terrain lighting function in the same manner.<br><br>Bascially, the problem was that the lightmapper was casting rays from the light to the TOP LEFT CORNER of each lumel instead of at the lumel's center.  The center of each lumel corresponds to the center of each pixel in the lightmap.  So it was sampling from the wrong place.<br><br><pre class=code>
See link two messages down.
</pre><br><br><br>The only issues now are that the top of the cube displays slightly lighter bands near it's edges, and near the bottom of the cube on the floor you see either a slightly lighter shade or slightly darker shade in the lightmap depending on wehther you offset the cube into the floor a tiny bit or not.<br><br>You should be able to reduce these artifacts by doing 4x antialiasing on the lightmap.  Ie, sample it at twice the resolution and then average it down.  But that won't solve the issue entirely.<br><br>As for how to solve the issue entirely, I think you'd need to be able to detect when a texel is partially in shadow so you can darken it.  So that would involve sampling at each of the 4 corners of the texel. Then texels which have a center that is just inside a wall on the opposite side of the wall from a light would have two corners out side the wall on the shadowed side of the wall, and that texel would therefore become shadowed. <br><br></td></tr></table><br>
<a name="262156"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >sswift</td><td align="right"><font class=tiny>(Posted 2003)</font>&nbsp;<a href="#4">[#4]</a></td></tr></table></td></tr><tr ><td class="posttext"> Okay, I fixed the problems.<br><br>First, I set the lightmapping function so it would accept the current lumel size as a parameter.  Then, I used that value to calculate the corners of the lumel.  Then I check all four corners of each lumel to see if it can see the light source.  If ALL of them can, then that lumel is in the light.<br><br>(You might want to increase the size you pass to the function depending on the amount of blur you use.  It may help to avoid areas being lit by the blur that should not be lit.)<br><br>Then, I added a constant which allows you to move the lumel pivot away from the surface it is illuminating in the direction of the lightmap mapping.  By moving it away from the surface a tiny bit, objects that rest flat on the ground and have bottoms no longer have black outlines around them on the ground, and there are no black outlines around the edges of some objects like the cube which had some new black outlines caused by the more agressive shadowing.<br><br>The only remaining issue is that the dark top of the cube has  a tiny bit of light at the fornt and back edges.  I'm not sure why this is.  I think it might have to do with the light under the wall leak issue with this different way of lighting.  In that case I don't know how to solve it.<br><br>Here's a pic of the latest version:<br><br><img src="http://home.earthlink.net/~sswift/after2.jpg"><br><br>And here's a link to the latest code.  The terrain functions still need to be updated.  I'm not gonna muck about with it though, I'm just messing around with this cause I'm bored.<br><br><a href="http://home.earthlink.net/~sswift/514-004.bb" target="_blank">http://home.earthlink.net/~sswift/514-004.bb</a><br><br>I think I'm gonna try one last thing with this.  I'm gonna try going back to the old method of calculating which lumels are hit by light, but then make any lumel which has a corner that is lit be lit, and see what that does. <br><br></td></tr></table><br>
<a name="262161"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >sswift</td><td align="right"><font class=tiny>(Posted 2003)</font>&nbsp;<a href="#5">[#5]</a></td></tr></table></td></tr><tr ><td class="posttext"> Well I tried the old lighting method with the new 4 sample method from the lumel corners, but while it did fix a lot of artifacts it still left a bunch and created new ones that I'm not sure how to fix, so it looks like the above will be as good as it gets for now. <br><br></td></tr></table><br>
<a name="262168"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >jfk EO-11110</td><td align="right"><font class=tiny>(Posted 2003)</font>&nbsp;<a href="#6">[#6]</a></td></tr></table></td></tr><tr ><td class="posttext"> Amazing work! I'm am hopeful the new problems will be solved the sooner or the later. <br><br></td></tr></table><br>
<a name="262196"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >JaviCervera</td><td align="right"><font class=tiny>(Posted 2003)</font>&nbsp;<a href="#7">[#7]</a></td></tr></table></td></tr><tr ><td class="posttext"> sswift GREAT WORK!!! I have fixed this horrible bleeding in BSP Factory! Thank you! <br><br></td></tr></table><br>
<a name="262210"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >DJWoodgate</td><td align="right"><font class=tiny>(Posted 2003)</font>&nbsp;<a href="#8">[#8]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> <br>The only remaining issue is that the dark top of the cube has a tiny bit of light at the fornt and back edges. I'm not sure why this is. I think it might have to do with the light under the wall leak issue with this different way of lighting. In that case I don't know how to solve it. <br> <br></div><br><br>Is this due to bilinear filtering? Perhaps duplicating the border pixels for each image in the lightmap will solve it? <br><br></td></tr></table><br>
<a name="262212"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Koriolis</td><td align="right"><font class=tiny>(Posted 2003)</font>&nbsp;<a href="#9">[#9]</a></td></tr></table></td></tr><tr ><td class="posttext"> I made the exact same guess. It's logical that this happens if polygons are packed without any border betyween them in the textures, and there's nothing else (other than creating a one-pixel border) you can do to prevent this. The problem being that this would require independant sets of texture coordinates for adjacent polygons (to have a delta of one pixel between the texture coordinates of a vertex for different polygons). And I don't see how you can do that (in the present state of b3d) without unwelding every vertex, which is not a very good idea. So better keep going in this way SSwift : cheating a little bit to minimize the artefacts.<br>If we had more than 2 texture coordinates sets in b3d, we could make "clever" processing to have adjacent polygons use different sets, thus allowing to have independant texture coordinates for each polygon, without duplicating the vertices. This way we would have perfect, sharp borders. <br><br></td></tr></table><br>
<a name="262213"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >sswift</td><td align="right"><font class=tiny>(Posted 2003)</font>&nbsp;<a href="#10">[#10]</a></td></tr></table></td></tr><tr ><td class="posttext"> "Is this due to bilinear filtering?"<br><br>I'm not sure. It is either that, or it is lighter pixels around the edges of the map caused by the pixels off the map being in the light because there's no surface between then an d the light because in reality they are off the edge of the polygons on the top of the cube.<br><br><br>"Perhaps duplicating the border pixels for each image in the lightmap will solve it?"  <br><br>It probably would, but you'll have to determine those borders using the actual polygons mapped to the lightmap, which is too much work for me. :-)  <br><br>And you have to make sure that the lightmaps as it is don't already butt up against one another.  Which unfortunately, I think they do, because YAL combined multiple polygons into single "surfaces".  So you'll have to duplicate only the edges of the triangles in those "surfaces" which do not touch other triangles in the surface. <br><br></td></tr></table><br>
<a name="262220"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >sswift</td><td align="right"><font class=tiny>(Posted 2003)</font>&nbsp;<a href="#11">[#11]</a></td></tr></table></td></tr><tr ><td class="posttext"> I thought that it was likely that the top of the cube was being illuminated by the lights below, but it looks like I was wrong, and that YAL does in fact check the angle of incidence for light rays hitting the surfaces and attentuates the light properly.  So a lumel that's off a surface should still be facing away from the light and be dark, even if there's really nothing between it and the light.<br><br>So that can't be the issue.<br><br>The only remaining possiblity is bilinear filtering...  And looking at the lightmap that is generated, I think I can say that this is our culprit.  I'm pretty sure the top of the cube is being put in the top right corner, which means that on each side of it sit the much larger light grey lightmaps.     (YAL compresses lightmaps with low contrast more than others)<br><br>Unfortunately it looks like YAL must stick it's UV's right up against the map edges.  So we can't simply draw extra pixels around it.  We'll have to find a way to get it to make the polygons smaller within the lightmaps. <br><br></td></tr></table><br>
<a name="262227"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >sswift</td><td align="right"><font class=tiny>(Posted 2003)</font>&nbsp;<a href="#12">[#12]</a></td></tr></table></td></tr><tr ><td class="posttext"> I found a totally unrelated bug in YAL while looking through it.<br><br>The function which decided whether a lightmap had a small enough amount of contrast to compress was comparing the maximum R G or B with the minimum R G or B.  The result of this was that a pure red map would be considered high contrast because G and B would be 0 and red would be much greater.<br><br>So I fixed the function to compare each channel seperately and then return the contrast of the one with the highest contrast.<br><br>And here's a link to another post I made about it so as not to muck up this thread with wide code.<br><br><a href="http://www.blitzbasic.com/bbs/posts.php?topic=25245" target="_blank">http://www.blitzbasic.com/bbs/posts.php?topic=25245</a> <br><br></td></tr></table><br>
<a name="262234"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >sswift</td><td align="right"><font class=tiny>(Posted 2003)</font>&nbsp;<a href="#13">[#13]</a></td></tr></table></td></tr><tr ><td class="posttext"> Okay I got rid of the lighting on top of the cube, but I don't really understand the math behind what I did.<br><br>Here's the code I changed in the LMSetupSurface function:<br><br><pre class=code>
	; Reduce black borders
	; (sswift)
	; Multiplying by 3.0 eradicates the light bleeding from adjacent lightmaps, but I don't know why, or what
	; effect changing the lumel size will have.
	;DT# = lumelsize * Float(blurradius + 1)
	DT# = LumelSize# * Float(BlurRadius# + 1.0) * 3.0
</pre><br><br><br>As you can see I simply multiplied DT# by 3.0 above and beyond what it was already set to for removing black borders.  Unfortunately, I don't have a complete grasp of all the mathmatical goings on here at the moment so I don't know what exactly I've done, and whether it will stand up to changing the lumel size or if it is going to be wasting tons of space in the lightmap.  The lightmapping LOOKS fine though with the current lumel size.  I will have to change the lumel size and see what the effect is now and try to understand what I've done to make sure it's a good solution. <br><br></td></tr></table><br>
<a name="262251"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Mustang</td><td align="right"><font class=tiny>(Posted 2003)</font>&nbsp;<a href="#14">[#14]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> but I don't really understand the math behind what I did. <br></div><br><br>:) <br><br></td></tr></table><br>
<a name="bottom"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td align="right"><a href="http://monkeycoder.co.nz" target="_blank"><img src="/img/monkey2.svg" ></a> <a href="https://github.com/blitz-research" target="_blank"><img src="/img/github.svg" ></a> <a href="https://discord.gg/qJccbSp" target="_blank"><img src="/img/discord.svg" ></a></td></tr></table><br></div><br><table width="100%"><tr><td></body></html lang="en">
