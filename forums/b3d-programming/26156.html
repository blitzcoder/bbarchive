<!DOCTYPE html><html lang="en" ><head ><title >Should I 'normalize' my normals?</title><meta name='viewport' content='width=device-width, initial-scale=0.66'><meta name='description' content='language:basic, target:desktop, category:game development'><link rel="styleSheet" href="../skins/granite/style.css" type="text/css"><style type="text/css">div.bbcode {padding: 8px;background: #E5E5E5;color: #000000;border: 1px dashed #B4B4BE;}</style></head><body ><table width=100% cellspacing=0 cellpadding=0><tr ><td class="menubarleft"></td><td class="menubar"><table cellspacing="0" cellpadding="0"><tr ><td >&nbsp;</td><td class="menuitemleft"></td><td class="menuitem"><a href="/" class="menuitem">News</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/forums.php" class="menuitem">Forums</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/codearcs.php" class="menuitem">Code</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/logs.php" class="menuitem">Logs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/gallery.php" class="menuitem">Gallery</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/sdkspecs.php" class="menuitem">Specs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/search.php" class="menuitem">Search</a></td><td class="menuitemright"></td></tr></table></td><td class="menubarright"></td></tr></table><div class="main"><h1 >Should I 'normalize' my normals?</h1><a href="forums.php" >Blitz3D Forums</a>/<a href="topics.php?forum=82" >Blitz3D Programming</a>/<a href="#bottom" >Should I 'normalize' my normals?</a><br><br>
<a name="272045"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >John Pickford</td><td align="right"><font class=tiny>(Posted 2003)</font>&nbsp;<a href="#1">[#1]</a></td></tr></table></td></tr><tr ><td class="posttext"> I'm building a landscape engine and calculating the vertex normals myself.    <br><br>Do I actually NEED to 'normalize' the normals (set them to a length of one)?     <br><br>It seems like the correct thing to do but as far as I can tell it makes no difference visually.   If I can safely leave out this step I can lose a SQR and 3 divides.<br><br>Will this store up problems or fail on some cards? <br><br></td></tr></table><br>
<a name="272085"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Floyd</td><td align="right"><font class=tiny>(Posted 2003)</font>&nbsp;<a href="#2">[#2]</a></td></tr></table></td></tr><tr ><td class="posttext"> I think it doesn't matter for graphics.<br><br>Does Blitz3D use normals for anything other than lighting?<br><br>UpdateNormals originally did not normalize. I once reported an apparently<br>unrelated bug in UpdateNormals. Mark fixed this, and also changed UpdateNormals <br>so it does normalize normals.<br><br>So maybe it is important. <br><br></td></tr></table><br>
<a name="272100"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >sswift</td><td align="right"><font class=tiny>(Posted 2003)</font>&nbsp;<a href="#3">[#3]</a></td></tr></table></td></tr><tr ><td class="posttext"> Well here's a test for you.  Multiply each component of the normals by 100.  If you don't see anty visual difference then you don't need to normalize them.  Presumably the 3d card or Blitz is doing it.  But I suspect that they do not automatically normalize them for you.  And as far as I know, surface normals need to have a length of 1 to properly calculate lighting via the dot product. <br><br></td></tr></table><br>
<a name="272112"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >John Pickford</td><td align="right"><font class=tiny>(Posted 2003)</font>&nbsp;<a href="#4">[#4]</a></td></tr></table></td></tr><tr ><td class="posttext"> Tried multiplying by 100.   Can't see a difference.<br><br>I think I'll keep the normalization in there for now,  just in case I run into a problem.   No point in optimising it out unless I hit a speed problem. <br><br></td></tr></table><br>
<a name="272228"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rob</td><td align="right"><font class=tiny>(Posted 2003)</font>&nbsp;<a href="#5">[#5]</a></td></tr></table></td></tr><tr ><td class="posttext"> Forgive me for being thick, but whats the formula for getting the normal of a vert pointing straight up? I need this to calculate the normals for my water meshes. Which verts only ever move up or down... <br><br></td></tr></table><br>
<a name="272247"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Floyd</td><td align="right"><font class=tiny>(Posted 2003)</font>&nbsp;<a href="#6">[#6]</a></td></tr></table></td></tr><tr ><td class="posttext"> This should probably be done by computing the normal to the mathematical surface being used.<br><br>I imagine you have y = SomeFunction(x,z), involving Sin and/or Cos.<br>The relevant concept here is the Gradient. You need a little bit of calculus for this, but not much.<br><br>One 'gotcha' is that Blitz Sin and Cos use degrees rather than radians.<br>A calculus book will tell you that the derivative of Sin is Cos.<br>But in Blitz the derivative of Sin is (Pi/180)*Cos.<br><br>If you don't know enough math for this then just post the details of SomeFunction().<br>I'll tell you the Gradient. <br><br></td></tr></table><br>
<a name="272252"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rob</td><td align="right"><font class=tiny>(Posted 2003)</font>&nbsp;<a href="#7">[#7]</a></td></tr></table></td></tr><tr ><td class="posttext"> All I have is an array of verts that can be any height at any one time, depending on the cos and sin I use to create the wave pattern of the water... I ignore x and z positions totally, although these would be easy enough to store in a lookup table, since x and z never change in realtime. <br><br></td></tr></table><br>
<a name="272258"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Floyd</td><td align="right"><font class=tiny>(Posted 2003)</font>&nbsp;<a href="#8">[#8]</a></td></tr></table></td></tr><tr ><td class="posttext"> I know x,z are in there somewhere, although they may not appear explicitly.<br><br>Without knowing the details I can't be more specific. <br><br></td></tr></table><br>
<a name="272259"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >simonh</td><td align="right"><font class=tiny>(Posted 2003)</font>&nbsp;<a href="#9">[#9]</a></td></tr></table></td></tr><tr ><td class="posttext"> You need to calculate the cross product. There's some information about it here: <a href="http://www.geocities.com/SiliconValley/2151/math3d.html" target="_blank">http://www.geocities.com/SiliconValley/2151/math3d.html</a><br><br>Or you might want to look at my code archive entry, which calculates a normal for a triangle:<br><a href="http://www.blitzbasic.com/codearcs/codearcs.php?code=466" target="_blank">http://www.blitzbasic.com/codearcs/codearcs.php?code=466</a> <br><br></td></tr></table><br>
<a name="272265"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Floyd</td><td align="right"><font class=tiny>(Posted 2003)</font>&nbsp;<a href="#10">[#10]</a></td></tr></table></td></tr><tr ><td class="posttext"> That is appropriate for meshes in general.<br><br>But if you know the underlying mathematical surface you can calculate<br>normals much more accurately and more quickly.<br><br>It's also simpler, once you get past the hurdle of writing down an equation. <br><br></td></tr></table><br>
<a name="272288"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >sswift</td><td align="right"><font class=tiny>(Posted 2003)</font>&nbsp;<a href="#11">[#11]</a></td></tr></table></td></tr><tr ><td class="posttext"> The normal for a vertex pointing straight up is 0,1,0. <br><br></td></tr></table><br>
<a name="272333"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rob</td><td align="right"><font class=tiny>(Posted 2003)</font>&nbsp;<a href="#12">[#12]</a></td></tr></table></td></tr><tr ><td class="posttext"> <pre class=code>
	s=GetSurface(water,1)
	For i=0 To CountVertices(s)-1
		Vertex(i)\y#=Sin(freq+Vertex(i)\x#*500+Vertex(i)\z#*300)*1.2
		VertexCoords s,i,Vertex(i)\x#,-Vertex(i)\y#,Vertex(i)\z#
	Next
</pre><br><br>This is my water preturb routine.... you can see the underlying coords. A vert normal of 1 ruins the effect. Updatenormals looks perfect though. <br><br></td></tr></table><br>
<a name="272337"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >sswift</td><td align="right"><font class=tiny>(Posted 2003)</font>&nbsp;<a href="#13">[#13]</a></td></tr></table></td></tr><tr ><td class="posttext"> Can't look perfect because it's mathematically impossible to properly represent the light falling on a surface with vertex normals. :-)<br><br>Imagine if you will a triangular-wave shaped terrain.  Each vertex is at a point where the light should have a sharp transition from dark to light.  So do you set it's normal to point away from the light, or towards it?  Mathematically, updatenormals would do neither.  It would set them all to point straight up, which obviously would look bad. <br><br></td></tr></table><br>
<a name="272409"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Floyd</td><td align="right"><font class=tiny>(Posted 2003)</font>&nbsp;<a href="#14">[#14]</a></td></tr></table></td></tr><tr ><td class="posttext"> Rob,<br><br>Here's the mathematical version of normals. Your water lies on this surface:<br><br>y = -1.2 * Sin( freq + x*500 + z*300 )<br><br>The first step is to reformulate this as<br><br>y + 1.2 * Sin( freq + x*500 + z*300 ) = 0<br><br>We now have the form F(x,y,z)=0.<br><br>The gradient vector, which is perpendicular to this surface, is<br><br>( dF/dx, dF/dy, dF/dz )<br><br>where e.g. dF/dx denotes the partial derivative of F with respect to x.<br><br>NOTE: d is not the correct symbol for partial derivative.<br>The proper one looks like a flipped over 6, but we don't have that on our keyboards.<br><br>Finally, we need partial derivatives, e.g.<br><br>dF/dx = 1.2 * (Pi/180) * 500 * Cos( freq + 500 * Vertex(i)\x# + 300 * Vertex(i)\z# )<br><br><br>Here is your vertex code, updated to calculate normals:<br><pre class=code>
s=GetSurface(water,1)

A# = 1.2 * (Pi/180) * 500
B# = 1.2 * (Pi/180) * 300

For i=0 To CountVertices(s)-1

	u# = freq + 500 * Vertex(i)\x# + 300 * Vertex(i)\z#

	Vertex(i)\y# = 1.2 * Sin(u)
	VertexCoords s,i, Vertex(i)\x#, -Vertex(i)\y#, Vertex(i)\z#
	
	; Now the gradient at point (x,y,z)
	
	C# = Cos(u)
	
	nx# = A * C
	ny# = 1
	nz# = B * C
	
	; (nx,ny,nz) is the gradient, which is perpendicular to the surface.
	; It has length greater than 1, but that is probably harmless.
	; If there is any problem you can scale to length 1 before doing:
	
	VertexNormal s, i, nx, ny, nz
	
Next

</pre><br>This hasn't been tested, but it should work.<br><br>You can see how much simpler the gradient calculation is than doing vector cross products.<br>The only hard part is that you need to know some elementary calculus. <br><br></td></tr></table><br>
<a name="272422"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Michael Reitzenstein</td><td align="right"><font class=tiny>(Posted 2003)</font>&nbsp;<a href="#15">[#15]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> The proper one looks like a flipped over 6, but we don't have that on our keyboards. <br></div><br>I think that sign (delta or whatever it is?) is only for 'change' rather than derivative itself. All the textbooks I have used use it for change in (eg for the approximation formula [delta]y = dy/dx * [delta]x.) and not in the actual derivitive. Or maybe my textbooks suck (which is actually highly likely!). <br><br></td></tr></table><br>
<a name="272445"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rob</td><td align="right"><font class=tiny>(Posted 2003)</font>&nbsp;<a href="#16">[#16]</a></td></tr></table></td></tr><tr ><td class="posttext"> Thankyou Floyd, it's beginning to make sense- much appreciated!<br><br>Although your fixed code makes the cubic mapped water go haywire :) <br><br></td></tr></table><br>
<a name="272471"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Floyd</td><td align="right"><font class=tiny>(Posted 2003)</font>&nbsp;<a href="#17">[#17]</a></td></tr></table></td></tr><tr ><td class="posttext"> Rob,<br><br>Sorry about the haywireness. Offhand I don't see where the problem might be.<br><br>You might try scaling nx,ny,nz to have length 1.<br>I don't know if that matters here. It definitely would matter if you were creating a bump map.<br>The method used for encoding normals into the texture assumes length 1.<br><br><br>Michael,<br><br>That 'rounded d' symbol is shown <a href="http://hyperphysics.phy-astr.gsu.edu/hbase/deriv.html" target="_blank">here</a> in The Partial Derivatives section.<br><br>Notice that equations are actually rendered as images.<br>This is because ordinary fonts don't have the necessary symbols. <br><br></td></tr></table><br>
<a name="bottom"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td align="right"><a href="http://monkeycoder.co.nz" target="_blank"><img src="/img/monkey2.svg" ></a> <a href="https://github.com/blitz-research" target="_blank"><img src="/img/github.svg" ></a> <a href="https://discord.gg/qJccbSp" target="_blank"><img src="/img/discord.svg" ></a></td></tr></table><br></div><br><table width="100%"><tr><td></body></html lang="en">
