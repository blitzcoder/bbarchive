<!DOCTYPE html><html lang="en" ><head ><title >FastPointer + Dynamic Mesh = World Explodes</title><meta name='viewport' content='width=device-width, initial-scale=0.66'><meta name='description' content='language:basic, target:desktop, category:game development'><link rel="styleSheet" href="../skins/granite/style.css" type="text/css"><style type="text/css">div.bbcode {padding: 8px;background: #E5E5E5;color: #000000;border: 1px dashed #B4B4BE;}</style></head><body ><table width=100% cellspacing=0 cellpadding=0><tr ><td class="menubarleft"></td><td class="menubar"><table cellspacing="0" cellpadding="0"><tr ><td >&nbsp;</td><td class="menuitemleft"></td><td class="menuitem"><a href="/" class="menuitem">News</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/forums.php" class="menuitem">Forums</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/codearcs.php" class="menuitem">Code</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/logs.php" class="menuitem">Logs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/gallery.php" class="menuitem">Gallery</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/sdkspecs.php" class="menuitem">Specs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/search.php" class="menuitem">Search</a></td><td class="menuitemright"></td></tr></table></td><td class="menubarright"></td></tr></table><div class="main"><h1 >FastPointer + Dynamic Mesh = World Explodes</h1><a href="forums.php" >Blitz3D Forums</a>/<a href="topics.php?forum=82" >Blitz3D Programming</a>/<a href="#bottom" >FastPointer + Dynamic Mesh = World Explodes</a><br><br>
<a name="1193249"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >ClayPigeon</td><td align="right"><font class=tiny>(Posted 2013)</font>&nbsp;<a href="#1">[#1]</a></td></tr></table></td></tr><tr ><td class="posttext"> I'm working on a Minecraftish game (actually, it's nothing like Minecraft, I'm just giving you an idea of the visual style) and the cube-based world is constantly updating. It is divided into 16x16x16-block sections called "chunks". Each chunk is just a type with a bank and a "needsUpdated" flag. When the system is cycling through all the types, if the needsUpdated flag is true, it rebuilds the mesh for that chunk.<br><br>My problem is this: It takes too long to build one chunk mesh per frame. So I tried using FastPointer and put the chunk updating into a thread. It works fine for a few seconds running a 60 FPS, but then MAVs on a RenderWorld line. I'm sure this has to do with calling RenderWorld while the thread is in the middle of building the mesh. Does anyone have any ideas for alternate approaches for multi-threading with a mesh being modified in real time? Thanks! <br><br></td></tr></table><br>
<a name="1193250"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Yasha</td><td align="right"><font class=tiny>(Posted 2013)</font>&nbsp;<a href="#2">[#2]</a></td></tr></table></td></tr><tr ><td class="posttext"> All of your graphics resources need to be finalised and their threads paused while RenderWorld runs, yes. Rendering was not designed with threading in mind (there are almost no engines even for modern AAA games where it is, not least because shaders make it irrelevant), and there is <i>no</i> way to make it work while a mesh is being updated in another thread. So there's that to bear in mind.<br><br>First thing: are you just building one chunk at a time, and building a chunk doesn't fit into a single frame, or are you building many chunks and farming them out to different threads so that they can  be built in parallel? (I'm not sure I see how threading actually helps the first scenario, since if there's only one task, nothing is getting parallelized..?)<br><br>Second: are chunks being updated for immediate rendering, or are they being handled in the background while out of sight? In other words do the requirements of your rendering system mean that a chunk needs to be updated within the span of a single frame? (again, this might mean that there's less to usefully parallelize.)<br><br>The most obvious thing that comes to mind for updating a mesh "safely" is to copy its vertex data into a bank, modify it directly in the bank, and copy it back to the mesh on the main thread when it's marked as complete using a block-copy operation (e.g. memcpy). This should be easy to work out if you're familiar with FastPointer, although it requires you to know the internal entity structure layout (there are some tables floating around somewhere... otherwise, give me a minute and I might be able to come up with something). This obviously is limited to things you can do by simply adjusting the properties of existing vertices (potentially do the same for tris) rather than creating anything new, which needs the proper creation functions.<br><br>One other problem you face with threading in B3D is that there is <i>no</i> safe way for threads to communicate. Best I can think of is to have your application open a port to itself and use network commands or something like that. Writing to global variables for another thread to read is <i>not safe</i>, as the whole point is that the threads can potentially access the same memory mid-write. <br><br></td></tr></table><br>
<a name="1193252"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >ClayPigeon</td><td align="right"><font class=tiny>(Posted 2013)</font>&nbsp;<a href="#3">[#3]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> are you just building one chunk at a time, and building a chunk doesn't fit into a single frame, or are you building many chunks and farming them out to different threads so that they can be built in parallel? <br></div><br><br>I'm only updating one chunk per frame since I can't even update one in a single frame. It's the only way to keep a "reasonable" framerate.<br><br><div class="quote"> are chunks being updated for immediate rendering, or are they being handled in the background while out of sight? <br></div><br><br>In a perfect world, the chunks need to update as soon as possible; the changes need to be visible instantaneously. Obviously, that's not going to happen. Would building the updated mesh into a separate model and hiding it work? As in, would using HideEntity on a mesh fix the MAV if it was still being processed when a RenderWorld came along?<br><br><div class="quote"> copy its vertex data into a bank, modify it directly in the bank, and copy it back to the mesh <br></div><br><br>That wouldn't work because I'm not modifying the vertices on an update, I'm completely reconstructing the mesh. Anyway, I don't think that would speed anything up because I think the overhead is coming from the act of creating the vertices themselves, because there are so many. <br><br></td></tr></table><br>
<a name="1193253"></a>

<a name="1193254"></a>

<a name="1193255"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Yasha</td><td align="right"><font class=tiny>(Posted 2013)</font>&nbsp;<a href="#4">[#4]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> Would building the updated mesh into a separate model and hiding it work? As in, would using HideEntity on a mesh fix the MAV if it was still being processed when a RenderWorld came along? <br></div><br><br>I was thinking about suggesting that, but your Hide and Show commands would need to be synchronised with the rendering thread, or you'd have the same problem (if the Hide command is issued after the point during RenderWorld where the render list has been built, it will do nothing). Certainly worth a try if you can work out a way to do that. However, once you're syncing it with the main thread, you're effectively admitting that it won't be done in the same frame, and that the purpose of using a child thread is to skip a render cycle (or else... you'd be doing it on the main thread anyway).<br><br><br><div class="quote"> That wouldn't work because I'm not modifying the vertices on an update, I'm completely reconstructing the mesh. Anyway, I don't think that would speed anything up because I think the overhead is coming from the act of creating the vertices themselves, because there are so many. <br></div><br><br>If this is because the number of verts can change, consider the option of creating every mesh with the maximum suitable number of vertices and simply crushing down the "unused" ones into a zero-by-zero point in one corner. Reusing any dynamically-allocated object is usually better than recreating it (when you create a new mesh and add vertices to it, there are a lot of vector.push_back operations that need to happen as the vertex buffer extends and the memory gets reallocated, among other things: this won't happen with a fixed-length vertex buffer).<br><br><br>Anyway if you do do the above, and it's not fast enough and you want to try the bank method, the pointer to the vertex buffer is found by peeking surface+28. Vertices start at 64-byte intervals and have the structure x#, y#, z#, nx#, ny#, nz#, argb%, u0#, v0#, u1#, v1# (the rest of the space is for bone data). To copy it to a bank you need to copy 64*number-of-verts; if you have a preallocated large vertex buffer you could also just copy the first few you want to use and modify and set the rest to 0 (by first memcpying from a second bank preloaded with all vertices crushed, and then memcpying the first <i>N</i> verts from the modified bank). <br><br></td></tr></table><br>
<a name="1193264"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >ClayPigeon</td><td align="right"><font class=tiny>(Posted 2013)</font>&nbsp;<a href="#5">[#5]</a></td></tr></table></td></tr><tr ><td class="posttext"> Well, I changed it to the system you suggested (put all the verts at 0,0,0 until needed and only modify coords) and the MAVs went away, but now there's all kinds of crazy artifacts, like seeing the triangles spazz around before they get placed, and sometimes things have holes in them. Also, I realized that the {0,0,0} vertices method defeats my LOD; all faces are visible as opposed to only the surface ones like I had it set up. <br><br></td></tr></table><br>
<a name="bottom"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td align="right"><a href="http://monkeycoder.co.nz" target="_blank"><img src="/img/monkey2.svg" ></a> <a href="https://github.com/blitz-research" target="_blank"><img src="/img/github.svg" ></a> <a href="https://discord.gg/qJccbSp" target="_blank"><img src="/img/discord.svg" ></a></td></tr></table><br></div><br><table width="100%"><tr><td></body></html lang="en">
