<!DOCTYPE html><html lang="en" ><head ><title >miniB3D - part 2</title><meta name='viewport' content='width=device-width, initial-scale=0.66'><meta name='description' content='language:basic, target:desktop, category:game development'><link rel="styleSheet" href="../skins/granite/style.css" type="text/css"><style type="text/css">div.bbcode {padding: 8px;background: #E5E5E5;color: #000000;border: 1px dashed #B4B4BE;}</style></head><body ><table width=100% cellspacing=0 cellpadding=0><tr ><td class="menubarleft"></td><td class="menubar"><table cellspacing="0" cellpadding="0"><tr ><td >&nbsp;</td><td class="menuitemleft"></td><td class="menuitem"><a href="/" class="menuitem">News</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/forums.php" class="menuitem">Forums</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/codearcs.php" class="menuitem">Code</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/logs.php" class="menuitem">Logs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/gallery.php" class="menuitem">Gallery</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/sdkspecs.php" class="menuitem">Specs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/search.php" class="menuitem">Search</a></td><td class="menuitemright"></td></tr></table></td><td class="menubarright"></td></tr></table><div class="main"><h1 >miniB3D - part 2</h1><a href="forums.php" >Monkey Forums</a>/<a href="topics.php?forum=524" >User Modules</a>/<a href="#bottom" >miniB3D - part 2</a><br><br>
<a name="2028461"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >DruggedBunny</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#1">[#1]</a></td></tr></table></td></tr><tr ><td class="posttext"> Continued from <a href="/posts.php?topic=2212" target="_blank">here</a>.<br><br>By AdamRedwoods:<br><div class="quote"> <br>minib3d+monkey<br><a href="https://github.com/adamredwoods/minib3d-monkey" target="_blank">https://github.com/adamredwoods/minib3d-monkey</a><br> <br></div><br><br>Last post from previous thread by <i>visionastral</i>:<br><br><div class="quote"> <br>I noticed something weird:<br>In your examples, this line is making the app crash 50% of the time:<br><br>txt.SetText(fps+" fps ~nhow are you",0,0)<br><br><br>I have noticed it's because of the "~n" new line character. If I delete it, then it never crashes.<br>That's very weird, specially because it doesn't crash every time, but only 50% of the times or so...<br>Perhaps it has something to do with the fps counter, I don't know.<br><br>- edit: By the way, I'm compiling for GLFW when this happens -  <br></div> <br><br></td></tr></table><br>
<a name="2031640"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >AdamRedwoods</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#2">[#2]</a></td></tr></table></td></tr><tr ><td class="posttext"> minib3d+monkey<br><a href="https://github.com/adamredwoods/minib3d-monkey" target="_blank">https://github.com/adamredwoods/minib3d-monkey</a><br><br>branch: v0.20 requires most recent Monkey<br><br>big note:<br>- turn on config.h depth_buffer_bits = 32 (not needed in v0.20)<br>- tested on glfw, android, macos, ios<br><br>Works!<br>- normals work<br>- textures, mipmaps work<br>- android, works<br>- vbos and non-vbo fallback works<br>- sprites<br>- batch sprites<br>- context handling for mobile devices<br>- pick (optimized)<br>- collisions<br>- binary load for b3d files (base64)<br>- animation, bone &amp; vertex<br>- Load OBJ<br>- animated textures<br><br><br>To Do:<br>- XNA target<br>- WebGL target<br>- shaders<br>- MDD/3DS loaders<br><br><img src="http://i295.photobucket.com/albums/mm144/adamredwoods/minib3d_example_zombie100.jpg"><br><img src="http://i295.photobucket.com/albums/mm144/adamredwoods/P1040945b.jpg"> <br><br></td></tr></table><br>
<a name="2029347"></a>

<a name="2029348"></a>

<a name="2029346"></a>

<a name="2029345"></a>

<a name="2028492"></a>

<a name="2028490"></a>

<a name="2028487"></a>

<a name="2028488"></a>

<a name="2028489"></a>

<a name="2028491"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >AdamRedwoods</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#3">[#3]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> I noticed something weird:<br>In your examples, this line is making the app crash 50% of the time:<br><br>txt.SetText(fps+" fps ~nhow are you",0,0)<br><br><br>I have noticed it's because of the "~n" new line character. If I delete it, then it never crashes.<br>That's very weird, specially because it doesn't crash every time, but only 50% of the times or so...<br>Perhaps it has something to do with the fps counter, I don't know.<br><br>- edit: By the way, I'm compiling for GLFW when this happens -  <br></div><br><br>Ok, I will check it. I know there were some bugs with that in earlier versions, but I thought the latest version fixed it. <br><br></td></tr></table><br>
<a name="2028799"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >visionastral</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#4">[#4]</a></td></tr></table></td></tr><tr ><td class="posttext"> Bug found in TFormPoint function (tentity.monkey)<br><br>TFormPoint is using FastRotateScale to perform matrix operations, but it seems FastRotateScale is not working as expected because I had to disable it and enable the commented out functions Scale,RotateRoll,Pitch... in order to make it work.<br>Something is really wrong with FastRotateScale (matrix.monkey) and will make bugs if it's used anywhere else. (as I suppose is the case)<br><br><br>By the way, in the SetText function, you are using "cam" as the camera the text object is being aligned to. However, this variable is not defined anywhere in MiniB3D except in the examples, throwing a memory handle error when compiling if your app hasn't created this variable as a global and as a camera.<br><br><br>The FastRotateScale bug was driving me really crazy for 3 days!<br>But now I'm making some shadow mapping on monkey with miniB3D! :D<br><br>I just love the Blitz community! ^_^<br><br><br><br>-EDIT-<br><br>Another little bug:<br>In the BackBufferToTex method (ttexture.monkey) the OpenGL bit format is incorrect. It's not GL_RGBA8888 but GL_RGB: (if you use GL_RGBA it will not work on Android, as the color buffer does not have alpha information.)<br><br><pre class=code>glCopyTexImage2D(GL_TEXTURE_2D,mipmap_no,GL_RGB,x,TRender.height-y-height,width,height,0)</pre> <br><br></td></tr></table><br>
<a name="2028771"></a>

<a name="2028778"></a>

<a name="2028779"></a>

<a name="2028780"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >visionastral</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#5">[#5]</a></td></tr></table></td></tr><tr ><td class="posttext"> Mmmm... That's weird but when I compile for android, any change I make to a texture isn't updated on screen.<br>That's not happening when I compile for GLFW.<br><br>I mean, I'm rendering the scene with RenderWorld, then I copy the render to a texture with BackBufferToTex. At this point, the texture is already updated on GLFW, but on Android, the texture is still in the same state as when it was created (full black) and doesn't want to be updated.<br>I have tried using TTexture.BindAnimTexture(texture,flags) but the texture goes wrong in both targets if I make this (becomes full black) and on android it drops framerate from 60fps to 6 !<br><br>Any help will be very welcome!<br><br>-EDIT: -<br><br>Ok, if I use BindAnimTextures, it is reloading the texture from RAM to the texture memory, that's why it's slow. But the fact is BackBufferToTex is supposed to copy the color buffer from opengl (the output default buffer) to a texture INSIDE the graphic memory, thus making it very fast.<br>And that's what it makes in my PC when I compile to GLFW, but it's not happening on Android...<br><br>Is this a limitation of OpenGLes 1.1 on Android??<br>If this is the case, I will need to switch to GLES2.0 quickly.... <br><br></td></tr></table><br>
<a name="2028776"></a>

<a name="2028777"></a>

<a name="2028800"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >visionastral</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#6">[#6]</a></td></tr></table></td></tr><tr ><td class="posttext"> -THIS HAS BEEN SOLVED CHANGING THE BIT FORMAT OF glCopyTexImage2D TO GL_RGB instead of GL_RGBA -<br><br>After googling a lot, I deduced some GLES stuff about Android:<br>It seems Android only supports OpenGLes 1.0 and OpenGLes 2.0 (Android v2.2), so the problem is OpenGLes 1.0 is NOT OpenGLes 1.1, and one of the big differences was the addition of Frame Buffer Objects for doing exactly what I'm doing.<br>Sooo... I will need to switch to OpenGL 2.0 no matter what.<br><br>Adam, you seem to plan to "officially" support OpenGL 2.0.<br>I'm not really in a hurry to switch, since I can work on GLES11 on my PC and I have lots of stuff to do (starting with my shadow mapping module) but I just want to know the place GLES20 has in your todo list for MiniB3D. (or if you don't plan to make it any time soon.)<br><br>(I really don't mean to rush anyone and don't expect others to program anything specially for me. It's just to know if I will have to do GLES2.0 support by myself (given the fact I'm a total noob on OpenGL! :p )) <br><br></td></tr></table><br>
<a name="2028781"></a>

<a name="2028782"></a>

<a name="2028790"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >AdamRedwoods</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#7">[#7]</a></td></tr></table></td></tr><tr ><td class="posttext"> Re:TFormPoint<br><br>Sorry about that, yeah, there are residual bugs left over from attempts to optimize the matrices. Matrix.FastRotateScale() overwrites itself and does not take into account the prior matrix (which is why its faster). I use it only on the local matrix, not on global matrices.<br><br>TFormPoint() uses global information by looping over the entity hierarchy. This isn't needed as I am storing global matrices and global scale. This routine may be faster:<br><br>minib3d/tentity/TFormPoint<br><pre class=code>
	Function TFormPoint(x#,y#,z#,src_ent:TEntity,dest_ent:TEntity)
		
		'Local mat:Matrix=global_mat.Copy() '***global***
		temp_mat.Overwrite(global_mat)
	
		If src_ent&lt;&gt;Null

			temp_mat.Overwrite(src_ent.mat)
			temp_mat.Translate(x,y,-z)
			
			x=temp_mat.grid[3][0]
			y=temp_mat.grid[3][1]
			z=-temp_mat.grid[3][2]
		
		Endif

		If dest_ent&lt;&gt;Null
				
			temp_mat = dest_ent.mat.Inverse()
			temp_mat.Scale(1.0/(dest_ent.gsx*dest_ent.gsx),
			1.0/(dest_ent.gsy*dest_ent.gsy),
			1.0/(dest_ent.gsz*dest_ent.gsz))

			
			temp_mat.Translate(x,y,-z)
			
			x=temp_mat.grid[3][0]
			y=temp_mat.grid[3][1]
			z=-temp_mat.grid[3][2]
			
		Endif
		
		tformed_x=x
		tformed_y=y
		tformed_z=z
		
	End 
</pre> <br><br></td></tr></table><br>
<a name="2028783"></a>

<a name="2028784"></a>

<a name="2028785"></a>

<a name="2028786"></a>

<a name="2028787"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >AdamRedwoods</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#8">[#8]</a></td></tr></table></td></tr><tr ><td class="posttext"> Re:SetText<br><div class="quote"> By the way, in the SetText function, you are using "cam" as the camera the text object is being aligned to. <br></div><br>Yes, you need to assign the camera being used to TText or it will not work, since I need to do a camera Unproject. (will probably fix this so it's not needed in the next version).<br><br>Re: BackBufferToTex<br>Ok, thanks for finding this bug! <br><br></td></tr></table><br>
<a name="2028789"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >AdamRedwoods</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#9">[#9]</a></td></tr></table></td></tr><tr ><td class="posttext"> Re:BackBufferToTex<br><br>I threw this in there with no testing :D.<br>Ok, so GLES1.1 is not guaranteed on all Android devices, so there will be limitations. I'll test it on my end.<br><a href="http://stackoverflow.com/questions/1781371/android-glcopyteximage2d-any-success" target="_blank">http://stackoverflow.com/questions/1781371/android-glcopyteximage2d-any-success</a><br><br><br><br>Re: minib3d+monkey GLES2.0<br>I don't want to get ahead of myself, but this is in progress and moving along! This will be a big update with many changes (under the hood, API stays the same). <br><br></td></tr></table><br>
<a name="2028788"></a>

<a name="2028802"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >visionastral</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#10">[#10]</a></td></tr></table></td></tr><tr ><td class="posttext"> OOOK! I found the issue!<br>I changed the bit format of glCopyTexImage2D to GL_RGBA instead of GL_RGB !<br>Now since the color buffer does not store alpha information, it raises an error on android and doesn't work (raises an internal error that doesn't stop your app, that is).<br><br>I have fixed the earlier posts to simplify the life of the people who search the forums for answers (like I do a lot).<br><br>Now shadow mapping is working at 60fps on android! :D<br>Still a very early function, but I plan to make it a stand alone module as easy to use as "set shadow caster" and "set shadow receiver".<br><br>About GLES2.0: I'm really really REALLY happy you're working on it! Pixel shaders are one of those things I wanted to make a loong ago but never found the courage to learn visual c + openGL! (I even studied the pixel shader programs to know how to do stuff like parallax mapping and the like)<br>Having Blitz3D with pixel shaders has been my geek's wet dream for years!<br><br>Now, don't rush! Take your time and do it right! ;) <br><br></td></tr></table><br>
<a name="2028816"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >visionastral</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#11">[#11]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> This routine may be faster <br></div><br>It is! Thank you very much! (and it works ;) )<br>By the way, if there is any other way to make this calculations faster it would be very welcome, since the shadow mapping technique relies massively in this matrix transformations to do the trick.<br>It's not slow now, but it can slow down pretty quickly with shadows depending onto how much poligons the shadow is being projected.<br>(obviously, I'm talking about android now. In GLFW you have light speed those days!) <br><br></td></tr></table><br>
<a name="2028820"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >AdamRedwoods</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#12">[#12]</a></td></tr></table></td></tr><tr ><td class="posttext"> GLES 2.0 in progress: 100 zombies with per-pixel lighting<br>it's a work in progress seeing how the frame rate is low.<br><img src="http://i295.photobucket.com/albums/mm144/adamredwoods/100zombies_gles20.jpg"> <br><br></td></tr></table><br>
<a name="2028827"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >bruZard</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#13">[#13]</a></td></tr></table></td></tr><tr ><td class="posttext"> GO! GO! GO! :D <br><br></td></tr></table><br>
<a name="2028883"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >visionastral</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#14">[#14]</a></td></tr></table></td></tr><tr ><td class="posttext"> per-pixel lighting !<br>THAT's what I need! :D<br><br>(well, I will be needing everything cool you'll show anyway :P ) <br><br></td></tr></table><br>
<a name="2028882"></a>

<a name="2029145"></a>

<a name="2029146"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >visionastral</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#15">[#15]</a></td></tr></table></td></tr><tr ><td class="posttext"> Another bug found!<br><br>PC and MAC platforms are veeery permisive with parameters in OpenGL, but android isn't.<br>The fog rgb information must be given as an array of 4 instead of 3, otherwise, it will crash anytime you want to activate the fog.<br><br>change line 523 in "tcamera.monkey":<br><pre class=code>Local rgb#[]=[fog_r,fog_g,fog_b,0]</pre><br><br>This will fix it.<br><br>I suppose other errors like this one are to be expected, so we will have to watch for them! <br><br></td></tr></table><br>
<a name="2029152"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >AdamRedwoods</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#16">[#16]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> I suppose other errors like this one are to be expected, so we will have to watch for them!  <br></div><br>yes, thank you!<br><br>Do you know if "0" fixes it or should it be "1.0", as this is fog I'm not sure what it's alpha should be, or if it's ignored. <br><br></td></tr></table><br>
<a name="2029156"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >visionastral</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#17">[#17]</a></td></tr></table></td></tr><tr ><td class="posttext"> I was asking myself the same question... xD<br>I have tried it with 0 and worked ok, but since I'm not really doing fog in a regular render way, I can't really say.<br>In fact, I was using the fog as a way to enlighten shadow mapping internal renders, and it's working (making parametric transparent shadows) so it should be ok. Anyway, putting a 1.0 instead of a 0 should be wiser... just in case other phone's opengl don't like a zero there (or iphone's?).<br><br>By the way, I was thinking you could include my shadow mapping engine into MiniB3D once it has been finished. It's pretty straigth forward and should work in GLES20 without any modification, since the shadows are made of poligons with transparent maps on them.<br>You use it simply calling "New ShadowMappingCaster(cube)" for a cube to cast shadows, and define receptors and light emitters the same way. The shadows are update and rendered in the same function just before RenderWorld.<br>I'm optimizing as much as I can without entering too much inside the MiniB3D internal work, but I think it could be much more fast if we simply put it into the render pipeline with straight opengl commands.<br>Right now it's extremely fast in PC, but I'm much more concerned by android devices.<br>I'm planning to do a "fake" shadow option for alowing objects to cast circular shadows to the ground under them. It should be much better suited for small devices than full projected shadows and you could swap them just switching a boolean. <br><br></td></tr></table><br>
<a name="2029155"></a>

<a name="2029164"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >visionastral</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#18">[#18]</a></td></tr></table></td></tr><tr ><td class="posttext"> -edit: I found the answer, nevermind- <br><br></td></tr></table><br>
<a name="2029159"></a>

<a name="2029166"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >AdamRedwoods</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#19">[#19]</a></td></tr></table></td></tr><tr ><td class="posttext"> Re: shadows<br>yes, great contribution. are you creating shadow volumes or shadow maps?<br><br>re: adding to minib3d<br>yes, but i need to present v0.2 (opengles20) which is a redesigned render system, which allows additions like this. I need to create a new branch/fork on github for this, but i'm not sure how to do this?<br><br>i could do this early (it would be incomplete), to allow you to work with it.<br>i would just want to make sure people wouldn't expect it to be finalized.<br><br>It's pretty sweet, the underlying API is the same, but the opengl20 stuff is very flexible, allows for FrameBuffers and multiple shaders. <br><br></td></tr></table><br>
<a name="2029165"></a>

<a name="2029167"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >visionastral</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#20">[#20]</a></td></tr></table></td></tr><tr ><td class="posttext"> I'm making shadow maps, not volumes. (I will surely make an stencil shadow engine for gles20 later. It will be better suited for interiors) <br>The shadow maps are projected rendered shapes of the caster object mapped on poligons wich mimics the receivers surface. This is done individually for each emitter/caster/receiver and generates individual geometries parented to the receiver object. This means you don't have to update all the shadows at once but only those that had been changed (this will be done automatically). It's well suited for exterior lighting and for faking simplistic shadows under enemies ie.<br>However, interior results are somewhat poor compared with stencil buffer techniques because the individual shadow maps overlap each other and gives a weird sensation.<br>But with opengles 1.1 you can't do better for the price ;)<br>And stencil shadows are too much expensive in ressources for exterior lighting even on pc. <br><br></td></tr></table><br>
<a name="2029184"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >visionastral</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#21">[#21]</a></td></tr></table></td></tr><tr ><td class="posttext"> Another idea for gles20 is the shadow mapping technique used in ps3 and xbox: a global shadow map for each light with zbuffer. Then you have to filter wich pixels will be shadowed with a pixel shader, comparing the pixel's z position (in the light's matrix) with the zbuffer of the shadowmap.<br>The good thing with this technique is: it's fast and convenient, but the resolution of the shadowmap quickly becomes a problem since it will be projected and thus pixelate a lot. A good game to see this technique in action is devil may cry 4. <br><br></td></tr></table><br>
<a name="2029168"></a>

<a name="2029187"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >visionastral</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#22">[#22]</a></td></tr></table></td></tr><tr ><td class="posttext"> Adam, could it be done to use OpenGL to perform matrix operations for calculating the transformation of a given point/vector just like the TFormPoint and TFormVector functions?<br>I think it would greatly improve shadows performance in android, because right now I'm making the calculations at the CPU, and using GL it would be done by the GPU, wich seems much better suited for that stuff.<br>Excuse me but I'm a noob with OGL :P <br><br></td></tr></table><br>
<a name="2029341"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >AdamRedwoods</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#23">[#23]</a></td></tr></table></td></tr><tr ><td class="posttext"> re:opengl matrix math<br><br>you can offload math to the gfx chip, but some people would argue that transferring the data to the chip and back would be slow enough that it may be better to do it with the cpu. you'd have to do some speed tests. it definitely would work better in gles2.0. <br><br></td></tr></table><br>
<a name="2029344"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >AdamRedwoods</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#24">[#24]</a></td></tr></table></td></tr><tr ><td class="posttext"> ** UPDATE v0.20 **<br><br>I have now created a new alpha-stage branch <b>"minib3d.2.0"</b> which encapsulates all the driver specific routines. the API should be the same, but the underlying code is different.<br><br>Overall, this will allow targets to be made for almost every platform since only ONE file needs to be changed and updated for a target (for the most part). New targets need just extend TRender and fill in the appropriate methods. If anyone is up for an XNA/DirectX target, feel free.<br><br>Needs at least monkey56.<br><br>** OpenGLES2.0 and WebGL **<br>I haven't added that in yet, but it is working. I want to make a dramatic announcement for that, since it is a big deal, so I am working on some cool examples with shaders and all.<br><br>Plus, opengles2.0 will not work until Mark fixes a few errors with the webgl target, so it will require the LATEST monkey version. <br><br></td></tr></table><br>
<a name="2029343"></a>

<a name="2029342"></a>

<a name="2029349"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >visionastral</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#25">[#25]</a></td></tr></table></td></tr><tr ><td class="posttext"> opengles 2.0 currently works for android and glfw?<br>(I don't care of webgl right now :P ) <br><br></td></tr></table><br>
<a name="2029385"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >simonh</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#26">[#26]</a></td></tr></table></td></tr><tr ><td class="posttext"> Great work Adam, looking forward to having a play with this. <br><br></td></tr></table><br>
<a name="2029411"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Beaker</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#27">[#27]</a></td></tr></table></td></tr><tr ><td class="posttext"> Really looking forward to WebGL. Great stuff Adam. <br><br></td></tr></table><br>
<a name="2029416"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >bruZard</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#28">[#28]</a></td></tr></table></td></tr><tr ><td class="posttext"> you're my hero Adam! <br><br></td></tr></table><br>
<a name="2029553"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >AdamRedwoods</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#29">[#29]</a></td></tr></table></td></tr><tr ><td class="posttext"> 100 zombies. WebGL in firefox on the left, opengles11 on the right.<br>getting closer. rebuilding the fixed function is a pain!<br>Note the wrong light direction on the red ball.<br><br><img src="http://i295.photobucket.com/albums/mm144/adamredwoods/webgl_compare.png"> <br><br></td></tr></table><br>
<a name="2029552"></a>

<a name="2029556"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >visionastral</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#30">[#30]</a></td></tr></table></td></tr><tr ><td class="posttext"> note the per pixel lighting on the left ;)<br><br>You're doing an awesome work there Adam.<br>You're earning so much good karma with that you will eventually levitate in bliss and joy. (surrounded by red balls hating zombies) <br><br></td></tr></table><br>
<a name="2029554"></a>

<a name="2029555"></a>

<a name="2029607"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Sammy</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#31">[#31]</a></td></tr></table></td></tr><tr ><td class="posttext"> Well I dropped Monkey after I realised that a good 3D lib was not on the horizon, this has brought me back. Thank you Adam. <br><br></td></tr></table><br>
<a name="2030427"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >LeeTheGee1</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#32">[#32]</a></td></tr></table></td></tr><tr ><td class="posttext"> Hi Guy's<br><br>wow this is exciting for old Blitz3d user<br><br>getting an error though when compiling to android on the phone it say's Monkey runtime error:unable to parse '0-CM' as integer...C:/aaamonkeey/MonkeyPro56/modules/minib3d/trender.monkey<br><br>Donno why any ideas<br><br>lee <br><br></td></tr></table><br>
<a name="2030430"></a>

<a name="2030431"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >AdamRedwoods</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#33">[#33]</a></td></tr></table></td></tr><tr ><td class="posttext"> a bug! thanks.<br><br>change opengles11.monkey (trender.monkey-- old version)<br><pre class=code>

	Method GetVersion:Float()
		
		Local s:String[] = glGetString(GL_VERSION).Split(".")
		If s[0].Length() &gt; 2
			Local st:String[] = s[0].Split(" ")
			s[0] = st[2] 
		Endif
		
		Local len:Float = 1.0/(10*s[1].Length())
		Return Float( Int(s[0])+Int(s[1])*len )
		
	End
</pre><br>i'll update github.<br><br>**FYI** just so you know, there's a branched version (v0.20) that is more up-to-date and will be more in-line to the next big update. <br><br></td></tr></table><br>
<a name="2030428"></a>

<a name="2030432"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >LeeTheGee1</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#34">[#34]</a></td></tr></table></td></tr><tr ><td class="posttext"> Hi Adam<br><br>Changed this in the trender.monkey still get the same error will try the forked version(v0.20) now<br><br>Thanks For you Help...really excited to use Blitz3d again<br><br>lee <br><br></td></tr></table><br>
<a name="2030436"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >AdamRedwoods</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#35">[#35]</a></td></tr></table></td></tr><tr ><td class="posttext"> brute-force approach for non-compliant version numbers:<br><pre class=code>

Method GetVersion:Float()
		Local st:String
		
		Local s:String = glGetString(GL_VERSION)
		
		Local num:Int=0
		
		For Local i:Int=0 To s.Length()-1

			If (s[i] &gt;47 And s[i]&lt;58)
				st=st+String.FromChar(s[i])
				If num =0 Then num=1
			Elseif s[i]=46
				If num=2 Then Exit
				st=st+String.FromChar(s[i])
				num=2
			Elseif num&lt;&gt;0
				Exit
			Endif 
		Next

		Return Float( st )
		
	End
</pre> <br><br></td></tr></table><br>
<a name="2030447"></a>

<a name="2030448"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >LeeTheGee1</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#36">[#36]</a></td></tr></table></td></tr><tr ><td class="posttext"> Hi Adam<br><br>Got it Working its Fan Daby Dozzy Awsome...<br><br>i changed get version in opengles11.monkey(AS Above) from  branched version (v0.20)<br><br>then i was getting error:<br>C:/aaamonkeey/MonkeyPro56/modules/minib3d/tsurface.monkey&lt;140&gt; : Identifier 'tex_frame' not found.<br>Monkey runtime error: C:/aaamonkeey/MonkeyPro56/modules/minib3d/tsurface.monkey&lt;140&gt; : Identifier 'tex_frame' not found.<br><br>i commented out this line in tsurface.monkey....<br>line 140..brush.tex_frame = bru.tex_frame<br><br>then i was getting error:<br>C:/aaamonkeey/MonkeyPro56/modules/minib3d/tbrush.monkey&lt;206&gt; : Identifier 'tex_frame' not found.<br>Monkey runtime error: C:/aaamonkeey/MonkeyPro56/modules/minib3d/tbrush.monkey&lt;206&gt; : Identifier 'tex_frame' not found.<br><br>i commented out this line in tbrush.monkey....<br><br>line 206...'If brush1.tex_frame&lt;&gt;brush2.tex_frame Then Return False ''may not want if animtextures have different start frames<br><br>Thanks Soo Much for this Adam<br><br>coding coding coding<br><br>lee <br><br></td></tr></table><br>
<a name="2030446"></a>

<a name="2030449"></a>

<a name="2030450"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >AdamRedwoods</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#37">[#37]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> i commented out this line in tsurface.monkey.... <br></div><br>ya, sorry, i did move tex_frames around. removing that is ok.<br><br><br>In other news...<br>[monkeycode]<br><br>Class MyShader Extends TShaderGLSL Implements TShaderRender<br>	<br>	Field fbo:FrameBuffer<br>	<br>	Method New()<br><br>		'Override(1) ''override brush shaders<br>		AddProcess(Self)<br>		SetShader(Self)<br>		<br>		fbo = FrameBuffer.CreateFBO(CreateTexture(256,256,3))<br>		Print "yes"<br>	End<br>	<br>	Method PreProcess()<br>		Print 123<br>	End<br>	<br>	Method PostProcess()<br>		Print 456<br>	End<br>	<br>	Method Render(cam:TCamera)<br><br>		fbo.BeginFBO()<br>		DefaultShader()<br>		RenderCamera(cam)	<br>		fbo.EndFBO()<br>		<br>		DefaultShader()<br>		fbo.Display()<br>		<br>		<br>		<br>	End<br>	<br>End<br>[/monkeycode]<br>The above code is an example of the *custom* shader pipeline. SO far, so good! FBO's and shader swapping works on html5,glfw,android. <br><br></td></tr></table><br>
<a name="2030463"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >visionastral</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#38">[#38]</a></td></tr></table></td></tr><tr ><td class="posttext"> Adam, WE ARE WATCHING YOU xD<br>This will be a major upgrade for monkey, keep up the awesome work!<br>:) <br><br></td></tr></table><br>
<a name="2030536"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Sledge</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#39">[#39]</a></td></tr></table></td></tr><tr ><td class="posttext"> Not having much luck with this. Just installed the latest version of Monkey (v58) along with a fresh install of VCPP Express specifically to have a jolly faff about with it (Oooh! MiniB3D in Monkey! etc) but I initially got some similar errors to LeeTheGee1 (except his fixes above didn't work for me). Reset my PC (which I hadn't done after installing VCPP Express) and took a fresh take on both forks, and got the following errors (all with GLFW as the target)...<br><br><pre class=code>
0.14 (df70f5de41)
=================
ttexture.monkey &gt; Compile Error, Identifier 'MINIB3D_DRIVER' not found.

Branch (559cf932dc)
===================
animation_test
pick_collision_test
trender.monkey &gt; Compile Error, Line 215, Unable to find overload for Update().

firepaint3d
ttexture.monkey &gt; Compile Error, Line 613, Identifier 'DeleteTexture' not found.
</pre><br><br>Dunno if this helps or whether I'm being thick and have missed something obvious, but there you go. <br><br></td></tr></table><br>
<a name="2030538"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >AdamRedwoods</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#40">[#40]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> took a fresh take on both forks, and got the following errors <br></div><br>OK, my fault since I am messing up maintaining these two branches. Best to stick with v0.20.<br><br>The Branch errors you're getting seem to be mixing v0.14 and v0.20. I'd delete the minib3d module and start with just v0.20. <br><br></td></tr></table><br>
<a name="2030554"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Sledge</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#41">[#41]</a></td></tr></table></td></tr><tr ><td class="posttext"> Oh I cleaned out 0.14 before trying 0.20 -- there's nothing persistent beyond the module folder is there? <br><br></td></tr></table><br>
<a name="2030562"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >AdamRedwoods</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#42">[#42]</a></td></tr></table></td></tr><tr ><td class="posttext"> ok. i double-checked against monkey58/trans v1.34, and works here.<br><br>trender.monkey &gt; error line 215, I can't find a line with Update() (v0.20), but that line is in the old trender.monkey (v0.14). This is why I thought v0.14 and v0.20 were swapped.<br>ttexture.monnkey &gt; error line 613, DeleteTexture was moved to TRender.render (in v0.20), so the render object must be defined before this works. A sure way to force this is to put<br><pre class=code>
Import minib3d.opengles11
</pre><br>at the top (before other imports) of the example program.<br><br>Also, when compiling (minib3d v0.20), the output should show which driver is being used:<br><pre class=code>
Translating firepaint3d
C:/Monkey/bin/trans_winnt -target=mingw -run D:/_work/software_dev/_monkey/bananas/minib3d_bug_testing/firepaint3d.monkey

TRANS monkey compiler V1.34
Parsing...
MINIB3D_DRIVER=default
</pre><br>default being opengles11.<br><br>Try again, delete the build folder too. Check trender.monkey source and verify that #MINIB3D_DRIVER is in there (v0.20). <br><br></td></tr></table><br>
<a name="2030557"></a>

<a name="2030559"></a>

<a name="2030561"></a>

<a name="2030563"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Sledge</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#43">[#43]</a></td></tr></table></td></tr><tr ><td class="posttext"> Ah, I just deleted trender, compiled and up it popped again as if it were still there. Made me look suspiciously at Windows 7 and, a quick search later, I find "C:\Users\Sledge\AppData\Local\VirtualStore\Program Files\Monkey\modules\minib3d"! So yep, the OS had been kindly mixing and matching any edits &amp; file deletions -- I'm back to the errors that LeeTheGee1  had now so fingers crossed... <br><br></td></tr></table><br>
<a name="2030566"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Sledge</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#44">[#44]</a></td></tr></table></td></tr><tr ><td class="posttext"> Righto. Fresh version of v0.20, previous build folders deleted, virtual files zapped and I'm running Monk as admin so it shouldn't bother me with that sort of silliness again. I get the same error as LeeTheGee1 reported at first...<br><br><div class="quote"> Monkey runtime error: C:/aaamonkeey/MonkeyPro56/modules/minib3d/tsurface.monkey&lt;140&gt; : Identifier 'tex_frame' not found. <br></div><br><br>...but when I comment out line 140 the build process fails...<br><br><textarea class=codebox name="code" wrap=OFF readonly="true" rows="15" cols="80">Translating animation_test
"C:/Program Files/Monkey/bin/trans_winnt" -config=release -target=glfw -run C:/Users/Sledge/Downloads/adamredwoods-minib3d-monkey-559cf93/minib3d/examples/animation_test.monkey

TRANS monkey compiler V1.34
Parsing...
MINIB3D_DRIVER=default
Semanting...
Translating...
Building...
Microsoft (R) Build Engine Version 4.0.30319.1
[Microsoft .NET Framework, Version 4.0.30319.269]
Copyright (C) Microsoft Corporation 2007. All rights reserved.

Build started 31/05/2012 22:42:14.
Project "C:\Users\Sledge\Downloads\adamredwoods-minib3d-monkey-559cf93\minib3d\examples\animation_test.build\glfw\vc2010\MonkeyGame.sln" on node 1 (default targets).
ValidateSolutionConfiguration:
  Building solution configuration "Release|win32".
Project "C:\Users\Sledge\Downloads\adamredwoods-minib3d-monkey-559cf93\minib3d\examples\animation_test.build\glfw\vc2010\MonkeyGame.sln" (1) is building "C:\Users\Sledge\Downloads\adamredwoods-minib3d-monkey-559cf93\minib3d\examples\animation_test.build\glfw\vc2010\MonkeyGame.vcxproj" (2) on node 1 (default targets).
PrepareForBuild:
  Creating directory "C:\Users\Sledge\Downloads\adamredwoods-minib3d-monkey-559cf93\minib3d\examples\animation_test.build\glfw\vc2010\build\Release\".
InitializeBuildStatus:
  Creating "C:\Users\Sledge\Downloads\adamredwoods-minib3d-monkey-559cf93\minib3d\examples\animation_test.build\glfw\vc2010\build\Release\MonkeyGame.unsuccessfulbuild" because "AlwaysCreate" was specified.
ClCompile:
  C:\Program Files (x86)\Microsoft Visual Studio 10.0\VC\bin\CL.exe /c /I"../bdwgc/libatomic_ops-1.2/src" /I../bdwgc/include /I../stb /I../openal/include /I../glfw/include /I../glfw/lib /I../glfw/lib/win32 /Zi /nologo /W0 /WX- /O2 /Oi /Oy- /GL /D WIN32 /D NDEBUG /D _WINDOWS /D _MBCS /Gm- /EHsc /MT /GS /Gy- /fp:precise /Zc:wchar_t /Zc:forScope /Fo"C:\Users\Sledge\Downloads\adamredwoods-minib3d-monkey-559cf93\minib3d\examples\animation_test.build\glfw\vc2010\build\Release\\" /Fd"C:\Users\Sledge\Downloads\adamredwoods-minib3d-monkey-559cf93\minib3d\examples\animation_test.build\glfw\vc2010\build\Release\vc100.pdb" /Gd /TC /analyze- /errorReport:queue ..\glfw\lib\enable.c ..\glfw\lib\fullscreen.c ..\glfw\lib\glext.c ..\glfw\lib\image.c ..\glfw\lib\init.c ..\glfw\lib\input.c ..\glfw\lib\joystick.c ..\glfw\lib\stream.c ..\glfw\lib\tga.c ..\glfw\lib\thread.c ..\glfw\lib\time.c ..\glfw\lib\win32\win32_dllmain.c ..\glfw\lib\win32\win32_enable.c ..\glfw\lib\win32\win32_fullscreen.c ..\glfw\lib\win32\win32_glext.c ..\glfw\lib\win32\win32_init.c ..\glfw\lib\win32\win32_joystick.c ..\glfw\lib\win32\win32_thread.c ..\glfw\lib\win32\win32_time.c ..\glfw\lib\win32\win32_window.c ..\glfw\lib\window.c ..\stb\stb_image.c
  enable.c
  fullscreen.c
  glext.c
  image.c
  init.c
  input.c
  joystick.c
  stream.c
  tga.c
  thread.c
  time.c
  win32_dllmain.c
  win32_enable.c
  win32_fullscreen.c
  win32_glext.c
  win32_init.c
  win32_joystick.c
  win32_thread.c
  win32_time.c
  win32_window.c
  Compiling...
  window.c
  stb_image.c
  C:\Program Files (x86)\Microsoft Visual Studio 10.0\VC\bin\CL.exe /c /I"../bdwgc/libatomic_ops-1.2/src" /I../bdwgc/include /I../stb /I../openal/include /I../glfw/include /I../glfw/lib /I../glfw/lib/win32 /Zi /nologo /W0 /WX- /O2 /Oi /Oy- /GL /D WIN32 /D NDEBUG /D _WINDOWS /D _MBCS /Gm- /EHsc /MT /GS /Gy- /fp:precise /Zc:wchar_t /Zc:forScope /Fo"C:\Users\Sledge\Downloads\adamredwoods-minib3d-monkey-559cf93\minib3d\examples\animation_test.build\glfw\vc2010\build\Release\\" /Fd"C:\Users\Sledge\Downloads\adamredwoods-minib3d-monkey-559cf93\minib3d\examples\animation_test.build\glfw\vc2010\build\Release\vc100.pdb" /Gd /TP /analyze- /errorReport:queue ..\main.cpp
  main.cpp
..\main.cpp(2795): error C2146: syntax error : missing ')' before identifier '_' [C:\Users\Sledge\Downloads\adamredwoods-minib3d-monkey-559cf93\minib3d\examples\animation_test.build\glfw\vc2010\MonkeyGame.vcxproj]
..\main.cpp(2795): error C2059: syntax error : ')' [C:\Users\Sledge\Downloads\adamredwoods-minib3d-monkey-559cf93\minib3d\examples\animation_test.build\glfw\vc2010\MonkeyGame.vcxproj]
..\main.cpp(2795): error C2065: '_' : undeclared identifier [C:\Users\Sledge\Downloads\adamredwoods-minib3d-monkey-559cf93\minib3d\examples\animation_test.build\glfw\vc2010\MonkeyGame.vcxproj]
..\main.cpp(2795): error C2146: syntax error : missing ';' before identifier 'free' [C:\Users\Sledge\Downloads\adamredwoods-minib3d-monkey-559cf93\minib3d\examples\animation_test.build\glfw\vc2010\MonkeyGame.vcxproj]
Done Building Project "C:\Users\Sledge\Downloads\adamredwoods-minib3d-monkey-559cf93\minib3d\examples\animation_test.build\glfw\vc2010\MonkeyGame.vcxproj" (default targets) -- FAILED.
Done Building Project "C:\Users\Sledge\Downloads\adamredwoods-minib3d-monkey-559cf93\minib3d\examples\animation_test.build\glfw\vc2010\MonkeyGame.sln" (default targets) -- FAILED.

Build FAILED.

"C:\Users\Sledge\Downloads\adamredwoods-minib3d-monkey-559cf93\minib3d\examples\animation_test.build\glfw\vc2010\MonkeyGame.sln" (default target) (1) -&gt;
"C:\Users\Sledge\Downloads\adamredwoods-minib3d-monkey-559cf93\minib3d\examples\animation_test.build\glfw\vc2010\MonkeyGame.vcxproj" (default target) (2) -&gt;
(ClCompile target) -&gt; 
  ..\main.cpp(2795): error C2146: syntax error : missing ')' before identifier '_' [C:\Users\Sledge\Downloads\adamredwoods-minib3d-monkey-559cf93\minib3d\examples\animation_test.build\glfw\vc2010\MonkeyGame.vcxproj]
  ..\main.cpp(2795): error C2059: syntax error : ')' [C:\Users\Sledge\Downloads\adamredwoods-minib3d-monkey-559cf93\minib3d\examples\animation_test.build\glfw\vc2010\MonkeyGame.vcxproj]
  ..\main.cpp(2795): error C2065: '_' : undeclared identifier [C:\Users\Sledge\Downloads\adamredwoods-minib3d-monkey-559cf93\minib3d\examples\animation_test.build\glfw\vc2010\MonkeyGame.vcxproj]
  ..\main.cpp(2795): error C2146: syntax error : missing ';' before identifier 'free' [C:\Users\Sledge\Downloads\adamredwoods-minib3d-monkey-559cf93\minib3d\examples\animation_test.build\glfw\vc2010\MonkeyGame.vcxproj]

    0 Warning(s)
    4 Error(s)

Time Elapsed 00:00:07.51
TRANS FAILED: TRANS Failed to execute 'C:\Windows\Microsoft.NET\Framework\v4.0.30319\MSBuild.exe /p:Configuration=Release;Platform="win32" MonkeyGame.sln', return code=1

Process Complete</textarea><br><br>It definitely can build for GLFW as I tried the clock demo and it ran fine... stumped! <br><br></td></tr></table><br>
<a name="2030569"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >AdamRedwoods</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#45">[#45]</a></td></tr></table></td></tr><tr ><td class="posttext"> That error is something that MR. MARK SIBLY needs to fix.... *AHEM, AHEM*<br>We've mentioned it before, along with a slew of webgl fixes.<br><br>in modules/opengl/native/databuffers.cpp<br>change ~DataBuffer to look like this:<br><pre class=code>
	~DataBuffer(){
		if( _data) free( _data );
	}
</pre> <br><br></td></tr></table><br>
<a name="2030571"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Sledge</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#46">[#46]</a></td></tr></table></td></tr><tr ><td class="posttext"> That did the trick! Excellent stuff -- that's my weekend gone! <br><br></td></tr></table><br>
<a name="2030740"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >LeeTheGee1</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#47">[#47]</a></td></tr></table></td></tr><tr ><td class="posttext"> Hi All<br><br>Thanks to everybody in this forum i think i am off and running...i have attached a simple 3d collision example that may be helpful to others..with some help from here <a href="http://www.blitzbasic.com/Community/posts.php?topic=97932...not" target="_blank">http://www.blitzbasic.com/Community/posts.php?topic=97932...not</a> monkey specific <br><br><br>'Strict '..........think this is important<br>#TEXT_FILES="*.txt|*.xml|*.json|*.obj|*.mtl"<br>Import mojo<br>Import minib3d<br><br>Function Main()<br>	New Game<br>End<br><br>Class Game Extends App<br><br>	Field cam:TCamera <br>	<br>	Field light:TLight<br>	Field txt:TText<br>	Field cube:TMesh<br>	Field cube2:TMesh<br>	'Global noise:Sound<br>	' used by fps code<br>	Field old_ms:Int<br>	Field renders:Int<br>	Field fps:Int<br>	<br>	Field a:Float=0, dir:Int=0, oldTouchX:Int, oldTouchY:Int, touchBegin:Int<br><br>	Field whitebrush:TBrush<br><br><br>	Field init_gl:Bool = False<br>	<br>	Method OnCreate()<br>		SetUpdateRate 30<br>	End<br><br>	Method Init()<br>		<br>		If init_gl Then Return<br>		init_gl = True<br>		<br>		SetRender(New OpenglES11)<br>	<br>		<br>		cam = CreateCamera()<br>		cam.CameraClsColor(0,0,80)<br><br>		<br>		light=CreateLight(1)<br>		<br>		'sphere1 = CreateSphere()<br>	<br>		txt = TText.CreateText(cam)<br>		'txt.NoSmooth()<br>		<br>		light.PositionEntity 0,3,-3<br>		cam.PositionEntity 0.5,1,-5<br><br>		'PositionEntity sphere1,-1,0,0<br><br>		<br>		whitebrush = New TBrush<br>		whitebrush.BrushColor(200,200,200)<br>		'sphere1.PaintEntity( whitebrush)<br><br>		'sphere1.EntityCollision(1, COLLISION_METHOD_POLYGON, 1.0)		<br>		'sphere1.EntityFX(2)<br>		'sphere1.RotateEntity(145,145,0)<br>		'sphere1.ScaleEntity(2.0,2.0,2.0)<br>		<br>		cube=CreateCube()<br>		cube.ScaleEntity(0.5,0.5,0.5)<br>		cube.name = "cube"<br>		PositionEntity cube,-2,2,2<br>		EntityType(cube,1) 'append the constant collision data to second sphere<br>		<br>		cube2=CreateCube()<br>		cube2.ScaleEntity(0.5,0.5,0.5)<br>		cube2.name = "cube2"<br>		PositionEntity cube2,2,2,2<br>		EntityType(cube2,2) 'append the constant collision data to second sphere<br>		<br>		Collisions(1,2, 2, 2)  'update collisions using the ellipsoid to polygon and full sliding collision methods<br>		'Collisions(2,1, 2, 2)  'update collisions using the ellipsoid to polygon and full sliding collision methods<br><br>		'noise = LoadSound("sound.wav")<br>		old_ms=Millisecs()<br>		<br>		'Wireframe(True)<br>		<br>		Print "main: intit done"<br>	End<br>	<br>	Method OnUpdate()	<br>		If KeyDown(KEY_LEFT)<br>		 cube.MoveEntity(-0.5,0,0)<br>		Endif<br><br>		If KeyDown(KEY_RIGHT)<br>		 cube.MoveEntity(0.5,0,0)<br>		Endif<br>		If EntityCollided (cube,2)<br>		'PlaySound (noise,0,0)<br>		cube.MoveEntity(4,0,0)<br>		Endif<br><br>		<br>		'cam.PointEntity(cube)<br><br>		<br>		<br>		txt.SetMode2D()	<br>		txt.SetText(fps+" fps ~nhow are you", 0,0)<br>	<br>		<br>		' calculate fps<br>		If Millisecs()-old_ms &gt;= 1000<br>			old_ms=Millisecs()<br>			fps=renders<br>			renders=0<br>		Endif<br>		<br>		UpdateWorld()<br>		<br>	End<br>	<br>	Method OnRender()<br>		Init()<br>		<br>		RenderWorld()<br>		renders=renders+1				<br>		<br>	End<br><br>End<br>...............Thanks Again to everybody here<br><br>lee <br><br></td></tr></table><br>
<a name="2030735"></a>

<a name="2030858"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Sammy</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#48">[#48]</a></td></tr></table></td></tr><tr ><td class="posttext"> Could you stick that in a codebox Lee, for readability? <br><br></td></tr></table><br>
<a name="2030979"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rone</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#49">[#49]</a></td></tr></table></td></tr><tr ><td class="posttext"> Hi, <br><br>I wrote an rudimentary XNA wrapper and implemented an XNA target for miniB3D v0.2.<br>Its not feature complete and not optimized, but the samples seems to work..so it might be an good starting point.<br><br>There might be some places, where the opengl import was removed...in tlight for example<br>I changed the import section of trender.monkey as follows:<br><br><textarea class=codebox name="code" wrap=OFF readonly="true" rows="15" cols="80">
#If MINIB3D_DRIVER="default"
	Import minib3d.opengles11
#elseIf MINIB3D_DRIVER="xna"
	Import minib3d.xna_render 
#endif

#if TARGET&lt;&gt;"xna"
	Import opengl.databuffer
#Endif
</textarea><br><br>native/xna.xna.cs<br><br><textarea class=codebox name="code" wrap=OFF readonly="true" rows="15" cols="80">
public class XNAGraphicsDevice
{
    public GraphicsDevice _device;
	public BasicEffect _effect;
	public Viewport _viewport = new Viewport();
	public Color _clsColor = Color.White;
	
    public XNAGraphicsDevice()
    {
        _device = gxtkApp.game.app.graphics.device;
        _effect = new BasicEffect(_device);
        _effect.VertexColorEnabled = false;
        _effect.PreferPerPixelLighting = false;
        _effect.SpecularColor = new Vector3(1,1,1);
        _effect.FogEnabled = false;
    }

    public XNATexture LoadTexture(string fileName)
    {
        var texture = MonkeyData.LoadTexture2D(fileName, gxtkApp.game.Content);
        if (texture != null) return new XNATexture(texture,fileName);
        return null;
    }
	
	public XNATexture CreateTexture(int width, int height, bool mipmap, int format)
    {
         return new XNATexture(_device, width, height, mipmap, format);
    }
	
	public XNABasicEffect CreateBasicEffect()
	{
		return new XNABasicEffect(this,new BasicEffect(_device));
	}
	
	public XNAEffect LoadEffect(string filename)
	{
		//var effect = gxtkApp.game.Content.Load&lt;Effect&gt;(filename);
		//if( effect != null ) return new XNAEffect(effect, this);
		return null;
	}	
	
	public XNAMesh CreateMesh()
	{
		return new XNAMesh(_device);
	}

	 public void SetBlend(XNABlendState blend)
    {
		_device.BlendState = blend._state;
    }
	
	public void SetRasterizerState(XNARasterizerState state)
    {
        _device.RasterizerState = state._state;
    }
	
	public void SetDepthStencilState(XNADepthStencilState state)
	{
		_device.DepthStencilState = state._state;
	}
	
	public void SetSamplerState(int index, XNASamplerState state)
	{
		_device.SamplerStates[index] = state._state;
	}

    public void ClearScreen(float r, float g, float b, bool back, bool depth, bool stencil)
    {
		int mode = 0;
        if (back) mode |= (int)ClearOptions.Target;
        if (depth) mode |= (int)ClearOptions.DepthBuffer;
        if (stencil) mode |= (int)ClearOptions.Stencil;
        _device.Clear((ClearOptions)mode, new Color(r, g, b), 1.0f, 0);
    }
	
	public void Viewport(int x,int y,int width, int height) 
	{
		_viewport.X = x;
        _viewport.Y = y;
        _viewport.Width = width;
        _viewport.Height = height;
		_viewport.MinDepth = 0.0f;
        _viewport.MaxDepth = 1.0f;
	}
};

public class XNABlendState
{
	public BlendState _state;
	
	public XNABlendState(BlendState state)
	{
		_state = state;
	}

    public static XNABlendState Create()
	{
		return new XNABlendState(new BlendState());
	}

    public static XNABlendState Additive()
	{
		return new XNABlendState(BlendState.Additive);
	}

    public static XNABlendState AlphaBlend()
	{
		return new XNABlendState(BlendState.AlphaBlend);
	}

    public static XNABlendState NonPremultiplied()
	{
		return new XNABlendState(BlendState.NonPremultiplied);
	}

    public static XNABlendState Opaque()
	{
		return new XNABlendState(BlendState.Opaque);
	}
	
	public int GetAlphaBlendFunction()
	{
		return (int)_state.AlphaBlendFunction;
	}
	
	public int GetAlphaDestinationBlend()
	{
		return (int)_state.AlphaDestinationBlend;
	}
	
	public int GetAlphaSourceBlend()
	{
		return (int)_state.AlphaSourceBlend;
	}

    public XNAColor GetBlendFactor()
	{
        return new XNAColor(_state.BlendFactor);
	}
	
	public int GetColorBlendFunction()
	{
		return (int)_state.ColorBlendFunction;
	}
	
	public int GetColorDestinationBlend()
	{
		return (int)_state.ColorDestinationBlend;
	}

    public int GetColorSourceBlend()
	{
		return (int)_state.ColorSourceBlend;
	}
	
	public void SetAlphaBlendFunction(int value)
	{
        _state.AlphaBlendFunction = (BlendFunction)value;
	}
	
	public void SetAlphaDestinationBlend(int value)
	{
        _state.AlphaDestinationBlend = (Blend)value;
	}
	
	public void SetAlphaSourceBlend(int value)
	{
        _state.AlphaSourceBlend = (Blend)value;
	}
	
	public void SetBlendFactor(XNAColor value)
	{
        _state.BlendFactor = value._color;
	}
	
	public void SetColorBlendFunction(int value)
	{
        _state.ColorBlendFunction = (BlendFunction)value;
	}
	
	public void SetColorDestinationBlend(int value)
	{
        _state.ColorDestinationBlend = (Blend)value;
	}
	
	public void SetColorSourceBlend(int value)
	{
        _state.ColorSourceBlend = (Blend)value;
	}
}

public class XNARasterizerState
{
	public RasterizerState _state;
	
	public XNARasterizerState(RasterizerState state)
	{
		_state = state;
	}

    public static XNARasterizerState Create()
	{
        return new XNARasterizerState(new RasterizerState());
	}

    public static XNARasterizerState CullClockwise()
	{
		return new XNARasterizerState(RasterizerState.CullClockwise);
	}

    public static XNARasterizerState CullCounterClockwise()
	{
		return new XNARasterizerState(RasterizerState.CullCounterClockwise);
	}

    public static XNARasterizerState CullNone()
	{
		return new XNARasterizerState(RasterizerState.CullNone);
	}
	
	public int GetCullMode()
	{
        return (int)_state.CullMode;
	}
	
	public float GetDepthBias()
	{
        return (float)_state.DepthBias;
	}
	
	public int GetFillMode()
	{
        return (int)_state.FillMode;
	}
	
	public bool GetMultiSampleAntiAlias()
	{
        return _state.MultiSampleAntiAlias;
	}

    public bool GetScissorTestEnable()
	{
        return _state.ScissorTestEnable;
	}
	
	public float GetSlopeScaleDepthBias()
	{
        return _state.SlopeScaleDepthBias;
	}
	
	public void SetCullMode(int value)
	{
        _state.CullMode = (CullMode)value;
	}

    public void SetDepthBias(float value)
	{
        _state.DepthBias = value;
	}
	
	public void SetFillMode(int value)
	{
        _state.FillMode = (FillMode)value;
	}
	
	public void SetMultiSampleAntiAlias(bool value)
	{
        _state.MultiSampleAntiAlias = value;
	}

    public void SetScissorTestEnable(bool value)
	{
        _state.ScissorTestEnable = value;
	}
	
	public void SetSlopeScaleDepthBias(float value)
	{
        _state.SlopeScaleDepthBias = value;
	}
}


public class XNASamplerState 
{
    public SamplerState _state;

    public XNASamplerState(SamplerState state)
    {
        _state = state;
    }

    public static XNASamplerState Create()
    {
        return new XNASamplerState(new SamplerState());
    }

    public static XNASamplerState AnisotropicClamp()
    {
        return new XNASamplerState(SamplerState.AnisotropicClamp);
    }

    public static XNASamplerState AnisotropicWrap()
    {
        return new XNASamplerState(SamplerState.AnisotropicWrap);
    }

    public static XNASamplerState LinearClamp()
    {
        return new XNASamplerState(SamplerState.LinearClamp);
    }

    public static XNASamplerState PointClamp()
    {
        return new XNASamplerState(SamplerState.PointClamp);
    }

    public static XNASamplerState PointWrap()
    {
        return new XNASamplerState(SamplerState.PointWrap);
    }

	public int GetAddressU()
    {
        return (int)_state.AddressU;
    }

	public int GetAddressV()
    {
        return (int)_state.AddressV;
    }

	public int GetAddressW()
    {
        return (int)_state.AddressW;
    }

	public int GetFilter()
    {
        return (int)_state.Filter;
    }

	public int GetMaxAnisotropy()
    {
        return (int)_state.MaxAnisotropy;
    }

	public int GetMaxMipLevel()
    {
        return (int)_state.MaxMipLevel;
    }

	public int GetMipMapLevelOfDetailBias()
    {
        return (int)_state.MipMapLevelOfDetailBias;
    }

	public void SetAddressU(int value)
    {
        _state.AddressU = (TextureAddressMode)value;
    }

	public void SetAddressV(int value)
    {
        _state.AddressV = (TextureAddressMode)value;
    }

	public void SetAddressW(int value)
    {
        _state.AddressW = (TextureAddressMode)value;
    }

	public void SetFilter(int value)
    {
        _state.Filter = (TextureFilter)value;
    }

	public void SetMaxAnisotropy(int value)
    {
        _state.MaxAnisotropy = value;
    }

	public void SetMaxMipLevel(int value)
    {
        _state.MaxMipLevel = value;
    }

    public void SetMipMapLevelOfDetailBias(int value)
    {
        _state.MipMapLevelOfDetailBias = value;
    }
} 

public class XNADepthStencilState
{
	public DepthStencilState _state;

    public XNADepthStencilState(DepthStencilState state)
    {
        _state = state;
    }

    public static XNADepthStencilState Create()
    {
        return new XNADepthStencilState(new DepthStencilState());
    }

    public static XNADepthStencilState Default()
    {
        return new XNADepthStencilState(DepthStencilState.Default);
    }

    public static XNADepthStencilState DepthRead()
    {
        return new XNADepthStencilState(DepthStencilState.DepthRead);
    }

    public static XNADepthStencilState None()
    {
        return new XNADepthStencilState(DepthStencilState.None);
    }

	public int GetCounterClockwiseStencilDepthBufferFail()
	{
        return (int)_state.CounterClockwiseStencilDepthBufferFail;
	}

	public int GetCounterClockwiseStencilFail()
	{
        return (int)_state.CounterClockwiseStencilFail;
	}
	 
	public int GetCounterClockwiseStencilFunction()
	{
         return (int)_state.CounterClockwiseStencilFunction;
	}
	 
	public int GetCounterClockwiseStencilPass()
	{
        return (int)_state.CounterClockwiseStencilPass;
	}
	
	public bool GetDepthBufferEnable()
	{
        return _state.DepthBufferEnable;
	}
	
	public int GetDepthBufferFunction()
	{
        return (int)_state.DepthBufferFunction;
	}
	
	public bool GetDepthBufferWriteEnable()
	{
        return _state.DepthBufferWriteEnable;
	}
	
	public int GetReferenceStencil()
	{
        return _state.ReferenceStencil;
	}
	
	public int GetStencilDepthBufferFail()
	{
        return (int)_state.StencilDepthBufferFail;
	}
	
	public bool GetStencilEnable()
	{
        return _state.StencilEnable;
	}
	
	public int GetStencilFail()
	{
        return (int)_state.StencilFail;
	}
	
	public int GetStencilFunction()
	{
        return (int)_state.StencilFunction;
	}
	
	public int GetStencilMask()
	{
        return _state.StencilMask;
	}
	
	public int GetStencilPass()
	{
        return (int)_state.StencilPass;
	}
	
	public int GetStencilWriteMask()
	{
        return (int)_state.StencilWriteMask;
	}
	
	public bool GetTwoSidedStencilMode()
	{
        return _state.TwoSidedStencilMode;
	}
	
	public void SetCounterClockwiseStencilDepthBufferFail(int value)
    {
        _state.CounterClockwiseStencilDepthBufferFail = (StencilOperation)value;
    }

	public void SetCounterClockwiseStencilFail(int value)
    {
        _state.CounterClockwiseStencilFail = (StencilOperation)value;
    }
 
	public void SetCounterClockwiseStencilFunction(int value)
    {
        _state.CounterClockwiseStencilFunction = (CompareFunction)value;
    }

	public void SetCounterClockwiseStencilPass(int value)
    {
        _state.CounterClockwiseStencilPass = (StencilOperation)value;
    }

	public void SetDepthBufferEnable(bool value)
    {
        _state.DepthBufferEnable = value;
    }
	
	public void SetDepthBufferFunction(int value)
    {
        _state.DepthBufferFunction = (CompareFunction)value;
    }

    public void SetDepthBufferWriteEnable(bool value)
    {
        _state.DepthBufferWriteEnable = value;
    }
	
	public void SetReferenceStencil(int value)
    {
        _state.ReferenceStencil = value;
    }
	
	public void SetStencilDepthBufferFail(int value)
    {
        _state.StencilDepthBufferFail = (StencilOperation)value;
    }

    public void SetStencilEnable(bool value)
    {
        _state.StencilEnable = value;
    }
	
	public void SetStencilFail(int value)
    {
        _state.StencilFail = (StencilOperation)value;
    }
	
	public void SetStencilFunction(int value)
    {
        _state.StencilFunction = (CompareFunction)value;
    }
	
	public void SetStencilMask(int value)
    {
        _state.StencilMask = value;
    }
	
	public void SetStencilPass(int value)
    {
        _state.StencilPass = (StencilOperation)value;
    }
	
	public void SetStencilWriteMask(int value)
    {
        _state.StencilWriteMask = value;
    }

    public void SetTwoSidedStencilMode(bool value)
    {
        _state.TwoSidedStencilMode = value;
    }
}

public class XNATexture
{
    public Texture2D _texture;
	public string _name;
	
    public XNATexture(Texture2D tex, string name)
    {
		_name = name;
        _texture = tex;
    }
	
    public XNATexture(GraphicsDevice device, int width, int height, bool mipmap, int format)
    {
        _texture = new Texture2D(device, width, height,mipmap,SurfaceFormat.Color );
    }
	
	public void SetData(int level, DataBuffer data, int start, int count)
    {
        _texture.SetData&lt;byte&gt;(level, new Rectangle(0,0,_texture.Width, _texture.Height) ,data._data, start, count);
    }

    public int Width()
    {
        return _texture.Width;
    }

    public int Height()
    {
        return _texture.Height;
    }

    public virtual int Discard()
    {
        if (_texture != null)_texture = null;
        return 0;
    }
};

public class XNAMesh
{
	public struct VERTEX : IVertexType
    {
        public Vector3  Position;
        public Vector3  Normal;
        public Color    Color;
        public Vector2  TextureCoordinate0;
        public Vector2  TextureCoordinate1;

        public VERTEX(Vector3 pos, Vector3 norm, Color color, Vector2 tex0, Vector2 tex1)
        {
            Position = pos;
            Normal = norm;
            Color = color;
            TextureCoordinate0 = tex0;
            TextureCoordinate1 = tex1;
        }

        public readonly static VertexDeclaration VertexDeclaration = new VertexDeclaration
        (
            new VertexElement(0, VertexElementFormat.Vector3, VertexElementUsage.Position, 0),
            new VertexElement(12, VertexElementFormat.Vector3, VertexElementUsage.Normal, 0),
            new VertexElement(24, VertexElementFormat.Color, VertexElementUsage.Color, 0),
            new VertexElement(32, VertexElementFormat.Vector2, VertexElementUsage.TextureCoordinate, 0),
            new VertexElement(40, VertexElementFormat.Vector2, VertexElementUsage.TextureCoordinate, 1)
        );

        VertexDeclaration IVertexType.VertexDeclaration { get { return VertexDeclaration; } }
    };
	
	public GraphicsDevice _device;
	
	// Vertexformat
    public int VERTEXSIZE;
    public int INDEXSIZE;
    public VertexDeclaration VERTEXDECLARATION;
	
	// Vertex &amp; index buffer
    public VertexBuffer _vBuffer;
    public IndexBuffer _iBuffer;

    // Vertex &amp; indexe arrays
    public List&lt;short&gt; _indices;
    public List&lt;VertexPositionNormalTexture&gt; _vertices;

    public bool _updated;
    public bool _vboEnabled;
	
	public XNAMesh(GraphicsDevice device)
	{
		_device = device;
        VERTEXDECLARATION = VertexPositionNormalTexture.VertexDeclaration;
        VERTEXSIZE = 24;//System.Runtime.InteropServices.Marshal.SizeOf(typeof(VertexPositionNormalTexture));
        INDEXSIZE = 2;

        _vertices = new List&lt;VertexPositionNormalTexture&gt;();
		_indices = new List&lt;short&gt;();
	}
	
	public bool IsEmty()
	{
		return _vertices.Count == 0;
	}
	
	public int AddVertex(float x,float y,float z, float nx, float ny, float nz, float s, float t)
	{
		_updated = true;
        _vertices.Add(new VertexPositionNormalTexture(new Vector3(x, y, z), new Vector3(nx, ny, nz), new Vector2(s, t)));
		return _vertices.Count-1;
	}
	
	public int AddTriangle(int v0,int v1,int  v2)
	{
		_updated = true;
		_indices.Add((short)v0);
		_indices.Add((short)v1);
		_indices.Add((short)v2);
		return _indices.Count / 3;
	}
	
	public int CountVertices()
	{
		return _vertices.Count;
	}
	
	public int CountTriangles()
	{
		return _indices.Count / 3;
	}
	
	public int Size()
	{
		return _vertices.Count * VERTEXSIZE;
	}
	
	public void Clear()
	{
		_vertices.Clear();
		_indices.Clear();
		
		if( _vBuffer != null ) 
		{
			_vBuffer.Dispose();
			_vBuffer = null;
		}
		
		if( _iBuffer != null ) 
		{
			_iBuffer.Dispose();
			_iBuffer = null;
		}
	}
	
	public void Update()
	{
		if (_vBuffer == null || _iBuffer == null || _updated )
        {
            //Init VBO
			try
            {
                if (_vBuffer != null)
                {
                    _vBuffer.Dispose();
                }
                _vBuffer = new VertexBuffer(_device, VERTEXDECLARATION, _vertices.Count(), BufferUsage.WriteOnly);

                if (_iBuffer != null)
                {
                    _iBuffer.Dispose();
                }
                _iBuffer = new IndexBuffer(_device, typeof(short), _indices.Count, BufferUsage.WriteOnly);

            }
            catch
            {
                _vboEnabled = false;
            }

            if (_vBuffer == null || _iBuffer == null)
            {
                _vboEnabled = false;
            }
            else
            {
                _vboEnabled = true;
            }

            if (_vboEnabled)
            {
                _vBuffer.SetData&lt;VertexPositionNormalTexture&gt;(_vertices.ToArray(), 0, _vertices.Count);
                _iBuffer.SetData(_indices.ToArray(),0,_indices.Count);
            }

            _updated = false;
        }
	}
	
	public void Bind()
	{
		if (_vboEnabled)
        {
            _device.Indices = _iBuffer;
            _device.SetVertexBuffer(_vBuffer);
        }
	}
	
	public void Render()
	{
		if (_vboEnabled) // Render from vertexbuffer object
        {
            _device.DrawIndexedPrimitives(PrimitiveType.TriangleList, 0, 0, _vertices.Count, 0, _indices.Count / 3);
        }
        else // Render from arrays 
        {
            _device.DrawUserIndexedPrimitives(PrimitiveType.TriangleList, _vertices.ToArray(), 0, _vertices.Count, _indices.ToArray(), 0, _indices.Count / 3);
        }
	}
};


/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
public class Utility
{
    public static double RAD_TO_DEG = 57.2957795130823208767981548141052;
    public static double DEG_TO_RAD = 0.0174532925199432957692369076848861;

    public static void MatrixTranslate(ref Matrix mat, Vector3 vec)
    {
        mat.M41 += mat.M11 * vec.X + mat.M21 * vec.Y + mat.M31 * vec.Z;
        mat.M42 += mat.M12 * vec.X + mat.M22 * vec.Y + mat.M32 * vec.Z;
        mat.M43 += mat.M13 * vec.X + mat.M23 * vec.Y + mat.M33 * vec.Z;
    }

    public static void MatrixRotate(ref Matrix mat, Vector3 vec)
    {
  // yaw

        float cos_ang = (float)Cos((double)vec.Y);
        float sin_ang = (float)Sin((double)vec.Y);
	
		float m11 = mat.M11 * cos_ang + mat.M31 * -sin_ang;
		float m12 = mat.M12 * cos_ang + mat.M32 * -sin_ang;
		float m13 = mat.M13 * cos_ang + mat.M33 * -sin_ang;
		
		mat.M31 = mat.M11 * sin_ang + mat.M31 * cos_ang;
		mat.M32 = mat.M12 * sin_ang + mat.M32 * cos_ang;
		mat.M33 = mat.M13 * sin_ang + mat.M33 * cos_ang;

        mat.M11 = m11;
        mat.M12 = m12;
        mat.M13 = m13;
		
  // pitch

        cos_ang = (float)Cos((double)vec.X);
        sin_ang = (float)Sin((double)vec.X);
	
        float m21 = mat.M21 * cos_ang + mat.M31 * sin_ang;
		float m22 = mat.M22 * cos_ang + mat.M32 * sin_ang;
		float m23 = mat.M23 * cos_ang + mat.M33 * sin_ang;
        
        mat.M31 = mat.M21 * -sin_ang + mat.M31 * cos_ang;
		mat.M32 = mat.M22 * -sin_ang + mat.M32 * cos_ang;
		mat.M33 = mat.M23 * -sin_ang + mat.M33 * cos_ang;
		
		mat.M21=m21;
		mat.M22=m22;
		mat.M23=m23;
		
  // roll

        cos_ang = (float)Cos((double)vec.Z);
        sin_ang = (float)Sin((double)vec.Z);

		m11 = mat.M11 * cos_ang + mat.M21 * sin_ang;
		m12 = mat.M12 * cos_ang + mat.M22 * sin_ang;
		m13 = mat.M13 * cos_ang + mat.M23 * sin_ang;
		
		mat.M21 = mat.M11 * -sin_ang + mat.M21 * cos_ang;
		mat.M22 = mat.M12 * -sin_ang + mat.M22 * cos_ang;
		mat.M23 = mat.M13 * -sin_ang + mat.M23 * cos_ang;
		
		mat.M11 = m11;
		mat.M12 = m12;
        mat.M13 = m13;
    }

    public static void MatrixScale(ref Matrix mat, Vector3 vec)
    {
        mat.M11 *= vec.X;
        mat.M12 *= vec.X;
        mat.M13 *= vec.X;

        mat.M21 *= vec.Y;
        mat.M22 *= vec.Y;
        mat.M23 *= vec.Y;

        mat.M31 *= vec.Z;
        mat.M32 *= vec.Z;
        mat.M33 *= vec.Z;
    }

    public static Matrix MatrixCopy(Matrix m)
    {
        return new Matrix(m.M11, m.M12, m.M13, m.M14,
                            m.M21, m.M22, m.M23, m.M24,
                            m.M31, m.M32, m.M33, m.M34,
                            m.M41, m.M42, m.M43, m.M44);

    }

    public static void MatrixOverride(ref Matrix dest, Matrix src)
    {
        dest.M11 = src.M11;
        dest.M12 = src.M12;
        dest.M13 = src.M13;
        dest.M14 = src.M14;
        dest.M21 = src.M21;
        dest.M22 = src.M22;
        dest.M23 = src.M23;
        dest.M24 = src.M24;
        dest.M31 = src.M31;
        dest.M32 = src.M32;
        dest.M33 = src.M33;
        dest.M34 = src.M34;
        dest.M41 = src.M41;
        dest.M42 = src.M42;
        dest.M43 = src.M43;
        dest.M44 = src.M44;

    }

    public static double Cos(double x)
    {
        return Math.Cos(x * DEG_TO_RAD);
    }

    public static double tan(double x)
    {
        return Math.Tan(x * DEG_TO_RAD);
    }

    public static double Sin(double x)
    {
        return Math.Sin(x * DEG_TO_RAD);
    }

    public static double ASin(double x)
    {
        return Math.Asin(x) * RAD_TO_DEG;
    }

    public static double ACos(double x)
    {
        return Math.Acos(x) * RAD_TO_DEG;
    }

    public static double ATan(double x)
    {
        return Math.Atan(x) * RAD_TO_DEG;
    }

    public static double ATan2(double y, double x)
    {
        return Math.Atan2(y, x) * RAD_TO_DEG;
    }
};


public class XNAVector
{
	public Vector3 _vector;
	
	public XNAVector(float x,float y,float z)
	{
		_vector = new Vector3(x,y,z);
	}
	
	public static XNAVector CreateVector(float x,float y,float z)
	{
		return new XNAVector(x,y,z);
	}
	
	public float X() 
	{
		return _vector.X;
	}
	
	public float Y() 
	{
		return _vector.Y;
	}
	
	public float Z() 
	{
		return _vector.Z;
	}
	
	/*
	Method Set(x#,y#,z#)
		_x = x
		_y = y
		_z = z
		_w = 3
	End
	
	Method Add(vec:Vector)
		_x+=vec._x
		_y+=vec._y
		_z+=vec._z
	End 
	
	Method Subtract(vec:Vector)
		_x-=vec._x
		_y-=vec._y
		_z-=vec._z
	End 
	
	Method Multiply(value#)
		_x*=value
		_y*=value
		_z*=value
	End 
	
	Method Divide(val#)
		_x/=val
		_y/=val
		_z/=val
	End 
	
	Method Dot:Float(vec:Vector)
		Return (_x*vec._x)+(_y*vec._y)+(_z*vec._z)
	End 
	
	Method Cross:Vector0(vec:Vector)
		Return new Vector0((_y*vec._z)-(_z*vec._y),(_z*vec._x)-(_x*vec._z),(_x*vec._y)-(_y*vec._x))
	End 
	
	Method Normalize()
		Local d#=1.0/Sqr(_x*_x+_y*_y+_z*_z)
		_x*=d
		_y*=d
		_z*=d
	End 
	
	Method Length#()	
		Return Sqr(_x*_x+_y*_y+_z*_z)
	End 
	
	Method SquaredLength#()
		Return _x*_x+_y*_y+_z*_z
	End Method
	
	Method SetLength(value#)
		Normalize()
		_x*=value
		_y*=value
		_z*=value
	End Method
	
	Method Compare( q:Vector )
		If _x-q._x&gt;EPSILON Return 1
		If _q.x-_x&gt;EPSILON Return -1
		If _y-q._y&gt;EPSILON Return 1
		If _q.y-_y&gt;EPSILON Return -1
		If _z-q._z&gt;EPSILON Return 1
		If q._z-_z&gt;EPSILON Return -1
		Return 0
	End 
	*/
}

public class XNADirectionalLight 
{
	public DirectionalLight _light;
	
	public XNADirectionalLight(DirectionalLight light)
	{
		_light = light;
	}
	
	public void SetDiffuseColor(float r, float g, float b) 
	{
		_light.DiffuseColor = new Vector3(r,g,b);
	}
	
	public void SetDirection(float x, float y, float z)
	{
		_light.Direction = new Vector3(x,y,z);
	}
	
	public bool GetEnabled() 
	{
		return _light.Enabled;
	}
	
	public void SetEnabled(bool value)
	{
		_light.Enabled = value;
	}

	public void SetSpecularColor(float r, float g, float b) 
	{
		_light.SpecularColor = new Vector3(r,g,b);
	}
}

public class XNABasicEffect : XNAEffect
{
	public BasicEffect _basicEffect;
	public XNADirectionalLight _light0;
	public XNADirectionalLight _light1;
	public XNADirectionalLight _light2;
	
	public XNABasicEffect(XNAGraphicsDevice device, BasicEffect effect) 
		: base(effect,device)
	{
		_basicEffect = effect;
		_light0 = new XNADirectionalLight(effect.DirectionalLight0);
		_light1 = new XNADirectionalLight(effect.DirectionalLight1);
		_light2 = new XNADirectionalLight(effect.DirectionalLight2);
	}
	
	public void SetAlpha(float alpha)
	{
		_basicEffect.Alpha = alpha;
	}

	public void SetAmbientLightColor(float r, float g, float b)	
	{
		_basicEffect.AmbientLightColor = new Vector3(r,g,b);
	}
		
	public void SetDiffuseColor(float r, float g, float b)	
	{
		_basicEffect.DiffuseColor  = new Vector3(r,g,b);
	}
	
	public XNADirectionalLight GetDirectionalLight0()	
	{
		return _light0;
	}
		
	public XNADirectionalLight GetDirectionalLight1()	
	{
		return _light1;
	}
	
	public XNADirectionalLight GetDirectionalLight2()	
	{
		return _light2;
	}
		
	public void SetEmissiveColor(float r, float g, float b)	
	{
		_basicEffect.EmissiveColor  = new Vector3(r,g,b);
	}
	
	public void SetFogColor(float r, float g, float b)	
	{
		_basicEffect.FogColor  = new Vector3(r,g,b);
	}

	public bool GetFogEnabled()
	{
		return _basicEffect.FogEnabled;
	}
	
	public void SetFogEnabled(bool value)	
	{
		_basicEffect.FogEnabled = value;
	}
		
	public void SetFogEnd(float value)	
	{
		_basicEffect.FogEnd = value;
	}
	
	public void SetFogStart(float value)	
	{
		_basicEffect.FogStart = value;
	}
		
	public void SetLightingEnabled(bool value)	
	{
		_basicEffect.LightingEnabled = value;
	}
	
	public void SetPreferPerPixelLighting(bool value)	
	{
		_basicEffect.PreferPerPixelLighting = value;
	}

	public void SetSpecularColor(float r, float g, float b)	
	{
		_basicEffect.SpecularColor  = new Vector3(r,g,b);
	}

	public void SetSpecularPower(float value)	
	{
		_basicEffect.SpecularPower = value;
	}
	
	public void SetTexture(XNATexture value)	
	{
		_basicEffect.Texture = value._texture;
	}
		
	public void SetTextureEnabled(bool value)		
	{
		_basicEffect.TextureEnabled = value;
	}
	
	public void SetVertexColorEnabled(bool value)		
	{
		_basicEffect.VertexColorEnabled = value;
	}
	
	public void SetProjection(float fieldOfView, float aspectRatio, float near, float far) 
	{
        _basicEffect.Projection = Matrix.CreatePerspectiveFieldOfView((float)Utility.DEG_TO_RAD * fieldOfView, aspectRatio, near, far);
	}
	
	
	public void SetView(float px, float py, float pz, float rx, float ry, float rz, float sx, float sy, float sz)
	{
		var _mat = Matrix.Identity;
			
		Utility.MatrixTranslate(ref _mat, new Vector3(px,py,pz));
        Utility.MatrixRotate(ref _mat, new Vector3(rx,ry,rz));
        Utility.MatrixScale(ref _mat, new Vector3(sx,sy,sz));
		
		// only rotation
        Matrix mCam = new Matrix(_mat.M11, _mat.M12, _mat.M13, _mat.M14,
                                 _mat.M21, _mat.M22, _mat.M23, _mat.M24,
                                 _mat.M31, _mat.M32, _mat.M33, _mat.M34,
                                 _mat.M41, _mat.M42, _mat.M43, _mat.M44);

        mCam.M41 = 0.0f;
        mCam.M42 = 0.0f;
        mCam.M43 = 0.0f;
		
		// Calculate Lookat
        Vector3 vWorldLook = Vector3.TransformNormal(Vector3.Forward, mCam);
        Vector3 vUp =  Vector3.TransformNormal(Vector3.Up, mCam);
        Vector3 vPos = new Vector3(_mat.M41, _mat.M42, _mat.M43);
        Vector3 vLookAt = vPos + vWorldLook;
		
		_basicEffect.View = Matrix.CreateLookAt(vPos, vLookAt, vUp * 1);
	}
	
	public void SetWorld(float px, float py, float pz, float rx, float ry, float rz, float sx, float sy, float sz)
	{
		var _mat = Matrix.Identity;
			
		Utility.MatrixTranslate(ref _mat, new Vector3(px,py,pz));
        Utility.MatrixRotate(ref _mat, new Vector3(rx,ry,rz));
        Utility.MatrixScale(ref _mat, new Vector3(sx,sy,sz));
		
		_basicEffect.World = _mat;
	}
};

public class XNAEffect
{
	public Effect _effect;
	public XNAGraphicsDevice _device;
	
	public XNAEffectTechnique _curentTechnique;
	public Dictionary&lt;string,XNAEffectTechnique&gt; _techniques = new Dictionary&lt;string,XNAEffectTechnique&gt;();
	public Dictionary&lt;string,XNAEffectParameter&gt; _parameters = new Dictionary&lt;string,XNAEffectParameter&gt;();
	
	public XNAEffect(Effect effect,XNAGraphicsDevice device)
	{
		_effect = effect;
		_device = device;
		
		foreach(var technique in _effect.Techniques)
        {
			_techniques.Add(  technique.Name ,new XNAEffectTechnique(technique) );
        }
		
		foreach(var parameter in _effect.Parameters)
        {
			_parameters.Add(  parameter.Name ,new XNAEffectParameter(parameter) );
        }
		
		SetCurrentTechnique(_techniques[_effect.CurrentTechnique.Name]);
	}
		
	public XNAEffectTechnique GetCurrentTechnique()
	{
		return _curentTechnique;
	}
	
	public void SetCurrentTechnique(XNAEffectTechnique technique)
	{
		_curentTechnique = technique;
		_effect.CurrentTechnique = technique._technique;
	}
	
	public XNAGraphicsDevice GetGraphicsDevice()
	{
		return this._device;
	}
	
	public string GetName()
	{
		return _effect.Name;
	}
	
	public XNAEffectParameter GetParameter(string name) 
	{
		return _parameters[name];
	}
	
	public int CountParameters() 
	{
		return _parameters.Count;
	}
	
	public XNAEffectTechnique GetTechnique(string name) 
	{
		return _techniques[name];
	}
	
	public int CountTechniques() 
	{
		return _techniques.Count;
	}	
};


public class XNAEffectTechnique
{
	public EffectTechnique _technique;
	public XNAEffectPass[] _passes;
	
	public XNAEffectTechnique(EffectTechnique technique) 
	{
		_technique = technique;
		_passes = new XNAEffectPass[_technique.Passes.Count];
		for( int i = 0; i&lt; _technique.Passes.Count; ++i)
		{
			_passes[i] = new XNAEffectPass(_technique.Passes[i]);
		}
	}
	
	public string GetName()
	{
		return _technique.Name;
	}
	
	public XNAEffectPass[] GetPasses()
	{
		return _passes;
	}
}

public class XNAEffectPass
{
	public EffectPass _pass;
	
	public XNAEffectPass(EffectPass pass)
	{
		_pass = pass;
	}
	
	public string GetName()
	{
		return _pass.Name;
	}
	
	public void Apply()
	{
		_pass.Apply();
	}
}

public class XNAEffectParameter
{
	public EffectParameter _parameter;
	
	public XNAEffectParameter(EffectParameter parameter)
	{
		_parameter = parameter;
	}
	
	public int GetParameterClass() 
	{
		return (int)_parameter.ParameterClass;
	}
	
	public int GetParameterType() 
	{
		return (int)_parameter.ParameterType;
	}
	
	public string GetName() 	
	{
		return _parameter.Name;
	}
	
	public string GetSemantic() 	
	{
	    return _parameter.Semantic;
	}
	
	public void  SetValue(bool value)	
	{
		_parameter.SetValue(value);
	}
	
	public void  SetValue(bool[] value)		
	{
		_parameter.SetValue(value);
	}
	
	public void  SetValue(int value)	
	{
		_parameter.SetValue(value);
	}
		
	public void  SetValue(int[] value)	
	{
		_parameter.SetValue(value);
	}
	
	public void  SetValue(float value)	
	{
		_parameter.SetValue(value);
	}
	
	public void  SetValue(float[] value)	
	{
		_parameter.SetValue(value);
	}
	
	public void  SetValue(string value)	
	{
		_parameter.SetValue(value);
	}
	
	public void  SetValue(XNATexture value)	
	{
		_parameter.SetValue(value._texture);
	}
	
	/*
	public void  SetValue(Matrix value)	
	{
		_parameter.SetValue(value);
	}
	
	public void  SetValue(Matrix[] value)	
	{
		_parameter.SetValue(value);
	}
		
	public void  SetValue(Quaternion value)	
	{
		_parameter.SetValue(value);
	}
	
	public void  SetValue(Quaternion[] value)		
	{
		_parameter.SetValue(value);
	}
	
	public void  SetValue(Vector value)	
	{
		_parameter.SetValue(value);
	}
	*/
}

public class XNAColor
{
	public Color _color;
	
	public static XNAColor White()
	{
		return new XNAColor(1,1,1,1);
	}
	
	public static XNAColor Black()
	{
		return new XNAColor(0,0,0,1);
	}
	
	public static XNAColor Red()
	{
		return new XNAColor(1,0,0,1);
	}
	
	public static XNAColor Blue()
	{
		return new XNAColor(0,0,1,1);
	}
	
	public static XNAColor FromARGB(float r, float g, float b, float a)
	{
		return new XNAColor(r,g,b,a);
	}
	
	public XNAColor(float r, float g, float b, float a)
	{
		_color = new Color(r,g,b,a);
	}
	
	public XNAColor(Color color)
	{
		_color = color;
	}
	
	public float GetR()
	{
		return (float)_color.R / 255.0f;
	}
	
	public float GetG()
	{
		return (float)_color.G/ 255.0f;
	}
	
	public float GetB()
	{
		return (float)_color.B/ 255.0f;
	}
	
	public float GetA()
	{
		return (float)_color.A/ 255.0f;
	}
	
	public void SetR(float value)
	{
		_color.R = (byte)(value*255.0f);
	}
	
	public void SetG(float value)
	{
		_color.G = (byte)(value*255.0f);
	}
	
	public void SetB(float value)
	{
		_color.B = (byte)(value*255.0f);
	}
	
	public void SetA(float value)
	{
		_color.A = (byte)(value*255.0f);
	}
}

class XNAMatrix
{
	public Matrix mat;
	
	public XNAMatrix()
	{
		mat = new Matrix();
	}
	
	public static XNAMatrix MatrixIdentity()
	{
		var matrix = new XNAMatrix();
		matrix.mat = Matrix.Identity;
		return matrix;
	}
	
	public static XNAMatrix CreateMatrixA()
	{
		var matrix = new XNAMatrix();
		matrix.mat = new Matrix();
		return matrix;
	}
	
	public static XNAMatrix CreateMatrixB(XNAMatrix mat)
	{
		return null;// Todo
	}
	
	public float GetM11(){return mat.M11;}
	public float GetM12(){return mat.M12;}
	public float GetM13(){return mat.M13;}
	public float GetM14(){return mat.M14;}
	public float GetM21(){return mat.M21;}
	public float GetM22(){return mat.M22;}
	public float GetM23(){return mat.M23;}
	public float GetM24(){return mat.M24;}
	public float GetM31(){return mat.M31;}
	public float GetM32(){return mat.M32;}
	public float GetM33(){return mat.M33;}
	public float GetM34(){return mat.M34;}
	public float GetM41(){return mat.M41;}
	public float GetM42(){return mat.M42;}
	public float GetM43(){return mat.M43;}
	public float GetM44(){return mat.M44;}
	
	public void SetM11(float value){mat.M11 = value;}
	public void SetM12(float value){mat.M12 = value;}
	public void SetM13(float value){mat.M13 = value;}
	public void SetM14(float value){mat.M14 = value;}
	public void SetM21(float value){mat.M21 = value;}
	public void SetM22(float value){mat.M22 = value;}
	public void SetM23(float value){mat.M23 = value;}
	public void SetM24(float value){mat.M24 = value;}
	public void SetM31(float value){mat.M31 = value;}
	public void SetM32(float value){mat.M32 = value;}
	public void SetM33(float value){mat.M33 = value;}
	public void SetM34(float value){mat.M34 = value;}
	public void SetM41(float value){mat.M41 = value;}
	public void SetM42(float value){mat.M42 = value;}
	public void SetM43(float value){mat.M43 = value;}
	public void SetM44(float value){mat.M44 = value;}
	
	public static XNAMatrix CreateMatrixC(XNAMatrix mat)
	{
		var matrix = new XNAMatrix();
		matrix.mat = new Matrix(mat.mat.M11, mat.mat.M12, mat.mat.M13, mat.mat.M14,
                   mat.mat.M21, mat.mat.M22, mat.mat.M23, mat.mat.M24,
                   mat.mat.M31, mat.mat.M32, mat.mat.M33, mat.mat.M34,
                   mat.mat.M41, mat.mat.M42, mat.mat.M43, mat.mat.M44);
		return matrix;
	}
	
	public void Overwrite(XNAMatrix matrix)
	{
		mat.M11 = matrix.mat.M11;
        mat.M12 = matrix.mat.M12;
        mat.M13 = matrix.mat.M13;
        mat.M14 = matrix.mat.M14;
        mat.M21 = matrix.mat.M21;
        mat.M22 = matrix.mat.M22;
        mat.M23 = matrix.mat.M23;
        mat.M24 = matrix.mat.M24;
        mat.M31 = matrix.mat.M31;
        mat.M32 = matrix.mat.M32;
        mat.M33 = matrix.mat.M33;
        mat.M34 = matrix.mat.M34;
        mat.M41 = matrix.mat.M41;
        mat.M42 = matrix.mat.M42;
        mat.M43 = matrix.mat.M43;
        mat.M44 = matrix.mat.M44;
	}
	
	public XNAMatrix Inverse()
	{
		var m = new XNAMatrix();
		m.mat = Matrix.Invert(mat);
		return m;
	}
	
	public XNAMatrix Multiply(XNAMatrix matrix)
	{
		var m = new XNAMatrix();
		m.mat = Matrix.Multiply(mat,matrix.mat);
		return m;
	}
	
	public void Translate(float x,float y,float z)
	{
		mat.M41 += mat.M11 * x + mat.M21 * y + mat.M31 * z;
        mat.M42 += mat.M12 * x + mat.M22 * y + mat.M32 * z;
        mat.M43 += mat.M13 * x + mat.M23 * y + mat.M33 * z;
	}
	
	public void Scale(float x,float y,float z)
	{
		mat.M11 *= x;
        mat.M12 *= x;
        mat.M13 *= x;

        mat.M21 *= y;
        mat.M22 *= y;
        mat.M23 *= y;

        mat.M31 *= z;
        mat.M32 *= z;
        mat.M33 *= z;
	}
	
	public void Rotate(float x,float y,float z)
	{
		 // yaw

        float cos_ang = (float)Utility.Cos((double)y);
        float sin_ang = (float)Utility.Sin((double)y);
	
		float m11 = mat.M11 * cos_ang + mat.M31 * -sin_ang;
		float m12 = mat.M12 * cos_ang + mat.M32 * -sin_ang;
		float m13 = mat.M13 * cos_ang + mat.M33 * -sin_ang;
		
		mat.M31 = mat.M11 * sin_ang + mat.M31 * cos_ang;
		mat.M32 = mat.M12 * sin_ang + mat.M32 * cos_ang;
		mat.M33 = mat.M13 * sin_ang + mat.M33 * cos_ang;

        mat.M11 = m11;
        mat.M12 = m12;
        mat.M13 = m13;
		
  		// pitch

        cos_ang = (float)Utility.Cos((double)x);
        sin_ang = (float)Utility.Sin((double)x);
	
        float m21 = mat.M21 * cos_ang + mat.M31 * sin_ang;
		float m22 = mat.M22 * cos_ang + mat.M32 * sin_ang;
		float m23 = mat.M23 * cos_ang + mat.M33 * sin_ang;
        
        mat.M31 = mat.M21 * -sin_ang + mat.M31 * cos_ang;
		mat.M32 = mat.M22 * -sin_ang + mat.M32 * cos_ang;
		mat.M33 = mat.M23 * -sin_ang + mat.M33 * cos_ang;
		
		mat.M21=m21;
		mat.M22=m22;
		mat.M23=m23;
		
  		// roll

        cos_ang = (float)Utility.Cos((double)z);
        sin_ang = (float)Utility.Sin((double)z);

		m11 = mat.M11 * cos_ang + mat.M21 * sin_ang;
		m12 = mat.M12 * cos_ang + mat.M22 * sin_ang;
		m13 = mat.M13 * cos_ang + mat.M23 * sin_ang;
		
		mat.M21 = mat.M11 * -sin_ang + mat.M21 * cos_ang;
		mat.M22 = mat.M12 * -sin_ang + mat.M22 * cos_ang;
		mat.M23 = mat.M13 * -sin_ang + mat.M23 * cos_ang;
		
		mat.M11 = m11;
		mat.M12 = m12;
        mat.M13 = m13;
	}
	
	public void RotatePitch(float ang)
	{
		float cos_ang = (float)Utility.Cos((double)ang);
        float sin_ang = (float)Utility.Sin((double)ang);
	
        float m21 = mat.M21 * cos_ang + mat.M31 * sin_ang;
		float m22 = mat.M22 * cos_ang + mat.M32 * sin_ang;
		float m23 = mat.M23 * cos_ang + mat.M33 * sin_ang;
        
        mat.M31 = mat.M21 * -sin_ang + mat.M31 * cos_ang;
		mat.M32 = mat.M22 * -sin_ang + mat.M32 * cos_ang;
		mat.M33 = mat.M23 * -sin_ang + mat.M33 * cos_ang;
		
		mat.M21=m21;
		mat.M22=m22;
		mat.M23=m23;
	}
	
	public void RotateYaw(float ang)
	{
		float cos_ang = (float)Utility.Cos((double)ang);
        float sin_ang = (float)Utility.Sin((double)ang);
	
		float m11 = mat.M11 * cos_ang + mat.M31 * -sin_ang;
		float m12 = mat.M12 * cos_ang + mat.M32 * -sin_ang;
		float m13 = mat.M13 * cos_ang + mat.M33 * -sin_ang;
		
		mat.M31 = mat.M11 * sin_ang + mat.M31 * cos_ang;
		mat.M32 = mat.M12 * sin_ang + mat.M32 * cos_ang;
		mat.M33 = mat.M13 * sin_ang + mat.M33 * cos_ang;

        mat.M11 = m11;
        mat.M12 = m12;
        mat.M13 = m13;
	}
	
	public void RotateRoll(float ang) 
	{
		float cos_ang = (float)Utility.Cos((double)ang);
        float sin_ang = (float)Utility.Sin((double)ang);

		float m11 = mat.M11 * cos_ang + mat.M21 * sin_ang;
		float m12 = mat.M12 * cos_ang + mat.M22 * sin_ang;
		float m13 = mat.M13 * cos_ang + mat.M23 * sin_ang;
		
		mat.M21 = mat.M11 * -sin_ang + mat.M21 * cos_ang;
		mat.M22 = mat.M12 * -sin_ang + mat.M22 * cos_ang;
		mat.M23 = mat.M13 * -sin_ang + mat.M23 * cos_ang;
		
		mat.M11 = m11;
		mat.M12 = m12;
        mat.M13 = m13;
	}
}

public class XNAViewport
{
    public Viewport _viewport;

    public XNAViewport(int x, int y, int width, int height)
    {
        _viewport = new Viewport(x, y, width, height);
    }

    public static XNAViewport Create(int x, int y, int width, int height)
    {
        return new XNAViewport(x, y, width, height);
    }

    public float getAspectRatio()
    {
        return _viewport.AspectRatio;
    }

    public int getX()
    {
        return _viewport.X;
    }

    public int getY()
    {
        return _viewport.Y;
    }

    public int getWidth()
    {
        return _viewport.Width;
    }

    public int getHeight()
    {
        return _viewport.Height;
    }

    public void setX(int value)
    {
        _viewport.X = value;
    }

    public void setY(int value)
    {
        _viewport.Y = value;
    }

    public void setWidth(int value)
    {
        _viewport.Width = value;
    }

    public void setHeight(int value)
    {
        _viewport.Height = value;
    }

    public float getMaxDepth()
    {
        return _viewport.MaxDepth;
    }

    public float getMinDepth()
    {
        return _viewport.MaxDepth;
    }

    public void setMaxDepth(float value)
    {
        _viewport.MaxDepth = value;
    }

    public void setMinDepth(float value)
    {
        _viewport.MinDepth = value;
    }
}


public class DataBuffer
{

    public byte[] _data;
    int _length;

    public DataBuffer(int length)
    {
        _data = new byte[length];
        _length = length;
    }
	
	public DataBuffer(byte[] data)
    {
        _data = data;
        _length = data.Length;
    }
	
    public int Size()
    {
        return _length;
    }

    public void Discard()
    {
        if (_data != null)
        {
            _data = null;
            _length = 0;
        }
    }

    public void PokeByte(int addr, int value)
    {
        _data[addr] = (byte)value;
    }

    public void PokeShort(int addr, int value)
    {
        Array.Copy(System.BitConverter.GetBytes((short)value), 0, _data, addr, 2);
    }

    public void PokeInt(int addr, int value)
    {
        Array.Copy(System.BitConverter.GetBytes(value), 0, _data, addr, 4);
    }

    public void PokeFloat(int addr, float value)
    {
        Array.Copy(System.BitConverter.GetBytes(value), 0, _data, addr, 4);
    }

    public int PeekByte(int addr)
    {
        return (int)_data[addr];
    }

    public int PeekShort(int addr)
    {
        return (int)System.BitConverter.ToInt16(_data, addr);
    }

    public int PeekInt(int addr)
    {
        return System.BitConverter.ToInt32(_data, addr);
    }

    public float PeekFloat(int addr)
    {
        return (float)System.BitConverter.ToSingle(_data, addr);
    }

    public static DataBuffer Create(int length)
    {
        return new DataBuffer(length);
    }
	
	public static DataBuffer LoadImageData(string path, int[] info)
	{
		var texture = MonkeyData.LoadTexture2D(path, gxtkApp.game.Content);
        int size = texture.Width * texture.Height * 4;

		info[0] = texture.Width;
		info[1] = texture.Height;
		
		var buffer = new DataBuffer(size);
        texture.GetData&lt;byte&gt;(buffer._data, 0, size);

		
        return buffer;
	}
}
</textarea> <br><br></td></tr></table><br>
<a name="2030978"></a>

<a name="2030936"></a>

<a name="2030934"></a>

<a name="2030932"></a>

<a name="2030930"></a>

<a name="2030927"></a>

<a name="2030924"></a>

<a name="2030923"></a>

<a name="2030980"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rone</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#50">[#50]</a></td></tr></table></td></tr><tr ><td class="posttext"> xna_render.monkey<br><textarea class=codebox name="code" wrap=OFF readonly="true" rows="15" cols="80">
' Author: Sascha Schmidt

Import mojo
Import xna 
Import trender
Import minib3d


#rem

Notes:
------------------------------------------------------------------------------------------------------------------------
Hardare caps		-	<a href="http://msdn.microsoft.com/en-us/library/ff604995.aspx" target="_blank">http://msdn.microsoft.com/en-us/library/ff604995.aspx</a>

ttext				- 	Does not work, not yet checked...

Multitexture		-	BasicEffect sucks!

TextureTrans		-	SamplerState?

TextureFilter		-	SamplerState?

BindTexture 		-  	<a href="http://msdn.microsoft.com/en-us/library/bb198834" target="_blank">http://msdn.microsoft.com/en-us/library/bb198834</a> Reconsider the minib3d content pipeline.

Second textcoords	-	Needs custom vertex declaration

fx flag 2 			- 	vertex colors: needs custom vertex declaration.(Effect.VertexColorEnabled)

fx flag 4 			- 	flatshaded: Does BasicEffect suport this? PerPixelLightning can be supported easyly.

fx flag 32 			- 	force alpha ?

Lightning			-  	No custom effects in xna reach profile, so only the 3 directional light from basiceffect
  						DisableLight &amp; UpdateLight needs to be reimplemented - just a test at the moment
						
UpdateVBo 			- 	Needs to be optimized when VertexBuffer and IndexBuffer is added to xna.monkey.
	      				Current solution is just an hasty reaction...

SpriteBatch			-	Not implplemented. Check XNA SpriteBatch Class: <a href="http://msdn.microsoft.com/en-us/library/microsoft.xna.framework.graphics.spritebatch" target="_blank">http://msdn.microsoft.com/en-us/library/microsoft.xna.framework.graphics.spritebatch</a>

#end 

#MINIB3D_DRIVER="xna"

Const VBO_MIN_TRIS=10


Class XNARender Extends TRender
	
Private

	Field _device				:XNAGraphicsDevice 
	Field _blendStates			:XNABlendState[] 
	Field _rasterizerStates		:XNARasterizerState[]
	Field _depthStencilDefault	:XNADepthStencilState
	Field _depthStencilNone		:XNADepthStencilState
	Field _basicEffect			:XNABasicEffect 
		
	Field _textures:= new IntMap&lt;XNATexture&gt;
	Field _meshes:= new IntMap&lt;XNAMesh&gt;
	Field _lights:TLight[3]
	Field _xna_lights:XNADirectionalLight[3]
	
	Field _alpha_list:= new List&lt;TSurface&gt; 
	field _red#,_green#,_blue#,_alpha#,_shine#,_blend%,_fx%
	Field _mesh_id, _texture_id, _light_no
	Field _last_texture:TTexture
	
Public 
		
	Method New()
		_device 				= New XNAGraphicsDevice 
		_basicEffect			= _device.CreateBasicEffect()
		_xna_lights[0] 			= _basicEffect.DirectionalLight0 
		_xna_lights[1] 			= _basicEffect.DirectionalLight1 
		_xna_lights[2] 			= _basicEffect.DirectionalLight2 
		_blendStates 			= [XNABlendState.AlphaBlend, XNABlendState.AlphaBlend, XNABlendState.Premultiplied, XNABlendState.Additive, XNABlendState.Opaque]
		_rasterizerStates 		= [XNARasterizerState.CullNone, XNARasterizerState.CullCounterClockwise,XNARasterizerState.CullClockwise ]
		_depthStencilDefault 	= XNADepthStencilState._Default
		_depthStencilNone 		= XNADepthStencilState.None
	End
	
	Method GetVersion:Float()
		Return 4.0
	End

	Method GraphicsInit(flags:Int=0)
		Reset()
		TLight.max_lights = 3
		width = DeviceWidth
		height = DeviceHeight 
		vbo_enabled = True 
	End
	
	Method Reset:Void()
		TRender.alpha_pass = 0
		
		_last_texture = null
		_lights[0] = null
		_lights[1] = null
		_lights[2] = null
		_device.DepthStencilState = _depthStencilDefault	
		_basicEffect.FogEnabled = False
		_basicEffect.LightingEnabled = True
		_basicEffect.TextureEnabled = false
	End
	
	Method Render:Void(ent:TEntity, cam:TCamera = Null)
	
		Local mesh:TMesh = TMesh(ent)
		If Not mesh Then Return
		
		Local anim_surf2:TSurface
		Local ccc:Int=0 ''counter for debugging
		
		'' draw surfaces with alpha last
		Local temp_list:List&lt;TSurface&gt; = mesh.surf_list
		_alpha_list.Clear()
	
		''run through surfaces twice, sort alpha surfaces for second pass
		For Local alphaloop:= alpha_pass To 1 ''if alpha_pass is on, no need to reorder alpha surfs
			
			For Local surf:TSurface =Eachin temp_list
				ccc +=1
	
				''draw alpha surfaces last in second loop
				''also catch surfaces with no vertex
				If surf.no_verts=0 Then Continue
				If (surf.alpha_enable And alphaloop &lt; 1)
					_alpha_list.AddLast(surf)				
					Continue
				Endif
				
				
				Local vbo:Int=False
				If vbo_enabled
					vbo=True
				Else
					' if surf no longer has required no of tris then free vbo
					If surf.vbo_id[0]&lt;&gt;0 
						FreeVBO(surf)
					Endif
				Endif
	
				' update surf vbo if necessary
				If vbo
					
					' update vbo
					If surf.reset_vbo&lt;&gt;0
						UpdateVBO(surf)
					Else If surf.vbo_id[0]=0 ' no vbo - unknown reason
						surf.reset_vbo=-1
						UpdateVBO(surf)
					Endif
					
				Endif
				
				If mesh.anim
			
					' get anim_surf
					anim_surf2 = mesh.anim_surf[surf.surf_id] ''(edit 2012)
					
					If vbo
					
						' update vbo
						If anim_surf2.reset_vbo&lt;&gt;0
							UpdateVBO(anim_surf2)
						Else If anim_surf2.vbo_id[0]=0 ' no vbo - unknown reason
							anim_surf2.reset_vbo=-1
							UpdateVBO(anim_surf2)
						Endif
					
					Endif
					
				Endif
		
				' update brush
				BindBrush(ent,surf) 
				
				' update textures
				SetTextures( ent, surf)
	
				' Mesh Transform
				_basicEffect.World(
						ent.EntityX(true), ent.EntityY(true), ent.EntityZ(true), 
						ent.EntityPitch(True), ent.EntityYaw(True), ent.EntityRoll(True),
						ent.EntityScaleX(True), ent.EntityScaleY(True), ent.EntityScaleZ(True))
						
				_basicEffect.CurrentTechnique.Passes[0].Apply()

				' draw tris
				If mesh.anim
					
					Local mesh:= _meshes.Get(mesh.anim_surf[surf.surf_id].vbo_id[0])
					mesh.Bind()
					mesh.Render()
				
				Else
					Local mesh:= _meshes.Get(surf.vbo_id[0])
					mesh.Bind()
					mesh.Render()
				End
				
			Next 
		
			If Not _alpha_list Then Exit ''get out of loop, no alpha
			temp_list = _alpha_list
			
		Next	''end alpha loop
			
		temp_list = Null	
	End

	Method Finish:Void()
	End
	
	Method EnableStates:Void()
	End 

	Method UpdateVBO:Int(surf:TSurface)
	
		Local m:XNAMesh = null
		
		If surf.vbo_id[0]=0
			_mesh_id+=1
			 surf.vbo_id[0] = _mesh_id
			m = _device.CreateMesh()
			_meshes.Set(_mesh_id,m)
		Endif
		
		If Not m Then 
			m = _meshes.Get (surf.vbo_id[0])
		End

		If surf.reset_vbo=-1 Then surf.reset_vbo=255
			
		If surf.reset_vbo Then 
			m.Clear()
			UpdateXNAMesh(m, surf)
			m.Update()
		End
		
		If surf.reset_vbo&amp;1
		Endif
		'If GetGLError() Then Print "vertcoords"
		
		If surf.reset_vbo&amp;2
		Endif
		'If GetGLError() Then Print "verttexcords"
		
		If surf.reset_vbo&amp;4
		Endif
		'If GetGLError() Then Print "vertnorm"
		
		If surf.reset_vbo&amp;8
		Endif
		'If GetGLError() Then Print "vertcol"	
		
		If surf.reset_vbo&amp;16
		Endif
		'If GetGLError() Then Print "verttris"
		
		surf.reset_vbo=False
	End
	
	Method FreeVBO(surf:TSurface)
		If surf.vbo_id[0]&lt;&gt;0 
			Local m := _meshes.Get(surf.vbo_id[0])
			m.Clear()
		Endif
	End 

	
	'' --- TTexture specific---
	
	Method DeleteTexture(glid:Int[])
		If _textures.Contains (glid[0]) Then 
			_textures.Remove(glid[0])
		End 
	End
	
	
	Method IsPowerOfTwo?(x)
	    return (x &lt;&gt; 0) And ((x &amp; (x - 1)) = 0)
	End
	
	' Caution
	' Here is a tip for rendering objects within the Draw method of an Xbox 360 game. 
	' Do not use SetData when writing data to vertex buffers, index buffers, and textures. 
	' This method may lead to graphics corruption or crashes: <a href="http://msdn.microsoft.com/en-us/library/bb198834" target="_blank">http://msdn.microsoft.com/en-us/library/bb198834</a>
	'
	' Instead of using setData here, its recommended to reconsider the minib3d content pipeline
	' and use _device.LoadTexture( tex.file )...
	Method BindTexture:TTexture(tex:TTexture,flags:Int)
	
		' if mask flag is true, mask pixmap
		If tex.flags&amp;4
			tex.pixmap.MaskPixmap(0,0,0)
		Endif

		' pixmap -&gt; tex

		Local width=tex.pixmap.width
		Local height=tex.pixmap.height
		
		' TODO: Check max cubemap texture size
		
		If width &gt; 2048 Or height &gt; 2048 Then 
			Error "Exceeded Maximum texture size of 2048: " + tex.file
		End 
		
		Local mipmap:Int= 0, mip_level:Int=0
		If tex.flags&amp;8 Then mipmap=True
		If Not( IsPowerOfTwo(width) Or IsPowerOfTwo(height) ) Then 
			mipmap=False
			' TODO: Handle also no wrap addressing mode, no DXT compression on nonpower of two textures.
		End 
		
		If tex.gltex[0] = 0 then 
			_texture_id+=1
			tex.gltex[0] = _texture_id
		End 
			
		local t:= _device.CreateTexture(tex.pixmap.width, tex.pixmap.height,mipmap = True, -1 )
		If t Then 
			_textures.Set( tex.gltex[0], t ) 
		End 
		
		Repeat
		
			t.SetData(mip_level, tex.pixmap.pixels, 0, tex.pixmap.pixels.Size)
			
			If Not mipmap Or (width=1 And height =1) Then Exit
			If width&gt;1 width *= 0.5
			If height&gt;1 height *= 0.5

			If tex.resize_smooth Then 
				tex.pixmap=tex.pixmap.ResizePixmap(width,height) 
			Else 
				tex.pixmap=tex.pixmap.ResizePixmapNoSmooth(width,height)
			End
			mip_level+=1
			
		Forever
			
		tex.no_mipmaps=mip_level
		
		Return tex		
		
	End
	
	Method DisableLight(light:TLight)
		For Local i = 0 until 3
			If _lights[i] = light Then 
				SetLightEnable(i,false)
			End
		Next
	End
	
	Method SetLightEnable(id, enable?)
		_xna_lights[id].Enabled = enable
	End
	
	Method SetLight(id, dirX#, dirY#, dirZ#, r#, g#, b#)
		_xna_lights[id].Direction(dirX, dirY, dirZ);
        _xna_lights[id].DiffuseColor(r,g,b);
    End

	Method UpdateLight(cam:TCamera,light:TLight)
		_light_no=_light_no+1
		If _light_no&gt;light.no_lights Then _light_no=0
		_lights[_light_no] = light
		
		If light.Hidden()
			SetLightEnable(_light_no,false)
		Else
			SetLightEnable(_light_no,True)
			SetLight(_light_no, 1,-1,1,light.red,light.green,light.blue)' TODO:dir
		Endif
	End

	Method UpdateCamera(cam:TCamera)
	
		' viewport
		_device.Viewport(cam.vx,cam.vy,cam.vwidth,cam.vheight)
		
		' clear buffers
		_device.ClearScreen(cam.cls_r,cam.cls_g,cam.cls_b, cam.cls_color=True, cam.cls_zbuffer=True, False )
		
		' set view matrix
		_basicEffect.View(
			cam.EntityX(true), cam.EntityY(true), cam.EntityZ(true), 
			cam.EntityPitch(True), cam.EntityYaw(True), cam.EntityRoll(True), 
			cam.EntityScaleX(True), cam.EntityScaleY(True), -cam.EntityScaleZ(True))
			
		' set projection
		_basicEffect.Projection(cam.fov_y, cam.aspect, cam.range_near , cam.range_far)
	
		'fog
		If cam.fog_mode&gt;0
			_basicEffect.FogEnabled = true
			_basicEffect.FogStart = cam.fog_range_near
	        _basicEffect.FogEnd = cam.fog_range_far
	        _basicEffect.FogColor(cam.fog_r,cam.fog_g,cam.fog_b)
		Else
			_basicEffect.FogEnabled = False 
		Endif
	End
	
	Method BackBufferToTex(mipmap_no=0,frame=0)
	End 
	
	Method UpdateXNAMesh(mesh:XNAMesh,surf1:TSurface)
		
		Local tri_offset:Int = 0
			
		' add vertices
		Local s1v:Int = surf1.CountVertices()		
		For Local v:Int=0 To s1v-1

			Local vx#=surf1.VertexX(v)
			Local vy#=surf1.VertexY(v)
			Local vz#=surf1.VertexZ(v)
			Local vr#=surf1.VertexRed(v)
			Local vg#=surf1.VertexGreen(v)
			Local vb#=surf1.VertexBlue(v)
			Local va#=surf1.VertexAlpha(v)
			Local vnx#=surf1.VertexNX(v)
			Local vny#=surf1.VertexNY(v)
			Local vnz#=surf1.VertexNZ(v)
			Local vu0#=surf1.VertexU(v,0)
			Local vv0#=surf1.VertexV(v,0)
			Local vw0#=surf1.VertexW(v,0)
			Local vu1#=surf1.VertexU(v,1)
			Local vv1#=surf1.VertexV(v,1)
			Local vw1#=surf1.VertexW(v,1)
			
			mesh.AddVertex(vx,vy,vz, vnx,vny,vnz, vu0,vv0 )
		Next
	
		' add triangles

		For Local t=0 To surf1.CountTriangles()-1
			Local v0=surf1.TriangleVertex(t,0) + tri_offset
			Local v1=surf1.TriangleVertex(t,1) + tri_offset
			Local v2=surf1.TriangleVertex(t,2) + tri_offset
			
			mesh.AddTriangle(v0,v1,v2)
		Next
	End
	
	Method CombineBrushes(brushA:TBrush,brushB:TBrush )

		' get main brush values
		_red   = brushA.red
		_green = brushA.green
		_blue  = brushA.blue
		_alpha = brushA.alpha
		_shine = brushA.shine
		_blend = brushA.blend
		_fx    = brushA.fx
		
		' combine surface brush values with main brush values
		If brushB

			Local shine2#=0.0

			_red   =_red  *brushB.red
			_green =_green*brushB.green
			_blue  =_blue *brushB.blue
			_alpha =_alpha *brushB.alpha
			shine2=brushB.shine
			If _shine=0.0 Then _shine=shine2
			If _shine&lt;&gt;0.0 And shine2&lt;&gt;0.0 Then _shine=_shine*shine2
			If _blend=0 Then _blend=brushB.blend ' overwrite master brush if master brush blend=0
			_fx=_fx|brushB.fx
		
		Endif
	End
	
	Method ResetBrush()
		If fx&amp;8
			_basicEffect.FogEnabled = true
		Endif	
	End
	
	Method BindBrush(ent:TEntity, surf:TSurface)
		
		CombineBrushes(ent.brush, surf.brush)
		
		' color
		_basicEffect.DiffuseColor(_red,_green,_blue);
        _basicEffect.Alpha = _alpha;
		
		' shininess
		_basicEffect.SpecularPower(_shine)
		
		' fx flag 1 - full bright ***todo*** disable all lights?
		If _fx&amp;1 then 
			_basicEffect.AmbientLightColor(1,1,1) 
		Else 
			_basicEffect.AmbientLightColor(TLight.ambient_red, TLight.ambient_green, TLight.ambient_blue)
		End 

		' fx flag 2 - vertex colors 

		' fx flag 4 - flatshaded

		' fx flag 8 - disable fog
		If _fx&amp;8 then 
			_basicEffect.FogEnabled = False 
		End 
		
		'-----
		
		' fx flag 16 - disable backface culling
		If _fx&amp;16 then 
			_device.RasterizerState = _rasterizerStates[0] 
		Else 
			_device.RasterizerState = _rasterizerStates[2]
		End 

		'' fx flag 32 - force alpha
		
		'' fx flag 64 - disable depth testing (new 2012)
		If _fx&amp;64 then 
			_device.DepthStencilState = _depthStencilNone 
		Else
			_device.DepthStencilState = _depthStencilDefault
		End 

		' take into account auto fade alpha
		_alpha=_alpha-ent.fade_alpha
		' if surface contains alpha info, enable blending
		If ent.alpha_order&lt;&gt;0.0 Or surf.alpha_enable=True
			_device.DepthStencilState = _depthStencilNone 
		Else
			_device.DepthStencilState = _depthStencilDefault
		Endif	
		
		' blend mode
		_device.BlendState = _blendStates[_blend]
	End
	
	Method SetTextures(ent:TEntity, surf:TSurface)
	
		Local tex_count=ent.brush.no_texs
		If surf.brush.no_texs&gt;tex_count Then 
			tex_count=surf.brush.no_texs
		End 
		
		'' turn off textures if no textures
		If tex_count = 0
			_basicEffect.TextureEnabled = false
		else
				
			For Local ix=0 until tex_count			
	
				If surf.brush.tex[ix]&lt;&gt;Null Or ent.brush.tex[ix]&lt;&gt;Null
					
					Local texture:TTexture,tex_flags,tex_blend,tex_coords,tex_u_scale#,tex_v_scale#
					Local tex_u_pos#,tex_v_pos#,tex_ang#,tex_cube_mode,frame, tex_smooth
	
					' Main brush texture takes precedent over surface brush texture
					If ent.brush.tex[ix]&lt;&gt;Null
						texture=ent.brush.tex[ix]
						frame=ent.brush.tex[ix].tex_frame	
					Else
						texture=surf.brush.tex[ix]
						frame=surf.brush.tex[ix].tex_frame		
					Endif
	
					''preserve texture states--------------------------------------
					If (surf.brush.tex[ix] And _last_texture &lt;&gt; surf.brush.tex[ix]) Or
					    (ent.brush.tex[ix] And _last_texture &lt;&gt; ent.brush.tex[ix])
						
						If ent.brush.tex[ix] Then 
							_last_texture = ent.brush.tex[ix] 
						Else 
							_last_texture = surf.brush.tex[ix]
						End 
							
						_basicEffect.TextureEnabled = true
					 	_basicEffect.Texture = _textures.Get(texture.gltex[0])
						Return 
					Endif 
					
					Exit ' only one texture with basiceffect
				Endif ''end if tex[ix]
			
			Next 'end texture loop
		End
		
	End 
		
End
</textarea><br><br>Suggestions are welcome.<br><br>RONE <br><br></td></tr></table><br>
<a name="2030933"></a>

<a name="2030931"></a>

<a name="2030928"></a>

<a name="2030929"></a>

<a name="2030925"></a>

<a name="2030944"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >AdamRedwoods</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#51">[#51]</a></td></tr></table></td></tr><tr ><td class="posttext"> AWESOME! Can't wait to try this out later this week.<br><br>re:TLight-- updated github to remove that import (residual leftovers).<br><br>re:TRender-- yeah, i wish there was a better way to seamlessly add in new targets, if anyone has a suggestion, i can add it in.<br><br>great stuff! <br><br></td></tr></table><br>
<a name="2030982"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rone</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#52">[#52]</a></td></tr></table></td></tr><tr ><td class="posttext"> Updated xna.monkey:<br><br><textarea class=codebox name="code" wrap=OFF readonly="true" rows="15" cols="80">
' Module xna
' Version: 0.10
' Author: Sascha Schmidt

Import mojo

Import "native/xna.${TARGET}.${LANG}"

' Defines classes that can be used for effect parameters or shader constants.
Const EFFECT_PARAMETER_CLASS_MATRIX 	= 0
Const EFFECT_PARAMETER_CLASS_OBJECT 	= 1
Const EFFECT_PARAMETER_CLASS_SCALAR 	= 2
Const EFFECT_PARAMETER_CLASS_STRUCT 	= 3
Const EFFECT_PARAMETER_CLASS_VECTOR 	= 4

' Defines types that can be used for effect parameters or shader constants.
Const EFFECT_PARAMETER_TYPE_BOOL 		= 0
Const EFFECT_PARAMETER_TYPE_INT32 		= 1
Const EFFECT_PARAMETER_TYPE_SINGLE 		= 2
Const EFFECT_PARAMETER_TYPE_STRING 		= 3
Const EFFECT_PARAMETER_TYPE_TEXTURE 	= 4
Const EFFECT_PARAMETER_TYPE_TEXTURE1D	= 5
Const EFFECT_PARAMETER_TYPE_TEXTURE2D	= 6
Const EFFECT_PARAMETER_TYPE_TEXTURE3D	= 7
Const EFFECT_PARAMETER_TYPE_TEXTURECUBE	= 8
Const EFFECT_PARAMETER_TYPE_VOID 		= 9

Const BLENDFUNCTION_ADD = 0
Const BLENDFUNCTION_SUBSTRACT = 1
Const BLENDFUNCTION_REVERSESUBSTRACT = 2
Const BLENDFUNCTION_MIN = 3
Const BLENDFUNCTION_MAX = 4

' Defines color blending factors.
Const BLEND_One = 0
Const BLEND_Zero = 1
Const BLEND_SourceColor = 2
Const BLEND_InverseSourceColor = 3
Const BLEND_SourceAlpha = 4
Const BLEND_InverseSourceAlpha = 5
Const BLEND_DestinationColor = 6
Const BLEND_InverseDestinationColor = 7
Const BLEND_DestinationAlpha = 8
Const BLEND_InverseDestinationAlpha = 9
Const BLEND_BlendFactor = 10
Const BLEND_InverseBlendFactor = 11
Const BLEND_SourceAlphaSaturation = 12

const CullMode_None = 0
const CullMode_CullClockwiseFace = 1
const CullMode_CullCounterClockwiseFace = 2

Const FillMode_Solid = 0
Const FillMode_WireFrame = 1

Const TextureAddressMode_Wrap = 0
Const TextureAddressMode_Clamp = 1
Const TextureAddressMode_Mirror = 2

Const TextureFilter_Linear = 0
Const TextureFilter_Point = 1
Const TextureFilter_Anisotropic = 2
Const TextureFilter_LinearMipPoint = 3
Const TextureFilter_PointMipLinear = 4
Const TextureFilter_MinLinearMagPointMipLinear = 5
Const TextureFilter_MinLinearMagPointMipPoint = 6
Const TextureFilter_MinPointMagLinearMipLinear = 7
Const TextureFilter_MinPointMagLinearMipPoint = 8

' Defines stencil buffer operations.
Const StencilOperation_Keep = 0
Const StencilOperation_Zero = 1
Const StencilOperation_Replace = 2
Const StencilOperation_Increment = 3
Const StencilOperation_Decrement = 4
Const StencilOperation_IncrementSaturation = 5
Const StencilOperation_DecrementSaturation = 6
Const StencilOperation_Invert = 7

' Defines comparison functions that can be chosen for alpha, stencil, or depth-buffer tests.
Const CompareFunction_Always = 0
Const CompareFunction_Never = 1
Const CompareFunction_Less = 2
Const CompareFunction_LessEqual = 3
Const CompareFunction_Equal = 4
Const CompareFunction_GreaterEqual = 5
Const CompareFunction_Greater = 6
Const CompareFunction_NotEqual = 7

Const PlaneIntersectionType_Back = 1
Const PlaneIntersectionType_Front = 2
Const PlaneIntersectionType_Intersecting = 3

Const BUFFERUSAGE_NONE 					= 0
Const BUFFERUSAGE_WRITEONLY 			= 1

Const VERTEX_POSITION_COLOR 			= 0
Const VERTEX_POSITION_COLOR_TEXTURE 	= 1
Const VERTEX_POSITION_NORMAL_TEXTURE 	= 2
Const VERTEX_POSITION_TEXTURE 			= 3

Extern

'----------------------------------------------------------------------------------------------------------
' Defines a plane.
' TODO: Needs to be implemented
Class XNAPlane = "XNAPlane"
	Method D:Vector4() Property = "GetD"
	Method Normal:Vector() Property = "GetNormal"
	Method DotNormal:Vector() Property = "GetDotNormal"
	Method DorCoordinate(v:Vector) = "DorCoordinateA"
	Method DorCoordinate(v:Vector, v2#) = "DorCoordinateB"	
	Method Equals?(p:Plane ) = "Equals"
	Method Intersects?(value:BoundingBox) = "IntersectsBox"
	Method Intersects?(value:BoundingBox, containmentType) = "IntersectsBox2"
	Method Intersects?(value:BoundingSphere) = "IntersectsSphere"
	Method Intersects?(value:BoundingSphere, containmentType) = "IntersectsSphere2"
	Method Intersects?(value:BoundingFrustum) = "IntersectsFrustum"
	Method Normalize() = "NormalizeA"
	Method Normalize(p:Plane) = "NormalizeB"
	Method Normalize(p:Plane, q:Plane) = "NormalizeC"
	
	Function Create:XNAPlane(v1#,v2#,v3#,v4#) = "XNAPlane.CreateA"
	Function Create:XNAPlane(v1:Vector, v2#) = "XNAPlane.CreateB"
	Function Create:XNAPlane(v1:Vector,v2:Vector,v3:Vector) = "XNAPlane.CreateC"
	Function Create:XNAPlane(v1:Vector4) = "XNAPlane.CreateD"
End



'----------------------------------------------------------------------------------------------------------
' Defines an axis-aligned box-shaped 3D volume.
' TODO: Needs to be implemented
Class XNABoundingBox = "XNABoundingBox"
	Method CornerCount%() Property = "GetConrnerCount"
	Method Min:Vector() Property = "GetMin"
	Method Max:Vector() Property = "GetMax"
	Method Intersects?(value:BoundingBox) = "IntersectsBox"
	Method Intersects?(value:BoundingSphere) = "IntersectsSphere"
	Method Intersects?(value:BoundingFrustum) = "IntersectsFrustum"
	Method Intersects?(value:Plane) = "IntersectsPlane"
	Method Contains?(value:BoundingBox) = "ContainsBox"
	Method Contains?(value:BoundingBox, containmentType) = "ContainsBox2"
	Method Contains?(value:BoundingSphere) = "ContainsSphere"
	Method Contains?(value:BoundingSphere, containmentType) = "ContainsSphere2"
	Method Contains?(value:BoundingFrustum) = "ContainsFrustum"
	Method Contains?(value:Vector,containmentType) = "ContainsVector"
	
	function Create:XNABoundingBox(min:Vector,max:Vector) = "XNABoundingBox.Create"
	function CreateFromBoundingSphere:XNABoundingBox(box:XNABoundingSphere) = "XNABoundingBox.CreateFromBoundingSphere"
	function CreateFromFrustum:XNABoundingBox(frustum:XNABoundingFrustum) = "XNABoundingBox.CreateFromFrustum"
	function CreateFromPoints:XNABoundingBox(points:Vector[]) = "XNABoundingBox.CreateFromPoints"
	function CreateMerged:XNABoundingBox(a:XNABoundingBox, b:XNABoundingBox) = "XNABoundingBox.CreateMerged"
	function Op_Equality?(a:XNABoundingBox, b:XNABoundingBox) = "XNABoundingBox.op_Equality"
	function Op_Inequality?(a:XNABoundingBox, b:XNABoundingBox) = "XNABoundingBox.op_Inequality"
End

'----------------------------------------------------------------------------------------------------------
' Defines a sphere.
' TODO: Needs to be implemented
Class XNABoundingSphere = "XNABoundingSphere"
	Method Radius#() Property  = "GetRadius"
	Method Radius(value#) Property  = "SetRadius"
	Method Center:Vector() Property = "GetCenter"
	Method Center(value:Vector) Property = "SetCenter"
	Method Transform(mat:Matrix) = "Transform"
	Method Intersects?(value:Plane) = "IntersectsPlane"
	Method Intersects?(value:BoundingBox) = "IntersectsBox"
	Method Intersects?(value:BoundingSphere) = "IntersectsSphere"
	Method Intersects?(value:BoundingFrustum) = "IntersectsFrustum"
	Method Contains?(value:BoundingBox) = "ContainsBox"
	Method Contains?(value:BoundingBox, containmentType) = "ContainsBox2"
	Method Contains?(value:BoundingSphere) = "ContainsSphere"
	Method Contains?(value:BoundingSphere, containmentType) = "ContainsSphere2"
	Method Contains?(value:BoundingFrustum) = "ContainsFrustum"
	Method Contains?(value:Vector,containmentType) = "ContainsVector"
	
	function Create:XNABoundingSphere(center:Vector, mat:Matrix) = "XNABoundingSphere.Create"
	function CreateFromBoundingBox:XNABoundingSphere(box:XNABoundingBox) = "XNABoundingSphere.CreateFromBoundingBox"
	function CreateFromFrustum:XNABoundingSphere(frustum:XNABoundingFrustum) = "XNABoundingSphere.CreateFromFrustum"
	function CreateFromPoints:XNABoundingSphere(points:Vector[]) = "XNABoundingSphere.CreateFromPoints"
	function CreateMerged:XNABoundingSphere(a:XNABoundingSphere, b:XNABoundingSphere) = "XNABoundingSphere.CreateMerged"
	function Op_Equality?(a:XNABoundingSphere, b:XNABoundingSphere) = "XNABoundingSphere.op_Equality"
	function Op_Inequality?(a:XNABoundingSphere, b:XNABoundingSphere) = "XNABoundingSphere.op_Inequality"
End

'----------------------------------------------------------------------------------------------------------
' Defines a frustum and helps determine whether forms intersect with it.
' TODO: Needs to be implemented
Class XNABoundingFrustum = "XNABoundingFrustum"
	Method ConrnerCount%() Property = "GetConrnerCount"
	Method Bottom:Plane() Property = "GetBottom"
	Method Far:Plane() Property = "GetFar"
	Method Left:Plane() Property = "GetLeft"
	Method Near:Plane() Property = "GetNear"
	Method Right:Plane() Property = "GetRight"
	Method Top:Plane() Property = "GetTop"
	Method Matrix:Matrix() Property = "GetMatrix"
	Method Matrix(value:Matrix) Property = "SetMatrix"
	Method Intersects?(value:BoundingBox) = "IntersectsBox"
	Method Intersects?(value:BoundingSphere) = "IntersectsSphere"
	Method Intersects?(value:BoundingFrustum) = "IntersectsFrustum"
	Method Intersects?(value:Plane) = "IntersectsPlane"
	Method Contains?(value:BoundingBox) = "ContainsBox"
	Method Contains?(value:BoundingBox, containmentType) = "ContainsBox2"
	Method Contains?(value:BoundingSphere) = "ContainsSphere"
	Method Contains?(value:BoundingSphere, containmentType) = "ContainsSphere2"
	Method Contains?(value:BoundingFrustum) = "ContainsFrustum"
	Method Contains?(value:Vector,containmentType) = "ContainsVector"
	
	function Create:XNABoundingFrustum(mat:Matrix) = "XNABoundingFrustum.Create"
	function Op_Equality?(a:XNABoundingFrustum, b:XNABoundingFrustum) = "XNABoundingFrustum.op_Equality"
	function Op_Inequality?(a:XNABoundingFrustum, b:XNABoundingFrustum) = "XNABoundingFrustum.op_Inequality"
End


'----------------------------------------------------------------------------------------------------------
' Defines the window dimensions of a render-target surface 
' onto which a 3D volume projects.
Class XNAViewport = "XNAViewport"
	Method AspectRatio#() Property		= " getAspectRatio"
	Method X#() Property				= " getX"
	Method Y#() Property				= " getY"
	Method Width#() Property			= " getWidth"
	Method Height#() Property			= " getHeight"
	Method X(value%) Property			= " setX"
	Method Y(value%) Property			= " setY"
	Method Width(value%) Property		= " setWidth"
	Method Height(value%) Property		= " setHeight"
	Method MaxDepth#() Property			= " getMaxDepth"
	Method MinDepth#() Property			= " getMinDepth"
	Method MaxDepth(value%) Property	= " setMaxDepth"
	Method MinDepth(value%) Property	= " setMinDepth"
	
	Function Create:XNAViewport(x,y,width, height) = "XNAViewport.Create"
End


'----------------------------------------------------------------------------------------------------------
' Contains blend state for the device.
Class XNABlendState = "XNABlendState"
	Method AlphaBlendFunction() property = "GetAlphaBlendFunction"
	Method AlphaDestinationBlend() Property = "GetAlphaDestinationBlend"
	Method AlphaSourceBlend() Property = "GetAlphaSourceBlend"
	Method BlendFactor:Color() Property = "GetBlendFactor"
	Method ColorBlendFunction() Property = "GetColorBlendFunction"
	Method ColorDestinationBlend() Property = "GetColorDestinationBlend"
	Method ColorSourceBlend() Property = "GetColorSourceBlend"
	Method AlphaBlendFunction(value%) property = "SetAlphaBlendFunction"
	Method AlphaDestinationBlend(value%) Property = "SetAlphaDestinationBlend"
	Method AlphaSourceBlend(value%) Property = "SetAlphaSourceBlend"
	Method BlendFactor(value:Color) Property = "SetBlendFactor"
	Method ColorBlendFunction(value%) Property = "SetColorBlendFunction"
	Method ColorDestinationBlend(value%) Property = "SetColorDestinationBlend"
	Method ColorSourceBlend(value%) Property = "SetColorSourceBlend"
		
	function Create:XNABlendState() = "XNABlendState.Create"
	function Additive:XNABlendState()= "XNABlendState.Additive"
	function AlphaBlend:XNABlendState()= "XNABlendState.AlphaBlend"
	function Premultiplied:XNABlendState()= "XNABlendState.NonPremultiplied"
	function Opaque:XNABlendState()= "XNABlendState.Opaque"
End

'----------------------------------------------------------------------------------------------------------
' Contains rasterizer state, which determines how to convert vector data (shapes) into raster data (pixels).
class XNARasterizerState = "XNARasterizerState"
	Method CullMode() = "GetCullMode"
	Method DepthBias#() = "GetDepthBias"
	Method FillMode() = "GetFillMode"
	Method MultiSampleAntiAlias?()= "GetMultiSampleAntiAlias"
	Method ScissorTestEnable?()= "GetScissorTestEnable"
	Method SlopeScaleDepthBias#()= "GetSlopeScaleDepthBias"
	Method CullMode(value%) = "SetCullMode"
	Method DepthBias(value#) = "SetDepthBias"
	Method FillMode(value%) = "SetFillMode"
	Method MultiSampleAntiAlias?(value?)= "SetMultiSampleAntiAlias"
	Method ScissorTestEnable?(value?)= "SetScissorTestEnable"
	Method SlopeScaleDepthBias(value#)= "SetSlopeScaleDepthBias"
	
	Function Create:XNARasterizerState() = "XNARasterizerState.Create"
	Function CullClockwise:XNARasterizerState() = "XNARasterizerState.CullClockwise"
	Function CullCounterClockwise:XNARasterizerState() = "XNARasterizerState.CullCounterClockwise"
	Function CullNone:XNARasterizerState() = "XNARasterizerState.CullNone"
End

'----------------------------------------------------------------------------------------------------------
' Contains sampler state, which determines how to sample texture data.
Class XNASamplerState = "XNASamplerState"
	Method AddressU%()	Property = "GetAddressU"
	Method AddressV%()Property = "GetAddressV"
	Method AddressW%()Property = "GetAddressW"
	Method Filter%()Property = "GetFilter"
	Method MaxAnisotropy%()Property = "GetMaxAnisotropy"
	Method MaxMipLevel%()Property = "GetMaxMipLevel"
	Method MipMapLevelOfDetailBias%()Property = "GetMipMapLevelOfDetailBias"
	Method AddressU(value%)	Property = "SetAddressU"
	Method AddressV(value%)Property = "SetAddressV"
	Method AddressW(value%)Property = "SetAddressW"
	Method Filter(value%)Property = "SetFilter"
	Method MaxAnisotropy(value%)Property = "SetMaxAnisotropy"
	Method MaxMipLevel(value%)Property = "SetMaxMipLevel"
	Method MipMapLevelOfDetailBias(value%)Property = "SetMipMapLevelOfDetailBias"
	
	Function Create:XNASamplerState() = "XNASamplerState.Create"
	Function AnisotropicWrap:XNASamplerState() = "XNASamplerState.AnisotropicClamp"
	Function LinearClamp:XNASamplerState() = "XNASamplerState.AnisotropicWrap"
	Function LinearWrap:XNASamplerState() = "XNASamplerState.LinearClamp"
	Function PointClamp:XNASamplerState() = "XNASamplerState.PointClamp"
	Function PointWrap:XNASamplerState() = "XNASamplerState.PointWrap"
End 

'----------------------------------------------------------------------------------------------------------
' Contains depth-stencil state for the device.
Class XNADepthStencilState = "XNADepthStencilState"
	Method CounterClockwiseStencilDepthBufferFail%() Property = "GetCounterClockwiseStencilDepthBufferFail"
	Method CounterClockwiseStencilFail%() Property = "GetCounterClockwiseStencilFail"	 
	Method CounterClockwiseStencilFunction%() Property = "GetCounterClockwiseStencilFunction"	 
	Method CounterClockwiseStencilPass%() Property = "GetCounterClockwiseStencilPass"	
	Method DepthBufferEnable?() Property = "GetDepthBufferEnable"	
	Method DepthBufferFunction%	() Property = "GetDepthBufferFunction"	
	Method DepthBufferWriteEnable?	() Property = "GetDepthBufferWriteEnable"	
	Method ReferenceStencil%() Property = "GetReferenceStencil"	
	Method StencilDepthBufferFail%() Property = "GetStencilDepthBufferFail"	
	Method StencilEnable?() Property = "GetStencilEnable"	
	Method StencilFail%() Property = "GetStencilFail"	
	Method StencilFunction%	() Property = "GetStencilFunction"	
	Method StencilMask%	() Property = "GetStencilMask"	
	Method StencilPass%	() Property = "GetStencilPass"	
	Method StencilWriteMask%() Property = "GetStencilWriteMask"	
	Method TwoSidedStencilMode?() Property = "GetTwoSidedStencilMode"	
	Method CounterClockwiseStencilDepthBufferFail(value%) Property = "SetCounterClockwiseStencilDepthBufferFail"
	Method CounterClockwiseStencilFail(value%) Property = "SetCounterClockwiseStencilFail"	 
	Method CounterClockwiseStencilFunction(value%) Property = "SetCounterClockwiseStencilFunction"	 
	Method CounterClockwiseStencilPass(value%) Property = "SetCounterClockwiseStencilPass"	
	Method DepthBufferEnable(value?) Property = "SetDepthBufferEnable"	
	Method DepthBufferFunction(value%) Property = "SetDepthBufferFunction"	
	Method DepthBufferWriteEnable(value?) Property = "SetDepthBufferWriteEnable"	
	Method ReferenceStencil(value%) Property = "SetReferenceStencil"	
	Method StencilDepthBufferFail(value%) Property = "SetStencilDepthBufferFail"	
	Method StencilEnable(value?) Property = "SetStencilEnable"	
	Method StencilFail(value%) Property = "SetStencilFail"	
	Method StencilFunction(value%) Property = "SetStencilFunction"	
	Method StencilMask(value%) Property = "SetStencilMask"	
	Method StencilPass(value%) Property = "SetStencilPass"	
	Method StencilWriteMask(value%) Property = "SetStencilWriteMask"	
	Method TwoSidedStencilMode(value?) Property = "SetTwoSidedStencilMode"	
	
	Function Create:XNADepthStencilState() = "XNADepthStencilState.Create"
	Function _Default:XNADepthStencilState() = "XNADepthStencilState.Default"	
	Function DepthRead:XNADepthStencilState() = "XNADepthStencilState.DepthRead"
	Function None:XNADepthStencilState() = "XNADepthStencilState.None"
End

'----------------------------------------------------------------------------------------------------------
' Represents a 2D grid of texels.
Class XNATexture = "XNATexture"
	Method Load:Texture(fileName$)	
	Method Width()
	Method Height()
	Method SetData(level:int, data:DataBuffer, start, count) 
End

'----------------------------------------------------------------------------------------------------------
' Reperesents an renderable object containing vertices and indices
Class XNAMesh = "XNAMesh"
	Method IsEmty?()
	Method AddVertex:int(x#, y#, z#,nx#, ny#, nz#, s#,t#)
	Method AddTriangle:int(v0, v1, v2)
	Method CountVertices()
	Method CountTriangles()
	Method Size()
	Method Clear()
	Method Update()
	Method Bind()
	Method Render()
End

'----------------------------------------------------------------------------------------------------------
'Performs primitive-based rendering, creates resources, handles system-level variables  and creates shaders.
Class XNAGraphicsDevice  = "XNAGraphicsDevice"
	Method CreateTexture:XNATexture(width, height, mipmap:bool , format)
	Method LoadTexture:XNATexture(filename$)
	Method CreateMesh:XNAMesh()
	Method CreateBasicEffect:XNABasicEffect()
	'Method LoadEffect:XNAEffect(filename$)' custom effetcts not supported in REACH profile
	Method BlendState(blend:XNABlendState) Property = "SetBlend"
	Method RasterizerState(state:XNARasterizerState ) Property = "SetRasterizerState"
	Method DepthStencilState(state:XNADepthStencilState) Property = "SetDepthStencilState"
	Method SamplerState(index, state:XNASamplerState ) = "SetSamplerState"
	Method ClearScreen(r#,g#,b#, back? , depth? , stencil? )
	Method Viewport(x,y,width, height)
End

'----------------------------------------------------------------------------------------------------------
' Represents a color using Red, Green, Blue, and Alpha values.
Class XNAColor = "XNAColor"
	Method R#() Property = "GetR"
	Method G#() Property = "GetG"
	Method B#() Property = "GetB"
	Method A#() Property = "GetA"
	Method R(value#) Property = "SetR"
	Method G(value#) Property = "SetG"
	Method B(value#) Property = "SetB"
	Method A(value#) Property = "SetA"
	
	Function FromArgb:XNAColor(r#,g#,b#,a#) = "XNAColor.FromARGB"
	Function Black:XNAColor() 				= "XNAColor.Black"
	Function White:XNAColor() 				= "XNAColor.White"
	Function Red:XNAColor()   				= "XNAColor.Red"
	Function Blue:XNAColor()  				= "XNAColor.Blue"
End

'----------------------------------------------------------------------------------------------------------
'Creates a DirectionalLight object.
Class XNADirectionalLight = "XNADirectionalLight"
	Method DiffuseColor(r#,g#,b#) = "SetDiffuseColor"
	Method SpecularColor(r#,g#,b#) = "SetSpecularColor"
	Method Direction(x#,y#,z#) = "SetDirection"
	Method Enabled?() = "GetEnabled"
	Method Enabled(value?) = "SetEnabled"
End

'----------------------------------------------------------------------------------------------------------
' Contains a basic rendering effect.
Class XNABasicEffect extends XNAEffect = "XNABasicEffect"
	Method Alpha(value#) Property = "SetAlpha"
	Method AmbientLightColor(r#,g#,b#) Property = "SetAmbientLightColor"
	Method DiffuseColor(r#,g#,b#) Property = "SetDiffuseColor"
	Method DirectionalLight0:XNADirectionalLight() Property = "GetDirectionalLight0"	
	Method DirectionalLight1:XNADirectionalLight() Property = "GetDirectionalLight1"	
	Method DirectionalLight2:XNADirectionalLight() Property = "GetDirectionalLight2"	
	Method EmissiveColor(r#,g#,b#) Property = "SetEmissiveColor"
	Method FogColor(r#,g#,b#) Property = "SetFogColor"
	Method FogEnabled?()  Property= "GetFogEnabled"
	Method FogEnabled(value?) Property = "SetFogEnabled"
	Method FogEnd(value#) Property = "SetFogEnd"
	Method FogStart(value#) Property = "SetFogStart"
	Method LightingEnabled(value?)  Property= "SetLightingEnabled"
	Method PreferPerPixelLighting(value?)  Property= "SetPreferPerPixelLighting"
	Method SpecularColor(r#,g#,b#)  Property= "SetSpecularColor"
	Method SpecularPower(value#)  Property= "SetSpecularPower"
	Method Texture(value:XNATexture) Property = "SetTexture"
	Method VertexColorEnabled(value?) Property = "SetVertexColorEnabled"
	Method TextureEnabled(value?) Property = "SetTextureEnabled"
	
	' TODO: Matrix needs to be wrapped(change in miniB3D)
	Method Projection(fieldOfView#, aspect#, near#, far#)  = "SetProjection"
	Method View(px#, py#, pz#, rx#, ry#, rz#, sx#, sy#, sz#) = "SetView"
	Method World(px#, py#, pz#, rx#, ry#, rz#, sx#, sy#, sz#) = "SetWorld"
End

'----------------------------------------------------------------------------------------------------------
' Used to set and query effects, and to choose techniques.
Class XNAEffect = "XNAEffect"
	Method CurrentTechnique:XNAEffectTechnique() Property = "GetCurrentTechnique"
	Method CurrentTechnique(value:XNAEffectTechnique) Property = "SetCurrentTechnique"
	Method GraphicsDevice:XNAGraphicsDevice() Property = "GetGraphicsDevice"
	Method Name$() Property = "GetName"
	Method GetParameter(name$) Property = "GetParameter"
	Method CountParameters() Property
	Method GetTechnique(name$) Property= "GetTechnique"
	Method CountTechniques() Property
End

'----------------------------------------------------------------------------------------------------------
' Represents an effect technique.
' Creating and assigning a EffectTechnique instance for each technique in your Effect is significantly 
' faster than using always the Techniques 'GetTechnique' property on Effect.
Class XNAEffectTechnique = "XNAEffectTechnique"
	Method Name$() Property = "GetName"
	Method Passes:XNAEffectPass[]() = "GetPasses"
End

'----------------------------------------------------------------------------------------------------------
' Contains rendering state for drawing with an effect; an effect can contain one or more passes.
Class XNAEffectPass = "XNAEffectPass"
	Method Name$() property = "GetName"
	Method Apply()
End

'----------------------------------------------------------------------------------------------------------
' Represents an Effect parameter.
' Creating and assigning a EffectParameter instance for each technique in your Effect is significantly 
' faster than using the Parameters indexed property on Effect.
Class XNAEffectParameter  = "XNAEffectParameter"
	Method ParameterClass() Property = "GetParameterClass"
	Method ParameterType() Property = "GetParameterType"
	Method Name$() Property = "GetName"
	Method Semantic$() Property = "GetSemantic"
	Method SetValue(value?)		= "SetBool"
	Method SetValue(value?[])	= "SetBoolArray"
	Method SetValue(value%)		= "SetInt"
	Method SetValue(value%[])	= "SetIntArray"
	Method SetValue(value#)	= "SetFloat"
	Method SetValue(value#[])	= "SetFloatArray"
	Method SetValue(value$)	= "SetString"
	Method SetValue(value:XNATexture)	= "SetTexture"
	#rem
	Method SetValue(value:Matrix)	= "SetMatrix"
	Method SetValue(value:Matrix[])		= "SetMatrixArray"
	Method SetValue(value:Vector)		= "SetVector"
	#end
End

#rem
Class XNAVertexBuffer
	Method BufferUsage() Property
	Method VertexCount() Property
	Method Size() Property
	Method VertexDeclaration() Property		
	Method Dispose()
	Method GetData:#[]()
	Method SetData(data:#[], start, count)
	Method AddVertex(x#, y#, z#,nx#, ny#, nz#, s#,t#)
	Method SetVertex(id%,x#, y#, z#,nx#, ny#, nz#, s#,t#)
	Method Clear()
End

Class XNAMeshIndexBuffer
	Method BufferUsage() Property
	Method IndexCount() Property
	Method IndexElementSize() Property
	Method Dispose()
	Method GetData:int[]()
	Method SetData(data:int[], start, count)
	Method AddTriangle:int(v0, v1, v2)
	Method Clear()
End 
#end 

' minib3d compatibility
Class DataBuffer

	Method Size()

	Method Discard:Void()
	
	Method PokeByte:Void( addr,value )
	Method PokeShort:Void( addr,value )
	Method PokeInt:Void( addr,value )
	Method PokeFloat:Void( addr,value# )
	
	Method PeekByte:Int( addr )
	Method PeekShort:Int( addr )
	Method PeekInt:Int( addr )
	Method PeekFloat:Float( addr )

	Function Create:DataBuffer( size )="DataBuffer.Create"
End

Function LoadImageData:DataBuffer( path$,info[]=[] )="DataBuffer.LoadImageData"

</textarea><br><br><br><br>@trender: <br><br>It seems, that I have to change the MINIB3D_DRIVER define in minib3d.monkey and call SetRender(...) in my application, in order to change the target.<br><br>I suggest to manage the target specific imports ONLY with the TARGET define. The MINIB3D_DRIVER define can be removed then. Also the global stuff in trender needs to be encapculated in a seperate class...trenderManager, for example.       <br><br>New targets must only be added to trenderManager then.  Changing the target can be done by only calling SetRender(...) <br><br>personally I would also convert TRender to an interface and provide a factory... <br><br></td></tr></table><br>
<a name="2030981"></a>

<a name="2030945"></a>

<a name="2030946"></a>

<a name="2030947"></a>

<a name="2030948"></a>

<a name="2031004"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >CopperCircle</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#53">[#53]</a></td></tr></table></td></tr><tr ><td class="posttext"> Cool XNA target!  I will give that a go ASAP, as a general question is there a limit on verts for B3D mesh?<br><br>I am trying to load a mesh and it draws then crashes with HEAP CORRUPTION DETECTED: after Normal block (#123638)<br><br>Thanks. <br><br></td></tr></table><br>
<a name="2031019"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rex Rhino</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#54">[#54]</a></td></tr></table></td></tr><tr ><td class="posttext"> Whooooo!? XNA target!!! Does it work on Xbox 360? I am at home, I can't test now, but somebody please tell me! That is so damn awesome! <br><br></td></tr></table><br>
<a name="2031064"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rone</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#55">[#55]</a></td></tr></table></td></tr><tr ><td class="posttext"> Works also on Xbox360...but its really an early stage of development. <br>Fixed a few bugs and added most features that are possible last night. There are also some Interface glitches that should fixed in miniB3D.<br><br>Will upload the latest version this night..<br><br>Just have build glfw target for the first time, models are not displayed !?!<br>Is there an common issue with that? I use v58<br><br>I also get an error in v59 with glfw:<br><br><textarea class=codebox name="code" wrap=OFF readonly="true" rows="15" cols="80">
try{
	
		bb_std_main( argc,argv );

		if( runner ) seh_call( runner );

	}catch( const char *err ){

		warn( ( String("Monkey runtime error: ")+err+"\n"+StackTrace() ).ToCString&lt;char&gt;() );
	}
</textarea><br><br>'seh_call' does not exist<br>'StackTrace' does not exist <br><br></td></tr></table><br>
<a name="2031061"></a>

<a name="2031060"></a>

<a name="2031081"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >AdamRedwoods</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#56">[#56]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> Just have build glfw target for the first time, models are not displayed !?!<br>Is there an common issue with that? I use v58 <br></div><br>not that i'm aware of. did you test the examples? make sure the b3d file is base64 and in the ".data" folder.<br><br>As for the v59 monkey error,<br>seh_call and StackTrace() is same code from previous versions. (not sure why, i havent tried m59) <br><br></td></tr></table><br>
<a name="2031078"></a>

<a name="2031079"></a>

<a name="2031094"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rone</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#57">[#57]</a></td></tr></table></td></tr><tr ><td class="posttext"> @AdamRedwoods<br>Yes, its the 'animation_test' example. 'TText' does also only work on Android..<br>-------------<br><br>Here is an update of the xna implementation.<br><br><a href="http://www.load.to/Qy9fTAYC9D/minib3d.zip" target="_blank">http://www.load.to/Qy9fTAYC9D/minib3d.zip</a><br><br>Is fairly complete. A few things are missing, due to lack of support in xna reach profil ...<br><br>Mesh manipulation and texture creation can be improved if the driver interface is extended...<br><br>Todo:<br>- SpriteBatch <br>- CubeMapping <br><br></td></tr></table><br>
<a name="2031089"></a>

<a name="2031088"></a>

<a name="2031118"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rone</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#58">[#58]</a></td></tr></table></td></tr><tr ><td class="posttext"> @AdamRedwoods<br>Have you ever thought about using interleaved vertex arrays? <br>I do not know what that does with OpenGL on animated meshes, regarding the performance, but in general it would make many things easier...<br><br><br><a href="http://developer.apple.com/library/ios/#documentation/3DDrawing/Conceptual/OpenGLES_ProgrammingGuide/TechniquesforWorkingwithVertexData/TechniquesforWorkingwithVertexData.html#//apple_ref/doc/uid/TP40008793-CH107-SW10" target="_blank">http://developer.apple.com/library/ios/#documentation/3DDrawing/Conceptual/OpenGLES_ProgrammingGuide/TechniquesforWorkingwithVertexData/TechniquesforWorkingwithVertexData.html#//apple_ref/doc/uid/TP40008793-CH107-SW10</a><br><br><a href="http://www.opengl.org/wiki/Vertex_Specification_Best_Practices" target="_blank">http://www.opengl.org/wiki/Vertex_Specification_Best_Practices</a> <br><br></td></tr></table><br>
<a name="2031117"></a>

<a name="2031125"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >AdamRedwoods</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#59">[#59]</a></td></tr></table></td></tr><tr ><td class="posttext"> Re: interleaving<br><br>Would it make things easier for XNA/DirectX?<br>I chose not to since I wanted to keep animation fast on android, although untested, my gut tells me the difference is minimal. I thought about just normal/texcoords/colors interleaving as well. Would require a system-wide change, so would require a few rounds of testing. <br><br></td></tr></table><br>
<a name="2031143"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rone</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#60">[#60]</a></td></tr></table></td></tr><tr ><td class="posttext"> Yes, exactly. Without interleaved arrays, it is very inefficient with xna / D3D. Also think that the difference is minimal at mehsh animations ...<br><br>I'll try it ... Probably the most can be copied from miniB3DExtended. <br><br></td></tr></table><br>
<a name="2031179"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rone</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#61">[#61]</a></td></tr></table></td></tr><tr ><td class="posttext"> Ok, did it. <br>Took 4 hours on a bug in this damn BoneToVertexAnim function to find....<br><br>Unfortunately, the original opengl implementation still does not work here...so I cant test if the opengl buffer binding is OK. <br><br></td></tr></table><br>
<a name="2031210"></a>

<a name="2031211"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >AdamRedwoods</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#62">[#62]</a></td></tr></table></td></tr><tr ><td class="posttext"> OK, I can't seem to find a simple way to Interface TRender for simple compile picking with SetRender(render,flags).<br><br>The problem is that Opengles11 and Opengles20 have consts and compiler defines that conflict with each other on Import. So I can't base this off TARGET or an Interface.<br><br>This complicated matters, since I would like an easy way to switch between opengl and directx.<br><br>My only thought is to degrade SetRender() to flags use only, and force the programmer to use:<br><pre class=code>Import minib3d.driver
'driver  = opengles20, opengles11, xna, dx11, etc...</pre><br>as the main way to pick the driver.<br><br>What do you think? <br><br></td></tr></table><br>
<a name="2031247"></a>

<a name="2031254"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rone</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#63">[#63]</a></td></tr></table></td></tr><tr ><td class="posttext"> Sounds good, if understand correctly ....Something like this?<br><br><textarea class=codebox name="code" wrap=OFF readonly="true" rows="15" cols="80">
' import driver...

#If TARGET="xna"
	Import minib3d.driver_xna
#Else
	Import minib3d.driver_opengles11 
#End 

' ...

' setup miniB3D

local flags = 0
Minib3dInit(flags )
</textarea><br><br>Here's an update of the xna implementation(Shows also the above described driver handling)<br><br><a href="http://www.load.to/ddWbbVShsY/minib3d_3.zip" target="_blank">http://www.load.to/ddWbbVShsY/minib3d_3.zip</a><br><br>Changed vertex data to 64byte aligned interleaved arrays(opengl will crash or not displaying anything, cause I have not yet converted openglES11.Render properly).<br><br>Have found a lot of bugs after I included reflection:<br><textarea class=codebox name="code" wrap=OFF readonly="true" rows="15" cols="80">
/minib3d/ttexture.monkey&lt;501&gt; : Error : Identifier 'mipmap' not found.
/minib3d/ttexture.monkey&lt;501&gt; : Error : Identifier 'BackBufferToTex' not found.
/minib3d/tbrush.monkey&lt;240&gt; : Error : Identifier 'tex_frame' not found.
/minib3d/functions.monkey&lt;99&gt; : Error : Identifier 'AntiAlias' not found.
/minib3d/functions.monkey&lt;194&gt; : Error : Unable to find overload for CameraClsMode(Int,Int).
/minib3d/functions.monkey&lt;271&gt; : Error : Unable to find overload for ClearSurface(Int,Int).
/minib3d/tpick.monkey&lt;72&gt; : Error : Cannot convert from Int to TSurface.
/minib3d/tmesh.monkey&lt;1495&gt; : Error : Type 'Transform' not found
/minib3d/tmesh.monkey&lt;1022&gt; : Error : Identifier 'tex_frame' not found.
/minib3d/functions.monkey&lt;1346&gt; : Error : Identifier 'TVector' not found.
/minib3d/vector.monkey&lt;151&gt; : Error : Identifier 'Sqr' not found.
/minib3d/functions.monkey&lt;1353&gt; : Error : Identifier 'TVector' not found.
/minib3d/geom.monkey&lt;91&gt; : Error : Expression has no scope
/minib3d/geom.monkey&lt;92&gt; : Error : Cannot convert from Plane to Int.
/minib3d/geom.monkey&lt;119&gt; : Error : VarExpr(Field Plane.n:Vector) must be numeric for use with unary operator '-'
/minib3d/opengles11.monkey&lt;1096&gt; : Error : Identifier 'flags' not found.
/minib3d/opengles11.monkey&lt;1100&gt; : Error : Identifier 'gltex' not found.
/minib3d/quaternion.monkey&lt;223&gt; : Error : Identifier 'pitch' not found.
/minib3d/quaternion.monkey&lt;224&gt; : Error : Identifier 'yaw' not found.
/minib3d/quaternion.monkey&lt;224&gt; : Error : Identifier 'roll' not found.
/minib3d/tbrush.monkey&lt;121&gt; : Error : Identifier 'brush' not found.
/minib3d/tbrush.monkey&lt;122&gt; : Error : Identifier 'brush' not found.
/minib3d/tbrush.monkey&lt;124&gt; : Error : Identifier 'brush' not found.
/minib3d/tcoltree.monkey&lt;324&gt; : Error : Illegal expression type.
/minib3d/tcoltree.monkey&lt;328&gt; : Error : Illegal expression type.
/minib3d/tcoltree.monkey&lt;330&gt; : Error : Illegal expression type.
/minib3d/tcoltree.monkey&lt;359&gt; : Error : Cannot convert from Int to Bool.
/minib3d/tcoltree.monkey&lt;462&gt; : Error : Type 'Transform' not found
...
/minib3d/tentity.monkey&lt;474&gt; : Error : Identifier 'TModel' not found.
/minib3d/tentity.monkey&lt;504&gt; : Error : Identifier 'length' not found - perhaps you meant 'Length'?
...
/minib3d/tentity.monkey&lt;518&gt; : Error : Illegal expression type.
...
/minib3d/tshader.monkey&lt;50&gt; : Error : Identifier 'shader' not found.
/minib3d/ttext.monkey&lt;255&gt; : Error : Identifier 'pixmap' not found.
/minib3d/ttexture.monkey&lt;25&gt; : Error : Type 'TTextureDriver' not found
/minib3d/vector.monkey&lt;25&gt; : Error : Identifier 'vec' not found.



Monkey bugs:

graphics.monkey -&gt; BeginRender() Needs to return Void
audio.monkey Method Length() -&gt; gxtkSample.Length() is not implemented in xna
</textarea><br>Most was easy to fix....some of it is just commented out, simply because either missed a class or I did not know 100% what the code does. <br><br></td></tr></table><br>
<a name="2031235"></a>

<a name="2031234"></a>

<a name="2031233"></a>

<a name="2031232"></a>

<a name="2031231"></a>

<a name="2031230"></a>

<a name="2031227"></a>

<a name="2031228"></a>

<a name="2031226"></a>

<a name="2031225"></a>

<a name="2031223"></a>

<a name="2031224"></a>

<a name="2031220"></a>

<a name="2031221"></a>

<a name="2031222"></a>

<a name="2031271"></a>

<a name="2031273"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rone</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#64">[#64]</a></td></tr></table></td></tr><tr ><td class="posttext"> Updated opengles11, in order to work with interleaved arrays. Tested with glfw and xna on pc and windows phone.<br><br><a href="http://www.load.to/EG8tjqGFMl/minib3d_4.zip" target="_blank">http://www.load.to/EG8tjqGFMl/minib3d_4.zip</a><br><br>Todo:<br>- check matrices(might be twisted in xna)<br>- add spritebatch to xna(copy/paste from opengles11 should work) <br><br></td></tr></table><br>
<a name="2031274"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >AdamRedwoods</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#65">[#65]</a></td></tr></table></td></tr><tr ><td class="posttext"> Nice job.<br><br>I'm going to change up the way the code is organized, not too major, but should help organize between multiple targets.<br><br>Do I have your permission to add the XNA to the next GitHub minib3d version? <br><br></td></tr></table><br>
<a name="2031275"></a>

<a name="2031276"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rone</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#66">[#66]</a></td></tr></table></td></tr><tr ><td class="posttext"> yes, of course <br><br></td></tr></table><br>
<a name="2031277"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rex Rhino</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#67">[#67]</a></td></tr></table></td></tr><tr ><td class="posttext"> The following code works in GLFW, but doesn't rotate properly in XNA (both PC and Xbox360 have problems):<br><br><pre class=code>
#If TARGET="xna"
	Import minib3d.driver_xna
#Else
	Import minib3d.driver_opengles11 
#End 

Function Main()
	New Game
End

Class Game Extends App
	
	Field cam:TCamera	
	Field light:TLight
	Field cube:TMesh

	Field init_gl:Bool = False

	Method OnCreate()
		Minib3dInit()
		#If TARGET="xna"
			Init()	
		#End 
		SetUpdateRate 60
	End

	Method Init()
		If init_gl Then Return
		init_gl = True

		cam = CreateCamera()
		cam.CameraClsColor(0,0,80)
		cam.CameraRange(1,100000)
		cam.PositionEntity 0,0,0
		
		light=CreateLight(1)
		light.PositionEntity 0,3,-3
		
		Local x:Int
		For x = 1 To 10000
			cube=CreateCube()
			cube.ScaleEntity(Rnd(0,10),Rnd(0,10),Rnd(0,10))
			cube.name = "cube"
			PositionEntity cube,Rnd(-500,500),Rnd(-500,500),Rnd(-500,500)
		Next
	End
	
	Method OnUpdate()
		TurnEntity cam,0,1,0
		UpdateWorld()
	End
	
	Method OnRender()
		Init()

		RenderWorld()
				
		RestoreMojo2D()
		DrawText "This is a test!", 0, 0	
	End

End
</pre> <br><br></td></tr></table><br>
<a name="2031284"></a>

<a name="2031285"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rone</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#68">[#68]</a></td></tr></table></td></tr><tr ><td class="posttext"> yes, as expected...frustum culling and lighting fail, too. matrices are twisted. <br><br></td></tr></table><br>
<a name="2031287"></a>

<a name="2031288"></a>

<a name="2031289"></a>

<a name="2031290"></a>

<a name="2031291"></a>

<a name="2031292"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rone</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#69">[#69]</a></td></tr></table></td></tr><tr ><td class="posttext"> Ok, matrices should work now...also TText and frustum culling.<br><br><a href="http://www.load.to/E88h9utXSY/minib3d_5.zip" target="_blank">http://www.load.to/E88h9utXSY/minib3d_5.zip</a><br><br>@Rex Rhino<br>Do the samples run on xbox360? <br>I was confused, because of that:<br><div class="quote"> <br>Caution<br>Here is a tip for rendering objects within the Draw method of an Xbox 360 game. Do not use SetData when writing data to vertex buffers, index buffers, and textures. This method may lead to graphics corruption or crashes.<br>This is because, in cases where the size of the back buffer and depth-stencil buffer exceed the size of the Xbox 360 10 MB of embedded memory (EDRAM), predicated tiling is utilized on this platform to compensate for the additional memory requirements. Predicated tiling is a process by which scene rendering is performed multiple times on subsections of the final render target dimensions.<br>When predicated tiling has been triggered, the drawing commands contained in the Draw function are not submitted until Present is called. (Note that Draw implicitly calls Present at the end of this method.) In this case, these resources are not available for modification until the GPU is finished with presenting the entire frame.<br> <br></div> <a href="http://msdn.microsoft.com/en-us/library/bb198834" target="_blank">http://msdn.microsoft.com/en-us/library/bb198834</a> <br><br></td></tr></table><br>
<a name="2031297"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rex Rhino</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#70">[#70]</a></td></tr></table></td></tr><tr ><td class="posttext"> Rone:<br><br>I tested the zombie example on the Xbox 360, and got it working on the 360 (I didn't test the camera movement, because I didn't change the code to work with the controller). My example with the cubes was also running, although with the matrice problems on rotation. I haven't tested it with your 5th revision (I probably won't be able to until later tonight).<br><br>As for the predicated tiling thing, it is usually only a problem when rendering 3D at 1080p. The standard procedure with Xbox 360 is to render at 720p, because the Xbox is able to automatically scale to all resolutions and it is able to render all in one go.<br><br>Anyway, great work with what you are doing Rone! If there is anything I can do to help, just let me know! <br><br></td></tr></table><br>
<a name="2031298"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rex Rhino</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#71">[#71]</a></td></tr></table></td></tr><tr ><td class="posttext"> Rone: <br><br>I tested the XNA on my PC with the cubes demo I made - All the cubes are now visible, but the lighting is only working on one half of the world, the other half of the cubes are dark grey. <br><br></td></tr></table><br>
<a name="2031299"></a>

<a name="2031300"></a>

<a name="2031301"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rone</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#72">[#72]</a></td></tr></table></td></tr><tr ><td class="posttext"> ok, thx.<br>*fixed matrix rotation issue on pitch vector<br><br>Since xna only supports 3 directional lights, each light is treated as a directional...I suspect the gray sides are only not illuminated(seems so, if you move around), but its possible, that the calculation of direction is wrong...in any case, it is ugly:<br><br><div class="quote"> <br>local dir:= LIGHT_QUAD.MatrixToQuat(light.mat).RotateVector(UP_VECTOR)<br> <br></div><br><br>Update follows..<br><br>@AdamRedwoods<br><br>In the conversion of the vertex format, I have added a class called VertexDataBuffer. It is simple, to copy the functionality to TSurface, but I would like to natively implement this class in c#, since the DataBuffer implementation is very suboptimal in c#(lack of unsafe code on windows phone)... <br><br></td></tr></table><br>
<a name="2031312"></a>

<a name="2031313"></a>

<a name="2031314"></a>

<a name="2031315"></a>

<a name="2031317"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rone</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#73">[#73]</a></td></tr></table></td></tr><tr ><td class="posttext"> Upadate<br>*some speed improvements during rendering(no VBOs with dynamic meshes)<br>*using float[] instead of DataBuffer for vertex manipulation is much faster<br><br><a href="http://www.load.to/c9suokb62P/minib3d_6.zip" target="_blank">http://www.load.to/c9suokb62P/minib3d_6.zip</a><br><br>Since miniB3ds animations are done completely on the CPU, there is a good possibility to improve the performance, by just declaring TMatrix and TVector extern. This way we get SIMD acceleration for free on XNA/D3D based platforms(just need to enable SIMD flag)...also Android and iOS supports this, through NEON technology.<br><br><a href="http://justinangel.net/AllWp7MangoAPIs#simd" target="_blank">http://justinangel.net/AllWp7MangoAPIs#simd</a><br><a href="http://www.arm.com/products/processors/technologies/neon.php" target="_blank">http://www.arm.com/products/processors/technologies/neon.php</a> <br><br></td></tr></table><br>
<a name="2031310"></a>

<a name="2031311"></a>

<a name="2031316"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rex Rhino</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#74">[#74]</a></td></tr></table></td></tr><tr ><td class="posttext"> I see, yeah, it is directional light...<br><br>XNA only supports 3 directional lights with the "Basic Effect" (which is the XNA equivalent to the Fixed Pipeline in OpenGL). From what I understand, "Effects" are essentially shaders in XNA.<br><br>Here is an effect that supports point lighting: <a href="http://www.catalinzima.com/tutorials/deferred-rendering-in-xna/point-lights/" target="_blank">http://www.catalinzima.com/tutorials/deferred-rendering-in-xna/point-lights/</a><br><br>Anyway, thanks for your work Rone! It is awesome! I am very excited this is coming along! <br><br></td></tr></table><br>
<a name="2031319"></a>

<a name="2031323"></a>

<a name="2031325"></a>

<a name="2031328"></a>

<a name="2031348"></a>

<a name="2031349"></a>

<a name="2031350"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rone</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#75">[#75]</a></td></tr></table></td></tr><tr ><td class="posttext"> Thanks.<br>Unfortunately xna reach profile does not support custom shader on wp7(I was totally confused when I tried to load fx files).<br><br>I also dont like the idea of recreating the FFP with a huge lame shader replicate... just as creating thousands of shaders for each lighting/material combination...<br><br>But especially the way minib3d handles materials, makes a smart solution challenging <br><br></td></tr></table><br>
<a name="2031324"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rex Rhino</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#76">[#76]</a></td></tr></table></td></tr><tr ><td class="posttext"> How is lighting translated from Monkey to XNA? <br><br>In XNA, it looks like it has a color, a direction, and a highlight color: <a href="http://rbwhitaker.wikidot.com/basic-effect-lighting" target="_blank">http://rbwhitaker.wikidot.com/basic-effect-lighting</a><br><br>How is that set and/or reconciled with the miniB3D style of lighting? <br><br></td></tr></table><br>
<a name="2031326"></a>

<a name="2031327"></a>

<a name="2031329"></a>

<a name="2031330"></a>

<a name="2031331"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rone</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#77">[#77]</a></td></tr></table></td></tr><tr ><td class="posttext"> Each light is treated as directional light. <br>Color and orientation were simply transferred. Specular is still ignored ...<br><textarea class=codebox name="code" wrap=OFF readonly="true" rows="15" cols="80">
	Method SetLight(id, dirX#, dirY#, dirZ#, r#, g#, b#)
	
		_lastEffect.UpdateLights = false
		_lightR = r
		_lightG = g
		_lightB = b
		
		Select id
			Case 0
				_dirX0 = dirX
				_dirY0 = dirY
				_dirZ0 = dirZ
				_lastEffect.Effect.DirectionalLight0.Direction(dirX, dirY, dirZ) 
				_lastEffect.Effect.DirectionalLight0.DiffuseColor(r,g,b);
			Case 1
				_dirX1 = dirX
				_dirY1 = dirY
				_dirZ1 = dirZ
				_lastEffect.Effect.DirectionalLight1.Direction(dirX, dirY, dirZ) 
				_lastEffect.Effect.DirectionalLight1.DiffuseColor(r,g,b);
			Case 2
				_dirX2 = dirX
				_dirY2 = dirY
				_dirZ2 = dirZ
				_lastEffect.Effect.DirectionalLight2.Direction(dirX, dirY, dirZ) 
				_lastEffect.Effect.DirectionalLight2.DiffuseColor(r,g,b);
		End
		
    End
</textarea><br><br>OK, theres obviesly a bug... <br><br></td></tr></table><br>
<a name="2031332"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rex Rhino</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#78">[#78]</a></td></tr></table></td></tr><tr ><td class="posttext"> Cool! Looking forward to see what I can do with it! I am making a space strategy game - I was going to use abstract 2D graphics, but it will be a lot cooler with an abstract 3D system.<br><br>Anyway, I don't know if I am up on XNA 3D to help you with the coding, but anything I can do to help otherwise, let me know. In my opinion, being able to do 3D on a bunch of different platforms (even if old school style 3D) make Monkey 1000X more valuable than it was before! <br><br></td></tr></table><br>
<a name="2031442"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Amon</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#79">[#79]</a></td></tr></table></td></tr><tr ><td class="posttext"> Hi! When trying out a few things with this I get an error:<br><br><pre class=code>
C:/Apps/Coding/MonkeyPro59/modules/minib3d/tmodelobj.monkey&lt;102&gt; : Error : Duplicate identifier 'DebugLog' found in module 'lang' and module 'tutility'.
Abnormal program termination. Exit code: -1
</pre> <br><br></td></tr></table><br>
<a name="2031443"></a>

<a name="2031444"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >AdamRedwoods</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#80">[#80]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> <br>When trying out a few things with this I get an error: <br></div><br>The latest monkey probably now has DebugLog, so minib3d is conflicting. I'll have to change this throughout. (EDIT: you may be able to just Rem out the tutility debuglog)<br><br>One project I had lined up fell through so I may be able to catch up this week. <br><br></td></tr></table><br>
<a name="2031457"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rex Rhino</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#81">[#81]</a></td></tr></table></td></tr><tr ><td class="posttext"> I just commented out the DebugLog statements, and it worked fine. <br><br></td></tr></table><br>
<a name="2031516"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Amon</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#82">[#82]</a></td></tr></table></td></tr><tr ><td class="posttext"> I'm a bit confused as how to load in 3D models! I see in the animation test example that there is a base64.txt of the b3d model.<br><br>What do I have to do to load in b3d models? <br><br></td></tr></table><br>
<a name="2031520"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rone</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#83">[#83]</a></td></tr></table></td></tr><tr ><td class="posttext"> You need to convert your .b3d models to base64.txt files... <br><br></td></tr></table><br>
<a name="2031521"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Amon</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#84">[#84]</a></td></tr></table></td></tr><tr ><td class="posttext"> How do I do that? <br><br></td></tr></table><br>
<a name="2031523"></a>

<a name="2031524"></a>

<a name="2031525"></a>

<a name="2031526"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rone</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#85">[#85]</a></td></tr></table></td></tr><tr ><td class="posttext"> https://www.google.com/search?btnG=1&amp;pws=0&amp;q=base64+encoder <br><br></td></tr></table><br>
<a name="2031534"></a>

<a name="2031535"></a>

<a name="2031536"></a>

<a name="2031537"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >AdamRedwoods</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#86">[#86]</a></td></tr></table></td></tr><tr ><td class="posttext"> Ok, I've started to get XNA working with this new integration. Still a few problems left, and android is too slow (vertex animation) so I'll need to work on those issues, too. XNA integration has slowed me down a little.<br><br>fyi Rone, since we've discussed this a little, i've set up the new format as follows (if you want to):<br><pre class=code>
+modules
++minib3d
+++gl
----opengles11.monkey
----opengles20.monkey
----tpixmapgl.monkey (and others, etc)
+++xna
----xna_render.monkey
----xna_pixmap.monkey (and others, etc)
++++xna_driver
-----xna.monkey
+++++native
------xna.xna.cs
</pre><br><br>so now to choose a driver, people are forced to do:<br>[monkeycode]<br>Import minib3d.gl.opengles11<br>'' ...or...<br>Import minib3d.gl.opengles20<br>'' ...or...<br>Import minib3d.xna<br><br>''then<br>SetDriver(flags) ''or whatever call to init()<br>[/monkeycode]<br>this keeps hardware implementations tidy in their own folder and removes #MINIB3D_DRIVER.<br><br>...more to come later, as minib3d+monkey v0.30 will be a massive change, but will offer new targets and shaders. <br><br></td></tr></table><br>
<a name="2031555"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Amon</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#87">[#87]</a></td></tr></table></td></tr><tr ><td class="posttext"> Lovely! :) <br><br></td></tr></table><br>
<a name="2031601"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >CopperCircle</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#88">[#88]</a></td></tr></table></td></tr><tr ><td class="posttext"> Hi, is there a limit on verts with b3d files? I have converted a couple of simple models and they load, draw once and then it crashes... <br><br></td></tr></table><br>
<a name="2031609"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >AdamRedwoods</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#89">[#89]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> Hi, is there a limit on verts with b3d files? <br></div><br>I removed that limit, but there is a trimverts function which caps at 1,000,000 verts. Is this opengl or xna? <br><br></td></tr></table><br>
<a name="2031615"></a>

<a name="2031616"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Beaker</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#90">[#90]</a></td></tr></table></td></tr><tr ><td class="posttext"> Keep it up. Looks great. <br><br></td></tr></table><br>
<a name="2031639"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >AdamRedwoods</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#91">[#91]</a></td></tr></table></td></tr><tr ><td class="posttext"> Obligatory 100 zombies screenshot. Opengl lighting is backward. XNA lighting does not allow attenuation, or point lights. But if XNA is going to DirectX, then that should help, but will mean a rewrite for this target.<br><br><img src="http://i295.photobucket.com/albums/mm144/adamredwoods/xna.jpg"> <br><br></td></tr></table><br>
<a name="2031638"></a>

<a name="2031653"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rone</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#92">[#92]</a></td></tr></table></td></tr><tr ><td class="posttext"> Hey, looks good... also the import stuff is very clean now!<br><br>Looking forward to your gles20 implementation...I have implemented the external xna interface for pss target. Your shaders should work there, without magnificent changes...<br><br><br><div class="quote"> <br>But if XNA is going to DirectX, then that should help, but will mean a rewrite for this target.<br> <br></div><br>Hopefully, they just unlock custom effects on windows phone. Anyway I will implement a shader driven xna driver. Then the missing features must only be considered if Windows Phone is targeted. <br><br></td></tr></table><br>
<a name="2031652"></a>

<a name="2031649"></a>

<a name="2031650"></a>

<a name="2031651"></a>

<a name="2031648"></a>

<a name="2031647"></a>

<a name="2031665"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >CopperCircle</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#93">[#93]</a></td></tr></table></td></tr><tr ><td class="posttext"> Hi Adam, it's OpenGL and the model has less than 10,000 verts, I am saving to a b3d from UU3D and then converting to base64, it does load and draw it but then just crashes, If I create a simple shape in UU3D and do the same it works...<br><br>Thanks. <br><br></td></tr></table><br>
<a name="2031666"></a>

<a name="2031667"></a>

<a name="2031668"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rone</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#94">[#94]</a></td></tr></table></td></tr><tr ><td class="posttext"> @CopperCircle<br><br>Did you try to run the native project(.build\glfw\vc2010\MonkeyGame.sln)?<br>You need to enable C++ Exceptions at Debug-&gt;Exceptions...<br><br>Visual Studio shows the method/line where the error occurs, if monkey does not. <br><br></td></tr></table><br>
<a name="2031686"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >AdamRedwoods</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#95">[#95]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote">  it does load and draw it but then just crashes <br></div><br>i'll either need a crash error or you can send me the model at my spam account (remove the nospam):<br>awNOSPAMpiette at NOSPAMyahoo dotcom. <br><br></td></tr></table><br>
<a name="2031693"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >CopperCircle</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#96">[#96]</a></td></tr></table></td></tr><tr ><td class="posttext"> Thanks, I email the model over and Rone I'll try running it in Visual Studio to find the error location. <br><br></td></tr></table><br>
<a name="2031700"></a>

<a name="2031701"></a>

<a name="2031702"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rone</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#97">[#97]</a></td></tr></table></td></tr><tr ><td class="posttext"> Here's an update of my xna implementation..<br><br>*fixed a few bugs<br>*implemented basic pss target(showing a black screen...but compiles at least :) )<br><br>@Adam<br>The upload contains also an incompatible b3d model(ind1_hall1.b3d). Crashes at TrimVerts ... if I remember correctly.<br><br><a href="http://www.load.to/Ebdsd8T1Sx/minib3d_40.rar" target="_blank">http://www.load.to/Ebdsd8T1Sx/minib3d_40.rar</a><br><br>Edit: <br>added 'f = f.Replace(".tga",".png")' to LoadPixmap, because of the model tries to load .tga files) <br><br></td></tr></table><br>
<a name="2031698"></a>

<a name="2031699"></a>

<a name="2032008"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >CopperCircle</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#98">[#98]</a></td></tr></table></td></tr><tr ><td class="posttext"> Hi Adam, did you get my email with the b3d model? <br><br></td></tr></table><br>
<a name="2032042"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >AdamRedwoods</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#99">[#99]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> <br>Hi Adam, did you get my email with the b3d model?  <br></div><br>I did, sorry to be slow. I tried it out and it worked in v0.20 that I posted on github.<br>I did get an error in tbrush, but deleted the line and it worked.<br><br>Are you using the latest v0.20? I may have updated it in a few places (i'm very bad at versioning), try updating TSurface.monkey and TModelB3D.monkey. <br><br></td></tr></table><br>
<a name="2032197"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >CopperCircle</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#100">[#100]</a></td></tr></table></td></tr><tr ><td class="posttext"> I have made sure i'm on the latest but my ship model still makes it crash as soon as it runs.<br><br>HEAP CORRUPTION DETECTED:after Normal block (#108605) at 0x08A246C8.<br>CRT detected that the application wrote to memory after the end of heap buffer.<br><br>In VS2010 (with c++ exceptions enabled) It just says:<br>The program '[1404] MonkeyGame.exe: Native' has exited with code 3 (0x3).<br><br>Thanks. <br><br></td></tr></table><br>
<a name="2032220"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rone</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#101">[#101]</a></td></tr></table></td></tr><tr ><td class="posttext"> You must also enable 'Win32 Exceptions'(best is enable all)... Visual Studio will break at the line where the error occurs. Go through the call stack, in order to find the accordant miniB3D method...<br>'----------------------------------------------------------------<br><br>xna update:<br><br>* fixed a lot of issues with the external xna interface<br>* added missing methods to XNAEffect &amp; XNAEffectParameter<br>* added HLSL driver for xbox360 and windows( shader is not complete yet..just an ugly test shader)<br>* implemented Matrix &amp; Vector extern.( Might be slow on android currently, but this way the different APIs will collaborate much better with miniB3d)<br><br><a href="http://www.load.to/GMcByhPCIz/minib3d_v60.zip" target="_blank">http://www.load.to/GMcByhPCIz/minib3d_v60.zip</a><br><br>Since .fx files needs a different content- importer and processor, its necessary to change the xna target as follows:<br><br>src\trans\target.monkey<br><textarea class=codebox name="code" wrap=OFF readonly="true" rows="15" cols="80">
Field FX_FILES$
'...
FX_FILES=Env.Get( "FX_FILES" )
'...
If FX_FILES    DATA_FILES+="|"+FX_FILES
</textarea><br><br>src\trans\targets\xna.monkey<br><textarea class=codebox name="code" wrap=OFF readonly="true" rows="15" cols="80">
 If MatchPath( r,FX_FILES )
         cont.Push "  &lt;ItemGroup&gt;"
         cont.Push "    &lt;Compile Include=~q"+t+"~q&gt;"
         cont.Push "      &lt;Name&gt;"+f+"&lt;/Name&gt;"
         cont.Push "      &lt;CopyToOutputDirectory&gt;Always&lt;/CopyToOutputDirectory&gt;"
         cont.Push "      &lt;Importer&gt;EffectImporter&lt;/Importer&gt;"
         cont.Push "      &lt;Processor&gt;EffectProcessor&lt;/Processor&gt;"
         cont.Push "    &lt;/Compile&gt;"
         cont.Push "  &lt;/ItemGroup&gt;"
</textarea><br><br>targets\xna\CONFIG<br><textarea class=codebox name="code" wrap=OFF readonly="true" rows="15" cols="80">
- FX_FILES=*.fx
</textarea><br><br>Then build and run \src\rebuildall.bmx. <br><br></td></tr></table><br>
<a name="2032218"></a>

<a name="2032219"></a>

<a name="2032211"></a>

<a name="2032209"></a>

<a name="2032210"></a>

<a name="2032207"></a>

<a name="2032208"></a>

<a name="2032203"></a>

<a name="2032204"></a>

<a name="2032205"></a>

<a name="2032206"></a>

<a name="2032198"></a>

<a name="2032201"></a>

<a name="2032202"></a>

<a name="2032314"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >CopperCircle</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#102">[#102]</a></td></tr></table></td></tr><tr ><td class="posttext"> Thanks Rone, turns out it was my models, I was using UU3D to texture and save as .B3D, I loaded them into the trail of fragMotion and saved them again and they now work.<br><br>I'm planning to port a level from my 3D XNA game to Monkey minib3d and then compile to all platforms (including XNA again) and compare results/speed... <br><br></td></tr></table><br>
<a name="2032328"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rone</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#103">[#103]</a></td></tr></table></td></tr><tr ><td class="posttext"> Adam,<br><br>I found a bug in opengles11.monkey:<br><br>In UpdateLight, glLoadMatrixf(light.mat.ToArray() ) needs to be replaced with glMultMatrixf(light.mat.ToArray() ). I wonder how that worked ever since your screenshots look correct, but I get only right results with glMultMatrix..?<br><br>I'm also confused about the attenuation factors you use...cause I'm not able to reproduce the same lighting using the same factors with hlsl<br><br>While trying to connect the attenuation factors with the light range, I found this explanation: <br><br><a href="http://imdoingitwrong.wordpress.com/2011/01/31/light-attenuation/" target="_blank">http://imdoingitwrong.wordpress.com/2011/01/31/light-attenuation/</a><br><br>att = 1  / ((d/r)+1)^2 <br>==&gt; att = 1 / (1+(2/r)*d + (1/r^2)*d^2)<br><br>Using this factors, I get much better results and can repoduce the ogl lighting, more or less.<br><br>What do you think about it? <br><br></td></tr></table><br>
<a name="2032327"></a>

<a name="2032326"></a>

<a name="2032345"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >CopperCircle</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#104">[#104]</a></td></tr></table></td></tr><tr ><td class="posttext"> Just a quick note, ExtractAnimSeq does not work until you increase the first/last array size in tentity.monkey<br><br>Field anim_seqs_first:Int[1]<br>Field anim_seqs_last:Int[1] <br><br></td></tr></table><br>
<a name="2032414"></a>

<a name="2032415"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >AdamRedwoods</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#105">[#105]</a></td></tr></table></td></tr><tr ><td class="posttext"> Ok, thanks for finding these bugs!<br><br>For ExtractAnimSeq and LoadAnimSeq in TEntity.monkey, the array needs a Resize(). I've updated this for the next version.<br><textarea class=codebox name="code" wrap=OFF readonly="true" rows="15" cols="80">
	Method ExtractAnimSeq(first_frame,last_frame,seq=0)
	
		no_seqs=no_seqs+1
	
		' expand anim_seqs array
		anim_seqs_first=anim_seqs_first.Resize(no_seqs+1)
		anim_seqs_last=anim_seqs_last.Resize(no_seqs+1)
	
		' if seq specifed then extract anim sequence from within existing sequnce
		Local offset=0
		If seq&lt;&gt;0
			offset=anim_seqs_first[seq]
		Endif
	
		anim_seqs_first[no_seqs]=first_frame+offset
		anim_seqs_last[no_seqs]=last_frame+offset
		
		Return no_seqs
	
	End 
</textarea><br><br><br><br>For light attenuation, it took a while to match miniB3D.<br>The light distance equation for my pixel shader is:<br><pre class=code>
d = (lightAtt[0].w* spotlight) / ( lightAtt[0].x + (lightAtt[0].y* dist) + (lightAtt[0].z*(dist * dist)) ) ;
if (lightType[0] ==1.0) d=1.0;
			
lambertTerm = clamp(NdotL * d  , 0.0, 1.0) ;
</pre><br>where lightAtt[].xyzw is<br>light[0].const_att, light[0].lin_att, light[0].quad_att, light[0].actual_range<br><br>Note I added an actual range value. minib3d originally stored the 1.0/range (which i kept intact, thus needing an actual_range variable). <br><br></td></tr></table><br>
<a name="2032413"></a>

<a name="2032412"></a>

<a name="2032417"></a>

<a name="2032418"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rone</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#106">[#106]</a></td></tr></table></td></tr><tr ><td class="posttext"> whats spotlight? <br>if lightType[0] = 2 then spotlight = 1 ???<br><br>Do you use no attenuation at all, if lightType[0] == pointlight  ??? <br><br></td></tr></table><br>
<a name="2032436"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >AdamRedwoods</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#107">[#107]</a></td></tr></table></td></tr><tr ><td class="posttext"> Spotlight =1 for point lights<br><br>Spotlight = the spotlight equation which includes cone falloff, etc. <br><br></td></tr></table><br>
<a name="2032842"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >CopperCircle</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#108">[#108]</a></td></tr></table></td></tr><tr ><td class="posttext"> Small bug, One Shot Animation would only work once until I changed trender to this:<br><br><pre class=code>
ElseIf mesh.anim_mode = 3 ''one-shot, hold at end
			
  mesh.anim_time=mesh.anim_time+(mesh.anim_speed*anim_speed)
  If mesh.anim_time&gt;last
    'mesh.anim_time=last
    mesh.anim_time = first + (mesh.anim_time - last)
    mesh.anim_mode = 0
  Endif
					
Endif
</pre> <br><br></td></tr></table><br>
<a name="2033017"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rone</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#109">[#109]</a></td></tr></table></td></tr><tr ><td class="posttext"> Bug in opengles11.monkey.<br><br>When rendering multiple objects with different count of textures, the texture layers are not deactivated properly.<br><br>Added the following fix to OpenglES11.Render:<br><pre class=code>
if tex_count &lt; last_tex_count 
				For Local i = tex_count until 8
					glActiveTexture(GL_TEXTURE0+i)
					glClientActiveTexture(GL_TEXTURE0+i)
					' reset texture matrix
					glMatrixMode(GL_TEXTURE)
					glLoadIdentity()
					glDisable(GL_TEXTURE_2D)
				Next
			EndIf
			last_tex_count = tex_count
			
			For Local ix=0 To tex_count-1	
		        ...
</pre> <br><br></td></tr></table><br>
<a name="2033220"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rone</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#110">[#110]</a></td></tr></table></td></tr><tr ><td class="posttext"> Adam,<br>How are things going with the GLSL version? I'm really interested in how you've solved the things.<br><br>I got a nearly feature complete hlsl version running...and although I have not much experience with shaders and its not optimized... it runs pretty fast - up to twice as fast as the gles11 with 4 lights, a 512x512 terrain and 1000 trees. <br>But only shader version 3 for now.<br><br><textarea class=codebox name="code" wrap=OFF readonly="true" rows="15" cols="80">
//-----------------------------------------------------------------------------
//
// miniB3d fixed function shader
//
// Author: 	Sascha Schmidt aka Rone
//
// supports
//  *up to 4 lights (directional-, point- and spot- lights).
//  *up to 8 texture layer
//  *texture scaling an offset per layer
//  *texture coords per layer
//	*texture blend per layer
//  *simple fog
//  *vertexcolor &amp; vertexalpha
//
//-----------------------------------------------------------------------------

//-----------------------------------------------------------------------------
// Texture sampler
//-----------------------------------------------------------------------------

uniform extern int textureCount = 0;

uniform extern texture texture0;
uniform extern texture texture1;
uniform extern texture texture2;
uniform extern texture texture3;
uniform extern texture texture4;
uniform extern texture texture5;
uniform extern texture texture6;
uniform extern texture texture7;

sampler textureSampler[8] = 
{
sampler_state { Texture = &lt;texture0&gt;;AddressU = Wrap; AddressV = Wrap; },
sampler_state { Texture = &lt;texture1&gt;;AddressU = Wrap; AddressV = Wrap; },
sampler_state { Texture = &lt;texture2&gt;;AddressU = Wrap; AddressV = Wrap; },
sampler_state { Texture = &lt;texture3&gt;;AddressU = Wrap; AddressV = Wrap; },
sampler_state { Texture = &lt;texture4&gt;;AddressU = Wrap; AddressV = Wrap; },
sampler_state { Texture = &lt;texture5&gt;;AddressU = Wrap; AddressV = Wrap; },
sampler_state { Texture = &lt;texture6&gt;;AddressU = Wrap; AddressV = Wrap; },
sampler_state { Texture = &lt;texture7&gt;;AddressU = Wrap; AddressV = Wrap; },
};

struct CTextureStageStage
{
	float2 scale;
	float2 offset;
	int blend;
	int coords;
};

CTextureStageStage textureStages[8];

//-----------------------------------------------------------------------------
// Fog settings
//-----------------------------------------------------------------------------

uniform extern float fogNear;
uniform extern float fogFar;
uniform extern float3 fogColor;


//-----------------------------------------------------------------------------
// Material settings
//-----------------------------------------------------------------------------

uniform extern float4 diffuseColor;
uniform extern float4 ambientColor;
uniform extern float  shininess;


//-----------------------------------------------------------------------------
// Lights
// All directions and positions are in world space and must be unit vectors
//-----------------------------------------------------------------------------

struct CLight
{
   int iType;
   float4 vPos;
   float4 vDir;
   float4 vAmbient;
   float4 vDiffuse;
   float4 vSpecular;
   float  fRange;
   float3 vAttenuation; //1, D, D^2;
   float3 vSpot;        //cos(theta/2), cos(phi/2), falloff
};

//initial and range of directional, point and spot lights within the light array
uniform extern int iLightDirIni;
uniform extern int iLightDirNum;
uniform extern int iLightPointIni;
uniform extern int iLightPointNum;
uniform extern int iLightSpotIni;
uniform extern int iLightSpotNum;

CLight lights[4];

struct COLOR_PAIR
{
   float3 Color;
   float3 ColorSpec;
};


//-----------------------------------------------------------------------------
// Matrices
//-----------------------------------------------------------------------------

uniform extern float4x4 world;		
uniform extern float4x4 view;		
uniform extern float4x4 projection;	

uniform const float3	EyePosition;

//-----------------------------------------------------------------------------
// Structure definitions
//-----------------------------------------------------------------------------

struct VertexShaderInput 
{
	 float4 Position					:	POSITION;
     float4 Color						:	COLOR0;
	 float3 Normal						:	NORMAL;
     float2 TextureCoordinate0			:	TEXCOORD0;
	 float2 TextureCoordinate1			:	TEXCOORD1;
};

struct VertexShaderOutput 
{
	 float4 Position					:	POSITION;
     float4 Color						:	COLOR0;
	 float3 Normal						:	NORMAL;
	 float2 TextureCoordinate0			:	TEXCOORD0;
	 float2 TextureCoordinate1			:	TEXCOORD1;
	 float4 WorldPosition				: 	TEXCOORD2;
	 float4x4 LightDir					:   TEXCOORD3;
	 float  Fog 						:	TEXCOORD7;
};

struct PixelShaderOutput
{
    float4 Color 						: 	COLOR0;
};

//-----------------------------------------------------------------------------
// Compute point light
//-----------------------------------------------------------------------------

COLOR_PAIR DoPointLight(float3 lightDir, float3 E, float3 N, float att)
{
	COLOR_PAIR r = (COLOR_PAIR)0;
	float3 L = normalize(lightDir);

	float lambertTerm = clamp(dot(N,L),0.f,1.f);
	if(lambertTerm &gt; 0.0) 
	{
		r.Color = lambertTerm * att;
		r.ColorSpec = shininess * pow(saturate(dot(reflect(-L, N),E)),  80.0f)* att;
	}
	return r;
}

//-----------------------------------------------------------------------------
// Compute spot light
//-----------------------------------------------------------------------------

COLOR_PAIR DoSpotLight(float3 lightDir,float3 E, float3 N, float3 dir, float att, float theta, float pi)
{
	COLOR_PAIR r = (COLOR_PAIR)0;
	float3 L = normalize(lightDir);
	
	float lambertTerm = clamp(dot(N,L),0.f,1.f);
	if(lambertTerm &gt; 0.0)
	{
		float angle = acos(dot(-normalize(lightDir.xyz),normalize(dir)));
		float f = smoothstep(theta, pi,angle );
		
		r.Color = lambertTerm * att *f;
		r.ColorSpec =  shininess * pow(saturate(dot(reflect(-L, N),E)),  80.0f)* att*f;
	}
	return r;
}

//-----------------------------------------------------------------------------
// Compute directional light
//-----------------------------------------------------------------------------

COLOR_PAIR DoDirLight(float3 lightDir,float3 E, float3 N)
{
	COLOR_PAIR r = (COLOR_PAIR)0;
	float3 L = normalize(-lightDir);
	float lambertTerm =  clamp(dot(N,L),0.f,1.f);
	r.Color = lambertTerm;
	r.ColorSpec = 10*shininess * pow(saturate(dot(reflect(-L,N),E)),  80.0f);
	return r;
}

//-----------------------------------------------------------------------------
// Pixel shader
//-----------------------------------------------------------------------------
	
float4 PixelShaderX(VertexShaderOutput input,
							uniform int vertexcolor,
							uniform int textures,
							uniform int lighting,
							uniform int fog, uniform int coords) : COLOR
{
	 int i =0;
	 
	 float4 color;
	 if( !vertexcolor )
	 {
	 	color = input.Color;
  	 }
	 else
	 {
	 	color = diffuseColor;
	 }
	 
	 float3 shading = ambientColor;
	 float3 specular = 0;
	 
	 if( textures )
	 {
	    for( i = 0; i&lt; textureCount; ++i) 
		{
			 // get coords for selected index
			 float2 ccc = (1-textureStages[i].coords)*input.TextureCoordinate0 + (textureStages[i].coords)*input.TextureCoordinate1;
			 ccc *= textureStages[i].scale + textureStages[i].offset;
			 
			 // sample texture
			 float4 c = tex2D(textureSampler[i], ccc );
			 color = (1-textureStages[i].blend) * (color + c) + // add
			 		 (textureStages[i].blend)   * (color * c);	// multiply;
		}
	 }
	  
	 if( lighting ) 
	 {
	 	int index;
	 	COLOR_PAIR p;
		
	 	float3 N = normalize(input.Normal);
		float3 E = normalize(EyePosition - input.WorldPosition.xyz);
		
		for( i = 0; i&lt; iLightDirNum; ++i)
		{
			index = iLightDirIni+i;
			p = DoDirLight(lights[index].vDir,E,N);
			shading += p.Color * lights[index].vDiffuse;
			specular += p.ColorSpec;
		}
			
		for( i = 0; i&lt; iLightPointNum; ++i) 
		{
			index = iLightPointIni+i;
			p =  DoPointLight(input.LightDir[index].xyz,E,N,input.LightDir[index].w);
			shading += p.Color * lights[index].vDiffuse;
			specular += p.ColorSpec;
		}
	 
	 	for( i = 0; i&lt; iLightSpotNum; ++i)
		{
			index = iLightSpotIni+i;
	  		p =  DoSpotLight(
								input.LightDir[index].xyz, E,N, 
								lights[index].vDir, 
								input.LightDir[index].w, 
								lights[index].vSpot.x,
								lights[index].vSpot.y);
								
	 		shading += p.Color * lights[index].vDiffuse;
			specular += p.ColorSpec;
		}
		
		color.rgb *= saturate(shading);
	 }

	 if( fog )
	 {
	 	color.rgb  = lerp(color.rgb  ,fogColor, input.WorldPosition.z);
	 }
	 
	 return color + float4(specular,0);
}

//-----------------------------------------------------------------------------
// Vertex shader
//-----------------------------------------------------------------------------

VertexShaderOutput VertexShaderX(VertexShaderInput input,
							uniform int vertexcolor,
							uniform int textures,
							uniform int lighting,
							uniform int fog) 
										
{
	 VertexShaderOutput output = (VertexShaderOutput)0;
	 float4 worldPosition = mul(input.Position, world);
	 float4 viewPosition = mul(worldPosition, view);
	 output.Position = mul(viewPosition, projection);
	 
	 if(!vertexcolor)
	 {
	 	output.Color = input.Color;
	 }
	 
	 if(textures)
	 {
	 	output.TextureCoordinate0 = input.TextureCoordinate0;
	 	output.TextureCoordinate1 = input.TextureCoordinate1;	
	 }
	 
	 if( lighting )
	 {
		output.Normal =  mul(input.Normal,(float3x3)world);
		output.WorldPosition = worldPosition;
	
		for( int i = 0; i&lt; 4; ++i )
		{
			 output.LightDir[i] = lights[i].vPos - worldPosition;
			 //float LD = length(output.LightDir[i]);
			 //output.LightDir[i].w = 1.0f/(lights[i].vAttenuation.x + lights[i].vAttenuation.y*LD + lights[i].vAttenuation.z*LD*LD);	
			 output.LightDir[i].w = 1.0f/(lights[i].fRange*length(output.LightDir[i]));	
		}
		 
	 }
	 
	 if(fog)
	 {
	 	 output.WorldPosition.z  = saturate((length(EyePosition-worldPosition) - fogNear)/(fogFar - fogNear)); 
	 }
	
	 return output;
}

//-----------------------------------------------------------------------------
// Shader and technique definitions
//-----------------------------------------------------------------------------


VertexShader VSArray[16] =
{
	 compile vs_3_0 VertexShaderX(0,0,0,0),
	 compile vs_3_0 VertexShaderX(0,0,0,1),
	 compile vs_3_0 VertexShaderX(0,0,1,0),
	 compile vs_3_0 VertexShaderX(0,0,1,1),
	 compile vs_3_0 VertexShaderX(0,1,0,0),
	 compile vs_3_0 VertexShaderX(0,1,1,1),
	 compile vs_3_0 VertexShaderX(0,1,1,0),
	 compile vs_3_0 VertexShaderX(0,1,1,1),
	 compile vs_3_0 VertexShaderX(1,0,0,0),
	 compile vs_3_0 VertexShaderX(1,0,0,1),
	 compile vs_3_0 VertexShaderX(1,0,1,0),
	 compile vs_3_0 VertexShaderX(1,0,1,1),
	 compile vs_3_0 VertexShaderX(1,1,0,0),
	 compile vs_3_0 VertexShaderX(1,1,0,1),
	 compile vs_3_0 VertexShaderX(1,1,1,0),
	 compile vs_3_0 VertexShaderX(1,1,1,1)
};

PixelShader PSArray[16] =
{
	 compile ps_3_0 PixelShaderX(0,0,0,0,1),
	 compile ps_3_0 PixelShaderX(0,0,0,1,1),
	 compile ps_3_0 PixelShaderX(0,0,1,0,1),
	 compile ps_3_0 PixelShaderX(0,0,1,1,1),
	 compile ps_3_0 PixelShaderX(0,1,0,0,1),
	 compile ps_3_0 PixelShaderX(0,1,0,1,1),
	 compile ps_3_0 PixelShaderX(0,1,1,0,1),
	 compile ps_3_0 PixelShaderX(0,1,1,1,1),
	 compile ps_3_0 PixelShaderX(1,0,0,0,1),
	 compile ps_3_0 PixelShaderX(1,0,0,1,1),
	 compile ps_3_0 PixelShaderX(1,0,1,0,1),
	 compile ps_3_0 PixelShaderX(1,0,1,1,1),
	 compile ps_3_0 PixelShaderX(1,1,0,0,1),
	 compile ps_3_0 PixelShaderX(1,1,0,1,1),
	 compile ps_3_0 PixelShaderX(1,1,1,0,1),
	 compile ps_3_0 PixelShaderX(1,1,1,1,1),
};


int ShaderIndex = 0;

technique t1 { pass P0 {
    VertexShader = VSArray[ShaderIndex]; PixelShader	 = PSArray[ShaderIndex];
}}
</textarea><br><br>will upload tomorrow, need to clean up a little first :) <br><br></td></tr></table><br>
<a name="2033212"></a>

<a name="2033211"></a>

<a name="2033210"></a>

<a name="2033246"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rex Rhino</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#111">[#111]</a></td></tr></table></td></tr><tr ><td class="posttext"> Wow! That is super exciting!<br><br>I don't know anything about HLSL, but I cobbled together a nice GSGL shader that was basically the old OpenGL fixed pipeline stuff, except with the addition of normal mapping and illumination mapping, figuring that would be highly usable for just about any vaugly realistic game.<br><br>It would be cool to have a generic shader built in that is highly useful for those who don't need to make highly customized shader. <br><br></td></tr></table><br>
<a name="2033249"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >AdamRedwoods</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#112">[#112]</a></td></tr></table></td></tr><tr ><td class="posttext"> funny you should ask, i'm tidying up and getting ready to upload v0.30.<br><br>great to hear xna is coming along! very exciting.<br><br>for my v0.30 I've added in an earlier version of your xna and changed a few things, but we'll have to circle back after both versions are out and see how we can integrate them better. <br><br></td></tr></table><br>
<a name="2033281"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Rone</td><td align="right"><font class=tiny>(Posted 2012)</font>&nbsp;<a href="#113">[#113]</a></td></tr></table></td></tr><tr ><td class="posttext"> Edit: wrong thread <br><br></td></tr></table><br>
<a name="2033280"></a>

<a name="2033279"></a>

<a name="2033278"></a>

<a name="bottom"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td align="right"><a href="http://monkeycoder.co.nz" target="_blank"><img src="/img/monkey2.svg" ></a> <a href="https://github.com/blitz-research" target="_blank"><img src="/img/github.svg" ></a> <a href="https://discord.gg/qJccbSp" target="_blank"><img src="/img/discord.svg" ></a></td></tr></table><br></div><br><table width="100%"><tr><td></body></html lang="en">
