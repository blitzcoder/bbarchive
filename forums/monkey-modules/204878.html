<!DOCTYPE html><html lang="en" ><head ><title >Monkey-UTF8: Full unicode plane support</title><meta name='viewport' content='width=device-width, initial-scale=0.66'><meta name='description' content='language:basic, target:desktop, category:game development'><link rel="styleSheet" href="../skins/granite/style.css" type="text/css"><style type="text/css">div.bbcode {padding: 8px;background: #E5E5E5;color: #000000;border: 1px dashed #B4B4BE;}</style></head><body ><table width=100% cellspacing=0 cellpadding=0><tr ><td class="menubarleft"></td><td class="menubar"><table cellspacing="0" cellpadding="0"><tr ><td >&nbsp;</td><td class="menuitemleft"></td><td class="menuitem"><a href="/" class="menuitem">News</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/forums.php" class="menuitem">Forums</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/codearcs.php" class="menuitem">Code</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/logs.php" class="menuitem">Logs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/gallery.php" class="menuitem">Gallery</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/sdkspecs.php" class="menuitem">Specs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/search.php" class="menuitem">Search</a></td><td class="menuitemright"></td></tr></table></td><td class="menubarright"></td></tr></table><div class="main"><h1 >Monkey-UTF8: Full unicode plane support</h1><a href="forums.php" >Monkey Forums</a>/<a href="topics.php?forum=524" >User Modules</a>/<a href="#bottom" >Monkey-UTF8: Full unicode plane support</a><br><br>
<a name="2053148"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Nobuyuki</td><td align="right"><font class=tiny>(Posted 2013)</font>&nbsp;<a href="#1">[#1]</a></td></tr></table></td></tr><tr ><td class="posttext"> <b>This is a library to add basic UTF-8 parsing and display support to your Monkey projects.</b>  It can't match the convenience of the built-in String type, but (with a little effort) can store and display any character available to Unicode, including ones on extended planes.<br><br><img src="https://s3.amazonaws.com/uploads.hipchat.com/11212/31746/efbg08hlrtk34ud/AngelFontUTF8.png"><br><br>This lib also includes a hacked version of the last stable build of AngelFont, which has been altered to support full unicode strings.<br><br><b>Q:  What do I need this for?</b><br>A:  Monkey has some native support for unicode strings, but they are limited to the 16-bits.  This means that only 65536 characters are available, locking out supplementary planes useful for displaying certain glyphs. Emoji, Japanese graphical emoticons, are quickly gaining support in the west, and are becoming popular amongst both smartphone users and the online community at large (eg: github). With this library, you can handle strings which contain emoji, or any character whose codepoint exists beyond $FFFF in the address space.<br><br><b>Q:  Can I retrieve a pure UTF-8 string from a TCPStream?</b><br>A:  Not yet!  There is no technical reason it can't be supported, I just haven't implemented it yet.  Maybe hopefully soon, if someone doesn't fork the project and beat me to it :)<br><br><b>Q:  Then, how can I retrieve a UTF-8 string?</b><br>A:  Right now, use the LoadString() function and point it to a text file.  This opens a FileStream relative to your data folder and returns a UTF8String object.<br><br><b>Q:  Okay, I want it.  So, how do I build a multi-lingual font?</b><br>A:  Use one of the many tools available which supports the xml .fnt format, like AngelCode's BMFont.  Be aware though that they don't support Unicode 6.1 yet, and hacking emoji and multiplane stuff in manually was a rather crash-laden affair for me!  Bug reports, bug reports, how do I file them?  That being said, all the common languages and Basic Multilingual Plane (BMP) codepoints should export nicely.<br><br><b>Community Challenges:</b><br><br>In the process of writing this code, I came across a number of issues and considerations that have the potential to be addressed through the community in a collective fashion.  Therefore, I have some challenges for the community which we can try to meet if there is enough demand for it:<br><br><b>*</b> Getting UTF8.LoadString to work on HTML5 without DataBuffers. There's no HTML5 support for this lib yet, and there's no reason why there shouldn't be!  It's just that right now, the only method for loading a UTF8 string is through brl.FileStream.  This can be worked around with a native method by someone more skilled in javascript than me -- <a href="http://jsfromhell.com/classes/binary-parser" target="_blank">http://jsfromhell.com/classes/binary-parser</a> looks promising, for example!<br><br><b>*</b> Improving AngelFont's performance. The last stable version of AngelFont used a fixed-sized Int array to support ASCII only.  My hacked version uses a hybrid array/IntMap system now, but can it be improved?  Please leave your comments below!<br><b>*</b> Improving AngelFont's source. This code's a mess - It mixes static and instance variables in the lib (AngelFont.current), probably for backwards-compatibility.  The ctor is also broken and would be confusing to a newcomer to AngelFont since it uses depreciated methods, probably for the same reason!  I've written a wrapper to work around these issues in the past, but perhaps it's time to give AngelFont an overhaul?  Let's make SimpleTextBox and AngelFont both fully instance-oriented and compatible with each other!<br><b>*</b> Improving SimpleTextBox's source.  IntStacks are used extensively in the new UTF8 methods, and there is a lot of duplicated code in there.  Can it be improved?  Comment below!<br><br>I've also set out a few challenges to myself, which I hope I can address in future iterations of this code:<br> <br><b>*</b> Improving UTF8String to support common string operations, such as Concat, Substr, Find/FindLast, Split, Format.  None of this is in there yet, hopefully coming soon!<br><b>*</b> Attempting to implement the above functions without relying too heavily on IntStacks.  Finding the fastest way to allocate temp units ahead of time could be tricky and/or take a bit of effort.<br><b>*</b> Separating out the LoadString() code from the actual parsing, so that brl.FileStream isn't a requirement, and TCPStreams can be used too.<br><br><br><b>Download:</b><br><a href="https://github.com/nobuyukinyuu/monkey-utf8" target="_blank">https://github.com/nobuyukinyuu/monkey-utf8</a>  (click the ZIP button, or clone it!) <br><br></td></tr></table><br>
<a name="2053141"></a>

<a name="2053142"></a>

<a name="2053146"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >c.k.</td><td align="right"><font class=tiny>(Posted 2013)</font>&nbsp;<a href="#2">[#2]</a></td></tr></table></td></tr><tr ><td class="posttext"> Wow, there's a lot of brain power in this forum. Well done! <br><br></td></tr></table><br>
<a name="2053150"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Samah</td><td align="right"><font class=tiny>(Posted 2013)</font>&nbsp;<a href="#3">[#3]</a></td></tr></table></td></tr><tr ><td class="posttext"> I should probably look at making the Diddy I18N module support this, somehow. <br><br></td></tr></table><br>
<a name="2053233"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Nobuyuki</td><td align="right"><font class=tiny>(Posted 2013)</font>&nbsp;<a href="#4">[#4]</a></td></tr></table></td></tr><tr ><td class="posttext"> <b>Update:  </b>HTML5 is now supported. Separated the classes into separate files, separated the file loading/streaming methods from the parsing methods.  <br><br>The class now also supports UTF-16 surrogate pair encoding/decoding -- Making me wonder if I should've called this class UTF8!  But anyway, this means you can specify whether to pass these surrogate pairs directly through a monkey.String. On HTML5 specifically, this means that your browser handles the encoding automatically, which means you get full unicode in the debug output  ;D <br><br></td></tr></table><br>
<a name="2053240"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Midimaster</td><td align="right"><font class=tiny>(Posted 2013)</font>&nbsp;<a href="#5">[#5]</a></td></tr></table></td></tr><tr ><td class="posttext"> This is an excellent work and really important. The world not only uses US american characters and need UTF-8 im games! Only 14% of the sold apps go to US. That mean that we ignore 86% of possible customers. I would be very happy if I can support eastern languages in my apps.<br><br>The main problem is that we need a completely closed system. File-based and internenet-based streams have to support this, so that we do not loose language informations on the "transfer ways". If a customer sends me a file with translations, I have to be able to integrate it. If a customers sends character through the app, my server has to be able to store them... and so on.<br><br>Thanks a lot for this work. It would love to use it!!! What about the licence? Can we use it freely? What about the modified angel codes? What about support for the future? Are you plan to use this class for a long time in your own apps? <br><br>I like Angelfont too! It is easy an small. But it is slowly. Yesterday I started working on finding a faster workaround. Suddenly I noticed, that Angelfont becomes 10 times faster, if you render with SETCOLOR(255,255,255)<br><br>I created a new class DrawPhotoText(T$,0,0,font). Now I send phrases to this class. At first time the class renders the phrase with canvas propery SETMATRIX(0,0,0,0,0,0) and SETCOLOR(255,255,255), then "screengraps" the phrase to an array with READPIXELS(), re-correct the alpha channel of the image and stores all to a big image with WRITEPIXELS(). From the second call of DrawPhotoText(T$,0,0,font) with the same phrase it paints the complete image instead of the single characters. This is 5 times faster. <br><br></td></tr></table><br>
<a name="2053395"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Nobuyuki</td><td align="right"><font class=tiny>(Posted 2013)</font>&nbsp;<a href="#6">[#6]</a></td></tr></table></td></tr><tr ><td class="posttext"> Yes, I couldn't decide on the license, but I'd say feel free to use it for what you like.  Right now, it's on the honor system, but hopefully if you make good additions, contributions are always welcome!  Consider the license BSD/MIT/ZLib-like.  I can't decide between them, so I didn't include anything in the source tree.  Probably MIT or BSD 3-Clause, which are essentially the same thing.<br><br>I don't use read/write pixels in any projects yet, because I there is no separate off-screen surface support in Monkey afaik.  Many of the speed issues I can imagine associated with AngelFont might be creation of local variables which may be cache-able.  Of course, best practices are always to avoid using SetColor() on sprites on non-HWA targets, because that is usually slow!<br><br>The best improvements I can imagine being made to AngelFont would be to streamline and simplify the API itself;  Saner ctor defaults, less use of Globals, eliminating the alignment consts and replacing them with a float, etc.  Since I don't want to create a rift in usage, I kinda don't want to fork AngelFont to implement this stuff!  It depends on what people want, and what Beaker plans on doing with the project.. <br><br></td></tr></table><br>
<a name="2070138"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Nobuyuki</td><td align="right"><font class=tiny>(Posted 2013)</font>&nbsp;<a href="#7">[#7]</a></td></tr></table></td></tr><tr ><td class="posttext"> Now that BMFont 1.14 supports extended plane characters, I expect this lib might get a little bit more use.  The included version of AngelFont is still a big hack, but I might start doing some tests with it and incorporate the changes to angelfont-tryouts ( <a href="http://github.com/nobuyukinyuu/angelfont-tryouts" target="_blank">http://github.com/nobuyukinyuu/angelfont-tryouts</a> ) and not keep a split codebase.  <br><br>Accordingly, I'm starting to clean up the lib a little bit.  I'm considering replacing the FileStream stuff with DataBuffer stuff, to make it fully cross-compatible, and keep to the spirit of it being purely for UTF-8 -- The surrogate pair encoding is a nice trick to make extended planes work on HTML5 (and in debugger outputs!) but it's definitely a UCS2/UTF16 thing, and has little (if anything) to do with UTF-8.<br><br>The last update made has added Find/FindLast/Replace methods to the UTF8String class, and more string manip stuff will be forthcoming, including (hopefully) a normalization/folding function for those of you missing doing equivalence checks and sort collation with ToLower(). <br><br></td></tr></table><br>
<a name="2081137"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Aman</td><td align="right"><font class=tiny>(Posted 2014)</font>&nbsp;<a href="#8">[#8]</a></td></tr></table></td></tr><tr ><td class="posttext"> This is great. I was about to start porting this BlitzMax module to Monkey <a href="http://www.wieringsoftware.nl/blitz/" target="_blank">http://www.wieringsoftware.nl/blitz/</a><br><br>Thank god I did a thorough search first. This should be listed in the module registry. <br><br></td></tr></table><br>
<a name="2108187"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Nobuyuki</td><td align="right"><font class=tiny>(Posted 2015)</font>&nbsp;<a href="#9">[#9]</a></td></tr></table></td></tr><tr ><td class="posttext"> Big update posted!  I know it's been a while since I've visited this module, but for a while, I haven't needed it....<br>I decided to revisit it after starting a new project which might be a bit more text-heavy.  This was done as part of the process of making a new (modern) fork of AngelFont (coming soon?)  :)<br><br>Anyway, here's some of the new things you can see here:<br><b>utf8.monkey</b><br>* Full multiplatform support!  No more workarounds on html5 which break full SMP compatibility. <br>* No more having to screw with UTF-16/UCS2 supplemental pairs!  (Although you can still decode/encode these pairs for backwards-compatibility and interop with OS's that <i>absolutely must give/take</i> a ucs2 string....)<br><br><b>utf8string.monkey</b><br>* Case folding!  You can now convert UTF8Strings to/from lowercase, UPPERCASE, and Title Case.  Supports most languages with simple decomposition.<br>* Split operation -- Both Monkey style, and a new style which completely ignores nulls.<br>* ToString now supports autoboxing, for easier debugging.  Be careful using this! If you accidentally convert from UTF8String to String and back, you might not be able to figure out why your emoji are broken...<br>* Trim operation -- Works nearly identical to Monkey's.  <i>Does not trim Unicode control characters beyond U+0020</i>.  Comments on how to best handle this are welcome.<br>* Join operation -- Join multiple UTF8Strings together<br>* Contains() method<br><br><b>builder.monkey</b><br>* Brand new C++_Tool CaseFolding builder!  To update monkey-utf8's case folding tables, simply drop in a new CaseFolding.txt and run builder.monkey.  The output file may be used to update case folding mappings.<br>* In the future, this tool will be used to provide extended support for Turkic, decomposition of complex forms (German ß for example), and full normalization options.<br><br><br>Future features, maybe:<br>* UTF8StringMap&lt;T&gt;<br>* Collating and normalization for UTF8StringMap<br>* Full decomposition forms for case folding<br>* Normalization rules based on culture context, similar to .NET's CultureInfo<br>* Equality checking based on cultural context  (insert joke here....)<br>* UTF8String.Format()<br><br>Full commit details:  <a href="https://github.com/nobuyukinyuu/monkey-utf8/commit/bbe1a3a06f52baaf80f80698ccf58d1dae861ba5" target="_blank">https://github.com/nobuyukinyuu/monkey-utf8/commit/bbe1a3a06f52baaf80f80698ccf58d1dae861ba5</a><br>Download in the usual place. <br><br></td></tr></table><br>
<a name="2108186"></a>

<a name="2108185"></a>

<a name="bottom"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td align="right"><a href="http://monkeycoder.co.nz" target="_blank"><img src="/img/monkey2.svg" ></a> <a href="https://github.com/blitz-research" target="_blank"><img src="/img/github.svg" ></a> <a href="https://discord.gg/qJccbSp" target="_blank"><img src="/img/discord.svg" ></a></td></tr></table><br></div><br><table width="100%"><tr><td></body></html lang="en">
