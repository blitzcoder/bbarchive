<!DOCTYPE html><html lang="en" ><head ><title >Monkey-timsort:  FAST array sorting</title><meta name='viewport' content='width=device-width, initial-scale=0.66'><meta name='description' content='language:basic, target:desktop, category:game development'><link rel="styleSheet" href="../skins/granite/style.css" type="text/css"><style type="text/css">div.bbcode {padding: 8px;background: #E5E5E5;color: #000000;border: 1px dashed #B4B4BE;}</style></head><body ><table width=100% cellspacing=0 cellpadding=0><tr ><td class="menubarleft"></td><td class="menubar"><table cellspacing="0" cellpadding="0"><tr ><td >&nbsp;</td><td class="menuitemleft"></td><td class="menuitem"><a href="/" class="menuitem">News</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/forums.php" class="menuitem">Forums</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/codearcs.php" class="menuitem">Code</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/logs.php" class="menuitem">Logs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/gallery.php" class="menuitem">Gallery</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/sdkspecs.php" class="menuitem">Specs</a></td><td class="menuitemright"></td><td class="menuitemleft"></td><td class="menuitem"><a href="/search.php" class="menuitem">Search</a></td><td class="menuitemright"></td></tr></table></td><td class="menubarright"></td></tr></table><div class="main"><h1 >Monkey-timsort:  FAST array sorting</h1><a href="forums.php" >Monkey Forums</a>/<a href="topics.php?forum=524" >User Modules</a>/<a href="#bottom" >Monkey-timsort:  FAST array sorting</a><br><br>
<a name="2054328"></a>

<a name="2054336"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Nobuyuki</td><td align="right"><font class=tiny>(Posted 2013)</font>&nbsp;<a href="#1">[#1]</a></td></tr></table></td></tr><tr ><td class="posttext"> <b>This module provides an implementation of TimSort, a new and fast sorting algorithm.</b>  Under testing, I've found this algorithm to be much faster in the most common use scenarios than all of the other implementations currently available for Monkey, including Diddy's QuickSort(), and most likely the default List&lt;T&gt;.Sort().  <strike>It's my hope that this may one day become the default sorting algorithm for Monkey arrays and containers.</strike><br><br><img src="http://i.imgur.com/J6cj2eC.png"><br><br>The code is adapted mostly from the default Java implementation written by Josh Bloch (formerly of Google), and is licensed under the GPL.<br><br><b>Q: What can I use this for?</b><br>A: Exactly what it says in the thread title -- fast sorting.  The most common usage scenarios for games would be Y-Order and Z-Order sorting of sprites or tiles.  Isometric tile renderers and 3d-vectorball routines can gain a large speed advantage with this sort -- since the data inside the tile/object arrays doesn't change often, the sort can skip the vast majority of the work, leaving more precious CPU cycles available to work with on mobile (and probably increasing your framerate as a result!)<br><br><b>Q: Can I use this in my commercial projects?</b><br>A: Generally speaking, yes, you should be able to. The original license was GPLv2, but is part of the Java classpath and is covered by their classpath linking exception. This means that the Monkey code is covered under the linking exception, too -- you may static link the module in commercial projects, and only modifications to the module itself need their source to be released. Monkey-timsort's license was changed to reflect this. <br><br><b>Download:</b>  <i>(Fork, Clone, or click the ZIP button)</i><br><a href="https://github.com/nobuyukinyuu/monkey-timsort" target="_blank">https://github.com/nobuyukinyuu/monkey-timsort</a><br><br><i>Be sure to read the wiki for help!</i>  Thanks, and enjoy! <br><br></td></tr></table><br>
<a name="2054311"></a>

<a name="2054312"></a>

<a name="2054313"></a>

<a name="2054314"></a>

<a name="2054315"></a>

<a name="2054316"></a>

<a name="2054318"></a>

<a name="2054317"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >ziggy</td><td align="right"><font class=tiny>(Posted 2013)</font>&nbsp;<a href="#2">[#2]</a></td></tr></table></td></tr><tr ><td class="posttext"> why GPL? We won't be able to use it on any commercial project. Is it GPL becouse the original algo is also GPL? <br><br></td></tr></table><br>
<a name="2054319"></a>

<a name="2054320"></a>

<a name="2054321"></a>

<a name="2054322"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Nobuyuki</td><td align="right"><font class=tiny>(Posted 2013)</font>&nbsp;<a href="#3">[#3]</a></td></tr></table></td></tr><tr ><td class="posttext"> Yes, that's correct, it's GPL because the original code was GPL.  I'm pretty sure there's an exception in the GPL which covers code in projects that simply static-link to this, otherwise it wouldn't be a part of Java's default library for arraysort (as of Java SE 7), or Python's default sort, either.  If the code to <i>monkey-timsort</i> itself is modified, the code should probably be released, but I would shy away from the notion that the implementation can't be used in a commercial project... <br><br></td></tr></table><br>
<a name="2054323"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >ziggy</td><td align="right"><font class=tiny>(Posted 2013)</font>&nbsp;<a href="#4">[#4]</a></td></tr></table></td></tr><tr ><td class="posttext"> No, there's no exception. The exception was added to LGPL to allow static linking, but AFAIK, GPL forces any software using a GPL licensed code to be also open-source, wich makes the GPL license highly incompatible with most other existing licenses. <br><br></td></tr></table><br>
<a name="2054324"></a>

<a name="2054325"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >skid</td><td align="right"><font class=tiny>(Posted 2013)</font>&nbsp;<a href="#5">[#5]</a></td></tr></table></td></tr><tr ><td class="posttext"> It's a pity the port is not based on the original implementation<br><br><a href="http://svn.python.org/projects/python/trunk/Objects/listobject.c" target="_blank">http://svn.python.org/projects/python/trunk/Objects/listobject.c</a><br><br>which is not infected by GPL. <br><br></td></tr></table><br>
<a name="2054326"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Nobuyuki</td><td align="right"><font class=tiny>(Posted 2013)</font>&nbsp;<a href="#6">[#6]</a></td></tr></table></td></tr><tr ><td class="posttext"> Ziggy:  Okay, I did some asking around, and here's what I found.  Apparently, the original Java SE classpath was released under GPL v2, with a classpath linking exception, which should allow people to release their commercial projects without releasing source.  Since I adapted this code from there, I will update my license to reflect this exception. <br><br></td></tr></table><br>
<a name="2054327"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Soap</td><td align="right"><font class=tiny>(Posted 2013)</font>&nbsp;<a href="#7">[#7]</a></td></tr></table></td></tr><tr ><td class="posttext"> Report from the original implementation? :P <br><br></td></tr></table><br>
<a name="2054330"></a>

<a name="2054331"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >muddy_shoes</td><td align="right"><font class=tiny>(Posted 2013)</font>&nbsp;<a href="#8">[#8]</a></td></tr></table></td></tr><tr ><td class="posttext"> The Java code uses the Classpath exception: <a href="http://www.gnu.org/software/classpath/license.html" target="_blank">http://www.gnu.org/software/classpath/license.html</a> and software that uses it doesn't need to be GPL'd as a whole.<br><br>If you're going to keep it GPL then you should include the same exception if you want it to be usable.<br><br>Edit: Oops, wrote the post and then went and did something else before hitting the button. I see you've got there already. <br><br></td></tr></table><br>
<a name="2054333"></a>

<a name="2054334"></a>

<a name="2054335"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Nobuyuki</td><td align="right"><font class=tiny>(Posted 2013)</font>&nbsp;<a href="#9">[#9]</a></td></tr></table></td></tr><tr ><td class="posttext"> thanks a lot, muddy.  Almost lost my crap seeing ziggy's post after 3 days of work!  Glad to know that this can be used in commercial projects.  I really never ran into licensing problems before (never having released a library covered under GPL), so I didn't know how much it's treated as radioactive/poison by commercial entities! <br><br></td></tr></table><br>
<a name="2054343"></a>

<a name="2054346"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Samah</td><td align="right"><font class=tiny>(Posted 2013)</font>&nbsp;<a href="#10">[#10]</a></td></tr></table></td></tr><tr ><td class="posttext"> You gonna put a reference to Diddy in that Arrays class as per the MIT license?<br><br>Edit: I've just added the MIT header to all of Diddy.  Please copy it into your version. <br><br></td></tr></table><br>
<a name="2054344"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >muddy_shoes</td><td align="right"><font class=tiny>(Posted 2013)</font>&nbsp;<a href="#11">[#11]</a></td></tr></table></td></tr><tr ><td class="posttext"> I've had a quick look at this and other than the "already sorted" case it looks like the advantage you're seeing is mostly down to diddy's use of object arrays. If I change the quicksort implementation to use generics and the Int array directly then it is generally faster than TimSort.<br><br>There's a worthwhile speed-up to be had by cutting some of the flab from the Array copy operations but it doesn't quite close the gap. <br><br></td></tr></table><br>
<a name="2054345"></a>

<a name="2054347"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Samah</td><td align="right"><font class=tiny>(Posted 2013)</font>&nbsp;<a href="#12">[#12]</a></td></tr></table></td></tr><tr ><td class="posttext"> I'm already working on primitives for Arrays.Sort/QuickSort, but it's messy trying to mix primitives and objects while avoiding boxing.<br><br>Edit: Optimally I'd like to do something native with the array copying like Java's System.arrayCopy() method which actually does a raw memory transfer via JNI. <br><br></td></tr></table><br>
<a name="2054348"></a>

<a name="2054349"></a>

<a name="2054350"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Nobuyuki</td><td align="right"><font class=tiny>(Posted 2013)</font>&nbsp;<a href="#13">[#13]</a></td></tr></table></td></tr><tr ><td class="posttext"> <b>muddy_shoes</b>:  I changed the code sometime before you wrote up about the boxing/unboxing so as to try and measure only the time spent in Quicksort() itself, and not boxing/unboxing the array in order to try and make the comparison more fair.  <br><br>That being said, the purely random numbers that are generated for these tests represent a worst-case scenario for most of the data that's fed to a sort in our games.  Things like sprite order sorts are going to be mostly-ordered already from frame to frame, and in those usage scenarios, TimSort has been shown (in tests done by people a lot smarter than me!) to be quite a bit more optimized for that purpose. <br><br><b>Samah</b>:  Sorry about that!  Completely slipped my mind... I'll get the new headers up for Arrays.monkey right away.  I probably could've foregone the usage of Arrays&lt;T&gt; for array copying, but I figured that Diddy probably did it the "fastest way" possible without going native, and its use of generics fit nicely into the existing style of the original (and matched Java's arraycopy arguments order, to boot).<br><br>What would really be nice is if these native libs you mention would eventually extend Monkey's built-in Array class! That's something I think many people would definitely appreciate having built-in and supported on all platforms.  There's definitely room for speed gains on the raw array copying, but I'm afraid it's a bit above my pay grade.  But anyway, thanks again to the Diddy devs for providing functions to manipulate arrays. <br><br></td></tr></table><br>
<a name="2054351"></a>

<a name="2054354"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Samah</td><td align="right"><font class=tiny>(Posted 2013)</font>&nbsp;<a href="#14">[#14]</a></td></tr></table></td></tr><tr ><td class="posttext"> <div class="quote"> Sorry about that! <br></div><br>Yeah I figured it'd just slipped your mind. ;)<br><br>I might take a look at the native stuff at some point.<br><br>Edit: Just made a change to Arrays.Copy to remove the need for a temp array (I'm an idiot for not thinking of it in the first place). <br><br></td></tr></table><br>
<a name="2054405"></a>

<a name="2054406"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >muddy_shoes</td><td align="right"><font class=tiny>(Posted 2013)</font>&nbsp;<a href="#15">[#15]</a></td></tr></table></td></tr><tr ><td class="posttext"> @Nobuyuki <br><br><div class="quote">  I changed the code sometime before you wrote up about the boxing/unboxing so as to try and measure only the time spent in Quicksort() itself, and not boxing/unboxing the array in order to try and make the comparison more fair.  <br></div><br><br>That's not really the issue. The problem is that the Object array based quicksort incurs a large overhead from all the casting that goes on in the comparator.<br><br>As for TimSort's comparative performance for any given real-world dataset, of course it may well be a better choice. You'd have to test to see if that is the case. I'm just pointing out that your headline numbers are a bit misleading as it isn't faster for the actual random data test you're using if the quicksort is implemented using the same generic style as your TimSort code.<br><br><br>@Samah: You might also want to wrap the various sanity checks at the top of the function in an #If CONFIG = "debug". <br><br></td></tr></table><br>
<a name="2054421"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Nobuyuki</td><td align="right"><font class=tiny>(Posted 2013)</font>&nbsp;<a href="#16">[#16]</a></td></tr></table></td></tr><tr ><td class="posttext"> &gt;I'm just pointing out that your headline numbers are a bit misleading as it isn't faster for the actual random data test you're using if the quicksort is implemented using the same generic style as your TimSort code.<br><br><br>Point taken.  I wouldn't mind a Quicksort() that operated on the same generic style, myself.  Voodoo casting scares me..  oAo; <br><br></td></tr></table><br>
<a name="2054547"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td class="posthead"><table width=100% cellspacing=0 cellpadding=0><tr ><td >Samah</td><td align="right"><font class=tiny>(Posted 2013)</font>&nbsp;<a href="#17">[#17]</a></td></tr></table></td></tr><tr ><td class="posttext"> Just refactored QuickSort into a generic class.<br>[monkeycode]SortUtil&lt;Int&gt;.QuickSort(Int[])[/monkeycode] <br><br></td></tr></table><br>
<a name="bottom"></a>
<table width=100% cellspacing=0 cellpadding=0><tr ><td align="right"><a href="http://monkeycoder.co.nz" target="_blank"><img src="/img/monkey2.svg" ></a> <a href="https://github.com/blitz-research" target="_blank"><img src="/img/github.svg" ></a> <a href="https://discord.gg/qJccbSp" target="_blank"><img src="/img/discord.svg" ></a></td></tr></table><br></div><br><table width="100%"><tr><td></body></html lang="en">
